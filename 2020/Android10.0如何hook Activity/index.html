<!doctype html>



  


<html class="theme-next pisces use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="hook Activity,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="在插件化中，hook Activity作为最基本的技术，用来在宿主app中新增Activity，而通常情况下，Activity必须在Manifest中注册在才可以使用，下面将就Android10.0来分析hook Activity的详细过程。 要hook Activity之前，必须知道Activity的启动过程，才能够选择合适的点进行hook，在前面的文章中有分析Activity详细的启动过程，h">
<meta name="keywords" content="hook Activity">
<meta property="og:type" content="article">
<meta property="og:title" content="Android10.0如何hook Activity">
<meta property="og:url" content="http://zproo.github.io/2020/Android10.0如何hook Activity/index.html">
<meta property="og:site_name" content="Skytoby">
<meta property="og:description" content="在插件化中，hook Activity作为最基本的技术，用来在宿主app中新增Activity，而通常情况下，Activity必须在Manifest中注册在才可以使用，下面将就Android10.0来分析hook Activity的详细过程。 要hook Activity之前，必须知道Activity的启动过程，才能够选择合适的点进行hook，在前面的文章中有分析Activity详细的启动过程，h">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://zproo.github.io/2020/Android10.0如何hook%20Activity/classloader.PNG">
<meta property="og:image" content="http://zproo.github.io/2020/Android10.0如何hook%20Activity/startActivity.jpg">
<meta property="og:updated_time" content="2020-05-08T01:49:03.247Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android10.0如何hook Activity">
<meta name="twitter:description" content="在插件化中，hook Activity作为最基本的技术，用来在宿主app中新增Activity，而通常情况下，Activity必须在Manifest中注册在才可以使用，下面将就Android10.0来分析hook Activity的详细过程。 要hook Activity之前，必须知道Activity的启动过程，才能够选择合适的点进行hook，在前面的文章中有分析Activity详细的启动过程，h">
<meta name="twitter:image" content="http://zproo.github.io/2020/Android10.0如何hook%20Activity/classloader.PNG">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://zproo.github.io/2020/Android10.0如何hook Activity/">

  <title> Android10.0如何hook Activity | Skytoby </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <header id="header_post" class="header" itemscope="" itemtype="http://schema.org/WPHeader" style="background-image: url('http://ortur5wom.bkt.clouddn.com/home_bg.jpg');">
      <div class="header-inner-post"><a class="site-home" href="/">Skytoby</a>

<div class="site-meta ">
  
  
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/logo.png" style="width: 50px" alt="Skytoby">
      </a>
    </div>
  

  
  
  
  
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
           <li class="menu-item menu-item-关于">
             <a href="/about" rel="section">
               
               
               关于
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-目录">
             <a href="/archives" rel="section">
               
               
               目录
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-首页">
             <a href="/" rel="section">
               
               
               首页
             </a>
           </li>
        
      

      
    </ul>
  

  
</nav> </div>
      <div class="header-post"> 
  <div class="post-header">
      <div class="tags">
      
        <a href="/tags/hook-Activity/" rel="tag" title="hook Activity">hook Activity</a>
      
      </div>
      <h1>Android10.0如何hook Activity</h1>
      <h2 class="subtitle"></h2>
      <div class="post-time">
        <span class="post-meta-item-text">Posted on </span>
        <time itemprop="dateCreated" datetime="2020-04-04T20:22:28+08:00" content="2020-04-04" title="2020-04-04 20:22:28">
          2020-04-04
        </time>
      </div>
  </div>
 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android10.0如何hook Activity
              
            
          </h1>
        

        <div class="post-meta">
		  

          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-04-04T20:22:28+08:00" content="2020-04-04">
              2020-04-04
            </time>
          </span>

          

          <!-- 
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/Android10.0如何hook Activity/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/Android10.0如何hook Activity/" itemprop="commentsCount"></span>
                </a>
              </span>
            
           -->

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在插件化中，hook Activity作为最基本的技术，用来在宿主app中新增Activity，而通常情况下，Activity必须在Manifest中注册在才可以使用，下面将就Android10.0来分析hook Activity的详细过程。</p>
<p>要hook Activity之前，必须知道Activity的启动过程，才能够选择合适的点进行hook，在前面的文章中有分析<a href="https://skytoby.github.io/2019/startActivity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" target="_blank" rel="noopener">Activity详细的启动过程</a>，hook主要是两个点：一是在Activity给AMS之前替换代理的Activity，二是在handler中发送启动Activity时替换为插件的Activity。</p>
<p>分析完了Activity的hook点之后，还有一个重要的问题，如何加载插件的类和资源，只有加载了插件中的类和资源，后面的hook才有意义。</p>
<h3 id="一、类加载"><a href="#一、类加载" class="headerlink" title="一、类加载"></a>一、类加载</h3><p>在Android中，将代码编译后会生成apk文件，apk文件里面有一个或多个classes.dex文件，它是所有class文件进行合并，优化后生成。在apk运行时ART虚拟机或Dalvik虚拟机会加载dex文件，加载都是通过ClassLoader实现。</p>
<p>ClassLoader是一个抽象类，实现分为系统类加载器和自定义类加载器。</p>
<p>系统类加载器有三种：</p>
<p>BootClassLoader：用于加载Android Framework中class文件。</p>
<p>PathClassLoader：用于Android应用程序类加载器，可以加载指定的dex，以及jar、zip、apk中的dex。</p>
<p>DexClassLoader：用于加载指定的dex，以及jar、zip、apk中的dex。</p>
<h4 id="1-1-PathClassLoader"><a href="#1-1-PathClassLoader" class="headerlink" title="1.1 PathClassLoader"></a>1.1 PathClassLoader</h4><p>[-&gt;libcore\dalvik\src\main\java\dalvik\system\PathClassLoader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public class PathClassLoader extends BaseDexClassLoader &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Creates a &#123;@code PathClassLoader&#125; that operates on a given list of files</span><br><span class="line">     * and directories. This method is equivalent to calling</span><br><span class="line">     * &#123;@link #PathClassLoader(String, String, ClassLoader)&#125; with a</span><br><span class="line">     * &#123;@code null&#125; value for the second argument (see description there).</span><br><span class="line">     *</span><br><span class="line">     * @param dexPath the list of jar/apk files containing classes and</span><br><span class="line">     * resources, delimited by &#123;@code File.pathSeparator&#125;, which</span><br><span class="line">     * defaults to &#123;@code &quot;:&quot;&#125; on Android</span><br><span class="line">     * @param parent the parent class loader</span><br><span class="line">     */</span><br><span class="line">    public PathClassLoader(String dexPath, ClassLoader parent) &#123;</span><br><span class="line">        super(dexPath, null, null, parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Creates a &#123;@code PathClassLoader&#125; that operates on two given</span><br><span class="line">     * lists of files and directories. The entries of the first list</span><br><span class="line">     * should be one of the following:</span><br><span class="line">     *</span><br><span class="line">     * &lt;ul&gt;</span><br><span class="line">     * &lt;li&gt;JAR/ZIP/APK files, possibly containing a &quot;classes.dex&quot; file as</span><br><span class="line">     * well as arbitrary resources.</span><br><span class="line">     * &lt;li&gt;Raw &quot;.dex&quot; files (not inside a zip file).</span><br><span class="line">     * &lt;/ul&gt;</span><br><span class="line">     *</span><br><span class="line">     * The entries of the second list should be directories containing</span><br><span class="line">     * native library files.</span><br><span class="line">     *</span><br><span class="line">     * @param dexPath the list of jar/apk files containing classes and</span><br><span class="line">     * resources, delimited by &#123;@code File.pathSeparator&#125;, which</span><br><span class="line">     * defaults to &#123;@code &quot;:&quot;&#125; on Android</span><br><span class="line">     * @param librarySearchPath the list of directories containing native</span><br><span class="line">     * libraries, delimited by &#123;@code File.pathSeparator&#125;; may be</span><br><span class="line">     * &#123;@code null&#125;</span><br><span class="line">     * @param parent the parent class loader</span><br><span class="line">     */</span><br><span class="line">    public PathClassLoader(String dexPath, String librarySearchPath, ClassLoader parent) &#123;</span><br><span class="line">        super(dexPath, null, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BaseDexClassLoader</p>
<p>[-&gt;libcore\dalvik\src\main\java\dalvik\system\BaseDexClassLoader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class BaseDexClassLoader extends ClassLoader &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Hook for customizing how dex files loads are reported.</span><br><span class="line">     *</span><br><span class="line">     * This enables the framework to monitor the use of dex files. The</span><br><span class="line">     * goal is to simplify the mechanism for optimizing foreign dex files and</span><br><span class="line">     * enable further optimizations of secondary dex files.</span><br><span class="line">     *</span><br><span class="line">     * The reporting happens only when new instances of BaseDexClassLoader</span><br><span class="line">     * are constructed and will be active only after this field is set with</span><br><span class="line">     * &#123;@link BaseDexClassLoader#setReporter&#125;.</span><br><span class="line">     */</span><br><span class="line">    /* @NonNull */ private static volatile Reporter reporter = null;</span><br><span class="line"></span><br><span class="line">    private final DexPathList pathList;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-2-DexClassLoader"><a href="#1-2-DexClassLoader" class="headerlink" title="1.2 DexClassLoader"></a>1.2 DexClassLoader</h4><p>[-&gt;libcore\dalvik\src\main\java\dalvik\system\DexClassLoader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class DexClassLoader extends BaseDexClassLoader &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Creates a &#123;@code DexClassLoader&#125; that finds interpreted and native</span><br><span class="line">     * code.  Interpreted classes are found in a set of DEX files contained</span><br><span class="line">     * in Jar or APK files.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;The path lists are separated using the character specified by the</span><br><span class="line">     * &#123;@code path.separator&#125; system property, which defaults to &#123;@code :&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @param dexPath the list of jar/apk files containing classes and</span><br><span class="line">     *     resources, delimited by &#123;@code File.pathSeparator&#125;, which</span><br><span class="line">     *     defaults to &#123;@code &quot;:&quot;&#125; on Android</span><br><span class="line">     * @param optimizedDirectory this parameter is deprecated and has no effect since API level 26.</span><br><span class="line">     * @param librarySearchPath the list of directories containing native</span><br><span class="line">     *     libraries, delimited by &#123;@code File.pathSeparator&#125;; may be</span><br><span class="line">     *     &#123;@code null&#125;</span><br><span class="line">     * @param parent the parent class loader</span><br><span class="line">     */</span><br><span class="line">    public DexClassLoader(String dexPath, String optimizedDirectory,</span><br><span class="line">            String librarySearchPath, ClassLoader parent) &#123;</span><br><span class="line">        super(dexPath, null, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PathClassLoader和DexClassLoader两者都是继承于BaseDexClassLoader，并且类中只有构成方法，实现全部在BaseDexClassLoader中。从源码中可以看出DexClassLoader多个一个optimizedDirectory参数，但是实际上没什么用处，这两者最后调用的super方法一模一样。</p>
<p><img src="/2020/Android10.0如何hook Activity/classloader.PNG" alt="classloader" style="zoom: 67%;"></p>
<h4 id="1-3-加载原理"><a href="#1-3-加载原理" class="headerlink" title="1.3 加载原理"></a>1.3 加载原理</h4><p>类加载器通过loadClass方法加载apk文件中的类。</p>
<h5 id="1-3-1-ClassLoader-loadClass"><a href="#1-3-1-ClassLoader-loadClass" class="headerlink" title="1.3.1 ClassLoader.loadClass"></a>1.3.1 ClassLoader.loadClass</h5><p>[-&gt;libcore\ojluni\src\main\java\java\lang\ClassLoader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br><span class="line">        throws ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">            // First, check if the class has already been loaded</span><br><span class="line">            // 检查这个类是否已经被加载</span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            if (c == null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (parent != null) &#123;</span><br><span class="line">                        //如果parent不为空，则调用parent的loadClass进行加载</span><br><span class="line">                        c = parent.loadClass(name, false);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        //正常情况下不会走到这里</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    // ClassNotFoundException thrown if class not found</span><br><span class="line">                    // from the non-null parent class loader</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (c == null) &#123;</span><br><span class="line">                    // If still not found, then invoke findClass in order</span><br><span class="line">                    // to find the class.</span><br><span class="line">                    //如果还是找不到，就调用findClass去查找</span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return c;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private Class&lt;?&gt; findBootstrapClassOrNull(String name)&#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     protected final Class&lt;?&gt; findLoadedClass(String name) &#123;</span><br><span class="line">        ClassLoader loader;</span><br><span class="line">        if (this == BootClassLoader.getInstance())</span><br><span class="line">            loader = null;</span><br><span class="line">        else</span><br><span class="line">            loader = this;</span><br><span class="line">            //通过native方法实现查找</span><br><span class="line">        return VMClassLoader.findLoadedClass(loader, name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面类加载的过程就是双亲委派机制。先检查类是否已经被加载，如果已经加载，直接获取并返回。如果没有被加载，parent不为空，则调用parent的loadClass进行加载，依次递归，直到找到或者加载了就返回；如果还没有找到也加载不了，则自己去加载。</p>
<p><strong>BootClassLoader是最后一个加载器</strong>，BootClassLoader重写了findClass和loadClass方法，并且在loadClass方法中不再获取parent，从而结束递归。</p>
<p>在所有parent都不能加载的情况下，DexClassLoader加载过程如下，它的父类继承了BaseDexClassLoader，并重写了findClass方法。</p>
<h5 id="1-3-2-BaseDexClassLoader-findClass"><a href="#1-3-2-BaseDexClassLoader-findClass" class="headerlink" title="1.3.2 BaseDexClassLoader.findClass"></a>1.3.2 BaseDexClassLoader.findClass</h5><p>[-&gt;libcore\dalvik\src\main\java\dalvik\system\BaseDexClassLoader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">       List&lt;Throwable&gt; suppressedExceptions = new ArrayList&lt;Throwable&gt;();</span><br><span class="line">        //在pathlist中查找指定的class</span><br><span class="line">       Class c = pathList.findClass(name, suppressedExceptions);</span><br><span class="line">       if (c == null) &#123;</span><br><span class="line">           ClassNotFoundException cnfe = new ClassNotFoundException(</span><br><span class="line">                   &quot;Didn&apos;t find class \&quot;&quot; + name + &quot;\&quot; on path: &quot; + pathList);</span><br><span class="line">           for (Throwable t : suppressedExceptions) &#123;</span><br><span class="line">               cnfe.addSuppressed(t);</span><br><span class="line">           &#125;</span><br><span class="line">           throw cnfe;</span><br><span class="line">       &#125;</span><br><span class="line">       return c;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">  private final DexPathList pathList;</span><br><span class="line">     /**</span><br><span class="line">    * @hide</span><br><span class="line">    */</span><br><span class="line">   public BaseDexClassLoader(String dexPath, File optimizedDirectory,</span><br><span class="line">           String librarySearchPath, ClassLoader parent, boolean isTrusted) &#123;</span><br><span class="line">       super(parent);</span><br><span class="line">       this.pathList = new DexPathList(this, dexPath, librarySearchPath, null, isTrusted);</span><br><span class="line"></span><br><span class="line">       if (reporter != null) &#123;</span><br><span class="line">           reportClassLoaderChain();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-3-3-DexPathList-findClass"><a href="#1-3-3-DexPathList-findClass" class="headerlink" title="1.3.3 DexPathList.findClass"></a>1.3.3 DexPathList.findClass</h5><p>[-&gt;\libcore\dalvik\src\main\java\dalvik\system\DexPathList.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * List of dex/resource (class path) elements.</span><br><span class="line">   * Should be called pathElements, but the Facebook app uses reflection</span><br><span class="line">   * to modify &apos;dexElements&apos; (http://b/7726934).</span><br><span class="line">   */</span><br><span class="line">private Element[] dexElements;</span><br><span class="line"></span><br><span class="line">public Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">      for (Element element : dexElements) &#123;</span><br><span class="line">         //通过element获取class对象</span><br><span class="line">          Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed);</span><br><span class="line">          if (clazz != null) &#123;</span><br><span class="line">              return clazz;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (dexElementsSuppressedExceptions != null) &#123;</span><br><span class="line">          suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">      &#125;</span><br><span class="line">      return null;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>dexElements初始化在构造函数中完成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DexPathList(ClassLoader definingContext, String dexPath,</span><br><span class="line">           String librarySearchPath, File optimizedDirectory, boolean isTrusted) &#123;</span><br><span class="line">       ...</span><br><span class="line">       this.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                                          suppressedExceptions, definingContext, isTrusted);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>生成Element数组，每一个dex对应一个Element</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">private static Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">           List&lt;IOException&gt; suppressedExceptions, ClassLoader loader, boolean isTrusted) &#123;</span><br><span class="line">     Element[] elements = new Element[files.size()];</span><br><span class="line">     int elementsPos = 0;</span><br><span class="line">     /*</span><br><span class="line">      * Open all files and load the (direct or contained) dex files up front.</span><br><span class="line">      */</span><br><span class="line">     for (File file : files) &#123;</span><br><span class="line">         if (file.isDirectory()) &#123;</span><br><span class="line">             // We support directories for looking up resources. Looking up resources in</span><br><span class="line">             // directories is useful for running libcore tests.</span><br><span class="line">             elements[elementsPos++] = new Element(file);</span><br><span class="line">         &#125; else if (file.isFile()) &#123;</span><br><span class="line">             String name = file.getName();</span><br><span class="line"></span><br><span class="line">             DexFile dex = null;</span><br><span class="line">             if (name.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">                 // Raw dex file (not inside a zip/jar).</span><br><span class="line">                 try &#123;</span><br><span class="line">                     dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                     if (dex != null) &#123;</span><br><span class="line">                         elements[elementsPos++] = new Element(dex, null);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                     System.logE(&quot;Unable to load dex file: &quot; + file, suppressed);</span><br><span class="line">                     suppressedExceptions.add(suppressed);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 try &#123;</span><br><span class="line">                     dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                 &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                     /*</span><br><span class="line">                      * IOException might get thrown &quot;legitimately&quot; by the DexFile constructor if</span><br><span class="line">                      * the zip file turns out to be resource-only (that is, no classes.dex file</span><br><span class="line">                      * in it).</span><br><span class="line">                      * Let dex == null and hang on to the exception to add to the tea-leaves for</span><br><span class="line">                      * when findClass returns null.</span><br><span class="line">                      */</span><br><span class="line">                     suppressedExceptions.add(suppressed);</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 if (dex == null) &#123;</span><br><span class="line">                     elements[elementsPos++] = new Element(file);</span><br><span class="line">                 &#125; else &#123;</span><br><span class="line">                     elements[elementsPos++] = new Element(dex, file);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             if (dex != null &amp;&amp; isTrusted) &#123;</span><br><span class="line">               dex.setTrusted();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             System.logW(&quot;ClassLoader referenced unknown path: &quot; + file);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     if (elementsPos != elements.length) &#123;</span><br><span class="line">         elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">     &#125;</span><br><span class="line">     return elements;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Class对象从Element中获取，每一个Element对应一个dex文件。通过上面的分析，可以想到插件apk的加载方法，通过DexClassLoader加载器加载插件apk，再通过反射的方法获取到宿主的dexElements，最后将插件dexElements和宿主的dexElements合并并赋值给dexElements，其详细流程如下：</p>
<p>1.创建插件的DexClassLoader类加载器，通过反射获取插件中的dexElements</p>
<p>2.获取宿主的PathClassLoader类加载器，通过反射获取宿主的dexElements</p>
<p>3.合并插件和宿主的dexElements，生成新的Element[]</p>
<p>4.最后通过反射将新的Element[]赋值给宿主的dexElements</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//获取BaseDexClassLoader类的class</span><br><span class="line"> Class&lt;?&gt; clazz = Class.forName(&quot;dalvik.system.BaseDexClassLoader&quot;);</span><br><span class="line"> //获取BaseDexClassLoader类成员变量pathList</span><br><span class="line"> Field pathListField = clazz.getDeclaredField(&quot;pathList&quot;);</span><br><span class="line"> pathListField.setAccessible(true);</span><br><span class="line"></span><br><span class="line"> //获取宿主PathClassLoader</span><br><span class="line"> PathClassLoader pathClassLoader = (PathClassLoader) context.getClassLoader();</span><br><span class="line"> //获取宿主pathlist值</span><br><span class="line"> Object hostPathList = pathListField.get(pathClassLoader);</span><br><span class="line"></span><br><span class="line"> //获取宿主的dexElements</span><br><span class="line"> Class&lt;?&gt; hostPathListClass = hostPathList.getClass();</span><br><span class="line"> Field hostDexElementsField = hostPathListClass.getDeclaredField(&quot;dexElements&quot;);</span><br><span class="line"> hostDexElementsField.setAccessible(true);</span><br><span class="line"> Object[] hostDexElements = (Object[]) hostDexElementsField.get(hostPathList);</span><br><span class="line"></span><br><span class="line"> //获取插件pathlist值</span><br><span class="line"> DexClassLoader dexClassLoader = new DexClassLoader(apkPath,context.getCacheDir().getAbsolutePath(),null,pathClassLoader);</span><br><span class="line"> Object pluginPathList = pathListField.get(dexClassLoader);</span><br><span class="line"></span><br><span class="line"> //获取插件的dexElements</span><br><span class="line"> Class&lt;?&gt; pluginPathListClass = pluginPathList.getClass();</span><br><span class="line"> Field pluginDexElementsField = pluginPathListClass.getDeclaredField(&quot;dexElements&quot;);</span><br><span class="line"> pluginDexElementsField.setAccessible(true);</span><br><span class="line"> Object[] pluginDexElements = (Object[]) pluginDexElementsField.get(pluginPathList);</span><br><span class="line"></span><br><span class="line"> //创建新的Element数组</span><br><span class="line"> Object[] newDexElements = (Object[]) Array.newInstance(hostDexElements.getClass().getComponentType(),hostDexElements.length+pluginDexElements.length);</span><br><span class="line"> System.arraycopy(hostDexElements,0,newDexElements,0,hostDexElements.length);</span><br><span class="line"> System.arraycopy(pluginDexElements,0,newDexElements,hostDexElements.length,pluginDexElements.length);</span><br><span class="line"></span><br><span class="line"> //将新的Element[]赋值给dexElements</span><br><span class="line"> hostDexElementsField.set(hostPathList,newDexElements);</span><br></pre></td></tr></table></figure>
<p>这样就完成了插件apk中类的加载，热修复也用到了这样的类加载的原理，不同的是将插件的Elements放在了最前面。</p>
<h3 id="二、资源加载"><a href="#二、资源加载" class="headerlink" title="二、资源加载"></a>二、资源加载</h3><p>要加载插件中的资源，可以通过AssetManager来实现，因为资源的加载实际上是通过AssetManager来加载的。AssetManager可以通过文件名访问那些被编译过的应用程序的资源文件也可以访问没有被编译过的应用程序资源文件。</p>
<p>下面分析下AssetManager如何加载资源的，获取资源是通过getResources方法：</p>
<p>在ActivityThread中attach 方法里面的createAppContext创建Context时会设置Resources。</p>
<h4 id="2-1-CL-createAppContext"><a href="#2-1-CL-createAppContext" class="headerlink" title="2.1 CL.createAppContext"></a>2.1 CL.createAppContext</h4><p>  [-&gt;base\core\java\android\app\ContextImpl.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static ContextImpl createAppContext(ActivityThread mainThread, LoadedApk packageInfo) &#123;</span><br><span class="line">      if (packageInfo == null) throw new IllegalArgumentException(&quot;packageInfo&quot;);</span><br><span class="line">      ContextImpl context = new ContextImpl(null, mainThread, packageInfo, null, null, null, 0,</span><br><span class="line">              null);</span><br><span class="line">      context.setResources(packageInfo.getResources());</span><br><span class="line">      return context;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-LoadedApk-getResources"><a href="#2-2-LoadedApk-getResources" class="headerlink" title="2.2 LoadedApk.getResources"></a>2.2 LoadedApk.getResources</h4><p>[-&gt;base\core\java\android\app\LoadedApk.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public Resources getResources() &#123;</span><br><span class="line">     if (mResources == null) &#123;</span><br><span class="line">         final String[] splitPaths;</span><br><span class="line">         try &#123;</span><br><span class="line">             splitPaths = getSplitPaths(null);</span><br><span class="line">         &#125; catch (NameNotFoundException e) &#123;</span><br><span class="line">             // This should never fail.</span><br><span class="line">             throw new AssertionError(&quot;null split not found&quot;);</span><br><span class="line">         &#125;</span><br><span class="line">        //获取ResourceManager对象，调用getResources获取mResources</span><br><span class="line">         mResources = ResourcesManager.getInstance().getResources(null, mResDir,</span><br><span class="line">                 splitPaths, mOverlayDirs, mApplicationInfo.sharedLibraryFiles,</span><br><span class="line">                 Display.DEFAULT_DISPLAY, null, getCompatibilityInfo(),</span><br><span class="line">                 getClassLoader());</span><br><span class="line">     &#125;</span><br><span class="line">     return mResources;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-RM-getResources"><a href="#2-3-RM-getResources" class="headerlink" title="2.3 RM.getResources"></a>2.3 RM.getResources</h4><p>[-&gt;base\core\java\android\app\ResourcesManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public @Nullable Resources getResources(@Nullable IBinder activityToken,</span><br><span class="line">          @Nullable String resDir,</span><br><span class="line">          @Nullable String[] splitResDirs,</span><br><span class="line">          @Nullable String[] overlayDirs,</span><br><span class="line">          @Nullable String[] libDirs,</span><br><span class="line">          int displayId,</span><br><span class="line">          @Nullable Configuration overrideConfig,</span><br><span class="line">          @NonNull CompatibilityInfo compatInfo,</span><br><span class="line">          @Nullable ClassLoader classLoader) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">          Trace.traceBegin(Trace.TRACE_TAG_RESOURCES, &quot;ResourcesManager#getResources&quot;);</span><br><span class="line">          final ResourcesKey key = new ResourcesKey(</span><br><span class="line">                  resDir,</span><br><span class="line">                  splitResDirs,</span><br><span class="line">                  overlayDirs,</span><br><span class="line">                  libDirs,</span><br><span class="line">                  displayId,</span><br><span class="line">                  overrideConfig != null ? new Configuration(overrideConfig) : null, // Copy</span><br><span class="line">                  compatInfo);</span><br><span class="line">          classLoader = classLoader != null ? classLoader : ClassLoader.getSystemClassLoader();</span><br><span class="line">          return getOrCreateResources(activityToken, key, classLoader);</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">          Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-RM-getOrCreateResources"><a href="#2-4-RM-getOrCreateResources" class="headerlink" title="2.4 RM.getOrCreateResources"></a>2.4 RM.getOrCreateResources</h4><p>[-&gt;base\core\java\android\app\ResourcesManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">private @Nullable Resources getOrCreateResources(@Nullable IBinder activityToken,</span><br><span class="line">           @NonNull ResourcesKey key, @NonNull ClassLoader classLoader) &#123;</span><br><span class="line">       synchronized (this) &#123;</span><br><span class="line">           if (DEBUG) &#123;</span><br><span class="line">               Throwable here = new Throwable();</span><br><span class="line">               here.fillInStackTrace();</span><br><span class="line">               Slog.w(TAG, &quot;!! Get resources for activity=&quot; + activityToken + &quot; key=&quot; + key, here);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (activityToken != null) &#123;</span><br><span class="line">               final ActivityResources activityResources =</span><br><span class="line">                       getOrCreateActivityResourcesStructLocked(activityToken);</span><br><span class="line"></span><br><span class="line">               // Clean up any dead references so they don&apos;t pile up.</span><br><span class="line">               ArrayUtils.unstableRemoveIf(activityResources.activityResources,</span><br><span class="line">                       sEmptyReferencePredicate);</span><br><span class="line"></span><br><span class="line">               // Rebase the key&apos;s override config on top of the Activity&apos;s base override.</span><br><span class="line">               if (key.hasOverrideConfiguration()</span><br><span class="line">                       &amp;&amp; !activityResources.overrideConfig.equals(Configuration.EMPTY)) &#123;</span><br><span class="line">                   final Configuration temp = new Configuration(activityResources.overrideConfig);</span><br><span class="line">                   temp.updateFrom(key.mOverrideConfiguration);</span><br><span class="line">                   key.mOverrideConfiguration.setTo(temp);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               ResourcesImpl resourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">               if (resourcesImpl != null) &#123;</span><br><span class="line">                   if (DEBUG) &#123;</span><br><span class="line">                       Slog.d(TAG, &quot;- using existing impl=&quot; + resourcesImpl);</span><br><span class="line">                   &#125;</span><br><span class="line">                   return getOrCreateResourcesForActivityLocked(activityToken, classLoader,</span><br><span class="line">                           resourcesImpl, key.mCompatInfo);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               // We will create the ResourcesImpl object outside of holding this lock.</span><br><span class="line"></span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               // Clean up any dead references so they don&apos;t pile up.</span><br><span class="line">               ArrayUtils.unstableRemoveIf(mResourceReferences, sEmptyReferencePredicate);</span><br><span class="line"></span><br><span class="line">               // Not tied to an Activity, find a shared Resources that has the right ResourcesImpl</span><br><span class="line">               ResourcesImpl resourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">               if (resourcesImpl != null) &#123;</span><br><span class="line">                   if (DEBUG) &#123;</span><br><span class="line">                       Slog.d(TAG, &quot;- using existing impl=&quot; + resourcesImpl);</span><br><span class="line">                   &#125;</span><br><span class="line">                   return getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               // We will create the ResourcesImpl object outside of holding this lock.</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // If we&apos;re here, we didn&apos;t find a suitable ResourcesImpl to use, so create one now.</span><br><span class="line">           //创建ResourcesImpl对象</span><br><span class="line">           ResourcesImpl resourcesImpl = createResourcesImpl(key);</span><br><span class="line">           if (resourcesImpl == null) &#123;</span><br><span class="line">               return null;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // Add this ResourcesImpl to the cache.</span><br><span class="line">           mResourceImpls.put(key, new WeakReference&lt;&gt;(resourcesImpl));</span><br><span class="line"></span><br><span class="line">           final Resources resources;</span><br><span class="line">           if (activityToken != null) &#123;</span><br><span class="line">               resources = getOrCreateResourcesForActivityLocked(activityToken, classLoader,</span><br><span class="line">                       resourcesImpl, key.mCompatInfo);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               resources = getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">           &#125;</span><br><span class="line">           return resources;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-5-RM-createResourcesImpl"><a href="#2-5-RM-createResourcesImpl" class="headerlink" title="2.5 RM.createResourcesImpl"></a>2.5 RM.createResourcesImpl</h4><p>[-&gt;base\core\java\android\app\ResourcesManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private @Nullable ResourcesImpl createResourcesImpl(@NonNull ResourcesKey key) &#123;</span><br><span class="line">       final DisplayAdjustments daj = new DisplayAdjustments(key.mOverrideConfiguration);</span><br><span class="line">       daj.setCompatibilityInfo(key.mCompatInfo);</span><br><span class="line">       //创建AssetManager</span><br><span class="line">       final AssetManager assets = createAssetManager(key);</span><br><span class="line">       if (assets == null) &#123;</span><br><span class="line">           return null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       final DisplayMetrics dm = getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">       final Configuration config = generateConfig(key, dm);</span><br><span class="line">       //将assets对象传入到ResourcesImpl中</span><br><span class="line">       final ResourcesImpl impl = new ResourcesImpl(assets, dm, config, daj);</span><br><span class="line"></span><br><span class="line">       if (DEBUG) &#123;</span><br><span class="line">           Slog.d(TAG, &quot;- creating impl=&quot; + impl + &quot; with key: &quot; + key);</span><br><span class="line">       &#125;</span><br><span class="line">       return impl;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-RM-createAssetManager"><a href="#2-6-RM-createAssetManager" class="headerlink" title="2.6 RM.createAssetManager"></a>2.6 RM.createAssetManager</h4><p>[-&gt;base\core\java\android\app\ResourcesManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">protected @Nullable AssetManager createAssetManager(@NonNull final ResourcesKey key) &#123;</span><br><span class="line">       final AssetManager.Builder builder = new AssetManager.Builder();</span><br><span class="line"></span><br><span class="line">       // resDir can be null if the &apos;android&apos; package is creating a new Resources object.</span><br><span class="line">       // This is fine, since each AssetManager automatically loads the &apos;android&apos; package</span><br><span class="line">       // already.</span><br><span class="line">       if (key.mResDir != null) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               builder.addApkAssets(loadApkAssets(key.mResDir, false /*sharedLib*/,</span><br><span class="line">                       false /*overlay*/));</span><br><span class="line">           &#125; catch (IOException e) &#123;</span><br><span class="line">               Log.e(TAG, &quot;failed to add asset path &quot; + key.mResDir);</span><br><span class="line">               return null;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (key.mSplitResDirs != null) &#123;</span><br><span class="line">           for (final String splitResDir : key.mSplitResDirs) &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                   builder.addApkAssets(loadApkAssets(splitResDir, false /*sharedLib*/,</span><br><span class="line">                           false /*overlay*/));</span><br><span class="line">               &#125; catch (IOException e) &#123;</span><br><span class="line">                   Log.e(TAG, &quot;failed to add split asset path &quot; + splitResDir);</span><br><span class="line">                   return null;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (key.mOverlayDirs != null) &#123;</span><br><span class="line">           for (final String idmapPath : key.mOverlayDirs) &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                   builder.addApkAssets(loadApkAssets(idmapPath, false /*sharedLib*/,</span><br><span class="line">                           true /*overlay*/));</span><br><span class="line">               &#125; catch (IOException e) &#123;</span><br><span class="line">                   Log.w(TAG, &quot;failed to add overlay path &quot; + idmapPath);</span><br><span class="line"></span><br><span class="line">                   // continue.</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (key.mLibDirs != null) &#123;</span><br><span class="line">           for (final String libDir : key.mLibDirs) &#123;</span><br><span class="line">               if (libDir.endsWith(&quot;.apk&quot;)) &#123;</span><br><span class="line">                   // Avoid opening files we know do not have resources,</span><br><span class="line">                   // like code-only .jar files.</span><br><span class="line">                   try &#123;</span><br><span class="line">                       builder.addApkAssets(loadApkAssets(libDir, true /*sharedLib*/,</span><br><span class="line">                               false /*overlay*/));</span><br><span class="line">                   &#125; catch (IOException e) &#123;</span><br><span class="line">                       Log.w(TAG, &quot;Asset path &apos;&quot; + libDir +</span><br><span class="line">                               &quot;&apos; does not exist or contains no resources.&quot;);</span><br><span class="line"></span><br><span class="line">                       // continue.</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       //最后通过build完成创建</span><br><span class="line">       return builder.build();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-7-AssetManager-addApkAssets"><a href="#2-7-AssetManager-addApkAssets" class="headerlink" title="2.7 AssetManager.addApkAssets"></a>2.7 AssetManager.addApkAssets</h4><p>[-&gt;base\core\java\android\content\res\AssetManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public Builder addApkAssets(ApkAssets apkAssets) &#123;</span><br><span class="line">          mUserApkAssets.add(apkAssets);</span><br><span class="line">          return this;</span><br><span class="line">&#125;</span><br><span class="line"> public AssetManager build() &#123;</span><br><span class="line">          // Retrieving the system ApkAssets forces their creation as well.</span><br><span class="line">          final ApkAssets[] systemApkAssets = getSystem().getApkAssets();</span><br><span class="line"></span><br><span class="line">          final int totalApkAssetCount = systemApkAssets.length + mUserApkAssets.size();</span><br><span class="line">          final ApkAssets[] apkAssets = new ApkAssets[totalApkAssetCount];</span><br><span class="line"></span><br><span class="line">          System.arraycopy(systemApkAssets, 0, apkAssets, 0, systemApkAssets.length);</span><br><span class="line"></span><br><span class="line">          final int userApkAssetCount = mUserApkAssets.size();</span><br><span class="line">          for (int i = 0; i &lt; userApkAssetCount; i++) &#123;</span><br><span class="line">              apkAssets[i + systemApkAssets.length] = mUserApkAssets.get(i);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          // Calling this constructor prevents creation of system ApkAssets, which we took care</span><br><span class="line">          // of in this Builder.</span><br><span class="line">          final AssetManager assetManager = new AssetManager(false /*sentinel*/);</span><br><span class="line">          assetManager.mApkAssets = apkAssets;</span><br><span class="line">          AssetManager.nativeSetApkAssets(assetManager.mObject, apkAssets,</span><br><span class="line">                  false /*invalidateCaches*/);</span><br><span class="line">          return assetManager;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-8-RM-loadApkAssets"><a href="#2-8-RM-loadApkAssets" class="headerlink" title="2.8 RM.loadApkAssets"></a>2.8 RM.loadApkAssets</h4><p>[-&gt;base\core\java\android\app\ResourcesManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private @NonNull ApkAssets loadApkAssets(String path, boolean sharedLib, boolean overlay)</span><br><span class="line">           throws IOException &#123;</span><br><span class="line">       final ApkKey newKey = new ApkKey(path, sharedLib, overlay);</span><br><span class="line">       ApkAssets apkAssets = null;</span><br><span class="line">       if (mLoadedApkAssets != null) &#123;</span><br><span class="line">           apkAssets = mLoadedApkAssets.get(newKey);</span><br><span class="line">           if (apkAssets != null) &#123;</span><br><span class="line">               return apkAssets;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Optimistically check if this ApkAssets exists somewhere else.</span><br><span class="line">       final WeakReference&lt;ApkAssets&gt; apkAssetsRef = mCachedApkAssets.get(newKey);</span><br><span class="line">       if (apkAssetsRef != null) &#123;</span><br><span class="line">           apkAssets = apkAssetsRef.get();</span><br><span class="line">           if (apkAssets != null) &#123;</span><br><span class="line">               if (mLoadedApkAssets != null) &#123;</span><br><span class="line">                   mLoadedApkAssets.put(newKey, apkAssets);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               return apkAssets;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               // Clean up the reference.</span><br><span class="line">               mCachedApkAssets.remove(newKey);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // We must load this from disk.</span><br><span class="line">       if (overlay) &#123;</span><br><span class="line">           apkAssets = ApkAssets.loadOverlayFromPath(overlayPathToIdmapPath(path),</span><br><span class="line">                   false /*system*/);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           apkAssets = ApkAssets.loadFromPath(path, false /*system*/, sharedLib);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (mLoadedApkAssets != null) &#123;</span><br><span class="line">           mLoadedApkAssets.put(newKey, apkAssets);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mCachedApkAssets.put(newKey, new WeakReference&lt;&gt;(apkAssets));</span><br><span class="line">       return apkAssets;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>按照这样的流程比较难hook，看下之前添加的方法addAssetPath，这个方法已经被废弃，但还可以用，hook这个方法比较简单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * @deprecated Use &#123;@link #setApkAssets(ApkAssets[], boolean)&#125;</span><br><span class="line">    * @hide</span><br><span class="line">    */</span><br><span class="line">   @Deprecated</span><br><span class="line">   @UnsupportedAppUsage</span><br><span class="line">   public int addAssetPath(String path) &#123;</span><br><span class="line">       return addAssetPathInternal(path, false /*overlay*/, false /*appAsLib*/);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>1.创建一个AssetManager对象，并调用addAssetPath方法，将插件apk路径作为参数传入</p>
<p>2.将创建的AssetManager对象作为参数，创建一个新的Resourced对象，并返回给插件使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static Resources loadResource(Context context)&#123;</span><br><span class="line">       try &#123;</span><br><span class="line"></span><br><span class="line">           AssetManager assetManager = AssetManager.class.newInstance();</span><br><span class="line">           Method addAssetPathMethod = AssetManager.class.getDeclaredMethod(&quot;addAssetPath&quot;,String.class);</span><br><span class="line">           //加载插件资源</span><br><span class="line">           addAssetPathMethod.invoke(assetManager,apkPath);</span><br><span class="line">           Resources resources = context.getResources();</span><br><span class="line">           return new Resources(assetManager,resources.getDisplayMetrics(),resources.getConfiguration());</span><br><span class="line">       &#125;catch (Exception e)&#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       return null;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private Resources resources;</span><br><span class="line">@Override</span><br><span class="line">public void onCreate() &#123;</span><br><span class="line">    super.onCreate();</span><br><span class="line">    //加载插件类</span><br><span class="line">    LoadClassUtil.loadClass(this);</span><br><span class="line">    //创建新的resources</span><br><span class="line">    resources = LoadClassUtil.loadResource(this);</span><br><span class="line">    HookUtil.hookAMS();</span><br><span class="line">    HookUtil.hookHandler();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Resources getResources() &#123;</span><br><span class="line">   //resources为空，相当于没有重写，不为空是返回新建的resources对象</span><br><span class="line">    return resources==null?super.getResources():resources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后让插件的Activity重写getResources方法，获取的资源就是新创建的resources对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public Resources getResources() &#123;</span><br><span class="line">      if(getApplication()!=null&amp;&amp;getApplication()!=null)&#123;</span><br><span class="line">          return getApplication().getResources();</span><br><span class="line">      &#125;</span><br><span class="line">      return super.getResources();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、hook-Activity"><a href="#三、hook-Activity" class="headerlink" title="三、hook Activity"></a>三、hook Activity</h3><p>首先在宿主里面创建一个ProxyActivity，并且在Manifest中注册（如果需要对应不同启动模式的Activity，可以全部把每种启动模式下的Activity都注册）。当启动插件Activity时，进入AMS之前，通过Hook将插件Activity替换成ProxyActivity，在进入AMS之后，通过handler发送消息时使用hook将ProxyActivity替换成插件的Activity。</p>
<p>startActivity的流程如下图，可以看到这两个具体的hook点</p>
<p><img src="/2020/Android10.0如何hook Activity/startActivity.jpg" alt="startActivity" style="zoom: 50%;"></p>
<h4 id="3-1-hook-AMS"><a href="#3-1-hook-AMS" class="headerlink" title="3.1 hook AMS"></a>3.1 hook AMS</h4><p>在进入到AMS之前，这个是最后一步，那么如何将intent换成插件的intent的呢？可以通过动态代理实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public ActivityResult execStartActivity(</span><br><span class="line">      Context who, IBinder contextThread, IBinder token, String target,</span><br><span class="line">      Intent intent, int requestCode, Bundle options) &#123;</span><br><span class="line">      ...</span><br><span class="line">      try &#123;</span><br><span class="line">          intent.migrateExtraStreamToClipData();</span><br><span class="line">          intent.prepareToLeaveProcess(who);</span><br><span class="line">          int result = ActivityManager.getService()</span><br><span class="line">              .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                      intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                      token, target, requestCode, 0, null, options);</span><br><span class="line">          checkStartActivityResult(result, intent);</span><br><span class="line">      &#125; catch (RemoteException e) &#123;</span><br><span class="line">          throw new RuntimeException(&quot;Failure from system&quot;, e);</span><br><span class="line">      &#125;</span><br><span class="line">      return null;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ActivityManager.getService具体实现如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * @hide</span><br><span class="line">    */</span><br><span class="line">   @UnsupportedAppUsage</span><br><span class="line">   public static IActivityManager getService() &#123;</span><br><span class="line">       return IActivityManagerSingleton.get();</span><br><span class="line">   &#125;</span><br><span class="line">   public abstract class Singleton&lt;T&gt; &#123;</span><br><span class="line">   @UnsupportedAppUsage</span><br><span class="line">   private T mInstance;</span><br><span class="line"></span><br><span class="line">   protected abstract T create();</span><br><span class="line"></span><br><span class="line">   @UnsupportedAppUsage</span><br><span class="line">   public final T get() &#123;</span><br><span class="line">       synchronized (this) &#123;</span><br><span class="line">           if (mInstance == null) &#123;</span><br><span class="line">               mInstance = create();</span><br><span class="line">           &#125;</span><br><span class="line">           return mInstance;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;  </span><br><span class="line">   @UnsupportedAppUsage</span><br><span class="line">   private static final Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">           new Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               protected IActivityManager create() &#123;</span><br><span class="line">                   final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">                   //获取AMS的代理</span><br><span class="line">                   final IActivityManager am = IActivityManager.Stub.asInterface(b);</span><br><span class="line">                   return am;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br></pre></td></tr></table></figure>
<p>第一步获取IActivityManager对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//获取IActivityManagerSingleton对象，用于获取mIntance</span><br><span class="line"> Class&lt;?&gt; clazz = Class.forName(&quot;android.app.ActivityManager&quot;);</span><br><span class="line"> Field singletonFiled = clazz.getDeclaredField(&quot;IActivityManagerSingleton&quot;);</span><br><span class="line"> singletonFiled.setAccessible(true);</span><br><span class="line"> Object singleton = singletonFiled.get(null);</span><br><span class="line"></span><br><span class="line"> //获取Singleton对象</span><br><span class="line"> Class&lt;?&gt; singletonClass = Class.forName(&quot;android.util.Singleton&quot;);</span><br><span class="line"> Field mInstanceField = singletonClass.getDeclaredField(&quot;mInstance&quot;);</span><br><span class="line"> mInstanceField.setAccessible(true);</span><br><span class="line"> //获取mInstance对象</span><br><span class="line"> final Object mInstance = mInstanceField.get(singleton);</span><br></pre></td></tr></table></figure>
<p>第二步将intent替换成插件的intent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> Class&lt;?&gt; iActivityManagerClass = Class.forName(&quot;android.app.IActivityManager&quot;);</span><br><span class="line">          Object proxyInstance = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), new Class[]&#123;iActivityManagerClass&#125;,</span><br><span class="line">                  new InvocationHandler() &#123;</span><br><span class="line">                      @Override</span><br><span class="line">                      public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">                          if(&quot;startActivity&quot;.equals(method.getName()))&#123;</span><br><span class="line">                              int index = 0;</span><br><span class="line">                              for(int i=0;i&lt;args.length;i++)&#123;</span><br><span class="line">                                  if(args[i] instanceof Intent)&#123;</span><br><span class="line">                                      index = i;</span><br><span class="line">                                      break;</span><br><span class="line">                                  &#125;</span><br><span class="line">                              &#125;</span><br><span class="line">                              //启动插件的intent</span><br><span class="line">                              Intent intent = (Intent) args[index];</span><br><span class="line">                              //启动代理的intent</span><br><span class="line">                              Intent proxyIntent = new Intent();</span><br><span class="line">                   proxyIntent.setClassName(&quot;com.android.test&quot;,&quot;com.android.test.ProxyActivity&quot;);</span><br><span class="line">                              //保存插件的intent</span><br><span class="line">                              proxyIntent.putExtra(&quot;target&quot;,intent);</span><br><span class="line">                              args[index] = proxyIntent;</span><br><span class="line">                          &#125;</span><br><span class="line">                          return method.invoke(mInstance,args);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;);</span><br><span class="line">//替换mInstance对象</span><br><span class="line">mInstanceField.set(singleton,proxyInstance);</span><br></pre></td></tr></table></figure>
<p>这样第一个hook点就完成了，下面看下第二步hook点</p>
<h4 id="3-2-hook-Handler"><a href="#3-2-hook-Handler" class="headerlink" title="3.2 hook Handler"></a>3.2 hook Handler</h4><p>在启动Activity之前的操作，Android10.0用状态模式完成Activity的生命周期的启动，那么如何将代理的intent替换成插件的intent的呢？从源码可以看出最后通过scheduleTransaction方法启动Activity，那么是否通过clientTransaction替换intent的呢，通过分析startActivity的启动流程，答案是可以的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//创建Activity启动事务</span><br><span class="line">// Create activity launch transaction.</span><br><span class="line">final ClientTransaction clientTransaction = ClientTransaction.obtain(app.thread,</span><br><span class="line">        r.appToken);</span><br><span class="line">clientTransaction.addCallback(LaunchActivityItem.obtain(new Intent(r.intent),</span><br><span class="line">        System.identityHashCode(r), r.info,</span><br><span class="line">        // TODO: Have this take the merged configuration instead of separate global</span><br><span class="line">        // and override configs.</span><br><span class="line">        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">        r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">        r.persistentState, results, newIntents, mService.isNextTransitionForward(),</span><br><span class="line">        profilerInfo));</span><br><span class="line"></span><br><span class="line">//设置目标事务的状态为onResume</span><br><span class="line">// Set desired final state.</span><br><span class="line">final ActivityLifecycleItem lifecycleItem;</span><br><span class="line">if (andResume) &#123;</span><br><span class="line">    lifecycleItem = ResumeActivityItem.obtain(mService.isNextTransitionForward());</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">&#125;</span><br><span class="line">clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">//通过transaciton方式开始activity生命周期，onCreate,onStart,onResume</span><br><span class="line">// Schedule transaction.</span><br><span class="line">mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br></pre></td></tr></table></figure>
<p>scheduleTransaction还是要通过Handler发送消息，进入EXECUTE_TRANSACTION分支</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void handleMessage(Message msg) &#123;</span><br><span class="line">         ...</span><br><span class="line">         case EXECUTE_TRANSACTION:</span><br><span class="line">                    final ClientTransaction transaction = (ClientTransaction) msg.obj;</span><br><span class="line">                    mTransactionExecutor.execute(transaction);</span><br><span class="line">                    if (isSystem()) &#123;</span><br><span class="line">                        // Client transactions inside system process are recycled on the client side</span><br><span class="line">                        // instead of ClientLifecycleManager to avoid being cleared before this</span><br><span class="line">                        // message is handled.</span><br><span class="line">                        transaction.recycle();</span><br><span class="line">                    &#125;</span><br><span class="line">                    // TODO(lifecycler): Recycle locally scheduled transactions.</span><br><span class="line">                    break;</span><br><span class="line">           ....</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>那么要替换intent首先需要hook handleMessage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">//获取ActivityThread对象</span><br><span class="line">Class&lt;?&gt; clazz = Class.forName(&quot;android.app.ActivityThread&quot;);</span><br><span class="line">Field sCurrentActivityThreadField = clazz.getDeclaredField(&quot;sCurrentActivityThread&quot;);</span><br><span class="line">sCurrentActivityThreadField.setAccessible(true);</span><br><span class="line">Object activityThread = sCurrentActivityThreadField.get(null);</span><br><span class="line"></span><br><span class="line">//获取handler</span><br><span class="line">Field mHField = clazz.getDeclaredField(&quot;mH&quot;);</span><br><span class="line">mHField.setAccessible(true);</span><br><span class="line">Object mH = mHField.get(activityThread);</span><br><span class="line"></span><br><span class="line">//获取callback对象</span><br><span class="line">Field mCallbackField = Handler.class.getDeclaredField(&quot;mCallback&quot;);</span><br><span class="line">mCallbackField.setAccessible(true);</span><br><span class="line">mCallbackField.set(mH, new Handler.Callback() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean handleMessage(Message msg) &#123;</span><br><span class="line">      switch (msg.what)&#123;</span><br><span class="line">          case 159:</span><br><span class="line">              try &#123;</span><br><span class="line">                  //获取List&lt;ClientTransactionItem&gt; mActivityCallbacks对象</span><br><span class="line">                  Class&lt;?&gt; clientTransactionClass = msg.obj.getClass();</span><br><span class="line">                  Field mActivityCallbacksField = clientTransactionClass.getDeclaredField(&quot;mActivityCallbacks&quot;);</span><br><span class="line">                  mActivityCallbacksField.setAccessible(true);</span><br><span class="line">                  List mActivityCallbacks = (List) mActivityCallbacksField.get(msg.obj);</span><br><span class="line">                  for(int i=0;i&lt;mActivityCallbacks.size();i++)&#123;                          if(mActivityCallbacks.get(i).getClass().getName().equals(&quot;android.app.servertransaction.LaunchActivityItem&quot;))&#123;</span><br><span class="line">                          //获取LaunchActivityItem</span><br><span class="line">                          Object launchActivityItem = mActivityCallbacks.get(i);</span><br><span class="line">                          Class&lt;?&gt; launchActivityItemClass = launchActivityItem.getClass();</span><br><span class="line"></span><br><span class="line">                          Field mIntentField = launchActivityItemClass.getDeclaredField(&quot;mIntent&quot;);</span><br><span class="line">                          mIntentField.setAccessible(true);</span><br><span class="line"></span><br><span class="line">                          //代理intent</span><br><span class="line">                          Intent proxyIntent = (Intent) mIntentField.get(launchActivityItem);</span><br><span class="line">                          //插件intent</span><br><span class="line">                          Intent intent = proxyIntent.getParcelableExtra(&quot;target&quot;);</span><br><span class="line">                          //插件intent替换代理intent</span><br><span class="line">                          proxyIntent.setComponent(intent.getComponent());</span><br><span class="line"></span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                  &#125;</span><br></pre></td></tr></table></figure>
<p>hook了handleMessage后，通过LaunchActivityItem中的mIntent完成代理intent的替换。</p>
<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>hook Activity涉及的技术比较多，Activity的启动流程，类加载，动态代理，资源加载，反射，binder机制等，只有在掌握了这些技术的基础上才能够完成插件化技术的开发。</p>
<p>本文介绍了hook Activity的具体实现方法，通过该方法引申出类的加载和资源加载的原理，并分析具体插件的加载实现，后面结合之前文章分析的<a href="https://skytoby.github.io/2019/startActivity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" target="_blank" rel="noopener">startActivity的启动流程</a>，引出了两个具体的hook点：</p>
<p>1.在ActivityManager.getService().startActivity时通过反射获取IActivityManager对象，startActivity时将插件的Activity替换成代理的Activity；</p>
<p>2.反射获取ActivityThread对象，通过获取类成员变量mH，重新设置callback，将handleMessage中的EXECUTE_TRANSACTION分支进行hook，在mActivityCallbacks中找到LaunchActivityItem，将其类成员变量mIntent替换成插件的Activity，这样就完成的插件Activity的启动过程。</p>

      
    </div>


    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/hook-Activity/" rel="tag">#hook Activity</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/深入理解Binder机制6-总结篇/" rel="next" title="深入理解Binder机制6-总结篇">
                <i class="fa fa-chevron-left"></i> 深入理解Binder机制6-总结篇
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/Android JNI 原理分析/" rel="prev" title="Android JNI原理分析">
                Android JNI原理分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Skytoby">
          <p class="site-author-name" itemprop="name">Skytoby</p>
          <p class="site-description motion-element" itemprop="description">现居深圳，毕业于电子科技大学 <br>Android、AI<br>座右铭：想法+行动+坚持</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caoxiaoliang" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/cao861544325" target="_blank" title="CSDN">
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、类加载"><span class="nav-text">一、类加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-PathClassLoader"><span class="nav-text">1.1 PathClassLoader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-DexClassLoader"><span class="nav-text">1.2 DexClassLoader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-加载原理"><span class="nav-text">1.3 加载原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-1-ClassLoader-loadClass"><span class="nav-text">1.3.1 ClassLoader.loadClass</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-2-BaseDexClassLoader-findClass"><span class="nav-text">1.3.2 BaseDexClassLoader.findClass</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-3-DexPathList-findClass"><span class="nav-text">1.3.3 DexPathList.findClass</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、资源加载"><span class="nav-text">二、资源加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-CL-createAppContext"><span class="nav-text">2.1 CL.createAppContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-LoadedApk-getResources"><span class="nav-text">2.2 LoadedApk.getResources</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-RM-getResources"><span class="nav-text">2.3 RM.getResources</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-RM-getOrCreateResources"><span class="nav-text">2.4 RM.getOrCreateResources</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-RM-createResourcesImpl"><span class="nav-text">2.5 RM.createResourcesImpl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-RM-createAssetManager"><span class="nav-text">2.6 RM.createAssetManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-AssetManager-addApkAssets"><span class="nav-text">2.7 AssetManager.addApkAssets</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-RM-loadApkAssets"><span class="nav-text">2.8 RM.loadApkAssets</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、hook-Activity"><span class="nav-text">三、hook Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-hook-AMS"><span class="nav-text">3.1 hook AMS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-hook-Handler"><span class="nav-text">3.2 hook Handler</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、总结"><span class="nav-text">四、总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skytoby</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme Next
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'https-zproo-github-io';
      var disqus_identifier = '2020/Android10.0如何hook Activity/';
      var disqus_title = "Android10.0如何hook Activity";
      var disqus_url = 'http://zproo.github.io/2020/Android10.0如何hook Activity/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  









  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
