<!doctype html>



  


<html class="theme-next pisces use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="JNI,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="一、概述JNI(Java Native Interface,Java本地接口)，是连接Android Native层和Java层的纽带，这个是Java所特有的，并不是Android系统独有。Java作为跨平台的语言，依靠的是虚拟机，虚拟机采用C/C++编写，适配各个系统，通过JNI为上层Java提供各种服务，保证跨平台性。下面将从Android虚拟机启动开始深入理解JNI的原理。 二、Androi">
<meta name="keywords" content="JNI">
<meta property="og:type" content="article">
<meta property="og:title" content="Android JNI原理分析">
<meta property="og:url" content="http://zproo.github.io/2020/Android JNI 原理分析/index.html">
<meta property="og:site_name" content="Skytoby">
<meta property="og:description" content="一、概述JNI(Java Native Interface,Java本地接口)，是连接Android Native层和Java层的纽带，这个是Java所特有的，并不是Android系统独有。Java作为跨平台的语言，依靠的是虚拟机，虚拟机采用C/C++编写，适配各个系统，通过JNI为上层Java提供各种服务，保证跨平台性。下面将从Android虚拟机启动开始深入理解JNI的原理。 二、Androi">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-07-29T08:28:03.638Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android JNI原理分析">
<meta name="twitter:description" content="一、概述JNI(Java Native Interface,Java本地接口)，是连接Android Native层和Java层的纽带，这个是Java所特有的，并不是Android系统独有。Java作为跨平台的语言，依靠的是虚拟机，虚拟机采用C/C++编写，适配各个系统，通过JNI为上层Java提供各种服务，保证跨平台性。下面将从Android虚拟机启动开始深入理解JNI的原理。 二、Androi">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://zproo.github.io/2020/Android JNI 原理分析/">

  <title> Android JNI原理分析 | Skytoby </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <header id="header_post" class="header" itemscope="" itemtype="http://schema.org/WPHeader" style="background-image: url('http://ortur5wom.bkt.clouddn.com/home_bg.jpg');">
      <div class="header-inner-post"><a class="site-home" href="/">Skytoby</a>

<div class="site-meta ">
  
  
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/logo.png" style="width: 50px" alt="Skytoby">
      </a>
    </div>
  

  
  
  
  
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
           <li class="menu-item menu-item-关于">
             <a href="/about" rel="section">
               
               
               关于
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-目录">
             <a href="/archives" rel="section">
               
               
               目录
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-首页">
             <a href="/" rel="section">
               
               
               首页
             </a>
           </li>
        
      

      
    </ul>
  

  
</nav> </div>
      <div class="header-post"> 
  <div class="post-header">
      <div class="tags">
      
        <a href="/tags/JNI/" rel="tag" title="JNI">JNI</a>
      
      </div>
      <h1>Android JNI原理分析</h1>
      <h2 class="subtitle"></h2>
      <div class="post-time">
        <span class="post-meta-item-text">Posted on </span>
        <time itemprop="dateCreated" datetime="2020-05-16T21:18:23+08:00" content="2020-05-16" title="2020-05-16 21:18:23">
          2020-05-16
        </time>
      </div>
  </div>
 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android JNI原理分析
              
            
          </h1>
        

        <div class="post-meta">
		  

          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-05-16T21:18:23+08:00" content="2020-05-16">
              2020-05-16
            </time>
          </span>

          

          <!-- 
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/Android JNI 原理分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/Android JNI 原理分析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
           -->

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h3><p>JNI(Java Native Interface,Java本地接口)，是连接Android Native层和Java层的纽带，这个是Java所特有的，并不是Android系统独有。Java作为跨平台的语言，依靠的是虚拟机，虚拟机采用C/C++编写，适配各个系统，通过JNI为上层Java提供各种服务，保证跨平台性。下面将从Android虚拟机启动开始深入理解JNI的原理。</p>
<h3 id="二、Android虚拟机启动"><a href="#二、Android虚拟机启动" class="headerlink" title="二、Android虚拟机启动"></a>二、Android虚拟机启动</h3><p>在Android系统systemserver启动上，有介绍过虚拟机的启动。虚拟机的启动是在Zygote进程中，Zygote启动过程中通过AndroidRuntime::start函数中的startVm来创建虚拟机而后注册JNI函数。</p>
<h4 id="2-1-AR-start"><a href="#2-1-AR-start" class="headerlink" title="2.1 AR::start"></a>2.1 AR::start</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options, bool zygote)</span><br><span class="line">&#123;</span><br><span class="line">   ......</span><br><span class="line">    /* start the virtual machine */</span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(NULL);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    //创建虚拟机</span><br><span class="line">    if (startVm(&amp;mJavaVM, &amp;env, zygote) != 0) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //空函数</span><br><span class="line">    onVmCreated(env);</span><br><span class="line">    /*</span><br><span class="line">     * Register android functions.</span><br><span class="line">     */</span><br><span class="line">    //注册JNI函数</span><br><span class="line">    if (startReg(env) &lt; 0) &#123;</span><br><span class="line">        ALOGE(&quot;Unable to register all android natives/n&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-AR-startVm"><a href="#2-2-AR-startVm" class="headerlink" title="2.2 AR::startVm"></a>2.2 AR::startVm</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br></pre></td><td class="code"><pre><span class="line">int AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, bool zygote, bool primary_zygote)</span><br><span class="line">&#123;</span><br><span class="line">    JavaVMInitArgs initArgs;</span><br><span class="line">    char propBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    char jniOptsBuf[sizeof(&quot;-Xjniopts:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char heapstartsizeOptsBuf[sizeof(&quot;-Xms&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char heapsizeOptsBuf[sizeof(&quot;-Xmx&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char heapgrowthlimitOptsBuf[sizeof(&quot;-XX:HeapGrowthLimit=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char heapminfreeOptsBuf[sizeof(&quot;-XX:HeapMinFree=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char heapmaxfreeOptsBuf[sizeof(&quot;-XX:HeapMaxFree=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char usejitOptsBuf[sizeof(&quot;-Xusejit:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char jitpthreadpriorityOptsBuf[sizeof(&quot;-Xjitpthreadpriority:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char jitmaxsizeOptsBuf[sizeof(&quot;-Xjitmaxsize:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char jitinitialsizeOptsBuf[sizeof(&quot;-Xjitinitialsize:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char jitthresholdOptsBuf[sizeof(&quot;-Xjitthreshold:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char useJitProfilesOptsBuf[sizeof(&quot;-Xjitsaveprofilinginfo:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char jitprithreadweightOptBuf[sizeof(&quot;-Xjitprithreadweight:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char jittransitionweightOptBuf[sizeof(&quot;-Xjittransitionweight:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char hotstartupsamplesOptsBuf[sizeof(&quot;-Xps-hot-startup-method-samples:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char madviseRandomOptsBuf[sizeof(&quot;-XX:MadviseRandomAccess:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char gctypeOptsBuf[sizeof(&quot;-Xgc:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char backgroundgcOptsBuf[sizeof(&quot;-XX:BackgroundGC=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char heaptargetutilizationOptsBuf[sizeof(&quot;-XX:HeapTargetUtilization=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char foregroundHeapGrowthMultiplierOptsBuf[</span><br><span class="line">            sizeof(&quot;-XX:ForegroundHeapGrowthMultiplier=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char cachePruneBuf[sizeof(&quot;-Xzygote-max-boot-retry=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatXmsImageFlagsBuf[sizeof(&quot;-Xms&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatXmxImageFlagsBuf[sizeof(&quot;-Xmx&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatXmsFlagsBuf[sizeof(&quot;-Xms&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatXmxFlagsBuf[sizeof(&quot;-Xmx&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatCompilerFilterBuf[sizeof(&quot;--compiler-filter=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatImageCompilerFilterBuf[sizeof(&quot;--compiler-filter=&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatThreadsBuf[sizeof(&quot;-j&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatThreadsImageBuf[sizeof(&quot;-j&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oat_isa_variant_key[PROPERTY_KEY_MAX];</span><br><span class="line">    char dex2oat_isa_variant[sizeof(&quot;--instruction-set-variant=&quot;) -1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oat_isa_features_key[PROPERTY_KEY_MAX];</span><br><span class="line">    char dex2oat_isa_features[sizeof(&quot;--instruction-set-features=&quot;) -1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatFlagsBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    char dex2oatImageFlagsBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    char extraOptsBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    char voldDecryptBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    enum &#123;</span><br><span class="line">      kEMDefault,</span><br><span class="line">      kEMIntPortable,</span><br><span class="line">      kEMIntFast,</span><br><span class="line">      kEMJitCompiler,</span><br><span class="line">    &#125; executionMode = kEMDefault;</span><br><span class="line">    char localeOption[sizeof(&quot;-Duser.locale=&quot;) + PROPERTY_VALUE_MAX];</span><br><span class="line">    char lockProfThresholdBuf[sizeof(&quot;-Xlockprofthreshold:&quot;)-1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char nativeBridgeLibrary[sizeof(&quot;-XX:NativeBridge=&quot;) + PROPERTY_VALUE_MAX];</span><br><span class="line">    char cpuAbiListBuf[sizeof(&quot;--cpu-abilist=&quot;) + PROPERTY_VALUE_MAX];</span><br><span class="line">    char corePlatformApiPolicyBuf[sizeof(&quot;-Xcore-platform-api-policy:&quot;) + PROPERTY_VALUE_MAX];</span><br><span class="line">    char methodTraceFileBuf[sizeof(&quot;-Xmethod-trace-file:&quot;) + PROPERTY_VALUE_MAX];</span><br><span class="line">    char methodTraceFileSizeBuf[sizeof(&quot;-Xmethod-trace-file-size:&quot;) + PROPERTY_VALUE_MAX];</span><br><span class="line">    std::string fingerprintBuf;</span><br><span class="line">    char jdwpProviderBuf[sizeof(&quot;-XjdwpProvider:&quot;) - 1 + PROPERTY_VALUE_MAX];</span><br><span class="line">    char bootImageBuf[sizeof(&quot;-Ximage:&quot;) - 1 + PROPERTY_VALUE_MAX];</span><br><span class="line"></span><br><span class="line">    std::string use_apex_image =</span><br><span class="line">        server_configurable_flags::GetServerConfigurableFlag(RUNTIME_NATIVE_BOOT_NAMESPACE,</span><br><span class="line">                                                             ENABLE_APEX_IMAGE,</span><br><span class="line">                                                             /*default_value=*/ &quot;&quot;);</span><br><span class="line">    if (use_apex_image == &quot;true&quot;) &#123;</span><br><span class="line">        addOption(kApexImageOption);</span><br><span class="line">        ALOGI(&quot;Using Apex boot image: &apos;%s&apos;/n&quot;, kApexImageOption);</span><br><span class="line">    &#125; else if (parseRuntimeOption(&quot;dalvik.vm.boot-image&quot;, bootImageBuf, &quot;-Ximage:&quot;)) &#123;</span><br><span class="line">        ALOGI(&quot;Using dalvik.vm.boot-image: &apos;%s&apos;/n&quot;, bootImageBuf);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ALOGI(&quot;Using default boot image&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string disable_lock_profiling =</span><br><span class="line">        server_configurable_flags::GetServerConfigurableFlag(RUNTIME_NATIVE_BOOT_NAMESPACE,</span><br><span class="line">                                                             DISABLE_LOCK_PROFILING,</span><br><span class="line">                                                             /*default_value=*/ &quot;&quot;);</span><br><span class="line">    if (disable_lock_profiling == &quot;true&quot;) &#123;</span><br><span class="line">        addOption(kLockProfThresholdRuntimeOption);</span><br><span class="line">        ALOGI(&quot;Disabling lock profiling: &apos;%s&apos;/n&quot;, kLockProfThresholdRuntimeOption);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ALOGI(&quot;Leaving lock profiling enabled&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bool checkJni = false;</span><br><span class="line">    property_get(&quot;dalvik.vm.checkjni&quot;, propBuf, &quot;&quot;);</span><br><span class="line">    if (strcmp(propBuf, &quot;true&quot;) == 0) &#123;</span><br><span class="line">        checkJni = true;</span><br><span class="line">    &#125; else if (strcmp(propBuf, &quot;false&quot;) != 0) &#123;</span><br><span class="line">        /* property is neither true nor false; fall back on kernel parameter */</span><br><span class="line">        property_get(&quot;ro.kernel.android.checkjni&quot;, propBuf, &quot;&quot;);</span><br><span class="line">        if (propBuf[0] == &apos;1&apos;) &#123;</span><br><span class="line">            checkJni = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGV(&quot;CheckJNI is %s/n&quot;, checkJni ? &quot;ON&quot; : &quot;OFF&quot;);</span><br><span class="line">    if (checkJni) &#123;</span><br><span class="line">        /* extended JNI checking */</span><br><span class="line">        addOption(&quot;-Xcheck:jni&quot;);</span><br><span class="line"></span><br><span class="line">        /* with -Xcheck:jni, this provides a JNI function call trace */</span><br><span class="line">        //addOption(&quot;-verbose:jni&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_get(&quot;dalvik.vm.execution-mode&quot;, propBuf, &quot;&quot;);</span><br><span class="line">    if (strcmp(propBuf, &quot;int:portable&quot;) == 0) &#123;</span><br><span class="line">        executionMode = kEMIntPortable;</span><br><span class="line">    &#125; else if (strcmp(propBuf, &quot;int:fast&quot;) == 0) &#123;</span><br><span class="line">        executionMode = kEMIntFast;</span><br><span class="line">    &#125; else if (strcmp(propBuf, &quot;int:jit&quot;) == 0) &#123;</span><br><span class="line">        executionMode = kEMJitCompiler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    strcpy(jniOptsBuf, &quot;-Xjniopts:&quot;);</span><br><span class="line">    if (parseRuntimeOption(&quot;dalvik.vm.jniopts&quot;, jniOptsBuf, &quot;-Xjniopts:&quot;)) &#123;</span><br><span class="line">        ALOGI(&quot;JNI options: &apos;%s&apos;/n&quot;, jniOptsBuf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* route exit() to our handler */</span><br><span class="line">    addOption(&quot;exit&quot;, (void*) runtime_exit);</span><br><span class="line"></span><br><span class="line">    /* route fprintf() to our handler */</span><br><span class="line">    addOption(&quot;vfprintf&quot;, (void*) runtime_vfprintf);</span><br><span class="line"></span><br><span class="line">    /* register the framework-specific &quot;is sensitive thread&quot; hook */</span><br><span class="line">    addOption(&quot;sensitiveThread&quot;, (void*) runtime_isSensitiveThread);</span><br><span class="line"></span><br><span class="line">    /* enable verbose; standard options are &#123; jni, gc, class &#125; */</span><br><span class="line">    //addOption(&quot;-verbose:jni&quot;);</span><br><span class="line">    addOption(&quot;-verbose:gc&quot;);</span><br><span class="line">    //addOption(&quot;-verbose:class&quot;);</span><br><span class="line"></span><br><span class="line">    if (primary_zygote) &#123;</span><br><span class="line">        addOption(&quot;-Xprimaryzygote&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * The default starting and maximum size of the heap.  Larger</span><br><span class="line">     * values should be specified in a product property override.</span><br><span class="line">     */</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.heapstartsize&quot;, heapstartsizeOptsBuf, &quot;-Xms&quot;, &quot;4m&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.heapsize&quot;, heapsizeOptsBuf, &quot;-Xmx&quot;, &quot;16m&quot;);</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.heapgrowthlimit&quot;, heapgrowthlimitOptsBuf, &quot;-XX:HeapGrowthLimit=&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.heapminfree&quot;, heapminfreeOptsBuf, &quot;-XX:HeapMinFree=&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.heapmaxfree&quot;, heapmaxfreeOptsBuf, &quot;-XX:HeapMaxFree=&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.heaptargetutilization&quot;,</span><br><span class="line">                       heaptargetutilizationOptsBuf,</span><br><span class="line">                       &quot;-XX:HeapTargetUtilization=&quot;);</span><br><span class="line"></span><br><span class="line">    /* Foreground heap growth multiplier option */</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.foreground-heap-growth-multiplier&quot;,</span><br><span class="line">                       foregroundHeapGrowthMultiplierOptsBuf,</span><br><span class="line">                       &quot;-XX:ForegroundHeapGrowthMultiplier=&quot;);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * JIT related options.</span><br><span class="line">     */</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.usejit&quot;, usejitOptsBuf, &quot;-Xusejit:&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.jitmaxsize&quot;, jitmaxsizeOptsBuf, &quot;-Xjitmaxsize:&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.jitinitialsize&quot;, jitinitialsizeOptsBuf, &quot;-Xjitinitialsize:&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.jitthreshold&quot;, jitthresholdOptsBuf, &quot;-Xjitthreshold:&quot;);</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.jitpthreadpriority&quot;,</span><br><span class="line">                       jitpthreadpriorityOptsBuf,</span><br><span class="line">                       &quot;-Xjitpthreadpriority:&quot;);</span><br><span class="line">    property_get(&quot;dalvik.vm.usejitprofiles&quot;, useJitProfilesOptsBuf, &quot;&quot;);</span><br><span class="line">    if (strcmp(useJitProfilesOptsBuf, &quot;true&quot;) == 0) &#123;</span><br><span class="line">        addOption(&quot;-Xjitsaveprofilinginfo&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.jitprithreadweight&quot;,</span><br><span class="line">                       jitprithreadweightOptBuf,</span><br><span class="line">                       &quot;-Xjitprithreadweight:&quot;);</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.jittransitionweight&quot;,</span><br><span class="line">                       jittransitionweightOptBuf,</span><br><span class="line">                       &quot;-Xjittransitionweight:&quot;);</span><br><span class="line"></span><br><span class="line">    property_get(&quot;dalvik.vm.profilebootimage&quot;, propBuf, &quot;&quot;);</span><br><span class="line">    if (strcmp(propBuf, &quot;true&quot;) == 0) &#123;</span><br><span class="line">        addOption(&quot;-Xps-profile-boot-class-path&quot;);</span><br><span class="line">        addOption(&quot;-Xps-profile-aot-code&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Madvise related options.</span><br><span class="line">     */</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.madvise-random&quot;, madviseRandomOptsBuf, &quot;-XX:MadviseRandomAccess:&quot;);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Profile related options.</span><br><span class="line">     */</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.hot-startup-method-samples&quot;, hotstartupsamplesOptsBuf,</span><br><span class="line">            &quot;-Xps-hot-startup-method-samples:&quot;);</span><br><span class="line"></span><br><span class="line">    property_get(&quot;ro.config.low_ram&quot;, propBuf, &quot;&quot;);</span><br><span class="line">    if (strcmp(propBuf, &quot;true&quot;) == 0) &#123;</span><br><span class="line">      addOption(&quot;-XX:LowMemoryMode&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Garbage-collection related options.</span><br><span class="line">     */</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.gctype&quot;, gctypeOptsBuf, &quot;-Xgc:&quot;);</span><br><span class="line"></span><br><span class="line">    // If it set, honor the &quot;enable_generational_cc&quot; device configuration;</span><br><span class="line">    // otherwise, let the runtime use its default behavior.</span><br><span class="line">    std::string enable_generational_cc =</span><br><span class="line">        server_configurable_flags::GetServerConfigurableFlag(RUNTIME_NATIVE_BOOT_NAMESPACE,</span><br><span class="line">                                                             ENABLE_GENERATIONAL_CC,</span><br><span class="line">                                                             /*default_value=*/ &quot;&quot;);</span><br><span class="line">    if (enable_generational_cc == &quot;true&quot;) &#123;</span><br><span class="line">        addOption(kGenerationalCCRuntimeOption);</span><br><span class="line">    &#125; else if (enable_generational_cc == &quot;false&quot;) &#123;</span><br><span class="line">        addOption(kNoGenerationalCCRuntimeOption);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.backgroundgctype&quot;, backgroundgcOptsBuf, &quot;-XX:BackgroundGC=&quot;);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Enable debugging only for apps forked from zygote.</span><br><span class="line">     */</span><br><span class="line">    if (zygote) &#123;</span><br><span class="line">      // Set the JDWP provider and required arguments. By default let the runtime choose how JDWP is</span><br><span class="line">      // implemented. When this is not set the runtime defaults to not allowing JDWP.</span><br><span class="line">      addOption(&quot;-XjdwpOptions:suspend=n,server=y&quot;);</span><br><span class="line">      parseRuntimeOption(&quot;dalvik.vm.jdwp-provider&quot;,</span><br><span class="line">                         jdwpProviderBuf,</span><br><span class="line">                         &quot;-XjdwpProvider:&quot;,</span><br><span class="line">                         &quot;default&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.lockprof.threshold&quot;,</span><br><span class="line">                       lockProfThresholdBuf,</span><br><span class="line">                       &quot;-Xlockprofthreshold:&quot;);</span><br><span class="line"></span><br><span class="line">    if (executionMode == kEMIntPortable) &#123;</span><br><span class="line">        addOption(&quot;-Xint:portable&quot;);</span><br><span class="line">    &#125; else if (executionMode == kEMIntFast) &#123;</span><br><span class="line">        addOption(&quot;-Xint:fast&quot;);</span><br><span class="line">    &#125; else if (executionMode == kEMJitCompiler) &#123;</span><br><span class="line">        addOption(&quot;-Xint:jit&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If we are booting without the real /data, don&apos;t spend time compiling.</span><br><span class="line">    property_get(&quot;vold.decrypt&quot;, voldDecryptBuf, &quot;&quot;);</span><br><span class="line">    bool skip_compilation = ((strcmp(voldDecryptBuf, &quot;trigger_restart_min_framework&quot;) == 0) ||</span><br><span class="line">                             (strcmp(voldDecryptBuf, &quot;1&quot;) == 0));</span><br><span class="line"></span><br><span class="line">    // Extra options for boot.art/boot.oat image generation.</span><br><span class="line">    parseCompilerRuntimeOption(&quot;dalvik.vm.image-dex2oat-Xms&quot;, dex2oatXmsImageFlagsBuf,</span><br><span class="line">                               &quot;-Xms&quot;, &quot;-Ximage-compiler-option&quot;);</span><br><span class="line">    parseCompilerRuntimeOption(&quot;dalvik.vm.image-dex2oat-Xmx&quot;, dex2oatXmxImageFlagsBuf,</span><br><span class="line">                               &quot;-Xmx&quot;, &quot;-Ximage-compiler-option&quot;);</span><br><span class="line">    if (skip_compilation) &#123;</span><br><span class="line">        addOption(&quot;-Ximage-compiler-option&quot;);</span><br><span class="line">        addOption(&quot;--compiler-filter=assume-verified&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        parseCompilerOption(&quot;dalvik.vm.image-dex2oat-filter&quot;, dex2oatImageCompilerFilterBuf,</span><br><span class="line">                            &quot;--compiler-filter=&quot;, &quot;-Ximage-compiler-option&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If there is a boot profile, it takes precedence over the image and preloaded classes.</span><br><span class="line">    if (hasFile(&quot;/system/etc/boot-image.prof&quot;)) &#123;</span><br><span class="line">        addOption(&quot;-Ximage-compiler-option&quot;);</span><br><span class="line">        addOption(&quot;--profile-file=/system/etc/boot-image.prof&quot;);</span><br><span class="line">        addOption(&quot;-Ximage-compiler-option&quot;);</span><br><span class="line">        addOption(&quot;--compiler-filter=speed-profile&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Make sure there is a preloaded-classes file.</span><br><span class="line">        if (!hasFile(&quot;/system/etc/preloaded-classes&quot;)) &#123;</span><br><span class="line">            ALOGE(&quot;Missing preloaded-classes file, /system/etc/preloaded-classes not found: %s/n&quot;,</span><br><span class="line">                  strerror(errno));</span><br><span class="line">            return -1;</span><br><span class="line">        &#125;</span><br><span class="line">        addOption(&quot;-Ximage-compiler-option&quot;);</span><br><span class="line">        addOption(&quot;--image-classes=/system/etc/preloaded-classes&quot;);</span><br><span class="line"></span><br><span class="line">        // If there is a dirty-image-objects file, push it.</span><br><span class="line">        if (hasFile(&quot;/system/etc/dirty-image-objects&quot;)) &#123;</span><br><span class="line">            addOption(&quot;-Ximage-compiler-option&quot;);</span><br><span class="line">            addOption(&quot;--dirty-image-objects=/system/etc/dirty-image-objects&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_get(&quot;dalvik.vm.image-dex2oat-flags&quot;, dex2oatImageFlagsBuf, &quot;&quot;);</span><br><span class="line">    parseExtraOpts(dex2oatImageFlagsBuf, &quot;-Ximage-compiler-option&quot;);</span><br><span class="line"></span><br><span class="line">    // Extra options for DexClassLoader.</span><br><span class="line">    parseCompilerRuntimeOption(&quot;dalvik.vm.dex2oat-Xms&quot;, dex2oatXmsFlagsBuf,</span><br><span class="line">                               &quot;-Xms&quot;, &quot;-Xcompiler-option&quot;);</span><br><span class="line">    parseCompilerRuntimeOption(&quot;dalvik.vm.dex2oat-Xmx&quot;, dex2oatXmxFlagsBuf,</span><br><span class="line">                               &quot;-Xmx&quot;, &quot;-Xcompiler-option&quot;);</span><br><span class="line">    if (skip_compilation) &#123;</span><br><span class="line">        addOption(&quot;-Xcompiler-option&quot;);</span><br><span class="line">        addOption(&quot;--compiler-filter=assume-verified&quot;);</span><br><span class="line"></span><br><span class="line">        // We skip compilation when a minimal runtime is brought up for decryption. In that case</span><br><span class="line">        // /data is temporarily backed by a tmpfs, which is usually small.</span><br><span class="line">        // If the system image contains prebuilts, they will be relocated into the tmpfs. In this</span><br><span class="line">        // specific situation it is acceptable to *not* relocate and run out of the prebuilts</span><br><span class="line">        // directly instead.</span><br><span class="line">        addOption(&quot;--runtime-arg&quot;);</span><br><span class="line">        addOption(&quot;-Xnorelocate&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        parseCompilerOption(&quot;dalvik.vm.dex2oat-filter&quot;, dex2oatCompilerFilterBuf,</span><br><span class="line">                            &quot;--compiler-filter=&quot;, &quot;-Xcompiler-option&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    parseCompilerOption(&quot;dalvik.vm.dex2oat-threads&quot;, dex2oatThreadsBuf, &quot;-j&quot;, &quot;-Xcompiler-option&quot;);</span><br><span class="line">    parseCompilerOption(&quot;dalvik.vm.image-dex2oat-threads&quot;, dex2oatThreadsImageBuf, &quot;-j&quot;,</span><br><span class="line">                        &quot;-Ximage-compiler-option&quot;);</span><br><span class="line"></span><br><span class="line">    // The runtime will compile a boot image, when necessary, not using installd. Thus, we need to</span><br><span class="line">    // pass the instruction-set-features/variant as an image-compiler-option.</span><br><span class="line">    // Note: it is OK to reuse the buffer, as the values are exactly the same between</span><br><span class="line">    //       * compiler-option, used for runtime compilation (DexClassLoader)</span><br><span class="line">    //       * image-compiler-option, used for boot-image compilation on device</span><br><span class="line"></span><br><span class="line">    // Copy the variant.</span><br><span class="line">    sprintf(dex2oat_isa_variant_key, &quot;dalvik.vm.isa.%s.variant&quot;, ABI_STRING);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_variant_key, dex2oat_isa_variant,</span><br><span class="line">                        &quot;--instruction-set-variant=&quot;, &quot;-Ximage-compiler-option&quot;);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_variant_key, dex2oat_isa_variant,</span><br><span class="line">                        &quot;--instruction-set-variant=&quot;, &quot;-Xcompiler-option&quot;);</span><br><span class="line">    // Copy the features.</span><br><span class="line">    sprintf(dex2oat_isa_features_key, &quot;dalvik.vm.isa.%s.features&quot;, ABI_STRING);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_features_key, dex2oat_isa_features,</span><br><span class="line">                        &quot;--instruction-set-features=&quot;, &quot;-Ximage-compiler-option&quot;);</span><br><span class="line">    parseCompilerOption(dex2oat_isa_features_key, dex2oat_isa_features,</span><br><span class="line">                        &quot;--instruction-set-features=&quot;, &quot;-Xcompiler-option&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    property_get(&quot;dalvik.vm.dex2oat-flags&quot;, dex2oatFlagsBuf, &quot;&quot;);</span><br><span class="line">    parseExtraOpts(dex2oatFlagsBuf, &quot;-Xcompiler-option&quot;);</span><br><span class="line"></span><br><span class="line">    /* extra options; parse this late so it overrides others */</span><br><span class="line">    property_get(&quot;dalvik.vm.extra-opts&quot;, extraOptsBuf, &quot;&quot;);</span><br><span class="line">    parseExtraOpts(extraOptsBuf, NULL);</span><br><span class="line"></span><br><span class="line">    /* Set the properties for locale */</span><br><span class="line">    &#123;</span><br><span class="line">        strcpy(localeOption, &quot;-Duser.locale=&quot;);</span><br><span class="line">        const std::string locale = readLocale();</span><br><span class="line">        strncat(localeOption, locale.c_str(), PROPERTY_VALUE_MAX);</span><br><span class="line">        addOption(localeOption);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Trace files are stored in /data/misc/trace which is writable only in debug mode.</span><br><span class="line">    property_get(&quot;ro.debuggable&quot;, propBuf, &quot;0&quot;);</span><br><span class="line">    if (strcmp(propBuf, &quot;1&quot;) == 0) &#123;</span><br><span class="line">        property_get(&quot;dalvik.vm.method-trace&quot;, propBuf, &quot;false&quot;);</span><br><span class="line">        if (strcmp(propBuf, &quot;true&quot;) == 0) &#123;</span><br><span class="line">            addOption(&quot;-Xmethod-trace&quot;);</span><br><span class="line">            parseRuntimeOption(&quot;dalvik.vm.method-trace-file&quot;,</span><br><span class="line">                               methodTraceFileBuf,</span><br><span class="line">                               &quot;-Xmethod-trace-file:&quot;);</span><br><span class="line">            parseRuntimeOption(&quot;dalvik.vm.method-trace-file-siz&quot;,</span><br><span class="line">                               methodTraceFileSizeBuf,</span><br><span class="line">                               &quot;-Xmethod-trace-file-size:&quot;);</span><br><span class="line">            property_get(&quot;dalvik.vm.method-trace-stream&quot;, propBuf, &quot;false&quot;);</span><br><span class="line">            if (strcmp(propBuf, &quot;true&quot;) == 0) &#123;</span><br><span class="line">                addOption(&quot;-Xmethod-trace-stream&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Native bridge library. &quot;0&quot; means that native bridge is disabled.</span><br><span class="line">    //</span><br><span class="line">    // Note: bridging is only enabled for the zygote. Other runs of</span><br><span class="line">    //       app_process may not have the permissions to mount etc.</span><br><span class="line">    property_get(&quot;ro.dalvik.vm.native.bridge&quot;, propBuf, &quot;&quot;);</span><br><span class="line">    if (propBuf[0] == &apos;/0&apos;) &#123;</span><br><span class="line">        ALOGW(&quot;ro.dalvik.vm.native.bridge is not expected to be empty&quot;);</span><br><span class="line">    &#125; else if (zygote &amp;&amp; strcmp(propBuf, &quot;0&quot;) != 0) &#123;</span><br><span class="line">        snprintf(nativeBridgeLibrary, sizeof(&quot;-XX:NativeBridge=&quot;) + PROPERTY_VALUE_MAX,</span><br><span class="line">                 &quot;-XX:NativeBridge=%s&quot;, propBuf);</span><br><span class="line">        addOption(nativeBridgeLibrary);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">#if defined(__LP64__)</span><br><span class="line">    const char* cpu_abilist_property_name = &quot;ro.product.cpu.abilist64&quot;;</span><br><span class="line">#else</span><br><span class="line">    const char* cpu_abilist_property_name = &quot;ro.product.cpu.abilist32&quot;;</span><br><span class="line">#endif  // defined(__LP64__)</span><br><span class="line">    property_get(cpu_abilist_property_name, propBuf, &quot;&quot;);</span><br><span class="line">    if (propBuf[0] == &apos;/0&apos;) &#123;</span><br><span class="line">        ALOGE(&quot;%s is not expected to be empty&quot;, cpu_abilist_property_name);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    snprintf(cpuAbiListBuf, sizeof(cpuAbiListBuf), &quot;--cpu-abilist=%s&quot;, propBuf);</span><br><span class="line">    addOption(cpuAbiListBuf);</span><br><span class="line"></span><br><span class="line">    // Dalvik-cache pruning counter.</span><br><span class="line">    parseRuntimeOption(&quot;dalvik.vm.zygote.max-boot-retry&quot;, cachePruneBuf,</span><br><span class="line">                       &quot;-Xzygote-max-boot-retry=&quot;);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * When running with debug.generate-debug-info, add --generate-debug-info to</span><br><span class="line">     * the compiler options so that the boot image, if it is compiled on device,</span><br><span class="line">     * will include native debugging information.</span><br><span class="line">     */</span><br><span class="line">    property_get(&quot;debug.generate-debug-info&quot;, propBuf, &quot;&quot;);</span><br><span class="line">    if (strcmp(propBuf, &quot;true&quot;) == 0) &#123;</span><br><span class="line">        addOption(&quot;-Xcompiler-option&quot;);</span><br><span class="line">        addOption(&quot;--generate-debug-info&quot;);</span><br><span class="line">        addOption(&quot;-Ximage-compiler-option&quot;);</span><br><span class="line">        addOption(&quot;--generate-debug-info&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The mini-debug-info makes it possible to backtrace through JIT code.</span><br><span class="line">    if (property_get_bool(&quot;dalvik.vm.minidebuginfo&quot;, 0)) &#123;</span><br><span class="line">        addOption(&quot;-Xcompiler-option&quot;);</span><br><span class="line">        addOption(&quot;--generate-mini-debug-info&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If set, the property below can be used to enable core platform API violation reporting.</span><br><span class="line">    property_get(&quot;persist.debug.dalvik.vm.core_platform_api_policy&quot;, propBuf, &quot;&quot;);</span><br><span class="line">    if (propBuf[0] != &apos;/0&apos;) &#123;</span><br><span class="line">      snprintf(corePlatformApiPolicyBuf,</span><br><span class="line">               sizeof(corePlatformApiPolicyBuf),</span><br><span class="line">               &quot;-Xcore-platform-api-policy:%s&quot;,</span><br><span class="line">               propBuf);</span><br><span class="line">      addOption(corePlatformApiPolicyBuf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Retrieve the build fingerprint and provide it to the runtime. That way, ANR dumps will</span><br><span class="line">     * contain the fingerprint and can be parsed.</span><br><span class="line">     * Fingerprints are potentially longer than PROPERTY_VALUE_MAX, so parseRuntimeOption() cannot</span><br><span class="line">     * be used here.</span><br><span class="line">     * Do not ever re-assign fingerprintBuf as its c_str() value is stored in mOptions.</span><br><span class="line">     */</span><br><span class="line">    std::string fingerprint = GetProperty(&quot;ro.build.fingerprint&quot;, &quot;&quot;);</span><br><span class="line">    if (!fingerprint.empty()) &#123;</span><br><span class="line">        fingerprintBuf = &quot;-Xfingerprint:&quot; + fingerprint;</span><br><span class="line">        addOption(fingerprintBuf.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initArgs.version = JNI_VERSION_1_4;</span><br><span class="line">    initArgs.options = mOptions.editArray();</span><br><span class="line">    initArgs.nOptions = mOptions.size();</span><br><span class="line">    initArgs.ignoreUnrecognized = JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Initialize the VM.</span><br><span class="line">     *</span><br><span class="line">     * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread.</span><br><span class="line">     * If this call succeeds, the VM is ready, and we can start issuing</span><br><span class="line">     * JNI calls.</span><br><span class="line">     */</span><br><span class="line">    if (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; 0) &#123;</span><br><span class="line">        ALOGE(&quot;JNI_CreateJavaVM failed/n&quot;);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startVM主要是对虚拟机的一些参数进行配置，配置完成之后才执行JNI_CreateJavaVM方法。这个方法会创建JavaVM<em>，每个进程都有一个JNIEnv</em>，虚拟机创建完成之后就可进行JNI的调用。</p>
<h5 id="2-2-1-JNI-CreateJavaVM"><a href="#2-2-1-JNI-CreateJavaVM" class="headerlink" title="2.2.1 JNI_CreateJavaVM"></a>2.2.1 JNI_CreateJavaVM</h5><p>[-&gt;java_vm_ext.cc]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// JNI Invocation interface.</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot; jint JNI_CreateJavaVM(JavaVM** p_vm, JNIEnv** p_env, void* vm_args) &#123;</span><br><span class="line">  ScopedTrace trace(__FUNCTION__);</span><br><span class="line">  const JavaVMInitArgs* args = static_cast&lt;JavaVMInitArgs*&gt;(vm_args);</span><br><span class="line">  if (JavaVMExt::IsBadJniVersion(args-&gt;version)) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;Bad JNI version passed to CreateJavaVM: &quot; &lt;&lt; args-&gt;version;</span><br><span class="line">    return JNI_EVERSION;</span><br><span class="line">  &#125;</span><br><span class="line">  RuntimeOptions options;</span><br><span class="line">  for (int i = 0; i &lt; args-&gt;nOptions; ++i) &#123;</span><br><span class="line">    JavaVMOption* option = &amp;args-&gt;options[i];</span><br><span class="line">    options.push_back(std::make_pair(std::string(option-&gt;optionString), option-&gt;extraInfo));</span><br><span class="line">  &#125;</span><br><span class="line">  bool ignore_unrecognized = args-&gt;ignoreUnrecognized;</span><br><span class="line">  //创建Runtime</span><br><span class="line">  if (!Runtime::Create(options, ignore_unrecognized)) &#123;</span><br><span class="line">    return JNI_ERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Initialize native loader. This step makes sure we have</span><br><span class="line">  // everything set up before we start using JNI.</span><br><span class="line">  android::InitializeNativeLoader();</span><br><span class="line"></span><br><span class="line">  Runtime* runtime = Runtime::Current();</span><br><span class="line">  //启动Runtime</span><br><span class="line">  bool started = runtime-&gt;Start();</span><br><span class="line">  if (!started) &#123;</span><br><span class="line">    delete Thread::Current()-&gt;GetJniEnv();</span><br><span class="line">    delete runtime-&gt;GetJavaVM();</span><br><span class="line">    LOG(WARNING) &lt;&lt; &quot;CreateJavaVM failed&quot;;</span><br><span class="line">    return JNI_ERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *p_env = Thread::Current()-&gt;GetJniEnv();</span><br><span class="line">  *p_vm = runtime-&gt;GetJavaVM();</span><br><span class="line">  return JNI_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Runtime表示当前进程ART虚拟机实例</p>
<h5 id="2-2-2-Runtime-Create"><a href="#2-2-2-Runtime-Create" class="headerlink" title="2.2.2 Runtime::Create"></a>2.2.2 Runtime::Create</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bool Runtime::Create(const RuntimeOptions&amp; raw_options, bool ignore_unrecognized) &#123;</span><br><span class="line">  RuntimeArgumentMap runtime_options;</span><br><span class="line">  return ParseOptions(raw_options, ignore_unrecognized, &amp;runtime_options) &amp;&amp;</span><br><span class="line">      Create(std::move(runtime_options));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool Runtime::Create(RuntimeArgumentMap&amp;&amp; runtime_options) &#123;</span><br><span class="line">  // TODO: acquire a static mutex on Runtime to avoid racing.</span><br><span class="line">  if (Runtime::instance_ != nullptr) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  instance_ = new Runtime;</span><br><span class="line">  Locks::SetClientCallback(IsSafeToCallAbort);</span><br><span class="line">  if (!instance_-&gt;Init(std::move(runtime_options))) &#123;</span><br><span class="line">    // TODO: Currently deleting the instance will abort the runtime on destruction. Now This will</span><br><span class="line">    // leak memory, instead. Fix the destructor. b/19100793.</span><br><span class="line">    // delete instance_;</span><br><span class="line">    instance_ = nullptr;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-3-Runtime-Init"><a href="#2-2-3-Runtime-Init" class="headerlink" title="2.2.3 Runtime::Init"></a>2.2.3 Runtime::Init</h5><p>[-&gt;runtime.cc]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br></pre></td><td class="code"><pre><span class="line">bool Runtime::Init(RuntimeArgumentMap&amp;&amp; runtime_options_in) &#123;</span><br><span class="line">  // (b/30160149): protect subprocesses from modifications to LD_LIBRARY_PATH, etc.</span><br><span class="line">  // Take a snapshot of the environment at the time the runtime was created, for use by Exec, etc.</span><br><span class="line">  env_snapshot_.TakeSnapshot();</span><br><span class="line"></span><br><span class="line">  using Opt = RuntimeArgumentMap;</span><br><span class="line">  Opt runtime_options(std::move(runtime_options_in));</span><br><span class="line">  ScopedTrace trace(__FUNCTION__);</span><br><span class="line">  CHECK_EQ(sysconf(_SC_PAGE_SIZE), kPageSize);</span><br><span class="line"></span><br><span class="line">  // Early override for logging output.</span><br><span class="line">  if (runtime_options.Exists(Opt::UseStderrLogger)) &#123;</span><br><span class="line">    android::base::SetLogger(android::base::StderrLogger);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  MemMap::Init();</span><br><span class="line"></span><br><span class="line">  // Try to reserve a dedicated fault page. This is allocated for clobbered registers and sentinels.</span><br><span class="line">  // If we cannot reserve it, log a warning.</span><br><span class="line">  // Note: We allocate this first to have a good chance of grabbing the page. The address (0xebad..)</span><br><span class="line">  //       is out-of-the-way enough that it should not collide with boot image mapping.</span><br><span class="line">  // Note: Don&apos;t request an error message. That will lead to a maps dump in the case of failure,</span><br><span class="line">  //       leading to logspam.</span><br><span class="line">  &#123;</span><br><span class="line">    constexpr uintptr_t kSentinelAddr =</span><br><span class="line">        RoundDown(static_cast&lt;uintptr_t&gt;(Context::kBadGprBase), kPageSize);</span><br><span class="line">    protected_fault_page_.reset(MemMap::MapAnonymous(&quot;Sentinel fault page&quot;,</span><br><span class="line">                                                     reinterpret_cast&lt;uint8_t*&gt;(kSentinelAddr),</span><br><span class="line">                                                     kPageSize,</span><br><span class="line">                                                     PROT_NONE,</span><br><span class="line">                                                     /* low_4g */ true,</span><br><span class="line">                                                     /* reuse */ false,</span><br><span class="line">                                                     /* error_msg */ nullptr));</span><br><span class="line">    if (protected_fault_page_ == nullptr) &#123;</span><br><span class="line">      LOG(WARNING) &lt;&lt; &quot;Could not reserve sentinel fault page&quot;;</span><br><span class="line">    &#125; else if (reinterpret_cast&lt;uintptr_t&gt;(protected_fault_page_-&gt;Begin()) != kSentinelAddr) &#123;</span><br><span class="line">      LOG(WARNING) &lt;&lt; &quot;Could not reserve sentinel fault page at the right address.&quot;;</span><br><span class="line">      protected_fault_page_.reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  VLOG(startup) &lt;&lt; &quot;Runtime::Init -verbose:startup enabled&quot;;</span><br><span class="line"></span><br><span class="line">  QuasiAtomic::Startup();</span><br><span class="line"></span><br><span class="line">  oat_file_manager_ = new OatFileManager;</span><br><span class="line"></span><br><span class="line">  Thread::SetSensitiveThreadHook(runtime_options.GetOrDefault(Opt::HookIsSensitiveThread));</span><br><span class="line">  Monitor::Init(runtime_options.GetOrDefault(Opt::LockProfThreshold),</span><br><span class="line">                runtime_options.GetOrDefault(Opt::StackDumpLockProfThreshold));</span><br><span class="line"></span><br><span class="line">  boot_class_path_string_ = runtime_options.ReleaseOrDefault(Opt::BootClassPath);</span><br><span class="line">  class_path_string_ = runtime_options.ReleaseOrDefault(Opt::ClassPath);</span><br><span class="line">  properties_ = runtime_options.ReleaseOrDefault(Opt::PropertiesList);</span><br><span class="line"></span><br><span class="line">  compiler_callbacks_ = runtime_options.GetOrDefault(Opt::CompilerCallbacksPtr);</span><br><span class="line">  patchoat_executable_ = runtime_options.ReleaseOrDefault(Opt::PatchOat);</span><br><span class="line">  must_relocate_ = runtime_options.GetOrDefault(Opt::Relocate);</span><br><span class="line">  is_zygote_ = runtime_options.Exists(Opt::Zygote);</span><br><span class="line">  is_explicit_gc_disabled_ = runtime_options.Exists(Opt::DisableExplicitGC);</span><br><span class="line">  dex2oat_enabled_ = runtime_options.GetOrDefault(Opt::Dex2Oat);</span><br><span class="line">  image_dex2oat_enabled_ = runtime_options.GetOrDefault(Opt::ImageDex2Oat);</span><br><span class="line">  dump_native_stack_on_sig_quit_ = runtime_options.GetOrDefault(Opt::DumpNativeStackOnSigQuit);</span><br><span class="line"></span><br><span class="line">  vfprintf_ = runtime_options.GetOrDefault(Opt::HookVfprintf);</span><br><span class="line">  exit_ = runtime_options.GetOrDefault(Opt::HookExit);</span><br><span class="line">  abort_ = runtime_options.GetOrDefault(Opt::HookAbort);</span><br><span class="line"></span><br><span class="line">  default_stack_size_ = runtime_options.GetOrDefault(Opt::StackSize);</span><br><span class="line">  use_tombstoned_traces_ = runtime_options.GetOrDefault(Opt::UseTombstonedTraces);</span><br><span class="line">#if !defined(ART_TARGET_ANDROID)</span><br><span class="line">  CHECK(!use_tombstoned_traces_)</span><br><span class="line">      &lt;&lt; &quot;-Xusetombstonedtraces is only supported in an Android environment&quot;;</span><br><span class="line">#endif</span><br><span class="line">  stack_trace_file_ = runtime_options.ReleaseOrDefault(Opt::StackTraceFile);</span><br><span class="line"></span><br><span class="line">  compiler_executable_ = runtime_options.ReleaseOrDefault(Opt::Compiler);</span><br><span class="line">  compiler_options_ = runtime_options.ReleaseOrDefault(Opt::CompilerOptions);</span><br><span class="line">  for (StringPiece option : Runtime::Current()-&gt;GetCompilerOptions()) &#123;</span><br><span class="line">    if (option.starts_with(&quot;--debuggable&quot;)) &#123;</span><br><span class="line">      SetJavaDebuggable(true);</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  image_compiler_options_ = runtime_options.ReleaseOrDefault(Opt::ImageCompilerOptions);</span><br><span class="line">  image_location_ = runtime_options.GetOrDefault(Opt::Image);</span><br><span class="line"></span><br><span class="line">  max_spins_before_thin_lock_inflation_ =</span><br><span class="line">      runtime_options.GetOrDefault(Opt::MaxSpinsBeforeThinLockInflation);</span><br><span class="line"></span><br><span class="line">  monitor_list_ = new MonitorList;</span><br><span class="line">  monitor_pool_ = MonitorPool::Create();</span><br><span class="line">  thread_list_ = new ThreadList(runtime_options.GetOrDefault(Opt::ThreadSuspendTimeout));</span><br><span class="line">  intern_table_ = new InternTable;</span><br><span class="line"></span><br><span class="line">  verify_ = runtime_options.GetOrDefault(Opt::Verify);</span><br><span class="line">  allow_dex_file_fallback_ = !runtime_options.Exists(Opt::NoDexFileFallback);</span><br><span class="line"></span><br><span class="line">  target_sdk_version_ = runtime_options.GetOrDefault(Opt::TargetSdkVersion);</span><br><span class="line"></span><br><span class="line">  // Check whether to enforce hidden API access checks. The checks are disabled</span><br><span class="line">  // by default and we only enable them if:</span><br><span class="line">  // (a) runtime was started with a flag that enables the checks, or</span><br><span class="line">  // (b) Zygote forked a new process that is not exempt (see ZygoteHooks).</span><br><span class="line">  //hidden_api检查</span><br><span class="line">  bool do_hidden_api_checks = runtime_options.Exists(Opt::HiddenApiChecks);</span><br><span class="line">  DCHECK(!is_zygote_ || !do_hidden_api_checks);</span><br><span class="line">  // TODO pass the actual enforcement policy in, rather than just a single bit.</span><br><span class="line">  // As is, we&apos;re encoding some logic here about which specific policy to use, which would be better</span><br><span class="line">  // controlled by the framework.</span><br><span class="line">  hidden_api_policy_ = do_hidden_api_checks</span><br><span class="line">      ? hiddenapi::EnforcementPolicy::kDarkGreyAndBlackList</span><br><span class="line">      : hiddenapi::EnforcementPolicy::kNoChecks;</span><br><span class="line"></span><br><span class="line">  no_sig_chain_ = runtime_options.Exists(Opt::NoSigChain);</span><br><span class="line">  force_native_bridge_ = runtime_options.Exists(Opt::ForceNativeBridge);</span><br><span class="line"></span><br><span class="line">  Split(runtime_options.GetOrDefault(Opt::CpuAbiList), &apos;,&apos;, &amp;cpu_abilist_);</span><br><span class="line"></span><br><span class="line">  fingerprint_ = runtime_options.ReleaseOrDefault(Opt::Fingerprint);</span><br><span class="line"></span><br><span class="line">  if (runtime_options.GetOrDefault(Opt::Interpret)) &#123;</span><br><span class="line">    GetInstrumentation()-&gt;ForceInterpretOnly();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  zygote_max_failed_boots_ = runtime_options.GetOrDefault(Opt::ZygoteMaxFailedBoots);</span><br><span class="line">  experimental_flags_ = runtime_options.GetOrDefault(Opt::Experimental);</span><br><span class="line">  is_low_memory_mode_ = runtime_options.Exists(Opt::LowMemoryMode);</span><br><span class="line">  madvise_random_access_ = runtime_options.GetOrDefault(Opt::MadviseRandomAccess);</span><br><span class="line"></span><br><span class="line">  plugins_ = runtime_options.ReleaseOrDefault(Opt::Plugins);</span><br><span class="line">  agent_specs_ = runtime_options.ReleaseOrDefault(Opt::AgentPath);</span><br><span class="line">  // TODO Add back in -agentlib</span><br><span class="line">  // for (auto lib : runtime_options.ReleaseOrDefault(Opt::AgentLib)) &#123;</span><br><span class="line">  //   agents_.push_back(lib);</span><br><span class="line">  // &#125;</span><br><span class="line"></span><br><span class="line">  float foreground_heap_growth_multiplier;</span><br><span class="line">  if (is_low_memory_mode_ &amp;&amp; !runtime_options.Exists(Opt::ForegroundHeapGrowthMultiplier)) &#123;</span><br><span class="line">    // If low memory mode, use 1.0 as the multiplier by default.</span><br><span class="line">    foreground_heap_growth_multiplier = 1.0f;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    foreground_heap_growth_multiplier =</span><br><span class="line">        runtime_options.GetOrDefault(Opt::ForegroundHeapGrowthMultiplier) +</span><br><span class="line">            kExtraDefaultHeapGrowthMultiplier;</span><br><span class="line">  &#125;</span><br><span class="line">  XGcOption xgc_option = runtime_options.GetOrDefault(Opt::GcOption);</span><br><span class="line">  //创建堆</span><br><span class="line">  heap_ = new gc::Heap(runtime_options.GetOrDefault(Opt::MemoryInitialSize),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapGrowthLimit),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapMinFree),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapMaxFree),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapTargetUtilization),</span><br><span class="line">                       foreground_heap_growth_multiplier,</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::MemoryMaximumSize),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::NonMovingSpaceCapacity),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::Image),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::ImageInstructionSet),</span><br><span class="line">                       // Override the collector type to CC if the read barrier config.</span><br><span class="line">                       kUseReadBarrier ? gc::kCollectorTypeCC : xgc_option.collector_type_,</span><br><span class="line">                       kUseReadBarrier ? BackgroundGcOption(gc::kCollectorTypeCCBackground)</span><br><span class="line">                                       : runtime_options.GetOrDefault(Opt::BackgroundGc),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectSpace),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectThreshold),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::ParallelGCThreads),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::ConcGCThreads),</span><br><span class="line">                       runtime_options.Exists(Opt::LowMemoryMode),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LongPauseLogThreshold),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LongGCLogThreshold),</span><br><span class="line">                       runtime_options.Exists(Opt::IgnoreMaxFootprint),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::UseTLAB),</span><br><span class="line">                       xgc_option.verify_pre_gc_heap_,</span><br><span class="line">                       xgc_option.verify_pre_sweeping_heap_,</span><br><span class="line">                       xgc_option.verify_post_gc_heap_,</span><br><span class="line">                       xgc_option.verify_pre_gc_rosalloc_,</span><br><span class="line">                       xgc_option.verify_pre_sweeping_rosalloc_,</span><br><span class="line">                       xgc_option.verify_post_gc_rosalloc_,</span><br><span class="line">                       xgc_option.gcstress_,</span><br><span class="line">                       xgc_option.measure_,</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::EnableHSpaceCompactForOOM),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HSpaceCompactForOOMMinIntervalsMs));</span><br><span class="line"></span><br><span class="line">  if (!heap_-&gt;HasBootImageSpace() &amp;&amp; !allow_dex_file_fallback_) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;Dex file fallback disabled, cannot continue without image.&quot;;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dump_gc_performance_on_shutdown_ = runtime_options.Exists(Opt::DumpGCPerformanceOnShutdown);</span><br><span class="line"></span><br><span class="line">  jdwp_options_ = runtime_options.GetOrDefault(Opt::JdwpOptions);</span><br><span class="line">  jdwp_provider_ = runtime_options.GetOrDefault(Opt::JdwpProvider);</span><br><span class="line">  switch (jdwp_provider_) &#123;</span><br><span class="line">    case JdwpProvider::kNone: &#123;</span><br><span class="line">      VLOG(jdwp) &lt;&lt; &quot;Disabling all JDWP support.&quot;;</span><br><span class="line">      if (!jdwp_options_.empty()) &#123;</span><br><span class="line">        bool has_transport = jdwp_options_.find(&quot;transport&quot;) != std::string::npos;</span><br><span class="line">        const char* transport_internal = !has_transport ? &quot;transport=dt_android_adb,&quot; : &quot;&quot;;</span><br><span class="line">        std::string adb_connection_args =</span><br><span class="line">            std::string(&quot;  -XjdwpProvider:adbconnection -XjdwpOptions:&quot;) + jdwp_options_;</span><br><span class="line">        LOG(WARNING) &lt;&lt; &quot;Jdwp options given when jdwp is disabled! You probably want to enable &quot;</span><br><span class="line">                     &lt;&lt; &quot;jdwp with one of:&quot; &lt;&lt; std::endl</span><br><span class="line">                     &lt;&lt; &quot;  -XjdwpProvider:internal &quot;</span><br><span class="line">                     &lt;&lt; &quot;-XjdwpOptions:&quot; &lt;&lt; transport_internal &lt;&lt; jdwp_options_ &lt;&lt; std::endl</span><br><span class="line">                     &lt;&lt; &quot;  -Xplugin:libopenjdkjvmti&quot; &lt;&lt; (kIsDebugBuild ? &quot;d&quot; : &quot;&quot;) &lt;&lt; &quot;.so &quot;</span><br><span class="line">                     &lt;&lt; &quot;-agentpath:libjdwp.so=&quot; &lt;&lt; jdwp_options_ &lt;&lt; std::endl</span><br><span class="line">                     &lt;&lt; (has_transport ? &quot;&quot; : adb_connection_args);</span><br><span class="line">      &#125;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    case JdwpProvider::kInternal: &#123;</span><br><span class="line">      if (runtime_options.Exists(Opt::JdwpOptions)) &#123;</span><br><span class="line">        JDWP::JdwpOptions ops;</span><br><span class="line">        if (!JDWP::ParseJdwpOptions(runtime_options.GetOrDefault(Opt::JdwpOptions), &amp;ops)) &#123;</span><br><span class="line">          LOG(ERROR) &lt;&lt; &quot;failed to parse jdwp options!&quot;;</span><br><span class="line">          return false;</span><br><span class="line">        &#125;</span><br><span class="line">        Dbg::ConfigureJdwp(ops);</span><br><span class="line">      &#125;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    case JdwpProvider::kAdbConnection: &#123;</span><br><span class="line">      constexpr const char* plugin_name = kIsDebugBuild ? &quot;libadbconnectiond.so&quot;</span><br><span class="line">                                                        : &quot;libadbconnection.so&quot;;</span><br><span class="line">      plugins_.push_back(Plugin::Create(plugin_name));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  callbacks_-&gt;AddThreadLifecycleCallback(Dbg::GetThreadLifecycleCallback());</span><br><span class="line">  callbacks_-&gt;AddClassLoadCallback(Dbg::GetClassLoadCallback());</span><br><span class="line"></span><br><span class="line">  jit_options_.reset(jit::JitOptions::CreateFromRuntimeArguments(runtime_options));</span><br><span class="line">  if (IsAotCompiler()) &#123;</span><br><span class="line">    // If we are already the compiler at this point, we must be dex2oat. Don&apos;t create the jit in</span><br><span class="line">    // this case.</span><br><span class="line">    // If runtime_options doesn&apos;t have UseJIT set to true then CreateFromRuntimeArguments returns</span><br><span class="line">    // null and we don&apos;t create the jit.</span><br><span class="line">    jit_options_-&gt;SetUseJitCompilation(false);</span><br><span class="line">    jit_options_-&gt;SetSaveProfilingInfo(false);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Use MemMap arena pool for jit, malloc otherwise. Malloc arenas are faster to allocate but</span><br><span class="line">  // can&apos;t be trimmed as easily.</span><br><span class="line">  const bool use_malloc = IsAotCompiler();</span><br><span class="line">  arena_pool_.reset(new ArenaPool(use_malloc, /* low_4gb */ false));</span><br><span class="line">  jit_arena_pool_.reset(</span><br><span class="line">      new ArenaPool(/* use_malloc */ false, /* low_4gb */ false, &quot;CompilerMetadata&quot;));</span><br><span class="line"></span><br><span class="line">  if (IsAotCompiler() &amp;&amp; Is64BitInstructionSet(kRuntimeISA)) &#123;</span><br><span class="line">    // 4gb, no malloc. Explanation in header.</span><br><span class="line">    low_4gb_arena_pool_.reset(new ArenaPool(/* use_malloc */ false, /* low_4gb */ true));</span><br><span class="line">  &#125;</span><br><span class="line">  linear_alloc_.reset(CreateLinearAlloc());</span><br><span class="line"></span><br><span class="line">  BlockSignals();</span><br><span class="line">  InitPlatformSignalHandlers();</span><br><span class="line"></span><br><span class="line">  // Change the implicit checks flags based on runtime architecture.</span><br><span class="line">  switch (kRuntimeISA) &#123;</span><br><span class="line">    case InstructionSet::kArm:</span><br><span class="line">    case InstructionSet::kThumb2:</span><br><span class="line">    case InstructionSet::kX86:</span><br><span class="line">    case InstructionSet::kArm64:</span><br><span class="line">    case InstructionSet::kX86_64:</span><br><span class="line">    case InstructionSet::kMips:</span><br><span class="line">    case InstructionSet::kMips64:</span><br><span class="line">      implicit_null_checks_ = true;</span><br><span class="line">      // Installing stack protection does not play well with valgrind.</span><br><span class="line">      implicit_so_checks_ = !(RUNNING_ON_MEMORY_TOOL &amp;&amp; kMemoryToolIsValgrind);</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      // Keep the defaults.</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!no_sig_chain_) &#123;</span><br><span class="line">    // Dex2Oat&apos;s Runtime does not need the signal chain or the fault handler.</span><br><span class="line">    if (implicit_null_checks_ || implicit_so_checks_ || implicit_suspend_checks_) &#123;</span><br><span class="line">      fault_manager.Init();</span><br><span class="line"></span><br><span class="line">      // These need to be in a specific order.  The null point check handler must be</span><br><span class="line">      // after the suspend check and stack overflow check handlers.</span><br><span class="line">      //</span><br><span class="line">      // Note: the instances attach themselves to the fault manager and are handled by it. The manager</span><br><span class="line">      //       will delete the instance on Shutdown().</span><br><span class="line">      if (implicit_suspend_checks_) &#123;</span><br><span class="line">        new SuspensionHandler(&amp;fault_manager);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (implicit_so_checks_) &#123;</span><br><span class="line">        new StackOverflowHandler(&amp;fault_manager);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (implicit_null_checks_) &#123;</span><br><span class="line">        new NullPointerHandler(&amp;fault_manager);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (kEnableJavaStackTraceHandler) &#123;</span><br><span class="line">        new JavaStackTraceHandler(&amp;fault_manager);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string error_msg;</span><br><span class="line">  //创建JavaVMExt实例</span><br><span class="line">  java_vm_ = JavaVMExt::Create(this, runtime_options, &amp;error_msg);</span><br><span class="line">  if (java_vm_.get() == nullptr) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;Could not initialize JavaVMExt: &quot; &lt;&lt; error_msg;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Add the JniEnv handler.</span><br><span class="line">  // TODO Refactor this stuff.</span><br><span class="line">  java_vm_-&gt;AddEnvironmentHook(JNIEnvExt::GetEnvHandler);</span><br><span class="line"></span><br><span class="line">  //创建线程</span><br><span class="line">  Thread::Startup();</span><br><span class="line"></span><br><span class="line">  // ClassLinker needs an attached thread, but we can&apos;t fully attach a thread without creating</span><br><span class="line">  // objects. We can&apos;t supply a thread group yet; it will be fixed later. Since we are the main</span><br><span class="line">  // thread, we do not get a java peer.</span><br><span class="line">  Thread* self = Thread::Attach(&quot;main&quot;, false, nullptr, false);</span><br><span class="line">  CHECK_EQ(self-&gt;GetThreadId(), ThreadList::kMainThreadId);</span><br><span class="line">  CHECK(self != nullptr);</span><br><span class="line"></span><br><span class="line">  self-&gt;SetCanCallIntoJava(!IsAotCompiler());</span><br><span class="line"></span><br><span class="line">  // Set us to runnable so tools using a runtime can allocate and GC by default</span><br><span class="line">  self-&gt;TransitionFromSuspendedToRunnable();</span><br><span class="line"></span><br><span class="line">  // Now we&apos;re attached, we can take the heap locks and validate the heap.</span><br><span class="line">  GetHeap()-&gt;EnableObjectValidation();</span><br><span class="line"></span><br><span class="line">  CHECK_GE(GetHeap()-&gt;GetContinuousSpaces().size(), 1U);</span><br><span class="line">  if (UNLIKELY(IsAotCompiler())) &#123;</span><br><span class="line">    class_linker_ = new AotClassLinker(intern_table_);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    class_linker_ = new ClassLinker(intern_table_);</span><br><span class="line">  &#125;</span><br><span class="line">  if (GetHeap()-&gt;HasBootImageSpace()) &#123;</span><br><span class="line">    bool result = class_linker_-&gt;InitFromBootImage(&amp;error_msg);</span><br><span class="line">    if (!result) &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; &quot;Could not initialize from image: &quot; &lt;&lt; error_msg;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (kIsDebugBuild) &#123;</span><br><span class="line">      for (auto image_space : GetHeap()-&gt;GetBootImageSpaces()) &#123;</span><br><span class="line">        image_space-&gt;VerifyImageAllocations();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (boot_class_path_string_.empty()) &#123;</span><br><span class="line">      // The bootclasspath is not explicitly specified: construct it from the loaded dex files.</span><br><span class="line">      const std::vector&lt;const DexFile*&gt;&amp; boot_class_path = GetClassLinker()-&gt;GetBootClassPath();</span><br><span class="line">      std::vector&lt;std::string&gt; dex_locations;</span><br><span class="line">      dex_locations.reserve(boot_class_path.size());</span><br><span class="line">      for (const DexFile* dex_file : boot_class_path) &#123;</span><br><span class="line">        dex_locations.push_back(dex_file-&gt;GetLocation());</span><br><span class="line">      &#125;</span><br><span class="line">      boot_class_path_string_ = android::base::Join(dex_locations, &apos;:&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      ScopedTrace trace2(&quot;AddImageStringsToTable&quot;);</span><br><span class="line">      GetInternTable()-&gt;AddImagesStringsToTable(heap_-&gt;GetBootImageSpaces());</span><br><span class="line">    &#125;</span><br><span class="line">    if (IsJavaDebuggable()) &#123;</span><br><span class="line">      // Now that we have loaded the boot image, deoptimize its methods if we are running</span><br><span class="line">      // debuggable, as the code may have been compiled non-debuggable.</span><br><span class="line">      DeoptimizeBootImage();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    std::vector&lt;std::string&gt; dex_filenames;</span><br><span class="line">    Split(boot_class_path_string_, &apos;:&apos;, &amp;dex_filenames);</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::string&gt; dex_locations;</span><br><span class="line">    if (!runtime_options.Exists(Opt::BootClassPathLocations)) &#123;</span><br><span class="line">      dex_locations = dex_filenames;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      dex_locations = runtime_options.GetOrDefault(Opt::BootClassPathLocations);</span><br><span class="line">      CHECK_EQ(dex_filenames.size(), dex_locations.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; boot_class_path;</span><br><span class="line">    if (runtime_options.Exists(Opt::BootClassPathDexList)) &#123;</span><br><span class="line">      boot_class_path.swap(*runtime_options.GetOrDefault(Opt::BootClassPathDexList));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      //打开dex文件</span><br><span class="line">      OpenDexFiles(dex_filenames,</span><br><span class="line">                   dex_locations,</span><br><span class="line">                   runtime_options.GetOrDefault(Opt::Image),</span><br><span class="line">                   &amp;boot_class_path);</span><br><span class="line">    &#125;</span><br><span class="line">    instruction_set_ = runtime_options.GetOrDefault(Opt::ImageInstructionSet);</span><br><span class="line">    if (!class_linker_-&gt;InitWithoutImage(std::move(boot_class_path), &amp;error_msg)) &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; &quot;Could not initialize without image: &quot; &lt;&lt; error_msg;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // TODO: Should we move the following to InitWithoutImage?</span><br><span class="line">    SetInstructionSet(instruction_set_);</span><br><span class="line">    for (uint32_t i = 0; i &lt; kCalleeSaveSize; i++) &#123;</span><br><span class="line">      CalleeSaveType type = CalleeSaveType(i);</span><br><span class="line">      if (!HasCalleeSaveMethod(type)) &#123;</span><br><span class="line">        SetCalleeSaveMethod(CreateCalleeSaveMethod(), type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  CHECK(class_linker_ != nullptr);</span><br><span class="line"></span><br><span class="line">  verifier::MethodVerifier::Init();</span><br><span class="line"></span><br><span class="line">  if (runtime_options.Exists(Opt::MethodTrace)) &#123;</span><br><span class="line">    trace_config_.reset(new TraceConfig());</span><br><span class="line">    trace_config_-&gt;trace_file = runtime_options.ReleaseOrDefault(Opt::MethodTraceFile);</span><br><span class="line">    trace_config_-&gt;trace_file_size = runtime_options.ReleaseOrDefault(Opt::MethodTraceFileSize);</span><br><span class="line">    trace_config_-&gt;trace_mode = Trace::TraceMode::kMethodTracing;</span><br><span class="line">    trace_config_-&gt;trace_output_mode = runtime_options.Exists(Opt::MethodTraceStreaming) ?</span><br><span class="line">        Trace::TraceOutputMode::kStreaming :</span><br><span class="line">        Trace::TraceOutputMode::kFile;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // TODO: move this to just be an Trace::Start argument</span><br><span class="line">  Trace::SetDefaultClockSource(runtime_options.GetOrDefault(Opt::ProfileClock));</span><br><span class="line"></span><br><span class="line">  // Pre-allocate an OutOfMemoryError for the double-OOME case.</span><br><span class="line">  self-&gt;ThrowNewException(&quot;Ljava/lang/OutOfMemoryError;&quot;,</span><br><span class="line">                          &quot;OutOfMemoryError thrown while trying to throw OutOfMemoryError; &quot;</span><br><span class="line">                          &quot;no stack trace available&quot;);</span><br><span class="line">  pre_allocated_OutOfMemoryError_ = GcRoot&lt;mirror::Throwable&gt;(self-&gt;GetException());</span><br><span class="line">  self-&gt;ClearException();</span><br><span class="line"></span><br><span class="line">  // Pre-allocate a NoClassDefFoundError for the common case of failing to find a system class</span><br><span class="line">  // ahead of checking the application&apos;s class loader.</span><br><span class="line">  self-&gt;ThrowNewException(&quot;Ljava/lang/NoClassDefFoundError;&quot;,</span><br><span class="line">                          &quot;Class not found using the boot class loader; no stack trace available&quot;);</span><br><span class="line">  pre_allocated_NoClassDefFoundError_ = GcRoot&lt;mirror::Throwable&gt;(self-&gt;GetException());</span><br><span class="line">  self-&gt;ClearException();</span><br><span class="line"></span><br><span class="line">  // Runtime initialization is largely done now.</span><br><span class="line">  // We load plugins first since that can modify the runtime state slightly.</span><br><span class="line">  // Load all plugins</span><br><span class="line">  for (auto&amp; plugin : plugins_) &#123;</span><br><span class="line">    std::string err;</span><br><span class="line">    if (!plugin.Load(&amp;err)) &#123;</span><br><span class="line">      LOG(FATAL) &lt;&lt; plugin &lt;&lt; &quot; failed to load: &quot; &lt;&lt; err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Look for a native bridge.</span><br><span class="line">  //</span><br><span class="line">  // The intended flow here is, in the case of a running system:</span><br><span class="line">  //</span><br><span class="line">  // Runtime::Init() (zygote):</span><br><span class="line">  //   LoadNativeBridge -&gt; dlopen from cmd line parameter.</span><br><span class="line">  //  |</span><br><span class="line">  //  V</span><br><span class="line">  // Runtime::Start() (zygote):</span><br><span class="line">  //   No-op wrt native bridge.</span><br><span class="line">  //  |</span><br><span class="line">  //  | start app</span><br><span class="line">  //  V</span><br><span class="line">  // DidForkFromZygote(action)</span><br><span class="line">  //   action = kUnload -&gt; dlclose native bridge.</span><br><span class="line">  //   action = kInitialize -&gt; initialize library</span><br><span class="line">  //</span><br><span class="line">  //</span><br><span class="line">  // The intended flow here is, in the case of a simple dalvikvm call:</span><br><span class="line">  //</span><br><span class="line">  // Runtime::Init():</span><br><span class="line">  //   LoadNativeBridge -&gt; dlopen from cmd line parameter.</span><br><span class="line">  //  |</span><br><span class="line">  //  V</span><br><span class="line">  // Runtime::Start():</span><br><span class="line">  //   DidForkFromZygote(kInitialize) -&gt; try to initialize any native bridge given.</span><br><span class="line">  //   No-op wrt native bridge.</span><br><span class="line">  &#123;</span><br><span class="line">    std::string native_bridge_file_name = runtime_options.ReleaseOrDefault(Opt::NativeBridge);</span><br><span class="line">    is_native_bridge_loaded_ = LoadNativeBridge(native_bridge_file_name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Startup agents</span><br><span class="line">  // TODO Maybe we should start a new thread to run these on. Investigate RI behavior more.</span><br><span class="line">  for (auto&amp; agent_spec : agent_specs_) &#123;</span><br><span class="line">    // TODO Check err</span><br><span class="line">    int res = 0;</span><br><span class="line">    std::string err = &quot;&quot;;</span><br><span class="line">    ti::LoadError error;</span><br><span class="line">    std::unique_ptr&lt;ti::Agent&gt; agent = agent_spec.Load(&amp;res, &amp;error, &amp;err);</span><br><span class="line"></span><br><span class="line">    if (agent != nullptr) &#123;</span><br><span class="line">      agents_.push_back(std::move(agent));</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (error) &#123;</span><br><span class="line">      case ti::LoadError::kInitializationError:</span><br><span class="line">        LOG(FATAL) &lt;&lt; &quot;Unable to initialize agent!&quot;;</span><br><span class="line">        UNREACHABLE();</span><br><span class="line"></span><br><span class="line">      case ti::LoadError::kLoadingError:</span><br><span class="line">        LOG(ERROR) &lt;&lt; &quot;Unable to load an agent: &quot; &lt;&lt; err;</span><br><span class="line">        continue;</span><br><span class="line"></span><br><span class="line">      case ti::LoadError::kNoError:</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG(FATAL) &lt;&lt; &quot;Unreachable&quot;;</span><br><span class="line">    UNREACHABLE();</span><br><span class="line">  &#125;</span><br><span class="line">  &#123;</span><br><span class="line">    ScopedObjectAccess soa(self);</span><br><span class="line">    callbacks_-&gt;NextRuntimePhase(RuntimePhaseCallback::RuntimePhase::kInitialAgents);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  VLOG(startup) &lt;&lt; &quot;Runtime::Init exiting&quot;;</span><br><span class="line"></span><br><span class="line">  // Set OnlyUseSystemOatFiles only after boot classpath has been set up.</span><br><span class="line">  if (runtime_options.Exists(Opt::OnlyUseSystemOatFiles)) &#123;</span><br><span class="line">    oat_file_manager_-&gt;SetOnlyUseSystemOatFiles();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法比较长，主要是对Art虚拟机进行一序列初始化。比较重要的有，创建ART虚拟机堆，创建JavaVMExt实例，启动当前线程，加载OAT文件。</p>
<h4 id="2-3-startReg"><a href="#2-3-startReg" class="headerlink" title="2.3 startReg"></a>2.3 startReg</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> int AndroidRuntime::startReg(JNIEnv* env)</span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_NAME(&quot;RegisterAndroidNatives&quot;);</span><br><span class="line">    /*</span><br><span class="line">     * This hook causes all future threads created in this process to be</span><br><span class="line">     * attached to the JavaVM.  (This needs to go away in favor of JNI</span><br><span class="line">     * Attach calls.)</span><br><span class="line">     */</span><br><span class="line">     //设置线程创建方法为javaCreateThreadEtc</span><br><span class="line">    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);</span><br><span class="line"></span><br><span class="line">    ALOGV(&quot;--- registering native functions ---/n&quot;);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Every &quot;register&quot; function calls one or more things that return</span><br><span class="line">     * a local reference (e.g. FindClass).  Because we haven&apos;t really</span><br><span class="line">     * started the VM yet, they&apos;re all getting stored in the base frame</span><br><span class="line">     * and never released.  Use Push/Pop to manage the storage.</span><br><span class="line">     */</span><br><span class="line">    env-&gt;PushLocalFrame(200);</span><br><span class="line">    //进程JNI方法注册</span><br><span class="line">    if (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; 0) &#123;</span><br><span class="line">        env-&gt;PopLocalFrame(NULL);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;PopLocalFrame(NULL);</span><br><span class="line"></span><br><span class="line">    //createJavaThread(&quot;fubar&quot;, quickTest, (void*) &quot;hello&quot;);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-1-register-jni-procs"><a href="#2-3-1-register-jni-procs" class="headerlink" title="2.3.1 register_jni_procs"></a>2.3.1 register_jni_procs</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static int register_jni_procs(const RegJNIRec array[], size_t count, JNIEnv* env)</span><br><span class="line">&#123;</span><br><span class="line">    for (size_t i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        if (array[i].mProc(env) &lt; 0) &#123;</span><br><span class="line">#ifndef NDEBUG</span><br><span class="line">            ALOGD(&quot;----------!!! %s failed to load/n&quot;, array[i].mName);</span><br><span class="line">#endif</span><br><span class="line">            return -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>循环调用gRegJNI数组成员所对应的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">static const RegJNIRec gRegJNI[] = &#123;</span><br><span class="line">    REG_JNI(register_com_android_internal_os_RuntimeInit),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_ZygoteInit_nativeZygoteInit),</span><br><span class="line">    REG_JNI(register_android_os_SystemClock),</span><br><span class="line">    REG_JNI(register_android_util_EventLog),</span><br><span class="line">    REG_JNI(register_android_util_Log),</span><br><span class="line">    REG_JNI(register_android_util_MemoryIntArray),</span><br><span class="line">    REG_JNI(register_android_util_PathParser),</span><br><span class="line">    REG_JNI(register_android_util_StatsLog),</span><br><span class="line">    REG_JNI(register_android_util_StatsLogInternal),</span><br><span class="line">    REG_JNI(register_android_app_admin_SecurityLog),</span><br><span class="line">    REG_JNI(register_android_content_AssetManager),</span><br><span class="line">    REG_JNI(register_android_content_StringBlock),</span><br><span class="line">    REG_JNI(register_android_content_XmlBlock),</span><br><span class="line">    REG_JNI(register_android_content_res_ApkAssets),</span><br><span class="line">    REG_JNI(register_android_text_AndroidCharacter),</span><br><span class="line">    REG_JNI(register_android_text_Hyphenator),</span><br><span class="line">    REG_JNI(register_android_text_MeasuredParagraph),</span><br><span class="line">    REG_JNI(register_android_text_StaticLayout),</span><br><span class="line">    REG_JNI(register_android_view_InputDevice),</span><br><span class="line">    REG_JNI(register_android_view_KeyCharacterMap),</span><br><span class="line">    REG_JNI(register_android_os_Process),</span><br><span class="line">    REG_JNI(register_android_os_SystemProperties),</span><br><span class="line">    REG_JNI(register_android_os_Binder),</span><br><span class="line">    REG_JNI(register_android_os_Parcel),</span><br><span class="line">    REG_JNI(register_android_os_HidlSupport),</span><br><span class="line">    REG_JNI(register_android_os_HwBinder),</span><br><span class="line">    REG_JNI(register_android_os_HwBlob),</span><br><span class="line">    REG_JNI(register_android_os_HwParcel),</span><br><span class="line">    REG_JNI(register_android_os_HwRemoteBinder),</span><br><span class="line">    REG_JNI(register_android_os_NativeHandle),</span><br><span class="line">    REG_JNI(register_android_os_VintfObject),</span><br><span class="line">    REG_JNI(register_android_os_VintfRuntimeInfo),</span><br><span class="line">    REG_JNI(register_android_nio_utils),</span><br><span class="line">    REG_JNI(register_android_graphics_Canvas),</span><br><span class="line">    REG_JNI(register_android_graphics_Graphics),</span><br><span class="line">    REG_JNI(register_android_view_DisplayEventReceiver),</span><br><span class="line">    REG_JNI(register_android_view_RenderNode),</span><br><span class="line">    REG_JNI(register_android_view_RenderNodeAnimator),</span><br><span class="line">    REG_JNI(register_android_view_DisplayListCanvas),</span><br><span class="line">    REG_JNI(register_android_view_TextureLayer),</span><br><span class="line">    REG_JNI(register_android_view_ThreadedRenderer),</span><br><span class="line">    REG_JNI(register_android_view_Surface),</span><br><span class="line">    REG_JNI(register_android_view_SurfaceControl),</span><br><span class="line">    REG_JNI(register_android_view_SurfaceSession),</span><br><span class="line">    REG_JNI(register_android_view_TextureView),</span><br><span class="line">    REG_JNI(register_com_android_internal_view_animation_NativeInterpolatorFactoryHelper),</span><br><span class="line">    REG_JNI(register_com_google_android_gles_jni_EGLImpl),</span><br><span class="line">    REG_JNI(register_com_google_android_gles_jni_GLImpl),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_EGL14),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_EGLExt),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES10),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES10Ext),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES11),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES11Ext),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES20),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES30),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES31),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES31Ext),</span><br><span class="line">    REG_JNI(register_android_opengl_jni_GLES32),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_graphics_Bitmap),</span><br><span class="line">    REG_JNI(register_android_graphics_BitmapFactory),</span><br><span class="line">    REG_JNI(register_android_graphics_BitmapRegionDecoder),</span><br><span class="line">    REG_JNI(register_android_graphics_ByteBufferStreamAdaptor),</span><br><span class="line">    REG_JNI(register_android_graphics_Camera),</span><br><span class="line">    REG_JNI(register_android_graphics_CreateJavaOutputStreamAdaptor),</span><br><span class="line">    REG_JNI(register_android_graphics_CanvasProperty),</span><br><span class="line">    REG_JNI(register_android_graphics_ColorFilter),</span><br><span class="line">    REG_JNI(register_android_graphics_DrawFilter),</span><br><span class="line">    REG_JNI(register_android_graphics_FontFamily),</span><br><span class="line">    REG_JNI(register_android_graphics_GraphicBuffer),</span><br><span class="line">    REG_JNI(register_android_graphics_ImageDecoder),</span><br><span class="line">    REG_JNI(register_android_graphics_drawable_AnimatedImageDrawable),</span><br><span class="line">    REG_JNI(register_android_graphics_Interpolator),</span><br><span class="line">    REG_JNI(register_android_graphics_MaskFilter),</span><br><span class="line">    REG_JNI(register_android_graphics_Matrix),</span><br><span class="line">    REG_JNI(register_android_graphics_Movie),</span><br><span class="line">    REG_JNI(register_android_graphics_NinePatch),</span><br><span class="line">    REG_JNI(register_android_graphics_Paint),</span><br><span class="line">    REG_JNI(register_android_graphics_Path),</span><br><span class="line">    REG_JNI(register_android_graphics_PathMeasure),</span><br><span class="line">    REG_JNI(register_android_graphics_PathEffect),</span><br><span class="line">    REG_JNI(register_android_graphics_Picture),</span><br><span class="line">    REG_JNI(register_android_graphics_Region),</span><br><span class="line">    REG_JNI(register_android_graphics_Shader),</span><br><span class="line">    REG_JNI(register_android_graphics_SurfaceTexture),</span><br><span class="line">    REG_JNI(register_android_graphics_Typeface),</span><br><span class="line">    REG_JNI(register_android_graphics_YuvImage),</span><br><span class="line">    REG_JNI(register_android_graphics_drawable_AnimatedVectorDrawable),</span><br><span class="line">    REG_JNI(register_android_graphics_drawable_VectorDrawable),</span><br><span class="line">    REG_JNI(register_android_graphics_pdf_PdfDocument),</span><br><span class="line">    REG_JNI(register_android_graphics_pdf_PdfEditor),</span><br><span class="line">    REG_JNI(register_android_graphics_pdf_PdfRenderer),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_database_CursorWindow),</span><br><span class="line">    REG_JNI(register_android_database_SQLiteConnection),</span><br><span class="line">    REG_JNI(register_android_database_SQLiteGlobal),</span><br><span class="line">    REG_JNI(register_android_database_SQLiteDebug),</span><br><span class="line">    REG_JNI(register_android_os_Debug),</span><br><span class="line">    REG_JNI(register_android_os_FileObserver),</span><br><span class="line">    REG_JNI(register_android_os_GraphicsEnvironment),</span><br><span class="line">    REG_JNI(register_android_os_MessageQueue),</span><br><span class="line">    REG_JNI(register_android_os_SELinux),</span><br><span class="line">    REG_JNI(register_android_os_Trace),</span><br><span class="line">    REG_JNI(register_android_os_UEventObserver),</span><br><span class="line">    REG_JNI(register_android_net_LocalSocketImpl),</span><br><span class="line">    REG_JNI(register_android_net_NetworkUtils),</span><br><span class="line">    REG_JNI(register_android_os_MemoryFile),</span><br><span class="line">    REG_JNI(register_android_os_SharedMemory),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_ClassLoaderFactory),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_Zygote),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_ZygoteInit),</span><br><span class="line">    REG_JNI(register_com_android_internal_util_VirtualRefBasePtr),</span><br><span class="line">    REG_JNI(register_android_hardware_Camera),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_CameraMetadata),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_legacy_LegacyCameraDevice),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_legacy_PerfMeasurement),</span><br><span class="line">    REG_JNI(register_android_hardware_camera2_DngCreator),</span><br><span class="line">    REG_JNI(register_android_hardware_HardwareBuffer),</span><br><span class="line">    REG_JNI(register_android_hardware_SensorManager),</span><br><span class="line">    REG_JNI(register_android_hardware_SerialPort),</span><br><span class="line">    REG_JNI(register_android_hardware_SoundTrigger),</span><br><span class="line">    REG_JNI(register_android_hardware_UsbDevice),</span><br><span class="line">    REG_JNI(register_android_hardware_UsbDeviceConnection),</span><br><span class="line">    REG_JNI(register_android_hardware_UsbRequest),</span><br><span class="line">    REG_JNI(register_android_hardware_location_ActivityRecognitionHardware),</span><br><span class="line">    REG_JNI(register_android_media_AudioRecord),</span><br><span class="line">    REG_JNI(register_android_media_AudioSystem),</span><br><span class="line">    REG_JNI(register_android_media_AudioTrack),</span><br><span class="line">    REG_JNI(register_android_media_JetPlayer),</span><br><span class="line">    REG_JNI(register_android_media_MicrophoneInfo),</span><br><span class="line">    REG_JNI(register_android_media_RemoteDisplay),</span><br><span class="line">    REG_JNI(register_android_media_ToneGenerator),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_opengl_classes),</span><br><span class="line">    REG_JNI(register_android_server_NetworkManagementSocketTagger),</span><br><span class="line">    REG_JNI(register_android_ddm_DdmHandleNativeHeap),</span><br><span class="line">    REG_JNI(register_android_backup_BackupDataInput),</span><br><span class="line">    REG_JNI(register_android_backup_BackupDataOutput),</span><br><span class="line">    REG_JNI(register_android_backup_FileBackupHelperBase),</span><br><span class="line">    REG_JNI(register_android_backup_BackupHelperDispatcher),</span><br><span class="line">    REG_JNI(register_android_app_backup_FullBackup),</span><br><span class="line">    REG_JNI(register_android_app_Activity),</span><br><span class="line">    REG_JNI(register_android_app_ActivityThread),</span><br><span class="line">    REG_JNI(register_android_app_NativeActivity),</span><br><span class="line">    REG_JNI(register_android_util_jar_StrictJarFile),</span><br><span class="line">    REG_JNI(register_android_view_InputChannel),</span><br><span class="line">    REG_JNI(register_android_view_InputEventReceiver),</span><br><span class="line">    REG_JNI(register_android_view_InputEventSender),</span><br><span class="line">    REG_JNI(register_android_view_InputQueue),</span><br><span class="line">    REG_JNI(register_android_view_KeyEvent),</span><br><span class="line">    REG_JNI(register_android_view_MotionEvent),</span><br><span class="line">    REG_JNI(register_android_view_PointerIcon),</span><br><span class="line">    REG_JNI(register_android_view_VelocityTracker),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_content_res_ObbScanner),</span><br><span class="line">    REG_JNI(register_android_content_res_Configuration),</span><br><span class="line"></span><br><span class="line">    REG_JNI(register_android_animation_PropertyValuesHolder),</span><br><span class="line">    REG_JNI(register_android_security_Scrypt),</span><br><span class="line">    REG_JNI(register_com_android_internal_content_NativeLibraryHelper),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_FuseAppLoop),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面有100多个成员变量，每个成员变量代表一个类文件的JNI映射，通过宏定义的方式调用相应的方法。</p>
<p>下面就一个例子，分析下注册的过程</p>
<h5 id="2-3-2-register-com-android-internal-os-RuntimeInit"><a href="#2-3-2-register-com-android-internal-os-RuntimeInit" class="headerlink" title="2.3.2  register_com_android_internal_os_RuntimeInit"></a>2.3.2  register_com_android_internal_os_RuntimeInit</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int register_com_android_internal_os_RuntimeInit(JNIEnv* env)</span><br><span class="line">&#123;</span><br><span class="line">    const JNINativeMethod methods[] = &#123;</span><br><span class="line">        &#123; &quot;nativeFinishInit&quot;, &quot;()V&quot;,</span><br><span class="line">            (void*) com_android_internal_os_RuntimeInit_nativeFinishInit &#125;,</span><br><span class="line">        &#123; &quot;nativeSetExitWithoutCleanup&quot;, &quot;(Z)V&quot;,</span><br><span class="line">            (void*) com_android_internal_os_RuntimeInit_nativeSetExitWithoutCleanup &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    return jniRegisterNativeMethods(env, &quot;com/android/internal/os/RuntimeInit&quot;,</span><br><span class="line">        methods, NELEM(methods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>jniRegisterNativeMethods最后调用到jni.h中的RegisterNatives方法</p>
<h5 id="2-3-3-RegisterNatives"><a href="#2-3-3-RegisterNatives" class="headerlink" title="2.3.3 RegisterNatives"></a>2.3.3 RegisterNatives</h5><p>[-&gt;jni.h]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jint RegisterNatives(jclass clazz, const JNINativeMethod* methods,</span><br><span class="line">      jint nMethods)</span><br><span class="line">  &#123; return functions-&gt;RegisterNatives(this, clazz, methods, nMethods); &#125;</span><br></pre></td></tr></table></figure>
<p>functions是指向<code>JNINativeInterface</code>结构体指针，也就是将调用下面方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#if defined(__cplusplus)</span><br><span class="line">typedef _JNIEnv JNIEnv;</span><br><span class="line">typedef _JavaVM JavaVM;</span><br><span class="line">#else</span><br><span class="line">typedef const struct JNINativeInterface* JNIEnv;</span><br><span class="line">typedef const struct JNIInvokeInterface* JavaVM;</span><br><span class="line">#endif</span><br><span class="line">struct _JavaVM &#123;</span><br><span class="line">    const struct JNIInvokeInterface* functions;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">struct _JNIEnv &#123;</span><br><span class="line">      /* do not rename this; it does not seem to be entirely opaque */</span><br><span class="line">      const struct JNINativeInterface* functions;</span><br><span class="line">      ...</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> jint (*RegisterNatives)(JNIEnv*, jclass, const JNINativeMethod*,jint);</span><br></pre></td></tr></table></figure>
<p>通过这种方法java层的nativeFinishInit与native层的com_android_internal_os_RuntimeInit_nativeFinishInit就完成了映射，后面通过JNIEvn这个变量就可以访问java中的方法了。</p>
<p>虚拟机中有两个重要的变量JavaVM和JNIEnv:</p>
<ul>
<li><code>JavaVM</code>：进程虚拟机环境，每个进程有且只有一个JavaVM实例</li>
<li><code>JNIEnv</code>：线程上下文环境，每个线程有且只有一个JNIEnv实例，通过该变量调用Java中的代码</li>
</ul>
<h3 id="三、动态库加载分析"><a href="#三、动态库加载分析" class="headerlink" title="三、动态库加载分析"></a>三、动态库加载分析</h3><p>JNI注册除了上面通过手动注册外，一般都是通过System.loadLibrary方法，下面就这个过程进行分析。</p>
<h4 id="3-1-System-loadLibrary"><a href="#3-1-System-loadLibrary" class="headerlink" title="3.1 System.loadLibrary"></a>3.1 System.loadLibrary</h4><p>[-&gt;System.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void loadLibrary(String libname) &#123;</span><br><span class="line">       Runtime.getRuntime().loadLibrary0(VMStack.getCallingClassLoader(), libname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-Runtime-loadLibrary0"><a href="#3-2-Runtime-loadLibrary0" class="headerlink" title="3.2 Runtime.loadLibrary0"></a>3.2 Runtime.loadLibrary0</h4><p>[-&gt;Runtime.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">synchronized void loadLibrary0(ClassLoader loader, String libname) &#123;</span><br><span class="line">       if (libname.indexOf((int)File.separatorChar) != -1) &#123;</span><br><span class="line">           throw new UnsatisfiedLinkError(</span><br><span class="line">   &quot;Directory separator should not appear in library name: &quot; + libname);</span><br><span class="line">       &#125;</span><br><span class="line">       String libraryName = libname;</span><br><span class="line">       if (loader != null) &#123;</span><br><span class="line">           //查找库</span><br><span class="line">           String filename = loader.findLibrary(libraryName);</span><br><span class="line">           if (filename == null) &#123;</span><br><span class="line">               // It&apos;s not necessarily true that the ClassLoader used</span><br><span class="line">               // System.mapLibraryName, but the default setup does, and it&apos;s</span><br><span class="line">               // misleading to say we didn&apos;t find &quot;libMyLibrary.so&quot; when we</span><br><span class="line">               // actually searched for &quot;liblibMyLibrary.so.so&quot;.</span><br><span class="line">               throw new UnsatisfiedLinkError(loader + &quot; couldn&apos;t find /&quot;&quot; +</span><br><span class="line">                                              System.mapLibraryName(libraryName) + &quot;/&quot;&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">           //加载库</span><br><span class="line">           String error = nativeLoad(filename, loader);</span><br><span class="line">           if (error != null) &#123;</span><br><span class="line">               throw new UnsatisfiedLinkError(error);</span><br><span class="line">           &#125;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       //见3.2.2.1节，映射库的名字</span><br><span class="line">       String filename = System.mapLibraryName(libraryName);</span><br><span class="line">       List&lt;String&gt; candidates = new ArrayList&lt;String&gt;();</span><br><span class="line">       String lastError = null;</span><br><span class="line">       //getLibPaths见3.5节</span><br><span class="line">       for (String directory : getLibPaths()) &#123;</span><br><span class="line">           String candidate = directory + filename;</span><br><span class="line">           candidates.add(candidate);</span><br><span class="line">           //判断目标动态库是否存在</span><br><span class="line">           if (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line">               //见3.4节，加载库</span><br><span class="line">               String error = nativeLoad(candidate, loader);</span><br><span class="line">               if (error == null) &#123;</span><br><span class="line">                   return; // We successfully loaded the library. Job done.</span><br><span class="line">               &#125;</span><br><span class="line">               lastError = error;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (lastError != null) &#123;</span><br><span class="line">           throw new UnsatisfiedLinkError(lastError);</span><br><span class="line">       &#125;</span><br><span class="line">       throw new UnsatisfiedLinkError(&quot;Library &quot; + libraryName + &quot; not found; tried &quot; + candidates);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里核心的操作时nativeLoad方法，来加载so动态库，注意该方法为同步方法。</p>
<p>如果classload为空，则从默认mLibPaths下查看库是否存在并加载</p>
<p>如果classload不为空，则通过findLibrary查找库并加载</p>
<h4 id="3-3-findLibrary"><a href="#3-3-findLibrary" class="headerlink" title="3.3 findLibrary"></a>3.3 findLibrary</h4><p>[-&gt;BaseDexClassLoader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public String findLibrary(String name) &#123;</span><br><span class="line">       return pathList.findLibrary(name);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Classloader一般都是PathClassLoader，由于PathClassLoader继承于BaseDexClassLoader，没有复写该方法，所以调用的是BaseDexClassLoader方法。</p>
<h5 id="3-3-1-DexPathList初始化"><a href="#3-3-1-DexPathList初始化" class="headerlink" title="3.3.1 DexPathList初始化"></a>3.3.1 DexPathList初始化</h5><p>[-&gt;BaseDexClassLoader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public BaseDexClassLoader(String dexPath, File optimizedDirectory,</span><br><span class="line">           String librarySearchPath, ClassLoader parent, boolean isTrusted) &#123;</span><br><span class="line">       super(parent);</span><br><span class="line">       this.pathList = new DexPathList(this, dexPath, librarySearchPath, null, isTrusted);</span><br><span class="line"></span><br><span class="line">       if (reporter != null) &#123;</span><br><span class="line">           reportClassLoaderChain();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-3-1-1-new-DexPathList"><a href="#3-3-1-1-new-DexPathList" class="headerlink" title="3.3.1.1  new DexPathList"></a>3.3.1.1  new DexPathList</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">DexPathList(ClassLoader definingContext, String dexPath,</span><br><span class="line">           String librarySearchPath, File optimizedDirectory, boolean isTrusted) &#123;</span><br><span class="line">       if (definingContext == null) &#123;</span><br><span class="line">           throw new NullPointerException(&quot;definingContext == null&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (dexPath == null) &#123;</span><br><span class="line">           throw new NullPointerException(&quot;dexPath == null&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (optimizedDirectory != null) &#123;</span><br><span class="line">           if (!optimizedDirectory.exists())  &#123;</span><br><span class="line">               throw new IllegalArgumentException(</span><br><span class="line">                       &quot;optimizedDirectory doesn&apos;t exist: &quot;</span><br><span class="line">                       + optimizedDirectory);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (!(optimizedDirectory.canRead()</span><br><span class="line">                           &amp;&amp; optimizedDirectory.canWrite())) &#123;</span><br><span class="line">               throw new IllegalArgumentException(</span><br><span class="line">                       &quot;optimizedDirectory not readable/writable: &quot;</span><br><span class="line">                       + optimizedDirectory);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       this.definingContext = definingContext;</span><br><span class="line"></span><br><span class="line">       ArrayList&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();</span><br><span class="line">       // save dexPath for BaseDexClassLoader</span><br><span class="line">       //所有的dexFile文件</span><br><span class="line">       this.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                                          suppressedExceptions, definingContext, isTrusted);</span><br><span class="line"></span><br><span class="line">       // Native libraries may exist in both the system and</span><br><span class="line">       // application library paths, and we use this search order:</span><br><span class="line">       //</span><br><span class="line">       //   1. This class loader&apos;s library path for application libraries (librarySearchPath):</span><br><span class="line">       //   1.1. Native library directories</span><br><span class="line">       //   1.2. Path to libraries in apk-files</span><br><span class="line">       //   2. The VM&apos;s library path from the system property for system libraries</span><br><span class="line">       //      also known as java.library.path</span><br><span class="line">       //</span><br><span class="line">       // This order was reversed prior to Gingerbread; see http://b/2933456.</span><br><span class="line">       //app目录下的native库</span><br><span class="line">       this.nativeLibraryDirectories = splitPaths(librarySearchPath, false);</span><br><span class="line">       //系统目录下的native库</span><br><span class="line">       this.systemNativeLibraryDirectories =</span><br><span class="line">               splitPaths(System.getProperty(&quot;java.library.path&quot;), true);</span><br><span class="line">       List&lt;File&gt; allNativeLibraryDirectories = new ArrayList&lt;&gt;(nativeLibraryDirectories);</span><br><span class="line">       allNativeLibraryDirectories.addAll(systemNativeLibraryDirectories);</span><br><span class="line"></span><br><span class="line">       //记录所有的native动态库</span><br><span class="line">       this.nativeLibraryPathElements = makePathElements(allNativeLibraryDirectories);</span><br><span class="line"></span><br><span class="line">       if (suppressedExceptions.size() &gt; 0) &#123;</span><br><span class="line">           this.dexElementsSuppressedExceptions =</span><br><span class="line">               suppressedExceptions.toArray(new IOException[suppressedExceptions.size()]);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           dexElementsSuppressedExceptions = null;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>DexPathList初始化主要是给两个全局变量赋值</p>
<p>dexElements：记录所有的dexFile文件</p>
<p>nativeLibraryPathElements：记录所有的Native动态库，包括app目录下和系统目录下的native库</p>
<p>app目录下：/data/app/<packagename>-xyz–/lib/下</packagename></p>
<p>系统目录：/system/lib下</p>
<h6 id="3-3-1-2-makePathElements"><a href="#3-3-1-2-makePathElements" class="headerlink" title="3.3.1.2 makePathElements"></a>3.3.1.2 makePathElements</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private static NativeLibraryElement[] makePathElements(List&lt;File&gt; files) &#123;</span><br><span class="line">       NativeLibraryElement[] elements = new NativeLibraryElement[files.size()];</span><br><span class="line">       int elementsPos = 0;</span><br><span class="line">       for (File file : files) &#123;</span><br><span class="line">           String path = file.getPath();</span><br><span class="line"></span><br><span class="line">           if (path.contains(zipSeparator)) &#123;</span><br><span class="line">               String split[] = path.split(zipSeparator, 2);</span><br><span class="line">               File zip = new File(split[0]);</span><br><span class="line">               String dir = split[1];</span><br><span class="line">               elements[elementsPos++] = new NativeLibraryElement(zip, dir);</span><br><span class="line">           &#125; else if (file.isDirectory()) &#123;</span><br><span class="line">               // We support directories for looking up native libraries.</span><br><span class="line">               elements[elementsPos++] = new NativeLibraryElement(file);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       if (elementsPos != elements.length) &#123;</span><br><span class="line">           elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">       &#125;</span><br><span class="line">       return elements;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>将native动态库存在nativeLibraryPathElements中，可以看出一个native库对应一个NativeLibraryElement</p>
<h5 id="3-3-2-DexPathList-findLibrary"><a href="#3-3-2-DexPathList-findLibrary" class="headerlink" title="3.3.2 DexPathList.findLibrary"></a>3.3.2 DexPathList.findLibrary</h5><p>[-&gt;DexPathList.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public String findLibrary(String libraryName) &#123;</span><br><span class="line">       String fileName = System.mapLibraryName(libraryName);</span><br><span class="line">       //从之前初始化的NativeLibraryElementS中查找库</span><br><span class="line">       for (NativeLibraryElement element : nativeLibraryPathElements) &#123;</span><br><span class="line">          //见3.3.2.2节</span><br><span class="line">           String path = element.findNativeLibrary(fileName);</span><br><span class="line"></span><br><span class="line">           if (path != null) &#123;</span><br><span class="line">               return path;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return null;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-3-2-1-System-mapLibraryName"><a href="#3-3-2-1-System-mapLibraryName" class="headerlink" title="3.3.2.1  System_mapLibraryName"></a>3.3.2.1  System_mapLibraryName</h6><p>[-&gt;System.c]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">System_mapLibraryName(JNIEnv *env, jclass ign, jstring libname)</span><br><span class="line">&#123;</span><br><span class="line">    int len;</span><br><span class="line">    int prefix_len = (int) strlen(JNI_LIB_PREFIX);</span><br><span class="line">    int suffix_len = (int) strlen(JNI_LIB_SUFFIX);</span><br><span class="line"></span><br><span class="line">    jchar chars[256];</span><br><span class="line">    if (libname == NULL) &#123;</span><br><span class="line">        JNU_ThrowNullPointerException(env, 0);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    len = (*env)-&gt;GetStringLength(env, libname);</span><br><span class="line">    if (len &gt; 240) &#123;</span><br><span class="line">        JNU_ThrowIllegalArgumentException(env, &quot;name too long&quot;);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    cpchars(chars, JNI_LIB_PREFIX, prefix_len);</span><br><span class="line">    (*env)-&gt;GetStringRegion(env, libname, 0, len, chars + prefix_len);</span><br><span class="line">    len += prefix_len;</span><br><span class="line">    cpchars(chars + len, JNI_LIB_SUFFIX, suffix_len);</span><br><span class="line">    len += suffix_len;</span><br><span class="line"></span><br><span class="line">    return (*env)-&gt;NewString(env, chars, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是将库的名字前面加上lib后缀加so，例如库名字是native，则转化后为libnative.so</p>
<h6 id="3-3-2-2-findNativeLibrary"><a href="#3-3-2-2-findNativeLibrary" class="headerlink" title="3.3.2.2  findNativeLibrary"></a>3.3.2.2  findNativeLibrary</h6><p>[-&gt;DexPathList.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public String findNativeLibrary(String name) &#123;</span><br><span class="line">          maybeInit();</span><br><span class="line"></span><br><span class="line">          if (zipDir == null) &#123;</span><br><span class="line">              String entryPath = new File(path, name).getPath();</span><br><span class="line">              if (IoUtils.canOpenReadOnly(entryPath)) &#123;</span><br><span class="line">                  return entryPath;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; else if (urlHandler != null) &#123;</span><br><span class="line">              // Having a urlHandler means the element has a zip file.</span><br><span class="line">              // In this case Android supports loading the library iff</span><br><span class="line">              // it is stored in the zip uncompressed.</span><br><span class="line">              String entryName = zipDir + &apos;/&apos; + name;</span><br><span class="line">              if (urlHandler.isEntryStored(entryName)) &#123;</span><br><span class="line">                return path.getPath() + zipSeparator + entryName;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>找到目标动态库，准备加载。</p>
<h4 id="3-4-nativeLoad"><a href="#3-4-nativeLoad" class="headerlink" title="3.4 nativeLoad"></a>3.4 nativeLoad</h4><p>[-&gt;libcore/ojluni/src/main/native/Runtime.c]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Runtime_nativeLoad(JNIEnv* env, jclass ignored, jstring javaFilename,</span><br><span class="line">                   jobject javaLoader)</span><br><span class="line">&#123;</span><br><span class="line">    //JVM加载动态库</span><br><span class="line">    return JVM_NativeLoad(env, javaFilename, javaLoader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JNINativeMethod gMethods[] = &#123;</span><br><span class="line">  FAST_NATIVE_METHOD(Runtime, freeMemory, &quot;()J&quot;),</span><br><span class="line">  FAST_NATIVE_METHOD(Runtime, totalMemory, &quot;()J&quot;),</span><br><span class="line">  FAST_NATIVE_METHOD(Runtime, maxMemory, &quot;()J&quot;),</span><br><span class="line">  NATIVE_METHOD(Runtime, gc, &quot;()V&quot;),</span><br><span class="line">  NATIVE_METHOD(Runtime, nativeExit, &quot;(I)V&quot;),</span><br><span class="line">  NATIVE_METHOD(Runtime, nativeLoad,</span><br><span class="line">                &quot;(Ljava/lang/String;Ljava/lang/ClassLoader;)&quot;</span><br><span class="line">                    &quot;Ljava/lang/String;&quot;),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="3-4-1-JVM-NativeLoad"><a href="#3-4-1-JVM-NativeLoad" class="headerlink" title="3.4.1 JVM_NativeLoad"></a>3.4.1 JVM_NativeLoad</h5><p>[-&gt;art/openjdkjvm/OpenjdkJvm.cc]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JVM_NativeLoad(JNIEnv* env,</span><br><span class="line">                                 jstring javaFilename,</span><br><span class="line">                                 jobject javaLoader) &#123;</span><br><span class="line">  ScopedUtfChars filename(env, javaFilename);</span><br><span class="line">  if (filename.c_str() == NULL) &#123;</span><br><span class="line">    return NULL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string error_msg;</span><br><span class="line">  &#123;</span><br><span class="line">    art::JavaVMExt* vm = art::Runtime::Current()-&gt;GetJavaVM();</span><br><span class="line">    //见3.4.2节</span><br><span class="line">    bool success = vm-&gt;LoadNativeLibrary(env,</span><br><span class="line">                                         filename.c_str(),</span><br><span class="line">                                         javaLoader,</span><br><span class="line">                                         &amp;error_msg);</span><br><span class="line">    if (success) &#123;</span><br><span class="line">      return nullptr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Don&apos;t let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.</span><br><span class="line">  env-&gt;ExceptionClear();</span><br><span class="line">  return env-&gt;NewStringUTF(error_msg.c_str());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-4-2-LoadNativeLibrary"><a href="#3-4-2-LoadNativeLibrary" class="headerlink" title="3.4.2 LoadNativeLibrary"></a>3.4.2 LoadNativeLibrary</h5><p>[-&gt;art/runtime/java_vm_ext.cc]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">bool JavaVMExt::LoadNativeLibrary(JNIEnv* env,</span><br><span class="line">                                  const std::string&amp; path,</span><br><span class="line">                                  jobject class_loader,</span><br><span class="line">                                  std::string* error_msg) &#123;</span><br><span class="line">  error_msg-&gt;clear();</span><br><span class="line"></span><br><span class="line">  // See if we&apos;ve already loaded this library.  If we have, and the class loader</span><br><span class="line">  // matches, return successfully without doing anything.</span><br><span class="line">  // TODO: for better results we should canonicalize the pathname (or even compare</span><br><span class="line">  // inodes). This implementation is fine if everybody is using System.loadLibrary.</span><br><span class="line">  SharedLibrary* library;</span><br><span class="line">  Thread* self = Thread::Current();</span><br><span class="line">  &#123;</span><br><span class="line">    // TODO: move the locking (and more of this logic) into Libraries.</span><br><span class="line">    MutexLock mu(self, *Locks::jni_libraries_lock_);</span><br><span class="line">    //检查该动态库是否完成加载</span><br><span class="line">    library = libraries_-&gt;Get(path);</span><br><span class="line">  &#125;</span><br><span class="line">  void* class_loader_allocator = nullptr;</span><br><span class="line">  &#123;</span><br><span class="line">    ScopedObjectAccess soa(env);</span><br><span class="line">    // As the incoming class loader is reachable/alive during the call of this function,</span><br><span class="line">    // it&apos;s okay to decode it without worrying about unexpectedly marking it alive.</span><br><span class="line">    ObjPtr&lt;mirror::ClassLoader&gt; loader = soa.Decode&lt;mirror::ClassLoader&gt;(class_loader);</span><br><span class="line"></span><br><span class="line">    ClassLinker* class_linker = Runtime::Current()-&gt;GetClassLinker();</span><br><span class="line">    if (class_linker-&gt;IsBootClassLoader(soa, loader.Ptr())) &#123;</span><br><span class="line">      loader = nullptr;</span><br><span class="line">      class_loader = nullptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class_loader_allocator = class_linker-&gt;GetAllocatorForClassLoader(loader.Ptr());</span><br><span class="line">    CHECK(class_loader_allocator != nullptr);</span><br><span class="line">  &#125;</span><br><span class="line">  if (library != nullptr) &#123;</span><br><span class="line">    // Use the allocator pointers for class loader equality to avoid unnecessary weak root decode.</span><br><span class="line">    if (library-&gt;GetClassLoaderAllocator() != class_loader_allocator) &#123;</span><br><span class="line">      // The library will be associated with class_loader. The JNI</span><br><span class="line">      // spec says we can&apos;t load the same library into more than one</span><br><span class="line">      // class loader.</span><br><span class="line">      //</span><br><span class="line">      // This isn&apos;t very common. So spend some time to get a readable message.</span><br><span class="line">      auto call_to_string = [&amp;](jobject obj) -&gt; std::string &#123;</span><br><span class="line">        if (obj == nullptr) &#123;</span><br><span class="line">          return &quot;null&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        // Handle jweaks. Ignore double local-ref.</span><br><span class="line">        ScopedLocalRef&lt;jobject&gt; local_ref(env, env-&gt;NewLocalRef(obj));</span><br><span class="line">        if (local_ref != nullptr) &#123;</span><br><span class="line">          ScopedLocalRef&lt;jclass&gt; local_class(env, env-&gt;GetObjectClass(local_ref.get()));</span><br><span class="line">          jmethodID to_string = env-&gt;GetMethodID(local_class.get(),</span><br><span class="line">                                                 &quot;toString&quot;,</span><br><span class="line">                                                 &quot;()Ljava/lang/String;&quot;);</span><br><span class="line">          DCHECK(to_string != nullptr);</span><br><span class="line">          ScopedLocalRef&lt;jobject&gt; local_string(env,</span><br><span class="line">                                               env-&gt;CallObjectMethod(local_ref.get(), to_string));</span><br><span class="line">          if (local_string != nullptr) &#123;</span><br><span class="line">            ScopedUtfChars utf(env, reinterpret_cast&lt;jstring&gt;(local_string.get()));</span><br><span class="line">            if (utf.c_str() != nullptr) &#123;</span><br><span class="line">              return utf.c_str();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          env-&gt;ExceptionClear();</span><br><span class="line">          return &quot;(Error calling toString)&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;null&quot;;</span><br><span class="line">      &#125;;</span><br><span class="line">      std::string old_class_loader = call_to_string(library-&gt;GetClassLoader());</span><br><span class="line">      std::string new_class_loader = call_to_string(class_loader);</span><br><span class="line">      StringAppendF(error_msg, &quot;Shared library /&quot;%s/&quot; already opened by &quot;</span><br><span class="line">          &quot;ClassLoader %p(%s); can&apos;t open in ClassLoader %p(%s)&quot;,</span><br><span class="line">          path.c_str(),</span><br><span class="line">          library-&gt;GetClassLoader(),</span><br><span class="line">          old_class_loader.c_str(),</span><br><span class="line">          class_loader,</span><br><span class="line">          new_class_loader.c_str());</span><br><span class="line">      LOG(WARNING) &lt;&lt; *error_msg;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[Shared library /&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot; already loaded in &quot;</span><br><span class="line">              &lt;&lt; &quot; ClassLoader &quot; &lt;&lt; class_loader &lt;&lt; &quot;]&quot;;</span><br><span class="line">    if (!library-&gt;CheckOnLoadResult()) &#123;</span><br><span class="line">      StringAppendF(error_msg, &quot;JNI_OnLoad failed on a previous attempt &quot;</span><br><span class="line">          &quot;to load /&quot;%s/&quot;&quot;, path.c_str());</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Open the shared library.  Because we&apos;re using a full path, the system</span><br><span class="line">  // doesn&apos;t have to search through LD_LIBRARY_PATH.  (It may do so to</span><br><span class="line">  // resolve this library&apos;s dependencies though.)</span><br><span class="line"></span><br><span class="line">  // Failures here are expected when java.library.path has several entries</span><br><span class="line">  // and we have to hunt for the lib.</span><br><span class="line"></span><br><span class="line">  // Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span><br><span class="line">  // class unloading. Libraries will only be unloaded when the reference count (incremented by</span><br><span class="line">  // dlopen) becomes zero from dlclose.</span><br><span class="line"></span><br><span class="line">  // Retrieve the library path from the classloader, if necessary.</span><br><span class="line">  ScopedLocalRef&lt;jstring&gt; library_path(env, GetLibrarySearchPath(env, class_loader));</span><br><span class="line"></span><br><span class="line">  Locks::mutator_lock_-&gt;AssertNotHeld(self);</span><br><span class="line">  const char* path_str = path.empty() ? nullptr : path.c_str();</span><br><span class="line">  bool needs_native_bridge = false;</span><br><span class="line">  //加载动态库</span><br><span class="line">  void* handle = android::OpenNativeLibrary(env,</span><br><span class="line">                                            runtime_-&gt;GetTargetSdkVersion(),</span><br><span class="line">                                            path_str,</span><br><span class="line">                                            class_loader,</span><br><span class="line">                                            library_path.get(),</span><br><span class="line">                                            &amp;needs_native_bridge,</span><br><span class="line">                                            error_msg);</span><br><span class="line"></span><br><span class="line">  VLOG(jni) &lt;&lt; &quot;[Call to dlopen(/&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot;, RTLD_NOW) returned &quot; &lt;&lt; handle &lt;&lt; &quot;]&quot;;</span><br><span class="line"></span><br><span class="line">  if (handle == nullptr) &#123;</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;dlopen(/&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot;, RTLD_NOW) failed: &quot; &lt;&lt; *error_msg;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (env-&gt;ExceptionCheck() == JNI_TRUE) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;Unexpected exception:&quot;;</span><br><span class="line">    env-&gt;ExceptionDescribe();</span><br><span class="line">    env-&gt;ExceptionClear();</span><br><span class="line">  &#125;</span><br><span class="line">  // Create a new entry.</span><br><span class="line">  // TODO: move the locking (and more of this logic) into Libraries.</span><br><span class="line">  //创建SharedLibrary共享库</span><br><span class="line">  bool created_library = false;</span><br><span class="line">  &#123;</span><br><span class="line">    // Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span><br><span class="line">    std::unique_ptr&lt;SharedLibrary&gt; new_library(</span><br><span class="line">        new SharedLibrary(env,</span><br><span class="line">                          self,</span><br><span class="line">                          path,</span><br><span class="line">                          handle,</span><br><span class="line">                          needs_native_bridge,</span><br><span class="line">                          class_loader,</span><br><span class="line">                          class_loader_allocator));</span><br><span class="line"></span><br><span class="line">    MutexLock mu(self, *Locks::jni_libraries_lock_);</span><br><span class="line">    library = libraries_-&gt;Get(path);</span><br><span class="line">    if (library == nullptr) &#123;  // We won race to get libraries_lock.</span><br><span class="line">      library = new_library.release();</span><br><span class="line">      libraries_-&gt;Put(path, library);</span><br><span class="line">      created_library = true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if (!created_library) &#123;</span><br><span class="line">    LOG(INFO) &lt;&lt; &quot;WOW: we lost a race to add shared library: &quot;</span><br><span class="line">        &lt;&lt; &quot;/&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot; ClassLoader=&quot; &lt;&lt; class_loader;</span><br><span class="line">    return library-&gt;CheckOnLoadResult();</span><br><span class="line">  &#125;</span><br><span class="line">  VLOG(jni) &lt;&lt; &quot;[Added shared library /&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot; for ClassLoader &quot; &lt;&lt; class_loader &lt;&lt; &quot;]&quot;;</span><br><span class="line"></span><br><span class="line">  bool was_successful = false;</span><br><span class="line">  void* sym = library-&gt;FindSymbol(&quot;JNI_OnLoad&quot;, nullptr);</span><br><span class="line">  if (sym == nullptr) &#123;</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[No JNI_OnLoad found in /&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot;]&quot;;</span><br><span class="line">    was_successful = true;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // Call JNI_OnLoad.  We have to override the current class</span><br><span class="line">    // loader, which will always be &quot;null&quot; since the stuff at the</span><br><span class="line">    // top of the stack is around Runtime.loadLibrary().  (See</span><br><span class="line">    // the comments in the JNI FindClass function.)</span><br><span class="line">    //调用JNI_OnLoad方法</span><br><span class="line">    ScopedLocalRef&lt;jobject&gt; old_class_loader(env, env-&gt;NewLocalRef(self-&gt;GetClassLoaderOverride()));</span><br><span class="line">    self-&gt;SetClassLoaderOverride(class_loader);</span><br><span class="line"></span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[Calling JNI_OnLoad in /&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot;]&quot;;</span><br><span class="line">    typedef int (*JNI_OnLoadFn)(JavaVM*, void*);</span><br><span class="line">    JNI_OnLoadFn jni_on_load = reinterpret_cast&lt;JNI_OnLoadFn&gt;(sym);</span><br><span class="line">    int version = (*jni_on_load)(this, nullptr);</span><br><span class="line"></span><br><span class="line">    if (runtime_-&gt;GetTargetSdkVersion() != 0 &amp;&amp; runtime_-&gt;GetTargetSdkVersion() &lt;= 21) &#123;</span><br><span class="line">      // Make sure that sigchain owns SIGSEGV.</span><br><span class="line">      EnsureFrontOfChain(SIGSEGV);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self-&gt;SetClassLoaderOverride(old_class_loader.get());</span><br><span class="line"></span><br><span class="line">    if (version == JNI_ERR) &#123;</span><br><span class="line">      StringAppendF(error_msg, &quot;JNI_ERR returned from JNI_OnLoad in /&quot;%s/&quot;&quot;, path.c_str());</span><br><span class="line">    &#125; else if (JavaVMExt::IsBadJniVersion(version)) &#123;</span><br><span class="line">      StringAppendF(error_msg, &quot;Bad JNI version returned from JNI_OnLoad in /&quot;%s/&quot;: %d&quot;,</span><br><span class="line">                    path.c_str(), version);</span><br><span class="line">      // It&apos;s unwise to call dlclose() here, but we can mark it</span><br><span class="line">      // as bad and ensure that future load attempts will fail.</span><br><span class="line">      // We don&apos;t know how far JNI_OnLoad got, so there could</span><br><span class="line">      // be some partially-initialized stuff accessible through</span><br><span class="line">      // newly-registered native method calls.  We could try to</span><br><span class="line">      // unregister them, but that doesn&apos;t seem worthwhile.</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      was_successful = true;</span><br><span class="line">    &#125;</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[Returned &quot; &lt;&lt; (was_successful ? &quot;successfully&quot; : &quot;failure&quot;)</span><br><span class="line">              &lt;&lt; &quot; from JNI_OnLoad in /&quot;&quot; &lt;&lt; path &lt;&lt; &quot;/&quot;]&quot;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  library-&gt;SetResult(was_successful);</span><br><span class="line">  return was_successful;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-4-2-OpenNativeLibrary"><a href="#3-4-2-OpenNativeLibrary" class="headerlink" title="3.4.2 OpenNativeLibrary"></a>3.4.2 OpenNativeLibrary</h5><p>[-&gt;art/openjdkjvm/OpenjdkJvm.cc]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">void* OpenNativeLibrary(JNIEnv* env,</span><br><span class="line">                        int32_t target_sdk_version,</span><br><span class="line">                        const char* path,</span><br><span class="line">                        jobject class_loader,</span><br><span class="line">                        jstring library_path,</span><br><span class="line">                        bool* needs_native_bridge,</span><br><span class="line">                        std::string* error_msg) &#123;</span><br><span class="line">#if defined(__ANDROID__)</span><br><span class="line">  UNUSED(target_sdk_version);</span><br><span class="line">  if (class_loader == nullptr) &#123;</span><br><span class="line">    *needs_native_bridge = false;</span><br><span class="line">    return dlopen(path, RTLD_NOW);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::lock_guard&lt;std::mutex&gt; guard(g_namespaces_mutex);</span><br><span class="line">  NativeLoaderNamespace ns;</span><br><span class="line"> </span><br><span class="line">  if (!g_namespaces-&gt;FindNamespaceByClassLoader(env, class_loader, &amp;ns)) &#123;</span><br><span class="line">    // This is the case where the classloader was not created by ApplicationLoaders</span><br><span class="line">    // In this case we create an isolated not-shared namespace for it.</span><br><span class="line">    if (!g_namespaces-&gt;Create(env,</span><br><span class="line">                              target_sdk_version,</span><br><span class="line">                              class_loader,</span><br><span class="line">                              false /* is_shared */,</span><br><span class="line">                              false /* is_for_vendor */,</span><br><span class="line">                              library_path,</span><br><span class="line">                              nullptr,</span><br><span class="line">                              &amp;ns,</span><br><span class="line">                              error_msg)) &#123;</span><br><span class="line">      return nullptr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //是否是android命名空间</span><br><span class="line">  if (ns.is_android_namespace()) &#123;</span><br><span class="line">    android_dlextinfo extinfo;</span><br><span class="line">    extinfo.flags = ANDROID_DLEXT_USE_NAMESPACE;</span><br><span class="line">    extinfo.library_namespace = ns.get_android_ns();</span><br><span class="line"></span><br><span class="line">    void* handle = android_dlopen_ext(path, RTLD_NOW, &amp;extinfo);</span><br><span class="line">    if (handle == nullptr) &#123;</span><br><span class="line">      *error_msg = dlerror();</span><br><span class="line">    &#125;</span><br><span class="line">    *needs_native_bridge = false;</span><br><span class="line">    return handle;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    void* handle = NativeBridgeLoadLibraryExt(path, RTLD_NOW, ns.get_native_bridge_ns());</span><br><span class="line">    if (handle == nullptr) &#123;</span><br><span class="line">      *error_msg = NativeBridgeGetError();</span><br><span class="line">    &#125;</span><br><span class="line">    *needs_native_bridge = true;</span><br><span class="line">    return handle;</span><br><span class="line">  &#125;</span><br><span class="line">#else</span><br><span class="line">  UNUSED(env, target_sdk_version, class_loader);</span><br><span class="line"></span><br><span class="line">  // Do some best effort to emulate library-path support. It will not</span><br><span class="line">  // work for dependencies.</span><br><span class="line">  //</span><br><span class="line">  // Note: null has a special meaning and must be preserved.</span><br><span class="line">  std::string c_library_path;  // Empty string by default.</span><br><span class="line">  if (library_path != nullptr &amp;&amp; path != nullptr &amp;&amp; path[0] != &apos;/&apos;) &#123;</span><br><span class="line">    ScopedUtfChars library_path_utf_chars(env, library_path);</span><br><span class="line">    c_library_path = library_path_utf_chars.c_str();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::string&gt; library_paths = base::Split(c_library_path, &quot;:&quot;);</span><br><span class="line"></span><br><span class="line">  for (const std::string&amp; lib_path : library_paths) &#123;</span><br><span class="line">    *needs_native_bridge = false;</span><br><span class="line">    const char* path_arg;</span><br><span class="line">    std::string complete_path;</span><br><span class="line">    if (path == nullptr) &#123;</span><br><span class="line">      // Preserve null.</span><br><span class="line">      path_arg = nullptr;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      complete_path = lib_path;</span><br><span class="line">      if (!complete_path.empty()) &#123;</span><br><span class="line">        complete_path.append(&quot;/&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      complete_path.append(path);</span><br><span class="line">      path_arg = complete_path.c_str();</span><br><span class="line">    &#125;</span><br><span class="line">    //打开动态库</span><br><span class="line">    void* handle = dlopen(path_arg, RTLD_NOW);</span><br><span class="line">    if (handle != nullptr) &#123;</span><br><span class="line">      return handle;</span><br><span class="line">    &#125;</span><br><span class="line">    if (NativeBridgeIsSupported(path_arg)) &#123;</span><br><span class="line">      *needs_native_bridge = true;</span><br><span class="line">      handle = NativeBridgeLoadLibrary(path_arg, RTLD_NOW);</span><br><span class="line">      if (handle != nullptr) &#123;</span><br><span class="line">        return handle;</span><br><span class="line">      &#125;</span><br><span class="line">      *error_msg = NativeBridgeGetError();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      *error_msg = dlerror();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return nullptr;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LoadNativeLibrar最后通过android::OpenNativeLibrary加载so库，这里有一个名字空间的概念，通过它来实现系统的私有库，不被第三方加载，这样应用就没法去链接系统的私有库。</p>
<h4 id="3-5-getLibPaths"><a href="#3-5-getLibPaths" class="headerlink" title="3.5 getLibPaths()"></a>3.5 getLibPaths()</h4><p>[-&gt;Runtime.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private String[] getLibPaths() &#123;</span><br><span class="line">        if (mLibPaths == null) &#123;</span><br><span class="line">            synchronized(this) &#123;</span><br><span class="line">                if (mLibPaths == null) &#123;</span><br><span class="line">                    mLibPaths = initLibPaths();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return mLibPaths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> private static String[] initLibPaths() &#123;</span><br><span class="line">        String javaLibraryPath = System.getProperty(&quot;java.library.path&quot;);</span><br><span class="line">        if (javaLibraryPath == null) &#123;</span><br><span class="line">            return EmptyArray.STRING;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] paths = javaLibraryPath.split(&quot;:&quot;);</span><br><span class="line">        // Add a &apos;/&apos; to the end of each directory so we don&apos;t have to do it every time.</span><br><span class="line">        for (int i = 0; i &lt; paths.length; ++i) &#123;</span><br><span class="line">            if (!paths[i].endsWith(&quot;/&quot;)) &#123;</span><br><span class="line">                paths[i] += &quot;/&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return paths;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是查找系统库下的so库，/system/lib64</p>
<h4 id="3-6-总结"><a href="#3-6-总结" class="headerlink" title="3.6 总结"></a>3.6 总结</h4><p>动态库的调用顺序如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">System.loadLibrary()</span><br><span class="line">  Runtime.loadLibrary()</span><br><span class="line">      nativeLoad()</span><br><span class="line">          JVM_NativeLoad</span><br><span class="line">          LoadNativeLibrary()</span><br><span class="line">              LoadNativeLibrary</span><br><span class="line">                  OpenNativeLibrary</span><br><span class="line">                     dlopen()</span><br><span class="line">                        JNI_OnLoad()</span><br></pre></td></tr></table></figure>
<p>加载动态库的主要流程如下：</p>
<p>1.判断是否为空，如果classload为空，则从默认mLibPaths下查看库是否存在并加载；如果classload不为空，则通过findLibrary查找库并加载，这两种加载库最后调用都是nativeLoad方法；</p>
<p>2.nativeLoad最后通过 android::OpenNativeLibrary来加载so库，通过这种方式来实现系统的私有so库，最后调用dlopen来打开动态库；</p>
<p>3.判断JNI_OnLoad方法是否存在，如果存在就调用该方法。</p>
<h3 id="四、JNI应用"><a href="#四、JNI应用" class="headerlink" title="四、JNI应用"></a>四、JNI应用</h3><h4 id="4-1-数据签名"><a href="#4-1-数据签名" class="headerlink" title="4.1 数据签名"></a>4.1 数据签名</h4><h5 id="4-1-1-基本数据类型"><a href="#4-1-1-基本数据类型" class="headerlink" title="4.1.1 基本数据类型"></a>4.1.1 基本数据类型</h5><table>
<thead>
<tr>
<th style="text-align:left">Signature格式</th>
<th style="text-align:left">Java</th>
<th style="text-align:left">Native</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">B</td>
<td style="text-align:left">byte</td>
<td style="text-align:left">jbyte</td>
</tr>
<tr>
<td style="text-align:left">C</td>
<td style="text-align:left">char</td>
<td style="text-align:left">jchar</td>
</tr>
<tr>
<td style="text-align:left">D</td>
<td style="text-align:left">double</td>
<td style="text-align:left">jdouble</td>
</tr>
<tr>
<td style="text-align:left">F</td>
<td style="text-align:left">float</td>
<td style="text-align:left">jfloat</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">int</td>
<td style="text-align:left">jint</td>
</tr>
<tr>
<td style="text-align:left">S</td>
<td style="text-align:left">short</td>
<td style="text-align:left">jshort</td>
</tr>
<tr>
<td style="text-align:left">J</td>
<td style="text-align:left">long</td>
<td style="text-align:left">jlong</td>
</tr>
<tr>
<td style="text-align:left">Z</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">jboolean</td>
</tr>
<tr>
<td style="text-align:left">V</td>
<td style="text-align:left">void</td>
<td style="text-align:left">void</td>
</tr>
</tbody>
</table>
<h5 id="4-1-2-数组数据类型"><a href="#4-1-2-数组数据类型" class="headerlink" title="4.1.2 数组数据类型"></a>4.1.2 数组数据类型</h5><table>
<thead>
<tr>
<th style="text-align:left">Signature格式</th>
<th style="text-align:left">Java</th>
<th style="text-align:left">Native</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">[B</td>
<td style="text-align:left">byte[]</td>
<td style="text-align:left">jbyteArray</td>
</tr>
<tr>
<td style="text-align:left">[C</td>
<td style="text-align:left">char[]</td>
<td style="text-align:left">jcharArray</td>
</tr>
<tr>
<td style="text-align:left">[D</td>
<td style="text-align:left">double[]</td>
<td style="text-align:left">jdoubleArray</td>
</tr>
<tr>
<td style="text-align:left">[F</td>
<td style="text-align:left">float[]</td>
<td style="text-align:left">jfloatArray</td>
</tr>
<tr>
<td style="text-align:left">[I</td>
<td style="text-align:left">int[]</td>
<td style="text-align:left">jintArray</td>
</tr>
<tr>
<td style="text-align:left">[S</td>
<td style="text-align:left">short[]</td>
<td style="text-align:left">jshortArray</td>
</tr>
<tr>
<td style="text-align:left">[J</td>
<td style="text-align:left">long[]</td>
<td style="text-align:left">jlongArray</td>
</tr>
<tr>
<td style="text-align:left">[Z</td>
<td style="text-align:left">boolean[]</td>
<td style="text-align:left">jbooleanArray</td>
</tr>
</tbody>
</table>
<h5 id="4-1-3-对象数据类型"><a href="#4-1-3-对象数据类型" class="headerlink" title="4.1.3 对象数据类型"></a>4.1.3 对象数据类型</h5><table>
<thead>
<tr>
<th style="text-align:left">Signature格式</th>
<th style="text-align:left">Java</th>
<th style="text-align:left">Native</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ljava/lang/String;</td>
<td style="text-align:left">String</td>
<td style="text-align:left">jstring</td>
</tr>
<tr>
<td style="text-align:left">L+classname +;</td>
<td style="text-align:left">所有对象</td>
<td style="text-align:left">jobject</td>
</tr>
<tr>
<td style="text-align:left">[L+classname +;</td>
<td style="text-align:left">Object[]</td>
<td style="text-align:left">jobjectArray</td>
</tr>
<tr>
<td style="text-align:left">Ljava.lang.Class;</td>
<td style="text-align:left">Class</td>
<td style="text-align:left">jclass</td>
</tr>
<tr>
<td style="text-align:left">Ljava.lang.Throwable;</td>
<td style="text-align:left">Throwable</td>
<td style="text-align:left">jthrowable</td>
</tr>
</tbody>
</table>
<h5 id="4-1-4-函数签名"><a href="#4-1-4-函数签名" class="headerlink" title="4.1.4 函数签名"></a>4.1.4 函数签名</h5><table>
<thead>
<tr>
<th style="text-align:left">Java函数</th>
<th style="text-align:left">对应的签名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">void foo()</td>
<td style="text-align:left">()V</td>
</tr>
<tr>
<td style="text-align:left">float foo(int i)</td>
<td style="text-align:left">(I)F</td>
</tr>
<tr>
<td style="text-align:left">long foo(int[] i)</td>
<td style="text-align:left">([I)J</td>
</tr>
<tr>
<td style="text-align:left">double foo(Class c)</td>
<td style="text-align:left">(Ljava/lang/Class;)D</td>
</tr>
<tr>
<td style="text-align:left">boolean foo(int[] i,String s)</td>
<td style="text-align:left">([ILjava/lang/String;)Z</td>
</tr>
<tr>
<td style="text-align:left">String foo(int i)</td>
<td style="text-align:left">(I)Ljava/lang/String;</td>
</tr>
</tbody>
</table>
<h4 id="4-2-Native层调用Java层"><a href="#4-2-Native层调用Java层" class="headerlink" title="4.2 Native层调用Java层"></a>4.2 Native层调用Java层</h4><h5 id="4-2-1-访问属性"><a href="#4-2-1-访问属性" class="headerlink" title="4.2.1 访问属性"></a>4.2.1 访问属性</h5><p><strong>访问普通属性</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   public String gBlogName = &quot;skytoby&quot;;</span><br><span class="line">  </span><br><span class="line">Java_com_skytoby_myapplication_MainActivity_modifyBlogNameField(JNIEnv *env, jobject obj) &#123;  </span><br><span class="line">   //获取类</span><br><span class="line">   jclass clazz = env-&gt;GetObjectClass(obj);</span><br><span class="line">   //获取属性签名</span><br><span class="line">   jfieldID  fieldId = env-&gt;GetFieldID(clazz,&quot;gBlogName&quot;,&quot;Ljava/lang/String;&quot;);</span><br><span class="line">   //获取属性值</span><br><span class="line">   jstring jstr = static_cast&lt;jstring&gt;(env-&gt;GetObjectField(obj, fieldId));</span><br><span class="line">   //jstring转char*</span><br><span class="line">   //isCopy 是否复制（true代表赋值，false不复制）</span><br><span class="line">   char *str = const_cast&lt;char *&gt;(env-&gt;GetStringUTFChars(jstr, JNI_FALSE));</span><br><span class="line">   char *name = strcat(str,&quot;haha&quot;);</span><br><span class="line">   //修改属性值</span><br><span class="line">   env-&gt;SetObjectField(obj,fieldId,env-&gt;NewStringUTF(name));</span><br><span class="line">   env-&gt;ReleaseStringUTFChars(jstr,str);</span><br><span class="line"> ｝</span><br></pre></td></tr></table></figure>
<p><strong>访问静态属性</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static String gStaticBlogName = &quot;skytoby&quot;;</span><br><span class="line"></span><br><span class="line">jclass clazz = env-&gt;GetObjectClass(obj);</span><br><span class="line">jfieldID  fieldId = env-&gt;GetStaticFieldID(clazz,&quot;gStaticBlogName&quot;,&quot;Ljava/lang/String;&quot;);</span><br><span class="line">jstring jstr = static_cast&lt;jstring&gt;(env-&gt;GetStaticObjectField(clazz, fieldId));</span><br><span class="line"> char *str = const_cast&lt;char *&gt;(env-&gt;GetStringUTFChars(jstr,JNI_FALSE));</span><br><span class="line"> char *name = strcat(str,&quot;hehe&quot;);</span><br><span class="line"> env-&gt;SetStaticObjectField(clazz,fieldId,env-&gt;NewStringUTF(name));</span><br><span class="line"> env-&gt;ReleaseStringUTFChars(jstr,str);</span><br></pre></td></tr></table></figure>
<h5 id="4-2-2-访问方法"><a href="#4-2-2-访问方法" class="headerlink" title="4.2.2.访问方法"></a>4.2.2.访问方法</h5><p>每个native函数，都至少有两个参数（JNIEnv*,jobject)<br>1）当native方法为静态方法时：<br>jclass 代表native方法所属类的class对象<br>2）当native方法为非静态方法时：<br>jobject 代表native方法所属的对象</p>
<p><strong>访问普通方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> public String getgBlogName(int age)&#123;</span><br><span class="line">    return &quot;skytoby&quot;+age;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">//获取类</span><br><span class="line">jclass  clazz = env-&gt;GetObjectClass(obj);</span><br><span class="line">//获取方法签名</span><br><span class="line">jmethodID  methodId = env-&gt;GetMethodID(clazz,&quot;getgBlogName&quot;,&quot;(I)Ljava/lang/String;&quot;);</span><br><span class="line">//调用方法</span><br><span class="line">jstring  jstr = static_cast&lt;jstring&gt;(env-&gt;CallObjectMethod(obj, methodId, 12));</span><br></pre></td></tr></table></figure>
<p>访问静态方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static String getStaticgBlogName(int age)&#123;</span><br><span class="line">    return &quot;static skytoby&quot;+age;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">jclass  clazz = env-&gt;GetObjectClass(obj);</span><br><span class="line">jmethodID  methodId = env-&gt;GetStaticMethodID(clazz,&quot;getStaticgBlogName&quot;,&quot;(I)Ljava/lang/String;&quot;);</span><br><span class="line">jstring  jstr = static_cast&lt;jstring&gt;(env-&gt;CallStaticObjectMethod(clazz, methodId, 12));</span><br></pre></td></tr></table></figure>
<h4 id="4-3-引用"><a href="#4-3-引用" class="headerlink" title="4.3 引用"></a>4.3 引用</h4><p>在JNI中有三种引用关系</p>
<p>Local Reference(本地引用)</p>
<p>Global Reference（全局引用）</p>
<p>Weak Global Reference(全局弱引用)</p>
<p>Global Reference如果不主动释放，则一直不会释放；对于其他两种类型的引用都是释放的可能性。不管是这三种类型的哪种引用，在内存不再需要时，应立即释放，减少不可预知的性能与稳定性问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;NewGlobalRef(obj);</span><br><span class="line">env-&gt;NewLocalRef(obj);</span><br><span class="line">env-&gt;NewWeakGlobalRef(obj);</span><br><span class="line">env-&gt;DeleteGlobalRef(obj);</span><br><span class="line">env-&gt;DeleteLocalRef(obj);</span><br><span class="line">env-&gt;DeleteWeakGlobalRef(obj);</span><br></pre></td></tr></table></figure>
<h4 id="4-4-异常处理"><a href="#4-4-异常处理" class="headerlink" title="4.4 异常处理"></a>4.4 异常处理</h4><p>Java中点异常用trycatch就可以处理，不会影响代码点继续执行，但是JNI中的异常，Java层是无法捕获的，只能够在JNI中清除，可以通过ThrowNew给Java层抛出异常，让java层捕获。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">jclass clazz = env-&gt;GetObjectClass(obj);</span><br><span class="line">jfieldID  fieldId = env-&gt;GetStaticFieldID(clazz,&quot;gStaticBlogName1&quot;,&quot;Ljava/lang/String;&quot;);</span><br><span class="line">//检测是否发生Java异常</span><br><span class="line">jthrowable exception = env-&gt;ExceptionOccurred();</span><br><span class="line">if (exception != NULL)&#123;</span><br><span class="line">    //让Java代码可以继续运行</span><br><span class="line">    //清空异常信息</span><br><span class="line">    env-&gt;ExceptionClear();</span><br><span class="line">    if (fieldId == NULL)&#123;</span><br><span class="line">        //认为抛出异常，给Java层处理</span><br><span class="line">        jclass newExcCls = env-&gt;FindClass( &quot;java/lang/IllegalArgumentException&quot;);</span><br><span class="line">        env-&gt;ThrowNew(newExcCls,&quot;fieldId&apos;s value is invalid!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h3><p>本文主要从虚拟机的启动开始，再详细分析动态库的加载流程，最后对JNI的应用有详细的举例。</p>
<p>虚拟机启动过程中：</p>
<p>1.对Art虚拟机进行一序列初始化，如创建ART虚拟机堆，创建JavaVMExt实例，启动当前线程，加载OAT文件；</p>
<p>2.注册JNI函数，分析注册的详细过程</p>
<p>动态库的加载流程：</p>
<p>1.判断是否为空，如果classload为空，则从默认mLibPaths下查看库是否存在并加载；如果classload不为空，则通过findLibrary查找库并加载，这两种加载库最后调用都是nativeLoad方法；</p>
<p>2.nativeLoad最后通过 android::OpenNativeLibrary来加载so库，通过这种方式来实现系统的私有so库，最后调用dlopen来打开动态库；</p>
<p>3.判断JNI_OnLoad方法是否存在，如果存在就调用该方法。</p>
<p>JNI应用主要介绍了数据签名，Nativie层调用java层的基本方法，以及JNI引用和异常处理的问题。</p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/libcore/ojluni/src/main/java/java/lang/System.java</span><br><span class="line">/libcore/ojluni/src/main/java/java/lang/Runtime.java</span><br><span class="line">/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="line">/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="line"></span><br><span class="line">/frameworks/base/core/jni/AndroidRuntime.cpp</span><br><span class="line">/libcore/ojluni/src/main/native/Runtime.c</span><br><span class="line">/art/openjdkjvm/OpenjdkJvm.cc</span><br><span class="line">/art/runtime/java_vm_ext.cc</span><br><span class="line">/libcore/ojluni/src/main/native/System.c</span><br></pre></td></tr></table></figure>

      
    </div>


    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JNI/" rel="tag">#JNI</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/Android10.0如何hook Activity/" rel="next" title="Android10.0如何hook Activity">
                <i class="fa fa-chevron-left"></i> Android10.0如何hook Activity
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/Android刷新机制-View绘制原理/" rel="prev" title="Android刷新机制-View绘制原理">
                Android刷新机制-View绘制原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Skytoby">
          <p class="site-author-name" itemprop="name">Skytoby</p>
          <p class="site-description motion-element" itemprop="description">现居深圳，毕业于电子科技大学 <br>Android、AI<br>座右铭：想法+行动+坚持</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">40</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caoxiaoliang" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/cao861544325" target="_blank" title="CSDN">
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、概述"><span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、Android虚拟机启动"><span class="nav-text">二、Android虚拟机启动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-AR-start"><span class="nav-text">2.1 AR::start</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-AR-startVm"><span class="nav-text">2.2 AR::startVm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-JNI-CreateJavaVM"><span class="nav-text">2.2.1 JNI_CreateJavaVM</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-Runtime-Create"><span class="nav-text">2.2.2 Runtime::Create</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-Runtime-Init"><span class="nav-text">2.2.3 Runtime::Init</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-startReg"><span class="nav-text">2.3 startReg</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-1-register-jni-procs"><span class="nav-text">2.3.1 register_jni_procs</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-2-register-com-android-internal-os-RuntimeInit"><span class="nav-text">2.3.2  register_com_android_internal_os_RuntimeInit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-3-RegisterNatives"><span class="nav-text">2.3.3 RegisterNatives</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、动态库加载分析"><span class="nav-text">三、动态库加载分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-System-loadLibrary"><span class="nav-text">3.1 System.loadLibrary</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-Runtime-loadLibrary0"><span class="nav-text">3.2 Runtime.loadLibrary0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-findLibrary"><span class="nav-text">3.3 findLibrary</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-1-DexPathList初始化"><span class="nav-text">3.3.1 DexPathList初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-1-1-new-DexPathList"><span class="nav-text">3.3.1.1  new DexPathList</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-1-2-makePathElements"><span class="nav-text">3.3.1.2 makePathElements</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-2-DexPathList-findLibrary"><span class="nav-text">3.3.2 DexPathList.findLibrary</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-2-1-System-mapLibraryName"><span class="nav-text">3.3.2.1  System_mapLibraryName</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-2-2-findNativeLibrary"><span class="nav-text">3.3.2.2  findNativeLibrary</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-nativeLoad"><span class="nav-text">3.4 nativeLoad</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-1-JVM-NativeLoad"><span class="nav-text">3.4.1 JVM_NativeLoad</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-2-LoadNativeLibrary"><span class="nav-text">3.4.2 LoadNativeLibrary</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-2-OpenNativeLibrary"><span class="nav-text">3.4.2 OpenNativeLibrary</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-getLibPaths"><span class="nav-text">3.5 getLibPaths()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-总结"><span class="nav-text">3.6 总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、JNI应用"><span class="nav-text">四、JNI应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-数据签名"><span class="nav-text">4.1 数据签名</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-基本数据类型"><span class="nav-text">4.1.1 基本数据类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-2-数组数据类型"><span class="nav-text">4.1.2 数组数据类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-3-对象数据类型"><span class="nav-text">4.1.3 对象数据类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-4-函数签名"><span class="nav-text">4.1.4 函数签名</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-Native层调用Java层"><span class="nav-text">4.2 Native层调用Java层</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-1-访问属性"><span class="nav-text">4.2.1 访问属性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-2-访问方法"><span class="nav-text">4.2.2.访问方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-引用"><span class="nav-text">4.3 引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-异常处理"><span class="nav-text">4.4 异常处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五、总结"><span class="nav-text">五、总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#附录"><span class="nav-text">附录</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skytoby</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme Next
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'https-zproo-github-io';
      var disqus_identifier = '2020/Android JNI 原理分析/';
      var disqus_title = "Android JNI原理分析";
      var disqus_url = 'http://zproo.github.io/2020/Android JNI 原理分析/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  









  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
