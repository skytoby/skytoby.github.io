<!doctype html>



  


<html class="theme-next pisces use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Android Camera,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="一、概述回顾高通平台Camera HAL历史，之前高通采用的是QCamera &amp;amp; MM-Camera架构，但是为了更精细化控制底层硬件(Sensor/ISP等关键硬件)，同时方便手机厂商自定义一些功能，现在提出了CamX-CHI架构，由于在CamX-CHI中完全看不到之前老架构的影子，所以它完全是一个全新的架构，它将一些高度统一的功能性接口抽离出来放到CamX中，将可定制化的部分放在CHI">
<meta name="keywords" content="Android Camera">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Android Camera架构四-高通CamX-CHI">
<meta property="og:url" content="http://zproo.github.io/2024/深入理解Android Camera架构四-高通CamX-CHI/index.html">
<meta property="og:site_name" content="Skytoby">
<meta property="og:description" content="一、概述回顾高通平台Camera HAL历史，之前高通采用的是QCamera &amp;amp; MM-Camera架构，但是为了更精细化控制底层硬件(Sensor/ISP等关键硬件)，同时方便手机厂商自定义一些功能，现在提出了CamX-CHI架构，由于在CamX-CHI中完全看不到之前老架构的影子，所以它完全是一个全新的架构，它将一些高度统一的功能性接口抽离出来放到CamX中，将可定制化的部分放在CHI">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/camx-chi.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/feature.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/usercase.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/camera_provider_init.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/camx-chi-dlopen.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/config_stream.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/ProcessCaptureRequest.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/DeferredRequestQueue.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/AdvancedCameraUsecase.png">
<meta property="og:updated_time" content="2024-10-26T03:03:00.422Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解Android Camera架构四-高通CamX-CHI">
<meta name="twitter:description" content="一、概述回顾高通平台Camera HAL历史，之前高通采用的是QCamera &amp;amp; MM-Camera架构，但是为了更精细化控制底层硬件(Sensor/ISP等关键硬件)，同时方便手机厂商自定义一些功能，现在提出了CamX-CHI架构，由于在CamX-CHI中完全看不到之前老架构的影子，所以它完全是一个全新的架构，它将一些高度统一的功能性接口抽离出来放到CamX中，将可定制化的部分放在CHI">
<meta name="twitter:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构四-高通CamX-CHI/camx-chi.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://zproo.github.io/2024/深入理解Android Camera架构四-高通CamX-CHI/">

  <title> 深入理解Android Camera架构四-高通CamX-CHI | Skytoby </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <header id="header_post" class="header" itemscope="" itemtype="http://schema.org/WPHeader" style="background-image: url('http://ortur5wom.bkt.clouddn.com/home_bg.jpg');">
      <div class="header-inner-post"><a class="site-home" href="/">Skytoby</a>

<div class="site-meta ">
  
  
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/logo.png" style="width: 50px" alt="Skytoby">
      </a>
    </div>
  

  
  
  
  
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
           <li class="menu-item menu-item-关于">
             <a href="/about" rel="section">
               
               
               关于
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-目录">
             <a href="/archives" rel="section">
               
               
               目录
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-首页">
             <a href="/" rel="section">
               
               
               首页
             </a>
           </li>
        
      

      
    </ul>
  

  
</nav> </div>
      <div class="header-post"> 
  <div class="post-header">
      <div class="tags">
      
        <a href="/tags/Android-Camera/" rel="tag" title="Android Camera">Android Camera</a>
      
      </div>
      <h1>深入理解Android Camera架构四-高通CamX-CHI</h1>
      <h2 class="subtitle"></h2>
      <div class="post-time">
        <span class="post-meta-item-text">Posted on </span>
        <time itemprop="dateCreated" datetime="2024-04-20T21:18:23+08:00" content="2024-04-20" title="2024-04-20 21:18:23">
          2024-04-20
        </time>
      </div>
  </div>
 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                深入理解Android Camera架构四-高通CamX-CHI
              
            
          </h1>
        

        <div class="post-meta">
		  

          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2024-04-20T21:18:23+08:00" content="2024-04-20">
              2024-04-20
            </time>
          </span>

          

          <!--  -->

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>回顾高通平台Camera HAL历史，之前高通采用的是QCamera &amp; MM-Camera架构，但是为了更精细化控制底层硬件(Sensor/ISP等关键硬件)，同时方便手机厂商自定义一些功能，现在提出了CamX-CHI架构，由于在CamX-CHI中完全看不到之前老架构的影子，所以它完全是一个全新的架构，它将一些高度统一的功能性接口抽离出来放到CamX中，将可定制化的部分放在CHI中供不同厂商进行修改，实现各自独有的特色功能，这样设计的好处显而易见，那便是即便开发者对于CamX并不是很了解，但是依然可以很方便的加入自定义的功能，从而降低了开发者在高通平台的开发门槛。</p>
<p>接下来我们以最直观的目录结构入手对该架构做一个简单的认识，以下便是CamX-CHI基本目录结构：</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/camx-chi.png" style="zoom: 67%;"></p>
<p>该部分代码主要位于 vendor/qcom/proprietary/ 目录下：</p>
<p>其中 camx 代表了通用功能性接口的代码实现集合（CamX），chi-cdk代表了可定制化需求的代码实现集合（CHI），从图中可以看出Camx部分对上作为HAL3接口的实现，对下通过v4l2框架与Kernel保持通讯，中间通过互相dlopen so库并获取对方操作接口的方式保持着与CHI的交互。</p>
<p>camx/中有如下几个主要目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">├── ./build</span><br><span class="line">│   └── ./build/infrastructure</span><br><span class="line">└── ./src</span><br><span class="line">    ├── ./src/chiiqutils</span><br><span class="line">    ├── ./src/core</span><br><span class="line">    ├── ./src/csl</span><br><span class="line">    ├── ./src/hwl</span><br><span class="line">    ├── ./src/lib</span><br><span class="line">    ├── ./src/mapperutils</span><br><span class="line">    ├── ./src/osutils</span><br><span class="line">    ├── ./src/settings</span><br><span class="line">    ├── ./src/swl</span><br><span class="line">    └── ./src/utils</span><br></pre></td></tr></table></figure>
<ul>
<li><p>core/ ： 用于存放camx的核心实现模块，其中还包含了主要用于实现hal3接口的hal/目录，以及负责与CHI进行交互的chi/目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">├── ./build</span><br><span class="line">├── ./chi</span><br><span class="line">├── ./hal</span><br><span class="line">├── ./halutils</span><br><span class="line">├── ./ncs</span><br><span class="line">└── ./oem</span><br></pre></td></tr></table></figure>
</li>
<li><p>csl/： 用于存放主要负责camx与camera driver的通讯模块，为camx提供了统一的Camera driver控制接口</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── ./android</span><br><span class="line">├── ./build</span><br><span class="line">├── ./common</span><br><span class="line">├── ./hw</span><br><span class="line">└── ./ifh</span><br></pre></td></tr></table></figure>
<ul>
<li><p>hwl/: 用于存放自身具有独立运算能力的硬件node，该部分node受csl管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── ./bps</span><br><span class="line">├── ./cvp</span><br><span class="line">├── ./dspinterfaces</span><br><span class="line">├── ./fd</span><br><span class="line">├── ./ife</span><br><span class="line">├── ./ipe</span><br><span class="line">├── ./iqinterpolation</span><br><span class="line">├── ./iqsetting</span><br><span class="line">├── ./isphwsetting</span><br><span class="line">├── ./ispiqmodule</span><br><span class="line">├── ./jpeg</span><br><span class="line">├── ./lrme</span><br><span class="line">├── ./qsat</span><br><span class="line">├── ./statsparser</span><br><span class="line">├── ./tfe</span><br><span class="line">└── ./titan17x</span><br></pre></td></tr></table></figure>
</li>
<li><p>swl/: 用于存放自身并不具有独立运算能力，必须依靠CPU才能实现的node</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── ./eisv2</span><br><span class="line">├── ./eisv3</span><br><span class="line">├── ./fd</span><br><span class="line">├── ./jpeg</span><br><span class="line">├── ./offlinestats</span><br><span class="line">├── ./ransac</span><br><span class="line">├── ./sensor</span><br><span class="line">├── ./stats</span><br><span class="line">└── ./swregistration</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>chi-cdk/中有如下几个主要目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">./api</span><br><span class="line">│   ├── ./api/chromatix</span><br><span class="line">│   │   ├── ./api/chromatix/presets</span><br><span class="line">│   │   ├── ./api/chromatix/XML</span><br><span class="line">│   │   └── ./api/chromatix/XSD</span><br><span class="line">│   ├── ./api/common</span><br><span class="line">│   ├── ./api/fd</span><br><span class="line">│   ├── ./api/generated</span><br><span class="line">│   │   └── ./api/generated/build</span><br><span class="line">│   ├── ./api/isp</span><br><span class="line">│   ├── ./api/ncs</span><br><span class="line">│   ├── ./api/node</span><br><span class="line">│   ├── ./api/pdlib</span><br><span class="line">│   ├── ./api/sensor</span><br><span class="line">│   ├── ./api/stats</span><br><span class="line">│   └── ./api/utils</span><br><span class="line">├── ./configs</span><br><span class="line">├── ./core</span><br><span class="line">│   ├── ./core/build</span><br><span class="line">│   │   ├── ./core/build/android</span><br><span class="line">│   │   └── ./core/build/linuxembedded</span><br><span class="line">│   ├── ./core/chifeature2</span><br><span class="line">│   │   ├── ./core/chifeature2/bitra</span><br><span class="line">│   │   └── ./core/chifeature2/common</span><br><span class="line">│   ├── ./core/chiframework</span><br><span class="line">│   │   ├── ./core/chiframework/bitra</span><br><span class="line">│   │   └── ./core/chiframework/common</span><br><span class="line">│   ├── ./core/chiofflinepostproclib</span><br><span class="line">│   │   ├── ./core/chiofflinepostproclib/bitra</span><br><span class="line">│   │   └── ./core/chiofflinepostproclib/common</span><br><span class="line">│   ├── ./core/chiofflinepostprocservice</span><br><span class="line">│   │   ├── ./core/chiofflinepostprocservice/bitra</span><br><span class="line">│   │   └── ./core/chiofflinepostprocservice/common</span><br><span class="line">│   ├── ./core/chiusecase</span><br><span class="line">│   │   ├── ./core/chiusecase/bitra</span><br><span class="line">│   │   └── ./core/chiusecase/common</span><br><span class="line">│   ├── ./core/chiutils</span><br><span class="line">│   │   ├── ./core/chiutils/bitra</span><br><span class="line">│   │   └── ./core/chiutils/common</span><br><span class="line">│   └── ./core/lib</span><br><span class="line">│       ├── ./core/lib/bitra</span><br><span class="line">│       └── ./core/lib/common</span><br><span class="line">├── ./oem</span><br><span class="line">│   └── ./oem/qcom</span><br><span class="line">│       ├── ./oem/qcom/actuator</span><br><span class="line">│       ├── ./oem/qcom/blm</span><br><span class="line">│       ├── ./oem/qcom/eebin</span><br><span class="line">│       ├── ./oem/qcom/eeprom</span><br><span class="line">│       ├── ./oem/qcom/fd</span><br><span class="line">│       ├── ./oem/qcom/feature2</span><br><span class="line">│       ├── ./oem/qcom/flash</span><br><span class="line">│       ├── ./oem/qcom/formatmapper</span><br><span class="line">│       ├── ./oem/qcom/module</span><br><span class="line">│       ├── ./oem/qcom/node</span><br><span class="line">│       ├── ./oem/qcom/ois</span><br><span class="line">│       ├── ./oem/qcom/sensor</span><br><span class="line">│       ├── ./oem/qcom/topology</span><br><span class="line">│       ├── ./oem/qcom/tuning</span><br><span class="line">│       ├── ./oem/qcom/tuningdeprecated</span><br><span class="line">│       └── ./oem/qcom/utils</span><br><span class="line">├── ./test</span><br><span class="line">│   ├── ./test/chifeature2test</span><br><span class="line">│   │   └── ./test/chifeature2test/common</span><br><span class="line">│   ├── ./test/chifeature2testframework</span><br><span class="line">│   │   └── ./test/chifeature2testframework/common</span><br><span class="line">│   ├── ./test/chiofflinepostproctest</span><br><span class="line">│   │   └── ./test/chiofflinepostproctest/common</span><br><span class="line">│   ├── ./test/f2player</span><br><span class="line">│   │   └── ./test/f2player/common</span><br><span class="line">│   └── ./test/nativetest</span><br><span class="line">│       └── ./test/nativetest/nativetestutils</span><br><span class="line">└── ./tools</span><br><span class="line">    ├── ./tools/binary_log</span><br><span class="line">    │   ├── ./tools/binary_log/analysis</span><br><span class="line">    │   ├── ./tools/binary_log/core</span><br><span class="line">    │   └── ./tools/binary_log/utils</span><br><span class="line">    ├── ./tools/blmconfig</span><br><span class="line">    ├── ./tools/buildbins</span><br><span class="line">    │   ├── ./tools/buildbins/linux64</span><br><span class="line">    │   ├── ./tools/buildbins/win32</span><br><span class="line">    │   └── ./tools/buildbins/yaml</span><br><span class="line">    ├── ./tools/memprofile</span><br><span class="line">    └── ./tools/usecaseconverter</span><br><span class="line">        └── ./tools/usecaseconverter/utils</span><br></pre></td></tr></table></figure>
<ul>
<li>core/: 用于存放CHI实现的核心模块，负责与camx进行交互并且实现了CHI的总体框架以及具体的业务处理。</li>
<li>configs/: 用于存放平台相关的配置项</li>
<li>topology/: 用于存放用户自定的Usecase xml配置文件</li>
<li>node/: 用于存放用户自定义功能的node</li>
<li>module/: 用于存放不同sensor的配置文件，该部分在初始化sensor的时候需要用到</li>
<li>tuning/: 用于存放不同场景下的效果参数的配置文件</li>
<li>sensor/: 用于存放不同sensor的私有信息以及寄存器配置参数</li>
<li>actuator/: 用于存放不同对焦模块的配置信息</li>
<li>ois/： 用于存放防抖模块的配置信息</li>
<li>flash/： 存放着闪光灯模块的配置信息</li>
<li>eeprom/: 存放着eeprom外部存储模块的配置信息</li>
<li>fd/: 存放了人脸识别模块的配置信息</li>
</ul>
<h2 id="二、基本组件概念"><a href="#二、基本组件概念" class="headerlink" title="二、基本组件概念"></a>二、基本组件概念</h2><h3 id="2-1-Usecase"><a href="#2-1-Usecase" class="headerlink" title="2.1 Usecase"></a>2.1 Usecase</h3><p>作为CamX-CHI中最大的抽象概念，其中包含了多条实现特定功能的Pipeline，具体实现是在CHI中通过Usecase类完成的，该类主要负责了其中的业务处理以及资源的管理。</p>
<p>Usecase类，提供了一系列通用接口，作为现有的所有Usecase的基类，其中，AdvancedCameraUsecase又继承于CameraUsecaseBase，相机中绝大部分场景会通过实例化AdvancedCameraUsecase来完成，它包括了几个主要接口：</p>
<ul>
<li>Create(): 该方法是静态方法，用于创建一个AdvancedCameraUsecase实例，在其构造方法中会去获取XML中的相应的Usecase配置信息。</li>
<li>ExecuteCaptureRequest(): 该方法用于下发一次Request请求。</li>
<li>ProcessResultCb(): 该方法会在创建Session的过程中，作为回调方法注册到其中，一旦Session数据处理完成的时候便会调用该方法将结果发送到AdvancedCameraUsecase中。</li>
<li>ProcessDriverPartialCaptureResult(): 该方法会在创建Session的过程中，作为回调方法注册到其中，一旦Session中产生了partial meta data的时候，便会调用该方法将其发送至AdvancedCameraUsecase中。</li>
<li>ProcessMessageCb(): 该方法会在创建Session的过程中，作为回调方法注册到其中，一旦Session产生任何事件，便会调用该方法通知到AdvancedCameraUsecase中。</li>
<li>ExecuteFlush(): 该方法用于刷新AdvancedCameraUsecase。</li>
<li>Destroy(): 该方法用于安全销毁AdvancedCameraUsecase。</li>
</ul>
<p>Usecase的可定制化部分被抽象出来放在了common_usecase.xml文件中，这里简单介绍其中的几个主要的标签含义：</p>
<ul>
<li>UsecaseName: 代表了该Usecase的名字，后期根据这个名字找到这个Usecase的定义。</li>
<li>Targets: 用于表示用于输出的数据流的集合，其中包括了数据流的格式，输出Size的范围等。</li>
<li>Pipeline: 用于定义该Usecase可以是使用的所有Pipeline，这里必须至少定义一条Pipeline。</li>
</ul>
<h3 id="2-2-Feature"><a href="#2-2-Feature" class="headerlink" title="2.2 Feature"></a>2.2 Feature</h3><p>代表了一个特定的功能，该功能需要多条Pipeline组合起来实现，受Usecase统一管理，在CHI中通过Feature类进行实现，在XML中没有对应的定义，具体的Feature选取工作是在Usecase中完成的，通过在创建Feature的时候，传入Usecase的实例的方式，来和Usecase进行相互访问各自的资源。</p>
<p>以下是现有的Feature，其中Feature作为基类存在，定义了一系列通用方法。</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/feature.png" style="zoom: 80%;"></p>
<p>几个常用的Feature:</p>
<ul>
<li>FeatureHDR: 用于实现HDR功能，它负责管理内部的一条或者几条pipeline的资源以及它们的流转，最终输出具有HDR效果的图像。</li>
<li>FeatureMFNR: 用于实现MFNR功能，内部分为几个大的流程，分别包括Prefiltering、Blending、Postfilter以及最终的OfflineNoiseReproces(这一个是可选择使能的)，每一个小功能中包含了各自的pipeline。</li>
<li>FeatureASD: 用于AI功能的实现，在预览的时候，接收每一帧数据，并且进行分析当前场景的AI识别输出结果，并其通过诸如到metadata方式给到上层，进行后续的处理。</li>
</ul>
<h3 id="2-3-Session"><a href="#2-3-Session" class="headerlink" title="2.3 Session"></a>2.3 Session</h3><p>用于管理pipeline的抽象控制单元，一个Session中至少拥有一个pipeine，并且控制着所有的硬件资源，管控着每一个内部pipeline的request的流转以及数据的输入输出，它没有可定制化的部分，所以在CHI中的XML文件中并没有将Session作为一个独立的单元进行定义。</p>
<p>Session的实现主要通过CamX中的Session类，其主要接口如下：</p>
<ul>
<li>Initialize(): 根据传入的参数SessionCreateData进行Session的初始化工作。</li>
<li>NotifyResult(): 内部的Pipeline通过该接口将结果发送到Session中。</li>
<li>ProcessCaptureRequest(): 该方法用于用户决定发送一个Request到Session中的时候调用。</li>
<li>StreamOn(): 通过传入的Pipeline句柄，开始硬件的数据传输。</li>
<li>StreamOff(): 通过传入的Pipeline句柄，停止硬件的数据传输。</li>
</ul>
<h3 id="2-4-Pipeline"><a href="#2-4-Pipeline" class="headerlink" title="2.4 Pipeline"></a>2.4 Pipeline</h3><p>作为提供单一特定功能的所有资源的集合，维护着所有硬件资源以及数据的流转，每一个Pipeline包括了其中的Node/Link，在CamX中通过Pipeline类进行实现，负责整条Pipeline的软硬件资源的维护以及业务逻辑的处理，接下来我们简单看下该类的几个主要接口：</p>
<ul>
<li>Create(): 该方法是一个静态方法，根据传入的PipelineCreateInputData信息来实例化一个Pipeline对象。</li>
<li>StreamOn(): 通知Pipeline开始硬件的数据传输</li>
<li>StreamOff(): 通知Pipeline停止硬件的数据传输</li>
<li>FinalizePipeline(): 用于完成Pipeline的设置工作</li>
<li>OpenRequest(): open一个CSL用于流转的Request</li>
<li>ProcessRequest(): 开始下发Request</li>
<li>NotifyNodeMetadataDone(): 该方法是Pipeline提供给Node，当Node内部生成了metadata,便会调用该方法来通知metadata已经完成，最后当所有Node都通知Pipeline metadata已经完成，Pipeline 便会调用ProcessMetadataRequestIdDone通知Session。</li>
<li>NotifyNodePartialMetadataDone(): 该方法是Pipeline提供给Node，当Node内部生成了partial metadata,便会调用该方法来通知metadata已经完成，最后当所有Node都通知Pipeline metadata已经完成，Pipeline 便会调用ProcessPartialMetadataRequestIdDone通知Session。</li>
<li>SinkPortFenceSignaled(): 用来通知Session 某个sink port的fence处于被触发的状态。</li>
<li>NonSinkPortFenceSignaled(): 用来通知Session 某个non sink port的fence处于被触发的状态。</li>
</ul>
<p>Pipeline中的Node以及连接方式都在XML中被定义，其主要包含了以下几个标签定义：</p>
<ul>
<li>PipelineName: 用来定义该条Pipeline的名称</li>
<li>NodeList: 该标签中定义了该条Pipeline的所有的Node</li>
<li>PortLinkages: 该标签定义了Node上不同端口之间的连接关系</li>
</ul>
<h3 id="2-5-Node"><a href="#2-5-Node" class="headerlink" title="2.5 Node"></a>2.5 Node</h3><p>作为单个具有独立处理功能的抽象模块，可以是硬件单元也可以是软件单元，关于Node的具体实现是CamX中的Node类来完成的，其中CamX-CHI中主要分为两个大类，一个是高通自己实现的Node包括硬件Node，一个是CHI中提供给用户进行实现的Node，其主要方法如下：</p>
<ul>
<li>Create(): 该方法是静态方法，用于实例化一个Node对象。</li>
<li>ExecuteProcessRequest(): 该方法用于针对hwl node下发request的操作。</li>
<li>ProcessRequestIdDone(): 一旦该Node当前request已经处理完成，便会通过调用该方法通知Pipeline。</li>
<li>ProcessMetadataDone(): 一旦该Node的当前request的metadata已经生成，便会通过调用该方法通知到Pipeline。</li>
<li>ProcessPartialMetadataDone(): 一旦该Node的当前request的partial metadata已经生成，便会通过调用该方法通知到Pipeline。</li>
<li>CreateImageBufferManager(): 创建ImageBufferManager</li>
</ul>
<p>其可定制化的部分作为标签在XML中进行定义：</p>
<ul>
<li>NodeName： 用来定义该Node的名称</li>
<li>NodeId: 用来指定该Node的ID，其中IPE NodeId为65538，IFE NodeId为65536，用户自定义的NodeId为255。</li>
<li>NodeInstance: 用于定义该Node的当前实例的名称。</li>
<li>NodeInstanceId: 用于指定该Node实例的Id。</li>
</ul>
<h3 id="2-6-Link"><a href="#2-6-Link" class="headerlink" title="2.6 Link"></a>2.6 Link</h3><p>用于定义不同Port的连接，一个Port可以根据需要建立多条与其它从属于不同Node的Port的连接,它通过标签来进行定义，其中包括了作为输入端口，作为输出端口。</p>
<p>一个Link中包含了一个SrcPort和一个DstPort，分别代表了输入端口和输出端口，然后BufferProperties用于表示两个端口之间的buffer配置。</p>
<h3 id="2-7-Port"><a href="#2-7-Port" class="headerlink" title="2.7 Port"></a>2.7 Port</h3><p>作为Node的输入输出的端口，在XML文件中，标签用来定义一个输入端口，标签用来定义输出端口，每一个Node都可以根据需要使用一个或者多个输入输出端口，使用OutputPort以及InputPort结构体来进行在代码中定义。</p>
<ul>
<li>PortId: 该端口的Id: 该端口的名称</li>
<li>NodeName: 该端口从属的Node名称</li>
<li>NodeId: 该端口从属的Node的Id</li>
<li>NodeInstance: 该端口从属的Node的实例名称</li>
<li>NodeInstanceId: 该端口从属的Node的实例的Id</li>
</ul>
<h2 id="三、组件结构关系"><a href="#三、组件结构关系" class="headerlink" title="三、组件结构关系"></a>三、组件结构关系</h2><p>通过之前的介绍，我们对于几个基本组件有了一个比较清晰地认识，但是任何一个框架体系并不是仅靠组件胡乱堆砌而成的，相反，它们都必须基于各自的定位，按照各自所独有的行为模式，同时按照约定俗称的一系列规则组合起来，共同完成整个框架某一特定的功能。所以这里不得不产生一个疑问，在该框架中它们到底是如何组织起来的呢？它们之间的关系又是如何的呢？ 接下来我们以下图入手开始进行分析：</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/usercase.png" style="zoom: 67%;"></p>
<p>由上图可以看到，几者是通过包含关系组合起来的，Usecase 包含Feature，而Feature包含了Session，Session又维护了内部的Pipeline的流转，而每一条pipeline中又通过Link将所有Node都连接了起来，接下我们就这几种关系详细讲解下：</p>
<p><strong>首先</strong>，一个Usecase代表了某个特定的图像采集场景，比如人像场景，后置拍照场景等等，在初始化的时候通过根据上层传入的一些具体信息来进行创建，这个过程中，一方面实例化了特定的Usecase，这个实例是用来管理整个场景的所有资源，同时也负责了其中的业务处理逻辑，另一方面，获取了定义在XML中的特定Usecase，获取了用于实现某些特定功能的pipeline。</p>
<p><strong>其次</strong>，在Usecase中，Feature是一个可选项，如果当前用户选择了HDR模式或者需要在Zoom下进行拍照等特殊功能的话，在Usecase创建过程中，便会根据需要创建一个或者多个Feature，一般一个Feature对应着一个特定的功能，如果场景中并不需要任何特定的功能，则也完全可以不使用也不创建任何Feature。</p>
<p><strong>然后</strong>，每一个Usecase或者Feature都可以包含一个或者多个Session，每一个Session都是直接管理并负责了内部的Pipeline的数据流转，其中每一次的Request都是Usecase或者Featuret通过Session下发到内部的Pipeline进行处理，数据处理完成之后也是通过Session的方法将结果给到CHI中，之后是直接给到上层还是将数据封装下再次下发到另一个Session中进行后处理，这都交由CHI来决定。</p>
<p>其中，Session和Pipeline是一对多的关系，通常一个Session只包含了一条Pipeline，用于某个特定图像处理功能的实现，但是也不绝对，比如FeatureMFNR中包含的Session就包括了三条pipeline，又比如后置人像预览，也是用一个Session包含了两条分别用于主副双摄预览的Pipeline，主要是要看当前功能需要的pipeline数量以及它们之间是否存在一定关联。</p>
<p>同时，根据上面关于Pipeline的定义，它内部包含了一定数量的Node，并且实现的功能越复杂，所包含的Node也就越多，同时Node之间的连接也就越错综复杂，比如后置人像预览虚化效果的实现就是将拿到的主副双摄的图像通过RTBOfflinePreview这一条Pipeline将两帧图像合成一帧具有虚化效果的图像，从而完成了虚化功能。</p>
<p><strong>最后</strong>Pipeline中的Node的连接方式是通过XML文件中的Link来进行描述的，每一个Link定义了一个输入端和输出端分别对应着不同Node上面的输入输出端口，通过这种方式就将其中的一个Node的输出端与另外一个Node的输入端，一个一个串联起来，等到图像数据从Pipeline的起始端开始输入的时候，便可以按照这种定义好的轨迹在一个一个Node之间进行流转，而在流转的过程中每经过一个Node都会在内部对数据进行处理，这样等到数据从起始端一直流转到最后一个Node的输出端的时候，数据就经过了很多次处理，这些处理效果最后叠加在一起便是该Pipeline所要实现的功能，比如降噪、虚化等等。</p>
<h2 id="四、关键流程详解"><a href="#四、关键流程详解" class="headerlink" title="四、关键流程详解"></a>四、关键流程详解</h2><h3 id="4-1-Camera-Provider-启动初始化"><a href="#4-1-Camera-Provider-启动初始化" class="headerlink" title="4.1 Camera Provider 启动初始化"></a>4.1 Camera Provider 启动初始化</h3><p>当系统启动的时候，Camera Provider主程序会被运行（具体启动参考系列架构三），在整个程序初始化的过程中会通过获取到的camera_module_t调用其get_number_of_camera接口获取底层支持的camera数量，由于是第一次获取，所以在CamX-CHI中会伴随着很多初始化动作，具体操作见下图：</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/camera_provider_init.png" alt=""></p>
<h4 id="4-1-1-HAL3Module初始化"><a href="#4-1-1-HAL3Module初始化" class="headerlink" title="4.1.1 HAL3Module初始化"></a>4.1.1 HAL3Module初始化</h4><p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static int get_number_of_cameras(void)</span><br><span class="line">&#123;</span><br><span class="line">    CAMX_ENTRYEXIT_SCOPE(CamxLogGroupHAL, SCOPEEventHAL3GetNumberOfCameras);</span><br><span class="line"></span><br><span class="line">    return static_cast&lt;int&gt;(HAL3Module::GetInstance()-&gt;GetNumCameras());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3module.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">HAL3Module::HAL3Module()</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line">    CSLCameraPlatform CSLPlatform = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;***************************************************&quot;);</span><br><span class="line">    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;SHA1:     %s&quot;, CAMX_SHA1);</span><br><span class="line">    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;COMMITID: %s&quot;, CAMX_COMMITID);</span><br><span class="line">    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;BUILD TS: %s&quot;, CAMX_BUILD_TS);</span><br><span class="line">    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;***************************************************&quot;);</span><br><span class="line"></span><br><span class="line">    m_hChiOverrideModuleHandle = NULL;</span><br><span class="line">    m_numLogicalCameras        = 0;</span><br><span class="line">    m_pStaticSettings          = HwEnvironment::GetInstance()-&gt;GetStaticSettings();</span><br><span class="line">    result                     = CSLQueryCameraPlatform(&amp;CSLPlatform);</span><br><span class="line">    m_hdmiRes.width = 0;</span><br><span class="line">    m_hdmiRes.height = 0;</span><br><span class="line">    m_hdmiRes.id = -1;</span><br><span class="line">    m_hdmiRes.have_hdmi_signal = 0;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(CamxResultSuccess == result);</span><br><span class="line"></span><br><span class="line">    CamX::Utils::Memset(&amp;m_ChiAppCallbacks, 0, sizeof(m_ChiAppCallbacks));</span><br><span class="line">    CamX::Utils::Memset(m_pStaticMetadata, 0, sizeof(m_pStaticMetadata));</span><br><span class="line"></span><br><span class="line">    for (UINT32 sensor = 0; sensor &lt; MaxNumImageSensors; sensor++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_torchStatus[sensor] = TorchModeStatusAvailableOff;</span><br><span class="line">    &#125;</span><br><span class="line">    m_pMetadata = NULL;</span><br><span class="line"></span><br><span class="line">    // Set Camera Launch status to False at the time of constructor</span><br><span class="line">    DisplayConfigInterface::GetInstance()-&gt;SetCameraStatus(FALSE);</span><br><span class="line"></span><br><span class="line">    static const UINT NumCHIOverrideModules = 2;</span><br><span class="line"></span><br><span class="line">    UINT16 fileCount        = 0;</span><br><span class="line">    const  CHAR*  pD        = NULL;</span><br><span class="line">    INT    fileIndexBitra  = FILENAME_MAX;</span><br><span class="line">    INT    fileIndex        = 0;</span><br><span class="line"></span><br><span class="line">    CHAR moduleFileName[NumCHIOverrideModules * FILENAME_MAX];</span><br><span class="line"></span><br><span class="line">    switch (CSLPlatform.socId)</span><br><span class="line">    &#123;</span><br><span class="line">        case CSLCameraTitanSocSM6350:</span><br><span class="line">        case CSLCameraTitanSocSM7225:</span><br><span class="line">#if defined(_LP64)</span><br><span class="line">            fileCount = OsUtils::GetFilesFromPath(&quot;/vendor/lib64/camera/oem/bitra&quot;,</span><br><span class="line">                                                  FILENAME_MAX,</span><br><span class="line">                                                  &amp;moduleFileName[0],</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &quot;chi&quot;,</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &amp;SharedLibraryExtension[0]);</span><br><span class="line">            if (0 == fileCount)</span><br><span class="line">            &#123;</span><br><span class="line">                fileCount = OsUtils::GetFilesFromPath(&quot;/vendor/lib64/camera/qti/bitra&quot;,</span><br><span class="line">                                                      FILENAME_MAX,</span><br><span class="line">                                                      &amp;moduleFileName[0],</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &quot;chi&quot;,</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &amp;SharedLibraryExtension[0]);</span><br><span class="line">            &#125;</span><br><span class="line">#else // using LP32</span><br><span class="line">            fileCount = OsUtils::GetFilesFromPath(&quot;/vendor/lib/camera/oem/bitra&quot;,</span><br><span class="line">                                                  FILENAME_MAX,</span><br><span class="line">                                                  &amp;moduleFileName[0],</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &quot;chi&quot;,</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &amp;SharedLibraryExtension[0]);</span><br><span class="line">            if (0 == fileCount)</span><br><span class="line">            &#123;</span><br><span class="line">                fileCount = OsUtils::GetFilesFromPath(&quot;/vendor/lib/camera/qti/bitra&quot;,</span><br><span class="line">                                                      FILENAME_MAX,</span><br><span class="line">                                                      &amp;moduleFileName[0],</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &quot;chi&quot;,</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &amp;SharedLibraryExtension[0]);</span><br><span class="line">            &#125;</span><br><span class="line">#endif // _LP64</span><br><span class="line">            if (0 == fileCount)</span><br><span class="line">            &#123;</span><br><span class="line">                fileCount = OsUtils::GetFilesFromPath(CHIOverrideModulePath,</span><br><span class="line">                                                      FILENAME_MAX,</span><br><span class="line">                                                      &amp;moduleFileName[0],</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &quot;chi&quot;,</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &quot;*&quot;,</span><br><span class="line">                                                      &amp;SharedLibraryExtension[0]);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            fileCount = OsUtils::GetFilesFromPath(CHIOverrideModulePath,</span><br><span class="line">                                                  FILENAME_MAX,</span><br><span class="line">                                                  &amp;moduleFileName[0],</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &quot;chi&quot;,</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &quot;*&quot;,</span><br><span class="line">                                                  &amp;SharedLibraryExtension[0]);</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (0 == fileCount)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;FATAL: No CHI Module library found in %s - Cannot proceed&quot;, CHIOverrideModulePath);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        pD = OsUtils::StrStr(&amp;moduleFileName[0], &quot;bitra&quot;);</span><br><span class="line"></span><br><span class="line">        // pD is NULL if Bitra is not present in first file index</span><br><span class="line">        if (pD != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            fileIndexBitra = 0;</span><br><span class="line">            fileIndex      = FILENAME_MAX;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (NumCHIOverrideModules &gt;= fileCount)</span><br><span class="line">        &#123;</span><br><span class="line">            if (CSLPlatform.socId == CSLCameraTitanSocSM6350 || CSLPlatform.socId == CSLCameraTitanSocSM7225)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;opening CHI Module - %s&quot;, &amp;moduleFileName[fileIndexBitra]);</span><br><span class="line">                m_hChiOverrideModuleHandle = OsUtils::LibMap(&amp;moduleFileName[fileIndexBitra]);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;opening CHI Module - %s&quot;, &amp;moduleFileName[fileIndex]);</span><br><span class="line">                m_hChiOverrideModuleHandle = OsUtils::LibMap(&amp;moduleFileName[fileIndex]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (NULL != m_hChiOverrideModuleHandle)</span><br><span class="line">            &#123;</span><br><span class="line">                CHIHALOverrideEntry funcCHIHALOverrideEntry =</span><br><span class="line">                    reinterpret_cast&lt;CHIHALOverrideEntry&gt;(</span><br><span class="line">                        CamX::OsUtils::LibGetAddr(m_hChiOverrideModuleHandle, &quot;chi_hal_override_entry&quot;));</span><br><span class="line"></span><br><span class="line">                if (NULL != funcCHIHALOverrideEntry)</span><br><span class="line">                &#123;</span><br><span class="line">                    funcCHIHALOverrideEntry(&amp;m_ChiAppCallbacks);</span><br><span class="line"></span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_get_num_cameras);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_get_camera_info);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_get_info);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_finalize_override_session);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_initialize_override_session);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_override_process_request);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_override_flush);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_override_dump);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_teardown_override_session);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_extend_open);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_extend_close);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_remap_camera_id);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_modify_settings);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_get_default_request_settings);</span><br><span class="line">                    CAMX_ASSERT(NULL != m_ChiAppCallbacks.chi_override_getFaceRoiInfo);</span><br><span class="line"></span><br><span class="line">                    if ((NULL != m_ChiAppCallbacks.chi_get_num_cameras)             &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_get_camera_info)             &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_get_info)                    &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_finalize_override_session)   &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_initialize_override_session) &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_override_process_request)    &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_override_flush)              &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_override_dump)               &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_teardown_override_session)   &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_extend_open)                 &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_extend_close)                &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_remap_camera_id)             &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_modify_settings)             &amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_get_default_request_settings)&amp;&amp;</span><br><span class="line">                        (NULL != m_ChiAppCallbacks.chi_override_getFaceRoiInfo))</span><br><span class="line">                    &#123;</span><br><span class="line">                        CAMX_LOG_VERBOSE(CamxLogGroupHAL, &quot;CHI Module library function pointers exchanged&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else</span><br><span class="line">                    &#123;</span><br><span class="line">                        CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;CHI Module library function pointers exchanged FAILED&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Couldn&apos;t open CHI Module lib. All usecases will go thru HAL implementation&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if (fileCount &gt; NumCHIOverrideModules)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Cannot have more than %d CHI override module present&quot;, NumCHIOverrideModules);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (NULL != m_ChiAppCallbacks.chi_get_num_cameras)</span><br><span class="line">    &#123;</span><br><span class="line">        m_ChiAppCallbacks.chi_get_num_cameras(&amp;m_numFwCameras, &amp;m_numLogicalCameras);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_ASSERT_ALWAYS_MESSAGE(&quot;Override module is mandatory.  Returning 0 cameras, and app will not behave properly&quot;);</span><br><span class="line">        m_numFwCameras = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pThermalManager = ThermalManager::Create();</span><br><span class="line">    if (NULL == m_pThermalManager)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_WARN(CamxLogGroupHAL, &quot;Failed to create ThermalManager&quot;);</span><br><span class="line">        // Not a fatal error. Camera can continue to operate without this</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // There are arrays capped with a max number of sensors.  If there are more than MaxNumImageSensors logical</span><br><span class="line">    // cameras, this assert will fire.</span><br><span class="line">    CAMX_ASSERT(m_numLogicalCameras &lt; MaxNumImageSensors);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-1-2-HwEnvironment初始化"><a href="#4-1-2-HwEnvironment初始化" class="headerlink" title="4.1.2 HwEnvironment初始化"></a>4.1.2 HwEnvironment初始化</h4><p>[-&gt;vendor\qcom\proprietary\camx\src\core\camxhwenvironment.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const StaticSettings* HwEnvironment::GetStaticSettings() const</span><br><span class="line">&#123;</span><br><span class="line">    return m_pSettingsManager-&gt;GetStaticSettings();</span><br><span class="line">&#125;</span><br><span class="line">HwEnvironment::HwEnvironment()</span><br><span class="line">    : m_initCapsStatus(InitCapsInvalid)</span><br><span class="line">    , m_pNCSObject(NULL)</span><br><span class="line">&#123;</span><br><span class="line">    Initialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">CamxResult HwEnvironment::Initialize()</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult              result                  = CamxResultSuccess;</span><br><span class="line">    CSLInitializeParams     params                  = &#123; 0 &#125;;</span><br><span class="line">    SettingsManager*        pStaticSettingsManager  = SettingsManager::Create(NULL);</span><br><span class="line">    ExternalComponentInfo*  pExternalComponent      = GetExternalComponent();</span><br><span class="line"></span><br><span class="line">    m_pHWEnvLock = Mutex::Create(&quot;HwEnvLock&quot;);</span><br><span class="line">    CAMX_ASSERT(NULL != m_pHWEnvLock);</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != pStaticSettingsManager);</span><br><span class="line"></span><br><span class="line">    if (NULL != pStaticSettingsManager)</span><br><span class="line">    &#123;</span><br><span class="line">        const StaticSettings* pStaticSettings = pStaticSettingsManager-&gt;GetStaticSettings();</span><br><span class="line"></span><br><span class="line">        CAMX_ASSERT(NULL != pStaticSettings);</span><br><span class="line"></span><br><span class="line">        if (NULL != pStaticSettings)</span><br><span class="line">        &#123;</span><br><span class="line">            params.mode                                           = pStaticSettings-&gt;CSLMode;</span><br><span class="line">            params.emulatedSensorParams.enableSensorSimulation    = pStaticSettings-&gt;enableSensorEmulation;</span><br><span class="line">            params.emulatedSensorParams.dumpSensorEmulationOutput = pStaticSettings-&gt;dumpSensorEmulationOutput;</span><br><span class="line"></span><br><span class="line">            OsUtils::StrLCpy(params.emulatedSensorParams.sensorEmulatorPath,</span><br><span class="line">                             pStaticSettings-&gt;sensorEmulatorPath,</span><br><span class="line">                             sizeof(pStaticSettings-&gt;sensorEmulatorPath));</span><br><span class="line"></span><br><span class="line">            OsUtils::StrLCpy(params.emulatedSensorParams.sensorEmulator,</span><br><span class="line">                             pStaticSettings-&gt;sensorEmulator,</span><br><span class="line">                             sizeof(pStaticSettings-&gt;sensorEmulator));</span><br><span class="line"></span><br><span class="line">            result = CSLInitialize(&amp;params);</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                // Query the camera platform</span><br><span class="line">                result = QueryHwContextStaticEntryMethods();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                m_pHwFactory = m_staticEntryMethods.CreateHwFactory();</span><br><span class="line"></span><br><span class="line">                if (NULL == m_pHwFactory)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_ASSERT_ALWAYS_MESSAGE(&quot;Failed to create the HW factory&quot;);</span><br><span class="line">                    result = CamxResultEFailed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                m_pSettingsManager = m_pHwFactory-&gt;CreateSettingsManager();</span><br><span class="line"></span><br><span class="line">                if (NULL == m_pSettingsManager)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_ASSERT_ALWAYS_MESSAGE(&quot;Failed to create the HW settings manager&quot;);</span><br><span class="line">                    result = CamxResultEFailed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                m_staticEntryMethods.GetHWBugWorkarounds(&amp;m_workarounds);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pStaticSettingsManager-&gt;Destroy();</span><br><span class="line">        pStaticSettingsManager = NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != pExternalComponent);</span><br><span class="line">    if ((CamxResultSuccess == result) &amp;&amp; (NULL != pExternalComponent))</span><br><span class="line">    &#123;</span><br><span class="line">        result = ProbeChiComponents(pExternalComponent, &amp;m_numExternalComponent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        // Load the OEM sensor capacity customization functions</span><br><span class="line">        CAMXCustomizeCAMXInterface camxInterface;</span><br><span class="line">        camxInterface.pGetHWEnvironment = HwEnvironment::GetInstance;</span><br><span class="line">        CAMXCustomizeEntry(&amp;m_pOEMInterface, &amp;camxInterface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess != result)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;FATAL ERROR: Raise SigAbort. HwEnvironment initialization failed&quot;);</span><br><span class="line">        m_numberSensors = 0;</span><br><span class="line">        OsUtils::RaiseSignalAbort();</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        m_initCapsStatus = InitCapsInitialize;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-1-3-SettingsManager创建"><a href="#4-1-3-SettingsManager创建" class="headerlink" title="4.1.3 SettingsManager创建"></a>4.1.3 SettingsManager创建</h4><p>[-&gt;vendor\qcom\proprietary\camx\src\core\camxsettingsmanager.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SettingsManager* SettingsManager::Create(</span><br><span class="line">    StaticSettings* pStaticSettings)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    // Since this creation function is only used for static initialization, we don&apos;t want to track memory.</span><br><span class="line">    SettingsManager* pSettingsManager = CAMX_NEW SettingsManager();</span><br><span class="line">    if (pSettingsManager != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        result = pSettingsManager-&gt;Initialize(pStaticSettings);</span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_DELETE pSettingsManager;</span><br><span class="line">            pSettingsManager = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory; cannot create SettingsManager&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pSettingsManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">CamxResult SettingsManager::Initialize(</span><br><span class="line">    StaticSettings* pStaticSettings)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    // If the client gave us a static settings, use that. Otherwise, create our own.</span><br><span class="line">    if (NULL != pStaticSettings)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pStaticSettings = pStaticSettings;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        m_pStaticSettings = reinterpret_cast&lt;StaticSettings*&gt;(CAMX_CALLOC(sizeof(StaticSettings)));</span><br><span class="line">        if (NULL != m_pStaticSettings)</span><br><span class="line">        &#123;</span><br><span class="line">            m_internallyAllocatedStaticSettings = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory; cannot allocate static settings structure&quot;);</span><br><span class="line">            result = CamxResultENoMemory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create the override settings file helper</span><br><span class="line">    m_pOverrideSettingsStore = OverrideSettingsFile::Create();</span><br><span class="line"></span><br><span class="line">    if (NULL == m_pOverrideSettingsStore)</span><br><span class="line">    &#123;</span><br><span class="line">        result = CamxResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize the settings structure and override with user&apos;s values</span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        // Populate the default settings</span><br><span class="line">        InitializeDefaultSettings();</span><br><span class="line">        InitializeDefaultDebugSettings();</span><br><span class="line"></span><br><span class="line">#if SETTINGS_DUMP_ENABLE</span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            // Print all current settings</span><br><span class="line">            DumpSettings();</span><br><span class="line"></span><br><span class="line">            // Dump the override settings from our override settings stores</span><br><span class="line">            m_pOverrideSettingsStore-&gt;DumpOverriddenSettings();</span><br><span class="line">        &#125;</span><br><span class="line">#endif // SETTINGS_DUMP_ENABLE</span><br><span class="line"></span><br><span class="line">        // Load the override settings from our override settings stores</span><br><span class="line">        result = LoadOverrideSettings(m_pOverrideSettingsStore);</span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Failed to load override settings.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            result = LoadOverrideProperties(m_pOverrideSettingsStore, TRUE);</span><br><span class="line">            if (CamxResultSuccess != result)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Failed to load override properties.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Validate the updated settings structures</span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        result = ValidateSettings();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">#if SETTINGS_DUMP_ENABLE</span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        // Print all current settings</span><br><span class="line">        DumpSettings();</span><br><span class="line"></span><br><span class="line">        // Dump the override settings from our override settings stores</span><br><span class="line">        m_pOverrideSettingsStore-&gt;DumpOverriddenSettings();</span><br><span class="line">    &#125;</span><br><span class="line">#endif // SETTINGS_DUMP_ENABLE</span><br><span class="line"></span><br><span class="line">    // Push log settings to utils</span><br><span class="line">    UpdateLogSettings();</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取配置文件camxoverridesettings.xml</p>
<p>[-&gt;vendor\qcom\proprietary\camx\src\core\camxoverridesettingsfile.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OverrideSettingsFile* OverrideSettingsFile::Create()</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult              result                  = CamxResultSuccess;</span><br><span class="line">    OverrideSettingsFile*   pOverrideSettingsFile   = CAMX_NEW OverrideSettingsFile();</span><br><span class="line">    if (pOverrideSettingsFile != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        result = pOverrideSettingsFile-&gt;Initialize();</span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_DELETE pOverrideSettingsFile;</span><br><span class="line">            pOverrideSettingsFile = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory; cannot create OverrideSettingsFile&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pOverrideSettingsFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">static const CHAR* OverrideSettingsTextFileName =</span><br><span class="line">&#123;</span><br><span class="line">    &quot;camxoverridesettings.txt&quot;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">CamxResult OverrideSettingsFile::Initialize()</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    // Create the hash map to hold the override settings. Key is the settings string hash and value is a pointer to a</span><br><span class="line">    // SettingCacheEntry structure.</span><br><span class="line">    HashmapParams hashmapParams = &#123;0&#125;;</span><br><span class="line">    hashmapParams.keySize       = sizeof(UINT32);</span><br><span class="line">    hashmapParams.valSize       = 0;</span><br><span class="line">    m_pOverrideSettingsCache    = Hashmap::Create(&amp;hashmapParams);</span><br><span class="line">    if (NULL == m_pOverrideSettingsCache)</span><br><span class="line">    &#123;</span><br><span class="line">        result = CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        // Get the properties set on the device.</span><br><span class="line">        UpdatePropertyList();</span><br><span class="line"></span><br><span class="line">        // Since scratchString is used below to get the raw line from the override text file, the 128 should be way more than</span><br><span class="line">        // enough for the max length of whatever non-value stuff is specified on the override line (i.e. variable name, space,</span><br><span class="line">        // equals sign space, etc). Then, MaxStringLength is the max length string that a setting can have.</span><br><span class="line">        CHAR    scratchString[MaxStringLength + 128]    = &#123;0&#125;;</span><br><span class="line">        FILE*   pOverrideSettingsTextFile               = NULL;</span><br><span class="line"></span><br><span class="line">        // Search the paths to find the files</span><br><span class="line">        for (UINT directory = 0; directory &lt; CAMX_ARRAY_SIZE(OverrideSettingsTextFileDirectories); directory++)</span><br><span class="line">        &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                OsUtils::SNPrintF(scratchString,</span><br><span class="line">                                  sizeof(scratchString),</span><br><span class="line">                                  &quot;%s%s%s&quot;,</span><br><span class="line">                                  OverrideSettingsTextFileDirectories[directory],</span><br><span class="line">                                  PathSeparator,</span><br><span class="line">                                  OverrideSettingsTextFileName);</span><br><span class="line">                pOverrideSettingsTextFile = OsUtils::FOpen(scratchString, &quot;r&quot;);</span><br><span class="line">                if (NULL == pOverrideSettingsTextFile)</span><br><span class="line">                &#123;</span><br><span class="line">                    // We didn&apos;t find an override settings text file, try another path</span><br><span class="line">                    CAMX_LOG_VERBOSE(CamxLogGroupCore, &quot;Could not find override settings text file at: %s&quot;, scratchString);</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    // We found an override settings text file.</span><br><span class="line">                    CAMX_LOG_INFO(CamxLogGroupCore, &quot;Opening override settings text file: %s&quot;, scratchString);</span><br><span class="line"></span><br><span class="line">                    CHAR*   pSettingString      = NULL;</span><br><span class="line">                    CHAR*   pValueString        = NULL;</span><br><span class="line">                    CHAR*   pContext            = NULL;</span><br><span class="line">                    UINT32  settingStringHash   = 0;</span><br><span class="line">                    CHAR    strippedLine[MaxStringLength + 128];</span><br><span class="line"></span><br><span class="line">                    // Parse the settings file one line at a time</span><br><span class="line">                    while (NULL != OsUtils::FGetS(scratchString, sizeof(scratchString), pOverrideSettingsTextFile))</span><br><span class="line">                    &#123;</span><br><span class="line">                        // First strip off all whitespace from the line to make it easier to handle enum type settings with</span><br><span class="line">                        // combined values (e.g. A = B | C | D). After removing the whitespace, we only need to use &apos;=&apos; as the</span><br><span class="line">                        // delimiter to extract the setting/value string pair (e.g. setting string = &quot;A&quot;, value string =</span><br><span class="line">                        // &quot;B|C|D&quot;).</span><br><span class="line">                        Utils::Memset(strippedLine, 0x0, sizeof(strippedLine));</span><br><span class="line">                        OsUtils::StrStrip(strippedLine, scratchString, sizeof(strippedLine));</span><br><span class="line"></span><br><span class="line">                        // Extract a setting/value string pair.</span><br><span class="line">                        pSettingString  = OsUtils::StrTokReentrant(strippedLine, &quot;=&quot;, &amp;pContext);</span><br><span class="line">                        pValueString    = OsUtils::StrTokReentrant(NULL,         &quot;=&quot;, &amp;pContext);</span><br><span class="line"></span><br><span class="line">                        // Check for invalid lines</span><br><span class="line">                        if ((NULL == pSettingString) || (NULL == pValueString) || (&apos;\0&apos; == pValueString[0]))</span><br><span class="line">                        &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // Discard this line if the setting string starts with a semicolon, indicating a comment</span><br><span class="line">                        if (&apos;;&apos; == pSettingString[0])</span><br><span class="line">                        &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // Check whether the setting string is either an obfuscated hash or a human-readable setting name</span><br><span class="line">                        if ((&apos;0&apos; == pSettingString[0]) &amp;&amp;</span><br><span class="line">                            ((&apos;x&apos; == pSettingString[1]) || (&apos;X&apos; == pSettingString[1])))</span><br><span class="line">                        &#123;</span><br><span class="line">                            // Setting string is a hex value, indicating it is a hash</span><br><span class="line">                            settingStringHash = static_cast&lt;UINT32&gt;(OsUtils::StrToUL(pSettingString, NULL, 0));</span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                            // Setting string is a non-hex value, so get the hash</span><br><span class="line">                            settingStringHash = GetSettingsStringHashValue(pSettingString);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // Check if there is an existing entry. If not, create a new one. If so, update the value.</span><br><span class="line">                        SettingCacheEntry* pSettingCacheEntry = FindOverrideSetting(settingStringHash);</span><br><span class="line">                        if (NULL == pSettingCacheEntry)</span><br><span class="line">                        &#123;</span><br><span class="line">                            // No existing entry, add a key/value entry to the override settings cache</span><br><span class="line">                            pSettingCacheEntry = static_cast&lt;SettingCacheEntry*&gt;(CAMX_CALLOC(sizeof(SettingCacheEntry)));</span><br><span class="line">                            if (NULL == pSettingCacheEntry)</span><br><span class="line">                            &#123;</span><br><span class="line">                                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory; cannot allocate override setting entry&quot;);</span><br><span class="line">                                result = CamxResultENoMemory;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            // Populate override setting entry data (value string is updated below)</span><br><span class="line">                            pSettingCacheEntry-&gt;settingStringHash = settingStringHash;</span><br><span class="line"></span><br><span class="line">                            OsUtils::StrLCpy(pSettingCacheEntry-&gt;keyString,</span><br><span class="line">                                             pSettingString,</span><br><span class="line">                                             sizeof(pSettingCacheEntry-&gt;keyString));</span><br><span class="line"></span><br><span class="line">                            // Add the new override setting entry to override settings cache with the string has as the key</span><br><span class="line">                            m_pOverrideSettingsCache-&gt;Put(&amp;settingStringHash, pSettingCacheEntry);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // Set/overwrite value of setting</span><br><span class="line">                        OsUtils::StrLCpy(pSettingCacheEntry-&gt;valueString,</span><br><span class="line">                                         pValueString,</span><br><span class="line">                                         sizeof(pSettingCacheEntry-&gt;valueString));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    OsUtils::FClose(pOverrideSettingsTextFile);</span><br><span class="line">                    pOverrideSettingsTextFile = NULL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt;vendor\qcom\proprietary\camx\src\osutils\camxosutils.h]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static const CHAR OverrideSettingsPath[]   = &quot;/vendor/etc/camera&quot;;</span><br></pre></td></tr></table></figure>
<h4 id="4-1-4-CSLModeManager初始化"><a href="#4-1-4-CSLModeManager初始化" class="headerlink" title="4.1.4 CSLModeManager初始化"></a>4.1.4 CSLModeManager初始化</h4><p>[-&gt;vendor\qcom\proprietary\camx\src\csl\camxcsl.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">CamxResult CSLInitialize(</span><br><span class="line">    CSLInitializeParams* pInitializeParams)</span><br><span class="line">&#123;</span><br><span class="line">    CAMX_ENTRYEXIT_SCOPE(CamxLogGroupCSL, CamX::SCOPEEventCSLInitialize);</span><br><span class="line"></span><br><span class="line">    CAMX_STATIC_ASSERT(static_cast&lt;INT&gt;(CSLMode::CSLHwEnabled) ==</span><br><span class="line">                       static_cast&lt;INT&gt;(CamX::CSLModeType::CSLModeHardware));</span><br><span class="line">    CAMX_STATIC_ASSERT(static_cast&lt;INT&gt;(CSLMode::CSLIFHEnabled) ==</span><br><span class="line">                       static_cast&lt;INT&gt;(CamX::CSLModeType::CSLModeIFH));</span><br><span class="line">    CAMX_STATIC_ASSERT(static_cast&lt;INT&gt;(CSLMode::CSLPresilEnabled) ==</span><br><span class="line">                       static_cast&lt;INT&gt;(CamX::CSLModeType::CSLModePresil));</span><br><span class="line">    CAMX_STATIC_ASSERT(static_cast&lt;INT&gt;(CSLMode::CSLPresilRUMIEnabled) ==</span><br><span class="line">                       static_cast&lt;INT&gt;(CamX::CSLModeType::CSLModePresilRUMI));</span><br><span class="line"></span><br><span class="line">    if (NULL != g_pCSLModeManager)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_DELETE g_pCSLModeManager;</span><br><span class="line">        g_pCSLModeManager = NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_pCSLModeManager = CAMX_NEW CSLModeManager(pInitializeParams);</span><br><span class="line"></span><br><span class="line">    // Check g_pCSLModeManager before de-referencing it.</span><br><span class="line">    if (NULL != g_pCSLModeManager)</span><br><span class="line">    &#123;</span><br><span class="line">        CSLJumpTable* pJumpTable = g_pCSLModeManager-&gt;GetJumpTable();</span><br><span class="line">        return pJumpTable-&gt;CSLInitialize();</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCSL, &quot;CSL not initialized&quot;);</span><br><span class="line">        return CamxResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">CamxResult CSLInitializeHW()</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result                          = CamxResultEFailed;</span><br><span class="line">    CHAR       syncDeviceName[CSLHwMaxDevName] = &#123;0&#125;;</span><br><span class="line"></span><br><span class="line">    if (FALSE == CSLHwIsHwInstanceValid())</span><br><span class="line">    &#123;</span><br><span class="line">        if (TRUE == CSLHwEnumerateAndAddCSLHwDevice(CSLInternalHwVideodevice, CAM_VNODE_DEVICE_TYPE))</span><br><span class="line">        &#123;</span><br><span class="line">            if (TRUE == CSLHwEnumerateAndAddCSLHwDevice(CSLInternalHwVideoSubdevice, CAM_CPAS_DEVICE_TYPE))</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_VERBOSE(CamxLogGroupCSL, &quot;Platform family=%d, version=%d.%d.%d, cpas version=%d.%d.%d&quot;,</span><br><span class="line">                    g_CSLHwInstance.pCameraPlatform.family,</span><br><span class="line">                    g_CSLHwInstance.pCameraPlatform.platformVersion.majorVersion,</span><br><span class="line">                    g_CSLHwInstance.pCameraPlatform.platformVersion.minorVersion,</span><br><span class="line">                    g_CSLHwInstance.pCameraPlatform.platformVersion.revVersion,</span><br><span class="line">                    g_CSLHwInstance.pCameraPlatform.CPASVersion.majorVersion,</span><br><span class="line">                    g_CSLHwInstance.pCameraPlatform.CPASVersion.minorVersion,</span><br><span class="line">                    g_CSLHwInstance.pCameraPlatform.CPASVersion.revVersion);</span><br><span class="line"></span><br><span class="line">                if (FALSE == CSLHwEnumerateAndAddCSLHwDevice(CSLInternalHwVideoSubdeviceAll, 0))</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_ERROR(CamxLogGroupCSL, &quot;No KMD devices found&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_VERBOSE(CamxLogGroupCSL, &quot;Total KMD subdevices found =%d&quot;, g_CSLHwInstance.kmdDeviceCount);</span><br><span class="line">                &#125;</span><br><span class="line">                // Init the memory manager data structures here</span><br><span class="line">                CamX::Utils::Memset(g_CSLHwInstance.memManager.bufferInfo, 0, sizeof(g_CSLHwInstance.memManager.bufferInfo));</span><br><span class="line">                // Init the sync manager here</span><br><span class="line">                g_CSLHwInstance.lock-&gt;Lock();</span><br><span class="line">                g_CSLHwInstance.pSyncFW = CamX::SyncManager::GetInstance();</span><br><span class="line">                if (NULL != g_CSLHwInstance.pSyncFW)</span><br><span class="line">                &#123;</span><br><span class="line">                    CSLHwGetSyncHwDevice(syncDeviceName, CSLHwMaxDevName);</span><br><span class="line">                    CAMX_LOG_VERBOSE(CamxLogGroupCSL, &quot;Sync device found = %s&quot;, syncDeviceName);</span><br><span class="line">                    result = g_CSLHwInstance.pSyncFW-&gt;Initialize(syncDeviceName);</span><br><span class="line">                    if (CamxResultSuccess != result)</span><br><span class="line">                    &#123;</span><br><span class="line">                        CAMX_LOG_ERROR(CamxLogGroupCSL, &quot;CSL failed to initialize SyncFW&quot;);</span><br><span class="line">                        result = g_CSLHwInstance.pSyncFW-&gt;Destroy();</span><br><span class="line">                        g_CSLHwInstance.pSyncFW = NULL;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                g_CSLHwInstance.lock-&gt;Unlock();</span><br><span class="line">                CSLHwInstanceSetState(CSLHwValidState);</span><br><span class="line">                result = CamxResultSuccess;</span><br><span class="line">                CAMX_LOG_VERBOSE(CamxLogGroupCSL, &quot;Successfully acquired requestManager&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCSL, &quot;Failed to acquire CPAS&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCSL, &quot;Failed to acquire requestManager invalid&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCSL, &quot;CSL in Invalid State&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-1-5-总结"><a href="#4-1-5-总结" class="headerlink" title="4.1.5 总结"></a>4.1.5 总结</h4><p>主要流程如下：</p>
<ol>
<li>通过HAL3Module::GetInstance()静态方法实例化了HAL3Module对象，在其构造方法里面通过HwEnvironment::GetInstance()静态方法又实例化了HwEnvironment对象，在其构造方法中，实例化了SettingsManager对象，然后又在它构造方法中通过OverrideSettingsFile对象获取了位于/vendor/etc/camera/camoverridesettings.txt文件中的平台相关的配置信息（通过这种Override机制方便平台厂商加入自定义配置），该配置文件中，可以加入平台特定的配置项，比如可以通过设置multiCameraEnable的值来表示当前平台是否支持多摄，或者通过设置overrideLogLevels设置项来配置CamX-CHI部分的Log输出等级等等。</li>
<li>同时在HwEnvironment构造方法中会调用其Initialize方法，在该方法中实例化了CSLModeManager对象，并通过CSLModeManager提供的接口，获取了所有底层支持的硬件设备信息，其中包括了Camera Request Manager、CAPS模块（该驱动模块主要用于CSL获取Camera平台驱动信息，以及IPE/BPS模块的电源控制）以及Sensor/IPE/Flash等硬件模块，并且通过调用CSLHwInternalProbeSensorHW方法获取了当前设备安装的Sensor模组信息，并且将获取的信息暂存起来，等待后续阶段使用，总得来说在HwEnvironment初始化的过程中,通过探测方法获取了所有底层的硬件驱动模块，并将其信息存储下来供后续阶段使用。</li>
<li>之后通过调用HwEnvironment对象中的ProbeChiCompoents方法在/vendor/lib64/camera/components路径下找寻各个Node生成的So库，并获取Node提供的标准对外接口，这些Node不但包括CHI部分用户自定义的模块，还包括了CamX部分实现的硬件模块，并最后都将其都存入ExternalComponentInfo对象中，等待后续阶段使用。</li>
</ol>
<p>另外在初始化阶段还有一个比较重要的操作就是CamX 与CHI是通过互相dlopen对方的So库，获取了对方的入口方法，最后通过彼此的入口方法获取了对方操作方法集合，之后再通过这些操作方法与对方进行通讯，其主要流程见下图：</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/camx-chi-dlopen.png" style="zoom: 67%;"></p>
<p>从上图不难看出，在HAL3Module构造方法中会去通过dlopen方法加载com.qti.chi.override.so库，并通过dlsym映射出CHI部分的入口方法chi_hal_override_entry，并调用该方法将HAL3Module对像中的成员变量m_ChiAppCallbacks(CHIAppCallbacks)传入CHI中，其中包含了很多函数指针，这些函数指针分别对应着CHI部分的操作方法集中的方法，一旦进入到CHI中，就会将CHI本地的操作方法集合中的函数地址依次赋值给m_ChiAppCallbacks，这样CamX后续就可以通过这个成员变量调用到CHI中方法，从而保持了与CHI的通讯。</p>
<p>同样地，CHI中的ExtensionModule在初始化的时候，其构造方法中也会通过调用dlopen方法加载camera.qcom.so库，并将其入口方法ChiEntry通过dlsym映射出来，之后调用该方法，将g_chiContextOps（ChiContextOps，该结构体中定义了很多指针函数）作为参数传入CamX中，一旦进入CamX中，便会将本地的操作方法地址依次赋值给g_chiContextOps中的每一个函数指针，这样CHI之后就可以通过g_chiContextOps访问到CamX方法。</p>
<h3 id="4-2-打开相机设备-初始化相机设备"><a href="#4-2-打开相机设备-初始化相机设备" class="headerlink" title="4.2 打开相机设备/初始化相机设备"></a>4.2 打开相机设备/初始化相机设备</h3><p>一旦用户打开了相机应用，App中便会去调用CameraManager的openCamera方法，该方法之后会最终调用到Camera Service中的CameraService::connectDevice方法，然后通过ICameraDevice::open()这一个HIDL接口通知Provider，然后在Provider内部又通过调用之前获取的camera_module_t中methods的open方法来获取一个Camera 设备，对应于HAL中的camera3_device_t结构体，紧接着，在Provider中会继续调用获取到的camera3_device_t的initialize方法进行初始化动作。接下来我们便来详细分析下CamX-CHI对于open以及initialize的具体实现流程：</p>
<h4 id="4-2-1-open"><a href="#4-2-1-open" class="headerlink" title="4.2.1 open"></a>4.2.1 open</h4><p>[-&gt;hardware\interfaces\camera\common\1.0\default\CameraModule.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">camera_module_t *mModule;</span><br><span class="line"> </span><br><span class="line">int CameraModule::open(const char* id, struct hw_device_t** device) &#123;</span><br><span class="line">    int res;</span><br><span class="line">    ATRACE_BEGIN(&quot;camera_module-&gt;open&quot;);</span><br><span class="line">    res = filterOpenErrorCode(mModule-&gt;common.methods-&gt;open(&amp;mModule-&gt;common, id, device));</span><br><span class="line">    ATRACE_END();</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3entry.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// hw_module_methods_t Entry Points</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// open</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">int open(</span><br><span class="line">    const struct hw_module_t*   pHwModuleAPI,</span><br><span class="line">    const char*                 pCameraIdAPI,</span><br><span class="line">    struct hw_device_t**        ppHwDeviceAPI)</span><br><span class="line">&#123;</span><br><span class="line">    /// @todo (CAMX-43) - Reload Jumptable from settings</span><br><span class="line">    JumpTableHAL3* pHAL3 = static_cast&lt;JumpTableHAL3*&gt;(g_dispatchHAL3.GetJumpTable());</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(pHAL3);</span><br><span class="line">    CAMX_ASSERT(pHAL3-&gt;open);</span><br><span class="line"></span><br><span class="line">    return pHAL3-&gt;open(pHwModuleAPI, pCameraIdAPI, ppHwDeviceAPI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3.h]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">  // hw_module_methods_t entry points</span><br><span class="line">  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">  int (*open)(</span><br><span class="line">      const struct hw_module_t*,</span><br><span class="line">      const char*,</span><br><span class="line">      struct hw_device_t**);</span><br></pre></td></tr></table></figure>
<p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">static int open(</span><br><span class="line">    const struct hw_module_t*   pHwModuleAPI,</span><br><span class="line">    const char*                 pCameraIdAPI,</span><br><span class="line">    struct hw_device_t**        ppHwDeviceAPI)</span><br><span class="line">&#123;</span><br><span class="line">    CAMX_ENTRYEXIT_SCOPE(CamxLogGroupHAL, SCOPEEventHAL3Open);</span><br><span class="line"></span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line">    CAMX_ASSERT(NULL != pHwModuleAPI);</span><br><span class="line">    CAMX_ASSERT(NULL != pHwModuleAPI-&gt;id);</span><br><span class="line">    CAMX_ASSERT(NULL != pHwModuleAPI-&gt;name);</span><br><span class="line">    CAMX_ASSERT(NULL != pHwModuleAPI-&gt;author);</span><br><span class="line">    CAMX_ASSERT(NULL != pHwModuleAPI-&gt;methods);</span><br><span class="line">    CAMX_ASSERT(&apos;\0&apos; != pCameraIdAPI[0]);</span><br><span class="line">    CAMX_ASSERT(NULL != pCameraIdAPI);</span><br><span class="line">    CAMX_ASSERT(NULL != ppHwDeviceAPI);</span><br><span class="line"></span><br><span class="line">    if ((NULL != pHwModuleAPI) &amp;&amp;</span><br><span class="line">        (NULL != pHwModuleAPI-&gt;id) &amp;&amp;</span><br><span class="line">        (NULL != pHwModuleAPI-&gt;name) &amp;&amp;</span><br><span class="line">        (NULL != pHwModuleAPI-&gt;author) &amp;&amp;</span><br><span class="line">        (NULL != pHwModuleAPI-&gt;methods) &amp;&amp;</span><br><span class="line">        (NULL != pCameraIdAPI) &amp;&amp;</span><br><span class="line">        (&apos;\0&apos; != pCameraIdAPI[0]) &amp;&amp;</span><br><span class="line">        (NULL != ppHwDeviceAPI))</span><br><span class="line">    &#123;</span><br><span class="line">        CamX::OfflineLogger* pOfflineLoggerASCII = CamX::OfflineLogger::GetInstance(OfflineLoggerType::ASCII);</span><br><span class="line">        if (NULL != pOfflineLoggerASCII)</span><br><span class="line">        &#123;</span><br><span class="line">            pOfflineLoggerASCII-&gt;NotifyCameraOpen();</span><br><span class="line">        &#125;</span><br><span class="line">        CamX::OfflineLogger* pOfflineLoggerBinary = CamX::OfflineLogger::GetInstance(OfflineLoggerType::BINARY);</span><br><span class="line">        if (NULL != pOfflineLoggerBinary)</span><br><span class="line">        &#123;</span><br><span class="line">            pOfflineLoggerBinary-&gt;NotifyCameraOpen();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UINT32  cameraId        = 0;</span><br><span class="line">        UINT32  logicalCameraId = 0;</span><br><span class="line">        CHAR*   pNameEnd    = NULL;</span><br><span class="line"></span><br><span class="line">        cameraId = OsUtils::StrToUL(pCameraIdAPI, &amp;pNameEnd, 10);</span><br><span class="line"></span><br><span class="line">        const StaticSettings* pStaticSettings = HwEnvironment::GetInstance()-&gt;GetStaticSettings();</span><br><span class="line"></span><br><span class="line">//      Default value of forceCameraID override is set as 25, which is an emperical high value that is not expected for any camera</span><br><span class="line">//      Value other than 25 when given for forceCameraID, is set as the cameraID during camera open</span><br><span class="line">//      Physical camera ID&apos;s of 0, 1, 2 are not to be forced to other logical camera ID&apos;s</span><br><span class="line">        if ((25 != pStaticSettings-&gt;forceCameraID) &amp;&amp; (0 != cameraId) &amp;&amp; (1 != cameraId) &amp;&amp; (2 != cameraId))</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;cameraId from App: %d, Forced camera id: %d&quot;, cameraId, pStaticSettings-&gt;forceCameraID);</span><br><span class="line">            cameraId = pStaticSettings-&gt;forceCameraID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (*pNameEnd != &apos;\0&apos;)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Invalid camera id: %s&quot;, pCameraIdAPI);</span><br><span class="line">            // HAL interface requires -EINVAL (EInvalidArg) for invalid arguments</span><br><span class="line">            result = CamxResultEInvalidArg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            // Framework camera ID should only be known to these static landing functions, and the remap function</span><br><span class="line">            logicalCameraId = GetCHIAppCallbacks()-&gt;chi_remap_camera_id(cameraId, IdRemapCamera);</span><br><span class="line"></span><br><span class="line">            // Reserve the Torch resource for camera.</span><br><span class="line">            // If torch already switched on, then turn it off and reserve for camera.</span><br><span class="line">            HAL3Module::GetInstance()-&gt;ReserveTorchForCamera(</span><br><span class="line">                GetCHIAppCallbacks()-&gt;chi_remap_camera_id(cameraId, IdRemapTorch), cameraId);</span><br><span class="line"></span><br><span class="line">            // Sample code to show how the VOID* can be used in ExtendOpen</span><br><span class="line">            CHIEXTENDSETTINGS extend                       = &#123; 0 &#125;;</span><br><span class="line">            CHISETTINGTOKEN   tokenList[NumExtendSettings] = &#123; &#123; 0 &#125; &#125;;</span><br><span class="line">            extend.pTokens                                 = tokenList;</span><br><span class="line"></span><br><span class="line">            GenerateExtendOpenData(NumExtendSettings, &amp;extend);</span><br><span class="line"></span><br><span class="line">            // Reserve the camera to detect if it is already open or too many concurrent are open</span><br><span class="line">            CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;HalOp: Begin OPEN, logicalCameraId: %d, cameraId: %d&quot;,</span><br><span class="line">                            logicalCameraId, cameraId);</span><br><span class="line">            result = HAL3Module::GetInstance()-&gt;ProcessCameraOpen(logicalCameraId, &amp;extend);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            // Sample code to show how the VOID* can be used in ModifySettings</span><br><span class="line">            ChiModifySettings setting[NumExtendSettings] = &#123; &#123; &#123; 0 &#125; &#125; &#125;;</span><br><span class="line">            GenerateModifySettingsData(setting);</span><br><span class="line"></span><br><span class="line">            for (UINT i = 0; i &lt; NumExtendSettings; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                GetCHIAppCallbacks()-&gt;chi_modify_settings(&amp;setting[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CAMX_LOG_INFO(CamxLogGroupHAL, &quot;Open: overrideCameraClose is %d , overrideCameraOpen is %d &quot;,</span><br><span class="line">                pStaticSettings-&gt;overrideCameraClose, pStaticSettings-&gt;overrideCameraOpen);</span><br><span class="line"></span><br><span class="line">            const HwModule* pHwModule  = reinterpret_cast&lt;const HwModule*&gt;(pHwModuleAPI);</span><br><span class="line">            HALDevice*      pHALDevice = HALDevice::Create(pHwModule, logicalCameraId, cameraId);</span><br><span class="line"></span><br><span class="line">            if (NULL != pHALDevice)</span><br><span class="line">            &#123;</span><br><span class="line">                camera3_device_t* pCamera3Device = reinterpret_cast&lt;camera3_device_t*&gt;(pHALDevice-&gt;GetCameraDevice());</span><br><span class="line">                camera3_device_t&amp; rCamera3Device = *pCamera3Device;</span><br><span class="line">                *ppHwDeviceAPI                   = &amp;pCamera3Device-&gt;common;</span><br><span class="line">                BINARY_LOG(LogEvent::HAL3_Open, rCamera3Device, logicalCameraId, cameraId);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                // HAL interface requires -ENODEV (EFailed) for all other internal errors</span><br><span class="line">                result = CamxResultEFailed;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Error while opening camera&quot;);</span><br><span class="line"></span><br><span class="line">                CHIEXTENDSETTINGS extend                       = &#123; 0 &#125;;</span><br><span class="line">                CHISETTINGTOKEN   tokenList[NumExtendSettings] = &#123; &#123; 0 &#125; &#125;;</span><br><span class="line">                extend.pTokens = tokenList;</span><br><span class="line"></span><br><span class="line">                GenerateExtendCloseData(NumExtendSettings, &amp;extend);</span><br><span class="line"></span><br><span class="line">                // Allow the camera to be reopened later</span><br><span class="line">                HAL3Module::GetInstance()-&gt;ProcessCameraClose(logicalCameraId, &amp;extend);</span><br><span class="line"></span><br><span class="line">                ChiModifySettings setting[NumExtendSettings] = &#123; &#123; &#123; 0 &#125; &#125; &#125;;</span><br><span class="line">                GenerateModifySettingsData(setting);</span><br><span class="line"></span><br><span class="line">                for (UINT i = 0; i &lt; NumExtendSettings; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    GetCHIAppCallbacks()-&gt;chi_modify_settings(&amp;setting[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            // If open fails, then release the Torch resource that we reserved.</span><br><span class="line">            HAL3Module::GetInstance()-&gt;ReleaseTorchForCamera(</span><br><span class="line">                GetCHIAppCallbacks()-&gt;chi_remap_camera_id(cameraId, IdRemapTorch), cameraId);</span><br><span class="line">        &#125;</span><br><span class="line">        CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;HalOp: End OPEN, logicalCameraId: %d, cameraId: %d&quot;,</span><br><span class="line">                        logicalCameraId, cameraId);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Invalid argument(s) for open()&quot;);</span><br><span class="line">        // HAL interface requires -EINVAL (EInvalidArg) for invalid arguments</span><br><span class="line">        result = CamxResultEInvalidArg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return Utils::CamxResultToErrno(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-2-HALDevice初始化"><a href="#4-2-2-HALDevice初始化" class="headerlink" title="4.2.2 HALDevice初始化"></a>4.2.2 HALDevice初始化</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">HALDevice* HALDevice::Create(</span><br><span class="line">    const HwModule* pHwModule,</span><br><span class="line">    UINT32          cameraId,</span><br><span class="line">    UINT32          frameworkId)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result     = CamxResultENoMemory;</span><br><span class="line">    HALDevice* pHALDevice = CAMX_NEW HALDevice;</span><br><span class="line"></span><br><span class="line">    if (NULL != pHALDevice)</span><br><span class="line">    &#123;</span><br><span class="line">        pHALDevice-&gt;m_fwId = frameworkId;</span><br><span class="line"></span><br><span class="line">        result = pHALDevice-&gt;Initialize(pHwModule, cameraId);</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            pHALDevice-&gt;Destroy();</span><br><span class="line"></span><br><span class="line">            pHALDevice = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pHALDevice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HALDevice::Initialize</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">CamxResult HALDevice::Initialize(</span><br><span class="line">    const HwModule* pHwModule,</span><br><span class="line">    UINT32          cameraId)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    m_cameraId = cameraId;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        m_camera3Device.hwDevice.tag     = HARDWARE_DEVICE_TAG; /// @todo (CAMX-351) Get from local macro</span><br><span class="line"></span><br><span class="line">#if ((CAMX_ANDROID_API) &amp;&amp; (CAMX_ANDROID_API &gt;= 28)) // Android-P or better</span><br><span class="line">        m_camera3Device.hwDevice.version = CAMERA_DEVICE_API_VERSION_3_5;</span><br><span class="line">#else</span><br><span class="line">        m_camera3Device.hwDevice.version = CAMERA_DEVICE_API_VERSION_3_3;</span><br><span class="line">#endif // ((CAMX_ANDROID_API) &amp;&amp; (CAMX_ANDROID_API &gt;= 28))</span><br><span class="line"></span><br><span class="line">        m_camera3Device.hwDevice.close   = reinterpret_cast&lt;CloseFunc&gt;(GetHwDeviceCloseFunc());</span><br><span class="line">        m_camera3Device.pDeviceOps       = reinterpret_cast&lt;Camera3DeviceOps*&gt;(GetCamera3DeviceOps());</span><br><span class="line">        m_camera3Device.pPrivateData     = this;</span><br><span class="line">        // NOWHINE CP036a: Need exception here</span><br><span class="line">        m_camera3Device.hwDevice.pModule = const_cast&lt;HwModule*&gt;(pHwModule);</span><br><span class="line"></span><br><span class="line">        m_HALCallbacks.process_capture_result = ProcessCaptureResult;</span><br><span class="line">        m_HALCallbacks.notify_result          = Notify;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClearFrameworkRequestBuffer();</span><br><span class="line"></span><br><span class="line">    SIZE_T                entryCapacity;</span><br><span class="line">    SIZE_T                dataSize;</span><br><span class="line">    HAL3MetadataUtil::CalculateSizeAllMeta(&amp;entryCapacity, &amp;dataSize, TagSectionVisibleToFramework);</span><br><span class="line"></span><br><span class="line">    m_pResultMetadata = HAL3MetadataUtil::CreateMetadata(</span><br><span class="line">            entryCapacity,</span><br><span class="line">            dataSize);</span><br><span class="line"></span><br><span class="line">    for (UINT i = RequestTemplatePreview; i &lt; RequestTemplateCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        if (NULL == m_pDefaultRequestMetadata[i])</span><br><span class="line">        &#123;</span><br><span class="line">            ConstructDefaultRequestSettings(static_cast&lt;Camera3RequestTemplate&gt;(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const StaticSettings* pStaticSettings = HwEnvironment::GetInstance()-&gt;GetStaticSettings();</span><br><span class="line"></span><br><span class="line">    m_numPartialResult = pStaticSettings-&gt;numMetadataResults;</span><br><span class="line"></span><br><span class="line">    /* We will increment the Partial result count by 1 if CHI also has its own implementation */</span><br><span class="line">    if (CHIPartialDataSeparate == pStaticSettings-&gt;enableCHIPartialData)</span><br><span class="line">    &#123;</span><br><span class="line">        m_numPartialResult++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_tracingZoom = FALSE;</span><br><span class="line">    m_tunnellingEnabled = HAL3Module::GetInstance()-&gt;m_tunnellingEnabled;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-3-initialize"><a href="#4-2-3-initialize" class="headerlink" title="4.2.3 initialize"></a>4.2.3 initialize</h4><p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3entry.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// camera3_device_ops_t Entry Points</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// initialize</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">int initialize(</span><br><span class="line">    const struct camera3_device*    pCamera3DeviceAPI,</span><br><span class="line">    const camera3_callback_ops_t*   pCamera3CbOpsAPI)</span><br><span class="line">&#123;</span><br><span class="line">    JumpTableHAL3* pHAL3 = static_cast&lt;JumpTableHAL3*&gt;(g_dispatchHAL3.GetJumpTable());</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(pHAL3);</span><br><span class="line">    CAMX_ASSERT(pHAL3-&gt;initialize);</span><br><span class="line"></span><br><span class="line">    g_HAL3Entry.m_pCbOpsLock-&gt;Lock();</span><br><span class="line"></span><br><span class="line">    // See if there is already an entry for this device</span><br><span class="line">    Camera3CbOpsRedirect* pCamera3CbOps = NULL;</span><br><span class="line">    LDLLNode*             pNode         = g_HAL3Entry.m_cbOpsList.Head();</span><br><span class="line"></span><br><span class="line">    while (NULL != pNode)</span><br><span class="line">    &#123;</span><br><span class="line">        if (pCamera3DeviceAPI == static_cast&lt;Camera3CbOpsRedirect*&gt;(pNode-&gt;pData)-&gt;pCamera3Device)</span><br><span class="line">        &#123;</span><br><span class="line">            pCamera3CbOps = static_cast&lt;Camera3CbOpsRedirect*&gt;(pNode-&gt;pData);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        pNode = LightweightDoublyLinkedList::NextNode(pNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Else create and add to list</span><br><span class="line">    if (NULL == pCamera3CbOps)</span><br><span class="line">    &#123;</span><br><span class="line">        pNode = reinterpret_cast&lt;LDLLNode*&gt;(CAMX_CALLOC(sizeof(LDLLNode)));</span><br><span class="line"></span><br><span class="line">        if (NULL != pNode)</span><br><span class="line">        &#123;</span><br><span class="line">            pCamera3CbOps = reinterpret_cast&lt;Camera3CbOpsRedirect*&gt;(CAMX_CALLOC(sizeof(Camera3CbOpsRedirect)));</span><br><span class="line"></span><br><span class="line">            if (NULL != pCamera3CbOps)</span><br><span class="line">            &#123;</span><br><span class="line">                pNode-&gt;pData = pCamera3CbOps;</span><br><span class="line">                g_HAL3Entry.m_cbOpsList.InsertToTail(pNode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // List management may have failed, skip override on failure</span><br><span class="line">    if (NULL != pCamera3CbOps)</span><br><span class="line">    &#123;</span><br><span class="line">        pCamera3CbOps-&gt;cbOps.process_capture_result = process_capture_result;</span><br><span class="line">        pCamera3CbOps-&gt;cbOps.notify = notify;</span><br><span class="line">        pCamera3CbOps-&gt;pCamera3Device = pCamera3DeviceAPI;</span><br><span class="line">        pCamera3CbOps-&gt;pCbOpsAPI = pCamera3CbOpsAPI;</span><br><span class="line">        pCamera3CbOpsAPI = &amp;(pCamera3CbOps-&gt;cbOps);</span><br><span class="line">    &#125;</span><br><span class="line">    g_HAL3Entry.m_pCbOpsLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">    return pHAL3-&gt;initialize(pCamera3DeviceAPI, pCamera3CbOpsAPI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// initialize</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">static int initialize(</span><br><span class="line">    const struct camera3_device*    pCamera3DeviceAPI,</span><br><span class="line">    const camera3_callback_ops_t*   pCamera3CbOpsAPI)</span><br><span class="line">&#123;</span><br><span class="line">    CAMX_ENTRYEXIT_SCOPE(CamxLogGroupHAL, SCOPEEventHAL3Initialize);</span><br><span class="line"></span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != pCamera3DeviceAPI);</span><br><span class="line">    CAMX_ASSERT(NULL != pCamera3DeviceAPI-&gt;priv);</span><br><span class="line"></span><br><span class="line">    CAMX_LOG_INFO(CamxLogGroupHAL, &quot;initialize(): %p, %p&quot;, pCamera3DeviceAPI, pCamera3CbOpsAPI);</span><br><span class="line"></span><br><span class="line">    if ((NULL != pCamera3DeviceAPI) &amp;&amp;</span><br><span class="line">        (NULL != pCamera3DeviceAPI-&gt;priv))</span><br><span class="line">    &#123;</span><br><span class="line">        HALDevice* pHALDevice = GetHALDevice(pCamera3DeviceAPI);</span><br><span class="line">        pHALDevice-&gt;SetCallbackOps(pCamera3CbOpsAPI);</span><br><span class="line"></span><br><span class="line">        // initialize thermal after hal callback is set</span><br><span class="line">        const StaticSettings* pStaticSettings = HwEnvironment::GetInstance()-&gt;GetStaticSettings();</span><br><span class="line"></span><br><span class="line">        if (TRUE == pStaticSettings-&gt;enableThermalMitigation)</span><br><span class="line">        &#123;</span><br><span class="line">            ThermalManager* pThermalManager = HAL3Module::GetInstance()-&gt;GetThermalManager();</span><br><span class="line">            if (NULL != pThermalManager)</span><br><span class="line">            &#123;</span><br><span class="line">                CamxResult resultThermalReg = pThermalManager-&gt;RegisterHALDevice(pHALDevice);</span><br><span class="line">                if (CamxResultEResource == resultThermalReg)</span><br><span class="line">                &#123;</span><br><span class="line">                    result = resultThermalReg;</span><br><span class="line">                &#125;</span><br><span class="line">                // else Ignore result even if it fails. We don&apos;t want camera to fail due to any issues with initializing the</span><br><span class="line">                // thermal engine</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Invalid argument(s) for initialize()&quot;);</span><br><span class="line">        // HAL interface requires -ENODEV (EFailed) if initialization fails for any reason, including invalid arguments.</span><br><span class="line">        result = CamxResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return Utils::CamxResultToErrno(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-4-总结"><a href="#4-2-4-总结" class="headerlink" title="4.2.4 总结"></a>4.2.4 总结</h4><ul>
<li><strong>open</strong></li>
</ul>
<p>该方法是camera_module_t的标准方法，主要用来获取camera3_device_t设备结构体的，CamX-CHI对其进行了实现，open方法中完成的工作主要有以下几个：</p>
<ol>
<li>将当前camera id传入CHI中进行remap操作，当然这个remap操作逻辑完全是根据CHI中用户需求来的，用户可以根据自己的需要在CHI中加入自定义remap逻辑。</li>
<li>实例化HALDevice对象，其构造函数中调用Initialize方法，该方法会填充CamX中自定义的Camera3Device结构体。</li>
<li>将m_HALCallbacks.process_capture_result指向了本地方法ProcessCaptureResult以及m_HALCallbacks.notify_result指向了本地方法Notify（之后会在配置数据流的过程中，将m_HALCallbacks注册到CHI中， 一旦当CHI数据处理完成之后，便会通过这两个回调方法将数据或者事件回传给CamX）。</li>
<li>最后将HALDevice 中的Camera3Device成员变量作为返回值给到Provider中的CameraCaptureSession中。</li>
</ol>
<p>Camera3Device 其实重定义了camera3_device_t，其中HwDevice对应于camera3_device_t中的hw_device_t，Camera3DeviceOps对应于camera3_device_ops_t，而在HALDevice的初始化过程中，会将CamX实现的HAL3接口的结构体g_camera3DeviceOps赋值给Camera3DeviceOps中。</p>
<ul>
<li><strong>initialize</strong></li>
</ul>
<p>该方法在调用open后紧接着被调用，主要用于将上层的回调接口传入HAL中，一旦有数据或者事件产生，CamX便会通过这些回调接口将数据或者事件上传至调用者，其内部的实现较为简单。</p>
<p>initialize方法中有两个参数，分别是之前通过open方法获取的camera3_device_t结构体和实现了camera3_callback_ops_t的CameraDevice，很显然camera3_device_t结构体并不是重点，所以该方法的主要工作是将camera3_callback_ops_t与CamX关联上，一旦数据准备完成便通过这里camera3_callback_ops_t中回调方法将数据回传到Camera Provider中的CameraDevice中，基本流程可以总结为以下几点：</p>
<ol>
<li>实例化了一个Camera3CbOpsRedirect对象并将其加入了g_HAL3Entry.m_cbOpsList队列中，这样方便之后需要的时候能够顺利拿到该对象。</li>
<li>将本地的process_capture_result以及notify方法地址分别赋值给Camera3CbOpsRedirect.cbOps中的process_capture_result以及notify函数指针。</li>
<li>将上层传入的回调方法结构体指针pCamera3CbOpsAPI赋值给Camera3CbOpsRedirect.pCbOpsAPI，并将Camera3CbOpsRedirect.cbOps赋值给pCamera3CbOpsAPI，通过JumpTableHal3的initialize方法将pCamera3CbOpsAPI传给HALDevice中的m_pCamera3CbOps成员变量，这样HALDevice中的m_pCamera3CbOps就指向了CamX中本地方法process_capture_result以及notify。</li>
</ol>
<p>经过这样的一番操作之后，一旦CHI有数据传入便会首先进入到本地方法ProcessCaptureResult，然后在该方法中获取到HALDevice的成员变量m_pCamera3CbOps，进而调用m_pCamera3CbOps中的process_capture_result方法，即camxhal3entry.cpp中定义的process_capture_result方法，然后这个方法中会去调用JumpTableHAL3.process_capture_result方法，该方法最终会去调用Camera3CbOpsRedirect.pCbOpsAPI中的process_capture_result方法，这样就调到从Provider传入的回调方法，将数据顺利给到了CameraCaptureSession中。</p>
<h3 id="4-3-配置相机设备数据流"><a href="#4-3-配置相机设备数据流" class="headerlink" title="4.3 配置相机设备数据流"></a>4.3 配置相机设备数据流</h3><p>在打开相机应用过程中，App在获取并打开相机设备之后，会调用CameraDevice.createCaptureSession来获取CameraDeviceSession，并且通过Camera api v2标准接口，通知Camera Service，调用其CameraDeviceClient.endConfigure方法，在该方法内部又会去通过HIDL接口ICameraDeviceSession::configureStreams_3_4通知Provider开始处理此次配置需求，在Provider内部，会去通过在调用open流程中获取的camera3_device_t结构体的configure_streams方法来将数据流的配置传入CamX-CHI中，之后由CamX-CHI完成对数据流的配置工作，接下来我们来详细分析下CamX-CHI对于该标准HAL3接口 configure_streams的具体实现。</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/config_stream.png" alt=""></p>
<h4 id="4-3-1-configure-streams"><a href="#4-3-1-configure-streams" class="headerlink" title="4.3.1 configure_streams"></a>4.3.1 configure_streams</h4><h5 id="4-3-1-1-camxhal3entry-gt-configure-streams"><a href="#4-3-1-1-camxhal3entry-gt-configure-streams" class="headerlink" title="4.3.1.1 camxhal3entry-&gt;configure_streams"></a>4.3.1.1 camxhal3entry-&gt;configure_streams</h5><p>ops都是用JumpTable来获取到 camxhal3.cpp 中的JumpTableHAL3的跳转</p>
<p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3entry.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// configure_streams</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">int configure_streams(</span><br><span class="line">    const struct camera3_device*    pCamera3DeviceAPI,</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfigsAPI)</span><br><span class="line">&#123;</span><br><span class="line">    JumpTableHAL3* pHAL3 = static_cast&lt;JumpTableHAL3*&gt;(g_dispatchHAL3.GetJumpTable());</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(pHAL3);</span><br><span class="line">    CAMX_ASSERT(pHAL3-&gt;configure_streams);</span><br><span class="line"></span><br><span class="line">    return pHAL3-&gt;configure_streams(pCamera3DeviceAPI, pStreamConfigsAPI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-1-2-camxhal3-gt-configure-streams"><a href="#4-3-1-2-camxhal3-gt-configure-streams" class="headerlink" title="4.3.1.2 camxhal3-&gt;configure_streams"></a>4.3.1.2 camxhal3-&gt;configure_streams</h5><p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// configure_streams</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">static int configure_streams(</span><br><span class="line">    const struct camera3_device*    pCamera3DeviceAPI,</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfigsAPI)</span><br><span class="line">&#123;</span><br><span class="line">    CAMX_ENTRYEXIT_SCOPE(CamxLogGroupHAL, SCOPEEventHAL3ConfigureStreams);</span><br><span class="line"></span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != pCamera3DeviceAPI);</span><br><span class="line">    CAMX_ASSERT(NULL != pCamera3DeviceAPI-&gt;priv);</span><br><span class="line">    CAMX_ASSERT(NULL != pStreamConfigsAPI);</span><br><span class="line">    CAMX_ASSERT(pStreamConfigsAPI-&gt;num_streams &gt; 0);</span><br><span class="line">    CAMX_ASSERT(NULL != pStreamConfigsAPI-&gt;streams);</span><br><span class="line"></span><br><span class="line">    if ((NULL != pCamera3DeviceAPI)          &amp;&amp;</span><br><span class="line">        (NULL != pCamera3DeviceAPI-&gt;priv)    &amp;&amp;</span><br><span class="line">        (NULL != pStreamConfigsAPI)          &amp;&amp;</span><br><span class="line">        (pStreamConfigsAPI-&gt;num_streams &gt; 0) &amp;&amp;</span><br><span class="line">        (NULL != pStreamConfigsAPI-&gt;streams))</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_INFO(CamxLogGroupHAL, &quot;Number of streams: %d&quot;, pStreamConfigsAPI-&gt;num_streams);</span><br><span class="line"></span><br><span class="line">        HALDevice* pHALDevice = GetHALDevice(pCamera3DeviceAPI);</span><br><span class="line"></span><br><span class="line">        CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;HalOp: Begin CONFIG: %p, logicalCameraId: %d, cameraId: %d&quot;,</span><br><span class="line">                        pCamera3DeviceAPI, pHALDevice-&gt;GetCameraId(), pHALDevice-&gt;GetFwCameraId());</span><br><span class="line"></span><br><span class="line">        uint32_t numStreams      = pStreamConfigsAPI-&gt;num_streams;</span><br><span class="line">        UINT32   logicalCameraId = pHALDevice-&gt;GetCameraId();</span><br><span class="line">        UINT32   cameraId        = pHALDevice-&gt;GetFwCameraId();</span><br><span class="line">        BINARY_LOG(LogEvent::HAL3_ConfigSetup, numStreams, logicalCameraId, cameraId);</span><br><span class="line">        for (UINT32 stream = 0; stream &lt; pStreamConfigsAPI-&gt;num_streams; stream++)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_ASSERT(NULL != pStreamConfigsAPI-&gt;streams[stream]);</span><br><span class="line"></span><br><span class="line">            if (NULL == pStreamConfigsAPI-&gt;streams[stream])</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Invalid argument 2 for configure_streams()&quot;);</span><br><span class="line">                // HAL interface requires -EINVAL (EInvalidArg) for invalid arguments</span><br><span class="line">                result = CamxResultEInvalidArg;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                camera3_stream_t&amp; rConfigStream = *pStreamConfigsAPI-&gt;streams[stream];</span><br><span class="line">                BINARY_LOG(LogEvent::HAL3_StreamInfo, rConfigStream);</span><br><span class="line"></span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;  stream[%d] = %p - info:&quot;, stream,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]);</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            format       : %d, %s&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;format,</span><br><span class="line">                    FormatToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;format));</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            width        : %d&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;width);</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            height       : %d&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;height);</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            stream_type  : %08x, %s&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;stream_type,</span><br><span class="line">                    StreamTypeToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;stream_type));</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            usage        : %08x&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;usage);</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            max_buffers  : %d&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;max_buffers);</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            rotation     : %08x, %s&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;rotation,</span><br><span class="line">                    RotationToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;rotation));</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            data_space   : %08x, %s&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;data_space,</span><br><span class="line">                    DataSpaceToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;data_space));</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            priv         : %p&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;priv);</span><br><span class="line">#if (defined(CAMX_ANDROID_API) &amp;&amp; (CAMX_ANDROID_API &gt;= 28)) // Android-P or better</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupHAL, &quot;            physical_camera_id         : %s&quot;,</span><br><span class="line">                    pStreamConfigsAPI-&gt;streams[stream]-&gt;physical_camera_id);</span><br><span class="line">#endif // Android-P or better</span><br><span class="line">                pStreamConfigsAPI-&gt;streams[stream]-&gt;reserved[0] = NULL;</span><br><span class="line">                pStreamConfigsAPI-&gt;streams[stream]-&gt;reserved[1] = NULL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        CAMX_LOG_INFO(CamxLogGroupHAL, &quot;  operation_mode: %d&quot;, pStreamConfigsAPI-&gt;operation_mode);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Camera3StreamConfig* pStreamConfigs = reinterpret_cast&lt;Camera3StreamConfig*&gt;(pStreamConfigsAPI);</span><br><span class="line"></span><br><span class="line">        result = pHALDevice-&gt;ConfigureStreams(pStreamConfigs);</span><br><span class="line"></span><br><span class="line">        if ((CamxResultSuccess != result) &amp;&amp; (CamxResultEInvalidArg != result))</span><br><span class="line">        &#123;</span><br><span class="line">            // HAL interface requires -ENODEV (EFailed) if a fatal error occurs</span><br><span class="line">            result = CamxResultEFailed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            for (UINT32 stream = 0; stream &lt; pStreamConfigsAPI-&gt;num_streams; stream++)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_ASSERT(NULL != pStreamConfigsAPI-&gt;streams[stream]);</span><br><span class="line"></span><br><span class="line">                if (NULL == pStreamConfigsAPI-&gt;streams[stream])</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Invalid argument 2 for configure_streams()&quot;);</span><br><span class="line">                    // HAL interface requires -EINVAL (EInvalidArg) for invalid arguments</span><br><span class="line">                    result = CamxResultEInvalidArg;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot; FINAL stream[%d] = %p - info:&quot;, stream,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            format       : %d, %s&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;format,</span><br><span class="line">                        FormatToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;format));</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            width        : %d&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;width);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            height       : %d&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;height);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            stream_type  : %08x, %s&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;stream_type,</span><br><span class="line">                        StreamTypeToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;stream_type));</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            usage        : %08x&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;usage);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            max_buffers  : %d&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;max_buffers);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            rotation     : %08x, %s&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;rotation,</span><br><span class="line">                        RotationToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;rotation));</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            data_space   : %08x, %s&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;data_space,</span><br><span class="line">                        DataSpaceToString(pStreamConfigsAPI-&gt;streams[stream]-&gt;data_space));</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            priv         : %p&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;priv);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            reserved[0]         : %p&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;reserved[0]);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;            reserved[1]         : %p&quot;,</span><br><span class="line">                        pStreamConfigsAPI-&gt;streams[stream]-&gt;reserved[1]);</span><br><span class="line"></span><br><span class="line">                    Camera3HalStream* pHalStream =</span><br><span class="line">                        reinterpret_cast&lt;Camera3HalStream*&gt;(pStreamConfigsAPI-&gt;streams[stream]-&gt;reserved[0]);</span><br><span class="line">                    if (pHalStream != NULL)</span><br><span class="line">                    &#123;</span><br><span class="line">                        if (TRUE == HwEnvironment::GetInstance()-&gt;GetStaticSettings()-&gt;enableHALFormatOverride)</span><br><span class="line">                        &#123;</span><br><span class="line">                            pStreamConfigsAPI-&gt;streams[stream]-&gt;format =</span><br><span class="line">                                static_cast&lt;HALPixelFormat&gt;(pHalStream-&gt;overrideFormat);</span><br><span class="line">                        &#125;</span><br><span class="line">                        CAMX_LOG_CONFIG(CamxLogGroupHAL,</span><br><span class="line">                            &quot;   pHalStream: %p format : 0x%x, overrideFormat : 0x%x consumer usage: %llx,&quot;</span><br><span class="line">                            &quot; producer usage: %llx&quot;,</span><br><span class="line">                            pHalStream, pStreamConfigsAPI-&gt;streams[stream]-&gt;format,</span><br><span class="line">                            pHalStream-&gt;overrideFormat, pHalStream-&gt;consumerUsage, pHalStream-&gt;producerUsage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;HalOp: End CONFIG, logicalCameraId: %d, cameraId: %d&quot;,</span><br><span class="line">                        pHALDevice-&gt;GetCameraId(), pHALDevice-&gt;GetFwCameraId());</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Invalid argument(s) for configure_streams()&quot;);</span><br><span class="line">        // HAL interface requires -EINVAL (EInvalidArg) for invalid arguments</span><br><span class="line">        result = CamxResultEInvalidArg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return Utils::CamxResultToErrno(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-1-3-HALDevice-ConfigureStreams"><a href="#4-3-1-3-HALDevice-ConfigureStreams" class="headerlink" title="4.3.1.3 HALDevice::ConfigureStreams"></a>4.3.1.3 HALDevice::ConfigureStreams</h5><p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhaldevice.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">CamxResult HALDevice::ConfigureStreams(</span><br><span class="line">    Camera3StreamConfig* pStreamConfigs)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    // Validate the incoming stream configurations</span><br><span class="line">    result = CheckValidStreamConfig(pStreamConfigs);</span><br><span class="line"></span><br><span class="line">    if ((StreamConfigModeConstrainedHighSpeed == pStreamConfigs-&gt;operationMode) ||</span><br><span class="line">        (StreamConfigModeSuperSlowMotionFRC == pStreamConfigs-&gt;operationMode))</span><br><span class="line">    &#123;</span><br><span class="line">        SearchNumBatchedFrames (pStreamConfigs, &amp;m_usecaseNumBatchedFrames, &amp;m_FPSValue);</span><br><span class="line">        CAMX_ASSERT(m_usecaseNumBatchedFrames &gt; 1);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        // Not a HFR usecase batch frames value need to set to 1.</span><br><span class="line">        m_usecaseNumBatchedFrames = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        if (TRUE == m_bCHIModuleInitialized)</span><br><span class="line">        &#123;</span><br><span class="line">            GetCHIAppCallbacks()-&gt;chi_teardown_override_session(reinterpret_cast&lt;camera3_device*&gt;(&amp;m_camera3Device), 0, NULL);</span><br><span class="line">            ReleaseStreamConfig();</span><br><span class="line">            DeInitRequestLogger();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_bCHIModuleInitialized = CHIModuleInitialize(pStreamConfigs);</span><br><span class="line"></span><br><span class="line">        ClearFrameworkRequestBuffer();</span><br><span class="line"></span><br><span class="line">        if (FALSE == m_bCHIModuleInitialized)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;CHI Module failed to configure streams&quot;);</span><br><span class="line">            result = CamxResultEFailed;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            result = SaveStreamConfig(pStreamConfigs);</span><br><span class="line">            result = InitializeRequestLogger();</span><br><span class="line">            CAMX_LOG_VERBOSE(CamxLogGroupHAL, &quot;CHI Module configured streams ... CHI is in control!&quot;);</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                if (m_tunnellingEnabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    // Create tunnelling layer</span><br><span class="line">                    // TODO: App should provide details as z order, dest. rect., etc.</span><br><span class="line">                    LayerInfo layer;</span><br><span class="line"></span><br><span class="line">                    for (UINT i = 0; i &lt; pStreamConfigs-&gt;numStreams; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        if (StreamTypeOutput == pStreamConfigs-&gt;ppStreams[i]-&gt;streamType &amp;&amp;</span><br><span class="line">                            HALPixelFormatImplDefined == pStreamConfigs-&gt;ppStreams[i]-&gt;format &amp;&amp;</span><br><span class="line">                            ((GrallocUsageHwComposer &amp; pStreamConfigs-&gt;ppStreams[i]-&gt;grallocUsage) ||</span><br><span class="line">                            (GrallocUsageHwTexture &amp; pStreamConfigs-&gt;ppStreams[i]-&gt;grallocUsage)))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Camera3Stream* stream = pStreamConfigs-&gt;ppStreams[i];</span><br><span class="line">                            layer.width = stream-&gt;width;</span><br><span class="line">                            layer.height = stream-&gt;height;</span><br><span class="line">                            layer.dataspace = (int32_t)stream-&gt;dataspace;</span><br><span class="line">                            layer.rotation = (int32_t)stream-&gt;rotation;</span><br><span class="line">                            //layer.format is not used for now</span><br><span class="line"></span><br><span class="line">                            result = DisplayConfigInterface::GetInstance()-&gt;CreateLayer(layer);</span><br><span class="line">                            if (CamxResultSuccess != result)</span><br><span class="line">                            &#123;</span><br><span class="line">                                CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Create layer failed with %d&quot;, result);</span><br><span class="line">                                return result;</span><br><span class="line">                            &#125;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 如果之前有过配流的操作，m_bCHIModuleInitialized会被赋值，然后销毁 session的操作，调用CHIModuleInitialize函数操作</p>
<h5 id="4-3-1-4-HALDevice-CHIModuleInitialize"><a href="#4-3-1-4-HALDevice-CHIModuleInitialize" class="headerlink" title="4.3.1.4 HALDevice::CHIModuleInitialize"></a>4.3.1.4 HALDevice::CHIModuleInitialize</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BOOL HALDevice::CHIModuleInitialize(</span><br><span class="line">    Camera3StreamConfig* pStreamConfigs)</span><br><span class="line">&#123;</span><br><span class="line">    BOOL isOverrideEnabled = FALSE;</span><br><span class="line"></span><br><span class="line">    if (TRUE == HAL3Module::GetInstance()-&gt;IsCHIOverrideModulePresent())</span><br><span class="line">    &#123;</span><br><span class="line">        /// @todo (CAMX-1518) Handle private data from Override module</span><br><span class="line">        VOID*                   pPrivateData;</span><br><span class="line">        chi_hal_callback_ops_t* pCHIAppCallbacks  = GetCHIAppCallbacks();</span><br><span class="line"></span><br><span class="line">        pCHIAppCallbacks-&gt;chi_initialize_override_session(GetCameraId(),</span><br><span class="line">                                                          reinterpret_cast&lt;const camera3_device_t*&gt;(&amp;m_camera3Device),</span><br><span class="line">                                                          &amp;m_HALCallbacks,</span><br><span class="line">                                                          reinterpret_cast&lt;camera3_stream_configuration_t*&gt;(pStreamConfigs),</span><br><span class="line">                                                          &amp;isOverrideEnabled,</span><br><span class="line">                                                          &amp;pPrivateData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return isOverrideEnabled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiframework\chxextensioninterface.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static CDKResult chi_initialize_override_session(</span><br><span class="line">    uint32_t                        cameraId,</span><br><span class="line">    const camera3_device_t*         camera3_device,</span><br><span class="line">    const chi_hal_ops_t*            chiHalOps,</span><br><span class="line">    camera3_stream_configuration_t* stream_config,</span><br><span class="line">    int*                            override_config,</span><br><span class="line">    void**                          priv)</span><br><span class="line">&#123;</span><br><span class="line">    ExtensionModule* pExtensionModule = ExtensionModule::GetInstance();</span><br><span class="line"></span><br><span class="line">    pExtensionModule-&gt;InitializeOverrideSession(cameraId, camera3_device, chiHalOps, stream_config, override_config, priv);</span><br><span class="line"></span><br><span class="line">    return CDKResultSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-1-5-ExtensionModule-InitializeOverrideSession"><a href="#4-3-1-5-ExtensionModule-InitializeOverrideSession" class="headerlink" title="4.3.1.5 ExtensionModule::InitializeOverrideSession"></a>4.3.1.5 ExtensionModule::InitializeOverrideSession</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiframework\chxextensionmodule.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><span class="line">CDKResult ExtensionModule::InitializeOverrideSession(</span><br><span class="line">    uint32_t                        logicalCameraId,</span><br><span class="line">    const camera3_device_t*         pCamera3Device,</span><br><span class="line">    const chi_hal_ops_t*            chiHalOps,</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfig,</span><br><span class="line">    int*                            pIsOverrideEnabled,</span><br><span class="line">    VOID**                          pPrivate)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult          result             = CDKResultSuccess;</span><br><span class="line">    UINT32             modeCount          = 0;</span><br><span class="line">    ChiSensorModeInfo* pAllModes          = NULL;</span><br><span class="line">    UINT32             fps                = *m_pDefaultMaxFPS;</span><br><span class="line">    BOOL               isVideoMode        = FALSE;</span><br><span class="line">    uint32_t           operation_mode;</span><br><span class="line">    static BOOL        fovcModeCheck      = EnableFOVCUseCase();</span><br><span class="line">    UsecaseId          selectedUsecaseId  = UsecaseId::NoMatch;</span><br><span class="line">    UINT               minSessionFps      = 0;</span><br><span class="line">    UINT               maxSessionFps      = 0;</span><br><span class="line">    CDKResult          tagOpResult        = CDKResultEFailed;</span><br><span class="line">    ChiBLMParams       blmParams;</span><br><span class="line"></span><br><span class="line">    *pPrivate             = NULL;</span><br><span class="line">    *pIsOverrideEnabled   = FALSE;</span><br><span class="line">    m_aFlushInProgress[logicalCameraId] = FALSE;</span><br><span class="line">    m_firstResult                       = FALSE;</span><br><span class="line">    m_hasFlushOccurred[logicalCameraId] = FALSE;</span><br><span class="line">    blmParams.height                    = 0;</span><br><span class="line">    blmParams.width                     = 0;</span><br><span class="line"></span><br><span class="line">    if (NULL == m_hCHIContext)</span><br><span class="line">    &#123;</span><br><span class="line">        m_hCHIContext = g_chiContextOps.pOpenContext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ChiVendorTagsOps vendorTagOps = &#123; 0 &#125;;</span><br><span class="line">    g_chiContextOps.pTagOps(&amp;vendorTagOps);</span><br><span class="line">    operation_mode                = pStreamConfig-&gt;operation_mode &gt;&gt; 16;</span><br><span class="line">    operation_mode                = operation_mode &amp; 0x000F;</span><br><span class="line">    pStreamConfig-&gt;operation_mode = pStreamConfig-&gt;operation_mode &amp; 0xFFFF;</span><br><span class="line"></span><br><span class="line">    UINT numOutputStreams = 0;</span><br><span class="line">    for (UINT32 stream = 0; stream &lt; pStreamConfig-&gt;num_streams; stream++)</span><br><span class="line">    &#123;</span><br><span class="line">        if (0 != (pStreamConfig-&gt;streams[stream]-&gt;usage &amp; GrallocUsageHwVideoEncoder))</span><br><span class="line">        &#123;</span><br><span class="line">            isVideoMode = TRUE;</span><br><span class="line"></span><br><span class="line">            if((pStreamConfig-&gt;streams[stream]-&gt;height * pStreamConfig-&gt;streams[stream]-&gt;width) &gt;</span><br><span class="line">             (blmParams.height * blmParams.width))</span><br><span class="line">            &#123;</span><br><span class="line">                blmParams.height = pStreamConfig-&gt;streams[stream]-&gt;height;</span><br><span class="line">                blmParams.width  = pStreamConfig-&gt;streams[stream]-&gt;width;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CAMERA3_STREAM_OUTPUT == pStreamConfig-&gt;streams[stream]-&gt;stream_type)</span><br><span class="line">        &#123;</span><br><span class="line">            numOutputStreams++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //If video stream not present in that case store Preview/Snapshot Stream info</span><br><span class="line">        if((pStreamConfig-&gt;streams[stream]-&gt;height &gt; blmParams.height) &amp;&amp;</span><br><span class="line">            (pStreamConfig-&gt;streams[stream]-&gt;width &gt; blmParams.width)  &amp;&amp;</span><br><span class="line">            (isVideoMode == FALSE))</span><br><span class="line">        &#123;</span><br><span class="line">            blmParams.height = pStreamConfig-&gt;streams[stream]-&gt;height;</span><br><span class="line">            blmParams.width  = pStreamConfig-&gt;streams[stream]-&gt;width;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (numOutputStreams &gt; MaxExternalBuffers)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_ERROR(&quot;numOutputStreams(%u) greater than MaxExternalBuffers(%u)&quot;, numOutputStreams, MaxExternalBuffers);</span><br><span class="line">        result = CDKResultENotImplemented;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((isVideoMode == TRUE) &amp;&amp; (operation_mode != 0))</span><br><span class="line">    &#123;</span><br><span class="line">        UINT32             numSensorModes  = m_logicalCameraInfo[logicalCameraId].m_cameraCaps.numSensorModes;</span><br><span class="line">        CHISENSORMODEINFO* pAllSensorModes = m_logicalCameraInfo[logicalCameraId].pSensorModeInfo;</span><br><span class="line"></span><br><span class="line">        if ((operation_mode - 1) &gt;= numSensorModes)</span><br><span class="line">        &#123;</span><br><span class="line">            result = CDKResultEOverflow;</span><br><span class="line">            CHX_LOG_ERROR(&quot;operation_mode: %d, numSensorModes: %d&quot;, operation_mode, numSensorModes);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            fps = pAllSensorModes[operation_mode - 1].frameRate;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CDKResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">#if defined(CAMX_ANDROID_API) &amp;&amp; (CAMX_ANDROID_API &gt;= 28) //Android-P or better</span><br><span class="line">        camera_metadata_t* metadata = const_cast&lt;camera_metadata_t*&gt;(pStreamConfig-&gt;session_parameters);</span><br><span class="line"></span><br><span class="line">        camera_metadata_entry_t entry = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">        // The client may choose to send NULL sesssion parameter, which is fine. For example, torch mode</span><br><span class="line">        // will have NULL session param.</span><br><span class="line">        if (metadata != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            entry.tag = ANDROID_CONTROL_AE_TARGET_FPS_RANGE;</span><br><span class="line"></span><br><span class="line">            int ret = find_camera_metadata_entry(metadata, entry.tag, &amp;entry);</span><br><span class="line"></span><br><span class="line">            if(ret == 0) &#123;</span><br><span class="line">                minSessionFps = entry.data.i32[0];</span><br><span class="line">                maxSessionFps = entry.data.i32[1];</span><br><span class="line">                m_usecaseMaxFPS = maxSessionFps;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CHITAGSOPS   tagOps       = &#123; 0 &#125;;</span><br><span class="line">        UINT32       tagLocation  = 0;</span><br><span class="line"></span><br><span class="line">        g_chiContextOps.pTagOps(&amp;tagOps);</span><br><span class="line"></span><br><span class="line">        tagOpResult = tagOps.pQueryVendorTagLocation(</span><br><span class="line">            &quot;org.codeaurora.qcamera3.sessionParameters&quot;,</span><br><span class="line">            &quot;availableStreamMap&quot;,</span><br><span class="line">            &amp;tagLocation);</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess == tagOpResult)</span><br><span class="line">        &#123;</span><br><span class="line">            camera_metadata_entry_t entry = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">            if (metadata != NULL)</span><br><span class="line">            &#123;</span><br><span class="line">                int ret = find_camera_metadata_entry(metadata, tagLocation, &amp;entry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tagOpResult = tagOps.pQueryVendorTagLocation(</span><br><span class="line">            &quot;org.codeaurora.qcamera3.sessionParameters&quot;,</span><br><span class="line">            &quot;overrideResourceCostValidation&quot;,</span><br><span class="line">            &amp;tagLocation);</span><br><span class="line"></span><br><span class="line">        if ((NULL != metadata) &amp;&amp; (CDKResultSuccess == tagOpResult))</span><br><span class="line">        &#123;</span><br><span class="line">            camera_metadata_entry_t resourcecostEntry = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">            if (0 == find_camera_metadata_entry(metadata, tagLocation, &amp;resourcecostEntry))</span><br><span class="line">            &#123;</span><br><span class="line">                BOOL bypassRCV = static_cast&lt;BOOL&gt;(resourcecostEntry.data.u8[0]);</span><br><span class="line"></span><br><span class="line">                if (TRUE == bypassRCV)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pResourcesUsedLock-&gt;Lock();</span><br><span class="line">                    m_logicalCameraRCVBypassSet.insert(logicalCameraId);</span><br><span class="line">                    m_pResourcesUsedLock-&gt;Unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        CHIHANDLE    staticMetaDataHandle = const_cast&lt;camera_metadata_t*&gt;(</span><br><span class="line">                                            m_logicalCameraInfo[logicalCameraId].m_cameraInfo.static_camera_characteristics);</span><br><span class="line">        UINT32       metaTagPreviewFPS    = 0;</span><br><span class="line">        UINT32       metaTagVideoFPS      = 0;</span><br><span class="line"></span><br><span class="line">        m_previewFPS           = 0;</span><br><span class="line">        m_videoFPS             = 0;</span><br><span class="line">        GetInstance()-&gt;GetVendorTagOps(&amp;vendorTagOps);</span><br><span class="line"></span><br><span class="line">        result = vendorTagOps.pQueryVendorTagLocation(&quot;org.quic.camera2.streamBasedFPS.info&quot;, &quot;PreviewFPS&quot;,</span><br><span class="line">                                                      &amp;metaTagPreviewFPS);</span><br><span class="line">        if (CDKResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            vendorTagOps.pGetMetaData(staticMetaDataHandle, metaTagPreviewFPS, &amp;m_previewFPS,</span><br><span class="line">                                      sizeof(m_previewFPS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = vendorTagOps.pQueryVendorTagLocation(&quot;org.quic.camera2.streamBasedFPS.info&quot;, &quot;VideoFPS&quot;, &amp;metaTagVideoFPS);</span><br><span class="line">        if (CDKResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            vendorTagOps.pGetMetaData(staticMetaDataHandle, metaTagVideoFPS, &amp;m_videoFPS,</span><br><span class="line">                                      sizeof(m_videoFPS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ((StreamConfigModeConstrainedHighSpeed == pStreamConfig-&gt;operation_mode) ||</span><br><span class="line">            (StreamConfigModeSuperSlowMotionFRC == pStreamConfig-&gt;operation_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            if ((StreamConfigModeConstrainedHighSpeed == pStreamConfig-&gt;operation_mode) &amp;&amp;</span><br><span class="line">                (30 &gt;= maxSessionFps))</span><br><span class="line">            &#123;</span><br><span class="line">                minSessionFps   = DefaultFrameRateforHighSpeedSession;</span><br><span class="line">                maxSessionFps   = DefaultFrameRateforHighSpeedSession;</span><br><span class="line">                m_usecaseMaxFPS = maxSessionFps;</span><br><span class="line"></span><br><span class="line">                CHX_LOG_INFO(&quot;minSessionFps = %d maxSessionFps = %d&quot;, minSessionFps, maxSessionFps);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SearchNumBatchedFrames(logicalCameraId, pStreamConfig,</span><br><span class="line">                                   &amp;m_usecaseNumBatchedFrames, &amp;m_HALOutputBufferCombined,</span><br><span class="line">                                   &amp;m_usecaseMaxFPS, maxSessionFps);</span><br><span class="line">            if (480 &gt; m_usecaseMaxFPS)</span><br><span class="line">            &#123;</span><br><span class="line">                m_CurrentpowerHint = PERF_LOCK_POWER_HINT_VIDEO_ENCODE_HFR;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                // For 480FPS or higher, require more aggresive power hint</span><br><span class="line">                m_CurrentpowerHint = PERF_LOCK_POWER_HINT_VIDEO_ENCODE_HFR_480FPS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            // Not a HFR usecase, batch frames value need to be set to 1.</span><br><span class="line">            m_usecaseNumBatchedFrames = 1;</span><br><span class="line">            m_HALOutputBufferCombined = FALSE;</span><br><span class="line">            if (maxSessionFps == 0)</span><br><span class="line">            &#123;</span><br><span class="line">                m_usecaseMaxFPS = fps;</span><br><span class="line">            &#125;</span><br><span class="line">            if (TRUE == isVideoMode)</span><br><span class="line">            &#123;</span><br><span class="line">                if (30 &gt;= m_usecaseMaxFPS)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_CurrentpowerHint = PERF_LOCK_POWER_HINT_VIDEO_ENCODE;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    m_CurrentpowerHint = PERF_LOCK_POWER_HINT_VIDEO_ENCODE_60FPS;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_CurrentpowerHint = PERF_LOCK_POWER_HINT_PREVIEW;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ((NULL != m_pPerfLockManager[logicalCameraId]) &amp;&amp; (m_CurrentpowerHint != m_previousPowerHint))</span><br><span class="line">        &#123;</span><br><span class="line">            m_pPerfLockManager[logicalCameraId]-&gt;ReleasePerfLock(m_previousPowerHint);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Example [B == batch]: (240 FPS / 4 FPB = 60 BPS) / 30 FPS (Stats frequency goal) = 2 BPF i.e. skip every other stats</span><br><span class="line">        *m_pStatsSkipPattern = m_usecaseMaxFPS / m_usecaseNumBatchedFrames / 30;</span><br><span class="line">        if (*m_pStatsSkipPattern &lt; 1)</span><br><span class="line">        &#123;</span><br><span class="line">            *m_pStatsSkipPattern = 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_VideoHDRMode = (StreamConfigModeVideoHdr == pStreamConfig-&gt;operation_mode);</span><br><span class="line"></span><br><span class="line">        m_torchWidgetUsecase = (StreamConfigModeQTITorchWidget == pStreamConfig-&gt;operation_mode);</span><br><span class="line"></span><br><span class="line">        // this check is introduced to avoid set *m_pEnableFOVC == 1 if fovcEnable is disabled in</span><br><span class="line">        // overridesettings &amp; fovc bit is set in operation mode.</span><br><span class="line">        // as well as to avoid set,when we switch Usecases.</span><br><span class="line">        if (TRUE == fovcModeCheck)</span><br><span class="line">        &#123;</span><br><span class="line">            *m_pEnableFOVC = ((pStreamConfig-&gt;operation_mode &amp; StreamConfigModeQTIFOVC) == StreamConfigModeQTIFOVC) ? 1 : 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SetHALOps(logicalCameraId, chiHalOps);</span><br><span class="line"></span><br><span class="line">        m_logicalCameraInfo[logicalCameraId].m_pCamera3Device = pCamera3Device;</span><br><span class="line"></span><br><span class="line">        selectedUsecaseId = m_pUsecaseSelector-&gt;GetMatchingUsecase(&amp;m_logicalCameraInfo[logicalCameraId],</span><br><span class="line">                                                                   pStreamConfig);</span><br><span class="line"></span><br><span class="line">        CHX_LOG_CONFIG(&quot;Session_parameters FPS range %d:%d, previewFPS %d, videoFPS %d &quot;</span><br><span class="line">                       &quot;BatchSize: %u HALOutputBufferCombined %d FPS: %u SkipPattern: %u, &quot;</span><br><span class="line">                       &quot;cameraId = %d selected use case = %d&quot;,</span><br><span class="line">                       minSessionFps,</span><br><span class="line">                       maxSessionFps,</span><br><span class="line">                       m_previewFPS,</span><br><span class="line">                       m_videoFPS,</span><br><span class="line">                       m_usecaseNumBatchedFrames,</span><br><span class="line">                       m_HALOutputBufferCombined,</span><br><span class="line">                       m_usecaseMaxFPS,</span><br><span class="line">                       *m_pStatsSkipPattern,</span><br><span class="line">                       logicalCameraId,</span><br><span class="line">                       selectedUsecaseId);</span><br><span class="line"></span><br><span class="line">        // FastShutter mode supported only in ZSL usecase.</span><br><span class="line">        if ((pStreamConfig-&gt;operation_mode == StreamConfigModeFastShutter) &amp;&amp;</span><br><span class="line">            (UsecaseId::PreviewZSL         != selectedUsecaseId))</span><br><span class="line">        &#123;</span><br><span class="line">            pStreamConfig-&gt;operation_mode = StreamConfigModeNormal;</span><br><span class="line">        &#125;</span><br><span class="line">        m_operationMode[logicalCameraId] = pStreamConfig-&gt;operation_mode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (m_pBLMClient != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        blmParams.numcamera         = m_logicalCameraInfo[logicalCameraId].numPhysicalCameras;</span><br><span class="line">        blmParams.logicalCameraType = m_logicalCameraInfo[logicalCameraId].logicalCameraType;</span><br><span class="line">        blmParams.FPS               = m_usecaseMaxFPS;</span><br><span class="line">        blmParams.selectedusecaseId = selectedUsecaseId;</span><br><span class="line">        blmParams.socId             = GetPlatformID();</span><br><span class="line">        blmParams.isVideoMode       = isVideoMode;</span><br><span class="line"></span><br><span class="line">        m_pBLMClient-&gt;SetUsecaseBwLevel(blmParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (UsecaseId::NoMatch != selectedUsecaseId)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pStreamConfig[logicalCameraId] = static_cast&lt;camera3_stream_configuration_t*&gt;(</span><br><span class="line">            CHX_CALLOC(sizeof(camera3_stream_configuration_t)));</span><br><span class="line">        m_pStreamConfig[logicalCameraId]-&gt;streams = static_cast&lt;camera3_stream_t**&gt;(</span><br><span class="line">            CHX_CALLOC(sizeof(camera3_stream_t*) * pStreamConfig-&gt;num_streams));</span><br><span class="line">        m_pStreamConfig[logicalCameraId]-&gt;num_streams = pStreamConfig-&gt;num_streams;</span><br><span class="line"></span><br><span class="line">        for (UINT32 i = 0; i&lt; m_pStreamConfig[logicalCameraId]-&gt;num_streams; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            m_pStreamConfig[logicalCameraId]-&gt;streams[i] = pStreamConfig-&gt;streams[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pStreamConfig[logicalCameraId]-&gt;operation_mode = pStreamConfig-&gt;operation_mode;</span><br><span class="line"></span><br><span class="line">        if (NULL != pStreamConfig-&gt;session_parameters)</span><br><span class="line">        &#123;</span><br><span class="line">            m_pStreamConfig[logicalCameraId]-&gt;session_parameters =</span><br><span class="line">                (const camera_metadata_t *)allocate_copy_camera_metadata_checked(</span><br><span class="line">                pStreamConfig-&gt;session_parameters,</span><br><span class="line">                get_camera_metadata_size(pStreamConfig-&gt;session_parameters));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pSelectedUsecase[logicalCameraId] =</span><br><span class="line">            m_pUsecaseFactory-&gt;CreateUsecaseObject(&amp;m_logicalCameraInfo[logicalCameraId],</span><br><span class="line">                                                   selectedUsecaseId, m_pStreamConfig[logicalCameraId]);</span><br><span class="line"></span><br><span class="line">        if (NULL != m_pSelectedUsecase[logicalCameraId])</span><br><span class="line">        &#123;</span><br><span class="line">            // use camera device / used for recovery only for regular session</span><br><span class="line">            m_SelectedUsecaseId[logicalCameraId] = (UINT32)selectedUsecaseId;</span><br><span class="line">            CHX_LOG_CONFIG(&quot;Logical cam Id = %d usecase addr = %p&quot;, logicalCameraId, m_pSelectedUsecase[</span><br><span class="line">                logicalCameraId]);</span><br><span class="line"></span><br><span class="line">            m_pCameraDeviceInfo[logicalCameraId].m_pCamera3Device = pCamera3Device;</span><br><span class="line"></span><br><span class="line">            *pIsOverrideEnabled = TRUE;</span><br><span class="line"></span><br><span class="line">            m_TeardownInProgress[logicalCameraId]      = FALSE;</span><br><span class="line">            m_RecoveryInProgress[logicalCameraId]      = FALSE;</span><br><span class="line">            m_terminateRecoveryThread[logicalCameraId] = FALSE;</span><br><span class="line"></span><br><span class="line">            m_pPCRLock[logicalCameraId]                  = Mutex::Create();</span><br><span class="line">            m_pDestroyLock[logicalCameraId]              = Mutex::Create();</span><br><span class="line">            m_pRecoveryLock[logicalCameraId]             = Mutex::Create();</span><br><span class="line">            m_pTriggerRecoveryLock[logicalCameraId]      = Mutex::Create();</span><br><span class="line">            m_pTriggerRecoveryCondition[logicalCameraId] = Condition::Create();</span><br><span class="line">            m_pRecoveryCondition[logicalCameraId]        = Condition::Create();</span><br><span class="line">            m_recoveryThreadPrivateData[logicalCameraId] = &#123; logicalCameraId, this &#125;;</span><br><span class="line"></span><br><span class="line">            // Create recovery thread and wait on being signaled</span><br><span class="line">            m_pRecoveryThread[logicalCameraId].pPrivateData = &amp;m_recoveryThreadPrivateData[logicalCameraId];</span><br><span class="line"></span><br><span class="line">            result = ChxUtils::ThreadCreate(ExtensionModule::RecoveryThread,</span><br><span class="line">                &amp;m_pRecoveryThread[logicalCameraId],</span><br><span class="line">                &amp;m_pRecoveryThread[logicalCameraId].hThreadHandle);</span><br><span class="line">            if (CDKResultSuccess != result)</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_ERROR(&quot;Failed to create recovery thread for logical camera %d result %d&quot;, logicalCameraId, result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;For cameraId = %d CreateUsecaseObject failed&quot;, logicalCameraId);</span><br><span class="line">            m_logicalCameraInfo[logicalCameraId].m_pCamera3Device = NULL;</span><br><span class="line"></span><br><span class="line">            // Free m_pStreamConfig</span><br><span class="line">            if (NULL != m_pStreamConfig[logicalCameraId])</span><br><span class="line">            &#123;</span><br><span class="line">                if (NULL != m_pStreamConfig[logicalCameraId]-&gt;streams)</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_FREE(m_pStreamConfig[logicalCameraId]-&gt;streams);</span><br><span class="line">                    m_pStreamConfig[logicalCameraId]-&gt;streams = NULL;</span><br><span class="line">                &#125;</span><br><span class="line">                if (NULL != m_pStreamConfig[logicalCameraId]-&gt;session_parameters)</span><br><span class="line">                &#123;</span><br><span class="line">                    free_camera_metadata(const_cast&lt;camera_metadata_t*&gt;(m_pStreamConfig[logicalCameraId]-&gt;session_parameters));</span><br><span class="line">                    m_pStreamConfig[logicalCameraId]-&gt;session_parameters = NULL;</span><br><span class="line">                &#125;</span><br><span class="line">                CHX_FREE(m_pStreamConfig[logicalCameraId]);</span><br><span class="line">                m_pStreamConfig[logicalCameraId] = NULL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((CDKResultSuccess != result) || (UsecaseId::Torch == selectedUsecaseId))</span><br><span class="line">    &#123;</span><br><span class="line">        // reset resource count in failure case or Torch case</span><br><span class="line">        ResetResourceCost(m_logicalCameraInfo[logicalCameraId].cameraId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHX_LOG_INFO(&quot; logicalCameraId = %d, m_totalResourceBudget = %d, activeResourseCost = %d, m_IFEResourceCost = %d&quot;,</span><br><span class="line">            logicalCameraId, m_totalResourceBudget, GetActiveResourceCost(), m_IFEResourceCost[logicalCameraId]);</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断是否是视频模式，做帧率的操作； 根据logicalCameraId 匹配 usecase，根据usecaseId 创建usecase。</p>
<h4 id="4-3-2-GetMatchingUsecase"><a href="#4-3-2-GetMatchingUsecase" class="headerlink" title="4.3.2 GetMatchingUsecase"></a>4.3.2 GetMatchingUsecase</h4><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiusecase\chxusecaseutils.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">UsecaseId UsecaseSelector::GetMatchingUsecase(</span><br><span class="line">    const LogicalCameraInfo*        pCamInfo,</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfig)</span><br><span class="line">&#123;</span><br><span class="line">    UsecaseId usecaseId = UsecaseId::Default;</span><br><span class="line">    UINT32 VRDCEnable = ExtensionModule::GetInstance()-&gt;GetDCVRMode();</span><br><span class="line">    if ((pStreamConfig-&gt;num_streams == 2) &amp;&amp; IsQuadCFASensor(pCamInfo, NULL) &amp;&amp;</span><br><span class="line">        (LogicalCameraType_Default == pCamInfo-&gt;logicalCameraType))</span><br><span class="line">    &#123;</span><br><span class="line">        // need to validate preview size &lt;= binning size, otherwise return error</span><br><span class="line"></span><br><span class="line">        /// If snapshot size is less than sensor binning size, select defaut zsl usecase.</span><br><span class="line">        /// Only if snapshot size is larger than sensor binning size, select QuadCFA usecase.</span><br><span class="line">        /// Which means for snapshot in QuadCFA usecase,</span><br><span class="line">        ///   - either do upscale from sensor binning size,</span><br><span class="line">        ///   - or change sensor mode to full size quadra mode.</span><br><span class="line">        if (TRUE == QuadCFAMatchingUsecase(pCamInfo, pStreamConfig))</span><br><span class="line">        &#123;</span><br><span class="line">            usecaseId = UsecaseId::QuadCFA;</span><br><span class="line">            CHX_LOG_CONFIG(&quot;Quad CFA usecase selected&quot;);</span><br><span class="line">            return usecaseId;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pStreamConfig-&gt;operation_mode == StreamConfigModeSuperSlowMotionFRC)</span><br><span class="line">    &#123;</span><br><span class="line">        usecaseId = UsecaseId::SuperSlowMotionFRC;</span><br><span class="line">        CHX_LOG_CONFIG(&quot;SuperSlowMotionFRC usecase selected&quot;);</span><br><span class="line">        return usecaseId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// Reset the usecase flags</span><br><span class="line">    VideoEISV2Usecase   = 0;</span><br><span class="line">    VideoEISV3Usecase   = 0;</span><br><span class="line">    GPURotationUsecase  = FALSE;</span><br><span class="line">    GPUDownscaleUsecase = FALSE;</span><br><span class="line">    CHX_LOG_CONFIG(&quot;numPhysicalCameras: %d, logicalCameraType: %d&quot;,</span><br><span class="line">        pCamInfo-&gt;numPhysicalCameras, pCamInfo-&gt;logicalCameraType);</span><br><span class="line"></span><br><span class="line">    CHX_LOG_CONFIG(&quot;AIDirectorEnable = %d pStreamConfig-&gt;num_streams %d&quot;, ExtensionModule::GetInstance()-&gt;EnableAIDirector(), pStreamConfig-&gt;num_streams);</span><br><span class="line"></span><br><span class="line">    if ((NULL != pCamInfo) &amp;&amp; (pCamInfo-&gt;numPhysicalCameras &gt; 1) &amp;&amp; VRDCEnable)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_CONFIG(&quot;MultiCameraVR usecase selected&quot;);</span><br><span class="line">        usecaseId = UsecaseId::MultiCameraVR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else if ((NULL != pCamInfo) &amp;&amp; (pCamInfo-&gt;numPhysicalCameras &gt; 1) &amp;&amp;</span><br><span class="line">        (pStreamConfig-&gt;num_streams &gt; 1 || pCamInfo-&gt;logicalCameraType == LogicalCameraType_SAT))</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_CONFIG(&quot;MultiCamera usecase selected&quot;);</span><br><span class="line">        usecaseId = UsecaseId::MultiCamera;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_CONFIG(&quot;default usecase selected&quot;);</span><br><span class="line">        SnapshotStreamConfig snapshotStreamConfig;</span><br><span class="line">        CHISTREAM**          ppChiStreams = reinterpret_cast&lt;CHISTREAM**&gt;(pStreamConfig-&gt;streams);</span><br><span class="line">        switch (pStreamConfig-&gt;num_streams)</span><br><span class="line">        &#123;</span><br><span class="line">            case 2:</span><br><span class="line">                if (TRUE == IsRawJPEGStreamConfig(pStreamConfig))</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;Raw + JPEG usecase selected&quot;);</span><br><span class="line">                    usecaseId = UsecaseId::RawJPEG;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                /// @todo Enable ZSL by setting overrideDisableZSL to FALSE</span><br><span class="line">                /// @todo Because lt6911uxc can not be compatible with ZSL at prsent,</span><br><span class="line">                ///       this is workaround to disable ZSL for lt6911uxc.</span><br><span class="line">                if (FALSE == m_pExtModule-&gt;DisableZSL() &amp;&amp; strcmp(&quot;lt6911uxc&quot;,pCamInfo-&gt;m_cameraCaps.sensorCaps.pSensorName))</span><br><span class="line">                &#123;</span><br><span class="line">                    if (TRUE == IsPreviewZSLStreamConfig(pStreamConfig))</span><br><span class="line">                    &#123;</span><br><span class="line">                        usecaseId = UsecaseId::PreviewZSL;</span><br><span class="line">                        CHX_LOG_CONFIG(&quot;ZSL usecase selected&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if(TRUE == m_pExtModule-&gt;UseGPURotationUsecase())</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;GPU Rotation usecase flag set&quot;);</span><br><span class="line">                    GPURotationUsecase = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TRUE == m_pExtModule-&gt;UseGPUDownscaleUsecase())</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;GPU Downscale usecase flag set&quot;);</span><br><span class="line">                    GPUDownscaleUsecase = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TRUE == m_pExtModule-&gt;EnableMFNRUsecase())</span><br><span class="line">                &#123;</span><br><span class="line">                    if (TRUE == MFNRMatchingUsecase(pStreamConfig))</span><br><span class="line">                    &#123;</span><br><span class="line">                        usecaseId = UsecaseId::MFNR;</span><br><span class="line">                        CHX_LOG_CONFIG(&quot;MFNR usecase selected&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TRUE == m_pExtModule-&gt;EnableHFRNo3AUsecas())</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;HFR without 3A usecase flag set&quot;);</span><br><span class="line">                    HFRNo3AUsecase = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 3:</span><br><span class="line">                VideoEISV2Usecase = m_pExtModule-&gt;EnableEISV2Usecase();</span><br><span class="line">                VideoEISV3Usecase = m_pExtModule-&gt;EnableEISV3Usecase();</span><br><span class="line">                if (FALSE == m_pExtModule-&gt;DisableZSL() &amp;&amp; (TRUE == IsPreviewZSLStreamConfig(pStreamConfig)))</span><br><span class="line">                &#123;</span><br><span class="line">                    usecaseId = UsecaseId::PreviewZSL;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;ZSL usecase selected&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                else if(TRUE == IsRawJPEGStreamConfig(pStreamConfig))</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;Raw + JPEG usecase selected&quot;);</span><br><span class="line">                    usecaseId = UsecaseId::RawJPEG;</span><br><span class="line">                &#125;</span><br><span class="line">                else if((FALSE == IsVideoEISV2Enabled(pStreamConfig)) &amp;&amp; (FALSE == IsVideoEISV3Enabled(pStreamConfig)) &amp;&amp;</span><br><span class="line">                    (TRUE == IsVideoLiveShotConfig(pStreamConfig)) &amp;&amp; (FALSE == m_pExtModule-&gt;DisableZSL()))</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;Video With Liveshot, ZSL usecase selected&quot;);</span><br><span class="line">                    usecaseId = UsecaseId::VideoLiveShot;</span><br><span class="line">                &#125;</span><br><span class="line">                // Because LT6911 don&apos;t support ZSL.</span><br><span class="line">                if (!strcmp(&quot;lt6911uxc&quot;,pCamInfo-&gt;m_cameraCaps.sensorCaps.pSensorName))</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;Specific case for LT6911&quot;);</span><br><span class="line">                    usecaseId = UsecaseId::Default;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case 4:</span><br><span class="line">                GetSnapshotStreamConfiguration(pStreamConfig-&gt;num_streams, ppChiStreams, snapshotStreamConfig);</span><br><span class="line">                if ((SnapshotStreamType::HEIC == snapshotStreamConfig.type) &amp;&amp; (NULL != snapshotStreamConfig.pRawStream))</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_CONFIG(&quot;Raw + HEIC usecase selected&quot;);</span><br><span class="line">                    usecaseId = UsecaseId::RawJPEG;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            default:</span><br><span class="line">                CHX_LOG_CONFIG(&quot;Default usecase selected&quot;);</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (TRUE == ExtensionModule::GetInstance()-&gt;IsTorchWidgetUsecase())</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_CONFIG(&quot;Torch widget usecase selected&quot;);</span><br><span class="line">        usecaseId = UsecaseId::Torch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHX_LOG_INFO(&quot;usecase ID:%d&quot;,usecaseId);</span><br><span class="line">    return usecaseId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据 stream_number、operation_mode、numPhysicalCameras来判断选择哪个usecaseId</p>
<h5 id="4-3-2-1-CreateUsecaseObject"><a href="#4-3-2-1-CreateUsecaseObject" class="headerlink" title="4.3.2.1 CreateUsecaseObject"></a>4.3.2.1 CreateUsecaseObject</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiusecase\chxusecaseutils.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// UsecaseFactory::CreateUsecaseObject</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">Usecase* UsecaseFactory::CreateUsecaseObject(</span><br><span class="line">    LogicalCameraInfo*              pLogicalCameraInfo,     ///&lt; camera info</span><br><span class="line">    UsecaseId                       usecaseId,              ///&lt; Usecase Id</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfig)          ///&lt; Stream config</span><br><span class="line">&#123;</span><br><span class="line">    Usecase* pUsecase  = NULL;</span><br><span class="line">    UINT     camera0Id = pLogicalCameraInfo-&gt;ppDeviceInfo[0]-&gt;cameraId;</span><br><span class="line"></span><br><span class="line">    switch (usecaseId)</span><br><span class="line">    &#123;</span><br><span class="line">        case UsecaseId::PreviewZSL:</span><br><span class="line">        case UsecaseId::VideoLiveShot:</span><br><span class="line">            pUsecase = AdvancedCameraUsecase::Create(pLogicalCameraInfo, pStreamConfig, usecaseId);</span><br><span class="line">            break;</span><br><span class="line">        case UsecaseId::MultiCamera:</span><br><span class="line">            &#123;</span><br><span class="line">#if defined(CAMX_ANDROID_API) &amp;&amp; (CAMX_ANDROID_API &gt;= 28) //Android-P or better</span><br><span class="line"></span><br><span class="line">                LogicalCameraType logicalCameraType = m_pExtModule-&gt;GetCameraType(pLogicalCameraInfo-&gt;cameraId);</span><br><span class="line"></span><br><span class="line">                if (LogicalCameraType_DualApp == logicalCameraType)</span><br><span class="line">                &#123;</span><br><span class="line">                    pUsecase = UsecaseDualCamera::Create(pLogicalCameraInfo, pStreamConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">#endif</span><br><span class="line">                &#123;</span><br><span class="line">                    pUsecase = UsecaseMultiCamera::Create(pLogicalCameraInfo, pStreamConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        case UsecaseId::MultiCameraVR:</span><br><span class="line">            //pUsecase = UsecaseMultiVRCamera::Create(pLogicalCameraInfo, pStreamConfig);</span><br><span class="line">            break;</span><br><span class="line">        case UsecaseId::QuadCFA:</span><br><span class="line">            pUsecase = AdvancedCameraUsecase::Create(pLogicalCameraInfo, pStreamConfig, usecaseId);</span><br><span class="line">            break;</span><br><span class="line">        case UsecaseId::Torch:</span><br><span class="line">            pUsecase = UsecaseTorch::Create(pLogicalCameraInfo, pStreamConfig);</span><br><span class="line">            break;</span><br><span class="line">#if (!defined(LE_CAMERA)) // SuperSlowMotion not supported in LE</span><br><span class="line">        case UsecaseId::SuperSlowMotionFRC:</span><br><span class="line">            pUsecase = UsecaseSuperSlowMotionFRC::Create(pLogicalCameraInfo, pStreamConfig);</span><br><span class="line">            break;</span><br><span class="line">#endif</span><br><span class="line">        default:</span><br><span class="line">            pUsecase = AdvancedCameraUsecase::Create(pLogicalCameraInfo, pStreamConfig, usecaseId);</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pUsecase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据usecaseId选择，创建不同的usecase（AdvancedCameraUsecase ：ZSL、VideoLiveShot，UsecaseDualCamera：双摄，UsecaseMultiCamera：多摄，UsecaseQuadCFA：四合一、九合一处理，UsecaseTorch：闪光灯模式，UsecaseSuperSlowMotionFRC：慢动作）。</p>
<h5 id="4-3-2-2-AdvancedCameraUsecase-Create"><a href="#4-3-2-2-AdvancedCameraUsecase-Create" class="headerlink" title="4.3.2.2 AdvancedCameraUsecase::Create"></a>4.3.2.2 AdvancedCameraUsecase::Create</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiusecase\chxadvancedcamerausecase.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// AdvancedCameraUsecase::Create</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">AdvancedCameraUsecase* AdvancedCameraUsecase::Create(</span><br><span class="line">    LogicalCameraInfo*              pCameraInfo,   ///&lt; Camera info</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfig, ///&lt; Stream configuration</span><br><span class="line">    UsecaseId                       usecaseId)     ///&lt; Identifier for usecase function</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult              result                 = CDKResultSuccess;</span><br><span class="line">    AdvancedCameraUsecase* pAdvancedCameraUsecase = CHX_NEW AdvancedCameraUsecase;</span><br><span class="line"></span><br><span class="line">    if ((NULL != pAdvancedCameraUsecase) &amp;&amp; (NULL != pStreamConfig))</span><br><span class="line">    &#123;</span><br><span class="line">        result = pAdvancedCameraUsecase-&gt;Initialize(pCameraInfo, pStreamConfig, usecaseId);</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            pAdvancedCameraUsecase-&gt;Destroy(FALSE);</span><br><span class="line">            pAdvancedCameraUsecase = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        result = CDKResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pAdvancedCameraUsecase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-2-3-AdvancedCameraUsecase-Initialize"><a href="#4-3-2-3-AdvancedCameraUsecase-Initialize" class="headerlink" title="4.3.2.3 AdvancedCameraUsecase::Initialize"></a>4.3.2.3 AdvancedCameraUsecase::Initialize</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// AdvancedCameraUsecase::Initialize</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult AdvancedCameraUsecase::Initialize(</span><br><span class="line">    LogicalCameraInfo*              pCameraInfo,   ///&lt; Camera info</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfig, ///&lt; Stream configuration</span><br><span class="line">    UsecaseId                       usecaseId)     ///&lt; Identifier for the usecase function</span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_BEGIN(&quot;AdvancedCameraUsecase::Initialize&quot;);</span><br><span class="line">    CDKResult result = CDKResultSuccess;</span><br><span class="line"></span><br><span class="line">    m_usecaseId                     = usecaseId;</span><br><span class="line">    m_cameraId                      = pCameraInfo-&gt;cameraId;</span><br><span class="line">    m_pLogicalCameraInfo            = pCameraInfo;</span><br><span class="line"></span><br><span class="line">    m_pResultMutex                  = Mutex::Create();</span><br><span class="line">    m_pSetFeatureMutex              = Mutex::Create();</span><br><span class="line">    m_pRealtimeReconfigDoneMutex    = Mutex::Create();</span><br><span class="line">    m_isReprocessUsecase            = FALSE;</span><br><span class="line">    m_numOfPhysicalDevices          = pCameraInfo-&gt;numPhysicalCameras;</span><br><span class="line">    m_isUsecaseCloned               = FALSE;</span><br><span class="line">    m_numPCRsBeforeStreamOn         = ExtensionModule::GetInstance()-&gt;GetNumPCRsBeforeStreamOn(m_cameraId);</span><br><span class="line"></span><br><span class="line">    for (UINT32 i = 0 ; i &lt; m_numOfPhysicalDevices; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_cameraIdMap[i] = pCameraInfo-&gt;ppDeviceInfo[i]-&gt;cameraId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ExtensionModule::GetInstance()-&gt;GetVendorTagOps(&amp;m_vendorTagOps);</span><br><span class="line">    CHX_LOG(&quot;pGetMetaData:%p, pSetMetaData:%p&quot;, m_vendorTagOps.pGetMetaData, m_vendorTagOps.pSetMetaData);</span><br><span class="line">    //获取XML文件中Usecase配置信息</span><br><span class="line">    pAdvancedUsecase = GetXMLUsecaseByName(ZSL_USECASE_NAME);</span><br><span class="line"></span><br><span class="line">    if (NULL == pAdvancedUsecase)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_ERROR(&quot;Fail to get ZSL usecase from XML!&quot;);</span><br><span class="line">        result = CDKResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ChxUtils::Memset(m_enabledFeatures, 0, sizeof(m_enabledFeatures));</span><br><span class="line">    ChxUtils::Memset(m_rejectedSnapshotRequestList, 0, sizeof(m_rejectedSnapshotRequestList));</span><br><span class="line"></span><br><span class="line">    if (TRUE == IsMultiCameraUsecase())</span><br><span class="line">    &#123;</span><br><span class="line">        m_isRdiStreamImported   = TRUE;</span><br><span class="line">        m_isFdStreamImported    = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        m_isRdiStreamImported   = FALSE;</span><br><span class="line">        m_isFdStreamImported    = FALSE;</span><br><span class="line">        m_inputOutputType       = static_cast&lt;UINT32&gt;(InputOutputType::NO_SPECIAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (UINT32 i = 0; i &lt; m_numOfPhysicalDevices; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        if (FALSE == m_isRdiStreamImported)</span><br><span class="line">        &#123;</span><br><span class="line">            m_pRdiStream[i] = static_cast&lt;CHISTREAM*&gt;(CHX_CALLOC(sizeof(CHISTREAM)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (FALSE == m_isFdStreamImported)</span><br><span class="line">        &#123;</span><br><span class="line">            m_pFdStream[i]  = static_cast&lt;CHISTREAM*&gt;(CHX_CALLOC(sizeof(CHISTREAM)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pBayer2YuvStream[i] = static_cast&lt;CHISTREAM*&gt;(CHX_CALLOC(sizeof(CHISTREAM)));</span><br><span class="line">        m_pJPEGInputStream[i] = static_cast&lt;CHISTREAM*&gt;(CHX_CALLOC(sizeof(CHISTREAM)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (UINT32 i = 0; i &lt; MaxPipelines; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pipelineToSession[i] = InvalidSessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_realtimeSessionId = static_cast&lt;UINT32&gt;(InvalidSessionId);</span><br><span class="line"></span><br><span class="line">    if (NULL == pStreamConfig)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_ERROR(&quot;pStreamConfig is NULL&quot;);</span><br><span class="line">        result = CDKResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CDKResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_INFO(&quot;AdvancedCameraUsecase::Initialize usecaseId:%d num_streams:%d&quot;, m_usecaseId, pStreamConfig-&gt;num_streams);</span><br><span class="line">        CHX_LOG_INFO(&quot;CHI Input Stream Configs:&quot;);</span><br><span class="line">        for (UINT stream = 0; stream &lt; pStreamConfig-&gt;num_streams; stream++)</span><br><span class="line">        &#123;</span><br><span class="line">             CHX_LOG_INFO(&quot;\tstream = %p streamType = %d streamFormat = %d streamWidth = %d streamHeight = %d&quot;,</span><br><span class="line">                          pStreamConfig-&gt;streams[stream],</span><br><span class="line">                          pStreamConfig-&gt;streams[stream]-&gt;stream_type,</span><br><span class="line">                          pStreamConfig-&gt;streams[stream]-&gt;format,</span><br><span class="line">                          pStreamConfig-&gt;streams[stream]-&gt;width,</span><br><span class="line">                          pStreamConfig-&gt;streams[stream]-&gt;height);</span><br><span class="line"></span><br><span class="line">             if (CAMERA3_STREAM_INPUT == pStreamConfig-&gt;streams[stream]-&gt;stream_type)</span><br><span class="line">             &#123;</span><br><span class="line">                 CHX_LOG_INFO(&quot;Reprocess usecase&quot;);</span><br><span class="line">                 m_isReprocessUsecase = TRUE;</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        result = CreateMetadataManager(m_cameraId, false, NULL, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Default sensor mode pick hint</span><br><span class="line">    m_defaultSensorModePickHint.sensorModeCaps.value    = 0;</span><br><span class="line">    m_defaultSensorModePickHint.postSensorUpscale       = FALSE;</span><br><span class="line">    m_defaultSensorModePickHint.sensorModeCaps.u.Normal = TRUE;</span><br><span class="line"></span><br><span class="line">    if (TRUE == IsQuadCFAUsecase() &amp;&amp; (CDKResultSuccess == result))</span><br><span class="line">    &#123;</span><br><span class="line">        CHIDIMENSION binningSize = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">        // get binning mode sensor output size,</span><br><span class="line">        // if more than one binning mode, choose the largest one</span><br><span class="line">        for (UINT i = 0; i &lt; pCameraInfo-&gt;m_cameraCaps.numSensorModes; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG(&quot;i:%d, sensor mode:%d, size:%dx%d&quot;,</span><br><span class="line">                i, pCameraInfo-&gt;pSensorModeInfo[i].sensorModeCaps.value,</span><br><span class="line">                pCameraInfo-&gt;pSensorModeInfo[i].frameDimension.width,</span><br><span class="line">                pCameraInfo-&gt;pSensorModeInfo[i].frameDimension.height);</span><br><span class="line"></span><br><span class="line">            if (1 == pCameraInfo-&gt;pSensorModeInfo[i].sensorModeCaps.u.Normal)</span><br><span class="line">            &#123;</span><br><span class="line">                if ((pCameraInfo-&gt;pSensorModeInfo[i].frameDimension.width  &gt; binningSize.width) ||</span><br><span class="line">                    (pCameraInfo-&gt;pSensorModeInfo[i].frameDimension.height &gt; binningSize.height))</span><br><span class="line">                &#123;</span><br><span class="line">                    binningSize.width  = pCameraInfo-&gt;pSensorModeInfo[i].frameDimension.width;</span><br><span class="line">                    binningSize.height = pCameraInfo-&gt;pSensorModeInfo[i].frameDimension.height;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CHX_LOG(&quot;sensor binning mode size:%dx%d&quot;, binningSize.width, binningSize.height);</span><br><span class="line"></span><br><span class="line">        // For Quad CFA sensor, should use binning mode for preview.</span><br><span class="line">        // So set postSensorUpscale flag here to allow sensor pick binning sensor mode.</span><br><span class="line">        m_QuadCFASensorInfo.sensorModePickHint.sensorModeCaps.value    = 0;</span><br><span class="line">        m_QuadCFASensorInfo.sensorModePickHint.postSensorUpscale       = TRUE;</span><br><span class="line">        m_QuadCFASensorInfo.sensorModePickHint.sensorModeCaps.u.Normal = TRUE;</span><br><span class="line">        m_QuadCFASensorInfo.sensorModePickHint.sensorOutputSize.width  = binningSize.width;</span><br><span class="line">        m_QuadCFASensorInfo.sensorModePickHint.sensorOutputSize.height = binningSize.height;</span><br><span class="line"></span><br><span class="line">        // For Quad CFA usecase, should use full size mode for snapshot.</span><br><span class="line">        m_defaultSensorModePickHint.sensorModeCaps.value               = 0;</span><br><span class="line">        m_defaultSensorModePickHint.postSensorUpscale                  = FALSE;</span><br><span class="line">        m_defaultSensorModePickHint.sensorModeCaps.u.QuadCFA           = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (ExtensionModule::GetInstance()-&gt;IsHDMICamera(m_cameraId))</span><br><span class="line">    &#123;</span><br><span class="line">        m_defaultSensorModePickHint.sensorModeCaps.value               = 0;</span><br><span class="line">        m_defaultSensorModePickHint.sensorModeCaps.u.HDMI              = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if (CDKResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        //创建Feature</span><br><span class="line">        FeatureSetup(pStreamConfig);</span><br><span class="line">        //根据流配置和camera_info重新配置usecase</span><br><span class="line">        result = SelectUsecaseConfig(pCameraInfo, pStreamConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((NULL != m_pChiUsecase) &amp;&amp; (CDKResultSuccess == result) &amp;&amp; (NULL != m_pPipelineToCamera))</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_INFO(&quot;Usecase %s selected&quot;, m_pChiUsecase-&gt;pUsecaseName);</span><br><span class="line"></span><br><span class="line">        m_pCallbacks = static_cast&lt;ChiCallBacks*&gt;(CHX_CALLOC(sizeof(ChiCallBacks) * m_pChiUsecase-&gt;numPipelines));</span><br><span class="line"></span><br><span class="line">        CHX_LOG_INFO(&quot;Pipelines need to create in advance usecase:%d&quot;, m_pChiUsecase-&gt;numPipelines);</span><br><span class="line">        for (UINT i = 0; i &lt; m_pChiUsecase-&gt;numPipelines; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_INFO(&quot;[%d/%d], pipeline name:%s, pipeline type:%d, session id:%d, camera id:%d&quot;,</span><br><span class="line">                          i,</span><br><span class="line">                          m_pChiUsecase-&gt;numPipelines,</span><br><span class="line">                          m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pPipelineName,</span><br><span class="line">                          GetAdvancedPipelineTypeByPipelineId(i),</span><br><span class="line">                          (NULL != m_pPipelineToSession) ? m_pPipelineToSession[i] : i,</span><br><span class="line">                          m_pPipelineToCamera[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (NULL != m_pCallbacks)</span><br><span class="line">        &#123;</span><br><span class="line">            for (UINT i = 0; i &lt; m_pChiUsecase-&gt;numPipelines; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                m_pCallbacks[i].ChiNotify                      = AdvancedCameraUsecase::ProcessMessageCb;</span><br><span class="line">                m_pCallbacks[i].ChiProcessCaptureResult        = AdvancedCameraUsecase::ProcessResultCb;</span><br><span class="line">                m_pCallbacks[i].ChiProcessPartialCaptureResult = AdvancedCameraUsecase::ProcessDriverPartialCaptureResultCb;</span><br><span class="line">            &#125;</span><br><span class="line">            //调用父类CameraUsecaseBase的initialize方法，进行一些常规初始化工作</span><br><span class="line">            result = CameraUsecaseBase::Initialize(m_pCallbacks, pStreamConfig);</span><br><span class="line"></span><br><span class="line">            for (UINT index = 0; index &lt; m_pChiUsecase-&gt;numPipelines; ++index)</span><br><span class="line">            &#123;</span><br><span class="line">                INT32  pipelineType = GET_PIPELINE_TYPE_BY_ID(m_pipelineStatus[index].pipelineId);</span><br><span class="line">                UINT32 rtIndex      = GET_FEATURE_INSTANCE_BY_ID(m_pipelineStatus[index].pipelineId);</span><br><span class="line"></span><br><span class="line">                if (CDKInvalidId == m_metadataClients[index])</span><br><span class="line">                &#123;</span><br><span class="line">                    result = CDKResultEFailed;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if ((rtIndex &lt; MaxRealTimePipelines) &amp;&amp; (pipelineType &lt; AdvancedPipelineType::PipelineCount))</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pipelineToClient[rtIndex][pipelineType] = m_metadataClients[index];</span><br><span class="line">                    m_pMetadataManager-&gt;SetPipelineId(m_metadataClients[index], m_pipelineStatus[index].pipelineId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PostUsecaseCreation(pStreamConfig);</span><br><span class="line"></span><br><span class="line">        UINT32 maxRequiredFrameCnt = GetMaxRequiredFrameCntForOfflineInput(0);</span><br><span class="line">        if (TRUE == IsMultiCameraUsecase())</span><br><span class="line">        &#123;</span><br><span class="line">            //todo: it is better to calculate max required frame count according to pipeline,</span><br><span class="line">            // for example,some customer just want to enable MFNR feature for wide sensor,</span><br><span class="line">            // some customer just want to enable SWMF feature for tele sensor.</span><br><span class="line">            // here suppose both sensor enable same feature simply.</span><br><span class="line">            for (UINT i = 0; i &lt; m_numOfPhysicalDevices; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                maxRequiredFrameCnt = GetMaxRequiredFrameCntForOfflineInput(i);</span><br><span class="line">                UpdateValidRDIBufferLength(i, maxRequiredFrameCnt + 1);</span><br><span class="line">                UpdateValidFDBufferLength(i, maxRequiredFrameCnt + 1);</span><br><span class="line">                CHX_LOG_CONFIG(&quot;physicalCameraIndex:%d,validBufferLength:%d&quot;,</span><br><span class="line">                    i, GetValidBufferLength(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_rdiStreamIndex != InvalidId)</span><br><span class="line">            &#123;</span><br><span class="line">                UpdateValidRDIBufferLength(m_rdiStreamIndex, maxRequiredFrameCnt + 1);</span><br><span class="line">                CHX_LOG_INFO(&quot;m_rdiStreamIndex:%d validBufferLength:%d&quot;,</span><br><span class="line">                             m_rdiStreamIndex, GetValidBufferLength(m_rdiStreamIndex));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_INFO(&quot;No RDI stream&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (m_fdStreamIndex != InvalidId)</span><br><span class="line">            &#123;</span><br><span class="line">                UpdateValidFDBufferLength(m_fdStreamIndex, maxRequiredFrameCnt + 1);</span><br><span class="line">                CHX_LOG_INFO(&quot;m_fdStreamIndex:%d validBufferLength:%d&quot;,</span><br><span class="line">                             m_fdStreamIndex, GetValidBufferLength(m_fdStreamIndex));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_INFO(&quot;No FD stream&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        result = CDKResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ATRACE_END();</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-2-4-CameraUsecaseBase-Initialize"><a href="#4-3-2-4-CameraUsecaseBase-Initialize" class="headerlink" title="4.3.2.4 CameraUsecaseBase::Initialize"></a>4.3.2.4 CameraUsecaseBase::Initialize</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiusecase\chxadvancedcamerausecase.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// CameraUsecaseBase::Initialize</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult CameraUsecaseBase::Initialize(</span><br><span class="line">    ChiCallBacks*                   pCallbacks,</span><br><span class="line">    camera3_stream_configuration_t* pStreamConfig)</span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_BEGIN(&quot;CameraUsecaseBase::Initialize&quot;);</span><br><span class="line"></span><br><span class="line">    CDKResult result               = Usecase::Initialize(false);</span><br><span class="line">    BOOL      bReprocessUsecase    = FALSE;</span><br><span class="line"></span><br><span class="line">    m_lastResultMetadataFrameNum   = -1;</span><br><span class="line">    m_effectModeValue              = ANDROID_CONTROL_EFFECT_MODE_OFF;</span><br><span class="line">    m_sceneModeValue               = ANDROID_CONTROL_SCENE_MODE_DISABLED;</span><br><span class="line">    m_rtSessionIndex               = InvalidId;</span><br><span class="line"></span><br><span class="line">    m_finalPipelineIDForPartialMetaData = InvalidId;</span><br><span class="line"></span><br><span class="line">    m_deferOfflineThreadCreateDone = FALSE;</span><br><span class="line">    m_pDeferOfflineDoneMutex       = Mutex::Create();</span><br><span class="line">    m_pDeferOfflineDoneCondition   = Condition::Create();</span><br><span class="line">    m_deferOfflineSessionDone      = FALSE;</span><br><span class="line">    m_pCallBacks                   = pCallbacks;</span><br><span class="line">    m_GpuNodePresence              = FALSE;</span><br><span class="line">    m_debugLastResultFrameNumber   = static_cast&lt;UINT32&gt;(-1);</span><br><span class="line">    m_pEmptyMetaData               = ChxUtils::AndroidMetadata::AllocateMetaData(0,0);</span><br><span class="line">    m_rdiStreamIndex               = InvalidId;</span><br><span class="line">    m_fdStreamIndex                = InvalidId;</span><br><span class="line">    m_isRequestBatchingOn          = false;</span><br><span class="line">    m_batchRequestStartIndex       = UINT32_MAX;</span><br><span class="line">    m_batchRequestEndIndex         = UINT32_MAX;</span><br><span class="line">    m_numPCRsBeforeStreamOn        = ExtensionModule::GetInstance()-&gt;GetNumPCRsBeforeStreamOn(m_cameraId);</span><br><span class="line"></span><br><span class="line">    ChxUtils::Memset(&amp;m_sessions[0], 0, sizeof(m_sessions));</span><br><span class="line"></span><br><span class="line">    // Default to 1-1 mapping of sessions and pipelines</span><br><span class="line">    if (0 == m_numSessions)</span><br><span class="line">    &#123;</span><br><span class="line">        m_numSessions = m_pChiUsecase-&gt;numPipelines;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHX_ASSERT(0 != m_numSessions);</span><br><span class="line"></span><br><span class="line">    if (CDKResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        ChxUtils::Memset(m_pClonedStream, 0, (sizeof(ChiStream*)*MaxChiStreams));</span><br><span class="line">        ChxUtils::Memset(m_pFrameworkOutStreams, 0, (sizeof(ChiStream*)*MaxChiStreams));</span><br><span class="line">        m_bCloningNeeded         = FALSE;</span><br><span class="line">        m_numberOfOfflineStreams = 0;</span><br><span class="line"></span><br><span class="line">        for (UINT i = 0; i &lt; m_pChiUsecase-&gt;numPipelines; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].sourceTarget.numTargets &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                bReprocessUsecase = TRUE;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (UINT i = 0; i &lt; m_pChiUsecase-&gt;numPipelines; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            if (TRUE == m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pipelineCreateDesc.isRealTime)</span><br><span class="line">            &#123;</span><br><span class="line">                // Cloning of streams needs when source target stream is enabled and</span><br><span class="line">                // all the streams are connected in both real time and offline pipelines</span><br><span class="line">                // excluding the input stream count</span><br><span class="line">                m_bCloningNeeded = bReprocessUsecase &amp;&amp; (UsecaseId::PreviewZSL != m_usecaseId) &amp;&amp;</span><br><span class="line">                    (m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].sinkTarget.numTargets == (m_pChiUsecase-&gt;numTargets - 1));</span><br><span class="line">                if (TRUE == m_bCloningNeeded)</span><br><span class="line">                &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        CHX_LOG(&quot;m_bCloningNeeded = %d&quot;, m_bCloningNeeded);</span><br><span class="line">        // here just generate internal buffer index which will be used for feature to related target buffer</span><br><span class="line">        GenerateInternalBufferIndex() ;</span><br><span class="line"></span><br><span class="line">        for (UINT i = 0; i &lt; m_pChiUsecase-&gt;numPipelines; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            // use mapping if available, otherwise default to 1-1 mapping</span><br><span class="line">            UINT sessionId  = (NULL != m_pPipelineToSession) ? m_pPipelineToSession[i] : i;</span><br><span class="line">            UINT pipelineId = m_sessions[sessionId].numPipelines++;</span><br><span class="line"></span><br><span class="line">            // Assign the ID to pipelineID</span><br><span class="line">            m_sessions[sessionId].pipelines[pipelineId].id = i;</span><br><span class="line"></span><br><span class="line">            CHX_LOG(&quot;Creating Pipeline %s at index %u for session %u, session&apos;s pipeline %u, camera id:%d&quot;,</span><br><span class="line">                m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pPipelineName, i, sessionId, pipelineId, m_pPipelineToCamera[i]);</span><br><span class="line"></span><br><span class="line">            result = CreatePipeline(m_pPipelineToCamera[i],</span><br><span class="line">                                    &amp;m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i],</span><br><span class="line">                                    &amp;m_sessions[sessionId].pipelines[pipelineId],</span><br><span class="line">                                    pStreamConfig);</span><br><span class="line"></span><br><span class="line">            if (CDKResultSuccess != result)</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_ERROR(&quot;Failed to Create Pipeline %s at index %u for session %u, session&apos;s pipeline %u, camera id:%d&quot;,</span><br><span class="line">                    m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pPipelineName, i, sessionId, pipelineId, m_pPipelineToCamera[i]);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            m_sessions[sessionId].pipelines[pipelineId].isHALInputStream = PipelineHasHALInputStream(&amp;m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i]);</span><br><span class="line"></span><br><span class="line">            if (FALSE == m_GpuNodePresence)</span><br><span class="line">            &#123;</span><br><span class="line">                for (UINT nodeIndex = 0;</span><br><span class="line">                        nodeIndex &lt; m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pipelineCreateDesc.numNodes; nodeIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    UINT32 nodeIndexId =</span><br><span class="line">                                m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pipelineCreateDesc.pNodes-&gt;nodeId;</span><br><span class="line">                    if (255 == nodeIndexId)</span><br><span class="line">                    &#123;</span><br><span class="line">                        if (NULL != m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pipelineCreateDesc.pNodes-&gt;pNodeProperties)</span><br><span class="line">                        &#123;</span><br><span class="line">                            const CHAR* gpuNodePropertyValue = &quot;com.qti.node.gpu&quot;;</span><br><span class="line">                            const CHAR* nodePropertyValue = (const CHAR*)</span><br><span class="line">                                m_pChiUsecase-&gt;pPipelineTargetCreateDesc[i].pipelineCreateDesc.pNodes-&gt;pNodeProperties-&gt;pValue;</span><br><span class="line">                            if (!strcmp(gpuNodePropertyValue, nodePropertyValue))</span><br><span class="line">                            &#123;</span><br><span class="line">                                m_GpuNodePresence = TRUE;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            PipelineCreated(sessionId, pipelineId);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        if (CDKResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            //create internal buffer</span><br><span class="line">            CreateInternalBufferManager();</span><br><span class="line"></span><br><span class="line">            //If Session&apos;s Pipeline has HAL input stream port,</span><br><span class="line">            //create it on main thread to return important Stream</span><br><span class="line">            //information during configure_stream call.</span><br><span class="line">            result = CreateSessionsWithInputHALStream(pCallbacks);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            result = StartDeferThread();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            result = CreateRTSessions(pCallbacks);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            INT32 frameworkBufferCount = BufferQueueDepth;</span><br><span class="line"></span><br><span class="line">            for (UINT32 sessionIndex = 0; sessionIndex &lt; m_numSessions; ++sessionIndex)</span><br><span class="line">            &#123;</span><br><span class="line">                PipelineData* pPipelineData = m_sessions[sessionIndex].pipelines;</span><br><span class="line"></span><br><span class="line">                for (UINT32 pipelineIndex = 0; pipelineIndex &lt; m_sessions[sessionIndex].numPipelines; pipelineIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Pipeline* pPipeline = pPipelineData[pipelineIndex].pPipeline;</span><br><span class="line">                    if (TRUE == pPipeline-&gt;IsRealTime())</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_metadataClients[pPipelineData[pipelineIndex].id] =</span><br><span class="line">                             m_pMetadataManager-&gt;RegisterClient(</span><br><span class="line">                                pPipeline-&gt;IsRealTime(),</span><br><span class="line">                                pPipeline-&gt;GetTagList(),</span><br><span class="line">                                pPipeline-&gt;GetTagCount(),</span><br><span class="line">                                pPipeline-&gt;GetPartialTagCount(),</span><br><span class="line">                                pPipeline-&gt;GetMetadataBufferCount() + BufferQueueDepth,</span><br><span class="line">                                ChiMetadataUsage::RealtimeOutput);</span><br><span class="line"></span><br><span class="line">                        pPipelineData[pipelineIndex].pPipeline-&gt;SetMetadataClientId(</span><br><span class="line">                            m_metadataClients[pPipelineData[pipelineIndex].id]);</span><br><span class="line"></span><br><span class="line">                        // update tag filters</span><br><span class="line">                        PrepareHFRTagFilterList(pPipelineData[pipelineIndex].pPipeline-&gt;GetMetadataClientId());</span><br><span class="line">                        frameworkBufferCount += pPipeline-&gt;GetMetadataBufferCount();</span><br><span class="line">                    &#125;</span><br><span class="line">                    ChiMetadata* pMetadata = pPipeline-&gt;GetDescriptorMetadata();</span><br><span class="line">                    result = pMetadata-&gt;SetTag(&quot;com.qti.chi.logicalcamerainfo&quot;, &quot;NumPhysicalCameras&quot;, &amp;m_numOfPhysicalDevices,</span><br><span class="line">                        sizeof(m_numOfPhysicalDevices));</span><br><span class="line">                    if (CDKResultSuccess != result)</span><br><span class="line">                    &#123;</span><br><span class="line">                        CHX_LOG_ERROR(&quot;Failed to set metadata tag NumPhysicalCameras&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            m_pMetadataManager-&gt;InitializeFrameworkInputClient(frameworkBufferCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ATRACE_END();</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-3-CreatePipeline"><a href="#4-3-3-CreatePipeline" class="headerlink" title="4.3.3 CreatePipeline"></a>4.3.3 CreatePipeline</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// CameraUsecaseBase::CreatePipeline</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult CameraUsecaseBase::CreatePipeline(</span><br><span class="line">    UINT32                              cameraId,</span><br><span class="line">    ChiPipelineTargetCreateDescriptor*  pPipelineDesc,</span><br><span class="line">    PipelineData*                       pPipelineData,</span><br><span class="line">    camera3_stream_configuration_t*     pStreamConfig)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult result = CDKResultSuccess;</span><br><span class="line"></span><br><span class="line">    pPipelineData-&gt;pPipeline = Pipeline::Create(cameraId, PipelineType::Default, pPipelineDesc-&gt;pPipelineName);</span><br><span class="line"></span><br><span class="line">    if (NULL != pPipelineData-&gt;pPipeline)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT                         numStreams  = 0;</span><br><span class="line">        ChiTargetPortDescriptorInfo* pSinkTarget = &amp;pPipelineDesc-&gt;sinkTarget;</span><br><span class="line">        ChiTargetPortDescriptorInfo* pSrcTarget  = &amp;pPipelineDesc-&gt;sourceTarget;</span><br><span class="line"></span><br><span class="line">        ChiPortBufferDescriptor pipelineOutputBuffer[MaxChiStreams];</span><br><span class="line">        ChiPortBufferDescriptor pipelineInputBuffer[MaxChiStreams];</span><br><span class="line"></span><br><span class="line">        ChxUtils::Memset(pipelineOutputBuffer, 0, sizeof(pipelineOutputBuffer));</span><br><span class="line">        ChxUtils::Memset(pipelineInputBuffer, 0, sizeof(pipelineInputBuffer));</span><br><span class="line"></span><br><span class="line">        UINT32 tagId = ExtensionModule::GetInstance()-&gt;GetVendorTagId(VendorTag::FastShutterMode);</span><br><span class="line">        UINT8 isFSMode = 0;</span><br><span class="line">        if (StreamConfigModeFastShutter == ExtensionModule::GetInstance()-&gt;GetOpMode(m_cameraId))</span><br><span class="line">        &#123;</span><br><span class="line">            isFSMode = 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (TRUE == pPipelineData-&gt;pPipeline-&gt;HasSensorNode(&amp;pPipelineDesc-&gt;pipelineCreateDesc))</span><br><span class="line">        &#123;</span><br><span class="line">            ChiMetadata* pMetadata = pPipelineData-&gt;pPipeline-&gt;GetDescriptorMetadata();</span><br><span class="line">            if (NULL != pMetadata)</span><br><span class="line">            &#123;</span><br><span class="line">                CSIDBinningInfo binningInfo =&#123; 0 &#125;;</span><br><span class="line">                CameraCSIDTrigger(&amp;binningInfo, pPipelineDesc);</span><br><span class="line"></span><br><span class="line">                result = pMetadata-&gt;SetTag(&quot;org.quic.camera.ifecsidconfig&quot;,</span><br><span class="line">                                           &quot;csidbinninginfo&quot;,</span><br><span class="line">                                           &amp;binningInfo,</span><br><span class="line">                                           sizeof(binningInfo));</span><br><span class="line">                if (CDKResultSuccess != result)</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_ERROR(&quot;Failed to set metadata ifecsidconfig&quot;);</span><br><span class="line">                    result = CDKResultSuccess;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = pPipelineData-&gt;pPipeline-&gt;SetVendorTag(tagId, static_cast&lt;VOID*&gt;(&amp;isFSMode), 1);</span><br><span class="line">        if (CDKResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;Failed to set metadata FSMode&quot;);</span><br><span class="line">            result = CDKResultSuccess;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (NULL != pStreamConfig)</span><br><span class="line">        &#123;</span><br><span class="line">            pPipelineData-&gt;pPipeline-&gt;SetAndroidMetadata(pStreamConfig);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (UINT sinkIdx = 0; sinkIdx &lt; pSinkTarget-&gt;numTargets; sinkIdx++)</span><br><span class="line">        &#123;</span><br><span class="line">            ChiTargetPortDescriptor* pSinkTargetDesc = &amp;pSinkTarget-&gt;pTargetPortDesc[sinkIdx];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            UINT previewFPS  = ExtensionModule::GetInstance()-&gt;GetPreviewFPS();</span><br><span class="line">            UINT videoFPS    = ExtensionModule::GetInstance()-&gt;GetVideoFPS();</span><br><span class="line">            UINT pipelineFPS = ExtensionModule::GetInstance()-&gt;GetUsecaseMaxFPS();</span><br><span class="line"></span><br><span class="line">            pSinkTargetDesc-&gt;pTarget-&gt;pChiStream-&gt;streamParams.streamFPS = pipelineFPS;</span><br><span class="line"></span><br><span class="line">            // override ChiStream FPS value for Preview/Video streams with stream-specific values only IF</span><br><span class="line">            // APP has set valid stream-specific fps</span><br><span class="line">            if (UsecaseSelector::IsPreviewStream(reinterpret_cast&lt;camera3_stream_t*&gt;(pSinkTargetDesc-&gt;pTarget-&gt;pChiStream)))</span><br><span class="line">            &#123;</span><br><span class="line">                pSinkTargetDesc-&gt;pTarget-&gt;pChiStream-&gt;streamParams.streamFPS = (previewFPS == 0) ? pipelineFPS : previewFPS;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (UsecaseSelector::IsVideoStream(reinterpret_cast&lt;camera3_stream_t*&gt;(pSinkTargetDesc-&gt;pTarget-&gt;pChiStream)))</span><br><span class="line">            &#123;</span><br><span class="line">                pSinkTargetDesc-&gt;pTarget-&gt;pChiStream-&gt;streamParams.streamFPS = (videoFPS == 0) ? pipelineFPS : videoFPS;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if ((pSrcTarget-&gt;numTargets &gt; 0) &amp;&amp; (TRUE == m_bCloningNeeded))</span><br><span class="line">            &#123;</span><br><span class="line">                m_pFrameworkOutStreams[m_numberOfOfflineStreams] = pSinkTargetDesc-&gt;pTarget-&gt;pChiStream;</span><br><span class="line">                m_pClonedStream[m_numberOfOfflineStreams]        = static_cast&lt;CHISTREAM*&gt;(CHX_CALLOC(sizeof(CHISTREAM)));</span><br><span class="line"></span><br><span class="line">                ChxUtils::Memcpy(m_pClonedStream[m_numberOfOfflineStreams], pSinkTargetDesc-&gt;pTarget-&gt;pChiStream, sizeof(CHISTREAM));</span><br><span class="line"></span><br><span class="line">                pipelineOutputBuffer[sinkIdx].pStream     = m_pClonedStream[m_numberOfOfflineStreams];</span><br><span class="line">                pipelineOutputBuffer[sinkIdx].pNodePort   = pSinkTargetDesc-&gt;pNodePort;</span><br><span class="line">                pipelineOutputBuffer[sinkIdx].numNodePorts= pSinkTargetDesc-&gt;numNodePorts;</span><br><span class="line">                pPipelineData-&gt;pStreams[numStreams++]     = pipelineOutputBuffer[sinkIdx].pStream;</span><br><span class="line">                m_numberOfOfflineStreams++;</span><br><span class="line"></span><br><span class="line">                CHX_LOG(&quot;CloningNeeded sinkIdx %d numStreams %d pStream %p nodePortId %d&quot;,</span><br><span class="line">                        sinkIdx,</span><br><span class="line">                        numStreams-1,</span><br><span class="line">                        pipelineOutputBuffer[sinkIdx].pStream,</span><br><span class="line">                        pipelineOutputBuffer[sinkIdx].pNodePort[0].nodePortId);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                pipelineOutputBuffer[sinkIdx].pStream      = pSinkTargetDesc-&gt;pTarget-&gt;pChiStream;</span><br><span class="line">                pipelineOutputBuffer[sinkIdx].pNodePort    = pSinkTargetDesc-&gt;pNodePort;</span><br><span class="line">                pipelineOutputBuffer[sinkIdx].numNodePorts = pSinkTargetDesc-&gt;numNodePorts;</span><br><span class="line">                pPipelineData-&gt;pStreams[numStreams++]   = pipelineOutputBuffer[sinkIdx].pStream;</span><br><span class="line">                CHX_LOG(&quot;sinkIdx %d numStreams %d pStream %p format %u %d:%d nodePortID %d&quot;,</span><br><span class="line">                        sinkIdx,</span><br><span class="line">                        numStreams - 1,</span><br><span class="line">                        pipelineOutputBuffer[sinkIdx].pStream,</span><br><span class="line">                        pipelineOutputBuffer[sinkIdx].pStream-&gt;format,</span><br><span class="line">                        pipelineOutputBuffer[sinkIdx].pNodePort[0].nodeId,</span><br><span class="line">                        pipelineOutputBuffer[sinkIdx].pNodePort[0].nodeInstanceId,</span><br><span class="line">                        pipelineOutputBuffer[sinkIdx].pNodePort[0].nodePortId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (UINT sourceIdx = 0; sourceIdx &lt; pSrcTarget-&gt;numTargets; sourceIdx++)</span><br><span class="line">        &#123;</span><br><span class="line">            UINT                     i              = 0;</span><br><span class="line">            ChiTargetPortDescriptor* pSrcTargetDesc = &amp;pSrcTarget-&gt;pTargetPortDesc[sourceIdx];</span><br><span class="line"></span><br><span class="line">            pipelineInputBuffer[sourceIdx].pStream = pSrcTargetDesc-&gt;pTarget-&gt;pChiStream;</span><br><span class="line"></span><br><span class="line">            pipelineInputBuffer[sourceIdx].pNodePort    = pSrcTargetDesc-&gt;pNodePort;</span><br><span class="line">            pipelineInputBuffer[sourceIdx].numNodePorts = pSrcTargetDesc-&gt;numNodePorts;</span><br><span class="line"></span><br><span class="line">            for (i = 0; i &lt; numStreams; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                if (pPipelineData-&gt;pStreams[i] == pipelineInputBuffer[sourceIdx].pStream)</span><br><span class="line">                &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (numStreams == i)</span><br><span class="line">            &#123;</span><br><span class="line">                pPipelineData-&gt;pStreams[numStreams++] = pipelineInputBuffer[sourceIdx].pStream;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (UINT portIndex = 0; portIndex &lt; pipelineInputBuffer[sourceIdx].numNodePorts; portIndex++)</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG(&quot;sourceIdx %d portIndex %d numStreams %d pStream %p format %u %d:%d nodePortID %d&quot;,</span><br><span class="line">                        sourceIdx,</span><br><span class="line">                        portIndex,</span><br><span class="line">                        numStreams - 1,</span><br><span class="line">                        pipelineInputBuffer[sourceIdx].pStream,</span><br><span class="line">                        pipelineInputBuffer[sourceIdx].pStream-&gt;format,</span><br><span class="line">                        pipelineInputBuffer[sourceIdx].pNodePort[portIndex].nodeId,</span><br><span class="line">                        pipelineInputBuffer[sourceIdx].pNodePort[portIndex].nodeInstanceId,</span><br><span class="line">                        pipelineInputBuffer[sourceIdx].pNodePort[portIndex].nodePortId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pPipelineData-&gt;pPipeline-&gt;SetOutputBuffers(pSinkTarget-&gt;numTargets, &amp;pipelineOutputBuffer[0]);</span><br><span class="line">        pPipelineData-&gt;pPipeline-&gt;SetInputBuffers(pSrcTarget-&gt;numTargets, &amp;pipelineInputBuffer[0]);</span><br><span class="line">        pPipelineData-&gt;pPipeline-&gt;SetPipelineNodePorts(&amp;pPipelineDesc-&gt;pipelineCreateDesc);</span><br><span class="line">        pPipelineData-&gt;pPipeline-&gt;SetPipelineName(pPipelineDesc-&gt;pPipelineName);</span><br><span class="line"></span><br><span class="line">        CHX_LOG(&quot;set sensor mode pick hint: %p&quot;, GetSensorModePickHint(pPipelineData-&gt;id));</span><br><span class="line">        pPipelineData-&gt;pPipeline-&gt;SetSensorModePickHint(GetSensorModePickHint(pPipelineData-&gt;id));</span><br><span class="line"></span><br><span class="line">        pPipelineData-&gt;numStreams       = numStreams;</span><br><span class="line"></span><br><span class="line">        result = pPipelineData-&gt;pPipeline-&gt;CreateDescriptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-3-1-Pipeline-Create"><a href="#4-3-3-1-Pipeline-Create" class="headerlink" title="4.3.3.1 Pipeline::Create"></a>4.3.3.1 Pipeline::Create</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiframework\chxpipeline.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// Pipeline::Create</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">Pipeline* Pipeline::Create(</span><br><span class="line">    UINT32       cameraId,</span><br><span class="line">    PipelineType type,</span><br><span class="line">    const CHAR*  pName)</span><br><span class="line">&#123;</span><br><span class="line">    Pipeline* pPipeline = CHX_NEW Pipeline;</span><br><span class="line"></span><br><span class="line">    if (NULL != pPipeline)</span><br><span class="line">    &#123;</span><br><span class="line">        pPipeline-&gt;Initialize(cameraId, type);</span><br><span class="line"></span><br><span class="line">        pPipeline-&gt;m_pPipelineName = pName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pPipeline;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-3-2-Pipeline-Initialize"><a href="#4-3-3-2-Pipeline-Initialize" class="headerlink" title="4.3.3.2 Pipeline::Initialize"></a>4.3.3.2 Pipeline::Initialize</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line">CamxResult Pipeline::Initialize(</span><br><span class="line">    PipelineCreateInputData*  pPipelineCreateInputData,</span><br><span class="line">    PipelineCreateOutputData* pPipelineCreateOutputData)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultEFailed;</span><br><span class="line"></span><br><span class="line">    m_pChiContext                   = pPipelineCreateInputData-&gt;pChiContext;</span><br><span class="line">    m_flags.isSecureMode            = pPipelineCreateInputData-&gt;isSecureMode;</span><br><span class="line">    m_flags.isHFRMode               = pPipelineCreateInputData-&gt;pPipelineDescriptor-&gt;flags.isHFRMode;</span><br><span class="line">    m_flags.isInitialConfigPending  = TRUE;</span><br><span class="line">    m_pThreadManager                = pPipelineCreateInputData-&gt;pChiContext-&gt;GetThreadManager();</span><br><span class="line">    m_pPipelineDescriptor           = pPipelineCreateInputData-&gt;pPipelineDescriptor;</span><br><span class="line">    m_pipelineIndex                 = pPipelineCreateInputData-&gt;pipelineIndex;</span><br><span class="line">    m_cameraId                      = m_pPipelineDescriptor-&gt;cameraId;</span><br><span class="line">    m_hCSLLinkHandle                = CSLInvalidHandle;</span><br><span class="line">    m_numConfigDoneNodes            = 0;</span><br><span class="line">    m_lastRequestId                 = 0;</span><br><span class="line">    m_configDoneCount               = 0;</span><br><span class="line">    m_hCSLLinkHandle                = 0;</span><br><span class="line">    m_HALOutputBufferCombined       = m_pPipelineDescriptor-&gt;HALOutputBufferCombined;</span><br><span class="line">    m_lastSubmittedShutterRequestId = 0;</span><br><span class="line">    m_pTuningManager                = HwEnvironment::GetInstance()-&gt;GetTuningDataManager(m_cameraId);</span><br><span class="line">    m_sensorSyncMode                = NoSync;</span><br><span class="line"></span><br><span class="line">    // Create lock and condition for config done</span><br><span class="line">    m_pConfigDoneLock       = Mutex::Create(&quot;PipelineConfigDoneLock&quot;);</span><br><span class="line">    m_pWaitForConfigDone    = Condition::Create(&quot;PipelineWaitForConfigDone&quot;);</span><br><span class="line"></span><br><span class="line">    // Resource lock, used to syncronize acquire resources and release resources</span><br><span class="line">    m_pResourceAcquireReleaseLock = Mutex::Create(&quot;PipelineResourceAcquireReleaseLock&quot;);</span><br><span class="line">    if (NULL == m_pResourceAcquireReleaseLock)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pWaitForStreamOnDone = Condition::Create(&quot;PipelineWaitForStreamOnDone&quot;);</span><br><span class="line">    if (NULL == m_pWaitForStreamOnDone)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pStreamOnDoneLock = Mutex::Create(&quot;PipelineStreamOnDoneLock&quot;);</span><br><span class="line">    if (NULL == m_pStreamOnDoneLock)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pNodesRequestDoneLock = Mutex::Create(&quot;PipelineAllNodesRequestDone&quot;);</span><br><span class="line">    if (NULL == m_pNodesRequestDoneLock)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pWaitAllNodesRequestDone = Condition::Create(&quot;PipelineWaitAllNodesRequestDone&quot;);</span><br><span class="line">    if (NULL == m_pWaitAllNodesRequestDone)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create external Sensor when sensor module is enabled</span><br><span class="line">    // External Sensor Module is created so as to test CAMX ability to work with OEMs</span><br><span class="line">    // who has external sensor (ie they do all sensor configuration outside of driver</span><br><span class="line">    // and there is no sensor node in the pipeline )</span><br><span class="line">    HwContext* pHwcontext = pPipelineCreateInputData-&gt;pChiContext-&gt;GetHwContext();</span><br><span class="line">    if (TRUE == pHwcontext-&gt;GetStaticSettings()-&gt;enableExternalSensorModule)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pExternalSensor = ExternalSensor::Create();</span><br><span class="line">        CAMX_ASSERT(NULL != m_pExternalSensor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != m_pConfigDoneLock);</span><br><span class="line">    CAMX_ASSERT(NULL != m_pWaitForConfigDone);</span><br><span class="line">    CAMX_ASSERT(NULL != m_pResourceAcquireReleaseLock);</span><br><span class="line"></span><br><span class="line">    OsUtils::SNPrintF(m_pipelineIdentifierString, sizeof(m_pipelineIdentifierString), &quot;%s_%d&quot;,</span><br><span class="line">        GetPipelineName(), GetPipelineId());</span><br><span class="line"></span><br><span class="line">    // We can&apos;t defer UsecasePool since we are publishing preview dimension to it.</span><br><span class="line">    m_pUsecasePool  = MetadataPool::Create(PoolType::PerUsecase, m_pipelineIndex, NULL, 1, GetPipelineIdentifierString(), 0);</span><br><span class="line"></span><br><span class="line">    if (NULL != m_pUsecasePool)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pUsecasePool-&gt;UpdateRequestId(0); // Usecase pool created, mark the slot as valid</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SetLCRRawformatPorts();</span><br><span class="line"></span><br><span class="line">    SetNumBatchedFrames(m_pPipelineDescriptor-&gt;numBatchedFrames, m_pPipelineDescriptor-&gt;maxFPSValue);</span><br><span class="line"></span><br><span class="line">    m_pCSLSyncIDToRequestId = static_cast&lt;UINT64*&gt;(CAMX_CALLOC(sizeof(UINT64) * MaxPerRequestInfo * GetBatchedHALOutputNum()));</span><br><span class="line"></span><br><span class="line">    if (NULL == m_pCSLSyncIDToRequestId)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pStreamBufferBlob = static_cast&lt;StreamBufferInfo*&gt;(CAMX_CALLOC(sizeof(StreamBufferInfo) * GetBatchedHALOutputNum() *</span><br><span class="line">                                                                     MaxPerRequestInfo));</span><br><span class="line">    if (NULL == m_pStreamBufferBlob)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">        return CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (UINT i = 0; i &lt; MaxPerRequestInfo; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_perRequestInfo[i].pSequenceId = static_cast&lt;UINT32*&gt;(CAMX_CALLOC(sizeof(UINT32) * GetBatchedHALOutputNum()));</span><br><span class="line"></span><br><span class="line">        if (NULL == m_perRequestInfo[i].pSequenceId)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory!!&quot;);</span><br><span class="line">            return CamxResultENoMemory;</span><br><span class="line">        &#125;</span><br><span class="line">        m_perRequestInfo[i].request.pStreamBuffers = &amp;m_pStreamBufferBlob[i * GetBatchedHALOutputNum()];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MetadataSlot*    pMetadataSlot                = m_pUsecasePool-&gt;GetSlot(0);</span><br><span class="line">    MetaBuffer*      pInitializationMetaBuffer    = m_pPipelineDescriptor-&gt;pSessionMetadata;</span><br><span class="line">    MetaBuffer*      pMetadataSlotDstBuffer       = NULL;</span><br><span class="line"></span><br><span class="line">    // Copy metadata published by the Chi Usecase to this pipeline&apos;s UsecasePool</span><br><span class="line">    if (NULL != pInitializationMetaBuffer)</span><br><span class="line">    &#123;</span><br><span class="line">        result = pMetadataSlot-&gt;GetMetabuffer(&amp;pMetadataSlotDstBuffer);</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            pMetadataSlotDstBuffer-&gt;Copy(pInitializationMetaBuffer, TRUE);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupMeta, &quot;Cannot copy! Error Code: %u&quot;, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_WARN(CamxLogGroupMeta, &quot;No init metadata found!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT32      metaTag             = 0;</span><br><span class="line">        UINT        sleepStaticSetting  = HwEnvironment::GetInstance()-&gt;GetStaticSettings()-&gt;induceSleepInChiNode;</span><br><span class="line"></span><br><span class="line">        result                          = VendorTagManager::QueryVendorTagLocation(</span><br><span class="line">                                                &quot;org.quic.camera.induceSleepInChiNode&quot;,</span><br><span class="line">                                                &quot;InduceSleep&quot;,</span><br><span class="line">                                                &amp;metaTag);</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            result  = pMetadataSlot-&gt;SetMetadataByTag(metaTag, &amp;sleepStaticSetting, 1, &quot;camx_session&quot;);</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess != result)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Failed to set Induce sleep result %d&quot;, result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GetCameraRunningOnBPS(pMetadataSlot);</span><br><span class="line"></span><br><span class="line">    ConfigureMaxPipelineDelay(m_pPipelineDescriptor-&gt;maxFPSValue,</span><br><span class="line">        (FALSE == m_flags.isCameraRunningOnBPS) ? DefaultMaxIFEPipelineDelay : DefaultMaxBPSPipelineDelay);</span><br><span class="line"></span><br><span class="line">    QueryEISCaps();</span><br><span class="line"></span><br><span class="line">    PublishOutputDimensions();</span><br><span class="line">    PublishTargetFPS();</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        result = PopulatePSMetadataSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = CreateNodes(pPipelineCreateInputData, pPipelineCreateOutputData);</span><br><span class="line"></span><br><span class="line">    // set frame delay in session metadata</span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT32 metaTag    = 0;</span><br><span class="line">        UINT32 frameDelay = DetermineFrameDelay();</span><br><span class="line">        result            = VendorTagManager::QueryVendorTagLocation(</span><br><span class="line">                            &quot;org.quic.camera.eislookahead&quot;, &quot;FrameDelay&quot;, &amp;metaTag);</span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            MetaBuffer* pSessionMetaBuffer = m_pPipelineDescriptor-&gt;pSessionMetadata;</span><br><span class="line">            if (NULL != pSessionMetaBuffer)</span><br><span class="line">            &#123;</span><br><span class="line">                result = pSessionMetaBuffer-&gt;SetTag(metaTag, &amp;frameDelay, 1, sizeof(UINT32));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                result = CamxResultEInvalidPointer;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Session metadata pointer null&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set EIS enabled flag in session metadata</span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT32  metaTag     = 0;</span><br><span class="line">        BOOL    bEnabled    = IsEISEnabled();</span><br><span class="line">        result              = VendorTagManager::QueryVendorTagLocation(&quot;org.quic.camera.eisrealtime&quot;, &quot;Enabled&quot;, &amp;metaTag);</span><br><span class="line"></span><br><span class="line">        // write the enabled flag only if it&apos;s set to TRUE. IsEISEnabled may return FALSE when vendor tag is not published too</span><br><span class="line">        if ((TRUE == bEnabled) &amp;&amp; (CamxResultSuccess == result))</span><br><span class="line">        &#123;</span><br><span class="line">            MetaBuffer* pSessionMetaBuffer = m_pPipelineDescriptor-&gt;pSessionMetadata;</span><br><span class="line">            if (NULL != pSessionMetaBuffer)</span><br><span class="line">            &#123;</span><br><span class="line">                result = pSessionMetaBuffer-&gt;SetTag(metaTag, &amp;bEnabled, 1, sizeof(BYTE));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                result = CamxResultEInvalidPointer;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Session metadata pointer null&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set EIS minimal total margin in session metadata</span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT32 metaTag = 0;</span><br><span class="line">        MarginRequest margin = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">        result = DetermineEISMiniamalTotalMargin(&amp;margin);</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            result = VendorTagManager::QueryVendorTagLocation(&quot;org.quic.camera.eisrealtime&quot;, &quot;MinimalTotalMargins&quot;, &amp;metaTag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            MetaBuffer* pSessionMetaBuffer = m_pPipelineDescriptor-&gt;pSessionMetadata;</span><br><span class="line">            if (NULL != pSessionMetaBuffer)</span><br><span class="line">            &#123;</span><br><span class="line">                result = pSessionMetaBuffer-&gt;SetTag(metaTag, &amp;margin, 1, sizeof(MarginRequest));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                result = CamxResultEInvalidPointer;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Session metadata pointer null&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        for (UINT i = 0; i &lt; m_nodeCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            result = FilterAndUpdatePublishSet(m_ppNodes[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (HwEnvironment::GetInstance()-&gt;GetStaticSettings()-&gt;numMetadataResults &gt; SingleMetadataResult)</span><br><span class="line">    &#123;</span><br><span class="line">        m_bPartialMetadataEnabled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((TRUE == m_bPartialMetadataEnabled) &amp;&amp; (TRUE == m_flags.isHFRMode))</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_CONFIG(CamxLogGroupCore, &quot;Disable partial metadata in HFR mode&quot;);</span><br><span class="line">        m_bPartialMetadataEnabled = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pPerRequestInfoLock = Mutex::Create(&quot;PipelineRequestInfo&quot;);</span><br><span class="line">        if (NULL != m_pPerRequestInfoLock)</span><br><span class="line">        &#123;</span><br><span class="line">            if (IsRealTime())</span><br><span class="line">            &#123;</span><br><span class="line">                m_metaBufferDelay = Utils::MaxUINT32(</span><br><span class="line">                    GetMaxPipelineDelay(),</span><br><span class="line">                    DetermineFrameDelay());</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_metaBufferDelay = 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            result = CamxResultENoMemory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        if (IsRealTime())</span><br><span class="line">        &#123;</span><br><span class="line">            m_metaBufferDelay = Utils::MaxUINT32(</span><br><span class="line">                GetMaxPipelineDelay(),</span><br><span class="line">                DetermineFrameDelay());</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            m_metaBufferDelay = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UpdatePublishTags();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        pPipelineCreateOutputData-&gt;pPipeline = this;</span><br><span class="line">        SetPipelineStatus(PipelineStatus::INITIALIZED);</span><br><span class="line">        auto&amp; rPipelineName = m_pipelineIdentifierString;</span><br><span class="line">        UINT  pipelineId    = GetPipelineId();</span><br><span class="line">        BOOL  isRealtime    = IsRealTime();</span><br><span class="line">        auto  hPipeline     = m_pPipelineDescriptor;</span><br><span class="line">        BINARY_LOG(LogEvent::Pipeline_Initialize, rPipelineName, pipelineId, hPipeline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-3-3-CreateNodes"><a href="#4-3-3-3-CreateNodes" class="headerlink" title="4.3.3.3 CreateNodes"></a>4.3.3.3 CreateNodes</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// Pipeline::CreateNodes</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CamxResult Pipeline::CreateNodes(</span><br><span class="line">    PipelineCreateInputData*  pCreateInputData,</span><br><span class="line">    PipelineCreateOutputData* pCreateOutputData)</span><br><span class="line">&#123;</span><br><span class="line">    /// @todo (CAMX-423) Break it into smaller functions</span><br><span class="line"></span><br><span class="line">    CAMX_UNREFERENCED_PARAM(pCreateOutputData);</span><br><span class="line"></span><br><span class="line">    CamxResult                result                    = CamxResultSuccess;</span><br><span class="line">    const PipelineDescriptor* pPipelineDescriptor       = pCreateInputData-&gt;pPipelineDescriptor;</span><br><span class="line">    const PerPipelineInfo*    pPipelineInfo             = &amp;pPipelineDescriptor-&gt;pipelineInfo;</span><br><span class="line">    UINT                      numInPlaceSinkBufferNodes = 0;</span><br><span class="line">    Node*                     pInplaceSinkBufferNode[MaxNodeType];</span><br><span class="line">    UINT                      numBypassableNodes        = 0;</span><br><span class="line">    Node*                     pBypassableNodes[MaxNodeType];</span><br><span class="line">    ExternalComponentInfo*    pExternalComponentInfo    = HwEnvironment::GetInstance()-&gt;GetExternalComponent();</span><br><span class="line">    UINT                      numExternalComponents     = HwEnvironment::GetInstance()-&gt;GetNumExternalComponent();</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL == m_ppNodes);</span><br><span class="line">    m_onlineIFENodeCount               = 0;</span><br><span class="line"></span><br><span class="line">    m_nodeCount                        = pPipelineInfo-&gt;numNodes;</span><br><span class="line">    m_ppNodes                          = static_cast&lt;Node**&gt;(CAMX_CALLOC(sizeof(Node*) * m_nodeCount));</span><br><span class="line">    m_ppOrderedNodes = static_cast&lt;Node**&gt;(CAMX_CALLOC(sizeof(Node*) * m_nodeCount));</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != m_ppOrderedNodes);</span><br><span class="line"></span><br><span class="line">    if ((NULL != m_ppNodes) &amp;&amp;</span><br><span class="line">        (NULL != m_ppOrderedNodes))</span><br><span class="line">    &#123;</span><br><span class="line">        NodeCreateInputData createInputData  = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">        createInputData.pPipeline    = this;</span><br><span class="line">        createInputData.pChiContext  = pCreateInputData-&gt;pChiContext;</span><br><span class="line"></span><br><span class="line">        UINT nodeIndex = 0;</span><br><span class="line"></span><br><span class="line">        CAMX_LOG_CONFIG(CamxLogGroupCore,</span><br><span class="line">                      &quot;Topology: Creating Pipeline %s, numNodes %d isSensorInput %d isRealTime %d&quot;,</span><br><span class="line">                      GetPipelineIdentifierString(),</span><br><span class="line">                      m_nodeCount,</span><br><span class="line">                      IsSensorInput(),</span><br><span class="line">                      IsRealTime());</span><br><span class="line"></span><br><span class="line">        for (UINT numNodes = 0; numNodes &lt; m_nodeCount; numNodes++)</span><br><span class="line">        &#123;</span><br><span class="line">            NodeCreateOutputData createOutputData = &#123; 0 &#125;;</span><br><span class="line">            createInputData.pNodeInfo         = &amp;(pPipelineInfo-&gt;pNodeInfo[numNodes]);</span><br><span class="line">            createInputData.pipelineNodeIndex = numNodes;</span><br><span class="line"></span><br><span class="line">            for (UINT propertyIndex = 0; propertyIndex &lt; createInputData.pNodeInfo-&gt;nodePropertyCount; propertyIndex++)</span><br><span class="line">            &#123;</span><br><span class="line">                for (UINT index = 0; index &lt; numExternalComponents; index++)</span><br><span class="line">                &#123;</span><br><span class="line">                    if ((pExternalComponentInfo[index].nodeAlgoType == ExternalComponentNodeAlgo::COMPONENTALGORITHM) &amp;&amp;</span><br><span class="line">                        (NodePropertyCustomLib == createInputData.pNodeInfo-&gt;pNodeProperties[propertyIndex].id))</span><br><span class="line">                    &#123;</span><br><span class="line">                        CHAR matchString[FILENAME_MAX] = &#123;0&#125;;</span><br><span class="line">                        OsUtils::SNPrintF(matchString, FILENAME_MAX, &quot;%s.%s&quot;,</span><br><span class="line">                            static_cast&lt;CHAR*&gt;(createInputData.pNodeInfo-&gt;pNodeProperties[propertyIndex].pValue),</span><br><span class="line">                            SharedLibraryExtension);</span><br><span class="line"></span><br><span class="line">                        if (OsUtils::StrNICmp(pExternalComponentInfo[index].pComponentName,</span><br><span class="line">                            matchString,</span><br><span class="line">                            OsUtils::StrLen(pExternalComponentInfo[index].pComponentName)) == 0)</span><br><span class="line">                        &#123;</span><br><span class="line">                            if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOAF)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pAFAlgoCallbacks = &amp;pExternalComponentInfo[index].AFAlgoCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOAEC)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pAECAlgoCallbacks = &amp;pExternalComponentInfo[index].AECAlgoCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOAWB)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pAWBAlgoCallbacks = &amp;pExternalComponentInfo[index].AWBAlgoCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOAFD)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pAFDAlgoCallbacks = &amp;pExternalComponentInfo[index].AFDAlgoCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOASD)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pASDAlgoCallbacks = &amp;pExternalComponentInfo[index].ASDAlgoCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOPD)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pPDLibCallbacks = &amp;pExternalComponentInfo[index].PDLibCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOHIST)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pHistAlgoCallbacks = &amp;pExternalComponentInfo[index].histAlgoCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else if (pExternalComponentInfo[index].statsAlgo == ExternalComponentStatsAlgo::ALGOTRACK)</span><br><span class="line">                            &#123;</span><br><span class="line">                                createInputData.pTrackerAlgoCallbacks = &amp;pExternalComponentInfo[index].trackerAlgoCallbacks;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else if ((pExternalComponentInfo[index].nodeAlgoType == ExternalComponentNodeAlgo::COMPONENTHVX) &amp;&amp;</span><br><span class="line">                        (NodePropertyCustomLib == createInputData.pNodeInfo-&gt;pNodeProperties[propertyIndex].id) &amp;&amp;</span><br><span class="line">                        (OsUtils::StrStr(pExternalComponentInfo[index].pComponentName,</span><br><span class="line">                        static_cast&lt;CHAR*&gt;(createInputData.pNodeInfo-&gt;pNodeProperties[propertyIndex].pValue)) != NULL))</span><br><span class="line">                    &#123;</span><br><span class="line">                        createInputData.pHVXAlgoCallbacks = &amp;pExternalComponentInfo[index].HVXAlgoCallbacks;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            result = Node::Create(&amp;createInputData, &amp;createOutputData);</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_CONFIG(CamxLogGroupCore,</span><br><span class="line">                              &quot;Topology::%s Node::%s Type %d numInputPorts %d numOutputPorts %d&quot;,</span><br><span class="line">                              GetPipelineIdentifierString(),</span><br><span class="line">                              createOutputData.pNode-&gt;NodeIdentifierString(),</span><br><span class="line">                              createOutputData.pNode-&gt;Type(),</span><br><span class="line">                              createInputData.pNodeInfo-&gt;inputPorts.numPorts,</span><br><span class="line">                              createInputData.pNodeInfo-&gt;outputPorts.numPorts);</span><br><span class="line"></span><br><span class="line">                if (CamxResultSuccess != result)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_WARN(CamxLogGroupCore, &quot;[%s] Cannot get publish list for %s&quot;,</span><br><span class="line">                                  GetPipelineIdentifierString(), createOutputData.pNode-&gt;NodeIdentifierString());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (StatsProcessing == createOutputData.pNode-&gt;Type())</span><br><span class="line">                &#123;</span><br><span class="line">                    m_flags.hasStatsNode = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (IFENodeID == createOutputData.pNode-&gt;Type())</span><br><span class="line">                &#123;</span><br><span class="line">                    // SOF will come from all online IFE present in pipeline</span><br><span class="line">                    // one pipeline can have multiple IFE in case of</span><br><span class="line">                    // virtual channel support. Need to consolidate SOFs.</span><br><span class="line">                    m_onlineIFENodeCount++;</span><br><span class="line">                &#125;</span><br><span class="line">                if (0x10000 == createOutputData.pNode-&gt;Type())</span><br><span class="line">                &#123;</span><br><span class="line">                    m_flags.hasIFENode = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if ((JPEGAggregator == createOutputData.pNode-&gt;Type()) || (0x10001 == createOutputData.pNode-&gt;Type()))</span><br><span class="line">                &#123;</span><br><span class="line">                    m_flags.hasJPEGNode = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                m_ppNodes[nodeIndex] = createOutputData.pNode;</span><br><span class="line"></span><br><span class="line">                if ((TRUE == createOutputData.createFlags.isSinkBuffer) ||</span><br><span class="line">                    (TRUE == createOutputData.createFlags.isSinkNoBuffer))</span><br><span class="line">                &#123;</span><br><span class="line">                    m_nodesSinkOutPorts.nodeIndices[m_nodesSinkOutPorts.numNodes] = nodeIndex;</span><br><span class="line">                    m_nodesSinkOutPorts.numNodes++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if ((TRUE == createOutputData.createFlags.isSinkBuffer) &amp;&amp; (TRUE == createOutputData.createFlags.isInPlace))</span><br><span class="line">                &#123;</span><br><span class="line">                    pInplaceSinkBufferNode[numInPlaceSinkBufferNodes] = createOutputData.pNode;</span><br><span class="line">                    numInPlaceSinkBufferNodes++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TRUE == createOutputData.createFlags.isBypassable)</span><br><span class="line">                &#123;</span><br><span class="line">                    pBypassableNodes[numBypassableNodes] = createOutputData.pNode;</span><br><span class="line">                    numBypassableNodes++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if ((TRUE == createOutputData.createFlags.isSourceBuffer) || (Sensor == m_ppNodes[nodeIndex]-&gt;Type()))</span><br><span class="line">                &#123;</span><br><span class="line">                    m_nodesSourceInPorts.nodeIndices[m_nodesSourceInPorts.numNodes] = nodeIndex;</span><br><span class="line">                    m_nodesSourceInPorts.numNodes++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TRUE == createOutputData.createFlags.willNotifyConfigDone)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_numConfigDoneNodes++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TRUE == createOutputData.createFlags.hasDelayedNotification)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_isDelayedPipeline = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                nodeIndex++;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            // Set the input link of the nodes - basically connects output port of one node to input port of another</span><br><span class="line">            for (UINT nodeIndexInner = 0; nodeIndexInner &lt; m_nodeCount; nodeIndexInner++)</span><br><span class="line">            &#123;</span><br><span class="line">                const PerNodeInfo* pXMLNode = &amp;pPipelineInfo-&gt;pNodeInfo[nodeIndexInner];</span><br><span class="line"></span><br><span class="line">                for (UINT inputPortIndex = 0; inputPortIndex &lt; pXMLNode-&gt;inputPorts.numPorts; inputPortIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    const InputPortInfo* pInputPortInfo = &amp;pXMLNode-&gt;inputPorts.pPortInfo[inputPortIndex];</span><br><span class="line"></span><br><span class="line">                    if (FALSE == m_ppNodes[nodeIndexInner]-&gt;IsSourceBufferInputPort(inputPortIndex))</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_ppNodes[nodeIndexInner]-&gt;SetInputLink(inputPortIndex,</span><br><span class="line">                                                           pInputPortInfo-&gt;portId,</span><br><span class="line">                                                           m_ppNodes[pInputPortInfo-&gt;parentNodeIndex],</span><br><span class="line">                                                           pInputPortInfo-&gt;parentOutputPortId);</span><br><span class="line"></span><br><span class="line">                        m_ppNodes[nodeIndexInner]-&gt;SetUpLoopBackPorts(inputPortIndex);</span><br><span class="line"></span><br><span class="line">                        /// In the parent node&apos;s output port, Save this node as one of the output node connected to it.</span><br><span class="line">                        m_ppNodes[pInputPortInfo-&gt;parentNodeIndex]-&gt;AddOutputNodes(pInputPortInfo-&gt;parentOutputPortId,</span><br><span class="line">                                                                                   m_ppNodes[nodeIndexInner]);</span><br><span class="line"></span><br><span class="line">                        /// Update access device index list for the source port based on current nodes device index list</span><br><span class="line">                        /// At this point the source node which maintains the output buffer manager have the access information</span><br><span class="line">                        /// required for buffer manager creation.</span><br><span class="line">                        m_ppNodes[pInputPortInfo-&gt;parentNodeIndex]-&gt;AddOutputDeviceIndices(</span><br><span class="line">                            pInputPortInfo-&gt;parentOutputPortId,</span><br><span class="line">                            m_ppNodes[nodeIndexInner]-&gt;DeviceIndices(),</span><br><span class="line">                            m_ppNodes[nodeIndexInner]-&gt;DeviceIndexCount());</span><br><span class="line"></span><br><span class="line">                        const ImageFormat* pImageFormat = m_ppNodes[nodeIndexInner]-&gt;GetInputPortImageFormat(inputPortIndex);</span><br><span class="line">                        if (NULL != pImageFormat)</span><br><span class="line">                        &#123;</span><br><span class="line">                            CAMX_LOG_CONFIG(CamxLogGroupCore,</span><br><span class="line">                                          &quot;Topology: Pipeline[%s] &quot;</span><br><span class="line">                                          &quot;Link: Node::%s(outPort %d) --&gt; (inPort %d) Node::%s using format %d&quot;,</span><br><span class="line">                                          GetPipelineIdentifierString(),</span><br><span class="line">                                          m_ppNodes[pInputPortInfo-&gt;parentNodeIndex]-&gt;NodeIdentifierString(),</span><br><span class="line">                                          pInputPortInfo-&gt;parentOutputPortId,</span><br><span class="line">                                          pInputPortInfo-&gt;portId,</span><br><span class="line">                                          m_ppNodes[nodeIndexInner]-&gt;NodeIdentifierString(),</span><br><span class="line">                                          pImageFormat-&gt;format);</span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Node::%s Invalid pImageFormat&quot;,</span><br><span class="line">                                           m_ppNodes[nodeIndexInner]-&gt;NodeIdentifierString());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_ppNodes[nodeIndexInner]-&gt;SetupSourcePort(inputPortIndex, pInputPortInfo-&gt;portId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (TRUE == m_ppNodes[nodeIndexInner]-&gt;IsLoopBackNode())</span><br><span class="line">                &#123;</span><br><span class="line">                    m_ppNodes[nodeIndexInner]-&gt;EnableParentOutputPorts();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// @todo (CAMX-1015) Look into non recursive implementation</span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            for (UINT index = 0; index &lt; m_nodesSinkOutPorts.numNodes; index++)</span><br><span class="line">            &#123;</span><br><span class="line">                if (NULL != m_ppNodes[m_nodesSinkOutPorts.nodeIndices[index]])</span><br><span class="line">                &#123;</span><br><span class="line">                    m_ppNodes[m_nodesSinkOutPorts.nodeIndices[index]]-&gt;TriggerOutputPortStreamIdSetup();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;m_ppNodes or m_ppOrderedNodes is Null&quot;);</span><br><span class="line">        result = CamxResultENoMemory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Bypass node processing</span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        for (UINT index = 0; index &lt; numBypassableNodes; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            pBypassableNodes[index]-&gt;BypassNodeProcessing();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        for (UINT index = 0; index &lt; numInPlaceSinkBufferNodes; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            pInplaceSinkBufferNode[index]-&gt;TriggerInplaceProcessing();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        for (UINT index = 0; index &lt; m_nodesSinkOutPorts.numNodes; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_ASSERT((NULL != m_ppNodes) &amp;&amp; (NULL != m_ppNodes[m_nodesSinkOutPorts.nodeIndices[index]]));</span><br><span class="line"></span><br><span class="line">            Node* pNode = m_ppNodes[m_nodesSinkOutPorts.nodeIndices[index]];</span><br><span class="line"></span><br><span class="line">            result = pNode-&gt;TriggerBufferNegotiation();</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess != result)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_WARN(CamxLogGroupCore, &quot;Unable to satisfy node input buffer requirements, retrying with NV12&quot;);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            result = RenegotiateInputBufferRequirement(pCreateInputData, pCreateOutputData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess != result)</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_ASSERT_ALWAYS();</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;%s Creating Nodes Failed. Going to Destroy sequence&quot;, GetPipelineIdentifierString());</span><br><span class="line">        DestroyNodes();</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        UINT numInputs = 0;</span><br><span class="line"></span><br><span class="line">        for (UINT index = 0; index &lt; m_nodesSourceInPorts.numNodes; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            Node*                    pNode         = m_ppNodes[m_nodesSourceInPorts.nodeIndices[index]];</span><br><span class="line">            ChiPipelineInputOptions* pInputOptions = &amp;pCreateOutputData-&gt;pPipelineInputOptions[numInputs];</span><br><span class="line"></span><br><span class="line">            numInputs += pNode-&gt;FillPipelineInputOptions(pInputOptions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pCreateOutputData-&gt;numInputs = numInputs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-4-CreateSessions"><a href="#4-3-4-CreateSessions" class="headerlink" title="4.3.4 CreateSessions"></a>4.3.4 CreateSessions</h4><h5 id="4-3-4-1-CreateSessionsWithInputHALStream"><a href="#4-3-4-1-CreateSessionsWithInputHALStream" class="headerlink" title="4.3.4.1 CreateSessionsWithInputHALStream"></a>4.3.4.1 CreateSessionsWithInputHALStream</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// CameraUsecaseBase::CreateSessionsWithInputHALStream</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult CameraUsecaseBase::CreateSessionsWithInputHALStream(</span><br><span class="line">    ChiCallBacks* pCallbacks)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult result    = CDKResultSuccess;</span><br><span class="line">    BOOL inputHALStream = FALSE;</span><br><span class="line">    UINT numSessionsMinusOne = (m_numSessions &gt;= 1) ? (m_numSessions - 1) : 0;</span><br><span class="line"></span><br><span class="line">    for (INT sessionId = numSessionsMinusOne; sessionId &gt;= 0; sessionId--)</span><br><span class="line">    &#123;</span><br><span class="line">        Pipeline* pPipelines[MaxPipelinesPerSession] = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">        // Accumulate the pipeline pointers to an array to pass the session creation</span><br><span class="line">        for (UINT pipelineId = 0; pipelineId &lt; m_sessions[sessionId].numPipelines; pipelineId++)</span><br><span class="line">        &#123;</span><br><span class="line">            if (TRUE == m_sessions[sessionId].pipelines[pipelineId].isHALInputStream)</span><br><span class="line">            &#123;</span><br><span class="line">                inputHALStream = TRUE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pPipelines[pipelineId] = m_sessions[sessionId].pipelines[pipelineId].pPipeline;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (TRUE == inputHALStream)</span><br><span class="line">        &#123;</span><br><span class="line">            result = CreateSession(sessionId,</span><br><span class="line">                    pPipelines,</span><br><span class="line">                    pCallbacks);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (result != CDKResultSuccess)</span><br><span class="line">    &#123;</span><br><span class="line">        for (INT sessionId = m_numSessions - 1; sessionId &gt;= 0; sessionId--)</span><br><span class="line">        &#123;</span><br><span class="line">            if (NULL != m_sessions[sessionId].pSession)</span><br><span class="line">            &#123;</span><br><span class="line">                m_sessions[sessionId].pSession-&gt;Destroy(TRUE);</span><br><span class="line">                m_sessions[sessionId].pSession = NULL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-4-2-CreateSession"><a href="#4-3-4-2-CreateSession" class="headerlink" title="4.3.4.2 CreateSession"></a>4.3.4.2 CreateSession</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// CameraUsecaseBase::CreateSession</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult CameraUsecaseBase::CreateSession(</span><br><span class="line">        INT sessionId,</span><br><span class="line">        Pipeline** ppPipelines,</span><br><span class="line">        ChiCallBacks* pCallbacks)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult result = CDKResultSuccess;</span><br><span class="line"></span><br><span class="line">    CHX_LOG(&quot;Creating session %d &quot;, sessionId);</span><br><span class="line"></span><br><span class="line">    m_perSessionPvtData[sessionId].sessionId = sessionId;</span><br><span class="line">    m_perSessionPvtData[sessionId].pUsecase  = this;</span><br><span class="line"></span><br><span class="line">    if (NULL == m_sessions[sessionId].pSession)</span><br><span class="line">    &#123;</span><br><span class="line">        m_sessions[sessionId].pSession = Session::Create(ppPipelines,</span><br><span class="line">                m_sessions[sessionId].numPipelines,</span><br><span class="line">                &amp;pCallbacks[sessionId],</span><br><span class="line">                &amp;m_perSessionPvtData[sessionId]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (NULL == m_sessions[sessionId].pSession)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_ERROR(&quot;Failed to create offline session, sessionId: %d&quot;, sessionId);</span><br><span class="line">        result = CDKResultEFailed;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG(&quot;success Creating Session %d&quot;, sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-5-小结"><a href="#4-3-5-小结" class="headerlink" title="4.3.5 小结"></a>4.3.5 小结</h4><p>配置数据流是整个CamX-CHI流程比较重要的一环，其中主要包括两个阶段：</p>
<ol>
<li>选择UsecaseId</li>
<li>根据选择的UsecaseId创建Usecase</li>
</ol>
<p><strong>① 选择UsecaseId</strong></p>
<p>不同的UsecaseId分别对应的不同的应用场景，该阶段是通过调用UsecaseSelector::GetMatchingUsecase()方法来实现的，该函数中通过传入的operation_mode、num_streams配置数据流数量以及当前使用的Sensor个数来选择相应的UsecaseId，比如当numPhysicalCameras值大于1同时配置的数据流数量num_streams大于1时选择的就是UsecaseId::MultiCamera，表示当前采用的是双摄场景。</p>
<p><strong>② 创建Usecase</strong></p>
<p>根据之前选择的UsecaseId，通过UsecaseFactory来创建相应的Usecase，</p>
<p>其中Class Usecase是所有Usecase的基类，其中定义并实现了一些通用接口，CameraUsecaseBase继承于Usecase，并扩展了部分功能。AdvancedCameraUsecase又继承于CameraUsecaseBase，作为主要负责大部分场景的Usecase实现类，另外对于多摄场景，现提供了继承于AdvancedCameraUsecase的UsecaseMultiCamera来负责实现。</p>
<p>除了双摄场景，其它大部分场景使用的都是AdvancedCameraUsecase类来管理各项资源的。</p>
<p>在AdvancedCameraUsecase::Create方法中做了很多初始化操作，其中包括了以下几个阶段：</p>
<ol>
<li>获取XML文件中Usecase配置信息</li>
<li>创建Feature</li>
<li>保存数据流，重建Usecase的配置信息</li>
<li>调用父类CameraUsecaseBase的initialize方法，进行一些常规初始化工作</li>
</ol>
<p>接下来我们就这几个阶段逐一进行分析：</p>
<p><strong>1.获取XML文件中Usecase配置信息</strong></p>
<p>这一部分主要通过调用CameraUsecaseBase::GetXMLUsecaseByName方法进行实现。</p>
<p>该方法的主要操作是从PerNumTargetUsecases数组中找到匹配到给定的usecaseName的Usecase，并作为返回值返回给调用者，其中这里我们以”UsecaseZSL“为例进行分析，PerNumTargetUsecases的定义是在g_pipeline.h中，该文件是在编译过程中通过usecaseconverter.pl脚本将定义在个平台目录下的common_usecase.xml中的内容转换生成g_pipeline.h。</p>
<p><strong>2.创建Feature</strong></p>
<p>如果当前场景选取了Feature，则调用FeatureSetup来完成创建工作。</p>
<p>该方法主要是通过诸如operation_mode、camera数量以及UsecaseId等信息来决定需要选择哪些Feature,具体逻辑比较清晰，一旦决定需要使用哪一个Feature之后，便调用相应的Feature的Create()方法进行初始化操作。</p>
<p><strong>3.保存数据流，重建Usecase的配置信息</strong></p>
<p>从Camera Service 传入的数据流，需要将其存储下来，供后续使用，同时高通针对Usecase也加入了Override机制，根据需要可以选择性地扩展Usecase，这两个步骤的实现主要是通过SelectUsecaseConfig方法来实现。</p>
<p>其中主要是调用以下两个方法来实现的：</p>
<ul>
<li>ConfigureStream： 该方法将从上层配置的数据流指针存入AdvancedCameraUsecase中，其中包括了用于预览的m_pPreviewStream以及用于拍照的m_pSnapshotStream。</li>
<li>BuildUsecase： 这个方法用来重新在原有的Usecase上面加入了Feature中所需要的pipeline，并创建了一个新的Usecase，并将其存入AdvancedCameraUsecase中的m_pChiUsecase成员变量中，紧接着通过SetPipelineToSessionMapping方法将pipeline与Session进行关联。</li>
</ul>
<p><strong>4.调用父类CameraUsecaseBase的initialize方法，进行一些常规初始化工作</strong></p>
<p>该方法中的操作主要有以下三个：</p>
<ul>
<li>设置Session回调</li>
<li>创建Pipeline</li>
<li>创建Session</li>
</ul>
<p><strong>设置Session回调</strong></p>
<p>该方法有两个参数，第二个是缺省的，第一个是ChiCallBacks，该参数是作为创建的每一条Session的回调方法，当Session中的pipeline全部跑完之后，会回调该方法将数据投递到CHI中。</p>
<p><strong>创建Pipeline</strong></p>
<p>根据之前获取的pipeline信息开始创建每一条pipeline，通过调用CreatePipeline()方法实现。</p>
<p><strong>创建Session</strong></p>
<p>创建Session，通过CreateSession()方法实现，此时会将AdvancedCameraUsecase端的回调函数注册到Session中，一旦Session中数据处理完成，便会调用回调将数据回传给AdvancedCameraUsecase。</p>
<p>综上，整个configure_stream过程，基本可以概括为以下几点：</p>
<ol>
<li>根据operation_mode、camera 个数以及stream的配置信息选取了对应的UsecaseId</li>
<li>根据所选取的UsecaseId，使用UsecaseFactory简单工厂类创建了用于管理整个场景下所有资源的AdvancedCameraUsecase对象。</li>
<li>创建AdvancedCameraUsecase对象是通过调用其Create()方法完成，该方法中获取了common_usecase.xml定义的关于Usecase的配置信息，之后又根据需要创建了Feature并选取了Feature所需的pipeline，并通过Override机制将Feature中所需要的Pipeline加入重建后的Usecase中。</li>
<li>最后通过调用CameraUsecaseBaese的initialize方法依次创建了各个pipeline以及Session，并且将AdvancedCameraUsecase的成员方法注册到Session，用于Session将数据返回给Usecase中</li>
</ol>
<h3 id="4-4-处理拍照请求"><a href="#4-4-处理拍照请求" class="headerlink" title="4.4 处理拍照请求"></a>4.4 处理拍照请求</h3><p>当用户打开相机应用进行预览或者点击一次拍照操作的时候，便触发了一次拍照请求，该动作首先通过CameraDeviceSession的capture或者setRepeatingRequest方法将请求通过Camera api v2接口下发到Camera Service中，然后在Camera Service内部将此次请求发送到CameraDevice::RequestThread线程中进行处理，一旦进入到该线程之后，便会最终通过HIDL接口ICameraCaptureSession:processCaptureRequest_3_4将请求发送至Provider中，之后当Provider收到请求之后，会调用camera3_device_t结构体的process_capture_request开始了HAL针对此次Request的处理，而该处理是由CamX-CHI来负责实现，现在我们就来看下CamX-CHI是如何实现该方法的：</p>
<h4 id="4-4-1-process-capture-request"><a href="#4-4-1-process-capture-request" class="headerlink" title="4.4.1 process_capture_request"></a>4.4.1 process_capture_request</h4><h5 id="4-4-1-1-camxhal3entry-gt-process-capture-request"><a href="#4-4-1-1-camxhal3entry-gt-process-capture-request" class="headerlink" title="4.4.1.1 camxhal3entry-&gt;process_capture_request"></a>4.4.1.1 camxhal3entry-&gt;process_capture_request</h5><p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3entry.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// process_capture_request</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">int process_capture_request(</span><br><span class="line">    const struct camera3_device*    pCamera3DeviceAPI,</span><br><span class="line">    camera3_capture_request_t*      pCaptureRequestAPI)</span><br><span class="line">&#123;</span><br><span class="line">    JumpTableHAL3* pHAL3 = static_cast&lt;JumpTableHAL3*&gt;(g_dispatchHAL3.GetJumpTable());</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(pHAL3);</span><br><span class="line">    CAMX_ASSERT(pHAL3-&gt;process_capture_request);</span><br><span class="line"></span><br><span class="line">    return pHAL3-&gt;process_capture_request(pCamera3DeviceAPI, pCaptureRequestAPI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-2-camxhal3-gt-configure-streams"><a href="#4-4-1-2-camxhal3-gt-configure-streams" class="headerlink" title="4.4.1.2 camxhal3-&gt;configure_streams"></a>4.4.1.2 camxhal3-&gt;configure_streams</h5><p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhal3.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// process_capture_request</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">static int process_capture_request(</span><br><span class="line">    const struct camera3_device*    pCamera3DeviceAPI,</span><br><span class="line">    camera3_capture_request_t*      pCaptureRequestAPI)</span><br><span class="line">&#123;</span><br><span class="line">    UINT64 frameworkFrameNum = 0;</span><br><span class="line"></span><br><span class="line">    if (NULL != pCaptureRequestAPI)</span><br><span class="line">    &#123;</span><br><span class="line">        frameworkFrameNum = pCaptureRequestAPI-&gt;frame_number;</span><br><span class="line">    &#125;</span><br><span class="line">    const StaticSettings* pSettings         = HwEnvironment::GetInstance()-&gt;GetStaticSettings();</span><br><span class="line">    HALDevice* pHALDevice = GetHALDevice(pCamera3DeviceAPI);</span><br><span class="line">    CAMX_LOG_ERROR(CamxLogGroupHAL,&quot; enable Live Tuning %d&quot;, pSettings-&gt;enableLiveTuning);</span><br><span class="line">    INT32 cameraID = pHALDevice-&gt;GetCameraId();</span><br><span class="line">    if ((pSettings-&gt;enableLiveTuning==1) &amp;&amp; (frameworkFrameNum % 5 ==0))</span><br><span class="line">    &#123;</span><br><span class="line">        HwEnvironment::GetInstance()-&gt;GetSensorInfo(cameraID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CAMX_ENTRYEXIT_SCOPE_ID(CamxLogGroupHAL, SCOPEEventHAL3ProcessCaptureRequest, frameworkFrameNum);</span><br><span class="line"></span><br><span class="line">    CAMX_TRACE_ASYNC_BEGIN_F(CamxLogGroupHAL, frameworkFrameNum, &quot;HAL3: RequestTrace&quot;);</span><br><span class="line"></span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != pCamera3DeviceAPI);</span><br><span class="line">    CAMX_ASSERT(NULL != pCamera3DeviceAPI-&gt;priv);</span><br><span class="line">    CAMX_ASSERT(NULL != pCaptureRequestAPI);</span><br><span class="line">    CAMX_ASSERT(pCaptureRequestAPI-&gt;num_output_buffers &gt; 0);</span><br><span class="line">    CAMX_ASSERT(NULL != pCaptureRequestAPI-&gt;output_buffers);</span><br><span class="line"></span><br><span class="line">    if ((NULL != pCamera3DeviceAPI)                  &amp;&amp;</span><br><span class="line">        (NULL != pCamera3DeviceAPI-&gt;priv)            &amp;&amp;</span><br><span class="line">        (NULL != pCaptureRequestAPI)                 &amp;&amp;</span><br><span class="line">        (pCaptureRequestAPI-&gt;num_output_buffers &gt; 0) &amp;&amp;</span><br><span class="line">        (NULL != pCaptureRequestAPI-&gt;output_buffers))</span><br><span class="line">    &#123;</span><br><span class="line">        /// @todo (CAMX-337): Go deeper into camera3_capture_request_t struct for validation</span><br><span class="line"></span><br><span class="line">        HALDevice*                 pHALDevice      = GetHALDevice(pCamera3DeviceAPI);</span><br><span class="line">        Camera3CaptureRequest*     pRequest        = reinterpret_cast&lt;Camera3CaptureRequest*&gt;(pCaptureRequestAPI);</span><br><span class="line">        camera3_capture_request_t&amp; rCaptureRequest = *pCaptureRequestAPI;</span><br><span class="line">        BINARY_LOG(LogEvent::HAL3_ProcessCaptureRequest, rCaptureRequest);</span><br><span class="line"></span><br><span class="line">        CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;frame_number %d, settings %p, num_output_buffers %d&quot;,</span><br><span class="line">                      pCaptureRequestAPI-&gt;frame_number,</span><br><span class="line">                      pCaptureRequestAPI-&gt;settings,</span><br><span class="line">                      pCaptureRequestAPI-&gt;num_output_buffers);</span><br><span class="line"></span><br><span class="line">        uint32_t frame_number      = rCaptureRequest.frame_number;</span><br><span class="line">        BOOL     isCaptureBuffer   = FALSE;</span><br><span class="line">        BOOL     isReprocessBuffer = FALSE;</span><br><span class="line">        if (NULL != pCaptureRequestAPI-&gt;output_buffers)</span><br><span class="line">        &#123;</span><br><span class="line">            for (UINT i = 0; i &lt; pCaptureRequestAPI-&gt;num_output_buffers; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                const camera3_stream_buffer_t&amp; rBuffer = pCaptureRequestAPI-&gt;output_buffers[i];</span><br><span class="line">                isCaptureBuffer                        = TRUE;</span><br><span class="line">                isReprocessBuffer                      = FALSE;</span><br><span class="line">                BINARY_LOG(LogEvent::HAL3_BufferInfo, frame_number, rBuffer, isCaptureBuffer, isReprocessBuffer);</span><br><span class="line">                CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;    output_buffers[%d] : %p, buffer: %p, status: %08x, stream: %p&quot;,</span><br><span class="line">                              i,</span><br><span class="line">                              &amp;pCaptureRequestAPI-&gt;output_buffers[i],</span><br><span class="line">                              pCaptureRequestAPI-&gt;output_buffers[i].buffer,</span><br><span class="line">                              pCaptureRequestAPI-&gt;output_buffers[i].status,</span><br><span class="line">                              pCaptureRequestAPI-&gt;output_buffers[i].stream);</span><br><span class="line">                if (HAL_PIXEL_FORMAT_BLOB == pCaptureRequestAPI-&gt;output_buffers[i].stream-&gt;format)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_TRACE_ASYNC_BEGIN_F(CamxLogGroupHAL, pCaptureRequestAPI-&gt;frame_number, &quot;SNAPSHOT frameID: %d&quot;,</span><br><span class="line">                        pCaptureRequestAPI-&gt;frame_number);</span><br><span class="line">                    CAMX_TRACE_ASYNC_BEGIN_F(CamxLogGroupHAL, pCaptureRequestAPI-&gt;frame_number, &quot;SHUTTERLAG frameID: %d&quot;,</span><br><span class="line">                        pCaptureRequestAPI-&gt;frame_number);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (NULL != pCaptureRequestAPI-&gt;input_buffer)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            const camera3_stream_buffer_t&amp; rBuffer = *pCaptureRequestAPI-&gt;input_buffer;</span><br><span class="line">            isCaptureBuffer                        = FALSE;</span><br><span class="line">            isReprocessBuffer                      = TRUE;</span><br><span class="line">            BINARY_LOG(LogEvent::HAL3_BufferInfo, frame_number, rBuffer, isCaptureBuffer, isReprocessBuffer);</span><br><span class="line">            CAMX_LOG_CONFIG(CamxLogGroupHAL, &quot;    input_buffer %p, buffer: %p, status: %08x, stream: %p&quot;,</span><br><span class="line">                          pCaptureRequestAPI-&gt;input_buffer,</span><br><span class="line">                          pCaptureRequestAPI-&gt;input_buffer-&gt;buffer,</span><br><span class="line">                          pCaptureRequestAPI-&gt;input_buffer-&gt;status,</span><br><span class="line">                          pCaptureRequestAPI-&gt;input_buffer-&gt;stream);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if (CAMX_IS_TRACE_ENABLED(CamxLogGroupCore))</span><br><span class="line">        &#123;</span><br><span class="line">            pHALDevice-&gt;TraceZoom(pCaptureRequestAPI);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = pHALDevice-&gt;ProcessCaptureRequest(pRequest);</span><br><span class="line"></span><br><span class="line">        if ((CamxResultSuccess != result) &amp;&amp; (CamxResultEInvalidArg != result))</span><br><span class="line">        &#123;</span><br><span class="line">            // HAL interface requires -ENODEV (EFailed) if a fatal error occurs</span><br><span class="line">            result = CamxResultEFailed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;Invalid argument(s) for process_capture_request()&quot;);</span><br><span class="line">        // HAL interface requires -EINVAL (EInvalidArg) for invalid arguments</span><br><span class="line">        result = CamxResultEInvalidArg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return Utils::CamxResultToErrno(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-3-HALDevice-ProcessCaptureRequest"><a href="#4-4-1-3-HALDevice-ProcessCaptureRequest" class="headerlink" title="4.4.1.3 HALDevice::ProcessCaptureRequest"></a>4.4.1.3 HALDevice::ProcessCaptureRequest</h5><p>[-&gt;vendor\qcom\proprietary\camx\src\core\hal\camxhaldevice.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// HALDevice::ProcessCaptureRequest</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CamxResult HALDevice::ProcessCaptureRequest(</span><br><span class="line">    Camera3CaptureRequest* pRequest)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult result = CamxResultEFailed;</span><br><span class="line"></span><br><span class="line">    if (TRUE == IsCHIModuleInitialized())</span><br><span class="line">    &#123;</span><br><span class="line">        // Keep track of information related to request for error conditions</span><br><span class="line">        PopulateFrameworkRequestBuffer(pRequest);</span><br><span class="line"></span><br><span class="line">        CAMX_LOG_INFO(CamxLogGroupHAL,</span><br><span class="line">                      &quot;CHIModule: Original framework framenumber %d contains %d output buffers&quot;,</span><br><span class="line">                      pRequest-&gt;frameworkFrameNum,</span><br><span class="line">                      pRequest-&gt;numOutputBuffers);</span><br><span class="line"></span><br><span class="line">        result = GetCHIAppCallbacks()-&gt;chi_override_process_request(reinterpret_cast&lt;const camera3_device*&gt;(&amp;m_camera3Device),</span><br><span class="line">                                                                    reinterpret_cast&lt;camera3_capture_request_t*&gt;(pRequest),</span><br><span class="line">                                                                    NULL);</span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            // Remove the request from the framework data list if the request fails</span><br><span class="line">            RemoveFrameworkRequestBuffer(pRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupHAL, &quot;CHIModule disabled, rejecting HAL request&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(CamxResultSuccess == result);</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-4-chi-override-process-request"><a href="#4-4-1-4-chi-override-process-request" class="headerlink" title="4.4.1.4 chi_override_process_request"></a>4.4.1.4 chi_override_process_request</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiframework\chxextensioninterface.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// @brief Process request call</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">static CDKResult chi_override_process_request(</span><br><span class="line">    const camera3_device_t*     camera3_device,</span><br><span class="line">    camera3_capture_request_t*  capture_request,</span><br><span class="line">    void*                       priv)</span><br><span class="line">&#123;</span><br><span class="line">    ExtensionModule* pExtensionModule = ExtensionModule::GetInstance();</span><br><span class="line"></span><br><span class="line">    return pExtensionModule-&gt;OverrideProcessRequest(camera3_device, capture_request, priv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-5-OverrideProcessRequest"><a href="#4-4-1-5-OverrideProcessRequest" class="headerlink" title="4.4.1.5 OverrideProcessRequest"></a>4.4.1.5 OverrideProcessRequest</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiframework\chxextensionmodule.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// ExtensionModule::OverrideProcessRequest</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult ExtensionModule::OverrideProcessRequest(</span><br><span class="line">    const camera3_device_t*     camera3_device,</span><br><span class="line">    camera3_capture_request_t*  pCaptureRequest,</span><br><span class="line">    VOID*                       pPriv)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult result = CDKResultSuccess;</span><br><span class="line"></span><br><span class="line">    for (UINT32 i = 0; i &lt; pCaptureRequest-&gt;num_output_buffers; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        if (NULL != pCaptureRequest-&gt;output_buffers)</span><br><span class="line">        &#123;</span><br><span class="line">            ChxUtils::WaitOnAcquireFence(&amp;pCaptureRequest-&gt;output_buffers[i]);</span><br><span class="line"></span><br><span class="line">            INT*   pAcquireFence = (INT*)&amp;pCaptureRequest-&gt;output_buffers[i].acquire_fence;</span><br><span class="line"></span><br><span class="line">            *pAcquireFence = -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UINT32 logicalCameraId = GetCameraIdfromDevice(camera3_device);</span><br><span class="line">    if (CDKInvalidId != logicalCameraId)</span><br><span class="line">    &#123;</span><br><span class="line">        if (NULL != pCaptureRequest-&gt;settings)</span><br><span class="line">        &#123;</span><br><span class="line">            FreeLastKnownRequestSetting(logicalCameraId);</span><br><span class="line">            m_pLastKnownRequestSettings[logicalCameraId] = allocate_copy_camera_metadata_checked(pCaptureRequest-&gt;settings,</span><br><span class="line">                get_camera_metadata_size(pCaptureRequest-&gt;settings));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Set valid metadata after flush if settings aren&apos;t available</span><br><span class="line">        if ((TRUE == m_hasFlushOccurred[logicalCameraId]) &amp;&amp;</span><br><span class="line">            (NULL == pCaptureRequest-&gt;settings))</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_INFO(&quot;Setting Request to m_pLastKnownRequestSettings after flush for frame_number:%d&quot;,</span><br><span class="line">                pCaptureRequest-&gt;frame_number);</span><br><span class="line">            pCaptureRequest-&gt;settings = m_pLastKnownRequestSettings[logicalCameraId];</span><br><span class="line">            m_hasFlushOccurred[logicalCameraId] = FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (TRUE == static_cast&lt;BOOL&gt;(ChxUtils::AtomicLoadU32(&amp;m_aFlushInProgress[logicalCameraId])))</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_INFO(&quot;flush enabled, frame %d&quot;, pCaptureRequest-&gt;frame_number);</span><br><span class="line">            HandleProcessRequestErrorAllPCRs(pCaptureRequest, logicalCameraId);</span><br><span class="line">            return CDKResultSuccess;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (ChxUtils::AndroidMetadata::IsLongExposureCapture(const_cast&lt;camera_metadata_t*&gt;(pCaptureRequest-&gt;settings)))</span><br><span class="line">        &#123;</span><br><span class="line">            ChxUtils::AtomicStoreU32(&amp;m_aLongExposureInProgress[logicalCameraId], TRUE);</span><br><span class="line">            m_longExposureFrame[logicalCameraId] = pCaptureRequest-&gt;frame_number;</span><br><span class="line">            CHX_LOG_INFO(&quot;Long exposure enabled in frame %d&quot;, pCaptureRequest-&gt;frame_number);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pRecoveryLock[logicalCameraId]-&gt;Lock();</span><br><span class="line">        if (TRUE == m_RecoveryInProgress[logicalCameraId])</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_INFO(&quot;Wait for recovery to finish, before proceeding with new request for cameraId: %d&quot;, logicalCameraId);</span><br><span class="line">            m_pRecoveryCondition[logicalCameraId]-&gt;Wait(m_pRecoveryLock[logicalCameraId]-&gt;GetNativeHandle());</span><br><span class="line">        &#125;</span><br><span class="line">        m_pRecoveryLock[logicalCameraId]-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">        // Save the original metadata</span><br><span class="line">        const camera_metadata_t* pOriginalMetadata = pCaptureRequest-&gt;settings;</span><br><span class="line">        (VOID)pPriv;</span><br><span class="line"></span><br><span class="line">        m_pPCRLock[logicalCameraId]-&gt;Lock();</span><br><span class="line">        if (NULL != m_pSelectedUsecase[logicalCameraId])</span><br><span class="line">        &#123;</span><br><span class="line">            m_originalFrameWorkNumber[logicalCameraId] = pCaptureRequest-&gt;frame_number;</span><br><span class="line"></span><br><span class="line">            // Recovery happened if framework didn&apos;t send any metadata, send valid metadata</span><br><span class="line">            if (m_firstFrameAfterRecovery[logicalCameraId] == pCaptureRequest-&gt;frame_number &amp;&amp;</span><br><span class="line">                NULL == pCaptureRequest-&gt;settings)</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_INFO(&quot;Setting Request for first frame after case =%d&quot;, m_firstFrameAfterRecovery[logicalCameraId]);</span><br><span class="line">                pCaptureRequest-&gt;settings = m_pLastKnownRequestSettings[logicalCameraId];</span><br><span class="line">                m_firstFrameAfterRecovery[logicalCameraId] = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (pCaptureRequest-&gt;output_buffers != NULL)</span><br><span class="line">            &#123;</span><br><span class="line">                for (UINT i = 0; i &lt; pCaptureRequest-&gt;num_output_buffers; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    if ((NULL != m_pPerfLockManager[logicalCameraId]) &amp;&amp;</span><br><span class="line">                        (pCaptureRequest-&gt;output_buffers[i].stream-&gt;format == ChiStreamFormatBlob) &amp;&amp;</span><br><span class="line">                        ((pCaptureRequest-&gt;output_buffers[i].stream-&gt;data_space ==</span><br><span class="line">                            static_cast&lt;android_dataspace_t&gt;(DataspaceV0JFIF)) ||</span><br><span class="line">                        (pCaptureRequest-&gt;output_buffers[i].stream-&gt;data_space ==</span><br><span class="line">                            static_cast&lt;android_dataspace_t&gt;(DataspaceJFIF))))</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_pPerfLockManager[logicalCameraId]-&gt;AcquirePerfLock(PERF_LOCK_SNAPSHOT_CAPTURE, 2000);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if ((NULL != m_pPerfLockManager[logicalCameraId]) &amp;&amp;</span><br><span class="line">                        TRUE == UsecaseSelector::IsHEIFStream(pCaptureRequest-&gt;output_buffers[i].stream))</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_pPerfLockManager[logicalCameraId]-&gt;AcquirePerfLock(PERF_LOCK_SNAPSHOT_CAPTURE, 2000);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            result = m_pSelectedUsecase[logicalCameraId]-&gt;ProcessCaptureRequest(pCaptureRequest);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (pCaptureRequest-&gt;settings != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            // Restore the original metadata pointer that came from the framework</span><br><span class="line">            pCaptureRequest-&gt;settings = pOriginalMetadata;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Need to return success on PCR to allow FW to continue sending requests</span><br><span class="line">        if (result == CDKResultEBusy)</span><br><span class="line">        &#123;</span><br><span class="line">            result = CDKResultSuccess;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (result == CamxResultECancelledRequest)</span><br><span class="line">        &#123;</span><br><span class="line">            // Ignore the Failure if flush or recovery returned CamcelRequest</span><br><span class="line">            CHX_LOG(&quot;Flush/Recovery is in progress %d and so ignore failure&quot;, pCaptureRequest-&gt;frame_number);</span><br><span class="line">            result = CDKResultSuccess;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pPCRLock[logicalCameraId]-&gt;Unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_ERROR(&quot;Invalid logical camera id device:%p!!&quot;, camera3_device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-6-Usecase-ProcessCaptureRequest"><a href="#4-4-1-6-Usecase-ProcessCaptureRequest" class="headerlink" title="4.4.1.6 Usecase::ProcessCaptureRequest"></a>4.4.1.6 Usecase::ProcessCaptureRequest</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiframework\chxusecase.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// Usecase::ProcessCaptureRequest</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult Usecase::ProcessCaptureRequest(</span><br><span class="line">    camera3_capture_request_t* pRequest)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult                result               = CDKResultSuccess;</span><br><span class="line">    UINT32                   chiOverrideFrameNum  = GetChiOverrideFrameNum();</span><br><span class="line">    UINT32                   resultFrameIndexChi  = chiOverrideFrameNum % MaxOutstandingRequests;</span><br><span class="line">    UINT32                   frameworkFrameNum    = pRequest-&gt;frame_number;</span><br><span class="line">    camera3_capture_request* pPendingPCRSlot      = &amp;m_pendingPCRs[resultFrameIndexChi];</span><br><span class="line">    UINT32                   cameraId             = GetCameraId();</span><br><span class="line"></span><br><span class="line">    /// Chi override frame number is what the rest of the override module knows. The original application frame number is only</span><br><span class="line">    /// known to this class and no one else. Hence any result communication to application needs to go thru this class strictly</span><br><span class="line"></span><br><span class="line">    m_pMapLock-&gt;Lock();</span><br><span class="line"></span><br><span class="line">    if (FALSE == m_requestFlags[resultFrameIndexChi].isInErrorState)</span><br><span class="line">    &#123;</span><br><span class="line">        // Old request not returned yet. Flush its result result first</span><br><span class="line">        if (0 != m_numberOfPendingOutputBuffers[resultFrameIndexChi])</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;Chi Frame: %d hasn&apos;t returned a result and will be canceled in favor of Chi Frame: %d. Index: %d&quot;,</span><br><span class="line">                          pPendingPCRSlot-&gt;frame_number,</span><br><span class="line">                          pRequest-&gt;frame_number,</span><br><span class="line">                          resultFrameIndexChi);</span><br><span class="line">            HandleProcessRequestError(pPendingPCRSlot);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (FALSE == m_requestFlags[resultFrameIndexChi].isOutputMetaDataSent)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;Pending metadata in PCR. ChiOverrideFrame: %d, Last Request Frame: %&quot; PRIu64,</span><br><span class="line">                          chiOverrideFrameNum - MaxOutstandingRequests,</span><br><span class="line">                          m_lastAppRequestFrame);</span><br><span class="line"></span><br><span class="line">            // We reached max number of outstanding requests but metadata is not sent. Most probably errored out.</span><br><span class="line">            // Send Metadata error for this frame.</span><br><span class="line"></span><br><span class="line">            // release metadata also.</span><br><span class="line">            if (NULL != m_captureResult[resultFrameIndexChi].result)</span><br><span class="line">            &#123;</span><br><span class="line">                m_pMetadataManager-&gt;ReleaseAndroidFrameworkOutputMetadata(</span><br><span class="line">                    m_captureResult[resultFrameIndexChi].result);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            HandleResultError(pPendingPCRSlot);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AssignChiOverrideFrameNum(pRequest-&gt;frame_number);</span><br><span class="line">    pRequest-&gt;frame_number = chiOverrideFrameNum;</span><br><span class="line"></span><br><span class="line">    CHX_LOG(&quot;Saving buffer for CHI Frame: %d, requestFrame: %d, NumBuff: %d resultFrameIndexChi: %d&quot;,</span><br><span class="line">            chiOverrideFrameNum,</span><br><span class="line">            frameworkFrameNum,</span><br><span class="line">            pRequest-&gt;num_output_buffers,</span><br><span class="line">            resultFrameIndexChi);</span><br><span class="line"></span><br><span class="line">    // Set pending output buffers after clearing the previous one</span><br><span class="line">    m_numAppPendingOutputBuffers[resultFrameIndexChi]   = pRequest-&gt;num_output_buffers;</span><br><span class="line">    m_numberOfPendingOutputBuffers[resultFrameIndexChi] = pRequest-&gt;num_output_buffers;</span><br><span class="line">    m_numBufferErrorMessages[resultFrameIndexChi]       = 0;</span><br><span class="line"></span><br><span class="line">    m_requestFlags[resultFrameIndexChi].value               = 0; // Reset all flags</span><br><span class="line">    m_requestFlags[resultFrameIndexChi].isMessagePending    = TRUE;</span><br><span class="line">    pPendingPCRSlot-&gt;frame_number       = chiOverrideFrameNum;</span><br><span class="line">    pPendingPCRSlot-&gt;num_output_buffers = pRequest-&gt;num_output_buffers;</span><br><span class="line">    pPendingPCRSlot-&gt;input_buffer       = pRequest-&gt;input_buffer;</span><br><span class="line"></span><br><span class="line">    if (InvalidFrameNumber == m_nextAppMessageFrame)</span><br><span class="line">    &#123;</span><br><span class="line">        m_nextAppMessageFrame           = chiOverrideFrameNum;</span><br><span class="line">        m_lastAppMessageFrameReceived   = chiOverrideFrameNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (InvalidFrameNumber == m_nextAppResultFrame)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_SET_AND_LOG_UINT64(m_nextAppResultFrame, chiOverrideFrameNum);</span><br><span class="line">        m_nextAppMessageFrame        = chiOverrideFrameNum;</span><br><span class="line">        m_lastAppRequestFrame        = chiOverrideFrameNum;</span><br><span class="line">        m_lastResultMetadataFrameNum = m_nextAppMessageFrame - 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL isSnapshotStream = FALSE;</span><br><span class="line"></span><br><span class="line">    for (UINT i = 0; i &lt; pRequest-&gt;num_output_buffers; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        if (&amp;pRequest-&gt;output_buffers[i] == NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        CHX_LOG(&quot;SAVING frame: %d resultFrameIndexChi: %d&quot;, frameworkFrameNum, resultFrameIndexChi);</span><br><span class="line">        ChxUtils::Memcpy(const_cast&lt;camera3_stream_buffer_t*&gt;(&amp;pPendingPCRSlot-&gt;output_buffers[i]),</span><br><span class="line">                         &amp;pRequest-&gt;output_buffers[i],</span><br><span class="line">                         sizeof(camera3_stream_buffer_t));</span><br><span class="line">        if ((UsecaseSelector::IsJPEGSnapshotStream(pRequest-&gt;output_buffers[i].stream)) ||</span><br><span class="line">            (UsecaseSelector::IsHEIFStream(pRequest-&gt;output_buffers[i].stream)))</span><br><span class="line">        &#123;</span><br><span class="line">            isSnapshotStream = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UINT32 isZSLMode = 0;</span><br><span class="line">    isZSLMode        = ChxUtils::AndroidMetadata::GetZSLMode(const_cast&lt;camera_metadata_t*&gt;(pRequest-&gt;settings));</span><br><span class="line"></span><br><span class="line">    if ((TRUE == isSnapshotStream) &amp;&amp; (1 == isZSLMode))</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_INFO(&quot;Frame: %u(idx: %u) is a Snapshot, Setting isSnapshotStream TRUE&quot;,</span><br><span class="line">            chiOverrideFrameNum, resultFrameIndexChi);</span><br><span class="line">        m_requestFlags[resultFrameIndexChi].isZSLMessageAvailable = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pMapLock-&gt;Unlock();</span><br><span class="line">    ResetMetadataStatus(pRequest);</span><br><span class="line">    ChxUtils::AtomicStore64(&amp;m_lastAppRequestFrame, chiOverrideFrameNum);</span><br><span class="line"></span><br><span class="line">    camera3_capture_result_t* pUsecaseResult = GetCaptureResult(resultFrameIndexChi);</span><br><span class="line">    pUsecaseResult-&gt;result                   = NULL;</span><br><span class="line">    pUsecaseResult-&gt;frame_number             = pRequest-&gt;frame_number;</span><br><span class="line">    pUsecaseResult-&gt;num_output_buffers       = 0;</span><br><span class="line"></span><br><span class="line">    if (FlushStatus::NotFlushing != GetFlushStatus())</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_INFO(&quot;Usecase is flushing. No requests will be generated for Framework Frame: %d&quot;, frameworkFrameNum);</span><br><span class="line">        HandleProcessRequestError(pPendingPCRSlot);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        if (NULL != pRequest-&gt;settings)</span><br><span class="line">        &#123;</span><br><span class="line">            // Replace the metadata by appending vendor tag for cropRegions</span><br><span class="line">            result = ReplaceRequestMetadata(pRequest-&gt;settings, cameraId);</span><br><span class="line">            if (CDKResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                pRequest-&gt;settings = m_pReplacedMetadata;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // The translation must be done in base class as it is also required for default usecase,</span><br><span class="line">            // which is used for most CTS/ITS cases.</span><br><span class="line">            if ((NULL  != m_pLogicalCameraInfo) &amp;&amp;</span><br><span class="line">                (TRUE  == UsecaseSelector::IsQuadCFASensor(m_pLogicalCameraInfo, NULL)) &amp;&amp;</span><br><span class="line">                (FALSE == ExtensionModule::GetInstance()-&gt;ExposeFullsizeForQuadCFA()))</span><br><span class="line">            &#123;</span><br><span class="line">                // map ROIs (aec/af/crop region) from binning active array size based to full active arrsy size based</span><br><span class="line">                result = OverrideInputMetaForQCFA(const_cast&lt;camera_metadata_t*&gt;(pRequest-&gt;settings));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess != result)</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_ERROR(&quot;OverrideInputMetaForQCFA Errored Out! Usecase:%d cameraId:%d in state: %s&quot;,</span><br><span class="line">                    GetUsecaseId(), GetCameraId(), CamxResultStrings[result]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = ExecuteCaptureRequest(pRequest);</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;ECR Errored Out! Usecase:%d cameraId:%d in state: %s&quot;,</span><br><span class="line">                GetUsecaseId(), GetCameraId(), CamxResultStrings[result]);</span><br><span class="line"></span><br><span class="line">            if (CDKResultETimeout == result)</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_ERROR(&quot;Usecase:%d cameraId:%d timed out - returning success to trigger recovery&quot;,</span><br><span class="line">                              GetUsecaseId(), GetCameraId());</span><br><span class="line">                result = CDKResultSuccess;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Restore the original metadata</span><br><span class="line">        RestoreRequestMetadata(pRequest, cameraId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // reset the frame number</span><br><span class="line">    pRequest-&gt;frame_number = frameworkFrameNum;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// Usecase::ReplaceRequestMetadata</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult Usecase::ReplaceRequestMetadata(</span><br><span class="line">    const VOID*                 pMetadata,</span><br><span class="line">    UINT32                      cameraId)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult result = CDKResultSuccess;</span><br><span class="line"></span><br><span class="line">    // Save the the original metadata</span><br><span class="line">    ExtensionModule::GetInstance()-&gt;SetOriginalMetadata(pMetadata, cameraId);</span><br><span class="line"></span><br><span class="line">    m_pReplacedMetadata = place_camera_metadata(m_pReplacedMetadata,</span><br><span class="line">                            m_replacedMetadataSize,</span><br><span class="line">                            ReplacedMetadataEntryCapacity,</span><br><span class="line">                            ReplacedMetadataDataCapacity);</span><br><span class="line"></span><br><span class="line">    // Add the existing metadata first before appending the new tags</span><br><span class="line">    result = append_camera_metadata(m_pReplacedMetadata, static_cast&lt;const camera_metadata_t*&gt;(pMetadata));</span><br><span class="line"></span><br><span class="line">    if (CDKResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        // Read the android crop region</span><br><span class="line">        camera_metadata_entry_t entry = &#123; 0 &#125;;</span><br><span class="line">        if (0 == find_camera_metadata_entry(m_pReplacedMetadata, ANDROID_SCALER_CROP_REGION, &amp;entry))</span><br><span class="line">        &#123;</span><br><span class="line">            CaptureRequestCropRegions cropRegions;</span><br><span class="line">            cropRegions.userCropRegion.left   = entry.data.i32[0];</span><br><span class="line">            cropRegions.userCropRegion.top    = entry.data.i32[1];</span><br><span class="line">            cropRegions.userCropRegion.width  = entry.data.i32[2];</span><br><span class="line">            cropRegions.userCropRegion.height = entry.data.i32[3];</span><br><span class="line"></span><br><span class="line">            CHIRECT* pUserZoom = reinterpret_cast&lt;CHIRECT*&gt;(&amp;cropRegions.userCropRegion);</span><br><span class="line">            cropRegions.pipelineCropRegion = *pUserZoom;</span><br><span class="line">            cropRegions.ifeLimitCropRegion = *pUserZoom;</span><br><span class="line"></span><br><span class="line">            // Set the cropRegions vendor tag data</span><br><span class="line">            ChxUtils::AndroidMetadata::SetVendorTagValue(m_pReplacedMetadata, VendorTag::CropRegions,</span><br><span class="line">                            sizeof(CaptureRequestCropRegions), &amp;cropRegions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-7-ExecuteCaptureRequest"><a href="#4-4-1-7-ExecuteCaptureRequest" class="headerlink" title="4.4.1.7 ExecuteCaptureRequest"></a>4.4.1.7 ExecuteCaptureRequest</h5><p>[-&gt;vendor\qcom\proprietary\chi-cdk\core\chiusecase\chxadvancedcamerausecase.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// AdvancedCameraUsecase::ExecuteCaptureRequest</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult AdvancedCameraUsecase::ExecuteCaptureRequest(</span><br><span class="line">    camera3_capture_request_t* pRequest)</span><br><span class="line">&#123;</span><br><span class="line">    CDKResult result     = CDKResultSuccess;</span><br><span class="line">    UINT      frameIndex = pRequest-&gt;frame_number % MaxOutstandingRequests;</span><br><span class="line">    Feature*  pFeature   = m_pActiveFeature;</span><br><span class="line"></span><br><span class="line">    CHX_LOG(&quot;AdvancedCameraUsecase::ExecuteCaptureRequest %u %u&quot;, pRequest-&gt;frame_number, frameIndex);</span><br><span class="line"></span><br><span class="line">    // swapping JPEG thumbnail size params</span><br><span class="line">    const ExtensionModule*      pExtModule = ExtensionModule::GetInstance();</span><br><span class="line">    BOOL isGpuOverrideSetting = pExtModule-&gt;UseGPUDownscaleUsecase() || pExtModule-&gt;UseGPURotationUsecase();</span><br><span class="line">    if( (TRUE == m_GpuNodePresence) &amp;&amp; (TRUE == isGpuOverrideSetting))</span><br><span class="line">    &#123;</span><br><span class="line">        if (NULL != pRequest-&gt;settings)</span><br><span class="line">        &#123;</span><br><span class="line">            // ANDROID_JPEG_ORIENTATION</span><br><span class="line">            INT32 JpegOrientation    = 0;</span><br><span class="line">            CDKResult result         = m_vendorTagOps.pGetMetaData(</span><br><span class="line">                                        const_cast&lt;VOID*&gt;</span><br><span class="line">                                        (reinterpret_cast&lt;const VOID*&gt;(pRequest-&gt;settings)),</span><br><span class="line">                                        ANDROID_JPEG_ORIENTATION,</span><br><span class="line">                                        &amp;JpegOrientation,</span><br><span class="line">                                        sizeof(INT32));</span><br><span class="line"></span><br><span class="line">            if (CDKResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                INT32*                  pIntentJpegSize = NULL;</span><br><span class="line"></span><br><span class="line">                if (JpegOrientation % 180)</span><br><span class="line">                &#123;</span><br><span class="line">                    JPEGThumbnailSize thumbnailSizeGet, thumbnailSizeSet;</span><br><span class="line">                    CDKResult result = m_vendorTagOps.pGetMetaData(</span><br><span class="line">                                        const_cast&lt;VOID*&gt;</span><br><span class="line">                                        (reinterpret_cast&lt;const VOID*&gt;(pRequest-&gt;settings)),</span><br><span class="line">                                        ANDROID_JPEG_THUMBNAIL_SIZE,</span><br><span class="line">                                        &amp;thumbnailSizeGet,</span><br><span class="line">                                        sizeof(JPEGThumbnailSize));</span><br><span class="line"></span><br><span class="line">                    if (CDKResultSuccess == result)</span><br><span class="line">                    &#123;</span><br><span class="line">                        thumbnailSizeSet.JpegThumbnailSize_0 = thumbnailSizeGet.JpegThumbnailSize_1;</span><br><span class="line">                        thumbnailSizeSet.JpegThumbnailSize_1 = thumbnailSizeGet.JpegThumbnailSize_0;</span><br><span class="line"></span><br><span class="line">                        CDKResult result = m_vendorTagOps.pSetMetaData(</span><br><span class="line">                                            const_cast&lt;VOID*&gt;</span><br><span class="line">                                            (reinterpret_cast&lt;const VOID*&gt;(pRequest-&gt;settings)),</span><br><span class="line">                                            ANDROID_JPEG_THUMBNAIL_SIZE,</span><br><span class="line">                                            &amp;thumbnailSizeSet,</span><br><span class="line">                                            sizeof(JPEGThumbnailSize));</span><br><span class="line"></span><br><span class="line">                        if (CDKResultSuccess == result)</span><br><span class="line">                        &#123;</span><br><span class="line">                            CDKResult result = m_vendorTagOps.pGetMetaData(</span><br><span class="line">                                                const_cast&lt;VOID*&gt;</span><br><span class="line">                                                (reinterpret_cast&lt;const VOID*&gt;(pRequest-&gt;settings)),</span><br><span class="line">                                                ANDROID_JPEG_THUMBNAIL_SIZE,</span><br><span class="line">                                                &amp;thumbnailSizeGet,</span><br><span class="line">                                                sizeof(JPEGThumbnailSize));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // exchange JPEG thumbnail</span><br><span class="line"></span><br><span class="line">    m_shutterTimestamp[frameIndex]              = 0;</span><br><span class="line"></span><br><span class="line">    result = UpdateFeatureModeIndex(const_cast&lt;camera_metadata_t*&gt;(pRequest-&gt;settings));</span><br><span class="line">    if (TRUE ==</span><br><span class="line">        ChxUtils::AndroidMetadata::IsVendorTagPresent(reinterpret_cast&lt;const VOID*&gt;(pRequest-&gt;settings),</span><br><span class="line">            VendorTag::VideoHDR10Mode))</span><br><span class="line">    &#123;</span><br><span class="line">        VOID* pData = NULL;</span><br><span class="line">        StreamHDRMode  HDRMode = StreamHDRMode::HDRModeNone;</span><br><span class="line">        ChxUtils::AndroidMetadata::GetVendorTagValue(reinterpret_cast&lt;const VOID*&gt;(pRequest-&gt;settings),</span><br><span class="line">            VendorTag::VideoHDR10Mode,</span><br><span class="line">            reinterpret_cast&lt;VOID**&gt;(&amp;pData));</span><br><span class="line">        if (NULL != pData)</span><br><span class="line">        &#123;</span><br><span class="line">            HDRMode = *(static_cast&lt;StreamHDRMode*&gt;(pData));</span><br><span class="line">            if (StreamHDRMode::HDRModeHDR10 == HDRMode)</span><br><span class="line">            &#123;</span><br><span class="line">                m_tuningFeature2Value = static_cast&lt;UINT32&gt;(ChiModeFeature2SubModeType::HDR10);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (StreamHDRMode::HDRModeHLG == HDRMode)</span><br><span class="line">            &#123;</span><br><span class="line">                m_tuningFeature2Value = static_cast&lt;UINT32&gt;(ChiModeFeature2SubModeType::HLG);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                m_tuningFeature2Value = 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (StreamConfigModeFastShutter == ExtensionModule::GetInstance()-&gt;GetOpMode(m_cameraId) &amp;&amp; NULL != pRequest-&gt;settings)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG(&quot;SetMetaData: StreamConfigModeFastShutter &quot;);</span><br><span class="line"></span><br><span class="line">        UINT8    isFSModeVendorTag = 1;</span><br><span class="line">        UINT32   FSModeTagId       = ExtensionModule::GetInstance()-&gt;GetVendorTagId(VendorTag::FastShutterMode);</span><br><span class="line">        result = m_vendorTagOps.pSetMetaData(</span><br><span class="line">            const_cast&lt;VOID*&gt;</span><br><span class="line">            (reinterpret_cast&lt;const VOID*&gt;(pRequest-&gt;settings)),</span><br><span class="line">            FSModeTagId,</span><br><span class="line">            &amp;isFSModeVendorTag,</span><br><span class="line">            sizeof(isFSModeVendorTag));</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;pSetMetaData failed result %d&quot;, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (TRUE == hasSnapshotStreamRequest(pRequest))</span><br><span class="line">    &#123;</span><br><span class="line">        WaitForDeferThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ChxUtils::Memset(&amp;m_snapshotFeatures[frameIndex], 0, sizeof(SnapshotFeatureList));</span><br><span class="line"></span><br><span class="line">    if (TRUE == AdvancedFeatureEnabled())</span><br><span class="line">    &#123;</span><br><span class="line">        for (UINT32 i = 0; i &lt; pRequest-&gt;num_output_buffers; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            if (m_pSnapshotStream == reinterpret_cast&lt;CHISTREAM*&gt;(pRequest-&gt;output_buffers[i].stream))</span><br><span class="line">            &#123;</span><br><span class="line">                pFeature = SelectFeatureToExecuteCaptureRequest(pRequest, 0);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (NULL != pFeature)</span><br><span class="line">        &#123;</span><br><span class="line">            m_shutterTimestamp[frameIndex] = 0;</span><br><span class="line">            result = pFeature-&gt;ExecuteProcessRequest(pRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_INFO(&quot;CameraUsecaseBase::ExecuteCaptureRequest()&quot;);</span><br><span class="line">        result = CameraUsecaseBase::ExecuteCaptureRequest(pRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-8-CameraUsecaseBase-ExecuteCaptureRequest"><a href="#4-4-1-8-CameraUsecaseBase-ExecuteCaptureRequest" class="headerlink" title="4.4.1.8 CameraUsecaseBase::ExecuteCaptureRequest"></a>4.4.1.8 CameraUsecaseBase::ExecuteCaptureRequest</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// CameraUsecaseBase::ExecuteCaptureRequest</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CDKResult CameraUsecaseBase::ExecuteCaptureRequest(</span><br><span class="line">    camera3_capture_request_t* pRequest)</span><br><span class="line">&#123;</span><br><span class="line">    // Base implementation finds the buffers that go to each output and invokes SubmitRequest for each pipeline with outputs</span><br><span class="line">    // If the advanced class wishes to use this function, but not invoke all the pipelines, the output produced from the disired</span><br><span class="line">    // inactive pipeline should be removed from the pRequest-&gt;output_buffers</span><br><span class="line">    CDKResult result = CDKResultSuccess;</span><br><span class="line"></span><br><span class="line">    CHX_LOG(&quot;CameraUsecaseBase::ExecuteCaptureRequest for frame %d with %d output buffers&quot;,</span><br><span class="line">        pRequest-&gt;frame_number, pRequest-&gt;num_output_buffers);</span><br><span class="line"></span><br><span class="line">    static const UINT32 NumOutputBuffers = 5;</span><br><span class="line"></span><br><span class="line">    UINT frameIndex = pRequest-&gt;frame_number % MaxOutstandingRequests;</span><br><span class="line"></span><br><span class="line">    if (InvalidId != m_rtSessionIndex)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT32 rtPipeline = m_sessions[m_rtSessionIndex].rtPipelineIndex;</span><br><span class="line"></span><br><span class="line">        if (InvalidId != rtPipeline)</span><br><span class="line">        &#123;</span><br><span class="line">            m_selectedSensorModeIndex =</span><br><span class="line">                m_sessions[m_rtSessionIndex].pipelines[rtPipeline].pPipeline-&gt;GetSensorModeInfo()-&gt;modeIndex;</span><br><span class="line">            result = UpdateSensorModeIndex(const_cast&lt;camera_metadata_t*&gt;(pRequest-&gt;settings));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (UINT session = 0; session &lt; MaxSessions; session++)</span><br><span class="line">    &#123;</span><br><span class="line">        BOOL bIsOffline = FALSE;</span><br><span class="line"></span><br><span class="line">        for (UINT pipeline = 0; pipeline &lt; m_sessions[session].numPipelines; pipeline++)</span><br><span class="line">        &#123;</span><br><span class="line">            if (NULL != pRequest-&gt;input_buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                bIsOffline = TRUE;</span><br><span class="line"></span><br><span class="line">                result = WaitForDeferThread();</span><br><span class="line"></span><br><span class="line">                if (CDKResultSuccess != result)</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_ERROR(&quot;Defer thread failure&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Skip submitting to realtime pipelines when an input buffer is provided</span><br><span class="line">                if (TRUE == m_sessions[session].pipelines[pipeline].pPipeline-&gt;IsRealTime())</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                // Skip submitting to offline pipelines when an input buffer is not provided</span><br><span class="line">                if (FALSE == m_sessions[session].pipelines[pipeline].pPipeline-&gt;IsRealTime())</span><br><span class="line">                &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CHISTREAMBUFFER outputBuffers[NumOutputBuffers] = &#123; &#123; 0 &#125; &#125;;</span><br><span class="line">            UINT32          outputCount                     = 0;</span><br><span class="line">            PipelineData*   pPipelineData                   = &amp;m_sessions[session].pipelines[pipeline];</span><br><span class="line"></span><br><span class="line">            for (UINT32 buffer = 0; buffer &lt; pRequest-&gt;num_output_buffers; buffer++)</span><br><span class="line">            &#123;</span><br><span class="line">                for (UINT stream = 0; stream &lt; pPipelineData-&gt;numStreams; stream++)</span><br><span class="line">                &#123;</span><br><span class="line">                    if ( (TRUE == bIsOffline) &amp;&amp;</span><br><span class="line">                        (FALSE == m_sessions[session].pipelines[pipeline].pPipeline-&gt;IsRealTime()) &amp;&amp;</span><br><span class="line">                        (TRUE  == m_bCloningNeeded) )</span><br><span class="line">                    &#123;</span><br><span class="line">                        UINT index = 0;</span><br><span class="line">                        if (TRUE == IsThisClonedStream(m_pClonedStream, pPipelineData-&gt;pStreams[stream], &amp;index))</span><br><span class="line">                        &#123;</span><br><span class="line">                            if ((reinterpret_cast&lt;CHISTREAM*&gt;(pRequest-&gt;output_buffers[buffer].stream) ==</span><br><span class="line">                                m_pFrameworkOutStreams[index]))</span><br><span class="line">                            &#123;</span><br><span class="line">                                ChxUtils::PopulateHALToChiStreamBuffer(&amp;pRequest-&gt;output_buffers[buffer],</span><br><span class="line">                                                                       &amp;outputBuffers[outputCount]);</span><br><span class="line">                                outputBuffers[outputCount].pStream = pPipelineData-&gt;pStreams[stream];</span><br><span class="line">                                outputCount++;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else</span><br><span class="line">                    &#123;</span><br><span class="line">                        if (reinterpret_cast&lt;CHISTREAM*&gt;(pRequest-&gt;output_buffers[buffer].stream) ==</span><br><span class="line">                            pPipelineData-&gt;pStreams[stream])</span><br><span class="line">                        &#123;</span><br><span class="line">                            ChxUtils::PopulateHALToChiStreamBuffer(&amp;pRequest-&gt;output_buffers[buffer],</span><br><span class="line">                                                                   &amp;outputBuffers[outputCount]);</span><br><span class="line">                            outputCount++;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (0 &lt; outputCount)</span><br><span class="line">            &#123;</span><br><span class="line">                CHICAPTUREREQUEST request       = &#123; 0 &#125;;</span><br><span class="line">                CHISTREAMBUFFER   inputBuffer   = &#123; 0 &#125;;</span><br><span class="line">                UINT32            sensorModeIndex;</span><br><span class="line"></span><br><span class="line">                if (NULL != pRequest-&gt;input_buffer)</span><br><span class="line">                &#123;</span><br><span class="line">                    request.numInputs     = 1;</span><br><span class="line">                    ChxUtils::PopulateHALToChiStreamBuffer(pRequest-&gt;input_buffer, &amp;inputBuffer);</span><br><span class="line">                    request.pInputBuffers = &amp;inputBuffer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                request.frameNumber       = pRequest-&gt;frame_number;</span><br><span class="line">                request.hPipelineHandle   = reinterpret_cast&lt;CHIPIPELINEHANDLE&gt;(</span><br><span class="line">                                                m_sessions[session].pSession-&gt;GetPipelineHandle());</span><br><span class="line">                request.numOutputs        = outputCount;</span><br><span class="line">                request.pOutputBuffers    = outputBuffers;</span><br><span class="line">                request.pPrivData         = &amp;m_privData[frameIndex];</span><br><span class="line"></span><br><span class="line">                UpdateMetadataBuffers(pRequest, pPipelineData-&gt;id, &amp;request, session, pipeline, !bIsOffline);</span><br><span class="line"></span><br><span class="line">                CHIPIPELINEREQUEST submitRequest = &#123; 0 &#125;;</span><br><span class="line">                submitRequest.pSessionHandle     = reinterpret_cast&lt;CHIHANDLE&gt;(</span><br><span class="line">                                                        m_sessions[session].pSession-&gt;GetSessionHandle());</span><br><span class="line">                submitRequest.numRequests        = 1;</span><br><span class="line">                submitRequest.pCaptureRequests   = &amp;request;</span><br><span class="line"></span><br><span class="line">                m_numPCRsBeforeStreamOn          = ExtensionModule::GetInstance()-&gt;GetNumPCRsBeforeStreamOn(m_cameraId);</span><br><span class="line"></span><br><span class="line">                if (1 &gt; m_numPCRsBeforeStreamOn)</span><br><span class="line">                &#123;</span><br><span class="line">                    // Activate pipeline before submitting request when EarlyPCR disabled</span><br><span class="line">                    result = CheckAndActivatePipeline(m_sessions[session].pSession);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (CDKResultSuccess != result)</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_ERROR(&quot;Activate Pipeline failure for session:%d pipeline %d&quot;, session, pipeline);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                CHX_LOG(&quot;Submitting request to Session %d Pipeline %d outputCount=%d&quot;, session, pipeline, outputCount);</span><br><span class="line"></span><br><span class="line">                CHX_LOG_REQMAP(&quot;frame: %u  &lt;==&gt;  (chiFrameNum) chiOverrideFrameNum: %&quot; PRIu64,</span><br><span class="line">                               GetAppFrameNum(request.frameNumber),</span><br><span class="line">                               request.frameNumber);</span><br><span class="line"></span><br><span class="line">                result = SubmitRequest(&amp;submitRequest);</span><br><span class="line"></span><br><span class="line">                if (CDKResultSuccess != result)</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_ERROR(&quot;Submit request failure for session:%d&quot;, session);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (0 &lt; m_numPCRsBeforeStreamOn)</span><br><span class="line">                &#123;</span><br><span class="line">                    // Activate pipeline after submitting request when EarlyPCR enabled</span><br><span class="line">                    result = CheckAndActivatePipeline(m_sessions[session].pSession);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (CDKResultSuccess != result)</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG_ERROR(&quot;Activate Pipeline failure for session:%d pipeline %d&quot;, session, pipeline);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;Defer thread or submit request failure for session:%d&quot;, session);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-9-ChiContext-ActivatePipeline"><a href="#4-4-1-9-ChiContext-ActivatePipeline" class="headerlink" title="4.4.1.9 ChiContext::ActivatePipeline"></a>4.4.1.9 ChiContext::ActivatePipeline</h5><p>[-&gt;vendor\qcom\proprietary\camx\src\core\chi\camxchicontext.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// ChiContext::ActivatePipeline</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CamxResult ChiContext::ActivatePipeline(</span><br><span class="line">    CHISession*         pChiSession,</span><br><span class="line">    CHIPIPELINEHANDLE   hPipelineDescriptor)</span><br><span class="line">&#123;</span><br><span class="line">    CAMX_ASSERT(NULL != pChiSession);</span><br><span class="line">    CAMX_ASSERT(NULL != hPipelineDescriptor);</span><br><span class="line"></span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    if (TRUE == pChiSession-&gt;UsingResourceManager(0))</span><br><span class="line">    &#123;</span><br><span class="line">        ResourceID resourceId = static_cast&lt;ResourceID&gt;(ResourceType::RealtimePipeline);</span><br><span class="line">        GetResourceManager()-&gt;CheckAndAcquireResource(resourceId, static_cast&lt;VOID*&gt;(hPipelineDescriptor), 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = pChiSession-&gt;StreamOn(hPipelineDescriptor);</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-1-10-小结"><a href="#4-4-1-10-小结" class="headerlink" title="4.4.1.10 小结"></a>4.4.1.10 小结</h5><p>首先CamX中会将此次request转发到HALDevice中，再通过HALDevice对象调用之前初始化的时候获取的CHI部分的回调接口m_ChiAppCallbacks.chi_override_process_request方法（chi_override_process_request方法的定义位于chxextensioninterface.cpp中）将request发送到CHI部分。</p>
<p>在chi_override_process_request方法中会去获取ExtensionModule对象，并将request发送到ExtensionModule对象中，该对象中存储了之前创建的Usecase对象，然后经过层层调用，最终会调用AdvancedCameraUsecase的ExecuteCaptureRequest方法，该方法负责处理此次Request，具体流程如下：</p>
<p>在AdvancedCameraUsecase的ExecuteCaptureRequest中会有两个主要的分支来分别处理：</p>
<ul>
<li>如果当前并没有任何Feature需要实现，此时便会走默认流程，根据上面的流程图所示，这里会调用CameraUsecaseBase::ExecuteCaptureRequest方法，在该方法中，首先会将request取出，重新封装成CHICAPTUREREQUEST，然后调用CheckAndActivatePipeline方法唤醒pipeline,这一操作到最后会调到Session的StreamOn方法，在唤醒了pipeline之后，继续往下执行，再将封装后的Request发送到CamX中，最终调用到相应的Session::ProcessCaptureRequest方法，此时Request就进入到了Session内部进行流转了。</li>
<li>如果当前场景需要实现某个Feature，则直接调用Feature的ExecuteProcessRequest方法将此次request送入Feature中处理，最后依然会调用到Session::StreamOn以及Session::ProcessCaptureRequest方法来分别完成唤醒pipeline以及下发request的到Session的操作。</li>
</ul>
<p>该流程最终都会调用到两个比较关键的方法Session::StreamOn以及Session::ProcessCaptureRequest，接下来针对这两个方法重点介绍下：</p>
<h4 id="4-4-2-Session-StreamOn"><a href="#4-4-2-Session-StreamOn" class="headerlink" title="4.4.2 Session::StreamOn"></a>4.4.2 Session::StreamOn</h4><p>[-&gt;vendor\qcom\proprietary\camx\src\core\camxsession.cpp]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// Session::StreamOn</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CamxResult Session::StreamOn(</span><br><span class="line">    CHIPIPELINEHANDLE hPipelineDescriptor)</span><br><span class="line">&#123;</span><br><span class="line">    UINT32     index  = 0;</span><br><span class="line">    CamxResult result = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    // input pipelineIndex not really match the index recorded by Session, so use Descriptor to find it.</span><br><span class="line">    for (index = 0; index &lt; m_numPipelines; index++)</span><br><span class="line">    &#123;</span><br><span class="line">        if (hPipelineDescriptor == m_pipelineData[index].pPipelineDescriptor)</span><br><span class="line">        &#123;</span><br><span class="line">            // found corresponding pipeline can use index to get to it</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(index &lt; m_numPipelines);</span><br><span class="line"></span><br><span class="line">    Pipeline* pPipeline = m_pipelineData[index].pPipeline;</span><br><span class="line"></span><br><span class="line">    m_pStreamOnOffLock-&gt;Lock();</span><br><span class="line"></span><br><span class="line">    if ((NULL != pPipeline) &amp;&amp; (PipelineStatus::STREAM_ON != pPipeline-&gt;GetPipelineStatus()))</span><br><span class="line">    &#123;</span><br><span class="line">        PipelineStatus pipelineStatus = pPipeline-&gt;GetPipelineStatus();</span><br><span class="line"></span><br><span class="line">        if (PipelineStatus::FINALIZED &gt; pipelineStatus)</span><br><span class="line">        &#123;</span><br><span class="line">            result = FinalizeDeferPipeline(index);</span><br><span class="line">            pipelineStatus = pPipeline-&gt;GetPipelineStatus();</span><br><span class="line">            CAMX_LOG_INFO(CamxLogGroupCore, &quot;FinalizeDeferPipeline result: %d pipelineStatus: %d&quot;,</span><br><span class="line">                result, pipelineStatus);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;FinalizeDeferPipeline() unsuccessful, Session StreamOn() is failed !!&quot;);</span><br><span class="line">            pPipeline-&gt;ReleaseResources();</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if (PipelineStatus::FINALIZED &lt;= pipelineStatus)</span><br><span class="line">            &#123;</span><br><span class="line">                result = pPipeline-&gt;StreamOn();</span><br><span class="line"></span><br><span class="line">                if (CamxResultSuccess == result)</span><br><span class="line">                &#123;</span><br><span class="line">                    if (TRUE == pPipeline-&gt;IsRealTime())</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_numStreamedOnRealtimePipelines++;</span><br><span class="line"></span><br><span class="line">                        CheckAndSyncLinks();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Pipeline %s failed to stream on.&quot;,</span><br><span class="line">                        pPipeline-&gt;GetPipelineName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pStreamOnOffLock-&gt;Unlock();</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从方法名称基本可以知道该方法主要用于开始硬件的数据输出，具体点儿就是进行配置Sensor寄存器，让其开始出图，并且将当前的Session的状态告知每一Node，让它们在自己内部也做好处理数据的准备，所以之后的相关Request的流转都是以该方法为前提进行的，所以该方法重要性可见一斑，其操作流程见下图：</p>
<p>Session的StreamOn方法中主要做了如下两个工作：</p>
<ul>
<li>调用FinalizeDeferPipeline()方法，如果当前pipeline并未初始化，则会调用pipeline的FinalizePipeline方法，这里方法里面会去针对每一个从属于当前pipeline的Node依次做FinalizeInitialization、CreateBufferManager、NotifyPipelineCreated以及PrepareNodeStreamOn操作，FinalizeInitialization用于完成Node的初始化动作，NotifyPipelineCreated用于通知Node当前Pipeline的状态，此时Node内部可以根据自身的需要作相应的操作，PrepareNodeStreamOn方法的主要是完成Sensor以及IFE等Node的控制硬件模块出图前的配置，其中包括了曝光的参数的设置，CreateBufferManagers方法涉及到CamX-CHI中的一个非常重要的Buffer管理机制，用于Node的ImageBufferManager的创建，而该类用于管理Node中的output port的buffer申请/流转/释放等操作。</li>
<li>调用Pipeline的StreamOn方法，里面会进一步通知CSL部分开启数据流，并且调用每一个Node的OnNodeStreamOn方法，该方法会去调用ImageBufferManager的Activate(),该方法里面会去真正分配用于装载图像数据的buffer，之后会去调用CHI部分实现的用户自定义的Node的pOnStreamOn方法，用户可以在该方法中做一些自定义的操作。</li>
</ul>
<h4 id="4-4-3-Session-ProcessCaptureRequest"><a href="#4-4-3-Session-ProcessCaptureRequest" class="headerlink" title="4.4.3 Session::ProcessCaptureRequest"></a>4.4.3 Session::ProcessCaptureRequest</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// Session::ProcessCaptureRequest</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CamxResult Session::ProcessCaptureRequest(</span><br><span class="line">    const ChiPipelineRequest* pPipelineRequests)</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult  result      = CamxResultSuccess;</span><br><span class="line"></span><br><span class="line">    UINT        numRequests = pPipelineRequests-&gt;numRequests;</span><br><span class="line">    UINT32      pipelineIndexes[MaxPipelinesPerSession];</span><br><span class="line"></span><br><span class="line">    const StaticSettings* pStaticSettings = m_pChiContext-&gt;GetStaticSettings();</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(NULL != pPipelineRequests);</span><br><span class="line">    CAMX_ASSERT(NULL != pStaticSettings);</span><br><span class="line"></span><br><span class="line">    // Prepare info for each request on each pipeline</span><br><span class="line">    for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        // input pipelineIndex not really match the index recorded by Session, so use GetPipelineIndex to get corresponding</span><br><span class="line">        // pipeline index.</span><br><span class="line">        pipelineIndexes[requestIndex] = GetPipelineIndex(pPipelineRequests-&gt;pCaptureRequests[requestIndex].hPipelineHandle);</span><br><span class="line">        CAMX_LOG_VERBOSE(CamxLogGroupCore,</span><br><span class="line">            &quot;Received(%d/%d) for framework framenumber %llu, num outputs %d on %s: PipelineStatus:%d&quot;,</span><br><span class="line">            requestIndex+1,</span><br><span class="line">            numRequests,</span><br><span class="line">            pPipelineRequests-&gt;pCaptureRequests[requestIndex].frameNumber,</span><br><span class="line">            pPipelineRequests-&gt;pCaptureRequests[requestIndex].numOutputs,</span><br><span class="line">            m_pipelineData[pipelineIndexes[requestIndex]].pPipeline-&gt;GetPipelineIdentifierString(),</span><br><span class="line">            m_pipelineData[pipelineIndexes[requestIndex]].pPipeline-&gt;GetPipelineStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess != m_pFlushLock-&gt;TryLock())</span><br><span class="line">    &#123;</span><br><span class="line">        // Prepare capture result with request error for the pipeline requests but don&apos;t</span><br><span class="line">        // dispatch it immediately as it would be dispatched at the end of flush call. This will</span><br><span class="line">        // ensure that all capture results of the cancelled requests are dispatched first before</span><br><span class="line">        // returning the control to the caller.</span><br><span class="line">        // Decrementing live pending and sending processing done notification to allow flush to</span><br><span class="line">        // process this inflight request&apos;s result after handling all enqueued requests</span><br><span class="line">        m_pLivePendingRequestsLock-&gt;Lock();</span><br><span class="line">        PrepareChiRequestErrorForInflightRequests(pPipelineRequests);</span><br><span class="line">        m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">        NotifyProcessingDone();</span><br><span class="line"></span><br><span class="line">        m_pFlushDoneLock-&gt;Lock();</span><br><span class="line">        while (TRUE == GetFlushStatus())</span><br><span class="line">        &#123;</span><br><span class="line">            // Block the thread and send result after flush is done</span><br><span class="line">            result = m_pWaitForFlushDone-&gt;TimedWait(m_pFlushDoneLock-&gt;GetNativeHandle(), MaxWaitTimeForFlush);</span><br><span class="line">        &#125;</span><br><span class="line">        m_pFlushDoneLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_WARN(CamxLogGroupCore, &quot;Flush done timed out for session: %p, but returing success as results&quot;</span><br><span class="line">                &quot; should be processed!!&quot;, this);</span><br><span class="line">            // returning success as result of this request should have already</span><br><span class="line">            // been dispatched at the end of flush</span><br><span class="line">            result = CamxResultSuccess;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pFlushLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">    m_pLivePendingRequestsLock-&gt;Lock();</span><br><span class="line"></span><br><span class="line">    CAMX_ASSERT(m_maxLivePendingRequests &gt; 0);</span><br><span class="line"></span><br><span class="line">    while (m_livePendingRequests &gt;= m_maxLivePendingRequests - 1)</span><br><span class="line">    &#123;</span><br><span class="line">        if (TRUE == m_aDeviceInError)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Device in error state, returning failure for session:%p&quot;, this);</span><br><span class="line">            m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line">            return CamxResultEFailed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (TRUE == GetSessionTriggeringRecovery())</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_WARN(CamxLogGroupCore, &quot;Session %p triggering recovery, cancelling new PCR&quot;, this);</span><br><span class="line">            m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line">            return CamxResultECancelledRequest;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UINT waitTime = LivePendingRequestTimeoutDefault;</span><br><span class="line"></span><br><span class="line">        if (m_sequenceId &lt; m_maxLivePendingRequests * 2)</span><br><span class="line">        &#123;</span><br><span class="line">            waitTime = LivePendingRequestTimeoutDefault + (m_maxLivePendingRequests * LivePendingRequestTimeOutExtendor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UINT32 additionalExposureTime = CamxAtomicLoadU32(&amp;m_aTotalLongExposureTimeout);</span><br><span class="line">        if (TRUE == m_additionalWaitTimeForLivePending)</span><br><span class="line">        &#123;</span><br><span class="line">            // after flush if current exposureTime used by sensor is more than the requested exposure time</span><br><span class="line">            // then need to wait according to current exposureTime use by sensor. Because sensor doesnot</span><br><span class="line">            // use requested exposure time upto first 3 frame(pipeline delay).</span><br><span class="line">            if (additionalExposureTime &lt; m_currExposureTimeUseBySensor)</span><br><span class="line">            &#123;</span><br><span class="line">                additionalExposureTime = m_currExposureTimeUseBySensor;</span><br><span class="line">            &#125;</span><br><span class="line">            additionalExposureTime = additionalExposureTime * 3;</span><br><span class="line">            m_additionalWaitTimeForLivePending = FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        waitTime = static_cast&lt;UINT&gt;(additionalExposureTime) + waitTime;</span><br><span class="line"></span><br><span class="line">        CAMX_LOG_VERBOSE(CamxLogGroupCore,</span><br><span class="line">                         &quot;Timed Wait Live Pending Requests(%u) &quot;</span><br><span class="line">                         &quot;Sequence Id %u &quot;</span><br><span class="line">                         &quot;Live Pending Requests %u &quot;</span><br><span class="line">                         &quot;Max Live Pending Requests %u &quot;</span><br><span class="line">                         &quot;Live Pending Request TimeOut Extendor %u&quot;,</span><br><span class="line">                         waitTime,</span><br><span class="line">                         m_sequenceId,</span><br><span class="line">                         m_livePendingRequests,</span><br><span class="line">                         m_maxLivePendingRequests,</span><br><span class="line">                         LivePendingRequestTimeOutExtendor);</span><br><span class="line"></span><br><span class="line">        result = m_pWaitLivePendingRequests-&gt;TimedWait(m_pLivePendingRequestsLock-&gt;GetNativeHandle(), waitTime);</span><br><span class="line"></span><br><span class="line">        CAMX_LOG_VERBOSE(CamxLogGroupCore,</span><br><span class="line">                      &quot;Timed Wait Live Pending Requests(%u) ...DONE result %s&quot;,</span><br><span class="line">                       waitTime,</span><br><span class="line">                       CamxResultStrings[result]);</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess != result)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line">        if (TRUE == pStaticSettings-&gt;enableRecovery)</span><br><span class="line">        &#123;</span><br><span class="line">            if (TRUE == pStaticSettings-&gt;raiserecoverysigabrt)</span><br><span class="line">            &#123;</span><br><span class="line">                DumpSessionState(SessionDumpFlag::ResetRecovery);</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;FATAL ERROR: Raise SigAbort to debug the root cause of HAL recovery&quot;);</span><br><span class="line">                OsUtils::RaiseSignalAbort();</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_CONFIG(CamxLogGroupCore, &quot;Lets do a Reset:UMD&quot;);</span><br><span class="line">                // Set recovery status to TRUE</span><br><span class="line">                SetSessionTriggeringRecovery(TRUE);</span><br><span class="line"></span><br><span class="line">                NotifyPipelinesOfTriggeringRecovery(TRUE);</span><br><span class="line"></span><br><span class="line">                DumpSessionState(SessionDumpFlag::ResetUMD);</span><br><span class="line">                return CamxResultETimeout;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;HAL Recovery is disabled, cannot trigger&quot;);</span><br><span class="line">            return CamxResultEFailed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pipelineData[pipelineIndexes[requestIndex]].pPipeline-&gt;IncrementLivePendingRequest();</span><br><span class="line">        CAMX_LOG_VERBOSE(CamxLogGroupCore, &quot;Framework frame number: %llu Pipeline: %s LivePendingRequests: %d&quot;,</span><br><span class="line">            pPipelineRequests-&gt;pCaptureRequests[requestIndex].frameNumber,</span><br><span class="line">            m_pipelineData[pipelineIndexes[requestIndex]].pPipeline-&gt;GetPipelineIdentifierString(),</span><br><span class="line">            m_pipelineData[pipelineIndexes[requestIndex]].pPipeline-&gt;GetLivePendingRequest());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_livePendingRequests++;</span><br><span class="line">    m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess != m_pFlushLock-&gt;TryLock())</span><br><span class="line">    &#123;</span><br><span class="line">        // Prepare capture result with request error for the pipeline requests but don&apos;t</span><br><span class="line">        // dispatch it immediately as it would be dispatched at the end of flush call. This will</span><br><span class="line">        // ensure that all capture results of the cancelled requests are dispatched first before</span><br><span class="line">        // returning the control to the caller.</span><br><span class="line">        // Decrementing live pending and sending processing done notification to allow flush to</span><br><span class="line">        // process this inflight request&apos;s result after handling all enqueued requests</span><br><span class="line">        m_pLivePendingRequestsLock-&gt;Lock();</span><br><span class="line">        PrepareChiRequestErrorForInflightRequests(pPipelineRequests);</span><br><span class="line">        PipelinesInflightRequestsNotification(pPipelineRequests);</span><br><span class="line">        m_livePendingRequests--;</span><br><span class="line">        m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">        NotifyProcessingDone();</span><br><span class="line"></span><br><span class="line">        m_pFlushDoneLock-&gt;Lock();</span><br><span class="line">        while (TRUE == GetFlushStatus())</span><br><span class="line">        &#123;</span><br><span class="line">            // Block the thread and send result after flush is done</span><br><span class="line">            result = m_pWaitForFlushDone-&gt;TimedWait(m_pFlushDoneLock-&gt;GetNativeHandle(), MaxWaitTimeForFlush);</span><br><span class="line">        &#125;</span><br><span class="line">        m_pFlushDoneLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess != result)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_WARN(CamxLogGroupCore, &quot;Flush done timed out for session: %p, but returing success as results&quot;</span><br><span class="line">                &quot; should be processed!!&quot;, this);</span><br><span class="line">            // returning success as result of this request should have already</span><br><span class="line">            // been dispatched at the end of flush</span><br><span class="line">            result = CamxResultSuccess;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If it reaches here flush lock should already be taken</span><br><span class="line"></span><br><span class="line">    // Block process request while stream on in progress</span><br><span class="line">    m_pStreamOnOffLock-&gt;Lock();</span><br><span class="line"></span><br><span class="line">    ChiCaptureRequest requests[MaxPipelinesPerSession];</span><br><span class="line">    m_captureRequest.numRequests = numRequests;</span><br><span class="line"></span><br><span class="line">    if (MaxRealTimePipelines &gt; m_numRealtimePipelines)</span><br><span class="line">    &#123;</span><br><span class="line">        // In single camera use case, one CHI request should have only one request per pipeline so that incoming requests will</span><br><span class="line">        // not be more than m_requestQueueDepth and the only exception is in Dual Camera use case to have two requests</span><br><span class="line">        if (2 &lt;= numRequests)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_WARN(CamxLogGroupCore, &quot;In batch mode, number of pipeline requests are more than 1&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SyncProcessCaptureRequest(pPipelineRequests, pipelineIndexes);</span><br><span class="line"></span><br><span class="line">    for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        // check resource availability before enqueue to requestQueue</span><br><span class="line">        if ((CamxResultSuccess == result) &amp;&amp;</span><br><span class="line">            (TRUE == UsingResourceManager(pipelineIndexes[requestIndex])))</span><br><span class="line">        &#123;</span><br><span class="line">            ResourceID resourceId = static_cast&lt;ResourceID&gt;(ResourceType::RealtimePipeline);</span><br><span class="line"></span><br><span class="line">            m_pChiContext-&gt;GetResourceManager()-&gt;AddResourceReference(resourceId,</span><br><span class="line">                static_cast&lt;VOID*&gt;(m_pipelineData[pipelineIndexes[requestIndex]].pPipelineDescriptor), 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        const ChiCaptureRequest* pCaptureRequest    = &amp;(pPipelineRequests-&gt;pCaptureRequests[requestIndex]);</span><br><span class="line">        UINT32             pipelineIndex            = pipelineIndexes[requestIndex];</span><br><span class="line">        Pipeline*          pPipeline                = m_pipelineData[pipelineIndex].pPipeline;</span><br><span class="line">        MetadataPool*      pPerFrameInputPool       = NULL;</span><br><span class="line">        MetadataPool*      pPerFrameResultPool      = NULL;</span><br><span class="line">        MetadataPool*      pPerFrameInternalPool    = NULL;</span><br><span class="line">        MetadataPool*      pPerFrameEarlyResultPool = NULL;</span><br><span class="line">        MetadataPool*      pPerUsecasePool          = NULL;</span><br><span class="line">        MetaBuffer*        pInputMetabuffer         = NULL;</span><br><span class="line">        MetaBuffer*        pOutputMetabuffer        = NULL;</span><br><span class="line"></span><br><span class="line">        if (NULL == pPipeline)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;pPipeline is NULL, pipelineIndex %u requestIndex %u&quot;,</span><br><span class="line">                pipelineIndex, requestIndex);</span><br><span class="line">            result = CamxResultEFailed;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (PipelineStatus::FINALIZED &gt; pPipeline-&gt;GetPipelineStatus())</span><br><span class="line">        &#123;</span><br><span class="line">            result = FinalizeDeferPipeline(pipelineIndex);</span><br><span class="line">            if (CamxResultSuccess != result)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;%s: FinalizeDeferPipeline failed pipelineIndex %u PipelineName: %s&quot;</span><br><span class="line">                    &quot;result: %s&quot;, m_pipelineNames, pipelineIndex, pPipeline-&gt;GetPipelineName(),</span><br><span class="line">                    CamxResultStrings[result]);</span><br><span class="line">                pPipeline-&gt;ReleaseResources();</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            pPerFrameInputPool       = pPipeline-&gt;GetPerFramePool(PoolType::PerFrameInput);</span><br><span class="line">            pPerFrameResultPool      = pPipeline-&gt;GetPerFramePool(PoolType::PerFrameResult);</span><br><span class="line">            pPerFrameInternalPool    = pPipeline-&gt;GetPerFramePool(PoolType::PerFrameInternal);</span><br><span class="line">            pPerFrameEarlyResultPool = pPipeline-&gt;GetPerFramePool(PoolType::PerFrameResultEarly);</span><br><span class="line">            pPerUsecasePool          = pPipeline-&gt;GetPerFramePool(PoolType::PerUsecase);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ((NULL != pPerFrameEarlyResultPool) &amp;&amp;</span><br><span class="line">            (NULL != pPerFrameInputPool)       &amp;&amp;</span><br><span class="line">            (NULL != pPerFrameResultPool)      &amp;&amp;</span><br><span class="line">            (NULL != pPerFrameInternalPool)    &amp;&amp;</span><br><span class="line">            (NULL != pPerUsecasePool))</span><br><span class="line">        &#123;</span><br><span class="line">            // Replace the incoming frameNumber with m_sequenceId to protect against sparse input frameNumbers</span><br><span class="line">            CamX::Utils::Memcpy(&amp;requests[requestIndex], pCaptureRequest, sizeof(ChiCaptureRequest));</span><br><span class="line"></span><br><span class="line">            pInputMetabuffer  = reinterpret_cast&lt;MetaBuffer*&gt;(requests[requestIndex].pInputMetadata);</span><br><span class="line">            pOutputMetabuffer = reinterpret_cast&lt;MetaBuffer*&gt;(requests[requestIndex].pOutputMetadata);</span><br><span class="line"></span><br><span class="line">            requests[requestIndex].frameNumber = m_sequenceId;</span><br><span class="line">            m_sequenceId++;</span><br><span class="line"></span><br><span class="line">            result = CanRequestProceed(&amp;requests[requestIndex]);</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                result = WaitOnAcquireFence(&amp;requests[requestIndex]);</span><br><span class="line"></span><br><span class="line">                if (CamxResultSuccess == result)</span><br><span class="line">                &#123;</span><br><span class="line">                    // Finally copy and enqueue the request and fire the threadpool</span><br><span class="line"></span><br><span class="line">                    // Set the expected exposure time to the current default</span><br><span class="line">                    UINT32 expectedExposureTime = 0;</span><br><span class="line"></span><br><span class="line">                    // m_batchedFrameIndex of respective pipelines should be less than m_usecaseNumBatchedFrames</span><br><span class="line">                    CAMX_ASSERT(m_batchedFrameIndex[pipelineIndex] &lt; m_usecaseNumBatchedFrames);</span><br><span class="line"></span><br><span class="line">                    // m_batchedFrameIndex 0 implies a new requestId must be generated - irrespective of batching</span><br><span class="line">                    // ON/OFF status</span><br><span class="line">                    if (0 == m_batchedFrameIndex[pipelineIndex])</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_requestBatchId[pipelineIndex]++;</span><br><span class="line"></span><br><span class="line">                        CAMX_ASSERT(m_usecaseNumBatchedFrames &gt;= m_captureRequest.requests[requestIndex].numBatchedFrames);</span><br><span class="line">                        CaptureRequest::PartialClearData(&amp;m_captureRequest.requests[requestIndex]);</span><br><span class="line"></span><br><span class="line">                        m_captureRequest.requests[requestIndex].requestId = m_requestBatchId[pipelineIndex];</span><br><span class="line">                        m_captureRequest.requests[requestIndex].pMultiRequestData =</span><br><span class="line">                            &amp;m_requestSyncData[(m_syncSequenceId) % MaxQueueDepth];</span><br><span class="line">                        CAMX_LOG_VERBOSE(CamxLogGroupCore, &quot;m_syncSequenceId:%d&quot;, m_syncSequenceId);</span><br><span class="line">                        CAMX_LOG_VERBOSE(CamxLogGroupCore, &quot;%s is handling RequestID:%llu whose PeerRequestID:%llu&quot;</span><br><span class="line">                            &quot; m_syncSequenceId:%llu&quot;,</span><br><span class="line">                            pPipeline-&gt;GetPipelineIdentifierString(),</span><br><span class="line">                            m_captureRequest.requests[requestIndex].requestId,</span><br><span class="line">                            m_requestSyncData[(m_syncSequenceId) % MaxQueueDepth],</span><br><span class="line">                            m_syncSequenceId);</span><br><span class="line"></span><br><span class="line">                        pPerFrameInputPool-&gt;Invalidate(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        pPerFrameResultPool-&gt;Invalidate(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        pPerFrameEarlyResultPool-&gt;Invalidate(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        pPerFrameInternalPool-&gt;Invalidate(m_requestBatchId[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                        pPerFrameInputPool-&gt;UpdateRequestId(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        pPerFrameResultPool-&gt;UpdateRequestId(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        pPerFrameEarlyResultPool-&gt;UpdateRequestId(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        pPerFrameInternalPool-&gt;UpdateRequestId(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        m_ppPerFrameDebugDataPool[pipelineIndex]-&gt;UpdateRequestId(m_requestBatchId[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                        if (TRUE == UseInternalDebugDataMemory())</span><br><span class="line">                        &#123;</span><br><span class="line">                            // Assign debug-data memory to the next request</span><br><span class="line">                            VOID*           pSlotDebugData      = NULL;</span><br><span class="line">                            VOID*           pBlobDebugData      = NULL;</span><br><span class="line">                            MetadataSlot*   pDebugDataPoolSlot  =</span><br><span class="line">                                m_ppPerFrameDebugDataPool[pipelineIndex]-&gt;GetSlot(m_requestBatchId[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                            result = GetDebugDataForSlot(&amp;pSlotDebugData);</span><br><span class="line">                            if (CamxResultSuccess == result)</span><br><span class="line">                            &#123;</span><br><span class="line">                                result = pDebugDataPoolSlot-&gt;GetPropertyBlob(&amp;pBlobDebugData);</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (CamxResultSuccess == result)</span><br><span class="line">                            &#123;</span><br><span class="line">                                CAMX_LOG_VERBOSE(CamxLogGroupDebugData,</span><br><span class="line">                                                 &quot;Assigning DebugData for request: %llu, debug-data: %p, pBlobDebugData: %p&quot;,</span><br><span class="line">                                                 m_requestBatchId[pipelineIndex], pSlotDebugData, pBlobDebugData);</span><br><span class="line">                                result = InitDebugDataSlot(pBlobDebugData, pSlotDebugData);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            if (CamxResultSuccess != result)</span><br><span class="line">                            &#123;</span><br><span class="line">                                // Debug-Data framework failures are non-fatal</span><br><span class="line">                                CAMX_LOG_WARN(CamxLogGroupDebugData, &quot;Fail to add debug-data to slot&quot;);</span><br><span class="line">                                result = CamxResultSuccess;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                            // Assign debug-data memory to the next request</span><br><span class="line">                            VOID*           pBlobDebugData      = NULL;</span><br><span class="line">                            MetadataSlot*   pDebugDataPoolSlot  =</span><br><span class="line">                                m_ppPerFrameDebugDataPool[pipelineIndex]-&gt;GetSlot(m_requestBatchId[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                            pDebugDataPoolSlot-&gt;GetPropertyBlob(&amp;pBlobDebugData);</span><br><span class="line">                            CAMX_LOG_VERBOSE(CamxLogGroupDebugData,</span><br><span class="line">                                             &quot;Not setting debug-data: RT: %u request[%u]: %llu pBlob: %p : pSlot: %p&quot;,</span><br><span class="line">                                             m_isRealTime,</span><br><span class="line">                                             pipelineIndex,</span><br><span class="line">                                             m_requestBatchId[pipelineIndex],</span><br><span class="line">                                             pBlobDebugData);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (TRUE == pStaticSettings-&gt;logMetaEnable)</span><br><span class="line">                        &#123;</span><br><span class="line">                            CAMX_LOG_META(&quot;+----------------------------------------------------&quot;);</span><br><span class="line">                            CAMX_LOG_META(&quot;| Input metadata for request: %lld&quot;, m_requestBatchId[pipelineIndex]);</span><br><span class="line">                            CAMX_LOG_META(&quot;|     %d entries&quot;, pInputMetabuffer-&gt;Count());</span><br><span class="line">                            CAMX_LOG_META(&quot;+----------------------------------------------------&quot;);</span><br><span class="line"></span><br><span class="line">                            pInputMetabuffer-&gt;PrintDetails();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        MetadataSlot* pMetadataSlot       = pPerFrameInputPool-&gt;GetSlot(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        MetadataSlot* pResultMetadataSlot = pPerFrameResultPool-&gt;GetSlot(m_requestBatchId[pipelineIndex]);</span><br><span class="line">                        MetadataSlot* pUsecasePoolSlot    = pPerUsecasePool-&gt;GetSlot(0);</span><br><span class="line"></span><br><span class="line">                        if (pMetadataSlot != NULL)</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = pMetadataSlot-&gt;AttachMetabuffer(pInputMetabuffer);</span><br><span class="line"></span><br><span class="line">                            if (CamxResultSuccess == result)</span><br><span class="line">                            &#123;</span><br><span class="line">                                result = pResultMetadataSlot-&gt;AttachMetabuffer(pOutputMetabuffer);</span><br><span class="line"></span><br><span class="line">                                if (CamxResultSuccess == result)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    UINT dumpMetadata = HwEnvironment::GetInstance()-&gt;GetStaticSettings()-&gt;dumpMetadata;</span><br><span class="line"></span><br><span class="line">                                    CHAR metadataFileName[FILENAME_MAX];</span><br><span class="line"></span><br><span class="line">                                    dumpMetadata &amp;= (TRUE == pPipeline-&gt;IsRealTime()) ?  RealTimeMetadataDumpMask</span><br><span class="line">                                        : OfflineMetadataDumpMask;</span><br><span class="line"></span><br><span class="line">                                    if (0 != (dumpMetadata &amp; 0x3))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        OsUtils::SNPrintF(metadataFileName, FILENAME_MAX, &quot;inputMetadata_%s_%5d.txt&quot;,</span><br><span class="line">                                            pPipeline-&gt;GetPipelineIdentifierString(),</span><br><span class="line">                                            m_requestBatchId[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                                        pInputMetabuffer-&gt;DumpDetailsToFile(metadataFileName);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    else if (0 != ((dumpMetadata&gt;&gt;2) &amp; 0x3))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        OsUtils::SNPrintF(metadataFileName, FILENAME_MAX, &quot;inputMetadata_%s_%5d.bin&quot;,</span><br><span class="line">                                            pPipeline-&gt;GetPipelineIdentifierString(),</span><br><span class="line">                                            m_requestBatchId[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                                        pInputMetabuffer-&gt;BinaryDump(metadataFileName);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                else</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Error attach output failed for slot %d&quot;,</span><br><span class="line">                                                   m_requestBatchId[pipelineIndex]);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">                                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Error attach input failed for slot %d&quot;,</span><br><span class="line">                                               m_requestBatchId[pipelineIndex]);</span><br><span class="line">                            &#125;</span><br><span class="line">                            CAMX_LOG_INFO(CamxLogGroupCore, &quot;AttachMetabuffer in pipeline %s InputMetaBuffer %p &quot;</span><br><span class="line">                                                            &quot;OutputMetaBuffer %p reqId %llu&quot;,</span><br><span class="line">                                          pPipeline-&gt;GetPipelineIdentifierString(),</span><br><span class="line">                                          pInputMetabuffer,</span><br><span class="line">                                          pOutputMetabuffer,</span><br><span class="line">                                          m_requestBatchId[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                            if (CamxResultSuccess == result)</span><br><span class="line">                            &#123;</span><br><span class="line"></span><br><span class="line">                                INT64*   pExposurePriority        = NULL;</span><br><span class="line">                                UINT64*  pSensorExposureTime      = static_cast&lt;UINT64*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                                                               SensorExposureTime));</span><br><span class="line"></span><br><span class="line">                                UINT64*  pSensorFrameDurationTime = static_cast&lt;UINT64*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                                                               SensorFrameDuration));</span><br><span class="line"></span><br><span class="line">                                INT32*   pExposurePriorityMode    = static_cast&lt;INT32*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                                                               m_exposurePriorityModeTagId));</span><br><span class="line"></span><br><span class="line">                                UINT8*   pAEMode                  = static_cast&lt;UINT8*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                                                               ControlAEMode));</span><br><span class="line">                                UINT8*   pControlMode             = static_cast&lt;UINT8*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                                                               ControlMode));</span><br><span class="line"></span><br><span class="line">                                UINT32    exposurePriorityTagId   = 0;</span><br><span class="line">                                CDKResult resultCode              = VendorTagManager::QueryVendorTagLocation(</span><br><span class="line">                                                                                &quot;org.codeaurora.qcamera3.iso_exp_priority&quot;,</span><br><span class="line">                                                                                &quot;use_iso_exp_priority&quot;,</span><br><span class="line">                                                                                &amp;exposurePriorityTagId);</span><br><span class="line"></span><br><span class="line">                                ControlAEModeValues AEMode       = ControlAEModeValues::ControlAEModeEnd;</span><br><span class="line">                                ControlModeValues   controlMode  = ControlModeValues::ControlModeEnd;</span><br><span class="line"></span><br><span class="line">                                if (CDKResultSuccess == resultCode)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    pExposurePriority = static_cast&lt;INT64*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                                                            exposurePriorityTagId));</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                if ((NULL != pControlMode) &amp;&amp; (NULL != pAEMode))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    AEMode      = *(reinterpret_cast&lt;ControlAEModeValues*&gt;(pAEMode));</span><br><span class="line">                                    controlMode = *(reinterpret_cast&lt;ControlModeValues*&gt;(pControlMode));</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                INT32  exposureProrityMode    = *pExposurePriorityMode;</span><br><span class="line"></span><br><span class="line">                                if ((1 == exposureProrityMode) &amp;&amp; (NULL != pExposurePriority))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    expectedExposureTime = static_cast&lt;UINT32&gt;((*pExposurePriority) /</span><br><span class="line">                                                                                static_cast&lt;UINT64&gt;(1000000));</span><br><span class="line">                                &#125;</span><br><span class="line">                                else if (NULL != pSensorExposureTime)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    UINT32 exposureTimeInMs =</span><br><span class="line">                                        static_cast&lt;UINT32&gt;((*pSensorExposureTime) / static_cast&lt;UINT64&gt;(1000000));</span><br><span class="line">                                    if ( (exposureTimeInMs &gt; expectedExposureTime) &amp;&amp;</span><br><span class="line">                                         (TRUE == m_isRealTime) &amp;&amp;</span><br><span class="line">                                         (TRUE == pStaticSettings-&gt;extendedTimeForLongExposure) &amp;&amp;</span><br><span class="line">                                         ((ControlModeValues::ControlModeOff == controlMode) ||</span><br><span class="line">                                          (ControlAEModeValues::ControlAEModeOff == AEMode)))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        expectedExposureTime = exposureTimeInMs;</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                    if ((NULL != pSensorFrameDurationTime) &amp;&amp; (NULL != pExposurePriorityMode))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        UINT32 sensorDurationTimeInMs =</span><br><span class="line">                                            static_cast&lt;UINT32&gt;((*pSensorFrameDurationTime) / static_cast&lt;UINT64&gt;(1000000));</span><br><span class="line"></span><br><span class="line">                                        if ((1 == exposureProrityMode) &amp;&amp; (ControlAEModeValues::ControlAEModeOn == AEMode))</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            expectedExposureTime =</span><br><span class="line">                                                    CamX::Utils::MaxUINT32(sensorDurationTimeInMs, expectedExposureTime);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                // m_batchedFrameIndex of 0 implies batching may be switched ON/OFF starting from this frame</span><br><span class="line">                                if (TRUE == IsUsecaseBatchingEnabled())</span><br><span class="line">                                &#123;</span><br><span class="line">                                    RangeINT32* pFPSRange = static_cast&lt;RangeINT32*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                                                                     ControlAETargetFpsRange));</span><br><span class="line"></span><br><span class="line">                                    // Must have been filled by GetMetadataByTag()</span><br><span class="line">                                    CAMX_ASSERT(NULL != pFPSRange);</span><br><span class="line"></span><br><span class="line">                                    BOOL hasBatchingModeChanged = FALSE;</span><br><span class="line"></span><br><span class="line">                                    if ((NULL != pFPSRange) &amp;&amp; (pFPSRange-&gt;min == pFPSRange-&gt;max))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        if (FALSE == m_isRequestBatchingOn)</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            hasBatchingModeChanged = TRUE;</span><br><span class="line">                                        &#125;</span><br><span class="line"></span><br><span class="line">                                        m_isRequestBatchingOn = TRUE;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    else</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        if (TRUE == m_isRequestBatchingOn)</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            hasBatchingModeChanged = TRUE;</span><br><span class="line">                                        &#125;</span><br><span class="line"></span><br><span class="line">                                        m_isRequestBatchingOn = FALSE;</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                    // If batching mode changes from ON to OFF or OFF to ON we need to dynamically adjust</span><br><span class="line">                                    // m_requestQueueDepth - because m_requestQueueDepth is different with batching ON or</span><br><span class="line">                                    // OFF With batching OFF it is RequestQueueDepth and with ON it is</span><br><span class="line">                                    // &quot;RequestQueueDepth * usecaseNumBatchedFrames&quot;</span><br><span class="line">                                    if (TRUE == hasBatchingModeChanged)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        // Before changing m_requestQueueDepth, we need to make sure:</span><br><span class="line">                                        // 1. All the current pending requests are processed by the Pipeline</span><br><span class="line">                                        // 2. All the results for all those processed requests are sent back to the</span><br><span class="line">                                        //    framework</span><br><span class="line">                                        //</span><br><span class="line">                                        // (1) is done by waiting for the request queue to become empty</span><br><span class="line">                                        // (2) is done by waiting on a condition variable that is signaled when all results</span><br><span class="line">                                        //     are sent back to the framework</span><br><span class="line">                                        m_pRequestQueue-&gt;WaitEmpty();</span><br><span class="line"></span><br><span class="line">                                        m_pLivePendingRequestsLock-&gt;Lock();</span><br><span class="line">                                        m_livePendingRequests--;</span><br><span class="line">                                        m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">                                        if (CamxResultSuccess != WaitTillAllResultsAvailable())</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            CAMX_LOG_WARN(CamxLogGroupCore,</span><br><span class="line">                                                          &quot;Failed to drain on batching mode change, calling flush&quot;);</span><br><span class="line">                                            Flush();</span><br><span class="line">                                        &#125;</span><br><span class="line"></span><br><span class="line">                                        m_pLivePendingRequestsLock-&gt;Lock();</span><br><span class="line">                                        m_livePendingRequests++;</span><br><span class="line">                                        m_pLivePendingRequestsLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">                                        // The request and result queues are completely empty at this point, and this</span><br><span class="line">                                        // function is the only thing that can add to the request queue.  Safe to change</span><br><span class="line">                                        // m_requestQueueDepth at this point</span><br><span class="line">                                        if (TRUE == m_isRequestBatchingOn)</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            m_requestQueueDepth      =</span><br><span class="line">                                                DefaultRequestQueueDepth *</span><br><span class="line">                                                GetBatchedHALOutputNum(m_usecaseNumBatchedFrames, m_HALOutputBufferCombined);</span><br><span class="line">                                            m_maxLivePendingRequests =</span><br><span class="line">                                                m_defaultMaxLivePendingRequests *</span><br><span class="line">                                                GetBatchedHALOutputNum(m_usecaseNumBatchedFrames, m_HALOutputBufferCombined);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        else</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            m_requestQueueDepth      = DefaultRequestQueueDepth;</span><br><span class="line">                                            m_maxLivePendingRequests = m_defaultMaxLivePendingRequests;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    else</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        // Need to set default value if batch mode is enabled but request batching is off.</span><br><span class="line">                                        // In this case we have only preview reqest.</span><br><span class="line">                                        if (FALSE == m_isRequestBatchingOn)</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            m_requestQueueDepth      = DefaultRequestQueueDepth;</span><br><span class="line">                                            m_maxLivePendingRequests = m_defaultMaxLivePendingRequests;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                if ((0 != m_recordingEndOfStreamTagId) &amp;&amp; (0 != m_recordingEndOfStreamRequestIdTagId))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    UINT8* pRecordingEndOfStream = static_cast&lt;UINT8*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                        m_recordingEndOfStreamTagId));</span><br><span class="line"></span><br><span class="line">                                    if ((FALSE == pStaticSettings-&gt;disableDRQPreemptionOnStopRecord) &amp;&amp;</span><br><span class="line">                                        ((NULL != pRecordingEndOfStream) &amp;&amp; (0 != *pRecordingEndOfStream)))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        UINT64 requestId = m_requestBatchId[pipelineIndex];</span><br><span class="line">                                        CAMX_LOG_INFO(CamxLogGroupCore, &quot;Recording stopped on reqId %llu&quot;, requestId);</span><br><span class="line"></span><br><span class="line">                                        UINT32 endOfStreamRequestIdTag = m_recordingEndOfStreamRequestIdTagId;</span><br><span class="line"></span><br><span class="line">                                        pUsecasePoolSlot-&gt;SetMetadataByTag(endOfStreamRequestIdTag,</span><br><span class="line">                                                                           static_cast&lt;VOID*&gt;(&amp;requestId),</span><br><span class="line">                                                                           sizeof(requestId),</span><br><span class="line">                                                                           &quot;camx_session&quot;);</span><br><span class="line"></span><br><span class="line">                                        pUsecasePoolSlot-&gt;PublishMetadataList(&amp;endOfStreamRequestIdTag, 1);</span><br><span class="line"></span><br><span class="line">                                        m_setVideoPerfModeFlag = TRUE;</span><br><span class="line">                                        m_pDeferredRequestQueue-&gt;SetPreemptDependencyFlag(TRUE);</span><br><span class="line">                                        m_pDeferredRequestQueue-&gt;DispatchReadyNodes();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    else</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        m_setVideoPerfModeFlag = FALSE;</span><br><span class="line">                                        m_pDeferredRequestQueue-&gt;SetPreemptDependencyFlag(FALSE);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                else</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CAMX_LOG_INFO(CamxLogGroupCore, &quot;No stop recording vendor tags&quot;);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                ControlCaptureIntentValues* pCaptureIntent = static_cast&lt;ControlCaptureIntentValues*&gt;(</span><br><span class="line">                                    pMetadataSlot-&gt;GetMetadataByTag(ControlCaptureIntent));</span><br><span class="line"></span><br><span class="line">                                // Update dynamic pipeline depth metadata which is required in capture result.</span><br><span class="line">                                pResultMetadataSlot-&gt;SetMetadataByTag(RequestPipelineDepth,</span><br><span class="line">                                                                      static_cast&lt;VOID*&gt;(&amp;(m_requestQueueDepth)),</span><br><span class="line">                                                                      1,</span><br><span class="line">                                                                      &quot;camx_session&quot;);</span><br><span class="line"></span><br><span class="line">                                if (NULL != pCaptureIntent)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    // Copy Intent to result</span><br><span class="line">                                    result = pResultMetadataSlot-&gt;SetMetadataByTag(ControlCaptureIntent, pCaptureIntent, 1,</span><br><span class="line">                                                                                   &quot;camx_session&quot;);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">                                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Couldn&apos;t copy request metadata!&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                            CAMX_LOG_ERROR(CamxLogGroupCore,</span><br><span class="line">                                            &quot;Couldn&apos;t get metadata slot for request id: %d&quot;,</span><br><span class="line">                                            requests[requestIndex].frameNumber);</span><br><span class="line"></span><br><span class="line">                            result = CamxResultEFailed;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // Get the per frame sensor mode index</span><br><span class="line">                        UINT* pSensorModeIndex  = NULL;</span><br><span class="line"></span><br><span class="line">                        if (m_vendorTagSensorModeIndex &gt; 0)</span><br><span class="line">                        &#123;</span><br><span class="line">                            if (NULL != pMetadataSlot)</span><br><span class="line">                            &#123;</span><br><span class="line">                                pSensorModeIndex = static_cast&lt;UINT*&gt;(pMetadataSlot-&gt;GetMetadataByTag(</span><br><span class="line">                                    m_vendorTagSensorModeIndex));</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            if (NULL != pSensorModeIndex)</span><br><span class="line">                            &#123;</span><br><span class="line">                                pResultMetadataSlot-&gt;WriteLock();</span><br><span class="line"></span><br><span class="line">                                pStaticSettings = HwEnvironment::GetInstance()-&gt;GetStaticSettings();</span><br><span class="line"></span><br><span class="line">                                if (TRUE == pStaticSettings-&gt;perFrameSensorMode)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    pResultMetadataSlot-&gt;SetMetadataByTag(PropertyIDSensorCurrentMode, pSensorModeIndex, 1,</span><br><span class="line">                                                                          &quot;camx_session&quot;);</span><br><span class="line">                                    pResultMetadataSlot-&gt;PublishMetadata(PropertyIDSensorCurrentMode);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                pResultMetadataSlot-&gt;Unlock();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // Check and update, if the preview stream is present in this request</span><br><span class="line">                        if (m_previewStreamPresentTagId &gt; 0)</span><br><span class="line">                        &#123;</span><br><span class="line">                            BOOL isPreviewPresent = FALSE;</span><br><span class="line">                            for (UINT32 i = 0; i &lt; pCaptureRequest-&gt;numOutputs; i++)</span><br><span class="line">                            &#123;</span><br><span class="line">                                CHISTREAM*        pStream    = pCaptureRequest-&gt;pOutputBuffers[i].pStream;</span><br><span class="line">                                ChiStreamWrapper* pChiStream = static_cast&lt;ChiStreamWrapper*&gt;(pStream-&gt;pPrivateInfo);</span><br><span class="line">                                if ((NULL != pChiStream) &amp;&amp; (TRUE == pChiStream-&gt;IsPreviewStream()))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    isPreviewPresent = TRUE;</span><br><span class="line">                                    break;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            // Update the metadata tag.</span><br><span class="line">                            pResultMetadataSlot-&gt;WriteLock();</span><br><span class="line">                            pResultMetadataSlot-&gt;SetMetadataByTag(m_previewStreamPresentTagId,</span><br><span class="line">                                                                  static_cast&lt;VOID*&gt;(&amp;(isPreviewPresent)),</span><br><span class="line">                                                                  1,</span><br><span class="line">                                                                  &quot;camx_session&quot;);</span><br><span class="line">                            pResultMetadataSlot-&gt;PublishMetadata(m_previewStreamPresentTagId);</span><br><span class="line">                            pResultMetadataSlot-&gt;Unlock();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (CamxResultSuccess == result)</span><br><span class="line">                    &#123;</span><br><span class="line">                        /// Adding 1 to avoid 0 as 0 is flagged as invalid</span><br><span class="line">                        UINT64            cslsyncid         = pCaptureRequest-&gt;frameNumber + 1;</span><br><span class="line">                        CaptureRequest*   pRequest          = &amp;(m_captureRequest.requests[requestIndex]);</span><br><span class="line">                        UINT              batchedFrameIndex = m_batchedFrameIndex[pipelineIndex];</span><br><span class="line">                        ChiStreamWrapper* pChiStreamWrapper = NULL;</span><br><span class="line">                        ChiStream*        pChiStream        = NULL;</span><br><span class="line"></span><br><span class="line">                        m_lastCSLSyncId                                                     = cslsyncid;</span><br><span class="line">                        pRequest-&gt;CSLSyncID                                                 = cslsyncid;</span><br><span class="line">                        pRequest-&gt;expectedExposureTime                                      = expectedExposureTime;</span><br><span class="line">                        pRequest-&gt;pPrivData                                                 = pCaptureRequest-&gt;pPrivData;</span><br><span class="line">                        pRequest-&gt;pStreamBuffers[batchedFrameIndex].originalFrameworkNumber = pCaptureRequest-&gt;frameNumber;</span><br><span class="line">                        pRequest-&gt;pStreamBuffers[batchedFrameIndex].numInputBuffers         = requests[requestIndex].numInputs;</span><br><span class="line"></span><br><span class="line">                        pRequest-&gt;pStreamBuffers[batchedFrameIndex].sequenceId =</span><br><span class="line">                            static_cast&lt;UINT32&gt;(requests[requestIndex].frameNumber);</span><br><span class="line"></span><br><span class="line">                        for (UINT i = 0; i &lt; requests[requestIndex].numInputs; i++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            /// @todo (CAMX-1015): Avoid this memcpy.</span><br><span class="line">                            Utils::Memcpy(&amp;pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].inputBuffer,</span><br><span class="line">                                            &amp;requests[requestIndex].pInputBuffers[i],</span><br><span class="line">                                            sizeof(ChiStreamBuffer));</span><br><span class="line"></span><br><span class="line">                            pChiStream = reinterpret_cast&lt;ChiStream*&gt;(</span><br><span class="line">                                pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].inputBuffer.pStream);</span><br><span class="line"></span><br><span class="line">                            if (NULL != pChiStream)</span><br><span class="line">                            &#123;</span><br><span class="line">                                pChiStreamWrapper = reinterpret_cast&lt;ChiStreamWrapper*&gt;(pChiStream-&gt;pPrivateInfo);</span><br><span class="line"></span><br><span class="line">                                if (pChiStreamWrapper != NULL)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CamxAtomicStoreU(&amp;pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].fenceRefCount,</span><br><span class="line">                                    pChiStreamWrapper-&gt;GetNumberOfPortId());</span><br><span class="line">                                &#125;</span><br><span class="line">                                else</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CamxAtomicStoreU(&amp;pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].fenceRefCount,</span><br><span class="line">                                    1);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                if (0 == pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].fenceRefCount)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CAMX_LOG_WARN(CamxLogGroupCore, &quot;fenceRefCount shouldn&apos;t be zero for input buffer&quot;);</span><br><span class="line"></span><br><span class="line">                                    // Assigning fence count to 1 for input buffer if it is 0.</span><br><span class="line">                                    // this is to avoid any regressions due to source port sharing.</span><br><span class="line">                                    pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].fenceRefCount = 1;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                // Below check is ideally not required but to avoid</span><br><span class="line">                                // regressions making it applicable to only MFNR/MFSR</span><br><span class="line">                                if (requests[requestIndex].numInputs &gt; 1)</span><br><span class="line">                                &#123;</span><br><span class="line"></span><br><span class="line">                                    if (pChiStreamWrapper != NULL)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].portId =</span><br><span class="line">                                        pChiStreamWrapper-&gt;GetPortId();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    else</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        if(i==0)</span><br><span class="line">                                        pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].portId = 0;</span><br><span class="line">                                        if(i==1)</span><br><span class="line">                                        pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].portId = 3;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    CAMX_LOG_VERBOSE(CamxLogGroupCore,</span><br><span class="line">                                    &quot;input buffers #%d, port %d, dim %d x %d wrapper %x, stream %x fenceRefCount %d&quot;,</span><br><span class="line">                                    i, pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].portId,</span><br><span class="line">                                    pChiStream-&gt;width, pChiStream-&gt;height, pChiStreamWrapper, pChiStream,</span><br><span class="line">                                    pRequest-&gt;pStreamBuffers[batchedFrameIndex].inputBufferInfo[i].fenceRefCount);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (CamxResultSuccess == result)</span><br><span class="line">                        &#123;</span><br><span class="line">                            /// @todo (CAMX-1797) Delete this</span><br><span class="line">                            pRequest-&gt;pipelineIndex    = pipelineIndex;</span><br><span class="line"></span><br><span class="line">                            CAMX_LOG_VERBOSE(CamxLogGroupCore,</span><br><span class="line">                                             &quot;Submit to pipeline index: %d / number of pipelines: %d batched index %d&quot;,</span><br><span class="line">                                             pRequest-&gt;pipelineIndex, m_numPipelines, m_batchedFrameIndex[pipelineIndex]);</span><br><span class="line"></span><br><span class="line">                            CAMX_ASSERT(requests[requestIndex].numOutputs &lt;= MaxOutputBuffers);</span><br><span class="line"></span><br><span class="line">                            pRequest-&gt;pStreamBuffers[m_batchedFrameIndex[pipelineIndex]].numOutputBuffers =</span><br><span class="line">                                requests[requestIndex].numOutputs;</span><br><span class="line"></span><br><span class="line">                            for (UINT i = 0; i &lt; requests[requestIndex].numOutputs; i++)</span><br><span class="line">                            &#123;</span><br><span class="line">                                /// @todo (CAMX-1015): Avoid this memcpy.</span><br><span class="line">                                Utils::Memcpy(&amp;pRequest-&gt;pStreamBuffers[m_batchedFrameIndex[pipelineIndex]].outputBuffers[i],</span><br><span class="line">                                              &amp;requests[requestIndex].pOutputBuffers[i],</span><br><span class="line">                                              sizeof(ChiStreamBuffer));</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            // Increment batch index only if batch mode is on</span><br><span class="line">                            if (TRUE == m_isRequestBatchingOn)</span><br><span class="line">                            &#123;</span><br><span class="line">                                m_batchedFrameIndex[pipelineIndex]++;</span><br><span class="line">                                pRequest-&gt;numBatchedFrames          = m_usecaseNumBatchedFrames;</span><br><span class="line">                                pRequest-&gt;HALOutputBufferCombined   = m_HALOutputBufferCombined;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">                                m_batchedFrameIndex[pipelineIndex]  = 0;</span><br><span class="line">                                pRequest-&gt;numBatchedFrames          = 1;</span><br><span class="line">                                pRequest-&gt;HALOutputBufferCombined   = FALSE;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (CamxResultSuccess == result)</span><br><span class="line">                    &#123;</span><br><span class="line">                        // Fill Color Metadata for output buffer</span><br><span class="line">                        result = SetPerStreamColorMetadata(pCaptureRequest, pPerFrameInputPool,</span><br><span class="line">                                                           m_requestBatchId[pipelineIndex]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Acquire fence failed for request&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupCore, &quot;Session unable to process request because of device state&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_LOG_ERROR(CamxLogGroupCore, &quot;PerFrame MetadataPool is NULL&quot;);</span><br><span class="line">            result = CamxResultEInvalidPointer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Update multi request sync data</span><br><span class="line">    if ((CamxResultSuccess == result) &amp;&amp; (m_numInputSensors &gt;= 2))</span><br><span class="line">    &#123;</span><br><span class="line">        UpdateMultiRequestSyncData(pPipelineRequests);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CamxResultSuccess == result)</span><br><span class="line">    &#123;</span><br><span class="line">        // Once we batch all the frames according to usecaseNumBatchedFrames we enqueue the capture request.</span><br><span class="line">        // For non-batch mode m_usecaseNumBatchedFrames is 1 so we enqueue every request. If batching is ON</span><br><span class="line">        // we enqueue the batched capture request only after m_usecaseBatchSize number of requests have been</span><br><span class="line">        // received</span><br><span class="line">        BOOL batchFrameReady = TRUE;</span><br><span class="line">        for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">        &#123;</span><br><span class="line">            UINT32 pipelineIndex = pipelineIndexes[requestIndex];</span><br><span class="line"></span><br><span class="line">            if (m_batchedFrameIndex[pipelineIndex] !=</span><br><span class="line">                GetBatchedHALOutputNum(m_usecaseNumBatchedFrames, m_HALOutputBufferCombined))</span><br><span class="line">            &#123;</span><br><span class="line">                batchFrameReady = FALSE;</span><br><span class="line">                break; // batch frame number must be same for all the pipelines in same session</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ((FALSE == m_isRequestBatchingOn) || (TRUE == batchFrameReady))</span><br><span class="line">        &#123;</span><br><span class="line">            result = m_pRequestQueue-&gt;EnqueueWait(&amp;m_captureRequest);</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                // Check for good conditions once more, if enqueue had to wait</span><br><span class="line">                for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    result = CanRequestProceed(&amp;requests[requestIndex]);</span><br><span class="line">                    if (CamxResultSuccess != result)</span><br><span class="line">                    &#123;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (CamxResultSuccess == result)</span><br><span class="line">            &#123;</span><br><span class="line">                for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    const ChiCaptureRequest* pCaptureRequest = &amp;(pPipelineRequests-&gt;pCaptureRequests[requestIndex]);</span><br><span class="line">                    CAMX_LOG_CONFIG(CamxLogGroupCore,</span><br><span class="line">                        &quot;Pipeline: %s Added Sequence ID %lld CHI framenumber %lld to request queue and launched job &quot;</span><br><span class="line">                        &quot;with request id %llu&quot;,</span><br><span class="line">                        m_pipelineData[pipelineIndexes[requestIndex]].pPipeline-&gt;GetPipelineIdentifierString(),</span><br><span class="line">                        requests[requestIndex].frameNumber, pCaptureRequest-&gt;frameNumber,</span><br><span class="line">                        m_requestBatchId[pipelineIndexes[requestIndex]]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                VOID* pData[] = &#123;this, NULL&#125;;</span><br><span class="line">                result        = m_pThreadManager-&gt;PostJob(m_hJobFamilyHandle,</span><br><span class="line">                                                          NULL,</span><br><span class="line">                                                          &amp;pData[0],</span><br><span class="line">                                                          FALSE,</span><br><span class="line">                                                          FALSE);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_WARN(CamxLogGroupCore, &quot;Session unable to process request because of device state&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (UINT requestIndex = 0; requestIndex &lt; numRequests; requestIndex++)</span><br><span class="line">            &#123;</span><br><span class="line">                m_batchedFrameIndex[pipelineIndexes[requestIndex]] = 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_pStreamOnOffLock-&gt;Unlock();</span><br><span class="line">    m_pFlushLock-&gt;Unlock();</span><br><span class="line">    CAMX_ASSERT(CamxResultSuccess == result);</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-4-3-1-Session-ProcessRequest"><a href="#4-4-3-1-Session-ProcessRequest" class="headerlink" title="4.4.3.1 Session::ProcessRequest"></a>4.4.3.1 Session::ProcessRequest</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// Session::ProcessRequest</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">CamxResult Session::ProcessRequest()</span><br><span class="line">&#123;</span><br><span class="line">    CamxResult              result          = CamxResultSuccess;</span><br><span class="line">    SessionCaptureRequest*  pSessionRequest = NULL;</span><br><span class="line"></span><br><span class="line">    // This should only ever be called from threadpool, should never be reentrant, and nothing else  grabs the request lock.</span><br><span class="line">    // If there is contention on this lock something very bad happened.</span><br><span class="line">    result = m_pRequestLock-&gt;TryLock();</span><br><span class="line">    if (CamxResultSuccess != result)</span><br><span class="line">    &#123;</span><br><span class="line">        // Should never happen...return control back to the threadpool and this will eventually get called again</span><br><span class="line">        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Could not grab m_pRequestLock...undefined behavior possible&quot;);</span><br><span class="line"></span><br><span class="line">        return CamxResultETryAgain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize a result holder expected for the result coming out of this request</span><br><span class="line">    // This information will be used in the result notification path</span><br><span class="line"></span><br><span class="line">    pSessionRequest = static_cast&lt;SessionCaptureRequest*&gt;(m_pRequestQueue-&gt;Dequeue());</span><br><span class="line"></span><br><span class="line">    if (NULL != pSessionRequest)</span><br><span class="line">    &#123;</span><br><span class="line">        // If session request contain multiple pipeline request, it means pipelines need to be sync</span><br><span class="line">        // and the batch frame number must be same.</span><br><span class="line">        UINT32 numBatchedFrames = pSessionRequest-&gt;requests[0].GetBatchedHALOutputNum(&amp;pSessionRequest-&gt;requests[0]);</span><br><span class="line">        for (UINT requestIndex = 1; requestIndex &lt; pSessionRequest-&gt;numRequests; requestIndex++)</span><br><span class="line">        &#123;</span><br><span class="line">            if (numBatchedFrames !=</span><br><span class="line">                pSessionRequest-&gt;requests[requestIndex].GetBatchedHALOutputNum(&amp;pSessionRequest-&gt;requests[requestIndex]))</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore,</span><br><span class="line">                    &quot;batch frame number are different in different pipline request&quot;);</span><br><span class="line">                m_pRequestLock-&gt;Unlock();</span><br><span class="line">                return CamxResultEInvalidArg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        const SettingsManager* pSettingManager = HwEnvironment::GetInstance()-&gt;GetSettingsManager();</span><br><span class="line"></span><br><span class="line">        if (TRUE == pSettingManager-&gt;GetStaticSettings()-&gt;dynamicPropertiesEnabled)</span><br><span class="line">        &#123;</span><br><span class="line">            // NOWHINE CP036a: We&apos;re actually poking into updating the settings dynamically so we do want to do this</span><br><span class="line">            const_cast&lt;SettingsManager*&gt;(pSettingManager)-&gt;UpdateOverrideProperties();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LightweightDoublyLinkedListNode** ppResultNodes         = NULL;</span><br><span class="line">        SessionResultHolder**             ppSessionResultHolder = NULL;</span><br><span class="line"></span><br><span class="line">        for (UINT requestIndex = 0; requestIndex &lt; pSessionRequest-&gt;numRequests; requestIndex++)</span><br><span class="line">        &#123;</span><br><span class="line">            CaptureRequest&amp; rRequest = pSessionRequest-&gt;requests[requestIndex];</span><br><span class="line">            CAMX_ASSERT(rRequest.numBatchedFrames &gt; 0);</span><br><span class="line"></span><br><span class="line">            if (NULL == ppResultNodes)</span><br><span class="line">            &#123;</span><br><span class="line">                ppResultNodes = reinterpret_cast&lt;LightweightDoublyLinkedListNode**&gt;(</span><br><span class="line">                    CAMX_CALLOC(numBatchedFrames * sizeof(LightweightDoublyLinkedListNode*)));</span><br><span class="line"></span><br><span class="line">                if (NULL == ppResultNodes)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_ERROR(CamxLogGroupCore, &quot;memory allocation failed for ppResultNodes for request %llu&quot;,</span><br><span class="line">                        rRequest.requestId);</span><br><span class="line">                    result = CamxResultENoMemory;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (NULL == ppSessionResultHolder)</span><br><span class="line">            &#123;</span><br><span class="line">                ppSessionResultHolder = reinterpret_cast&lt;SessionResultHolder**&gt;(</span><br><span class="line">                    CAMX_CALLOC(numBatchedFrames * sizeof(SessionResultHolder*)));</span><br><span class="line">                if (NULL == ppSessionResultHolder)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_ERROR(CamxLogGroupCore, &quot;memory allocation failed for ppSessionResultHolder for request %llu&quot;,</span><br><span class="line">                        rRequest.requestId);</span><br><span class="line">                    result = CamxResultENoMemory;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if ((NULL != ppResultNodes) &amp;&amp; (NULL != ppSessionResultHolder))</span><br><span class="line">            &#123;</span><br><span class="line">                // Add sequence id to framework frame number mapping after CheckRequestProcessingRate() = TRUE</span><br><span class="line">                // This is to make sure new process request do not override old result has not sent to framework yet.</span><br><span class="line">                for (UINT32 batchIndex = 0; batchIndex &lt; rRequest.GetBatchedHALOutputNum(&amp;rRequest); batchIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Pipeline*         pPipeline      = m_pipelineData[rRequest.pipelineIndex].pPipeline;</span><br><span class="line">                    StreamBufferInfo&amp; rStreamBuffer  = rRequest.pStreamBuffers[batchIndex];</span><br><span class="line">                    UINT64            chiFrameNumber = rStreamBuffer.originalFrameworkNumber;</span><br><span class="line">                    UINT64            requestId      = rRequest.requestId;</span><br><span class="line">                    UINT32            sequenceId     = rStreamBuffer.sequenceId;</span><br><span class="line">                    UINT64            CSLSyncID      = rRequest.CSLSyncID;</span><br><span class="line">                    auto              hPipeline      = pPipeline-&gt;GetPipelineDescriptor();</span><br><span class="line">                    m_fwFrameNumberMap[sequenceId % MaxQueueDepth] = chiFrameNumber;</span><br><span class="line"></span><br><span class="line">                    CAMX_LOG_REQMAP(CamxLogGroupCore,</span><br><span class="line">                        &quot;chiFrameNum: %llu  &lt;==&gt;  requestId: %llu  &lt;==&gt;  sequenceId: %u  &lt;==&gt; CSLSyncId: %llu -- %s&quot;,</span><br><span class="line">                        chiFrameNumber, requestId, sequenceId, CSLSyncID,</span><br><span class="line">                        pPipeline-&gt;GetPipelineIdentifierString());</span><br><span class="line"></span><br><span class="line">                    BINARY_LOG(LogEvent::ReqMap_CamXInfo, chiFrameNumber, requestId, sequenceId,</span><br><span class="line">                        CSLSyncID, hPipeline, this);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                for (UINT batchIndex = 0; batchIndex &lt; rRequest.GetBatchedHALOutputNum(&amp;rRequest); batchIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    UINT32 sequenceId = rRequest.pStreamBuffers[batchIndex].sequenceId;</span><br><span class="line"></span><br><span class="line">                    CAMX_TRACE_MESSAGE_F(CamxLogGroupCore, &quot;ProcessRequest: RequestId: %llu sequenceId: %u&quot;,</span><br><span class="line">                        rRequest.requestId, sequenceId);</span><br><span class="line"></span><br><span class="line">                    LightweightDoublyLinkedListNode* pNode = ppResultNodes[batchIndex];</span><br><span class="line">                    if (NULL == pNode)</span><br><span class="line">                    &#123;</span><br><span class="line">                        pNode = reinterpret_cast&lt;LightweightDoublyLinkedListNode*&gt;</span><br><span class="line">                            (CAMX_CALLOC(sizeof(LightweightDoublyLinkedListNode)));</span><br><span class="line">                        ppResultNodes[batchIndex] = pNode;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    SessionResultHolder* pSessionResultHolder = ppSessionResultHolder[batchIndex];</span><br><span class="line">                    if (NULL == pSessionResultHolder)</span><br><span class="line">                    &#123;</span><br><span class="line">                        pSessionResultHolder = reinterpret_cast&lt;SessionResultHolder*&gt;</span><br><span class="line">                            (CAMX_CALLOC(sizeof(SessionResultHolder)));</span><br><span class="line">                        ppSessionResultHolder[batchIndex] = pSessionResultHolder;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if ((NULL == pNode) ||</span><br><span class="line">                        (NULL == pSessionResultHolder))</span><br><span class="line">                    &#123;</span><br><span class="line">                        CAMX_LOG_ERROR(CamxLogGroupCore, &quot;Out of memory pNode=%p pSessionResultHolder=%p&quot;,</span><br><span class="line">                            pNode, pSessionResultHolder);</span><br><span class="line">                        result = CamxResultENoMemory;</span><br><span class="line"></span><br><span class="line">                        if (NULL != pNode)</span><br><span class="line">                        &#123;</span><br><span class="line">                            CAMX_FREE(pNode);</span><br><span class="line">                            pNode = NULL;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (NULL != pSessionResultHolder)</span><br><span class="line">                        &#123;</span><br><span class="line">                            CAMX_FREE(pSessionResultHolder);</span><br><span class="line">                            pSessionResultHolder = NULL;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (CamxResultSuccess == result)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ResultHolder* pHolder = &amp;(pSessionResultHolder-&gt;resultHolders[requestIndex]);</span><br><span class="line">                        Utils::Memset(pHolder, 0x0, sizeof(ResultHolder));</span><br><span class="line">                        pHolder-&gt;sequenceId           = sequenceId;</span><br><span class="line">                        pHolder-&gt;numOutBuffers        = rRequest.pStreamBuffers[batchIndex].numOutputBuffers;</span><br><span class="line">                        pHolder-&gt;numInBuffers         = rRequest.pStreamBuffers[batchIndex].numInputBuffers;</span><br><span class="line">                        pHolder-&gt;pendingMetadataCount = m_numMetadataResults;</span><br><span class="line">                        pHolder-&gt;pPrivData            = rRequest.pPrivData;</span><br><span class="line">                        pHolder-&gt;requestId            = static_cast&lt;UINT32&gt;(rRequest.requestId);</span><br><span class="line">                        pHolder-&gt;expectedExposureTime = static_cast&lt;UINT32&gt;(rRequest.expectedExposureTime);</span><br><span class="line"></span><br><span class="line">                        // We may not get a result metadata for reprocess requests</span><br><span class="line">                        // This logic may need to be expanded for multi-camera CHI override scenarios,</span><br><span class="line">                        // as to designate what pipelines are exactly offline</span><br><span class="line">                        if (rRequest.pipelineIndex &gt; 0)</span><br><span class="line">                        &#123;</span><br><span class="line">                            pHolder-&gt;tentativeMetadata = TRUE;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        for (UINT32 buffer = 0; buffer &lt; pHolder-&gt;numOutBuffers; buffer++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            UINT32 streamIndex = GetStreamIndex(reinterpret_cast&lt;ChiStream*&gt;(</span><br><span class="line">                                rRequest.pStreamBuffers[batchIndex].outputBuffers[buffer].pStream));</span><br><span class="line"></span><br><span class="line">                            if (streamIndex &lt; MaxNumOutputBuffers)</span><br><span class="line">                            &#123;</span><br><span class="line">                                pHolder-&gt;bufferHolder[streamIndex].pBuffer = GetResultStreamBuffer();</span><br><span class="line"></span><br><span class="line">                                Utils::Memcpy(pHolder-&gt;bufferHolder[streamIndex].pBuffer,</span><br><span class="line">                                              &amp;(rRequest.pStreamBuffers[batchIndex].outputBuffers[buffer]),</span><br><span class="line">                                              sizeof(ChiStreamBuffer));</span><br><span class="line"></span><br><span class="line">                                pHolder-&gt;bufferHolder[streamIndex].valid = FALSE;</span><br><span class="line"></span><br><span class="line">                                pHolder-&gt;bufferHolder[streamIndex].pStream = reinterpret_cast&lt;ChiStream*&gt;(</span><br><span class="line">                                    rRequest.pStreamBuffers[batchIndex].outputBuffers[buffer].pStream);</span><br><span class="line"></span><br><span class="line">                                ChiStreamWrapper* pChiStreamWrapper = static_cast&lt;ChiStreamWrapper*&gt;(</span><br><span class="line">                                    rRequest.pStreamBuffers[batchIndex].outputBuffers[buffer].pStream-&gt;pPrivateInfo);</span><br><span class="line"></span><br><span class="line">                                pChiStreamWrapper-&gt;AddEnabledInFrame(rRequest.pStreamBuffers[batchIndex].sequenceId);</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">                                CAMX_LOG_ERROR(CamxLogGroupCore, &quot;stream index = %d &lt; MaxNumOutputBuffers = %d&quot;,</span><br><span class="line">                                               streamIndex, MaxNumOutputBuffers);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // Create internal private input buffer fences and relase them (below), so that</span><br><span class="line">                        // input fence trigger mechanism would work same way that when the input fences</span><br><span class="line">                        // released from previous/parent node output buffer</span><br><span class="line"></span><br><span class="line">                        for (UINT32 buffer = 0; buffer &lt; pHolder-&gt;numInBuffers; buffer++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            StreamInputBufferInfo* pInputBufferInfo   = rRequest.pStreamBuffers[batchIndex].inputBufferInfo;</span><br><span class="line">                            ChiStreamBuffer*       pInputBuffer       = &amp;(pInputBufferInfo[buffer].inputBuffer);</span><br><span class="line">                            CSLFence*              phCSLFence         = NULL;</span><br><span class="line">                            CHIFENCEHANDLE*        phAcquireFence     = NULL;</span><br><span class="line">                            UINT32                 streamIndex        = 0;</span><br><span class="line">                            ChiStream*             pInputBufferStream = reinterpret_cast&lt;ChiStream*&gt;(pInputBuffer-&gt;pStream);</span><br><span class="line"></span><br><span class="line">                            /// @todo (CAMX-1797) Kernel currently requires us to pass a fence always even if we dont need it.</span><br><span class="line">                            ///                   Fix that and also need to handle input fence mechanism</span><br><span class="line">                            phCSLFence = &amp;(pInputBufferInfo[buffer].fence);</span><br><span class="line"></span><br><span class="line">                            if ((TRUE == pInputBuffer-&gt;acquireFence.valid) &amp;&amp;</span><br><span class="line">                                (ChiFenceTypeInternal == pInputBuffer-&gt;acquireFence.type))</span><br><span class="line">                            &#123;</span><br><span class="line">                                phAcquireFence = &amp;(pInputBuffer-&gt;acquireFence.hChiFence);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            if (FALSE == IsValidCHIFence(phAcquireFence))</span><br><span class="line">                            &#123;</span><br><span class="line">                                result = CSLCreatePrivateFence(&quot;InputBufferFence_session&quot;, phCSLFence);</span><br><span class="line">                                CAMX_ASSERT(CamxResultSuccess == result);</span><br><span class="line"></span><br><span class="line">                                if (CamxResultSuccess != result)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CAMX_LOG_ERROR(CamxLogGroupCore, &quot;process request failed : result %d&quot;, result);</span><br><span class="line">                                    break;</span><br><span class="line">                                &#125;</span><br><span class="line">                                else</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CAMX_LOG_VERBOSE(CamxLogGroupCore, &quot;CSLCreatePrivateFence:%d Used&quot;, *phCSLFence);</span><br><span class="line">                                &#125;</span><br><span class="line">                                pInputBufferInfo[buffer].isChiFence = FALSE;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">                                *phCSLFence = reinterpret_cast&lt;ChiFence*&gt;(*phAcquireFence)-&gt;hFence;</span><br><span class="line">                                pInputBufferInfo[buffer].isChiFence = TRUE;</span><br><span class="line">                                CAMX_LOG_VERBOSE(CamxLogGroupCore, &quot;AcquireFence:%d Used&quot;, *phCSLFence);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            // While CamX &lt;=&gt; CHI allows for more than 1 Input Buffer per request,</span><br><span class="line">                            // The   CHI  &lt;=&gt; HAL &lt;=&gt; App Framework layers do not.</span><br><span class="line">                            // The input buffer holder only can only properly represent Camera3 Input Streams</span><br><span class="line">                            // The maximum number of Camera3 input buffers supported is 1</span><br><span class="line">                            CAMX_STATIC_ASSERT(MaxNumInputBuffers == 1);</span><br><span class="line">                            CAMX_STATIC_ASSERT(CAMX_ARRAY_SIZE(pHolder-&gt;inputbufferHolder) == 1);</span><br><span class="line">                            streamIndex = 0;</span><br><span class="line">                            if (streamIndex &lt; MaxNumInputBuffers)</span><br><span class="line">                            &#123;</span><br><span class="line">                                ChiStreamBuffer* pChiResultStreamBuffer = GetResultStreamBuffer();</span><br><span class="line"></span><br><span class="line">                                Utils::Memcpy(pChiResultStreamBuffer, pInputBuffer, sizeof(ChiStreamBuffer));</span><br><span class="line">                                pHolder-&gt;inputbufferHolder[streamIndex].pBuffer = pChiResultStreamBuffer;</span><br><span class="line">                                pHolder-&gt;inputbufferHolder[streamIndex].pStream = pInputBufferStream;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else</span><br><span class="line">                    &#123;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ((NULL != ppResultNodes) &amp;&amp; (NULL != ppSessionResultHolder))</span><br><span class="line">        &#123;</span><br><span class="line">            // Lets start accounting for this request&apos;s exposure time</span><br><span class="line">            UINT32 totalResultExposureTime = 0;</span><br><span class="line"></span><br><span class="line">            // Now add the result holder to the linked list</span><br><span class="line">            for (UINT batchIndex = 0; batchIndex &lt; numBatchedFrames; batchIndex++)</span><br><span class="line">            &#123;</span><br><span class="line">                LightweightDoublyLinkedListNode* pNode                  = ppResultNodes[batchIndex];</span><br><span class="line">                SessionResultHolder*             pSessionResultHolder   = ppSessionResultHolder[batchIndex];</span><br><span class="line">                pSessionResultHolder-&gt;numResults = pSessionRequest-&gt;numRequests;</span><br><span class="line">                pNode-&gt;pData = pSessionResultHolder;</span><br><span class="line">                m_pResultHolderListLock-&gt;Lock();</span><br><span class="line">                m_resultHolderList.InsertToTail(pNode);</span><br><span class="line">                m_pResultHolderListLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">                for (UINT idx = 0; idx &lt; pSessionResultHolder-&gt;numResults; idx++)</span><br><span class="line">                &#123;</span><br><span class="line">                    totalResultExposureTime += pSessionResultHolder-&gt;resultHolders[idx].expectedExposureTime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            UINT32 totalExposureTime = CamxAtomicIncU32(&amp;m_aTotalLongExposureTimeout, totalResultExposureTime);</span><br><span class="line">            CAMX_LOG_VERBOSE(CamxLogGroupCore,</span><br><span class="line">                &quot;Session %p - exposureTimeout after accounting for %u requests starting with requestID %llu = %u&quot;,</span><br><span class="line">                this,</span><br><span class="line">                pSessionRequest-&gt;numRequests,</span><br><span class="line">                pSessionRequest-&gt;requests-&gt;requestId,</span><br><span class="line">                totalExposureTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // De-acllocate the array of ppResultNodes and ppSessionResultHolder.</span><br><span class="line">        // The actual node and session result holder will be free in processResult</span><br><span class="line">        if (NULL != ppResultNodes)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_FREE(ppResultNodes);</span><br><span class="line">            ppResultNodes = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">        if (NULL != ppSessionResultHolder)</span><br><span class="line">        &#123;</span><br><span class="line">            CAMX_FREE(ppSessionResultHolder);</span><br><span class="line">            ppSessionResultHolder = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    m_pRequestLock-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">    if (NULL != pSessionRequest)</span><br><span class="line">    &#123;</span><br><span class="line">        BOOL isSyncMode = TRUE;</span><br><span class="line"></span><br><span class="line">        if ((pSessionRequest-&gt;numRequests &lt;= 1) ||</span><br><span class="line">            (CSLSyncLinkModeNoSync == m_linkSyncMode))</span><br><span class="line">        &#123;</span><br><span class="line">            isSyncMode = FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (UINT requestIndex = 0; requestIndex &lt; pSessionRequest-&gt;numRequests; requestIndex++)</span><br><span class="line">        &#123;</span><br><span class="line">            CaptureRequest&amp; rRequest = pSessionRequest-&gt;requests[requestIndex];</span><br><span class="line"></span><br><span class="line">            result = m_pipelineData[rRequest.pipelineIndex].pPipeline-&gt;OpenRequest(rRequest.requestId,</span><br><span class="line">                rRequest.CSLSyncID, isSyncMode, rRequest.expectedExposureTime);</span><br><span class="line"></span><br><span class="line">            CAMX_LOG_INFO(CamxLogGroupCore,</span><br><span class="line">                &quot;pipeline[%d] OpenRequest called for request id = %llu withCSLSyncID %llu&quot;,</span><br><span class="line">                rRequest.pipelineIndex,</span><br><span class="line">                rRequest.requestId,</span><br><span class="line">                rRequest.CSLSyncID);</span><br><span class="line"></span><br><span class="line">            if ((CamxResultSuccess != result) &amp;&amp; (CamxResultECancelledRequest != result))</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_ERROR(CamxLogGroupCore,</span><br><span class="line">                    &quot;pipeline[%d] OpenRequest failed for request id = %llu withCSLSyncID %llu result = %s&quot;,</span><br><span class="line">                    rRequest.pipelineIndex,</span><br><span class="line">                    rRequest.requestId,</span><br><span class="line">                    rRequest.CSLSyncID,</span><br><span class="line">                    Utils::CamxResultToString(result));</span><br><span class="line">            &#125;</span><br><span class="line">            else if (CamxResultECancelledRequest == result)</span><br><span class="line">            &#123;</span><br><span class="line">                CAMX_LOG_INFO(CamxLogGroupCore, &quot;Session: %p is in Flush state, Canceling OpenRequest for pipeline[%d] &quot;</span><br><span class="line">                    &quot;for request id = %llu&quot;, this, rRequest.pipelineIndex, rRequest.requestId);</span><br><span class="line"></span><br><span class="line">                result = CamxResultSuccess;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CamxResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            for (UINT requestIndex = 0; requestIndex &lt; pSessionRequest-&gt;numRequests; requestIndex++)</span><br><span class="line">            &#123;</span><br><span class="line">                CaptureRequest&amp;            rRequest                   = pSessionRequest-&gt;requests[requestIndex];</span><br><span class="line">                PipelineProcessRequestData pipelineProcessRequestData = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">                result = SetupRequestData(&amp;rRequest, &amp;pipelineProcessRequestData);</span><br><span class="line"></span><br><span class="line">                // Set timestamp for start of request processing</span><br><span class="line">                PopulateSessionRequestTimingBuffer(&amp;rRequest);</span><br><span class="line"></span><br><span class="line">                if (CamxResultSuccess == result)</span><br><span class="line">                &#123;</span><br><span class="line">                    result = m_pipelineData[rRequest.pipelineIndex].pPipeline-&gt;ProcessRequest(&amp;pipelineProcessRequestData);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (CamxResultSuccess != result)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_LOG_ERROR(CamxLogGroupCore, &quot;pipeline[%u] ProcessRequest failed for request %llu - %s&quot;,</span><br><span class="line">                                   rRequest.pipelineIndex,</span><br><span class="line">                                   rRequest.requestId,</span><br><span class="line">                                   Utils::CamxResultToString(result));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (NULL != pipelineProcessRequestData.pPerBatchedFrameInfo)</span><br><span class="line">                &#123;</span><br><span class="line">                    CAMX_FREE(pipelineProcessRequestData.pPerBatchedFrameInfo);</span><br><span class="line">                    pipelineProcessRequestData.pPerBatchedFrameInfo = NULL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        m_pRequestQueue-&gt;Release(pSessionRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>针对每一次的Request的流转，都是以该方法为入口开始的，具体流程见下图：</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/ProcessCaptureRequest.png" alt=""></p>
<p>上述流程可以总结为以下几个步骤：</p>
<ol>
<li>通过调用Session的ProcessCaptureRequest方法进入到Session，然后调用Pipeline中的ProcessRequest方法通知Pipeline开始处理此次Request。</li>
<li>在Pipeline中，会先去调用内部的每一个Node的SetupRequest方法分别设置该Node的Output Port以及Input Port，之后通过调用DRQ(DeferredRequestQueue)的AddDeferredNode方法将所有的Node加入到DRQ中，其中DRQ中有两个队列分别是用于保存没有依赖项的Node的m_readyNodes以及保存处于等待依赖关系满足的Node的m_deferredNodes，当调用DRQ的DispatchReadyNodes方法后，会开始从m_readyNodes队列中取出Node调用其ProcessRequest开始进入Node内部处理本次request，在处理过程中会更新meta data数据，并更新至DRQ中，当该Node处理完成之后，会将处于m_deferredNodes中的已无依赖关系的Node移到m_readyNodes中，并再次调用DispatchReadyNodes方法从m_readyNodes取出Node进行处理。</li>
<li>与此过程中，当Node的数据处理完成之后会通过CSLFenceCallback通知到Pipeline，此时Pipeline会判断当前Node的Output port 是否是Sink Port(输出到CHI)，如果不是，则会更新依赖项到DRQ中，并且将不存在依赖项的Node移到m_readyNodes队列中，然后调用DispatchReadyNdoes继续进入到DRQ中流转，如果是Sink Port，则表示此Node是整个Pipeline的最末端，调用sinkPortFenceSignaled将数据给到Session中，最后通过调用Session中的NotifyResult将结果发送到CHI中。</li>
</ol>
<h5 id="4-4-3-2-DeferredRequestQueue"><a href="#4-4-3-2-DeferredRequestQueue" class="headerlink" title="4.4.3.2 DeferredRequestQueue"></a>4.4.3.2 DeferredRequestQueue</h5><p>上述流程里面中涉及到DeferredRequestQueue这个概念，这里简单介绍下：</p>
<p>DeferredRequestQueue继承于IPropertyPoolObserver，实现了OnPropertyUpdate/OnMetadataUpdate/OnPropertyFailure/OnMetadataFailure接口，这几个接口用于接收Meta Data以及Property的更新，另外，DRQ主要包含了以下几个主要方法:</p>
<ul>
<li><strong>Create()</strong></li>
</ul>
<p>该方法用于创建DRQ，其中创建了用于存储依赖信息的m_pDependencyMap，并将自己注册到MetadataPool中，一旦有meta data或者property更新便会通过类中实现的几个接口通知到DRQ。</p>
<ul>
<li><strong>DispatchReadyNodes()</strong></li>
</ul>
<p>该方法主要用于将处于m_readyNodes队列的Node取出，将其投递到m_hDeferredWorker线程中进行处理。</p>
<ul>
<li><strong>AddDeferredNode()</strong></li>
</ul>
<p>该方法主要用于添加依赖项到m_pDependencyMap中。</p>
<ul>
<li><strong>FenceSignaledCallback()</strong></li>
</ul>
<p>当Node内部针对某次request处理完成之后，会通过一系列回调通知到DRQ，而其调用的方法便是该方法，在该方法中，会首先调用UpdateDependency更新依赖项，然后调用DispatchReadyNodes触发开始对处于ready状态的Node开始进行处理</p>
<ul>
<li><strong>OnPropertyUpdate()</strong></li>
</ul>
<p>该方法是定义于IPropertyPoolObserver接口，DRQ实现了它，主要用于接收Property更新的通知，并在内部调用UpdateDependency更新依赖项。</p>
<ul>
<li>OnMetadataUpdate()</li>
</ul>
<p>该方法是定义于IPropertyPoolObserver接口，DRQ实现了它，主要用于接收Meta data更新的通知，并在内部调用UpdateDependency更新依赖项。</p>
<ul>
<li><strong>UpdateDependency()</strong></li>
</ul>
<p>该方法用于更新Node的依赖项信息，并且将没有依赖的Node从m_deferredNodes队列中移到m_readyNodes，这样该Node就可以在之后的某次DispatchReadyNodes调用之后投入运行。</p>
<ul>
<li><strong>DeferredWorkerWrapper()</strong></li>
</ul>
<p>该方法是m_hDeferredWorker线程的处理函数，主要用于处理需要下发request的Node，同时再次更新依赖项，最后会再次调用DispatchReadyNodes开始处理。</p>
<p>其中需要注意的是，Pipeline首次针对每一个Node通过调用AddDeferredNode方法加入到DRQ中，此时所有的Node都会加入到m_readyNodes中，然后通过调用dispatchReadyNodes方法，触发DRQ开始进行整个内部处理流程，基本流程可以参见下图，接下来就以该图进行深入梳理下：</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/DeferredRequestQueue.png" alt=""></p>
<ol>
<li>当调用了DRQ的dispatchReadyNodes方法后，会从m_readyNodes链表里面依次取出Dependency，将其投递到DeferredWorkerWrapper线程中，在该线程会从Dependency取出Node调用其ProcessRequest方法开始在Node内部处理本次request，处理完成之后如果当前Node依然存在依赖项，则调用AddDeferredNode方法将Node再次加入到m_deferredNodes链表中，并且加入新的依赖项，存入m_pDependencyMap hash表中。</li>
<li>在Node处理request的过程中，会持续更新meta data以及property，此时会通过调用MetadataSlot的PublishMetadata方法更新到MetadataPool中，此时MetadataPool会调用之前在DRQ初始化时候注册的几个回调方法OnPropertyUpdate以及OnMetadataUpdate方法通知DRQ，此时有新的meta data 和property更新，接下来会在这两个方法中调用UpdateDependency方法，去更新meta data 和property到m_pDependencyMap中，并且将没有任何依赖项的Node从m_deferredNodes取出加入到m_readyNodes，等待处理。</li>
<li>与此同时，Node的处理结果也会通过ProcessFenceCallback方法通知pipeline，并且调用pipeline的NonSinkPortFenceSignaled方法，在该方法内部又会去调用DRQ的FenceSignaledCallback方法，而该方法又会调用UpdateDependency更新依赖，并将依赖项都满足的Node从m_deferredNodes取出加入到m_readyNodes，然后调用dispatchReadyNodes继续进行处理。</li>
</ol>
<h3 id="4-5-上传拍照结果"><a href="#4-5-上传拍照结果" class="headerlink" title="4.5 上传拍照结果"></a>4.5 上传拍照结果</h3><p>在用户开启了相机应用，相机框架收到某次Request请求之后会开始对其进行处理，一旦有图像数据产生便会通过层层回调最终返回到应用层进行显示，这里我们针对CamX-CHI部分对于拍照结果的上传流程进行一个简单的梳理：</p>
<p>每一个Request对应了三个Result，分别是partial metadata、metadata以及image data，对于每一个Result，上传过程可以大致分为以下两个阶段：</p>
<ul>
<li>Session内部完成图像数据的处理，将结果发送至Usecase中</li>
<li>Usecase接收到来自Session的数据，并将其上传至Provider</li>
</ul>
<p>首先来看下Session内部完成图像数据的处理后是如何将结果发送至Usecase的：</p>
<p>在整个requets流转的过程中，一旦Node中有Partial Meta Data产生，便会调用Node的ProcessPartialMetadataDone方法去通知从属的Pipeline，其内部又调用了pipeline的NotifyNodePartialMetadataDone方法。每次调用Pipeline的NotifyNodePartialMetadataDone方法都会去将pPerRequestInfo→numNodesPartialMetadataDone加一并且判断当前值是否等于pipeline中的Node数量，一旦相等，便说明当前所有的Node都完成了partial meta data的更新动作，此时，便会调用ProcessPartialMetadataRequestIdDone方法，里面会去取出partial meta data，并且重新封装成ResultsData结构体，将其作为参数通过Session的NotifyResult方法传入Session中，之后在Session中经过层层调用最终会调用到内部成员变量m_chiCallBacks的ChiProcessPartialCaptureResult方法，该方法正是创建Session的时候，传入Session中的Usecase的方法（AdvancedCameraUsecase::ProcessDriverPartialCaptureResultCb），通过该方法就将meta data返回到了CHI中。</p>
<p>同样地，Meta data的逻辑和Partial Meta Data很相似，每个Node在处理request的过程中，会调用ProcessMetadataDone方法将数据发送到Pipeline中，一旦所有的Node的meta data否发送完成了，pipeline会调用NotifyNodeMetadataDone方法，将最终的结果发送至Session中，最后经过层层调用，会调用Session 中成员变量m_chiCallBacks的ChiProcessCaptureResult方法，将结果发送到CHI中Usecase中。</p>
<p>图像数据的流转和前两个meta data的流转有点儿差异，一旦Node内部图像数据处理完成后便会调用其ProcessFenceCallback方法，在该方法中会去检查当前输出是否是SInk Buffer，如果是则会调用Pipeline的SinkPortFenceSignaled方法将数据发送到Pipeline中，在该方法中Pipeline又会将数据发送至Session中，最后经过层层调用，会调用Session 中成员变量m_chiCallBacks的ChiProcessCaptureResult方法，将结果发送到CHI中Usecase中。</p>
<p>接下来我们来看下一旦Usecase接收到Session的数据，是如何发送至Provider的：</p>
<h4 id="4-5-1-ProcessResult"><a href="#4-5-1-ProcessResult" class="headerlink" title="4.5.1 ProcessResult"></a>4.5.1 ProcessResult</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// AdvancedCameraUsecase::ProcessResult</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">VOID AdvancedCameraUsecase::ProcessResult(</span><br><span class="line">    CHICAPTURERESULT*           pResult,</span><br><span class="line">    VOID*                       pPrivateCallbackData)</span><br><span class="line">&#123;</span><br><span class="line">    if (TRUE == AdvancedFeatureEnabled())</span><br><span class="line">    &#123;</span><br><span class="line">        SessionPrivateData* pSessionPrivateData = static_cast&lt;SessionPrivateData*&gt;(pPrivateCallbackData);</span><br><span class="line">        UINT32              sessionId           = pSessionPrivateData-&gt;sessionId;</span><br><span class="line"></span><br><span class="line">        if ((NULL != pResult-&gt;pOutputMetadata) &amp;&amp; (sessionId == m_realtimeSessionId))</span><br><span class="line">        &#123;</span><br><span class="line">            ParseResultMetadata(m_pMetadataManager-&gt;GetMetadataFromHandle(pResult-&gt;pOutputMetadata));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pResultMutex-&gt;Lock();</span><br><span class="line"></span><br><span class="line">        Feature* pFeature = FindFeatureToProcessResult(static_cast&lt;CHIPRIVDATA*&gt;(pResult-&gt;pPrivData),</span><br><span class="line">                                                       pResult-&gt;frameworkFrameNum,</span><br><span class="line">                                                       pPrivateCallbackData);</span><br><span class="line">        if (NULL != pFeature)</span><br><span class="line">        &#123;</span><br><span class="line">            pFeature-&gt;ProcessResult(pResult, pPrivateCallbackData);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;pFeature is NULL.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pResultMutex-&gt;Unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        m_pResultMutex-&gt;Lock();</span><br><span class="line">        CameraUsecaseBase::SessionCbCaptureResult(pResult, pPrivateCallbackData);</span><br><span class="line">        m_pResultMutex-&gt;Unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (2 &lt;= ExtensionModule::GetInstance()-&gt;EnableDumpDebugData())</span><br><span class="line">    &#123;</span><br><span class="line">        // Process debug-data</span><br><span class="line">        ProcessDebugData(pResult, pPrivateCallbackData, pResult-&gt;frameworkFrameNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-2-ProcessDriverPartialCaptureResult"><a href="#4-5-2-ProcessDriverPartialCaptureResult" class="headerlink" title="4.5.2 ProcessDriverPartialCaptureResult"></a>4.5.2 ProcessDriverPartialCaptureResult</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// AdvancedCameraUsecase::ProcessDriverPartialCaptureResult</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">VOID AdvancedCameraUsecase::ProcessDriverPartialCaptureResult(</span><br><span class="line">    CHIPARTIALCAPTURERESULT* pResult,</span><br><span class="line">    VOID*                    pPrivateCallbackData)</span><br><span class="line">&#123;</span><br><span class="line">    if (TRUE == AdvancedFeatureEnabled())</span><br><span class="line">    &#123;</span><br><span class="line">        SessionPrivateData* pSessionPrivateData = static_cast&lt;SessionPrivateData*&gt;(pPrivateCallbackData);</span><br><span class="line">        UINT32              sessionId = pSessionPrivateData-&gt;sessionId;</span><br><span class="line"></span><br><span class="line">        if ((NULL != pResult-&gt;pPartialResultMetadata) &amp;&amp; (sessionId == m_realtimeSessionId))</span><br><span class="line">        &#123;</span><br><span class="line">            ParseResultMetadata(m_pMetadataManager-&gt;GetMetadataFromHandle(pResult-&gt;pPartialResultMetadata));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pResultMutex-&gt;Lock();</span><br><span class="line"></span><br><span class="line">        Feature* pFeature = FindFeatureToProcessResult(static_cast&lt;CHIPRIVDATA*&gt;(pResult-&gt;pPrivData),</span><br><span class="line">                                                       pResult-&gt;frameworkFrameNum,</span><br><span class="line">                                                       pPrivateCallbackData);</span><br><span class="line">        if (NULL != pFeature)</span><br><span class="line">        &#123;</span><br><span class="line">            if (PartialMetaSupport::CombinedPartialMeta ==ExtensionModule::GetInstance()-&gt;EnableCHIPartialData())</span><br><span class="line">            &#123;</span><br><span class="line">                pFeature-&gt;ProcessCHIPartialData(pResult-&gt;frameworkFrameNum, sessionId);</span><br><span class="line">            &#125;</span><br><span class="line">            pFeature-&gt;ProcessDriverPartialCaptureResult(pResult, pPrivateCallbackData);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_ERROR(&quot;pFeature is NULL.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_pResultMutex-&gt;Unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CameraUsecaseBase::SessionCbPartialCaptureResult(pResult, pPrivateCallbackData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-3-SessionCbCaptureResult"><a href="#4-5-3-SessionCbCaptureResult" class="headerlink" title="4.5.3 SessionCbCaptureResult"></a>4.5.3 SessionCbCaptureResult</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// CameraUsecaseBase::SessionCbCaptureResult</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">VOID CameraUsecaseBase::SessionCbCaptureResult(</span><br><span class="line">    ChiCaptureResult* pCaptureResult,</span><br><span class="line">    VOID*             pPrivateCallbackData)</span><br><span class="line">&#123;</span><br><span class="line">    SessionPrivateData* pSessionPrivateData = static_cast&lt;SessionPrivateData*&gt;(pPrivateCallbackData);</span><br><span class="line">    CameraUsecaseBase*  pCameraUsecase      = static_cast&lt;CameraUsecaseBase*&gt;(pSessionPrivateData-&gt;pUsecase);</span><br><span class="line"></span><br><span class="line">    for (UINT stream = 0; stream &lt; pCaptureResult-&gt;numOutputBuffers; stream++)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT index = 0;</span><br><span class="line">        if (TRUE == IsThisClonedStream(pCameraUsecase-&gt;m_pClonedStream, pCaptureResult-&gt;pOutputBuffers[stream].pStream, &amp;index))</span><br><span class="line">        &#123;</span><br><span class="line">            CHISTREAMBUFFER* pTempStreamBuffer  = const_cast&lt;CHISTREAMBUFFER*&gt;(&amp;pCaptureResult-&gt;pOutputBuffers[stream]);</span><br><span class="line">            pTempStreamBuffer-&gt;pStream          = pCameraUsecase-&gt;m_pFrameworkOutStreams[index];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pCameraUsecase-&gt;SessionProcessResult(pCaptureResult, pSessionPrivateData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-4-SessionProcessResult"><a href="#4-5-4-SessionProcessResult" class="headerlink" title="4.5.4 SessionProcessResult"></a>4.5.4 SessionProcessResult</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// CameraUsecaseBase::SessionProcessResult</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">VOID CameraUsecaseBase::SessionProcessResult(</span><br><span class="line">    ChiCaptureResult*         pResult,</span><br><span class="line">    const SessionPrivateData* pSessionPrivateData)</span><br><span class="line">&#123;</span><br><span class="line">    CHX_LOG(&quot;CameraUsecaseBase::SessionProcessResult for frame: %u&quot;, pResult-&gt;frameworkFrameNum);</span><br><span class="line"></span><br><span class="line">    CDKResult           result                  = CDKResultSuccess;</span><br><span class="line">    UINT32              resultFrameNum          = pResult-&gt;frameworkFrameNum;</span><br><span class="line">    UINT32              resultFrameIndex        = resultFrameNum % MaxOutstandingRequests;</span><br><span class="line">    BOOL                isAppResultsAvailable   = FALSE;</span><br><span class="line"></span><br><span class="line">    camera3_capture_result_t* pUsecaseResult     = GetCaptureResult(resultFrameIndex);</span><br><span class="line"></span><br><span class="line">    pUsecaseResult-&gt;frame_number = resultFrameNum;</span><br><span class="line"></span><br><span class="line">    // Fill all the info in m_captureResult and call ProcessAndReturnFinishedResults to send the meta</span><br><span class="line">    // callback in sequence</span><br><span class="line">    m_pAppResultMutex-&gt;Lock();</span><br><span class="line">    for (UINT i = 0; i &lt; pResult-&gt;numOutputBuffers; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        camera3_stream_buffer_t* pResultBuffer =</span><br><span class="line">            const_cast&lt;camera3_stream_buffer_t*&gt;(&amp;pUsecaseResult-&gt;output_buffers[i + pUsecaseResult-&gt;num_output_buffers]);</span><br><span class="line"></span><br><span class="line">        ChxUtils::PopulateChiToHALStreamBuffer(&amp;pResult-&gt;pOutputBuffers[i], pResultBuffer);</span><br><span class="line">        isAppResultsAvailable = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    pUsecaseResult-&gt;num_output_buffers += pResult-&gt;numOutputBuffers;</span><br><span class="line">    m_pAppResultMutex-&gt;Unlock();</span><br><span class="line"></span><br><span class="line">    if (NULL != &amp;pResult-&gt;pInputBuffer[0])</span><br><span class="line">    &#123;</span><br><span class="line">        camera3_stream_buffer_t* pResultInBuffer =</span><br><span class="line">            const_cast&lt;camera3_stream_buffer_t*&gt;(pUsecaseResult-&gt;input_buffer);</span><br><span class="line"></span><br><span class="line">        ChxUtils::PopulateChiToHALStreamBuffer(pResult-&gt;pInputBuffer, pResultInBuffer);</span><br><span class="line">        isAppResultsAvailable = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((NULL != pResult-&gt;pInputMetadata) &amp;&amp; (NULL != pResult-&gt;pOutputMetadata))</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ChiMetadata* pChiInputMetadata  = m_pMetadataManager-&gt;GetMetadataFromHandle(pResult-&gt;pInputMetadata);</span><br><span class="line">        ChiMetadata* pChiOutputMetadata = m_pMetadataManager-&gt;GetMetadataFromHandle(pResult-&gt;pOutputMetadata);</span><br><span class="line"></span><br><span class="line">        if ((pResult-&gt;frameworkFrameNum &gt;= m_batchRequestStartIndex) &amp;&amp;</span><br><span class="line">            (pResult-&gt;frameworkFrameNum &lt;= m_batchRequestEndIndex))</span><br><span class="line">        &#123;</span><br><span class="line">            result = HandleBatchModeResult(pResult,</span><br><span class="line">                                           pChiOutputMetadata,</span><br><span class="line">                                           resultFrameIndex,</span><br><span class="line">                                           GetMetadataClientIdFromPipeline(pSessionPrivateData-&gt;sessionId, 0));</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if ((CDKResultSuccess == result) &amp;&amp; (FALSE == m_isMetadataAvailable[resultFrameIndex]) &amp;&amp;</span><br><span class="line">                (FALSE == m_isMetadataSent[resultFrameIndex]))</span><br><span class="line">            &#123;</span><br><span class="line">                result = Usecase::UpdateAppResultMetadata(pChiOutputMetadata,</span><br><span class="line">                                                          resultFrameIndex,</span><br><span class="line">                                                          GetMetadataClientIdFromPipeline(pSessionPrivateData-&gt;sessionId, 0));</span><br><span class="line">                if (CDKResultSuccess == result)</span><br><span class="line">                &#123;</span><br><span class="line">                    SetMetadataAvailable(resultFrameIndex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (CDKResultSuccess == result)</span><br><span class="line">        &#123;</span><br><span class="line">            // release the buffers</span><br><span class="line">            m_pMetadataManager-&gt;Release(pChiOutputMetadata);</span><br><span class="line"></span><br><span class="line">            m_pMetadataManager-&gt;Release(pChiInputMetadata);</span><br><span class="line"></span><br><span class="line">            CHX_LOG(&quot;Released output metadata buffer for session id: %d: %d&quot;,</span><br><span class="line">                pSessionPrivateData-&gt;sessionId, result);</span><br><span class="line"></span><br><span class="line">            pUsecaseResult-&gt;partial_result = pResult-&gt;numPartialMetadata;</span><br><span class="line">            isAppResultsAvailable = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (TRUE == isAppResultsAvailable)</span><br><span class="line">    &#123;</span><br><span class="line">        ProcessAndReturnFinishedResults();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-5-Usecase-ReturnFrameworkResult"><a href="#4-5-5-Usecase-ReturnFrameworkResult" class="headerlink" title="4.5.5 Usecase::ReturnFrameworkResult"></a>4.5.5 Usecase::ReturnFrameworkResult</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">/// Usecase::ReturnFrameworkResult</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">VOID Usecase::ReturnFrameworkResult(</span><br><span class="line">    const camera3_capture_result_t* pResult,</span><br><span class="line">    UINT32                          cameraID)</span><br><span class="line">&#123;</span><br><span class="line">    camera3_capture_result_t* pOverrideResult               = const_cast&lt;camera3_capture_result_t*&gt;(pResult);</span><br><span class="line">    UINT32                    chiOriginalOverrideFrameNum   = pResult-&gt;frame_number;</span><br><span class="line">    UINT32                    resultFrameIndexChi           = chiOriginalOverrideFrameNum % MaxOutstandingRequests;</span><br><span class="line">    BOOL                      metadataResult                = TRUE;</span><br><span class="line">    BOOL                      resultCanBeSent               = TRUE;</span><br><span class="line">    BOOL                      allBuffersReturned            = FALSE;</span><br><span class="line"></span><br><span class="line">    pOverrideResult-&gt;frame_number = GetAppFrameNum(pResult-&gt;frame_number);</span><br><span class="line"></span><br><span class="line">    m_pMapLock-&gt;Lock();</span><br><span class="line">    CHX_LOG_INFO(&quot;chiOriginalOverrideFrameNum: %d frame_number: %d resultFrameIndexF: %d FW: %d, Buffer Count: %d RESULT: %p&quot;,</span><br><span class="line">                 chiOriginalOverrideFrameNum,</span><br><span class="line">                 pOverrideResult-&gt;frame_number,</span><br><span class="line">                 resultFrameIndexChi,</span><br><span class="line">                 m_captureResult[resultFrameIndexChi].frame_number,</span><br><span class="line">                 m_numberOfPendingOutputBuffers[resultFrameIndexChi],</span><br><span class="line">                 pResult-&gt;result);</span><br><span class="line"></span><br><span class="line">    if ((NULL  != pResult-&gt;result) &amp;&amp;</span><br><span class="line">        (NULL  != m_pLogicalCameraInfo) &amp;&amp;</span><br><span class="line">        (TRUE  == UsecaseSelector::IsQuadCFASensor(m_pLogicalCameraInfo, NULL)) &amp;&amp;</span><br><span class="line">        (FALSE == ExtensionModule::GetInstance()-&gt;ExposeFullsizeForQuadCFA()))</span><br><span class="line">    &#123;</span><br><span class="line">        // map ROIs (aec/af/crop region) from full active array size based to binning active arrsy size based</span><br><span class="line">        OverrideResultMetaForQCFA(const_cast&lt;camera_metadata_t*&gt;(pResult-&gt;result));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (chiOriginalOverrideFrameNum != m_captureResult[resultFrameIndexChi].frame_number)</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_ERROR(&quot;Unexpected Frame Number %u&quot;, chiOriginalOverrideFrameNum);</span><br><span class="line">        resultCanBeSent = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    camera3_capture_request_t* pRequest = &amp;m_pendingPCRs[resultFrameIndexChi];</span><br><span class="line">    if (0 != m_numberOfPendingOutputBuffers[resultFrameIndexChi])</span><br><span class="line">    &#123;</span><br><span class="line">        // Set NULL to returned buffer so that it won&apos;t be returned again in flush call</span><br><span class="line">        CHX_LOG(&quot;pResult-&gt;num_output_buffers %d pending buffers %d&quot;,</span><br><span class="line">            pResult-&gt;num_output_buffers,</span><br><span class="line">            m_numberOfPendingOutputBuffers[resultFrameIndexChi]);</span><br><span class="line">        for (UINT resultIdx = 0; resultIdx &lt; pResult-&gt;num_output_buffers; resultIdx++)</span><br><span class="line">        &#123;</span><br><span class="line">            camera3_stream_buffer_t* pStreamBuffer = NULL;</span><br><span class="line">            for (UINT requestIdx = 0; requestIdx &lt; pRequest-&gt;num_output_buffers; requestIdx++)</span><br><span class="line">            &#123;</span><br><span class="line">                pStreamBuffer = const_cast&lt;camera3_stream_buffer_t*&gt;(&amp;pRequest-&gt;output_buffers[requestIdx]);</span><br><span class="line">                if (pResult-&gt;output_buffers[resultIdx].stream == pRequest-&gt;output_buffers[requestIdx].stream)</span><br><span class="line">                &#123;</span><br><span class="line">                    CHX_LOG(&quot;pStreamBuffer %p, i %d, j %d buffer %p&quot;,</span><br><span class="line">                        pStreamBuffer,</span><br><span class="line">                        resultIdx,</span><br><span class="line">                        requestIdx,</span><br><span class="line">                        pStreamBuffer-&gt;buffer);</span><br><span class="line">                    pStreamBuffer-&gt;buffer = NULL;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        allBuffersReturned = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (NULL != pResult-&gt;input_buffer)</span><br><span class="line">    &#123;</span><br><span class="line">        pRequest-&gt;input_buffer = NULL;</span><br><span class="line">        allBuffersReturned     = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Decrement the number of pending output buffers given the desired result to return</span><br><span class="line">    if (m_numberOfPendingOutputBuffers[resultFrameIndexChi] &gt;= pResult-&gt;num_output_buffers)</span><br><span class="line">    &#123;</span><br><span class="line">        m_numberOfPendingOutputBuffers[resultFrameIndexChi] -= pResult-&gt;num_output_buffers;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        resultCanBeSent = FALSE;</span><br><span class="line"></span><br><span class="line">        CHX_LOG_ERROR(&quot;ChiFrame: %d App Frame: %d - &quot;</span><br><span class="line">                      &quot;pResult contains more buffers (%d) than the expected number of buffers (%d) to return to the framework!&quot;,</span><br><span class="line">                      chiOriginalOverrideFrameNum,</span><br><span class="line">                      pOverrideResult-&gt;frame_number,</span><br><span class="line">                      pResult-&gt;num_output_buffers,</span><br><span class="line">                      m_numberOfPendingOutputBuffers[resultFrameIndexChi]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHX_LOG(&quot;m_numberOfPendingOutputBuffers = %d&quot;, m_numberOfPendingOutputBuffers[resultFrameIndexChi]);</span><br><span class="line"></span><br><span class="line">    BOOL metadataAvailable  = ((NULL != pOverrideResult-&gt;result) &amp;&amp;</span><br><span class="line">        (0 != pOverrideResult-&gt;partial_result) &amp;&amp; (pOverrideResult-&gt;partial_result &lt; ExtensionModule::GetInstance()-&gt;GetNumMetadataResults()) ) ? TRUE : FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // Block AFRegions in CHI level for fixed-focus lens. OEM can customize this based on need.</span><br><span class="line">    // AFRegion is always published in CamX driver</span><br><span class="line">    const LogicalCameraInfo          *pLogicalCameraInfo = NULL;</span><br><span class="line">    pLogicalCameraInfo = ExtensionModule::GetInstance()-&gt;GetPhysicalCameraInfo(cameraID);</span><br><span class="line">    if ((NULL != pLogicalCameraInfo) &amp;&amp; (NULL != pOverrideResult-&gt;result))</span><br><span class="line">    &#123;</span><br><span class="line">        const CHICAMERAINFO* pChiCameraInfo = &amp;(pLogicalCameraInfo-&gt;m_cameraCaps);</span><br><span class="line">        if (TRUE == pChiCameraInfo-&gt;lensCaps.isFixedFocus)</span><br><span class="line">        &#123;</span><br><span class="line">            camera_metadata_entry_t metadata_entry;</span><br><span class="line">            INT findResult = find_camera_metadata_entry(</span><br><span class="line">                const_cast&lt;camera_metadata_t*&gt;(pOverrideResult-&gt;result), ANDROID_CONTROL_AF_REGIONS, &amp;metadata_entry);</span><br><span class="line">            if (0 == findResult) //OK</span><br><span class="line">            &#123;</span><br><span class="line">                delete_camera_metadata_entry(const_cast&lt;camera_metadata_t*&gt;(pOverrideResult-&gt;result), metadata_entry.index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    PartialResultCount partialResultCount =</span><br><span class="line">        static_cast&lt;PartialResultCount&gt;(pOverrideResult-&gt;partial_result);</span><br><span class="line">    MetaDataResultCount totalMetaDataCount =</span><br><span class="line">        static_cast&lt;MetaDataResultCount&gt;(ExtensionModule::GetInstance()-&gt;GetNumMetadataResults());</span><br><span class="line"></span><br><span class="line">    // check if this result is only for partial metadata</span><br><span class="line">    if ((0 &lt; static_cast&lt;UINT8&gt;(partialResultCount)) &amp;&amp;</span><br><span class="line">        (static_cast&lt;UINT8&gt;(partialResultCount) &lt; static_cast&lt;UINT8&gt;(totalMetaDataCount)))</span><br><span class="line">    &#123;</span><br><span class="line">        // Check if final metadata has already been sent</span><br><span class="line">        if (TRUE == m_requestFlags[resultFrameIndexChi].isOutputMetaDataSent)</span><br><span class="line">        &#123;</span><br><span class="line">            resultCanBeSent = FALSE;</span><br><span class="line">            CHX_LOG_WARN(&quot;Attempting to Send Partial Metadata after Final Metadata has been sent for Chi Frame: %u FW Frame: %u&quot;,</span><br><span class="line">                         chiOriginalOverrideFrameNum,</span><br><span class="line">                         pResult-&gt;frame_number);</span><br><span class="line"></span><br><span class="line">            if (pOverrideResult-&gt;num_output_buffers &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                CHX_LOG_ERROR(&quot;Partial Metadata sent with buffers after Metadata is sent for Chi Frame: %u FW Frame: %u&quot;,</span><br><span class="line">                              chiOriginalOverrideFrameNum,</span><br><span class="line">                              pResult-&gt;frame_number);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    BOOL metadataErrorSent   = m_requestFlags[resultFrameIndexChi].isMetadataErrorSent;</span><br><span class="line">    BOOL allMetadataReturned = m_requestFlags[resultFrameIndexChi].isOutputMetaDataSent;</span><br><span class="line"></span><br><span class="line">    if ((TRUE == allBuffersReturned) &amp;&amp;</span><br><span class="line">        ((TRUE == metadataErrorSent) ||</span><br><span class="line">        (TRUE == allMetadataReturned)))</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_WARN(&quot;Result not returned - framework does not need more results for this request: &quot;</span><br><span class="line">                     &quot;allBuffersReturned %d, metadataErrorSent: %d, allMetadataReturned: %d &quot;,</span><br><span class="line">                     allBuffersReturned, metadataErrorSent, allMetadataReturned);</span><br><span class="line">        resultCanBeSent = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((FALSE == m_requestFlags[resultFrameIndexChi].isInErrorState) &amp;&amp; (resultCanBeSent == TRUE))</span><br><span class="line">    &#123;</span><br><span class="line">        metadataResult = HandleMetadataResultReturn(pOverrideResult, pResult-&gt;frame_number, resultFrameIndexChi, cameraID);</span><br><span class="line">        ExtensionModule::GetInstance()-&gt;ReturnFrameworkResult(pResult, cameraID);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        CHX_LOG_WARN(&quot;Cannot return results for Chi Frame: %u FW Frame: %u&quot;,</span><br><span class="line">                     chiOriginalOverrideFrameNum,</span><br><span class="line">                     pResult-&gt;frame_number);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pMapLock-&gt;Unlock();</span><br><span class="line">    pOverrideResult-&gt;frame_number = chiOriginalOverrideFrameNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-6-ExtensionModule-ReturnFrameworkResult"><a href="#4-5-6-ExtensionModule-ReturnFrameworkResult" class="headerlink" title="4.5.6 ExtensionModule::ReturnFrameworkResult"></a>4.5.6 ExtensionModule::ReturnFrameworkResult</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">// ExtensionModule::ReturnFrameworkResult</span><br><span class="line">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">VOID ExtensionModule::ReturnFrameworkResult(</span><br><span class="line">    const camera3_capture_result_t* pResult,</span><br><span class="line">    UINT32 cameraID)</span><br><span class="line">&#123;</span><br><span class="line">    if ((NULL != m_pPerfLockManager[cameraID]) &amp;&amp; (FALSE == m_firstResult))</span><br><span class="line">    &#123;</span><br><span class="line">        m_pPerfLockManager[cameraID]-&gt;AcquirePerfLock(m_CurrentpowerHint);</span><br><span class="line">        m_previousPowerHint = m_CurrentpowerHint;</span><br><span class="line">        m_firstResult = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pResult-&gt;frame_number == m_longExposureFrame[cameraID])</span><br><span class="line">    &#123;</span><br><span class="line">        if (pResult-&gt;num_output_buffers != 0)</span><br><span class="line">        &#123;</span><br><span class="line">            CHX_LOG_INFO(&quot;Returning long exposure snapshot&quot;);</span><br><span class="line">            ChxUtils::AtomicStoreU32(&amp;m_aLongExposureInProgress[cameraID], FALSE);</span><br><span class="line">            m_longExposureFrame[cameraID] = static_cast&lt;UINT32&gt;(InvalidFrameNumber);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_HALOps[cameraID].process_capture_result(m_logicalCameraInfo[cameraID].m_pCamera3Device, pResult);</span><br><span class="line"></span><br><span class="line">    if (pResult-&gt;output_buffers != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        for (UINT i = 0; i &lt; pResult-&gt;num_output_buffers; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            if ((NULL != m_pPerfLockManager[cameraID]) &amp;&amp;</span><br><span class="line">                (pResult-&gt;output_buffers[i].stream-&gt;format == ChiStreamFormatBlob) &amp;&amp;</span><br><span class="line">                ((pResult-&gt;output_buffers[i].stream-&gt;data_space == static_cast&lt;android_dataspace_t&gt;(DataspaceV0JFIF)) ||</span><br><span class="line">                (pResult-&gt;output_buffers[i].stream-&gt;data_space == static_cast&lt;android_dataspace_t&gt;(DataspaceJFIF))))</span><br><span class="line">            &#123;</span><br><span class="line">                 m_pPerfLockManager[cameraID]-&gt;ReleasePerfLock(PERF_LOCK_SNAPSHOT_CAPTURE);</span><br><span class="line">                 break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们以常用的AdvancedCameraUsecase为例进行代码的梳理：</p>
<p><img src="/2024/深入理解Android Camera架构四-高通CamX-CHI/AdvancedCameraUsecase.png" alt=""></p>
<p>如上图所示，整个result的流转逻辑还是比较清晰的，CamX通过回调方法将结果回传给CHI中，而在CHI中，首先判断是否需要发送到具体的Feature的， 如果需要，则调用相应Feature的ProcessDriverPartialCaptureResult或者ProcessResult方法将结果发送到具体的Feature中，一旦处理完成，便会调用调用CameraUsecaseBase的ProcessAndReturnPartialMetadataFinishedResults以及ProcessAndReturnFinishedResults方法将结果发送到Usecase中，如果当前不需要发送到Feature进行处理，就在AdvancedCameraUsecase中调用CameraUsecaseBase的SessionCbPartialCaptureResult以及SessionCbCaptureResult方法，然后通过Usecase::ReturnFrameResult方法将结果发送到ExtensionModule中，之后调用ExtensionModule中存储的CamX中的回调函数process_capture_result将结果发送到CamX中的HALDevice中，之后HALDevice又通过之前存储的上层传入的回调方法，将结果最终发送到CameraDeviceSession中。</p>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>通过以上的梳理，可以发现，整个CamX-CHI框架设计的很不错，目录结构清晰明确，框架简单高效，流程控制逻辑分明，比如针对某一图像请求，整个流程经过Usecase、Feature、Session、Pipeline并且给到具体的Node中进行处理，最终输出结果。另外，相比较之前的QCamera &amp; Mm-Camera框架的针对某个算法的扩展需要在整个流程代码中嵌入自定义的修改做法而言，CamX-CHI通过将自定义实现的放入CHI中，提高了其扩展性，降低了开发门槛，使得平台厂商在并不是很熟悉CamX框架的情况下也可以通过小规模的修改成功添加新功能。但是人无完人，框架也是一样，该框架异步化处理太多，加大了定位问题以及解决问题的难度，给开发者带来了不小的压力。另外，框架对于内存的要求较高，所以在一些低端机型尤其是低内存机型上，整个框架的运行效率可能会受到一定的限制，进而导致相机效率低于预期。</p>

      
    </div>


    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android-Camera/" rel="tag">#Android Camera</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/深入理解Android Camera架构三-硬件抽象层/" rel="next" title="深入理解Android Camera架构三-硬件抽象层">
                <i class="fa fa-chevron-left"></i> 深入理解Android Camera架构三-硬件抽象层
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/深入理解Android Camera架构五-驱动层V4L2/" rel="prev" title="深入理解Android Camera架构五-驱动层V4L2">
                深入理解Android Camera架构五-驱动层V4L2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Skytoby">
          <p class="site-author-name" itemprop="name">Skytoby</p>
          <p class="site-description motion-element" itemprop="description">现居深圳，毕业于电子科技大学 <br>Android、AI<br>座右铭：想法+行动+坚持</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">44</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caoxiaoliang" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/cao861544325" target="_blank" title="CSDN">
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、概述"><span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、基本组件概念"><span class="nav-text">二、基本组件概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Usecase"><span class="nav-text">2.1 Usecase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Feature"><span class="nav-text">2.2 Feature</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Session"><span class="nav-text">2.3 Session</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Pipeline"><span class="nav-text">2.4 Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Node"><span class="nav-text">2.5 Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-Link"><span class="nav-text">2.6 Link</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-Port"><span class="nav-text">2.7 Port</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、组件结构关系"><span class="nav-text">三、组件结构关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、关键流程详解"><span class="nav-text">四、关键流程详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Camera-Provider-启动初始化"><span class="nav-text">4.1 Camera Provider 启动初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-HAL3Module初始化"><span class="nav-text">4.1.1 HAL3Module初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-HwEnvironment初始化"><span class="nav-text">4.1.2 HwEnvironment初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-3-SettingsManager创建"><span class="nav-text">4.1.3 SettingsManager创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-4-CSLModeManager初始化"><span class="nav-text">4.1.4 CSLModeManager初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-5-总结"><span class="nav-text">4.1.5 总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-打开相机设备-初始化相机设备"><span class="nav-text">4.2 打开相机设备/初始化相机设备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-open"><span class="nav-text">4.2.1 open</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-HALDevice初始化"><span class="nav-text">4.2.2 HALDevice初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-3-initialize"><span class="nav-text">4.2.3 initialize</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-4-总结"><span class="nav-text">4.2.4 总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-配置相机设备数据流"><span class="nav-text">4.3 配置相机设备数据流</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-1-configure-streams"><span class="nav-text">4.3.1 configure_streams</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-1-1-camxhal3entry-gt-configure-streams"><span class="nav-text">4.3.1.1 camxhal3entry-&gt;configure_streams</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-1-2-camxhal3-gt-configure-streams"><span class="nav-text">4.3.1.2 camxhal3-&gt;configure_streams</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-1-3-HALDevice-ConfigureStreams"><span class="nav-text">4.3.1.3 HALDevice::ConfigureStreams</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-1-4-HALDevice-CHIModuleInitialize"><span class="nav-text">4.3.1.4 HALDevice::CHIModuleInitialize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-1-5-ExtensionModule-InitializeOverrideSession"><span class="nav-text">4.3.1.5 ExtensionModule::InitializeOverrideSession</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-GetMatchingUsecase"><span class="nav-text">4.3.2 GetMatchingUsecase</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-2-1-CreateUsecaseObject"><span class="nav-text">4.3.2.1 CreateUsecaseObject</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-2-2-AdvancedCameraUsecase-Create"><span class="nav-text">4.3.2.2 AdvancedCameraUsecase::Create</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-2-3-AdvancedCameraUsecase-Initialize"><span class="nav-text">4.3.2.3 AdvancedCameraUsecase::Initialize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-2-4-CameraUsecaseBase-Initialize"><span class="nav-text">4.3.2.4 CameraUsecaseBase::Initialize</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-CreatePipeline"><span class="nav-text">4.3.3 CreatePipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-3-1-Pipeline-Create"><span class="nav-text">4.3.3.1 Pipeline::Create</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-3-2-Pipeline-Initialize"><span class="nav-text">4.3.3.2 Pipeline::Initialize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-3-3-CreateNodes"><span class="nav-text">4.3.3.3 CreateNodes</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-4-CreateSessions"><span class="nav-text">4.3.4 CreateSessions</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-4-1-CreateSessionsWithInputHALStream"><span class="nav-text">4.3.4.1 CreateSessionsWithInputHALStream</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-4-2-CreateSession"><span class="nav-text">4.3.4.2 CreateSession</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-5-小结"><span class="nav-text">4.3.5 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-处理拍照请求"><span class="nav-text">4.4 处理拍照请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-1-process-capture-request"><span class="nav-text">4.4.1 process_capture_request</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-1-camxhal3entry-gt-process-capture-request"><span class="nav-text">4.4.1.1 camxhal3entry-&gt;process_capture_request</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-2-camxhal3-gt-configure-streams"><span class="nav-text">4.4.1.2 camxhal3-&gt;configure_streams</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-3-HALDevice-ProcessCaptureRequest"><span class="nav-text">4.4.1.3 HALDevice::ProcessCaptureRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-4-chi-override-process-request"><span class="nav-text">4.4.1.4 chi_override_process_request</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-5-OverrideProcessRequest"><span class="nav-text">4.4.1.5 OverrideProcessRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-6-Usecase-ProcessCaptureRequest"><span class="nav-text">4.4.1.6 Usecase::ProcessCaptureRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-7-ExecuteCaptureRequest"><span class="nav-text">4.4.1.7 ExecuteCaptureRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-8-CameraUsecaseBase-ExecuteCaptureRequest"><span class="nav-text">4.4.1.8 CameraUsecaseBase::ExecuteCaptureRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-9-ChiContext-ActivatePipeline"><span class="nav-text">4.4.1.9 ChiContext::ActivatePipeline</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-1-10-小结"><span class="nav-text">4.4.1.10 小结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-2-Session-StreamOn"><span class="nav-text">4.4.2 Session::StreamOn</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-3-Session-ProcessCaptureRequest"><span class="nav-text">4.4.3 Session::ProcessCaptureRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-3-1-Session-ProcessRequest"><span class="nav-text">4.4.3.1 Session::ProcessRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-3-2-DeferredRequestQueue"><span class="nav-text">4.4.3.2 DeferredRequestQueue</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-上传拍照结果"><span class="nav-text">4.5 上传拍照结果</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-1-ProcessResult"><span class="nav-text">4.5.1 ProcessResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-2-ProcessDriverPartialCaptureResult"><span class="nav-text">4.5.2 ProcessDriverPartialCaptureResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-3-SessionCbCaptureResult"><span class="nav-text">4.5.3 SessionCbCaptureResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-4-SessionProcessResult"><span class="nav-text">4.5.4 SessionProcessResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-5-Usecase-ReturnFrameworkResult"><span class="nav-text">4.5.5 Usecase::ReturnFrameworkResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-6-ExtensionModule-ReturnFrameworkResult"><span class="nav-text">4.5.6 ExtensionModule::ReturnFrameworkResult</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、总结"><span class="nav-text">五、总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skytoby</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme Next
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'https-zproo-github-io';
      var disqus_identifier = '2024/深入理解Android Camera架构四-高通CamX-CHI/';
      var disqus_title = "深入理解Android Camera架构四-高通CamX-CHI";
      var disqus_url = 'http://zproo.github.io/2024/深入理解Android Camera架构四-高通CamX-CHI/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  









  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
