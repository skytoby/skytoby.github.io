<!doctype html>



  


<html class="theme-next pisces use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Android Camera,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="相机应用处于整个框架的上层，在现实生活中，为了满足各式各样的应用场景，会加入很多业务处理逻辑，但是一旦当我们拨开繁杂的业务逻辑，便会发现其核心部分依然是通过调用谷歌制订的一系列Camera Api接口来完成的，而所有的相机行为都包含在该接口中。 起初，相机系统采用的是Camera Api v1接口，它通过一个Camera 类以及该类中的几个标准方法来实现整个相机系统的预览、拍照以及录像功能，控制逻">
<meta name="keywords" content="Android Camera">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Android Camera架构一-应用层">
<meta property="og:url" content="http://zproo.github.io/2024/深入理解Android Camera架构一-应用层/index.html">
<meta property="og:site_name" content="Skytoby">
<meta property="og:description" content="相机应用处于整个框架的上层，在现实生活中，为了满足各式各样的应用场景，会加入很多业务处理逻辑，但是一旦当我们拨开繁杂的业务逻辑，便会发现其核心部分依然是通过调用谷歌制订的一系列Camera Api接口来完成的，而所有的相机行为都包含在该接口中。 起初，相机系统采用的是Camera Api v1接口，它通过一个Camera 类以及该类中的几个标准方法来实现整个相机系统的预览、拍照以及录像功能，控制逻">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构一-应用层/cameraframework.png">
<meta property="og:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构一-应用层/cameraframework_binder.png">
<meta property="og:updated_time" content="2024-02-08T08:41:46.733Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解Android Camera架构一-应用层">
<meta name="twitter:description" content="相机应用处于整个框架的上层，在现实生活中，为了满足各式各样的应用场景，会加入很多业务处理逻辑，但是一旦当我们拨开繁杂的业务逻辑，便会发现其核心部分依然是通过调用谷歌制订的一系列Camera Api接口来完成的，而所有的相机行为都包含在该接口中。 起初，相机系统采用的是Camera Api v1接口，它通过一个Camera 类以及该类中的几个标准方法来实现整个相机系统的预览、拍照以及录像功能，控制逻">
<meta name="twitter:image" content="http://zproo.github.io/2024/深入理解Android%20Camera架构一-应用层/cameraframework.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://zproo.github.io/2024/深入理解Android Camera架构一-应用层/">

  <title> 深入理解Android Camera架构一-应用层 | Skytoby </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <header id="header_post" class="header" itemscope="" itemtype="http://schema.org/WPHeader" style="background-image: url('http://ortur5wom.bkt.clouddn.com/home_bg.jpg');">
      <div class="header-inner-post"><a class="site-home" href="/">Skytoby</a>

<div class="site-meta ">
  
  
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/logo.png" style="width: 50px" alt="Skytoby">
      </a>
    </div>
  

  
  
  
  
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
           <li class="menu-item menu-item-关于">
             <a href="/about" rel="section">
               
               
               关于
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-目录">
             <a href="/archives" rel="section">
               
               
               目录
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-首页">
             <a href="/" rel="section">
               
               
               首页
             </a>
           </li>
        
      

      
    </ul>
  

  
</nav> </div>
      <div class="header-post"> 
  <div class="post-header">
      <div class="tags">
      
        <a href="/tags/Android-Camera/" rel="tag" title="Android Camera">Android Camera</a>
      
      </div>
      <h1>深入理解Android Camera架构一-应用层</h1>
      <h2 class="subtitle"></h2>
      <div class="post-time">
        <span class="post-meta-item-text">Posted on </span>
        <time itemprop="dateCreated" datetime="2024-01-20T21:18:23+08:00" content="2024-01-20" title="2024-01-20 21:18:23">
          2024-01-20
        </time>
      </div>
  </div>
 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                深入理解Android Camera架构一-应用层
              
            
          </h1>
        

        <div class="post-meta">
		  

          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2024-01-20T21:18:23+08:00" content="2024-01-20">
              2024-01-20
            </time>
          </span>

          

          <!--  -->

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>相机应用处于整个框架的上层，在现实生活中，为了满足各式各样的应用场景，会加入很多业务处理逻辑，但是一旦当我们拨开繁杂的业务逻辑，便会发现其核心部分依然是通过调用谷歌制订的一系列Camera Api接口来完成的，而所有的相机行为都包含在该接口中。</p>
<p>起初，相机系统采用的是Camera Api v1接口，它通过一个Camera 类以及该类中的几个标准方法来实现整个相机系统的预览、拍照以及录像功能，控制逻辑比较简单，同时也比较容易理解，但也正是这种简单，导致了它无法逐帧控制底层硬件，无法通过元数据进行修改进而增强帧的表达能力，再加之应用场景的多样化趋势，该接口在新功能的实现上显得些许力不从心。面对该接口难以进一步扩展相机功能这一局面，谷歌在Andorid 5.0(API Level 21)便重新对Camera进行了设计，摒弃了Camera Api v1的设计逻辑，提出了一个全新的API – camera2，引入了Session以及Request概念，将控制逻辑统一成一个视图，因此在使用上更加复杂，同时也支持了更多特性，比如逐帧控制曝光、感光度以及支持Raw格式的输出等。并且由于对控制逻辑的高度抽象化，使得该接口具有很高的灵活性，可以通过简单的操作实现30fps的全高清连拍的功能，总得来说，该接口极大地提高了对于相机框架的控制能力，同时也进一步大幅度提升了其整体性能。</p>
<p>谷歌提出Camera Api v2接口的同时，将其具体实现放入了Camera Framework中来完成，Framework内部负责解析来自App的请求，并且通过AIDL跨进程接口下发到Camera Service中进行处理，并且等待结果的回传。下面将通过 Camera Api v2打开Camera的流程，来介绍下如何使用该接口来控制整个相机体系。</p>
<h1 id="一、打开Camera主流程"><a href="#一、打开Camera主流程" class="headerlink" title="一、打开Camera主流程"></a>一、打开Camera主流程</h1><h2 id="1-1-初始化TextureView并设置监听"><a href="#1-1-初始化TextureView并设置监听" class="headerlink" title="1.1 初始化TextureView并设置监听"></a>1.1 初始化TextureView并设置监听</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> mTextureView = findViewById(R.id.textview);</span><br><span class="line"> mTextureView.setSurfaceTextureListener(textureListener);</span><br><span class="line"> public TextureView.SurfaceTextureListener textureListener = new TextureView.SurfaceTextureListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onSurfaceTextureAvailable(SurfaceTexture surface, int width, int height) &#123;</span><br><span class="line">            //获取CameraManager服务</span><br><span class="line">            mCamManager = (CameraManager) getSystemService(Context.CAMERA_SERVICE);</span><br><span class="line">            try &#123;</span><br><span class="line">                //打开主摄</span><br><span class="line">                mCamManager.openCamera(&quot;0&quot;, mStateCallback, null);</span><br><span class="line">            &#125; catch (CameraAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onSurfaceTextureSizeChanged(SurfaceTexture surface, int width, int height) &#123;</span><br><span class="line">            log(&quot;onSurfaceTextureSizeChanged Enter&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean onSurfaceTextureDestroyed(SurfaceTexture surface) &#123;</span><br><span class="line">            log(&quot;onSurfaceTextureDestroyed Enter&quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onSurfaceTextureUpdated(SurfaceTexture surface) &#123;</span><br><span class="line">            log(&quot;onSurfaceTextureUpdated Enter&quot;);</span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-SurfaceTexture可用打开Camera"><a href="#1-2-SurfaceTexture可用打开Camera" class="headerlink" title="1.2 SurfaceTexture可用打开Camera"></a>1.2 SurfaceTexture可用打开Camera</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//mStateCallback获取CameraDevice</span><br><span class="line">public CameraDevice.StateCallback mStateCallback = new CameraDevice.StateCallback() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onOpened(CameraDevice camera) &#123;</span><br><span class="line">                if (camera != null) &#123;</span><br><span class="line">                    log(&quot;camera is not null&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                log(&quot;onOpened&quot;);</span><br><span class="line">                //返回CameraDevice,将其存入mCamDevice</span><br><span class="line">                mCamDevice = camera;</span><br><span class="line">                startPreview();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onDisconnected(CameraDevice camera) &#123;</span><br><span class="line">                camera.close();</span><br><span class="line">                mCamDevice = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onError(CameraDevice camera, int error) &#123;</span><br><span class="line">                camera.close();</span><br><span class="line">                mCamDevice = null;</span><br><span class="line">            &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="1-3-创建Camera-Session，请求Camera数据"><a href="#1-3-创建Camera-Session，请求Camera数据" class="headerlink" title="1.3 创建Camera Session，请求Camera数据"></a>1.3 创建Camera Session，请求Camera数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">//CameraDevice创建Session，请求Camera数据</span><br><span class="line">public void startPreview() &#123;</span><br><span class="line">            SurfaceTexture mSurfaceTexture = mTextureView.getSurfaceTexture();</span><br><span class="line">            // 设置TextureView 用于显示的缓冲区大小</span><br><span class="line">            mSurfaceTexture.setDefaultBufferSize(mPreviewSize.getWidth(), mPreviewSize.getHeight());</span><br><span class="line">            //创建Surface，用于显示预览数据</span><br><span class="line">            mPreviewSurface = new Surface(mSurfaceTexture);</span><br><span class="line">            try &#123;</span><br><span class="line">                //创建CameraCaptureSession,App需要实现CameraCaptureSession.StateCallback用于接收CameraCaptureSession实例</span><br><span class="line">                mCamDevice.createCaptureSession(Arrays.asList(mPreviewSurface, mImageReader.getSurface()), new CameraCaptureSession.StateCallback() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onConfigured(CameraCaptureSession session) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            //创建用于预览的CaptureRequest.Builder,进而得到CaptureRequest</span><br><span class="line">                            CaptureRequest.Builder b = mCamDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);</span><br><span class="line">                            b.addTarget(mPreviewSurface);</span><br><span class="line">                            CaptureRequest r = b.build();</span><br><span class="line">                            mCamSession = session;</span><br><span class="line">                            //下发预览需求</span><br><span class="line">                            mCamSession.setRepeatingRequest(r, mPreviewCaptureCallback, null);</span><br><span class="line">                        &#125; catch (CameraAccessException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    CameraCaptureSession.CaptureCallback mPreviewCaptureCallback = new CameraCaptureSession.CaptureCallback() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public void onCaptureCompleted(CameraCaptureSession session, CaptureRequest request, TotalCaptureResult result) &#123;</span><br><span class="line">                            //返回result --&gt; meta data</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public void onReady(CameraCaptureSession session) &#123;</span><br><span class="line">                        super.onReady(session);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public void onConfigureFailed(CameraCaptureSession session) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, null);</span><br><span class="line">            &#125; catch (CameraAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-拍照"><a href="#1-4-拍照" class="headerlink" title="1.4 拍照"></a>1.4 拍照</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">                    //创建CaptureRequest.Builder,TEMPLATE_STILL_CAPTURE代表了此Request是用于拍照</span><br><span class="line">                    CaptureRequest.Builder b = mCamDevice.createCaptureRequest(CameraDevice.TEMPLATE_STILL_CAPTURE);</span><br><span class="line">                    b.addTarget(mImageReader.getSurface());</span><br><span class="line">                    mCamSession.capture(b.build(), new CameraCaptureSession.CaptureCallback() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public void onCaptureCompleted(@NonNull CameraCaptureSession session, @NonNull CaptureRequest request, @NonNull TotalCaptureResult result) &#123;</span><br><span class="line">                            super.onCaptureCompleted(session, request, result);</span><br><span class="line">                            //返回result --&gt; meta data</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, null);</span><br><span class="line">                &#125; catch (CameraAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">    mImageReader = ImageReader.newInstance(mCaptureSize.getWidth(), mCaptureSize.getHeight(), ImageFormat.JPEG, 2);</span><br><span class="line">        mImageReader.setOnImageAvailableListener(new ImageReader.OnImageAvailableListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onImageAvailable(ImageReader reader) &#123;</span><br><span class="line">                Image image = reader.acquireNextImage();</span><br><span class="line">                ByteBuffer buffer = image.getPlanes()[0].getBuffer();</span><br><span class="line">                byte[] bytes = new byte[buffer.remaining()];</span><br><span class="line">                //由缓冲区存入字节数组</span><br><span class="line">                buffer.get(bytes);</span><br><span class="line">                //字节数组转换为jpeg格式图片，并存储在设备中</span><br><span class="line">                doByte2JpegFile(bytes);</span><br><span class="line">                image.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, null /*mCameraHandler*/);</span><br></pre></td></tr></table></figure>
<h1 id="二、mCamManager-openCamera"><a href="#二、mCamManager-openCamera" class="headerlink" title="二、mCamManager.openCamera"></a>二、mCamManager.openCamera</h1><h2 id="2-1-openCamera"><a href="#2-1-openCamera" class="headerlink" title="2.1 openCamera"></a>2.1 openCamera</h2><p>[-&gt;frameworks\base\core\java\android\hardware\camera2\CameraManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RequiresPermission(android.Manifest.permission.CAMERA)</span><br><span class="line">  public void openCamera(@NonNull String cameraId,</span><br><span class="line">          @NonNull final CameraDevice.StateCallback callback, @Nullable Handler handler)</span><br><span class="line">          throws CameraAccessException &#123;</span><br><span class="line"></span><br><span class="line">      openCameraForUid(cameraId, callback, CameraDeviceImpl.checkAndWrapHandler(handler),</span><br><span class="line">              USE_CALLING_UID);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-openCameraForUid"><a href="#2-2-openCameraForUid" class="headerlink" title="2.2 openCameraForUid"></a>2.2 openCameraForUid</h2><p>[-&gt;frameworks\base\core\java\android\hardware\camera2\CameraManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void openCameraForUid(@NonNull String cameraId,</span><br><span class="line">            @NonNull final CameraDevice.StateCallback callback, @NonNull Executor executor,</span><br><span class="line">            int clientUid)</span><br><span class="line">            throws CameraAccessException &#123;</span><br><span class="line"></span><br><span class="line">        if (cameraId == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;cameraId was null&quot;);</span><br><span class="line">        &#125; else if (callback == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;callback was null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (CameraManagerGlobal.sCameraServiceDisabled) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;No cameras available on device&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        openCameraDeviceUserAsync(cameraId, callback, executor, clientUid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-openCameraDeviceUserAsync"><a href="#2-3-openCameraDeviceUserAsync" class="headerlink" title="2.3 openCameraDeviceUserAsync"></a>2.3 openCameraDeviceUserAsync</h2><p>[-&gt;frameworks\base\core\java\android\hardware\camera2\CameraManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">private CameraDevice openCameraDeviceUserAsync(String cameraId,</span><br><span class="line">            CameraDevice.StateCallback callback, Executor executor, final int uid)</span><br><span class="line">            throws CameraAccessException &#123;</span><br><span class="line">        //获取Camera特性</span><br><span class="line">        CameraCharacteristics characteristics = getCameraCharacteristics(cameraId);</span><br><span class="line">        CameraDevice device = null;</span><br><span class="line"></span><br><span class="line">        synchronized (mLock) &#123;</span><br><span class="line"></span><br><span class="line">            ICameraDeviceUser cameraUser = null;</span><br><span class="line">            //实例化CameraDeviceImpl，传入callback</span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl =</span><br><span class="line">                    new android.hardware.camera2.impl.CameraDeviceImpl(</span><br><span class="line">                        cameraId,</span><br><span class="line">                        callback,</span><br><span class="line">                        executor,</span><br><span class="line">                        characteristics,</span><br><span class="line">                        mContext.getApplicationInfo().targetSdkVersion);</span><br><span class="line"></span><br><span class="line">            ICameraDeviceCallbacks callbacks = deviceImpl.getCallbacks();</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                //camera2 api</span><br><span class="line">                if (supportsCamera2ApiLocked(cameraId)) &#123;</span><br><span class="line">                    // Use cameraservice&apos;s cameradeviceclient implementation for HAL3.2+ devices</span><br><span class="line">                    ICameraService cameraService = CameraManagerGlobal.get().getCameraService();</span><br><span class="line">                    if (cameraService == null) &#123;</span><br><span class="line">                        throw new ServiceSpecificException(</span><br><span class="line">                            ICameraService.ERROR_DISCONNECTED,</span><br><span class="line">                            &quot;Camera service is currently unavailable&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //连接设备，并将callbacks传入</span><br><span class="line">                    cameraUser = cameraService.connectDevice(callbacks, cameraId,</span><br><span class="line">                            mContext.getOpPackageName(), uid);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Use legacy camera implementation for HAL1 devices</span><br><span class="line">                    int id;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        id = Integer.parseInt(cameraId);</span><br><span class="line">                    &#125; catch (NumberFormatException e) &#123;</span><br><span class="line">                        throw new IllegalArgumentException(&quot;Expected cameraId to be numeric, but it was: &quot;</span><br><span class="line">                                + cameraId);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Log.i(TAG, &quot;Using legacy camera HAL.&quot;);</span><br><span class="line">                    cameraUser = CameraDeviceUserShim.connectBinderShim(callbacks, id,</span><br><span class="line">                            getDisplaySize());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (ServiceSpecificException e) &#123;</span><br><span class="line">                if (e.errorCode == ICameraService.ERROR_DEPRECATED_HAL) &#123;</span><br><span class="line">                    throw new AssertionError(&quot;Should&apos;ve gone down the shim path&quot;);</span><br><span class="line">                &#125; else if (e.errorCode == ICameraService.ERROR_CAMERA_IN_USE ||</span><br><span class="line">                        e.errorCode == ICameraService.ERROR_MAX_CAMERAS_IN_USE ||</span><br><span class="line">                        e.errorCode == ICameraService.ERROR_DISABLED ||</span><br><span class="line">                        e.errorCode == ICameraService.ERROR_DISCONNECTED ||</span><br><span class="line">                        e.errorCode == ICameraService.ERROR_INVALID_OPERATION) &#123;</span><br><span class="line">                    // Received one of the known connection errors</span><br><span class="line">                    // The remote camera device cannot be connected to, so</span><br><span class="line">                    // set the local camera to the startup error state</span><br><span class="line">                    deviceImpl.setRemoteFailure(e);</span><br><span class="line"></span><br><span class="line">                    if (e.errorCode == ICameraService.ERROR_DISABLED ||</span><br><span class="line">                            e.errorCode == ICameraService.ERROR_DISCONNECTED ||</span><br><span class="line">                            e.errorCode == ICameraService.ERROR_CAMERA_IN_USE) &#123;</span><br><span class="line">                        // Per API docs, these failures call onError and throw</span><br><span class="line">                        throwAsPublicException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Unexpected failure - rethrow</span><br><span class="line">                    throwAsPublicException(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (RemoteException e) &#123;</span><br><span class="line">                // Camera service died - act as if it&apos;s a CAMERA_DISCONNECTED case</span><br><span class="line">                ServiceSpecificException sse = new ServiceSpecificException(</span><br><span class="line">                    ICameraService.ERROR_DISCONNECTED,</span><br><span class="line">                    &quot;Camera service is currently unavailable&quot;);</span><br><span class="line">                deviceImpl.setRemoteFailure(sse);</span><br><span class="line">                throwAsPublicException(sse);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // TODO: factor out callback to be non-nested, then move setter to constructor</span><br><span class="line">            // For now, calling setRemoteDevice will fire initial</span><br><span class="line">            // onOpened/onUnconfigured callbacks.</span><br><span class="line">            // This function call may post onDisconnected and throw CAMERA_DISCONNECTED if</span><br><span class="line">            // cameraUser dies during setup.</span><br><span class="line">            deviceImpl.setRemoteDevice(cameraUser);</span><br><span class="line">            device = deviceImpl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return device;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     public CameraCharacteristics getCameraCharacteristics(@NonNull String cameraId)</span><br><span class="line">            throws CameraAccessException &#123;</span><br><span class="line">        CameraCharacteristics characteristics = null;</span><br><span class="line">        if (CameraManagerGlobal.sCameraServiceDisabled) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;No cameras available on device&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (mLock) &#123;</span><br><span class="line">            /*</span><br><span class="line">             * Get the camera characteristics from the camera service directly if it supports it,</span><br><span class="line">             * otherwise get them from the legacy shim instead.</span><br><span class="line">             */</span><br><span class="line">            ICameraService cameraService = CameraManagerGlobal.get().getCameraService();</span><br><span class="line">            if (cameraService == null) &#123;</span><br><span class="line">                throw new CameraAccessException(CameraAccessException.CAMERA_DISCONNECTED,</span><br><span class="line">                        &quot;Camera service is currently unavailable&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                Size displaySize = getDisplaySize();</span><br><span class="line"></span><br><span class="line">                // First check isHiddenPhysicalCamera to avoid supportsCamera2ApiLocked throwing</span><br><span class="line">                // exception in case cameraId is a hidden physical camera.</span><br><span class="line">                if (!isHiddenPhysicalCamera(cameraId) &amp;&amp; !supportsCamera2ApiLocked(cameraId)) &#123;</span><br><span class="line">                    // Legacy backwards compatibility path; build static info from the camera</span><br><span class="line">                    // parameters</span><br><span class="line">                    int id = Integer.parseInt(cameraId);</span><br><span class="line"></span><br><span class="line">                    String parameters = cameraService.getLegacyParameters(id);</span><br><span class="line"></span><br><span class="line">                    CameraInfo info = cameraService.getCameraInfo(id);</span><br><span class="line"></span><br><span class="line">                    characteristics = LegacyMetadataMapper.createCharacteristics(parameters, info,</span><br><span class="line">                            id, displaySize);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Normal path: Get the camera characteristics directly from the camera service</span><br><span class="line">                    CameraMetadataNative info = cameraService.getCameraCharacteristics(cameraId);</span><br><span class="line">                    try &#123;</span><br><span class="line">                        info.setCameraId(Integer.parseInt(cameraId));</span><br><span class="line">                    &#125; catch (NumberFormatException e) &#123;</span><br><span class="line">                        Log.e(TAG, &quot;Failed to parse camera Id &quot; + cameraId + &quot; to integer&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    info.setDisplaySize(displaySize);</span><br><span class="line"></span><br><span class="line">                    characteristics = new CameraCharacteristics(info);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (ServiceSpecificException e) &#123;</span><br><span class="line">                throwAsPublicException(e);</span><br><span class="line">            &#125; catch (RemoteException e) &#123;</span><br><span class="line">                // Camera service died - act as if the camera was disconnected</span><br><span class="line">                throw new CameraAccessException(CameraAccessException.CAMERA_DISCONNECTED,</span><br><span class="line">                        &quot;Camera service is currently unavailable&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return characteristics;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-1-创建CameraDeviceImpl对象"><a href="#2-3-1-创建CameraDeviceImpl对象" class="headerlink" title="2.3.1 创建CameraDeviceImpl对象"></a>2.3.1 创建CameraDeviceImpl对象</h3><p>[-&gt;frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public CameraDeviceImpl(String cameraId, StateCallback callback, Executor executor,</span><br><span class="line">                    CameraCharacteristics characteristics, int appTargetSdkVersion) &#123;</span><br><span class="line">    if (cameraId == null || callback == null || executor == null || characteristics == null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;Null argument given&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    mCameraId = cameraId;</span><br><span class="line">    mDeviceCallback = callback;</span><br><span class="line">    mDeviceExecutor = executor;</span><br><span class="line">    mCharacteristics = characteristics;</span><br><span class="line">    mAppTargetSdkVersion = appTargetSdkVersion;</span><br><span class="line"></span><br><span class="line">    final int MAX_TAG_LEN = 23;</span><br><span class="line">    String tag = String.format(&quot;CameraDevice-JV-%s&quot;, mCameraId);</span><br><span class="line">    if (tag.length() &gt; MAX_TAG_LEN) &#123;</span><br><span class="line">        tag = tag.substring(0, MAX_TAG_LEN);</span><br><span class="line">    &#125;</span><br><span class="line">    TAG = tag;</span><br><span class="line"></span><br><span class="line">    Integer partialCount =</span><br><span class="line">            mCharacteristics.get(CameraCharacteristics.REQUEST_PARTIAL_RESULT_COUNT);</span><br><span class="line">    if (partialCount == null) &#123;</span><br><span class="line">        // 1 means partial result is not supported.</span><br><span class="line">        mTotalPartialCount = 1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mTotalPartialCount = partialCount;</span><br><span class="line">    &#125;</span><br><span class="line">    mIsPrivilegedApp = checkPrivilegedAppList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-2-deviceImpl-getCallbacks"><a href="#2-3-2-deviceImpl-getCallbacks" class="headerlink" title="2.3.2 deviceImpl.getCallbacks"></a>2.3.2 deviceImpl.getCallbacks</h3><p>获取CameraDeviceCallbacks，用于下面的connectDevice传入，mCallbacks获取设备的状态，并将这些状态转发给StateCallback，从而同步给应用。mCallbacks起到了代理作用，其实现了ICameraDeviceCallbacks.Stub接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">    private final CameraDeviceCallbacks mCallbacks = new CameraDeviceCallbacks();</span><br><span class="line">    </span><br><span class="line">    public CameraDeviceCallbacks getCallbacks() &#123;</span><br><span class="line">        return mCallbacks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public class CameraDeviceCallbacks extends ICameraDeviceCallbacks.Stub &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public IBinder asBinder() &#123;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onDeviceError(final int errorCode, CaptureResultExtras resultExtras) &#123;</span><br><span class="line">            if (DEBUG) &#123;</span><br><span class="line">                Log.d(TAG, String.format(</span><br><span class="line">                        &quot;Device error received, code %d, frame number %d, request ID %d, subseq ID %d&quot;,</span><br><span class="line">                        errorCode, resultExtras.getFrameNumber(), resultExtras.getRequestId(),</span><br><span class="line">                        resultExtras.getSubsequenceId()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            synchronized(mInterfaceLock) &#123;</span><br><span class="line">                if (mRemoteDevice == null) &#123;</span><br><span class="line">                    return; // Camera already closed</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                switch (errorCode) &#123;</span><br><span class="line">                    case ERROR_CAMERA_DISCONNECTED:</span><br><span class="line">                        final long ident = Binder.clearCallingIdentity();</span><br><span class="line">                        try &#123;</span><br><span class="line">                            CameraDeviceImpl.this.mDeviceExecutor.execute(mCallOnDisconnected);</span><br><span class="line">                        &#125; finally &#123;</span><br><span class="line">                            Binder.restoreCallingIdentity(ident);</span><br><span class="line">                        &#125;</span><br><span class="line">                        break;</span><br><span class="line">                    case ERROR_CAMERA_REQUEST:</span><br><span class="line">                    case ERROR_CAMERA_RESULT:</span><br><span class="line">                    case ERROR_CAMERA_BUFFER:</span><br><span class="line">                        onCaptureErrorLocked(errorCode, resultExtras);</span><br><span class="line">                        break;</span><br><span class="line">                    case ERROR_CAMERA_DEVICE:</span><br><span class="line">                        scheduleNotifyError(StateCallback.ERROR_CAMERA_DEVICE);</span><br><span class="line">                        break;</span><br><span class="line">                    case ERROR_CAMERA_DISABLED:</span><br><span class="line">                        scheduleNotifyError(StateCallback.ERROR_CAMERA_DISABLED);</span><br><span class="line">                        break;</span><br><span class="line">                    default:</span><br><span class="line">                        Log.e(TAG, &quot;Unknown error from camera device: &quot; + errorCode);</span><br><span class="line">                        scheduleNotifyError(StateCallback.ERROR_CAMERA_SERVICE);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-3-getCameraService"><a href="#2-3-3-getCameraService" class="headerlink" title="2.3.3 getCameraService"></a>2.3.3 getCameraService</h3><p>获取cameraService，通过CameraManager中的CameraManagerGlobal类，再通过ServiceManager获取ICameraService实例，代理CameraService。如何通过CAMERA_SERVICE_BINDER_NAME获取getCameraService代理，将在后面的章节进行详细说明</p>
<p>[-&gt;frameworks\base\core\java\android\hardware\camera2\CameraManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// Use cameraservice&apos;s cameradeviceclient implementation for HAL3.2+ devices</span><br><span class="line">// frameworks/av/camera/aidl/android/hardware/ICameraService.aidl</span><br><span class="line">ICameraService cameraService = CameraManagerGlobal.get().getCameraService();</span><br><span class="line"></span><br><span class="line">public ICameraService getCameraService() &#123;</span><br><span class="line">         synchronized(mLock) &#123;</span><br><span class="line">             connectCameraServiceLocked();</span><br><span class="line">             if (mCameraService == null &amp;&amp; !sCameraServiceDisabled) &#123;</span><br><span class="line">                 Log.e(TAG, &quot;Camera service is unavailable&quot;);</span><br><span class="line">             &#125;</span><br><span class="line">             return mCameraService;</span><br><span class="line">         &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   private void connectCameraServiceLocked() &#123;</span><br><span class="line">         // Only reconnect if necessary</span><br><span class="line">         if (mCameraService != null || sCameraServiceDisabled) return;</span><br><span class="line"></span><br><span class="line">         Log.i(TAG, &quot;Connecting to camera service&quot;);</span><br><span class="line">         //获取cameraServiceBinder服务</span><br><span class="line">         IBinder cameraServiceBinder = ServiceManager.getService(CAMERA_SERVICE_BINDER_NAME);</span><br><span class="line">         if (cameraServiceBinder == null) &#123;</span><br><span class="line">             // Camera service is now down, leave mCameraService as null</span><br><span class="line">             return;</span><br><span class="line">         &#125;</span><br><span class="line">         try &#123;</span><br><span class="line">             cameraServiceBinder.linkToDeath(this, /*flags*/ 0);</span><br><span class="line">         &#125; catch (RemoteException e) &#123;</span><br><span class="line">             // Camera service is now down, leave mCameraService as null</span><br><span class="line">             return;</span><br><span class="line">         &#125;</span><br><span class="line">         //将binder转化为ICameraService实例</span><br><span class="line">         ICameraService cameraService = ICameraService.Stub.asInterface(cameraServiceBinder);</span><br><span class="line"></span><br><span class="line">         try &#123;</span><br><span class="line">             CameraMetadataNative.setupGlobalVendorTagDescriptor();</span><br><span class="line">         &#125; catch (ServiceSpecificException e) &#123;</span><br><span class="line">             handleRecoverableSetupErrors(e);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         try &#123;</span><br><span class="line">             CameraStatus[] cameraStatuses = cameraService.addListener(this);</span><br><span class="line">             for (CameraStatus c : cameraStatuses) &#123;</span><br><span class="line">                 onStatusChangedLocked(c.status, c.cameraId);</span><br><span class="line">             &#125;</span><br><span class="line">             mCameraService = cameraService;</span><br><span class="line">         &#125; catch(ServiceSpecificException e) &#123;</span><br><span class="line">             // Unexpected failure</span><br><span class="line">             throw new IllegalStateException(&quot;Failed to register a camera service listener&quot;, e);</span><br><span class="line">         &#125; catch (RemoteException e) &#123;</span><br><span class="line">             // Camera service is now down, leave mCameraService as null</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-4-connectDevice"><a href="#2-3-4-connectDevice" class="headerlink" title="2.3.4 connectDevice"></a>2.3.4 connectDevice</h3><p>通过CameraService获取ICameraDeviceUser代理类，上面所有的代理实现aidl在源代码frameworks/av/camera/aidl/android/hardware/camera2中可以找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.aidl</span><br><span class="line">ICameraDeviceUser cameraUser = null;</span><br><span class="line">cameraUser = cameraService.connectDevice(callbacks, cameraId,</span><br><span class="line">                            mContext.getOpPackageName(), uid);</span><br><span class="line"> /**</span><br><span class="line">     * Open a camera device through the new camera API</span><br><span class="line">     * Only supported for device HAL versions &gt;= 3.2</span><br><span class="line">     */</span><br><span class="line">ICameraDeviceUser connectDevice(ICameraDeviceCallbacks callbacks,</span><br><span class="line">            String cameraId,</span><br><span class="line">            String opPackageName,</span><br><span class="line">            int clientUid);</span><br></pre></td></tr></table></figure>
<h3 id="2-3-5-setRemoteDevice"><a href="#2-3-5-setRemoteDevice" class="headerlink" title="2.3.5 setRemoteDevice"></a>2.3.5 setRemoteDevice</h3><p> 将获取到的ICameraDeviceUser保存到CameraDeviceImpl用于管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">deviceImpl.setRemoteDevice(cameraUser);</span><br><span class="line">public void setRemoteDevice(ICameraDeviceUser remoteDevice) throws CameraAccessException &#123;</span><br><span class="line">      synchronized(mInterfaceLock) &#123;</span><br><span class="line">          // TODO: Move from decorator to direct binder-mediated exceptions</span><br><span class="line">          // If setRemoteFailure already called, do nothing</span><br><span class="line">          if (mInError) return;</span><br><span class="line"></span><br><span class="line">          mRemoteDevice = new ICameraDeviceUserWrapper(remoteDevice);</span><br><span class="line"></span><br><span class="line">          IBinder remoteDeviceBinder = remoteDevice.asBinder();</span><br><span class="line">          // For legacy camera device, remoteDevice is in the same process, and</span><br><span class="line">          // asBinder returns NULL.</span><br><span class="line">          if (remoteDeviceBinder != null) &#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                  remoteDeviceBinder.linkToDeath(this, /*flag*/ 0);</span><br><span class="line">              &#125; catch (RemoteException e) &#123;</span><br><span class="line">                  CameraDeviceImpl.this.mDeviceExecutor.execute(mCallOnDisconnected);</span><br><span class="line"></span><br><span class="line">                  throw new CameraAccessException(CameraAccessException.CAMERA_DISCONNECTED,</span><br><span class="line">                          &quot;The camera device has encountered a serious error&quot;);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          mDeviceExecutor.execute(mCallOnOpened);</span><br><span class="line">          mDeviceExecutor.execute(mCallOnUnconfigured);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-6-mDeviceExecutor-execute"><a href="#2-3-6-mDeviceExecutor-execute" class="headerlink" title="2.3.6 mDeviceExecutor.execute"></a>2.3.6 mDeviceExecutor.execute</h3><p>通过StateCallback返回给应用CameraDeviceImpl，用于后续的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private final Runnable mCallOnOpened = new Runnable() &#123;</span><br><span class="line">       @Override</span><br><span class="line">       public void run() &#123;</span><br><span class="line">           StateCallbackKK sessionCallback = null;</span><br><span class="line">           synchronized(mInterfaceLock) &#123;</span><br><span class="line">               if (mRemoteDevice == null) return; // Camera already closed</span><br><span class="line"></span><br><span class="line">               sessionCallback = mSessionStateCallback;</span><br><span class="line">           &#125;</span><br><span class="line">           if (sessionCallback != null) &#123;</span><br><span class="line">               sessionCallback.onOpened(CameraDeviceImpl.this);</span><br><span class="line">           &#125;</span><br><span class="line">           mDeviceCallback.onOpened(CameraDeviceImpl.this);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-小结"><a href="#2-4-小结" class="headerlink" title="2.4 小结"></a>2.4 小结</h2><p>当应用打开相机应用时，会去调用该方法打开一个相机设备，其中该方法最终经过层层调用会调用到Camera Framework中的openCameraDeviceUserAsync方法，在该方法中主要做了三件事：</p>
<ol>
<li>首先是获取ICameraService代理，调用其getCameraInfo方法获取当前设备的属性。</li>
<li>其次是实例化了一个CameraDeviceImpl对象，并将来自App的CameraDevice.StateCallback接口存入该对象中，再将CameraDeviceImpl中的内部类CameraDeviceCallback作为参数通过ICameraService的connectDevice方法传入Camera Service去打开并获取一个ICameraDeviceUser代理，并将该代理存入CameraDeviceImpl中进行管理。</li>
<li>最后通过App传入的回调将CameraDeviceImpl返回给App使用，至此整个流程便完成了。</li>
</ol>
<h1 id="三、mCamDevice-createCaptureSession"><a href="#三、mCamDevice-createCaptureSession" class="headerlink" title="三、mCamDevice.createCaptureSession"></a>三、mCamDevice.createCaptureSession</h1><h2 id="3-1-createCaptureSession"><a href="#3-1-createCaptureSession" class="headerlink" title="3.1 createCaptureSession"></a>3.1 createCaptureSession</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void createCaptureSession(List&lt;Surface&gt; outputs,</span><br><span class="line">            CameraCaptureSession.StateCallback callback, Handler handler)</span><br><span class="line">            throws CameraAccessException &#123;</span><br><span class="line">        List&lt;OutputConfiguration&gt; outConfigurations = new ArrayList&lt;&gt;(outputs.size());</span><br><span class="line">        for (Surface surface : outputs) &#123;</span><br><span class="line">            outConfigurations.add(new OutputConfiguration(surface));</span><br><span class="line">        &#125;</span><br><span class="line">        createCaptureSessionInternal(null, outConfigurations, callback,</span><br><span class="line">                checkAndWrapHandler(handler), /*operatingMode*/ICameraDeviceUser.NORMAL_MODE,</span><br><span class="line">                /*sessionParams*/ null);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-createCaptureSessionInternal"><a href="#3-2-createCaptureSessionInternal" class="headerlink" title="3.2 createCaptureSessionInternal"></a>3.2 createCaptureSessionInternal</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">private void createCaptureSessionInternal(InputConfiguration inputConfig,</span><br><span class="line">            List&lt;OutputConfiguration&gt; outputConfigurations,</span><br><span class="line">            CameraCaptureSession.StateCallback callback, Executor executor,</span><br><span class="line">            int operatingMode, CaptureRequest sessionParams) throws CameraAccessException &#123;</span><br><span class="line">        synchronized(mInterfaceLock) &#123;</span><br><span class="line">            if (DEBUG) &#123;</span><br><span class="line">                Log.d(TAG, &quot;createCaptureSessionInternal&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkIfCameraClosedOrInError();</span><br><span class="line"></span><br><span class="line">            boolean isConstrainedHighSpeed =</span><br><span class="line">                    (operatingMode == ICameraDeviceUser.CONSTRAINED_HIGH_SPEED_MODE);</span><br><span class="line">            if (isConstrainedHighSpeed &amp;&amp; inputConfig != null) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;Constrained high speed session doesn&apos;t support&quot;</span><br><span class="line">                        + &quot; input configuration yet.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Notify current session that it&apos;s going away, before starting camera operations</span><br><span class="line">            // After this call completes, the session is not allowed to call into CameraDeviceImpl</span><br><span class="line">            if (mCurrentSession != null) &#123;</span><br><span class="line">                mCurrentSession.replaceSessionClose();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // TODO: dont block for this</span><br><span class="line">            boolean configureSuccess = true;</span><br><span class="line">            CameraAccessException pendingException = null;</span><br><span class="line">            Surface input = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                // configure streams and then block until IDLE</span><br><span class="line">                configureSuccess = configureStreamsChecked(inputConfig, outputConfigurations,</span><br><span class="line">                        operatingMode, sessionParams);</span><br><span class="line">                if (configureSuccess == true &amp;&amp; inputConfig != null) &#123;</span><br><span class="line">                    input = mRemoteDevice.getInputSurface();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (CameraAccessException e) &#123;</span><br><span class="line">                configureSuccess = false;</span><br><span class="line">                pendingException = e;</span><br><span class="line">                input = null;</span><br><span class="line">                if (DEBUG) &#123;</span><br><span class="line">                    Log.v(TAG, &quot;createCaptureSession - failed with exception &quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Fire onConfigured if configureOutputs succeeded, fire onConfigureFailed otherwise.</span><br><span class="line">            CameraCaptureSessionCore newSession = null;</span><br><span class="line">            if (isConstrainedHighSpeed) &#123;</span><br><span class="line">                ArrayList&lt;Surface&gt; surfaces = new ArrayList&lt;&gt;(outputConfigurations.size());</span><br><span class="line">                for (OutputConfiguration outConfig : outputConfigurations) &#123;</span><br><span class="line">                    surfaces.add(outConfig.getSurface());</span><br><span class="line">                &#125;</span><br><span class="line">                StreamConfigurationMap config =</span><br><span class="line">                    getCharacteristics().get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP);</span><br><span class="line">                SurfaceUtils.checkConstrainedHighSpeedSurfaces(surfaces, /*fpsRange*/null, config);</span><br><span class="line"></span><br><span class="line">                newSession = new CameraConstrainedHighSpeedCaptureSessionImpl(mNextSessionId++,</span><br><span class="line">                        callback, executor, this, mDeviceExecutor, configureSuccess,</span><br><span class="line">                        mCharacteristics);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                newSession = new CameraCaptureSessionImpl(mNextSessionId++, input,</span><br><span class="line">                        callback, executor, this, mDeviceExecutor, configureSuccess);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // TODO: wait until current session closes, then create the new session</span><br><span class="line">            mCurrentSession = newSession;</span><br><span class="line"></span><br><span class="line">            if (pendingException != null) &#123;</span><br><span class="line">                throw pendingException;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mSessionStateCallback = mCurrentSession.getDeviceStateCallback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-1-configureStreamsChecked"><a href="#3-2-1-configureStreamsChecked" class="headerlink" title="3.2.1 configureStreamsChecked"></a>3.2.1 configureStreamsChecked</h3><p>通过mRemoteDevice配置数据流，mRemoteDevice是在2.3.5中setRemoteDevice初始化，最终调用的是ICameraDeviceUser接口进行deleteStream、createStream等操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">public boolean configureStreamsChecked(InputConfiguration inputConfig,</span><br><span class="line">            List&lt;OutputConfiguration&gt; outputs, int operatingMode, CaptureRequest sessionParams)</span><br><span class="line">                    throws CameraAccessException &#123;</span><br><span class="line">        // Treat a null input the same an empty list</span><br><span class="line">        if (outputs == null) &#123;</span><br><span class="line">            outputs = new ArrayList&lt;OutputConfiguration&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        if (outputs.size() == 0 &amp;&amp; inputConfig != null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;cannot configure an input stream without &quot; +</span><br><span class="line">                    &quot;any output streams&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        checkInputConfiguration(inputConfig);</span><br><span class="line"></span><br><span class="line">        boolean success = false;</span><br><span class="line"></span><br><span class="line">        synchronized(mInterfaceLock) &#123;</span><br><span class="line">            checkIfCameraClosedOrInError();</span><br><span class="line">            // Streams to create</span><br><span class="line">            HashSet&lt;OutputConfiguration&gt; addSet = new HashSet&lt;OutputConfiguration&gt;(outputs);</span><br><span class="line">            // Streams to delete</span><br><span class="line">            List&lt;Integer&gt; deleteList = new ArrayList&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line">            // Determine which streams need to be created, which to be deleted</span><br><span class="line">            for (int i = 0; i &lt; mConfiguredOutputs.size(); ++i) &#123;</span><br><span class="line">                int streamId = mConfiguredOutputs.keyAt(i);</span><br><span class="line">                OutputConfiguration outConfig = mConfiguredOutputs.valueAt(i);</span><br><span class="line"></span><br><span class="line">                if (!outputs.contains(outConfig) || outConfig.isDeferredConfiguration()) &#123;</span><br><span class="line">                    // Always delete the deferred output configuration when the session</span><br><span class="line">                    // is created, as the deferred output configuration doesn&apos;t have unique surface</span><br><span class="line">                    // related identifies.</span><br><span class="line">                    deleteList.add(streamId);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    addSet.remove(outConfig);  // Don&apos;t create a stream previously created</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDeviceExecutor.execute(mCallOnBusy);</span><br><span class="line">            stopRepeating();</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                waitUntilIdle();</span><br><span class="line"></span><br><span class="line">                mRemoteDevice.beginConfigure();</span><br><span class="line"></span><br><span class="line">                // reconfigure the input stream if the input configuration is different.</span><br><span class="line">                InputConfiguration currentInputConfig = mConfiguredInput.getValue();</span><br><span class="line">                if (inputConfig != currentInputConfig &amp;&amp;</span><br><span class="line">                        (inputConfig == null || !inputConfig.equals(currentInputConfig))) &#123;</span><br><span class="line">                    if (currentInputConfig != null) &#123;</span><br><span class="line">                        mRemoteDevice.deleteStream(mConfiguredInput.getKey());</span><br><span class="line">                        mConfiguredInput = new SimpleEntry&lt;Integer, InputConfiguration&gt;(</span><br><span class="line">                                REQUEST_ID_NONE, null);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (inputConfig != null) &#123;</span><br><span class="line">                        int streamId = mRemoteDevice.createInputStream(inputConfig.getWidth(),</span><br><span class="line">                                inputConfig.getHeight(), inputConfig.getFormat());</span><br><span class="line">                        mConfiguredInput = new SimpleEntry&lt;Integer, InputConfiguration&gt;(</span><br><span class="line">                                streamId, inputConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Delete all streams first (to free up HW resources)</span><br><span class="line">                for (Integer streamId : deleteList) &#123;</span><br><span class="line">                    mRemoteDevice.deleteStream(streamId);</span><br><span class="line">                    mConfiguredOutputs.delete(streamId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Add all new streams</span><br><span class="line">                for (OutputConfiguration outConfig : outputs) &#123;</span><br><span class="line">                    if (addSet.contains(outConfig)) &#123;</span><br><span class="line">                        int streamId = mRemoteDevice.createStream(outConfig);</span><br><span class="line">                        mConfiguredOutputs.put(streamId, outConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                operatingMode = (operatingMode | (customOpMode &lt;&lt; 16));</span><br><span class="line"></span><br><span class="line">                if (sessionParams != null) &#123;</span><br><span class="line">                    mRemoteDevice.endConfigure(operatingMode, sessionParams.getNativeCopy());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    mRemoteDevice.endConfigure(operatingMode, null);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                success = true;</span><br><span class="line">            &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">                // OK. camera service can reject stream config if it&apos;s not supported by HAL</span><br><span class="line">                // This is only the result of a programmer misusing the camera2 api.</span><br><span class="line">                Log.w(TAG, &quot;Stream configuration failed due to: &quot; + e.getMessage());</span><br><span class="line">                return false;</span><br><span class="line">            &#125; catch (CameraAccessException e) &#123;</span><br><span class="line">                if (e.getReason() == CameraAccessException.CAMERA_IN_USE) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;The camera is currently busy.&quot; +</span><br><span class="line">                            &quot; You must wait until the previous operation completes.&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                throw e;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                if (success &amp;&amp; outputs.size() &gt; 0) &#123;</span><br><span class="line">                    mDeviceExecutor.execute(mCallOnIdle);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Always return to the &apos;unconfigured&apos; state if we didn&apos;t hit a fatal error</span><br><span class="line">                    mDeviceExecutor.execute(mCallOnUnconfigured);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-创建CameraCaptureSessionImpl"><a href="#3-2-2-创建CameraCaptureSessionImpl" class="headerlink" title="3.2.2 创建CameraCaptureSessionImpl"></a>3.2.2 创建CameraCaptureSessionImpl</h3><p>创建CameraCaptureSessionImpl，并传入CameraCaptureSession.StateCallback用于返回给应用侧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">newSession = new CameraCaptureSessionImpl(mNextSessionId++, input,</span><br><span class="line">                       callback, executor, this, mDeviceExecutor, configureSuccess);</span><br></pre></td></tr></table></figure>
<p>将应用侧mStateCallback保存在CameraCaptureSessionImpl，用于结果的回调。配置流成功，返回给应用侧状态mStateCallback.onConfigured</p>
<p>[-&gt;frameworks\base\core\java\android\hardware\camera2\impl\CameraCaptureSessionImpl.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">CameraCaptureSessionImpl(int id, Surface input,</span><br><span class="line">            CameraCaptureSession.StateCallback callback, Executor stateExecutor,</span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl,</span><br><span class="line">            Executor deviceStateExecutor, boolean configureSuccess) &#123;</span><br><span class="line">        if (callback == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;callback must not be null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mId = id;</span><br><span class="line">        mIdString = String.format(&quot;Session %d: &quot;, mId);</span><br><span class="line"></span><br><span class="line">        mInput = input;</span><br><span class="line">        mStateExecutor = checkNotNull(stateExecutor, &quot;stateExecutor must not be null&quot;);</span><br><span class="line">        mStateCallback = createUserStateCallbackProxy(mStateExecutor, callback);</span><br><span class="line"></span><br><span class="line">        mDeviceExecutor = checkNotNull(deviceStateExecutor,</span><br><span class="line">                &quot;deviceStateExecutor must not be null&quot;);</span><br><span class="line">        mDeviceImpl = checkNotNull(deviceImpl, &quot;deviceImpl must not be null&quot;);</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * Use the same handler as the device&apos;s StateCallback for all the internal coming events</span><br><span class="line">         *</span><br><span class="line">         * This ensures total ordering between CameraDevice.StateCallback and</span><br><span class="line">         * CameraDeviceImpl.CaptureCallback events.</span><br><span class="line">         */</span><br><span class="line">        mSequenceDrainer = new TaskDrainer&lt;&gt;(mDeviceExecutor, new SequenceDrainListener(),</span><br><span class="line">                /*name*/&quot;seq&quot;);</span><br><span class="line">        mIdleDrainer = new TaskSingleDrainer(mDeviceExecutor, new IdleDrainListener(),</span><br><span class="line">                /*name*/&quot;idle&quot;);</span><br><span class="line">        mAbortDrainer = new TaskSingleDrainer(mDeviceExecutor, new AbortDrainListener(),</span><br><span class="line">                /*name*/&quot;abort&quot;);</span><br><span class="line"></span><br><span class="line">        // CameraDevice should call configureOutputs and have it finish before constructing us</span><br><span class="line"></span><br><span class="line">        if (configureSuccess) &#123;</span><br><span class="line">            mStateCallback.onConfigured(this);</span><br><span class="line">            if (DEBUG) Log.v(TAG, mIdString + &quot;Created session successfully&quot;);</span><br><span class="line">            mConfigureSuccess = true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mStateCallback.onConfigureFailed(this);</span><br><span class="line">            mClosed = true; // do not fire any other callbacks, do not allow any other work</span><br><span class="line">            Log.e(TAG, mIdString + &quot;Failed to create capture session; configuration failed&quot;);</span><br><span class="line">            mConfigureSuccess = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-小结"><a href="#3-3-小结" class="headerlink" title="3.3 小结"></a>3.3 小结</h2><p>在打开相机设备之后便需要去创建一个相机会话，用于传输图像请求，其最终实现是调用该方法来进行实现的，而该方法会去调用到Camera Framework中的createCaptureSessionInternal方法，该方法主要做了两件事：</p>
<ol>
<li>首先调用configureStreamsChecked方法来配置数据流。</li>
<li>其次实例化了一个CameraCaptureImpl对象，并通过传入CameraCaptureSession.StateCallback回调类将该对象发送至至App中。</li>
</ol>
<p>而在configureStreamsChecked方法中会去调用ICameraDeviceUser代理的一系列方法进行数据流配置，其中调用cancelRequest方法停掉当前的预览流程，调用deleteStream方法删除之前的数据流，调用createStream创建新的数据流，最后调用endConfigure来进行数据流的配置工作，针对性的配置便在最后这个endConfigure方法中。</p>
<h1 id="四、mCamDevice-createCaptureRequest"><a href="#四、mCamDevice-createCaptureRequest" class="headerlink" title="四、mCamDevice.createCaptureRequest"></a>四、mCamDevice.createCaptureRequest</h1><p>[-&gt;frameworks/base/core/java/android/hardware/camera2/CaptureRequest.java ]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CaptureRequest.Builder b = mCamDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);</span><br><span class="line">b.addTarget(mPreviewSurface);</span><br><span class="line">CaptureRequest r = b.build();</span><br></pre></td></tr></table></figure>
<p>请求类型有6种</p>
<p>TEMPLATE_PREVIEW : 创建预览的请求<br>TEMPLATE_STILL_CAPTURE: 创建一个适合于静态图像捕获的请求，图像质量优先于帧速率<br>TEMPLATE_RECORD : 创建视频录制的请求<br>TEMPLATE_VIDEO_SNAPSHOT : 创建视视频录制时截屏的请求<br>TEMPLATE_ZERO_SHUTTER_LAG : 创建一个适用于零快门延迟的请求。在不影响预览帧率的情况下最大化图像质量<br>TEMPLATE_MANUAL : 创建一个基本捕获请求，这种请求中所有的自动控制都是禁用的(自动曝光，自动白平衡、自动焦点)</p>
<h2 id="4-1-createCaptureRequest"><a href="#4-1-createCaptureRequest" class="headerlink" title="4.1 createCaptureRequest"></a>4.1 createCaptureRequest</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public CaptureRequest.Builder createCaptureRequest(int templateType,</span><br><span class="line">           Set&lt;String&gt; physicalCameraIdSet)</span><br><span class="line">           throws CameraAccessException &#123;</span><br><span class="line">       synchronized(mInterfaceLock) &#123;</span><br><span class="line">           checkIfCameraClosedOrInError();</span><br><span class="line"></span><br><span class="line">           for (String physicalId : physicalCameraIdSet) &#123;</span><br><span class="line">               if (physicalId == getId()) &#123;</span><br><span class="line">                   throw new IllegalStateException(&quot;Physical id matches the logical id!&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           CameraMetadataNative templatedRequest = null;</span><br><span class="line"></span><br><span class="line">           templatedRequest = mRemoteDevice.createDefaultRequest(templateType);</span><br><span class="line"></span><br><span class="line">           // If app target SDK is older than O, or it&apos;s not a still capture template, enableZsl</span><br><span class="line">           // must be false in the default request.</span><br><span class="line">           if (mAppTargetSdkVersion &lt; Build.VERSION_CODES.O ||</span><br><span class="line">                   templateType != TEMPLATE_STILL_CAPTURE) &#123;</span><br><span class="line">               overrideEnableZsl(templatedRequest, false);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           CaptureRequest.Builder builder = new CaptureRequest.Builder(</span><br><span class="line">                   templatedRequest, /*reprocess*/false, CameraCaptureSession.SESSION_ID_NONE,</span><br><span class="line">                   getId(), physicalCameraIdSet);</span><br><span class="line"></span><br><span class="line">           return builder;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   public CameraMetadataNative createDefaultRequest(int templateId) throws CameraAccessException &#123;</span><br><span class="line">       try &#123;</span><br><span class="line">           return mRemoteDevice.createDefaultRequest(templateId);</span><br><span class="line">       &#125; catch (Throwable t) &#123;</span><br><span class="line">           CameraManager.throwAsPublicException(t);</span><br><span class="line">           throw new UnsupportedOperationException(&quot;Unexpected exception&quot;, t);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">  public Builder(CameraMetadataNative template, boolean reprocess,</span><br><span class="line">               int reprocessableSessionId, String logicalCameraId,</span><br><span class="line">               Set&lt;String&gt; physicalCameraIdSet) &#123;</span><br><span class="line">           mRequest = new CaptureRequest(template, reprocess, reprocessableSessionId,</span><br><span class="line">                   logicalCameraId, physicalCameraIdSet);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-小结"><a href="#4-2-小结" class="headerlink" title="4.2 小结"></a>4.2 小结</h2><p>在创建并获取相机会话之后，便可以开始下发图像请求了，而在此之前，需要通过该方法来创建一个CaptureRequest，一旦调用该方法，最终会调用到Camera Service中ICameraDeviceUser的createDefaultRequest方法来创建一个默认配置的CameraMetadataNative，其次实例化一个CaptureRequest.Builder对象，并将刚才获取的CameraMetadataNative传入其中，之后返回该CaptureRequest.Builder对象，在App中，直接通过调用该Buidler对象的build方法，获取一个CaptureRequest对象。</p>
<p>CaptureRequest对象也创建成功了，接下来需要下发图像请求了，一般常用请求分为两种,一个是预览一个是拍照。</p>
<h1 id="五、mCamSession-setRepeatingRequest"><a href="#五、mCamSession-setRepeatingRequest" class="headerlink" title="五、mCamSession.setRepeatingRequest"></a>五、mCamSession.setRepeatingRequest</h1><h2 id="5-1-setRepeatingRequest"><a href="#5-1-setRepeatingRequest" class="headerlink" title="5.1 setRepeatingRequest"></a>5.1 setRepeatingRequest</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public int setRepeatingRequest(CaptureRequest request, CaptureCallback callback,</span><br><span class="line">         Handler handler) throws CameraAccessException &#123;</span><br><span class="line">     checkRepeatingRequest(request);</span><br><span class="line"></span><br><span class="line">     synchronized (mDeviceImpl.mInterfaceLock) &#123;</span><br><span class="line">         checkNotClosed();</span><br><span class="line"></span><br><span class="line">         handler = checkHandler(handler, callback);</span><br><span class="line"></span><br><span class="line">         if (DEBUG) &#123;</span><br><span class="line">             Log.v(TAG, mIdString + &quot;setRepeatingRequest - request &quot; + request + &quot;, callback &quot; +</span><br><span class="line">                     callback + &quot; handler&quot; + &quot; &quot; + handler);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         return addPendingSequence(mDeviceImpl.setRepeatingRequest(request,</span><br><span class="line">                 createCaptureCallbackProxy(handler, callback), mDeviceExecutor));</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-addPendingSequence"><a href="#5-2-addPendingSequence" class="headerlink" title="5.2 addPendingSequence"></a>5.2 addPendingSequence</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private int addPendingSequence(int sequenceId) &#123;</span><br><span class="line">      mSequenceDrainer.taskStarted(sequenceId);</span><br><span class="line">      return sequenceId;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-1-setRepeatingRequest"><a href="#5-2-1-setRepeatingRequest" class="headerlink" title="5.2.1 setRepeatingRequest"></a>5.2.1 setRepeatingRequest</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public int setRepeatingRequest(CaptureRequest request, CaptureCallback callback,</span><br><span class="line">         Executor executor) throws CameraAccessException &#123;</span><br><span class="line">     List&lt;CaptureRequest&gt; requestList = new ArrayList&lt;CaptureRequest&gt;();</span><br><span class="line">     requestList.add(request);</span><br><span class="line">     return submitCaptureRequest(requestList, callback, executor, /*streaming*/true);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-submitRequestList"><a href="#5-2-2-submitRequestList" class="headerlink" title="5.2.2 submitRequestList"></a>5.2.2 submitRequestList</h3><p>最后调用的是ICameraDeviceUser的submitRequestList方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">private int submitCaptureRequest(List&lt;CaptureRequest&gt; requestList, CaptureCallback callback,</span><br><span class="line">            Executor executor, boolean repeating) throws CameraAccessException &#123;</span><br><span class="line"></span><br><span class="line">        // Need a valid executor, or current thread needs to have a looper, if</span><br><span class="line">        // callback is valid</span><br><span class="line">        executor = checkExecutor(executor, callback);</span><br><span class="line"></span><br><span class="line">        synchronized(mInterfaceLock) &#123;</span><br><span class="line">            checkIfCameraClosedOrInError();</span><br><span class="line"></span><br><span class="line">            // Make sure that there all requests have at least 1 surface; all surfaces are non-null;</span><br><span class="line">            // the surface isn&apos;t a physical stream surface for reprocessing request</span><br><span class="line">            for (CaptureRequest request : requestList) &#123;</span><br><span class="line">                if (request.getTargets().isEmpty()) &#123;</span><br><span class="line">                    throw new IllegalArgumentException(</span><br><span class="line">                            &quot;Each request must have at least one Surface target&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                for (Surface surface : request.getTargets()) &#123;</span><br><span class="line">                    if (surface == null) &#123;</span><br><span class="line">                        throw new IllegalArgumentException(&quot;Null Surface targets are not allowed&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    for (int i = 0; i &lt; mConfiguredOutputs.size(); i++) &#123;</span><br><span class="line">                        OutputConfiguration configuration = mConfiguredOutputs.valueAt(i);</span><br><span class="line">                        if (configuration.isForPhysicalCamera()</span><br><span class="line">                                &amp;&amp; configuration.getSurfaces().contains(surface)) &#123;</span><br><span class="line">                            if (request.isReprocess()) &#123;</span><br><span class="line">                                throw new IllegalArgumentException(</span><br><span class="line">                                        &quot;Reprocess request on physical stream is not allowed&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (repeating) &#123;</span><br><span class="line">                stopRepeating();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SubmitInfo requestInfo;</span><br><span class="line"></span><br><span class="line">            CaptureRequest[] requestArray = requestList.toArray(new CaptureRequest[requestList.size()]);</span><br><span class="line">            // Convert Surface to streamIdx and surfaceIdx</span><br><span class="line">            for (CaptureRequest request : requestArray) &#123;</span><br><span class="line">                request.convertSurfaceToStreamId(mConfiguredOutputs);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            requestInfo = mRemoteDevice.submitRequestList(requestArray, repeating);</span><br><span class="line">            if (DEBUG) &#123;</span><br><span class="line">                Log.v(TAG, &quot;last frame number &quot; + requestInfo.getLastFrameNumber());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (CaptureRequest request : requestArray) &#123;</span><br><span class="line">                request.recoverStreamIdToSurface();</span><br><span class="line">            &#125;</span><br><span class="line">            //保存callback到CameraDeviceImpl中</span><br><span class="line">            if (callback != null) &#123;</span><br><span class="line">                mCaptureCallbackMap.put(requestInfo.getRequestId(),</span><br><span class="line">                        new CaptureCallbackHolder(</span><br><span class="line">                            callback, requestList, executor, repeating, mNextSessionId - 1));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (DEBUG) &#123;</span><br><span class="line">                    Log.d(TAG, &quot;Listen for request &quot; + requestInfo.getRequestId() + &quot; is null&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (repeating) &#123;</span><br><span class="line">                if (mRepeatingRequestId != REQUEST_ID_NONE) &#123;</span><br><span class="line">                    checkEarlyTriggerSequenceComplete(mRepeatingRequestId,</span><br><span class="line">                            requestInfo.getLastFrameNumber(),</span><br><span class="line">                            mRepeatingRequestTypes);</span><br><span class="line">                &#125;</span><br><span class="line">                mRepeatingRequestId = requestInfo.getRequestId();</span><br><span class="line">                mRepeatingRequestTypes = getRequestTypes(requestArray);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mRequestLastFrameNumbersList.add(</span><br><span class="line">                    new RequestLastFrameNumbersHolder(requestList, requestInfo));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (mIdle) &#123;</span><br><span class="line">                mDeviceExecutor.execute(mCallOnActive);</span><br><span class="line">            &#125;</span><br><span class="line">            mIdle = false;</span><br><span class="line"></span><br><span class="line">            return requestInfo.getRequestId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-小结"><a href="#5-3-小结" class="headerlink" title="5.3 小结"></a>5.3 小结</h2><p>应用调用该方法开始预览流程，通过层层调用最终会调用到Framework中的submitCaptureRequest方法，该方法主要做了两件事：</p>
<ol>
<li>首先调用CameraService层CameraDeviceUser的submitRequestList方法，将此次Request下发到CameraService中。</li>
<li>其次将App通过参数传入的CameraCaptureSession.CaptureCallback对象存到CameraDeviceImpI对象中。</li>
</ol>
<h1 id="六、mCamSession-capture"><a href="#六、mCamSession-capture" class="headerlink" title="六、mCamSession.capture"></a>六、mCamSession.capture</h1><h2 id="6-1-capture"><a href="#6-1-capture" class="headerlink" title="6.1  capture"></a>6.1  capture</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public int capture(CaptureRequest request, CaptureCallback callback,</span><br><span class="line">            Handler handler) throws CameraAccessException &#123;</span><br><span class="line">        checkCaptureRequest(request);</span><br><span class="line"></span><br><span class="line">        synchronized (mDeviceImpl.mInterfaceLock) &#123;</span><br><span class="line">            checkNotClosed();</span><br><span class="line"></span><br><span class="line">            handler = checkHandler(handler, callback);</span><br><span class="line"></span><br><span class="line">            if (DEBUG) &#123;</span><br><span class="line">                Log.v(TAG, mIdString + &quot;capture - request &quot; + request + &quot;, callback &quot; + callback +</span><br><span class="line">                        &quot; handler &quot; + handler);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return addPendingSequence(mDeviceImpl.capture(request,</span><br><span class="line">                    createCaptureCallbackProxy(handler, callback), mDeviceExecutor));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-mDeviceImpl-capture"><a href="#6-2-mDeviceImpl-capture" class="headerlink" title="6.2 mDeviceImpl.capture"></a>6.2 mDeviceImpl.capture</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public int capture(CaptureRequest request, CaptureCallback callback, Executor executor)</span><br><span class="line">           throws CameraAccessException &#123;</span><br><span class="line">       if (DEBUG) &#123;</span><br><span class="line">           Log.d(TAG, &quot;calling capture&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">       List&lt;CaptureRequest&gt; requestList = new ArrayList&lt;CaptureRequest&gt;();</span><br><span class="line">       requestList.add(request);</span><br><span class="line">       return submitCaptureRequest(requestList, callback, executor, /*streaming*/false);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-3-submitCaptureRequest"><a href="#6-3-submitCaptureRequest" class="headerlink" title="6.3 submitCaptureRequest"></a>6.3 submitCaptureRequest</h2><p>该过程和5.3.1类似，最后submitRequestList提交拍照请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">private int submitCaptureRequest(List&lt;CaptureRequest&gt; requestList, CaptureCallback callback,</span><br><span class="line">            Executor executor, boolean repeating) throws CameraAccessException &#123;</span><br><span class="line"></span><br><span class="line">        // Need a valid executor, or current thread needs to have a looper, if</span><br><span class="line">        // callback is valid</span><br><span class="line">        executor = checkExecutor(executor, callback);</span><br><span class="line"></span><br><span class="line">        synchronized(mInterfaceLock) &#123;</span><br><span class="line">            checkIfCameraClosedOrInError();</span><br><span class="line"></span><br><span class="line">            // Make sure that there all requests have at least 1 surface; all surfaces are non-null;</span><br><span class="line">            // the surface isn&apos;t a physical stream surface for reprocessing request</span><br><span class="line">            for (CaptureRequest request : requestList) &#123;</span><br><span class="line">                if (request.getTargets().isEmpty()) &#123;</span><br><span class="line">                    throw new IllegalArgumentException(</span><br><span class="line">                            &quot;Each request must have at least one Surface target&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                for (Surface surface : request.getTargets()) &#123;</span><br><span class="line">                    if (surface == null) &#123;</span><br><span class="line">                        throw new IllegalArgumentException(&quot;Null Surface targets are not allowed&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    for (int i = 0; i &lt; mConfiguredOutputs.size(); i++) &#123;</span><br><span class="line">                        OutputConfiguration configuration = mConfiguredOutputs.valueAt(i);</span><br><span class="line">                        if (configuration.isForPhysicalCamera()</span><br><span class="line">                                &amp;&amp; configuration.getSurfaces().contains(surface)) &#123;</span><br><span class="line">                            if (request.isReprocess()) &#123;</span><br><span class="line">                                throw new IllegalArgumentException(</span><br><span class="line">                                        &quot;Reprocess request on physical stream is not allowed&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (repeating) &#123;</span><br><span class="line">                stopRepeating();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SubmitInfo requestInfo;</span><br><span class="line"></span><br><span class="line">            CaptureRequest[] requestArray = requestList.toArray(new CaptureRequest[requestList.size()]);</span><br><span class="line">            // Convert Surface to streamIdx and surfaceIdx</span><br><span class="line">            for (CaptureRequest request : requestArray) &#123;</span><br><span class="line">                request.convertSurfaceToStreamId(mConfiguredOutputs);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            requestInfo = mRemoteDevice.submitRequestList(requestArray, repeating);</span><br><span class="line">            if (DEBUG) &#123;</span><br><span class="line">                Log.v(TAG, &quot;last frame number &quot; + requestInfo.getLastFrameNumber());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (CaptureRequest request : requestArray) &#123;</span><br><span class="line">                request.recoverStreamIdToSurface();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (callback != null) &#123;</span><br><span class="line">                mCaptureCallbackMap.put(requestInfo.getRequestId(),</span><br><span class="line">                        new CaptureCallbackHolder(</span><br><span class="line">                            callback, requestList, executor, repeating, mNextSessionId - 1));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (DEBUG) &#123;</span><br><span class="line">                    Log.d(TAG, &quot;Listen for request &quot; + requestInfo.getRequestId() + &quot; is null&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (repeating) &#123;</span><br><span class="line">                if (mRepeatingRequestId != REQUEST_ID_NONE) &#123;</span><br><span class="line">                    checkEarlyTriggerSequenceComplete(mRepeatingRequestId,</span><br><span class="line">                            requestInfo.getLastFrameNumber(),</span><br><span class="line">                            mRepeatingRequestTypes);</span><br><span class="line">                &#125;</span><br><span class="line">                mRepeatingRequestId = requestInfo.getRequestId();</span><br><span class="line">                mRepeatingRequestTypes = getRequestTypes(requestArray);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mRequestLastFrameNumbersList.add(</span><br><span class="line">                    new RequestLastFrameNumbersHolder(requestList, requestInfo));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (mIdle) &#123;</span><br><span class="line">                mDeviceExecutor.execute(mCallOnActive);</span><br><span class="line">            &#125;</span><br><span class="line">            mIdle = false;</span><br><span class="line"></span><br><span class="line">            return requestInfo.getRequestId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-4-onCaptureProgressed、onCaptureCompleted"><a href="#6-4-onCaptureProgressed、onCaptureCompleted" class="headerlink" title="6.4 onCaptureProgressed、onCaptureCompleted"></a>6.4 onCaptureProgressed、onCaptureCompleted</h2><p>一旦Request下发到Camera Service之后，当底层生成了Partial Meta Data数据，Camera Service会调用通过调用在打开相机设备时传入的ICameraDeviceCallback代理，通过其onResultReceived方法将数据传回Framework，之后调用App传入的CameraCaptureSession.CaptureCallback中的onCaputreProgressed、onCaptureCompleted方法将结果回传至App进行解析以及后处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">public class CameraDeviceCallbacks extends ICameraDeviceCallbacks.Stub &#123;</span><br><span class="line">  .....</span><br><span class="line"> public void onResultReceived(CameraMetadataNative result,</span><br><span class="line">                CaptureResultExtras resultExtras, PhysicalCaptureResultInfo physicalResults[])</span><br><span class="line">                throws RemoteException &#123;</span><br><span class="line"></span><br><span class="line">            int requestId = resultExtras.getRequestId();</span><br><span class="line">            long frameNumber = resultExtras.getFrameNumber();</span><br><span class="line"></span><br><span class="line">            if (DEBUG) &#123;</span><br><span class="line">                Log.v(TAG, &quot;Received result frame &quot; + frameNumber + &quot; for id &quot;</span><br><span class="line">                        + requestId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            synchronized(mInterfaceLock) &#123;</span><br><span class="line">                if (mRemoteDevice == null) return; // Camera already closed</span><br><span class="line"></span><br><span class="line">                // TODO: Handle CameraCharacteristics access from CaptureResult correctly.</span><br><span class="line">                result.set(CameraCharacteristics.LENS_INFO_SHADING_MAP_SIZE,</span><br><span class="line">                        getCharacteristics().get(CameraCharacteristics.LENS_INFO_SHADING_MAP_SIZE));</span><br><span class="line"></span><br><span class="line">                final CaptureCallbackHolder holder =</span><br><span class="line">                        CameraDeviceImpl.this.mCaptureCallbackMap.get(requestId);</span><br><span class="line">                final CaptureRequest request = holder.getRequest(resultExtras.getSubsequenceId());</span><br><span class="line"></span><br><span class="line">                boolean isPartialResult =</span><br><span class="line">                        (resultExtras.getPartialResultCount() &lt; mTotalPartialCount);</span><br><span class="line">                int requestType = request.getRequestType();</span><br><span class="line"></span><br><span class="line">                // Check if we have a callback for this</span><br><span class="line">                if (holder == null) &#123;</span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        Log.d(TAG,</span><br><span class="line">                                &quot;holder is null, early return at frame &quot;</span><br><span class="line">                                        + frameNumber);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    mFrameNumberTracker.updateTracker(frameNumber, /*result*/null, isPartialResult,</span><br><span class="line">                            requestType);</span><br><span class="line"></span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (isClosed()) &#123;</span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        Log.d(TAG,</span><br><span class="line">                                &quot;camera is closed, early return at frame &quot;</span><br><span class="line">                                        + frameNumber);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    mFrameNumberTracker.updateTracker(frameNumber, /*result*/null, isPartialResult,</span><br><span class="line">                            requestType);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                Runnable resultDispatch = null;</span><br><span class="line"></span><br><span class="line">                CaptureResult finalResult;</span><br><span class="line">                // Make a copy of the native metadata before it gets moved to a CaptureResult</span><br><span class="line">                // object.</span><br><span class="line">                final CameraMetadataNative resultCopy;</span><br><span class="line">                if (holder.hasBatchedOutputs()) &#123;</span><br><span class="line">                    resultCopy = new CameraMetadataNative(result);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    resultCopy = null;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Either send a partial result or the final capture completed result</span><br><span class="line">                if (isPartialResult) &#123;</span><br><span class="line">                    final CaptureResult resultAsCapture =</span><br><span class="line">                            new CaptureResult(result, request, resultExtras);</span><br><span class="line">                    // Partial result</span><br><span class="line">                    resultDispatch = new Runnable() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public void run() &#123;</span><br><span class="line">                            if (!CameraDeviceImpl.this.isClosed()) &#123;</span><br><span class="line">                                if (holder.hasBatchedOutputs()) &#123;</span><br><span class="line">                                    // Send derived onCaptureProgressed for requests within</span><br><span class="line">                                    // the batch.</span><br><span class="line">                                    for (int i = 0; i &lt; holder.getRequestCount(); i++) &#123;</span><br><span class="line">                                        CameraMetadataNative resultLocal =</span><br><span class="line">                                                new CameraMetadataNative(resultCopy);</span><br><span class="line">                                        CaptureResult resultInBatch = new CaptureResult(</span><br><span class="line">                                                resultLocal, holder.getRequest(i), resultExtras);</span><br><span class="line"></span><br><span class="line">                                        holder.getCallback().onCaptureProgressed(</span><br><span class="line">                                            CameraDeviceImpl.this,</span><br><span class="line">                                            holder.getRequest(i),</span><br><span class="line">                                            resultInBatch);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    holder.getCallback().onCaptureProgressed(</span><br><span class="line">                                        CameraDeviceImpl.this,</span><br><span class="line">                                        request,</span><br><span class="line">                                        resultAsCapture);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    finalResult = resultAsCapture;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    List&lt;CaptureResult&gt; partialResults =</span><br><span class="line">                            mFrameNumberTracker.popPartialResults(frameNumber);</span><br><span class="line"></span><br><span class="line">                    final long sensorTimestamp =</span><br><span class="line">                            result.get(CaptureResult.SENSOR_TIMESTAMP);</span><br><span class="line">                    final Range&lt;Integer&gt; fpsRange =</span><br><span class="line">                            request.get(CaptureRequest.CONTROL_AE_TARGET_FPS_RANGE);</span><br><span class="line">                    final int subsequenceId = resultExtras.getSubsequenceId();</span><br><span class="line">                    final TotalCaptureResult resultAsCapture = new TotalCaptureResult(result,</span><br><span class="line">                            request, resultExtras, partialResults, holder.getSessionId(),</span><br><span class="line">                            physicalResults);</span><br><span class="line">                    // Final capture result</span><br><span class="line">                    resultDispatch = new Runnable() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public void run() &#123;</span><br><span class="line">                            if (!CameraDeviceImpl.this.isClosed())&#123;</span><br><span class="line">                                if (holder.hasBatchedOutputs()) &#123;</span><br><span class="line">                                    // Send derived onCaptureCompleted for requests within</span><br><span class="line">                                    // the batch.</span><br><span class="line">                                    for (int i = 0; i &lt; holder.getRequestCount(); i++) &#123;</span><br><span class="line">                                        resultCopy.set(CaptureResult.SENSOR_TIMESTAMP,</span><br><span class="line">                                                sensorTimestamp - (subsequenceId - i) *</span><br><span class="line">                                                NANO_PER_SECOND/fpsRange.getUpper());</span><br><span class="line">                                        CameraMetadataNative resultLocal =</span><br><span class="line">                                                new CameraMetadataNative(resultCopy);</span><br><span class="line">                                        // No logical multi-camera support for batched output mode.</span><br><span class="line">                                        TotalCaptureResult resultInBatch = new TotalCaptureResult(</span><br><span class="line">                                            resultLocal, holder.getRequest(i), resultExtras,</span><br><span class="line">                                            partialResults, holder.getSessionId(),</span><br><span class="line">                                            new PhysicalCaptureResultInfo[0]);</span><br><span class="line"></span><br><span class="line">                                        holder.getCallback().onCaptureCompleted(</span><br><span class="line">                                            CameraDeviceImpl.this,</span><br><span class="line">                                            holder.getRequest(i),</span><br><span class="line">                                            resultInBatch);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    holder.getCallback().onCaptureCompleted(</span><br><span class="line">                                        CameraDeviceImpl.this,</span><br><span class="line">                                        request,</span><br><span class="line">                                        resultAsCapture);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    finalResult = resultAsCapture;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                final long ident = Binder.clearCallingIdentity();</span><br><span class="line">                try &#123;</span><br><span class="line">                    holder.getExecutor().execute(resultDispatch);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    Binder.restoreCallingIdentity(ident);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Collect the partials for a total result; or mark the frame as totally completed</span><br><span class="line">                mFrameNumberTracker.updateTracker(frameNumber, finalResult, isPartialResult,</span><br><span class="line">                        requestType);</span><br><span class="line"></span><br><span class="line">                // Fire onCaptureSequenceCompleted</span><br><span class="line">                if (!isPartialResult) &#123;</span><br><span class="line">                    checkAndFireSequenceComplete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-5-onImageAvailable"><a href="#6-5-onImageAvailable" class="headerlink" title="6.5 onImageAvailable"></a>6.5 onImageAvailable</h2><p>[-&gt;frameworks/base/media/java/android/media/ImageReader.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"> protected ImageReader(int width, int height, int format, int maxImages, long usage) &#123;</span><br><span class="line">      mWidth = width;</span><br><span class="line">      mHeight = height;</span><br><span class="line">      mFormat = format;</span><br><span class="line">      mMaxImages = maxImages;</span><br><span class="line"></span><br><span class="line">      if (width &lt; 1 || height &lt; 1) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              &quot;The image dimensions must be positive&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (mMaxImages &lt; 1) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              &quot;Maximum outstanding image count must be at least 1&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (format == ImageFormat.NV21) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">                  &quot;NV21 format is not supported&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      mNumPlanes = ImageUtils.getNumPlanesForFormat(mFormat);</span><br><span class="line"></span><br><span class="line">      nativeInit(new WeakReference&lt;&gt;(this), width, height, format, maxImages, usage);</span><br><span class="line"></span><br><span class="line">      mSurface = nativeGetSurface();</span><br><span class="line"></span><br><span class="line">      mIsReaderValid = true;</span><br><span class="line">      // Estimate the native buffer allocation size and register it so it gets accounted for</span><br><span class="line">      // during GC. Note that this doesn&apos;t include the buffers required by the buffer queue</span><br><span class="line">      // itself and the buffers requested by the producer.</span><br><span class="line">      // Only include memory for 1 buffer, since actually accounting for the memory used is</span><br><span class="line">      // complex, and 1 buffer is enough for the VM to treat the ImageReader as being of some</span><br><span class="line">      // size.</span><br><span class="line">      mEstimatedNativeAllocBytes = ImageUtils.getEstimatedNativeAllocBytes(</span><br><span class="line">              width, height, format, /*buffer count*/ 1);</span><br><span class="line">      VMRuntime.getRuntime().registerNativeAllocation(mEstimatedNativeAllocBytes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">   * Called from Native code when an Event happens.</span><br><span class="line">   *</span><br><span class="line">   * This may be called from an arbitrary Binder thread, so access to the ImageReader must be</span><br><span class="line">   * synchronized appropriately.</span><br><span class="line">   */</span><br><span class="line">  private static void postEventFromNative(Object selfRef) &#123;</span><br><span class="line">      @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">      WeakReference&lt;ImageReader&gt; weakSelf = (WeakReference&lt;ImageReader&gt;)selfRef;</span><br><span class="line">      final ImageReader ir = weakSelf.get();</span><br><span class="line">      if (ir == null) &#123;</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      final Handler handler;</span><br><span class="line">      synchronized (ir.mListenerLock) &#123;</span><br><span class="line">          handler = ir.mListenerHandler;</span><br><span class="line">      &#125;</span><br><span class="line">      if (handler != null) &#123;</span><br><span class="line">          handler.sendEmptyMessage(0);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   public void setOnImageAvailableListener(OnImageAvailableListener listener, Handler handler) &#123;</span><br><span class="line">      synchronized (mListenerLock) &#123;</span><br><span class="line">          if (listener != null) &#123;</span><br><span class="line">              Looper looper = handler != null ? handler.getLooper() : Looper.myLooper();</span><br><span class="line">              if (looper == null) &#123;</span><br><span class="line">                  throw new IllegalArgumentException(</span><br><span class="line">                          &quot;handler is null but the current thread is not a looper&quot;);</span><br><span class="line">              &#125;</span><br><span class="line">              if (mListenerHandler == null || mListenerHandler.getLooper() != looper) &#123;</span><br><span class="line">                  mListenerHandler = new ListenerHandler(looper);</span><br><span class="line">              &#125;</span><br><span class="line">              mListener = listener;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              mListener = null;</span><br><span class="line">              mListenerHandler = null;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   private final class ListenerHandler extends Handler &#123;</span><br><span class="line">      public ListenerHandler(Looper looper) &#123;</span><br><span class="line">          super(looper, null, true /*async*/);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      @Override</span><br><span class="line">      public void handleMessage(Message msg) &#123;</span><br><span class="line">          OnImageAvailableListener listener;</span><br><span class="line">          synchronized (mListenerLock) &#123;</span><br><span class="line">              listener = mListener;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          // It&apos;s dangerous to fire onImageAvailable() callback when the ImageReader is being</span><br><span class="line">          // closed, as application could acquire next image in the onImageAvailable() callback.</span><br><span class="line">          boolean isReaderValid = false;</span><br><span class="line">          synchronized (mCloseLock) &#123;</span><br><span class="line">              isReaderValid = mIsReaderValid;</span><br><span class="line">          &#125;</span><br><span class="line">          if (listener != null &amp;&amp; isReaderValid) &#123;</span><br><span class="line">              listener.onImageAvailable(ImageReader.this);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   private synchronized native Surface nativeGetSurface();</span><br></pre></td></tr></table></figure>
<p>之前已经通过两个回调接口onCaptureProgressed以及onCaptureCompleted方法将meta data上传到了App，一般情况下，图像数据会在他们之后上传，而且这个上传过程并不经过Camera Framework，而是通过BufferQueue来进行的，当Camera Service接收到底层传来的图像数据，便会立即调用processCaptureResult_3_4方法，该方法中会去调用BufferQueue中生产者角色的Surface的queueBuffer方法，将数据入队并通知消费者去消费，而此时的消费者正是应用侧的ImageReader，并经过一层层回调，最终会通过调用ImageReader的onImageAvailable方法，通知ImageReader去将数据取出，并做后期操作。</p>
<h2 id="6-6-小结"><a href="#6-6-小结" class="headerlink" title="6.6 小结"></a>6.6 小结</h2><p>该方法最终也会调用到Framework中的submitCaptureRequest方法，接下来边和预览流程大致相同，会去调用Camera Service 中的ICameraDeviceUser的submitRequestList方法传入请求，之后将App实现的回调对象存入CameraDeviceImpl对象中。</p>
<h1 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h1><p>基于接口与实现相分离的基本设计原则，谷歌通过Camera Api 接口的定义，搭建起了App与相机系统的桥梁，而具体实现便是由Camera Framework来负责完成的。在采用Camera Api v1接口的时期，该部分是通过JNI层来进行java到C++的转换，进而到达native层，而在native层会通过实现CameraClient建立与Camera Service的通讯 ，整个过程比较繁琐，使得整体框架略显繁杂，而随着Camera Api v2的提出，在该层便大量使用AIDL机制，直接在Java层建立与Camera Service的通信，进一步简化了整体框架。接下来我们以几个主要接口为主线，简单梳理下其具体实现。</p>
<p><img src="/2024/深入理解Android Camera架构一-应用层/cameraframework.png" style="zoom:80%;"></p>
<p><strong>CameraManager</strong></p>
<p>实现主要在CameraManager.java中，通过CameraManager查询、获取以及打开一个Camera 设备。在该类中还实现了内部类CameraManagerGlobal，该类继承于ICameraServiceListener.Stub，在打开相机设备的时候，在内部会获取到ICameraService远程代理，并且调用ICameraService的addListener方法将自己注册到Camera Service中，一旦Camera Service状态有所变更便会通过其实现的回调方法通知到Camera Manager服务，另外，该类还通过调用ICameraService.connectDevice()方法获取到Camera Service中的CameraDevice远程代理，并且将该代理传入CameraDeviceImpl中，进而与Camera Service建立了连接。</p>
<p><strong>CameraDeviceImpl</strong></p>
<p>该类定义在CameraDeviceImpl.java文件中，继承并实现了CameraDevice接口，代表了一个相机设备，可以完成CameraCaptureSession的创建以及CaptureRequest创建等工作，内部定义了CameraDeviceCallbacks类(该类继承于ICameraDeviceCallbacks.Stub，对应于Camera Service中的 ICameraDeviceCallbacks接口)，用于接收来自Camera Service中的Camera Device的状态回调，并且内部维护着一个Camera Service 的远程ICameraDevice代理，进而可以下发图像请求到Camera Service中。</p>
<p><strong>CameraCaptureSessionImpl</strong></p>
<p>该类定义在CameraCaptureSessionImpl.java文件中，继承并实现了CameraCaptureSession接口，每一个相机设备在一个时间段中，只能创建并存在一个CameraCaptureSession，其中该类包含了两种Session，一种是普通的，适用于一般情况下的会话操作，另一种是用于Reprocess流程的会话操作，该流程主要用于对于现有的图像数据进行再处理的操作。该类维护着来自实例化时传入的Surface列表，这些Surface正是包含了每一个图像请求的数据缓冲区。除了以上这几个接口，还有几个接口是需要App部分进行实现的，用于返回App所需要的对象或者数据：</p>
<p><strong>CameraDevice.StateCallback</strong></p>
<p>被应用侧进行继承并实现，用于在调用CameraManager的openCamera方法时，通过参数的形式传入Framework，在Framework中，一旦CameraDeviceImpl创建成功便通过其中的onOpened方法将其返回给App，如果失败，便会通过其他方法返回给App错误信息。</p>
<p><strong>CameraCaptureSession.StateCallback</strong></p>
<p>被应用侧进行继承并实现，用于在调用CameraDevice的createCaptureSession方法时作为参数传入Framework中，一旦创建成功，Framework便会通过调用该类的onConfigured接口返回一个CameraCaptureSessionImpl的对象，如果失败，Framework会调用其onConfigureFailed方法将错误信息返回至App。</p>
<p><strong>CameraCaptureSession.CaptureCallback</strong></p>
<p>被应用侧进行继承并实现，App通过调用CameraCaptureSessionImpl的setReaptingRequest或者capture方法是作为参数传入Framework，一旦Framework接收到来自CameraService的数据时，便会通过调用这个回调类将数据发送至App中。</p>
<p><img src="/2024/深入理解Android Camera架构一-应用层/cameraframework_binder.png" alt=""></p>

      
    </div>


    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android-Camera/" rel="tag">#Android Camera</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2023/Android视频基础知识/" rel="next" title="Android视频基础知识">
                <i class="fa fa-chevron-left"></i> Android视频基础知识
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/深入理解Android Camera架构二-服务层/" rel="prev" title="深入理解Android Camera架构二-服务层">
                深入理解Android Camera架构二-服务层 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Skytoby">
          <p class="site-author-name" itemprop="name">Skytoby</p>
          <p class="site-description motion-element" itemprop="description">现居深圳，毕业于电子科技大学 <br>Android、AI<br>座右铭：想法+行动+坚持</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caoxiaoliang" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/cao861544325" target="_blank" title="CSDN">
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、打开Camera主流程"><span class="nav-text">一、打开Camera主流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-初始化TextureView并设置监听"><span class="nav-text">1.1 初始化TextureView并设置监听</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-SurfaceTexture可用打开Camera"><span class="nav-text">1.2 SurfaceTexture可用打开Camera</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-创建Camera-Session，请求Camera数据"><span class="nav-text">1.3 创建Camera Session，请求Camera数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-拍照"><span class="nav-text">1.4 拍照</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、mCamManager-openCamera"><span class="nav-text">二、mCamManager.openCamera</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-openCamera"><span class="nav-text">2.1 openCamera</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-openCameraForUid"><span class="nav-text">2.2 openCameraForUid</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-openCameraDeviceUserAsync"><span class="nav-text">2.3 openCameraDeviceUserAsync</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-创建CameraDeviceImpl对象"><span class="nav-text">2.3.1 创建CameraDeviceImpl对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-deviceImpl-getCallbacks"><span class="nav-text">2.3.2 deviceImpl.getCallbacks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-getCameraService"><span class="nav-text">2.3.3 getCameraService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-4-connectDevice"><span class="nav-text">2.3.4 connectDevice</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-5-setRemoteDevice"><span class="nav-text">2.3.5 setRemoteDevice</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-6-mDeviceExecutor-execute"><span class="nav-text">2.3.6 mDeviceExecutor.execute</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-小结"><span class="nav-text">2.4 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、mCamDevice-createCaptureSession"><span class="nav-text">三、mCamDevice.createCaptureSession</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-createCaptureSession"><span class="nav-text">3.1 createCaptureSession</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-createCaptureSessionInternal"><span class="nav-text">3.2 createCaptureSessionInternal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-configureStreamsChecked"><span class="nav-text">3.2.1 configureStreamsChecked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-创建CameraCaptureSessionImpl"><span class="nav-text">3.2.2 创建CameraCaptureSessionImpl</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-小结"><span class="nav-text">3.3 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、mCamDevice-createCaptureRequest"><span class="nav-text">四、mCamDevice.createCaptureRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-createCaptureRequest"><span class="nav-text">4.1 createCaptureRequest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-小结"><span class="nav-text">4.2 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、mCamSession-setRepeatingRequest"><span class="nav-text">五、mCamSession.setRepeatingRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-setRepeatingRequest"><span class="nav-text">5.1 setRepeatingRequest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-addPendingSequence"><span class="nav-text">5.2 addPendingSequence</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-setRepeatingRequest"><span class="nav-text">5.2.1 setRepeatingRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-submitRequestList"><span class="nav-text">5.2.2 submitRequestList</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-小结"><span class="nav-text">5.3 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、mCamSession-capture"><span class="nav-text">六、mCamSession.capture</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-capture"><span class="nav-text">6.1  capture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-mDeviceImpl-capture"><span class="nav-text">6.2 mDeviceImpl.capture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-submitCaptureRequest"><span class="nav-text">6.3 submitCaptureRequest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-onCaptureProgressed、onCaptureCompleted"><span class="nav-text">6.4 onCaptureProgressed、onCaptureCompleted</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-onImageAvailable"><span class="nav-text">6.5 onImageAvailable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6-小结"><span class="nav-text">6.6 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七、总结"><span class="nav-text">七、总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skytoby</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme Next
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'https-zproo-github-io';
      var disqus_identifier = '2024/深入理解Android Camera架构一-应用层/';
      var disqus_title = "深入理解Android Camera架构一-应用层";
      var disqus_url = 'http://zproo.github.io/2024/深入理解Android Camera架构一-应用层/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  









  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
