<!doctype html>



  


<html class="theme-next pisces use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Framework接口,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="Android Framwork开发过程中，经常会遇到新增接口的需求，下面将介绍基本上所有需要用到的接口开发流程。 一、JNI接口在系统开发接口过程中，很多情况需要通过JNI接口的方式调用一些库或者驱动，通过Android studio的方式构建native工程比较简单，下面主要介绍在framework层如何自定义jni接口。 JNI的原理参考：https://skytoby.github.io/">
<meta name="keywords" content="Framework接口">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Framework接口开发总结">
<meta property="og:url" content="http://zproo.github.io/2023/Android Framewok接口开发总结/index.html">
<meta property="og:site_name" content="Skytoby">
<meta property="og:description" content="Android Framwork开发过程中，经常会遇到新增接口的需求，下面将介绍基本上所有需要用到的接口开发流程。 一、JNI接口在系统开发接口过程中，很多情况需要通过JNI接口的方式调用一些库或者驱动，通过Android studio的方式构建native工程比较简单，下面主要介绍在framework层如何自定义jni接口。 JNI的原理参考：https://skytoby.github.io/">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2024-01-06T04:13:12.773Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android Framework接口开发总结">
<meta name="twitter:description" content="Android Framwork开发过程中，经常会遇到新增接口的需求，下面将介绍基本上所有需要用到的接口开发流程。 一、JNI接口在系统开发接口过程中，很多情况需要通过JNI接口的方式调用一些库或者驱动，通过Android studio的方式构建native工程比较简单，下面主要介绍在framework层如何自定义jni接口。 JNI的原理参考：https://skytoby.github.io/">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://zproo.github.io/2023/Android Framewok接口开发总结/">

  <title> Android Framework接口开发总结 | Skytoby </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <header id="header_post" class="header" itemscope="" itemtype="http://schema.org/WPHeader" style="background-image: url('http://ortur5wom.bkt.clouddn.com/home_bg.jpg');">
      <div class="header-inner-post"><a class="site-home" href="/">Skytoby</a>

<div class="site-meta ">
  
  
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/logo.png" style="width: 50px" alt="Skytoby">
      </a>
    </div>
  

  
  
  
  
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
           <li class="menu-item menu-item-关于">
             <a href="/about" rel="section">
               
               
               关于
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-目录">
             <a href="/archives" rel="section">
               
               
               目录
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-首页">
             <a href="/" rel="section">
               
               
               首页
             </a>
           </li>
        
      

      
    </ul>
  

  
</nav> </div>
      <div class="header-post"> 
  <div class="post-header">
      <div class="tags">
      
        <a href="/tags/Framework接口/" rel="tag" title="Framework接口">Framework接口</a>
      
      </div>
      <h1>Android Framework接口开发总结</h1>
      <h2 class="subtitle"></h2>
      <div class="post-time">
        <span class="post-meta-item-text">Posted on </span>
        <time itemprop="dateCreated" datetime="2023-10-15T21:18:23+08:00" content="2023-10-15" title="2023-10-15 21:18:23">
          2023-10-15
        </time>
      </div>
  </div>
 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android Framework接口开发总结
              
            
          </h1>
        

        <div class="post-meta">
		  

          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2023-10-15T21:18:23+08:00" content="2023-10-15">
              2023-10-15
            </time>
          </span>

          

          <!--  -->

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Android Framwork开发过程中，经常会遇到新增接口的需求，下面将介绍基本上所有需要用到的接口开发流程。</p>
<h1 id="一、JNI接口"><a href="#一、JNI接口" class="headerlink" title="一、JNI接口"></a>一、JNI接口</h1><p>在系统开发接口过程中，很多情况需要通过JNI接口的方式调用一些库或者驱动，通过Android studio的方式构建native工程比较简单，下面主要介绍在framework层如何自定义jni接口。</p>
<p>JNI的原理参考：<a href="https://skytoby.github.io/2020/Android%20JNI%20%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">https://skytoby.github.io/2020/Android%20JNI%20%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</a></p>
<h2 id="1-1-源码编译so库"><a href="#1-1-源码编译so库" class="headerlink" title="1.1 源码编译so库"></a>1.1 源码编译so库</h2><p>在 vendor 目录下创建 skytoby目录，我们把代码放到 testjni 里面。</p>
<p>测试jni接口源码文件，里面有一个jni方法还有一个带回调的jni方法例子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  sayHello方法的实现</span></span><br><span class="line"><span class="comment"> * @param jniEnv JNINativeInterface_结构体的二级指针对象里面包含了很多函数指针</span></span><br><span class="line"><span class="comment"> * @param jobject1 调用此方法的对象实例（即main方法中的dynamicDemo）</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">jstring <span class="title">jniSayHello</span><span class="params">(JNIEnv *jniEnv, jobject)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jniEnv-&gt;NewStringUTF(<span class="string">"我是Native方法sayHello的实现你好"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  sayBye方法的实现</span></span><br><span class="line"><span class="comment"> * @param jniEnv  JNINativeInterface_结构体的二级指针对象里面包含了很多函数指针</span></span><br><span class="line"><span class="comment"> * @param jobject1 调用此方法的对象实例（即main方法中的dynamicDemo）</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">jstring <span class="title">jniSayBye</span><span class="params">(JNIEnv *jniEnv, jobject)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jniEnv-&gt;NewStringUTF(<span class="string">"我是Native方法sayBye的实现拜拜"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">jniRegisterCallback</span><span class="params">(JNIEnv* jniEnv, jobject, jobject jcallback)</span> </span>&#123;</span><br><span class="line">        jclass callbackClass = jniEnv-&gt;GetObjectClass(jcallback);</span><br><span class="line">        jmethodID callbackMethodId = jniEnv-&gt;GetMethodID(callbackClass, <span class="string">"sayCallback"</span>, <span class="string">"(Ljava/lang/String;)V"</span>);</span><br><span class="line">        jniEnv-&gt;CallVoidMethod(jcallback, callbackMethodId, jniEnv-&gt;NewStringUTF(<span class="string">"我是jniRegisterCallback回调"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 声明sayHello和sayBye的类路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* mClassName=<span class="string">"com/skytoby/JniTest"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JNINativeMethod结构体</span></span><br><span class="line"><span class="comment"> * 包含：name-方法名；signature-方法签名(描述返回值和入参)；fnPtr-c中实现的函数指针</span></span><br><span class="line"><span class="comment"> * 方法签名可以根据javap命令反编译查看或使用jclasslib插件查看</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod mMethod[]=&#123;</span><br><span class="line">        &#123;<span class="string">"sayHello"</span>,<span class="string">"()Ljava/lang/String;"</span>,<span class="keyword">reinterpret_cast</span>&lt;jstring *&gt;(jniSayHello)&#125;,</span><br><span class="line">        &#123;<span class="string">"sayBye"</span>,<span class="string">"()Ljava/lang/String;"</span>,<span class="keyword">reinterpret_cast</span>&lt;jstring *&gt;(jniSayBye)&#125;,</span><br><span class="line">        &#123;<span class="string">"registerCallBack"</span>,<span class="string">"(Lcom/skytoby/HelloCallback;)V"</span>,<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(jniRegisterCallback)&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">registerNativeMethods</span><span class="params">(JNIEnv* env, <span class="keyword">const</span> <span class="keyword">char</span>* className,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> JNINativeMethod* gMethods, <span class="keyword">int</span> numMethods)</span> </span>&#123;</span><br><span class="line">        jclass clazz = env-&gt;FindClass(className);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ALOGV(<span class="string">"registerNativeMethods 1"</span>);</span><br><span class="line">                <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (env-&gt;RegisterNatives(clazz, gMethods, numMethods) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGV(<span class="string">"registerNativeMethods 2"</span>);</span><br><span class="line">                <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* jvm, <span class="keyword">void</span>*)</span> </span>&#123;</span><br><span class="line">        JNIEnv *env = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (jvm-&gt;GetEnv(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;env), JNI_VERSION_1_6)) &#123;</span><br><span class="line">                 ALOGV(<span class="string">"JNI_OnLoad 1"</span>);</span><br><span class="line">                <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (registerNativeMethods(env, mClassName, mMethod, <span class="keyword">sizeof</span>(mMethod) / <span class="keyword">sizeof</span>(mMethod[<span class="number">0</span>])) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGV(<span class="string">"JNI_OnLoad 2"</span>);</span><br><span class="line">                <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>testjni目录下增加编译文件文件Android.bp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cc_library_shared &#123;</span><br><span class="line">    name: <span class="string">"libtestjni"</span>,</span><br><span class="line">        </span><br><span class="line">    srcs: [</span><br><span class="line">        <span class="string">"JniTest.cpp"</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在testjni目录下下，执行mm，执行成功后会在对应的out目前下的system\lib64有一个libtestjni.so文件生成，说明编译成功，那如何让Java层的Framework可以调用到这个库里面的方法，下面将介绍。</p>
<h2 id="1-2-so库导入系统"><a href="#1-2-so库导入系统" class="headerlink" title="1.2 so库导入系统"></a>1.2 so库导入系统</h2><p>将库编译进系统，只需要在device目前下的mk文件加上如下代码即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += libtestjni</span><br></pre></td></tr></table></figure>
<h2 id="1-3-Java-jni调用"><a href="#1-3-Java-jni调用" class="headerlink" title="1.3 Java jni调用"></a>1.3 Java jni调用</h2><p>加载so，编写native函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package com.skytoby;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> JniTest &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"testjni"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> native String <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> native String <span class="title">sayBye</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> native <span class="keyword">void</span> <span class="title">registerCallBack</span><span class="params">(HelloCallback callback)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回调接口</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package com.skytoby;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> interface HelloCallback &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayCallback</span><span class="params">(String msg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">JniTest jniTest = <span class="keyword">new</span> JniTest();</span><br><span class="line">Log.d(<span class="string">"skytoby"</span>,jniTest.sayHello());</span><br><span class="line">Log.d(<span class="string">"skytoby"</span>,jniTest.sayBye());</span><br><span class="line">jniTest.registerCallBack(<span class="keyword">new</span> HelloCallback() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> sayCallback(String msg) &#123;</span><br><span class="line">        Log.d(<span class="string">"skytoby"</span>,<span class="string">"sayCallback "</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在framework代码中加上测试代码，可以正常看到打印。</p>
<h1 id="二、Jave服务接口"><a href="#二、Jave服务接口" class="headerlink" title="二、Jave服务接口"></a>二、Jave服务接口</h1><h2 id="2-1-使用-aidl-定义服务接口"><a href="#2-1-使用-aidl-定义服务接口" class="headerlink" title="2.1 使用 aidl 定义服务接口"></a>2.1 使用 aidl 定义服务接口</h2><p>首先我们得定义我们的服务名是什么，提供什么样的接口。 在这个例子里面，我们的服务就叫 HelloService，它提供了下接口：</p>
<ul>
<li>void hello(String name) //播放指定路径的音频文件</li>
</ul>
<p>在 frameworks/base/core/java/android 目录下创建 pure 目录，我们把代码放到 pure 里面。 pure 目录下增加中文件 IHelloService.aidl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.pure;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IHelloService</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">hello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 frameworks/base/Android.bp framework-defaults 模块中添加我们刚刚加的 aidl 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"core/java/android/pure/IHelloService.aidl"</span>,</span><br></pre></td></tr></table></figure>
<p>然后进入 framework/base 目录执行 mm -j 命令编译 framework.jar 模块。 编译成功后，会在 out/soong/.intermediates/frameworks/base/framework/android_common/gen/aidl/frameworks/base/core/java/android/pure 目录生成 IHelloService.java 这个文件。 这个文件封装了 binder 通信的相关细节，有兴趣的同学可以去了解一下。</p>
<h2 id="2-2-实现接口"><a href="#2-2-实现接口" class="headerlink" title="2.2 实现接口"></a>2.2 实现接口</h2><p>在 frameworks/base/services/core/java/com/android/server 目录下新建 HelloService.java 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.pure.IHelloService;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">IHelloService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> String TAG = <span class="string">"HelloService"</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">HelloService</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> Log.d(TAG, <span class="string">"create hello service"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"> Log.d(TAG, <span class="string">"hello "</span> + name);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-将服务添加到-ServiceManager"><a href="#2-3-将服务添加到-ServiceManager" class="headerlink" title="2.3 将服务添加到 ServiceManager"></a>2.3 将服务添加到 ServiceManager</h2><p>修改 frameworks/base/services/java/com/android/server/SystemServer.java 文件，在 startOtherServices 方法里面增加以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add hello service</span></span><br><span class="line">traceBeginAndSlog(<span class="string">"HelloService"</span>);</span><br><span class="line">ServiceManager.addService(<span class="string">"HelloService"</span>, <span class="keyword">new</span> HelloService());</span><br><span class="line">traceEnd();</span><br></pre></td></tr></table></figure>
<p>至此服务算是添加完了，我们来编译运行一下，发现系统起不来了，看下错误 log</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> I SystemServer: HelloService</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> D HelloService: create hello service</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">1526</span> <span class="number">1526</span> E SELinux : avc: denied &#123; add &#125; <span class="keyword">for</span> service=HelloService pid=<span class="number">3521</span> uid=<span class="number">1000</span> scontext=u:r:system_server:s0 tcontext=u:object_r:default_android_service:s0 tclass=service_manager permissive=<span class="number">0</span></span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">1526</span> <span class="number">1526</span> E ServiceManager: add_service(<span class="string">'HelloService'</span>,<span class="number">95</span>) uid=<span class="number">1000</span> - PERMISSION DENIED</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : ******************************************</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : ************ Failure starting system services</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : java.lang.SecurityException</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at android.os.BinderProxy.transactNative(Native Method)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at android.os.BinderProxy.transact(BinderProxy.java:<span class="number">510</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at android.os.ServiceManagerProxy.addService(ServiceManagerNative.java:<span class="number">156</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at android.os.ServiceManager.addService(ServiceManager.java:<span class="number">192</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at android.os.ServiceManager.addService(ServiceManager.java:<span class="number">161</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at com.android.server.SystemServer.startOtherServices(SystemServer.java:<span class="number">1914</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at com.android.server.SystemServer.run(SystemServer.java:<span class="number">512</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at com.android.server.SystemServer.main(SystemServer.java:<span class="number">349</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> E System : at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">908</span>)</span><br><span class="line"><span class="number">12</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">46</span>:<span class="number">47.308</span> <span class="number">3521</span> <span class="number">3521</span> D SystemServerTiming: HelloService took to complete: <span class="number">1</span>ms</span><br></pre></td></tr></table></figure>
<p>从 <code>SELinux : avc: denied { add } for service=HelloService</code> 这个信息来看，是因为我们没有添加 SELinux 规则，什么是 SELinux 这里就不展开了，同学们可以自己去查下资料。</p>
<h2 id="2-4-selinux-规则设置"><a href="#2-4-selinux-规则设置" class="headerlink" title="2.4 selinux 规则设置"></a>2.4 selinux 规则设置</h2><p>Android 10 的 selinux 规则是放在 system/sepolicy 目录下的。 但 Android 每个版本 selinux 的添加规则多多少少是有些变化的，我们要怎么把这个新服务的 SELinux 规则给加上呢, 我们可以参考现有的系统服务的规则去添加，这里参考的是 network_time_update_service 服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd system/sepolicy</span><br><span class="line">grep -nr network_time_update_service</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">prebuilts/api/<span class="number">28.0</span>/plat_pub_versioned.cil:<span class="number">2650</span>:(type network_time_update_service)</span><br><span class="line">prebuilts/api/<span class="number">28.0</span>/plat_pub_versioned.cil:<span class="number">2651</span>:(typeattribute network_time_update_service_28_0)</span><br><span class="line">prebuilts/api/<span class="number">28.0</span>/plat_pub_versioned.cil:<span class="number">2652</span>:(roletype object_r network_time_update_service_28_0)</span><br><span class="line">prebuilts/api/<span class="number">28.0</span>/<span class="keyword">public</span>/service.te:<span class="number">107</span>:type network_time_update_service, system_server_service, service_manager_type;</span><br><span class="line">prebuilts/api/<span class="number">28.0</span>/<span class="keyword">private</span>/compat/<span class="number">27.0</span>/<span class="number">27.0</span>.cil:<span class="number">385</span>:(expandtypeattribute (network_time_update_service_27_0) <span class="keyword">true</span>)</span><br><span class="line">prebuilts/api/<span class="number">28.0</span>/<span class="keyword">private</span>/compat/<span class="number">27.0</span>/<span class="number">27.0</span>.cil:<span class="number">1102</span>:(<span class="function">typeattributeset <span class="title">network_time_update_service_27_0</span> <span class="params">(network_time_update_service)</span>)</span></span><br><span class="line"><span class="function">prebuilts/api/28.0/<span class="keyword">private</span>/compat/26.0/26.0.cil:389:<span class="params">(typeattributeset network_time_update_service_26_0 (network_time_update_service)</span>)</span></span><br><span class="line"><span class="function">prebuilts/api/28.0/<span class="keyword">private</span>/service_contexts:109:network_time_update_service u:object_r:network_time_update_service:s0</span></span><br><span class="line"><span class="function"><span class="keyword">public</span>/service.te:125:type network_time_update_service, system_server_service, service_manager_type</span>;</span><br><span class="line"><span class="keyword">private</span>/compat/<span class="number">27.0</span>/<span class="number">27.0</span>.cil:<span class="number">391</span>:(expandtypeattribute (network_time_update_service_27_0) <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">private</span>/compat/<span class="number">27.0</span>/<span class="number">27.0</span>.cil:<span class="number">1108</span>:(<span class="function">typeattributeset <span class="title">network_time_update_service_27_0</span> <span class="params">(network_time_update_service)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span>/compat/26.0/26.0.cil:395:<span class="params">(typeattributeset network_time_update_service_26_0 (network_time_update_service)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span>/compat/28.0/28.0.cil:463:<span class="params">(expandtypeattribute (network_time_update_service_28_0)</span> <span class="keyword">true</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span>/compat/28.0/28.0.cil:1306:<span class="params">(typeattributeset network_time_update_service_28_0 (network_time_update_service)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span>/service_contexts:132:network_time_update_service u:object_r:network_time_update_service:s0</span></span><br></pre></td></tr></table></figure>
<p>涉及到的文件很多，有部分文件是不需要修改的，我们先把找到的所有 service.te 和 service_contexts 都参考 network_time_update_service 加上 HelloService 的配置。</p>
<p>service_contexts 加上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HelloService u:object_r:HelloService:s0</span><br></pre></td></tr></table></figure>
<p>service.te 加上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type HelloService, system_server_service, service_manager_type;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-编译验证"><a href="#2-5-编译验证" class="headerlink" title="2.5 编译验证"></a>2.5 编译验证</h2><p>完成以上各步骤的修改后，我们就可以先来验证一下，服务是否添加成功了。 先 <code>make api-stubs-docs-update-current-api -j20</code> 更新一下 api 接口，再整编系统。 运行虚拟机，执行 <code>service list</code> 看看有没有 HelloService 服务。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pure:/ # service list | grep HelloService </span><br><span class="line"><span class="number">16</span> HelloService: [android.pure.IHelloService]</span><br><span class="line">pure:/ #</span><br></pre></td></tr></table></figure>
<h2 id="2-6-客户端调用"><a href="#2-6-客户端调用" class="headerlink" title="2.6 客户端调用"></a>2.6 客户端调用</h2><p>我们创建完服务端之后，还要考虑怎么提供 api 接口给到 client 使用。我们分为两种情况来讨论。</p>
<h3 id="2-6-1-系统源码中使用"><a href="#2-6-1-系统源码中使用" class="headerlink" title="2.6.1 系统源码中使用"></a>2.6.1 系统源码中使用</h3><p>假如我们上面添加的服务是给在系统源码中编译的模块使用的，那就简单了。比如一个 apk ，我们在系统源码中创建一个 apk 模块。目录结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models$ tree PureSettings/</span><br><span class="line">PureSettings/</span><br><span class="line">├── Android.bp</span><br><span class="line">├── AndroidManifest.xml</span><br><span class="line">├── res</span><br><span class="line">│ ├── layout</span><br><span class="line">│ │ └── activity_main.xml</span><br><span class="line">│ └── mipmap-hdpi</span><br><span class="line">│ └── ic_launcher.png</span><br><span class="line">└── src</span><br><span class="line"> └── com</span><br><span class="line"> └── pure</span><br><span class="line"> └── settings</span><br><span class="line"> └── MainActivity.java</span><br><span class="line"></span><br><span class="line"><span class="number">7</span> directories, <span class="number">5</span> files</span><br><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models$</span><br></pre></td></tr></table></figure>
<p>Android.bp：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android_app &#123;</span><br><span class="line"> srcs: [<span class="string">"src/**/*.java"</span>],</span><br><span class="line"> resource_dirs: [<span class="string">"res"</span>],</span><br><span class="line"> name: <span class="string">"PureSettings"</span>,</span><br><span class="line"> certificate: <span class="string">"platform"</span>,</span><br><span class="line"> platform_apis: <span class="keyword">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 platform_apis 要设置为 true，不然没法调用我们新加的服务和 ServiceManager 。</p>
<p>AndroidManifest.xml：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line"> <span class="keyword">package</span>=<span class="string">"com.pure.settings"</span>&gt;</span><br><span class="line"> &lt;application</span><br><span class="line"> android:icon=<span class="string">"@mipmap/ic_launcher"</span></span><br><span class="line"> android:label=<span class="string">"PureSettings"</span></span><br><span class="line"> android:supportsRtl=<span class="string">"true"</span>&gt;</span><br><span class="line"> &lt;activity android:name=<span class="string">"com.pure.settings.MainActivity"</span>&gt;</span><br><span class="line"> &lt;intent-filter&gt;</span><br><span class="line"> &lt;action android:name=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span><br><span class="line"> &lt;category android:name=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span><br><span class="line"> &lt;/intent-filter&gt;</span><br><span class="line"> &lt;/activity&gt;</span><br><span class="line"> &lt;/application&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>
<p>res/layout/activity_main.xml:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line"> xmlns:app=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line"> xmlns:tools=<span class="string">"http://schemas.android.com/tools"</span></span><br><span class="line"> android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line"> android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line"> android:orientation=<span class="string">"vertical"</span></span><br><span class="line"> tools:context=<span class="string">".MainActivity"</span>&gt;</span><br><span class="line"> &lt;Button</span><br><span class="line"> android:id=<span class="string">"@+id/button"</span></span><br><span class="line"> android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line"> android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line"> android:text=<span class="string">"test"</span> /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p>src/com/pure/settings/MainActivity.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pure.settings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.os.ServiceManager;</span><br><span class="line"><span class="keyword">import</span> android.pure.IHelloService;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PureSettings"</span>;</span><br><span class="line"> <span class="keyword">private</span> IHelloService service = <span class="keyword">null</span>;</span><br><span class="line"> <span class="keyword">private</span> Button button;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> Log.d(TAG, <span class="string">"test"</span>);</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"> service.hello(<span class="string">"skytoby"</span>);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"> e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> setContentView(R.layout.activity_main);</span><br><span class="line"> service = IHelloService.Stub.asInterface(ServiceManager.getService(<span class="string">"HelloService"</span>));</span><br><span class="line"></span><br><span class="line"> button = (Button) findViewById(R.id.button);</span><br><span class="line"> button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"> test();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把模块添加到系统, pure.mk:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += PureSettings</span><br></pre></td></tr></table></figure>
<p>编译运行，闪退了，看下错误日志，发现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>-<span class="number">21</span> <span class="number">23</span>:<span class="number">55</span>:<span class="number">32.970</span> <span class="number">1526</span> <span class="number">1526</span> E SELinux : avc: denied &#123; find &#125; <span class="keyword">for</span> service=HelloService pid=<span class="number">4266</span> uid=<span class="number">10102</span> scontext=u:r:platform_app:s0:c512,c768 tcontext=u:object_r:HelloService:s0 tclass=service_manager permissive=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>看起来是还有 selinux 权限需要添加。具体分析如下 缺少什么权限：{find}权限， 谁缺少权限：scontext=u:r:platform_app:s0:c512,c768 对哪个文件缺少权限：tcontext=u:object_r:HelloService:s0 什么类型的文件：tclass=service_manager</p>
<p>完整的意思： platform_app 缺少 service_manager 类型的 HelloService 的 find 权限。</p>
<p>根据以上分析，我们就可以找到解决方案： 在 platform_app.te 中添加 HelloService 的 find 权限即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow platform_app HelloService:service_manager find;allow platform_app HelloService:service_manager find;</span><br></pre></td></tr></table></figure>
<p>我们查找一下有哪些 platform_app.te 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/system/sepolicy$ find -name platform_app.te </span><br><span class="line">./prebuilts/api/<span class="number">27.0</span>/<span class="keyword">public</span>/platform_app.te</span><br><span class="line">./prebuilts/api/<span class="number">27.0</span>/<span class="keyword">private</span>/platform_app.te</span><br><span class="line">./prebuilts/api/<span class="number">29.0</span>/<span class="keyword">public</span>/platform_app.te</span><br><span class="line">./prebuilts/api/<span class="number">29.0</span>/<span class="keyword">private</span>/platform_app.te</span><br><span class="line">./prebuilts/api/<span class="number">26.0</span>/<span class="keyword">public</span>/platform_app.te</span><br><span class="line">./prebuilts/api/<span class="number">26.0</span>/<span class="keyword">private</span>/platform_app.te</span><br><span class="line">./prebuilts/api/<span class="number">28.0</span>/<span class="keyword">public</span>/platform_app.te</span><br><span class="line">./prebuilts/api/<span class="number">28.0</span>/<span class="keyword">private</span>/platform_app.te</span><br><span class="line">./<span class="keyword">public</span>/platform_app.te</span><br><span class="line">./<span class="keyword">private</span>/platform_app.te</span><br></pre></td></tr></table></figure>
<p>把找到的所有 private/platform_app.te 都加上后，再重新编译运行发现不会挂了，看下 logcat:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">130|pure:/ # logcat -c;logcat -s "HelloService:V" "PureSettings:V" </span><br><span class="line"><span class="number">12</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">47</span>:<span class="number">26.505</span> <span class="number">4291</span> <span class="number">4291</span> D PureSettings: test</span><br><span class="line"><span class="number">12</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">47</span>:<span class="number">26.506</span> <span class="number">1757</span> <span class="number">3514</span> D HelloService: hello skytoby</span><br></pre></td></tr></table></figure>
<p>的确调用到了我们添加的服务。</p>
<h3 id="2-6-2-非系统源码中使用"><a href="#2-6-2-非系统源码中使用" class="headerlink" title="2.6.2 非系统源码中使用"></a>2.6.2 非系统源码中使用</h3><p>前面实现了在 Android 系统源码中调用新添加服务的方法，但在实际项目中很多情况是在非系统源码环境下使用的。这种情况我们一般是再封装一层接口出来。 调用的层级为： apk –&gt; HelloApi –&gt; HelloService 我们按以下目录结构创建 HelloApi 模块：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models$ tree HelloApi/</span><br><span class="line">HelloApi/</span><br><span class="line">├── Android.bp</span><br><span class="line">└── java</span><br><span class="line"> └── com</span><br><span class="line"> └── pure</span><br><span class="line"> └── api</span><br><span class="line"> └── HelloManager.java</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> directories, <span class="number">2</span> files</span><br><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models$</span><br></pre></td></tr></table></figure>
<p>Android.bp:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java_library &#123;</span><br><span class="line"> name: <span class="string">"com.pure.api"</span>,</span><br><span class="line"> installable: <span class="keyword">true</span>,</span><br><span class="line"> srcs: [</span><br><span class="line"> <span class="string">"java/**/*.java"</span>, <span class="comment">//文件列表</span></span><br><span class="line"> ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HelloManager.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pure.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.os.ServiceManager;</span><br><span class="line"><span class="keyword">import</span> android.pure.IHelloService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> HelloManager mInstance = <span class="keyword">null</span>;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HelloManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">null</span> == mInstance) &#123;</span><br><span class="line"> mInstance = <span class="keyword">new</span> HelloManager();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> mInstance;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> IHelloService mService = <span class="keyword">null</span>;</span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="title">HelloManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> mService = IHelloService.Stub.asInterface(ServiceManager.getService(<span class="string">"HelloService"</span>));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"> mService.hello(name);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"> e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后到 HelloApi 目录 mm 编译模块，得到 out/target/common/obj/JAVA_LIBRARIES/com.pure.api_intermediates/classes.jar 文件。 我们把这个 classes.jar 文件，复制到用 android-studio 创建的 apk 项目 的 app/libs 目录下，改名为 com.pure.api.jar 。 右键单击 com.pure.api.jar 选择 add as library， 然后我们就可以在 apk 的代码中使用 com.pure.api.jar 的接口了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> setContentView(R.layout.activity_main);</span><br><span class="line"> HelloManager.getInstance().sayHello(<span class="string">"skytoby"</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安装 apk 到虚拟机上运行，又遇到了 SELinux : avc: denied 错误，这次的错误是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E SELinux : avc:  denied  &#123; find &#125; for service=HelloService pid=4266 uid=10102 scontext=u:r:untrusted_app:s0:c512,c768 tcontext=u:object_r:HelloService:s0 tclass=service_manager permissive=0</span><br></pre></td></tr></table></figure>
<p>跟上面的错误基本上是一样的，只不过是把 platform_app 换成了 untrusted_app 而已。platform_app 表示有系统签名的 apk， untrusted_app 表示没有系统签名的 apk。 我们按同样的思路添加完 selinux 的权限后，重新编译运行虚拟机，就可以正常调用服务的接口了。</p>
<h2 id="2-7-添加服务回调"><a href="#2-7-添加服务回调" class="headerlink" title="2.7 添加服务回调"></a>2.7 添加服务回调</h2><h3 id="2-7-1-使用-aidl-定义callback接口"><a href="#2-7-1-使用-aidl-定义callback接口" class="headerlink" title="2.7.1 使用 aidl 定义callback接口"></a>2.7.1 使用 aidl 定义callback接口</h3><p>在 frameworks/base/core/java/android/pure 目录下创建 ICallback.aidl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.pure;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICallback</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(in String message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 frameworks/base/Android.bp framework-defaults 模块中添加我们刚刚加的 aidl 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"core/java/android/pure/ICallback.aidl"</span>,</span><br></pre></td></tr></table></figure>
<p>然后进入 framework/base 目录执行 mm -j 命令编译 framework.jar 模块。 编译成功后，会在 out/soong/.intermediates/frameworks/base/framework/android_common/gen/aidl/frameworks/base/core/java/android/pure 目录生成 ICallback.java 这个文件。</p>
<h3 id="2-7-2-添加注册回调接口"><a href="#2-7-2-添加注册回调接口" class="headerlink" title="2.7.2 添加注册回调接口"></a>2.7.2 添加注册回调接口</h3><p>修改 IHelloService.aidl 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.pure;</span><br><span class="line"><span class="keyword">import</span> android.pure.ICallback;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IHelloService</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">hello</span><span class="params">(in String name)</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">registerCallback</span><span class="params">(in <span class="keyword">int</span> pid, in ICallback callback)</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">unregisterCallback</span><span class="params">(in <span class="keyword">int</span> pid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HelloService.java 修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.pure.IHelloService;</span><br><span class="line"><span class="keyword">import</span> android.pure.ICallback;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">IHelloService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> String TAG = <span class="string">"HelloService"</span>;</span><br><span class="line"> <span class="keyword">private</span> Map&lt;Integer, ICallback&gt; mClients;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">HelloService</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> Log.d(TAG, <span class="string">"create hello service"</span>);</span><br><span class="line"> mClients = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"> Log.d(TAG, <span class="string">"hello "</span> + name);</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="keyword">for</span> (ICallback callback : mClients.values()) &#123;</span><br><span class="line"> callback.onMessage(<span class="string">"message from service"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"> e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCallback</span><span class="params">(<span class="keyword">int</span> pid, ICallback callback)</span> </span>&#123;</span><br><span class="line"> mClients.put(pid, callback);</span><br><span class="line"> Log.d(TAG, <span class="string">"registerCallback client's size = "</span> + mClients.size());</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterCallback</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line"> mClients.remove(pid);</span><br><span class="line"> Log.d(TAG, <span class="string">"unregisterCallback client's size = "</span> + mClients.size());</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把 client 传递过来的 callback 保存到 mClients 集合中，当 client 调用 hello 接口时， 遍历 mclients 把消息传递给 client。</p>
<h3 id="2-7-3-client-注册回调接口"><a href="#2-7-3-client-注册回调接口" class="headerlink" title="2.7.3 client 注册回调接口"></a>2.7.3 client 注册回调接口</h3><p>修改 PureSettings apk 中的 MainActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pure.settings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.os.ServiceManager;</span><br><span class="line"><span class="keyword">import</span> android.pure.ICallback;</span><br><span class="line"><span class="keyword">import</span> android.pure.IHelloService;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PureSettings"</span>;</span><br><span class="line"> <span class="keyword">private</span> IHelloService service = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Button button;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> ICallback callback = <span class="keyword">new</span> ICallback.Stub() &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"> Log.d(TAG, <span class="string">"onMessage:"</span> + message);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> Log.d(TAG, <span class="string">"test"</span>);</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"> service.hello(<span class="string">"skytoby"</span>);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"> e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> setContentView(R.layout.activity_main);</span><br><span class="line"> service = IHelloService.Stub.asInterface(ServiceManager.getService(<span class="string">"HelloService"</span>));</span><br><span class="line"> button = (Button) findViewById(R.id.button);</span><br><span class="line"> button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"> test();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">super</span>.onResume();</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"> service.registerCallback(android.os.Process.myPid(), callback);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"> e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">super</span>.onStop();</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"> service.unregisterCallback(android.os.Process.myPid());</span><br><span class="line"> &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"> e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.7.4 编译验证</p>
<p>整编系统，运行虚拟机，打开 PureSettings 测试，查看 logcat</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pure:/ # logcat -s HelloService:D PureSettings:D</span><br><span class="line"><span class="number">02</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">57</span>:<span class="number">37.913</span> <span class="number">1769</span> <span class="number">1769</span> D HelloService: create hello service</span><br><span class="line"><span class="number">02</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">57</span>:<span class="number">53.498</span> <span class="number">1769</span> <span class="number">3058</span> D HelloService: registerCallback client<span class="string">'s size = 1</span></span><br><span class="line"><span class="string">02-02 22:57:56.587 3580 3580 D PureSettings: test</span></span><br><span class="line"><span class="string">02-02 22:57:56.587 1769 3058 D HelloService: hello skytoby</span></span><br><span class="line"><span class="string">02-02 22:57:56.588 3580 3580 D PureSettings: onMessage:message from service</span></span><br><span class="line"><span class="string">02-02 22:58:01.160 1769 3503 D HelloService: unregisterCallback client'</span>s size = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>从 log 上看，client 收到了 service 传递过来的消息。</p>
<h1 id="三、Native服务接口"><a href="#三、Native服务接口" class="headerlink" title="三、Native服务接口"></a>三、Native服务接口</h1><p>上一小节我们学习了 java 层的系统服务，但有时候出于性能方面的考虑，有些服务是需要使用 c++ 来实现的，比如音视频编解码，图形绘制等。 Android 系统原生的 MediaPlayerService 和 SurfaceFlinger 就是使用 c++ 实现的 Native 系统服务。这一小节我们就来学习一下如何添加一个 HelloNativeService。</p>
<h2 id="3-1-声明服务接口"><a href="#3-1-声明服务接口" class="headerlink" title="3.1 声明服务接口"></a>3.1 声明服务接口</h2><p>我们先在 $device 目录下创建 HelloNativeService 目录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd device/skytoby/pure</span><br><span class="line">mkdir -p models/HelloNativeService</span><br></pre></td></tr></table></figure>
<p>然后创建 service 的头文件 HelloNativeService.h</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#ifndef ANDROID_10_HELLONATIVESERVICE_H</span><br><span class="line">#define ANDROID_10_HELLONATIVESERVICE_H</span><br><span class="line"></span><br><span class="line">#include &lt;binder/IInterface.h&gt;</span><br><span class="line">#include &lt;binder/Parcel.h&gt;</span><br><span class="line">#include &lt;utils/Errors.h&gt;</span><br><span class="line">using namespace android;</span><br><span class="line">class HelloNativeService: public BBinder &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    HelloNativeService();</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">instantiate</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">virtual status_t <span class="title">onTransact</span><span class="params">(uint32_t, <span class="keyword">const</span> Parcel&amp;, Parcel*, uint32_t)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line">#endif //ANDROID_10_HELLONATIVESERVICE_H</span><br></pre></td></tr></table></figure>
<p>这里我们直接继承的是 BBinder， 而不是像其他教程一样又 BpInterface， 又 BnInterface 的，还把 BpInterface 跟 BnInterface 的实现放到同一个 cpp 文件中， 把 client 跟 server 的代码放到同一个文件中，个人感觉把简单的事情复杂化了。</p>
<h2 id="3-2-实现服务功能"><a href="#3-2-实现服务功能" class="headerlink" title="3.2. 实现服务功能"></a>3.2. 实现服务功能</h2><p>创建文件 HelloNativeService.cpp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;android/log.h&gt;</span><br><span class="line">#include &lt;binder/IServiceManager.h&gt;</span><br><span class="line">#include &lt;binder/IPCThreadState.h&gt;</span><br><span class="line">#include "HelloNativeService.h"</span><br><span class="line"></span><br><span class="line">#define LOG_TAG "HelloNativeService"</span><br><span class="line">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    CMD_SAY_HELLO = <span class="number">1</span>,</span><br><span class="line">    CMD_CAL_SUM = <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    LOGD(<span class="string">"hello %s from HelloNativeService"</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HelloNativeService::HelloNativeService() &#123;</span><br><span class="line">    LOGD(<span class="string">"HelloNativeService created"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> HelloNativeService::instantiate() &#123;</span><br><span class="line">    <span class="keyword">int</span> r = defaultServiceManager()-&gt;addService(String16(<span class="string">"HelloNativeService"</span>),<span class="keyword">new</span> HelloNativeService());</span><br><span class="line">    LOGD(<span class="string">"add HelloNativeService r = %d"</span>, r);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status_t HelloNativeService::onTransact(uint32_t code, <span class="keyword">const</span> Parcel &amp;request, Parcel *reply, uint32_t flag) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_SAY_HELLO:</span><br><span class="line">            sayHello(request.readCString());</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> CMD_CAL_SUM:</span><br><span class="line">            <span class="keyword">int</span> a = request.readInt32();</span><br><span class="line">            <span class="keyword">int</span> b = request.readInt32();</span><br><span class="line">            reply-&gt;writeInt32(sum(a, b));</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BBinder::onTransact(code, request, reply, flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中最重要的是 onTransact 函数的实现，这是一个回调函数，当 client 端通过 binder 调用 server 功能的时候， server 端的 onTransact 回调函数就会被调用。 各参数理解如下：</p>
<ul>
<li>code : 表示要执行的动作，类似Handler发送的Message的what。code指示了当前远程操作的命令，IBinder定义了像INTERFACE_TRANSACTION、PING_TRANSACTION 这样的几个通用命令。自己使用的命令的标识值需要在FIRST_CALL_TRANSACTION和LAST_CALL_TRANSACTION之间。</li>
<li>request， reply ： request 和 reply 参数相当于普通函数里的调用参数和返回值。Parcel类型是可以跨进程的数据。</li>
<li>flag ： 参数 flags 只有 0 和 FLAG_ONEWAY 两种。0 表示阻塞调用， FLAG_ONEWAY 表示异步调用。这个参数不需要我们在服务端处理， Binder 框架会自动处理。</li>
</ul>
<h2 id="3-3-添加-main-cpp"><a href="#3-3-添加-main-cpp" class="headerlink" title="3.3. 添加 main.cpp"></a>3.3. 添加 main.cpp</h2><p>前面我们定义了服务接口而已，这个服务也是需要依赖在某个进程才能运行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;binder/IServiceManager.h&gt;</span><br><span class="line">#include &lt;binder/IPCThreadState.h&gt;</span><br><span class="line">#include "HelloNativeService.h"</span><br><span class="line"></span><br><span class="line">using namespace android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">sp&lt;ProcessState&gt; <span class="title">proc</span><span class="params">(ProcessState::self()</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    HelloNativeService::instantiate();</span><br><span class="line"></span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上都是样板代码，具体 ProcessState 的功能作用是什么这里就不展开了。</p>
<h2 id="3-4-Android-bp"><a href="#3-4-Android-bp" class="headerlink" title="3.4  Android.bp"></a>3.4  Android.bp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">"HelloNativeService"</span>,</span><br><span class="line">    srcs: [<span class="string">"main.cpp"</span>, <span class="string">"HelloNativeService.cpp"</span>],</span><br><span class="line"></span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">"liblog"</span>,</span><br><span class="line">        <span class="string">"libcutils"</span>,</span><br><span class="line">        <span class="string">"libutils"</span>,</span><br><span class="line">        <span class="string">"libbinder"</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-5-selinux-规则设置"><a href="#3-5-selinux-规则设置" class="headerlink" title="3.5 selinux 规则设置"></a>3.5 selinux 规则设置</h2><p>为了简单起见，我们直接修改系统默认的 sepolicy 规则路径了。</p>
<h3 id="3-5-1-添加-HelloNativeService-te"><a href="#3-5-1-添加-HelloNativeService-te" class="headerlink" title="3.5.1 添加 HelloNativeService.te"></a>3.5.1 添加 HelloNativeService.te</h3><p>system/sepolicy/private/HelloNativeService.te 和 system/sepolicy/prebuilts/api/29.0/private/HelloNativeService.te 文件内容保持一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type HelloNativeService, domain;</span><br><span class="line">typeattribute HelloNativeService coredomain;</span><br><span class="line">type HelloNativeService_exec, system_file_type, exec_type, file_type;</span><br><span class="line">binder_use(HelloNativeService)</span><br><span class="line">init_daemon_domain(HelloNativeService)</span><br><span class="line"></span><br><span class="line">allow HelloNativeService HelloNativeService_service:service_manager &#123; add find &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-2-修改-file-contexts"><a href="#3-5-2-修改-file-contexts" class="headerlink" title="3.5.2 修改 file_contexts"></a>3.5.2 修改 file_contexts</h3><p>system/sepolicy/private/file_contexts 和 system/sepolicy/prebuilts/api/29.0/private/file_contexts 文件内容保持一致，添加以下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/system/bin/HelloNativeService u:object_r:HelloNativeService_exec:s0</span><br></pre></td></tr></table></figure>
<h3 id="3-5-3-修改-service-contexts"><a href="#3-5-3-修改-service-contexts" class="headerlink" title="3.5.3 修改 service_contexts"></a>3.5.3 修改 service_contexts</h3><p>system/sepolicy/private/service_contexts 和 system/sepolicy/prebuilts/api/29.0/private/service_contexts 文件内容保持一致，添加以下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HelloNativeService u:object_r:HelloNativeService_service:s0</span><br></pre></td></tr></table></figure>
<h3 id="5-4-修改-service-te"><a href="#5-4-修改-service-te" class="headerlink" title="5.4 修改 service.te"></a>5.4 修改 service.te</h3><p>system/sepolicy/private/service.te 和 system/sepolicy/prebuilts/api/29.0/private/service.te，添加以下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type HelloNativeService_service,    service_manager_type;</span><br></pre></td></tr></table></figure>
<h2 id="3-6-开机自动运行"><a href="#3-6-开机自动运行" class="headerlink" title="3.6 开机自动运行"></a>3.6 开机自动运行</h2><p>在 device/skytoby/pure 目录添加rc文件 init.ranchu.rc</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service HelloNativeService /system/bin/HelloNativeService</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">core</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">root</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">root</span></span></span><br><span class="line">    seclabel u:r:HelloNativeService:s0</span><br></pre></td></tr></table></figure>
<p>在 pure.mk 中添加以下配置， <strong>这个配置需要添加在 $(call inherit-product, $(SRC_TARGET_DIR)/product/aosp_x86_64.mk) 之前。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_COPY_FILES += device/skytoby/pure/init.ranchu.rc:root/init.ranchu.rc</span><br></pre></td></tr></table></figure>
<h2 id="3-7-编写-client-调用服务"><a href="#3-7-编写-client-调用服务" class="headerlink" title="3.7 编写 client 调用服务"></a>3.7 编写 client 调用服务</h2><p>我们把测试代码跟 service 放在同一个目录，直接在 HelloNativeService 目录下创建 HelloNativeTest.cpp 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;binder/IServiceManager.h&gt;</span><br><span class="line">#include &lt;binder/Parcel.h&gt;</span><br><span class="line">#include &lt;utils/Errors.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">using namespace android;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    CMD_SAY_HELLO = <span class="number">1</span>,</span><br><span class="line">    CMD_CAL_SUM = <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> sp&lt;IBinder&gt; service;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Parcel request, reply;</span><br><span class="line">    request.writeCString(<span class="string">"skytoby"</span>);</span><br><span class="line">    service-&gt;transact(CMD_SAY_HELLO, request, &amp;reply);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_calSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Parcel request, reply;</span><br><span class="line">    request.writeInt32(<span class="number">2</span>);</span><br><span class="line">    request.writeInt32(<span class="number">3</span>);</span><br><span class="line">    service-&gt;transact(CMD_CAL_SUM, request, &amp;reply);</span><br><span class="line">    <span class="keyword">int</span> sum = reply.readInt32();</span><br><span class="line">    printf(<span class="string">"sum of 2 + 3 = %d\n"</span>, sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    service = defaultServiceManager()-&gt;getService(String16(<span class="string">"HelloNativeService"</span>));</span><br><span class="line">    test_sayHello();</span><br><span class="line">    test_calSum();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Android.bp 中添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">"HelloNativeTest"</span>,</span><br><span class="line">    srcs: [<span class="string">"HelloNativeTest.cpp"</span>],</span><br><span class="line"></span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">"liblog"</span>,</span><br><span class="line">        <span class="string">"libcutils"</span>,</span><br><span class="line">        <span class="string">"libutils"</span>,</span><br><span class="line">        <span class="string">"libbinder"</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-8-编译运行"><a href="#3-8-编译运行" class="headerlink" title="3.8 编译运行"></a>3.8 编译运行</h2><p>经过以上步骤，我们的 native 服务和测试 demo 就完成了，目录结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models$ tree HelloNativeService/</span><br><span class="line">HelloNativeService/</span><br><span class="line">├── Android.bp</span><br><span class="line">├── HelloNativeService.cpp</span><br><span class="line">├── HelloNativeService.h</span><br><span class="line">├── HelloNativeTest.cpp</span><br><span class="line">└── main.cpp</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> directories, <span class="number">5</span> files</span><br></pre></td></tr></table></figure>
<p>我们还需要把刚刚添加的这两个模块添加到 PRODUCT_PACKAGES</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += HelloNativeService HelloNativeTest</span><br></pre></td></tr></table></figure>
<p>然后编译运行，查看服务列表，可以看到我们的 HelloNativeService 已经在运行状态了。 然后执行 HelloNativeTest，服务端正确返回了计算结果。 查看一下 logcat， HelloNativeService 也正确收到了 HelloNativeTest 传递过来的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>$ adb shell</span><br><span class="line">pure:/ # service list | grep -i hello                                          </span><br><span class="line"><span class="number">15</span>      HelloService: [android.pure.IHelloService]</span><br><span class="line"><span class="number">161</span>     HelloNativeService: []</span><br><span class="line">pure:/ # </span><br><span class="line">pure:/ # HelloNativeTest</span><br><span class="line">sum of <span class="number">2</span> + <span class="number">3</span> = <span class="number">5</span></span><br><span class="line">pure:/ # </span><br><span class="line">pure:/ # logcat -s HelloNativeService</span><br><span class="line">--------- beginning of main</span><br><span class="line">--------- beginning of system</span><br><span class="line"><span class="number">01</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">19.788</span>  <span class="number">1661</span>  <span class="number">1661</span> D HelloNativeService: HelloNativeService created</span><br><span class="line"><span class="number">01</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">03</span>:<span class="number">19.788</span>  <span class="number">1661</span>  <span class="number">1661</span> D HelloNativeService: add HelloNativeService r = <span class="number">0</span>/n</span><br><span class="line"><span class="number">01</span>-<span class="number">05</span> <span class="number">00</span>:<span class="number">05</span>:<span class="number">50.011</span>  <span class="number">1661</span>  <span class="number">1670</span> D HelloNativeService: hello skytoby from HelloNativeService</span><br></pre></td></tr></table></figure>
<h2 id="3-9-添加native服务回调"><a href="#3-9-添加native服务回调" class="headerlink" title="3.9 添加native服务回调"></a>3.9 添加native服务回调</h2><h3 id="3-9-1-client-端更改"><a href="#3-9-1-client-端更改" class="headerlink" title="3.9.1 client 端更改"></a>3.9.1 client 端更改</h3><p>为了简单省事，我们直接在上一小节的 demo 基础上作修改， HelloNatvieTest.cpp 修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;binder/IServiceManager.h&gt;</span><br><span class="line">#include &lt;binder/Parcel.h&gt;</span><br><span class="line">#include &lt;utils/Errors.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">using namespace android;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    CMD_SAY_HELLO = <span class="number">1</span>,</span><br><span class="line">    CMD_CAL_SUM = <span class="number">2</span>,</span><br><span class="line">    CMD_CONNECT = <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class Callback :public BBinder &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        CALLBACK_SAY_HELLO = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">status_t <span class="title">onTransact</span><span class="params">(uint32_t code, <span class="keyword">const</span> Parcel &amp;request, Parcel *reply, uint32_t flag)</span> </span>&#123;</span><br><span class="line">        printf(<span class="string">"Callback onTransact\n"</span>);</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">            <span class="keyword">case</span> CALLBACK_SAY_HELLO:</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">char</span>* str = request.readCString();</span><br><span class="line">                printf(<span class="string">"msg from server:%s\n"</span>, str);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BBinder::onTransact(code, request, reply, flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> sp&lt;IBinder&gt; service;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Parcel request, reply;</span><br><span class="line">    request.writeCString(<span class="string">"skytoby"</span>);</span><br><span class="line">    service-&gt;transact(CMD_SAY_HELLO, request, &amp;reply);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_calSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Parcel request, reply;</span><br><span class="line">    request.writeInt32(<span class="number">2</span>);</span><br><span class="line">    request.writeInt32(<span class="number">3</span>);</span><br><span class="line">    service-&gt;transact(CMD_CAL_SUM, request, &amp;reply);</span><br><span class="line">    <span class="keyword">int</span> sum = reply.readInt32();</span><br><span class="line">    printf(<span class="string">"sum of 2 + 3 = %d\n"</span>, sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_connect</span><span class="params">(sp&lt;Callback&gt; callback)</span> </span>&#123;</span><br><span class="line">    Parcel request, reply;</span><br><span class="line">    request.writeStrongBinder(callback);</span><br><span class="line">    service-&gt;transact(CMD_CONNECT, request, &amp;reply);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    service = defaultServiceManager()-&gt;getService(String16(<span class="string">"HelloNativeService"</span>));</span><br><span class="line">    sp&lt;Callback&gt; callback = <span class="keyword">new</span> Callback();</span><br><span class="line">    test_connect(callback);</span><br><span class="line">    test_sayHello();</span><br><span class="line">    test_calSum();</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加了一个 Callback 类，并且增加了一个 CMD_CONNECT 命令。 main 函数中创建了一个 Callback 对象，然后通过 writeStrongBinder 把这个对象传给 server。</p>
<h3 id="3-9-2-server-端更改"><a href="#3-9-2-server-端更改" class="headerlink" title="3.9.2 server 端更改"></a>3.9.2 server 端更改</h3><p>HelloNativeService.h ,增加client变量修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; client;</span><br></pre></td></tr></table></figure>
<p>HelloNativeService.cpp 修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;android/log.h&gt;</span><br><span class="line">#include &lt;binder/IServiceManager.h&gt;</span><br><span class="line">#include &lt;binder/IPCThreadState.h&gt;</span><br><span class="line">#include "HelloNativeService.h"</span><br><span class="line"></span><br><span class="line">#define LOG_TAG "HelloNativeService"</span><br><span class="line">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    CMD_SAY_HELLO = <span class="number">1</span>,</span><br><span class="line">    CMD_CAL_SUM = <span class="number">2</span>,</span><br><span class="line">    CMD_CONNECT = <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    CALLBACK_SAY_HELLO = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    LOGD(<span class="string">"hello %s from HelloNativeService"</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">echo</span><span class="params">(sp&lt;IBinder&gt; client, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    Parcel request, reply;</span><br><span class="line">    <span class="keyword">char</span> buff[<span class="number">1024</span>];</span><br><span class="line">    memset(buff, <span class="number">0</span>, sizeof(buff));</span><br><span class="line">    sprintf(buff, <span class="string">"hello %s from HelloNativeService"</span>, name);</span><br><span class="line">    request.writeCString(buff);</span><br><span class="line">    client-&gt;transact(CALLBACK_SAY_HELLO, request, &amp;reply);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HelloNativeService::HelloNativeService() &#123;</span><br><span class="line">    LOGD(<span class="string">"HelloNativeService created"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> HelloNativeService::instantiate() &#123;</span><br><span class="line">    <span class="keyword">int</span> r = defaultServiceManager()-&gt;addService(String16(<span class="string">"HelloNativeService"</span>),</span><br><span class="line">                                                <span class="keyword">new</span> HelloNativeService());</span><br><span class="line">    LOGD(<span class="string">"add HelloNativeService r = %d"</span>, r);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status_t</span><br><span class="line">HelloNativeService::onTransact(uint32_t code, <span class="keyword">const</span> Parcel &amp;request, Parcel *reply, uint32_t flag) &#123;</span><br><span class="line">    LOGD(<span class="string">"service onTransact code = %d"</span>, code);</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_SAY_HELLO: &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *name = request.readCString();</span><br><span class="line">            sayHello(name);</span><br><span class="line">            echo(client, name);</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> CMD_CAL_SUM: &#123;</span><br><span class="line">            <span class="keyword">int</span> a = request.readInt32();</span><br><span class="line">            <span class="keyword">int</span> b = request.readInt32();</span><br><span class="line">            reply-&gt;writeInt32(sum(a, b));</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> CMD_CONNECT: &#123;</span><br><span class="line">            client = request.readStrongBinder();</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BBinder::onTransact(code, request, reply, flag);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加了一个 CMD_CONNECT 命令，通过 readStrongBinder 把 client 传送过来的 callback 对象给读取保存下来。后面需要回调客户端的时候只需要通过 client 这个 binder 就可以。 client binder 与 server binder 的一个差异是 client binder 对象不需要添加到系统服务里面去，而是通过 writeStrongBinder 直接传送给 server。</p>
<h3 id="3-9-3-编译验证"><a href="#3-9-3-编译验证" class="headerlink" title="3.9.3 编译验证"></a>3.9.3 编译验证</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pure:/ # HelloNativeTest                      </span><br><span class="line">Callback onTransact</span><br><span class="line">msg from server:hello skytoby from HelloNativeService</span><br><span class="line">sum of <span class="number">2</span> + <span class="number">3</span> = <span class="number">5</span></span><br><span class="line">pure:/ # logcat -s HelloNativeService</span><br><span class="line">--------- beginning of system</span><br><span class="line">--------- beginning of main</span><br><span class="line"><span class="number">01</span>-<span class="number">12</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">34.250</span>  <span class="number">1645</span>  <span class="number">1660</span> D HelloNativeService: service onTransact code = <span class="number">3</span></span><br><span class="line"><span class="number">01</span>-<span class="number">12</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">34.252</span>  <span class="number">1645</span>  <span class="number">1660</span> D HelloNativeService: service onTransact code = <span class="number">1</span></span><br><span class="line"><span class="number">01</span>-<span class="number">12</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">34.252</span>  <span class="number">1645</span>  <span class="number">1660</span> D HelloNativeService: hello skytoby from HelloNativeService</span><br><span class="line"><span class="number">01</span>-<span class="number">12</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">34.252</span>  <span class="number">1645</span>  <span class="number">1660</span> D HelloNativeService: service onTransact code = <span class="number">2</span></span><br><span class="line">130|pure:/ #</span><br></pre></td></tr></table></figure>
<h1 id="四、HIDL服务接口"><a href="#四、HIDL服务接口" class="headerlink" title="四、HIDL服务接口"></a>四、HIDL服务接口</h1><p>Android 8.0 之后，google　为了解决 Android 版本碎片化问题, 推出了 treble 架构，参考 <a href="https://blog.csdn.net/xiaosayidao/article/details/75577940" target="_blank" rel="noopener">Android Treble架构解析</a>。核心思想就是 vendor 分区和 system 分区的隔离。把厂商的更改限制在 vendor 分区，system 分区由 google 把控。system 分区需要访问 vendor 分区的话，需要通过 hidl 的形式来访问。 网上有很多介绍 hidl 的文章，但没有一篇是介绍得比较全面的，都会遗漏一些小细节，由于这样，那样的小细节，自己到处找资料，折腾了两天才把 hidl 的demo 跑起来。以下作详细的记录，手把手教你从零创建自己的 hidl 服务。关于什么是 hidl ，及为什么要用 hidl 的理论知识这里就不作介绍了，可以参考官网的介绍 : <a href="https://source.android.google.cn/devices/architecture/hidl?hl=zh-cn" target="_blank" rel="noopener">hidl概览</a></p>
<h2 id="4-1-添加-hal-目录"><a href="#4-1-添加-hal-目录" class="headerlink" title="4.1 添加 hal 目录"></a>4.1 添加 hal 目录</h2><p>网上的 demo 全部都是直接在 android/hardware/interfaces 目录下添加了， 但我觉得最好是在自己的 device 目录下添加比较好维护一点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p device/skytoby/pure/models/hidl/tvserver/<span class="number">1.0</span></span><br></pre></td></tr></table></figure>
<h2 id="4-2-定义-hal-接口"><a href="#4-2-定义-hal-接口" class="headerlink" title="4.2 定义 hal 接口"></a>4.2 定义 hal 接口</h2><p>在 device/skytoby/pure/models/hidl/tvserver/1.0 目录下创建文件 ITVServer.hal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> device.skytoby.pure.tvserver@<span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ITVServer</span> </span>&#123;</span><br><span class="line">    hello(string name) generates (string result);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-根据-hal-自动生成-cpp-实现"><a href="#4-3-根据-hal-自动生成-cpp-实现" class="headerlink" title="4.3 根据 .hal 自动生成 cpp 实现"></a>4.3 根据 .hal 自动生成 cpp 实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>$ PACKAGE=device.skytoby.pure.tvserver@<span class="number">1.0</span></span><br><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>$ LOC=device/skytoby/pure/models/hidl/tvserver/<span class="number">1.0</span>/<span class="keyword">default</span></span><br><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>$ hidl-gen -o $LOC -Lc++-impl -rdevice.skytoby.pure:device/skytoby/pure/models/hidl $PACKAGE</span><br></pre></td></tr></table></figure>
<p>执行完以上命令之后在 default 目录下生成了 TVServer.h 和 TVServer.cpp 这两个文件 我们需要对 TVServer.cpp 实现进行完善，只需要对我们定义的 hello 接口进行实现就行了，修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Return&lt;<span class="keyword">void</span>&gt; TVServer::hello(<span class="keyword">const</span> hidl_string&amp; name, hello_cb _hidl_cb) &#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    ::memset(buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    ::snprintf(buf, <span class="number">100</span>, <span class="string">"hello %s from TVServer"</span>, name.c_str());</span><br><span class="line">    <span class="function">hidl_string <span class="title">result</span><span class="params">(buf)</span></span>;</span><br><span class="line">    _hidl_cb(result);</span><br><span class="line">    <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们还需要一个进程来容纳我们的服务，创建一个 main.cpp 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;hidl/HidlTransportSupport.h&gt;</span><br><span class="line">#include &lt;utils/Looper.h&gt;</span><br><span class="line">#include &lt;utils/StrongPointer.h&gt;</span><br><span class="line">#include "TVServer.h"</span><br><span class="line">using android::hardware::configureRpcThreadpool;</span><br><span class="line">using android::hardware::joinRpcThreadpool;</span><br><span class="line">using device::skytoby::pure::tvserver::V1_0::ITVServer;</span><br><span class="line">using device::skytoby::pure::tvserver::V1_0::implementation::TVServer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// sleep for a second, wait /data/vendor to be mounted</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    configureRpcThreadpool(<span class="number">4</span>, <span class="keyword">true</span> <span class="comment">/* callerWillJoin */</span>);</span><br><span class="line"></span><br><span class="line">    android::sp&lt;ITVServer&gt; service = <span class="keyword">new</span> TVServer();</span><br><span class="line">    android::status_t ret = service-&gt;registerAsService();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret != android::NO_ERROR) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    joinRpcThreadpool();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-开机自动启动服务"><a href="#4-4-开机自动启动服务" class="headerlink" title="4.4 开机自动启动服务"></a>4.4 开机自动启动服务</h2><p>在 tvserver/1.0/default 目录下创建 <a href="mailto:device.qiushao.pure.tvserver@1.0-service.rc" target="_blank" rel="noopener">device.skytoby.pure.tvserver@1.0-service.rc</a> 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service tvserver /vendor/bin/hw/device.skytoby.pure.tvserver@<span class="number">1.0</span>-service</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">hal</span></span></span><br><span class="line"><span class="class">        <span class="title">user</span> <span class="title">root</span></span></span><br><span class="line"><span class="class">        <span class="title">group</span> <span class="title">root</span></span></span><br></pre></td></tr></table></figure>
<h2 id="4-5-生成-Android-bp"><a href="#4-5-生成-Android-bp" class="headerlink" title="4.5 生成 Android.bp"></a>4.5 生成 Android.bp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hidl-gen -o $LOC -Landroidbp-impl -rdevice.skytoby.pure:device/skytoby/pure/models/hidl $PACKAGE</span><br></pre></td></tr></table></figure>
<p>在 Android 9.0 之后，查看自动生成的 Android.bp 文件，里面有些提示，说明自动生成的文件还需要稍作修改，我们修改如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">"device.skytoby.pure.tvserver@1.0-service"</span>,</span><br><span class="line">    init_rc: [<span class="string">"device.skytoby.pure.tvserver@1.0-service.rc"</span>],</span><br><span class="line">    relative_install_path: <span class="string">"hw"</span>,</span><br><span class="line">    vendor: <span class="keyword">true</span>,</span><br><span class="line">    srcs: [</span><br><span class="line">        <span class="string">"TVServer.cpp"</span>,</span><br><span class="line">        <span class="string">"main.cpp"</span>,</span><br><span class="line">    ],</span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">"libhidlbase"</span>,</span><br><span class="line">        <span class="string">"libhidltransport"</span>,</span><br><span class="line">        <span class="string">"libutils"</span>,</span><br><span class="line">        <span class="string">"device.skytoby.pure.tvserver@1.0"</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <a href="mailto:device.qiushao.pure.tvserver@1.0-service.rc" target="_blank" rel="noopener">device.skytoby.pure.tvserver@1.0-service.rc</a> 文件会被安装到 /vendor/etc/init/ 目录。系统启动时会自动加载这个目录下的所有 rc 文件。</p>
<p>此时目录结构是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models/hidl$ tree tvserver/</span><br><span class="line">tvserver/</span><br><span class="line">└── <span class="number">1.0</span></span><br><span class="line">    ├── <span class="keyword">default</span></span><br><span class="line">    │   ├── Android.bp</span><br><span class="line">    │   ├── main.cpp</span><br><span class="line">    │   ├── TVServer.cpp</span><br><span class="line">    │   └── TVServer.h</span><br><span class="line">    │   └── device.skytoby.pure.tvserver@<span class="number">1.0</span>-service.rc</span><br><span class="line">    └── ITVServer.hal</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> directories, <span class="number">6</span> files</span><br><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models/hidl$</span><br></pre></td></tr></table></figure>
<h2 id="4-6-自动生成-hal-接口的-Android-bp"><a href="#4-6-自动生成-hal-接口的-Android-bp" class="headerlink" title="4.6 自动生成 hal 接口的 Android.bp"></a>4.6 自动生成 hal 接口的 Android.bp</h2><p>这里需要用到 update-makefiles.sh 这个脚本，我们可以从 $(TOP)/hardware/interfaces 里面 copy 一份过来放到 device/skytoby/pure/models/hidl 目录，稍作修改即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Script to update Android make-files for HAL and VTS modules.</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"$ANDROID_BUILD_TOP"</span> ]; then</span><br><span class="line">    echo <span class="string">"Missing ANDROID_BUILD_TOP env variable. Run 'lunch' first."</span></span><br><span class="line">    exit <span class="number">1</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">source $ANDROID_BUILD_TOP/system/tools/hidl/update-makefiles-helper.sh</span><br><span class="line"></span><br><span class="line">do_makefiles_update \</span><br><span class="line">  <span class="string">"device.skytoby.pure:device/skytoby/pure/models/hidl"</span></span><br></pre></td></tr></table></figure>
<p>然后在 Android 根目录执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./device/skytoby/pure/models/hidl/update-makefiles.sh</span><br></pre></td></tr></table></figure>
<p>这个命令生成了 device/skytoby/pure/models/hidl/tvserver/1.0/Android.bp 这个文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This file is autogenerated by hidl-gen -Landroidbp.</span></span><br><span class="line"></span><br><span class="line">hidl_interface &#123;</span><br><span class="line">    name: <span class="string">"device.skytoby.pure.tvserver@1.0"</span>,</span><br><span class="line">    root: <span class="string">"device.skytoby.pure"</span>,</span><br><span class="line">    product_specific: <span class="keyword">true</span>,</span><br><span class="line">    srcs: [</span><br><span class="line">        <span class="string">"ITVServer.hal"</span>,</span><br><span class="line">    ],</span><br><span class="line">    interfaces: [</span><br><span class="line">        <span class="string">"android.hidl.base@1.0"</span>,</span><br><span class="line">    ],</span><br><span class="line">    gen_java: <span class="keyword">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要在这个文件最前面添加以下配置才行，不然会编译不过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hidl_package_root &#123;</span><br><span class="line">    name: <span class="string">"device.skytoby.pure"</span>,</span><br><span class="line">    path: <span class="string">"device/skytoby/pure/models/hidl"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前目录结构是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models/hidl$ tree </span><br><span class="line">.</span><br><span class="line">├── tvserver</span><br><span class="line">│   └── <span class="number">1.0</span></span><br><span class="line">│       ├── Android.bp</span><br><span class="line">│       ├── <span class="keyword">default</span></span><br><span class="line">│       │   ├── Android.bp</span><br><span class="line">│       │   ├── main.cpp</span><br><span class="line">│       │   ├── TVServer.cpp</span><br><span class="line">│       │   └── TVServer.h</span><br><span class="line">│       │   └── device.skytoby.pure.tvserver@<span class="number">1.0</span>-service.rc</span><br><span class="line">│       └── ITVServer.hal</span><br><span class="line">└── update-makefiles.sh</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> directories, <span class="number">9</span> files</span><br><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models/hidl$</span><br></pre></td></tr></table></figure>
<h2 id="4-7-更新-current-txt"><a href="#4-7-更新-current-txt" class="headerlink" title="4.7 更新 current.txt"></a>4.7 更新 current.txt</h2><p>current.txt 记录了所有 hal 接口的 hash 值，接口有变化时，同时需要更新 current.txt 中的 hash 值 在 interfaces 目录下新建 current.txt 文件，随便写个 hash 值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">123456</span> device.skytoby.pure.tvserver@<span class="number">1.0</span>::ITVServer</span><br></pre></td></tr></table></figure>
<p>再执行一遍 update-makefiles.sh，这个时候就会发现提示 hash 值不正确了，同时会给出正确的 hash 值，我们把正确的 hash 值替换到 current.txt 即可。</p>
<h2 id="4-8-模块编译"><a href="#4-8-模块编译" class="headerlink" title="4.8 模块编译"></a>4.8 模块编译</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmm device/skytoby/pure/models/hidl/tvserver/<span class="number">1.0</span></span><br></pre></td></tr></table></figure>
<p>编译完成后，可以发现 $(TARGET_OUT)/vendor/bin/hw 目录下生成了我们的服务 <a href="mailto:device.skytoby.pure.tvserver@1.0-service" target="_blank" rel="noopener">device.skytoby.pure.tvserver@1.0-service</a></p>
<h2 id="4-9-更新-manifest-xml"><a href="#4-9-更新-manifest-xml" class="headerlink" title="4.9 更新 manifest.xml"></a>4.9 更新 manifest.xml</h2><p>复制 device/generic/goldfish/manifest.xml 到 device/skytoby/pure/manifest.xml manifest.xml 中加上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;hal format=<span class="string">"hidl"</span>&gt;</span><br><span class="line">    &lt;name&gt;device.skytoby.pure.tvserver&lt;/name&gt;</span><br><span class="line">    &lt;transport&gt;hwbinder&lt;/transport&gt;</span><br><span class="line">    &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">    &lt;<span class="class"><span class="keyword">interface</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">name</span>&gt;<span class="title">ITVServer</span>&lt;/<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">instance</span>&gt;<span class="title">default</span>&lt;/<span class="title">instance</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">interface</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">hal</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>pure/product_copy_files.mk　中加上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_COPY_FILES += \</span><br><span class="line">    device/skytoby/pure/manifest.xml:vendor/manifest.xml</span><br></pre></td></tr></table></figure>
<h2 id="4-10-添加到-PRODUCT-PACKAGES"><a href="#4-10-添加到-PRODUCT-PACKAGES" class="headerlink" title="4.10 添加到 PRODUCT_PACKAGES"></a>4.10 添加到 PRODUCT_PACKAGES</h2><p>修改 device.mk 增加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += \</span><br><span class="line"> device.skytoby.pure.tvserver@<span class="number">1.0</span>-service</span><br></pre></td></tr></table></figure>
<h2 id="4-11-添加-selinux-规则"><a href="#4-11-添加-selinux-规则" class="headerlink" title="4.11 添加 selinux 规则"></a>4.11 添加 selinux 规则</h2><p>系统原生的 selinux 规则在 system/sepolicy 目录下， 我们可以直接修改里面的规则，但不推荐这么做，最好是在 device　目录下添加厂商自己的规则。 在 BoardConfig.mk 里面添加:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BOARD_SEPOLICY_DIRS += device/skytoby/pure/sepolicy</span><br></pre></td></tr></table></figure>
<p>然后我们就可以在 pure/sepolicy 目录下添加我们的 selinux 规则了。</p>
<p>新增 tvserver.te</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type tvserver, domain;</span><br><span class="line"></span><br><span class="line">type tvserver_exec, exec_type, vendor_file_type, file_type;</span><br><span class="line">hwbinder_use(tvserver);</span><br><span class="line">init_daemon_domain(tvserver)</span><br><span class="line">add_hwservice(tvserver, tvserver_hwservice)</span><br><span class="line"></span><br><span class="line">allow tvserver hwservicemanager_prop:file &#123;map read open getattr&#125;;</span><br><span class="line">allow tvserver system_file:dir &#123;read open getattr search&#125;;</span><br></pre></td></tr></table></figure>
<p>新增 file_contexts</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/vendor/bin/hw/device.skytoby.pure.tvserver@<span class="number">1.0</span>-service u:object_r:tvserver_exec:s0</span><br></pre></td></tr></table></figure>
<p>新增 hwservice.te</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type tvserver_hwservice, hwservice_manager_type;</span><br></pre></td></tr></table></figure>
<p>新增 hwservice_contexts</p>
<p>然后去编译整个系统， 运行，嘿，我们的服务跑起来了：</p>
<h2 id="4-12-编写-client-调用服务"><a href="#4-12-编写-client-调用服务" class="headerlink" title="4.12 编写 client 调用服务"></a>4.12 编写 client 调用服务</h2><p>在 1.0 目录下增加 test 目录，新建 TVServerTest.cpp 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;device/skytoby/pure/tvserver/1.0/ITVServer.h&gt;</span><br><span class="line">#include &lt;hidl/Status.h&gt;</span><br><span class="line">#include &lt;utils/misc.h&gt;</span><br><span class="line">#include &lt;hidl/HidlSupport.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">using ::android::hardware::hidl_string;</span><br><span class="line">using ::android::sp;</span><br><span class="line">using device::skytoby::pure::tvserver::V1_0::ITVServer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"> android::sp&lt;ITVServer&gt; service = ITVServer::getService();</span><br><span class="line"> <span class="keyword">if</span> (service == nullptr)&#123;</span><br><span class="line"> printf(<span class="string">"Failed to get service\n"</span>);</span><br><span class="line"> <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> service-&gt;hello(<span class="string">"skytoby"</span>, [&amp;](hidl_string result)&#123;</span><br><span class="line"> printf(<span class="string">"%s\n"</span>, result.c_str());</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建 Android.bp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line"> name: <span class="string">"TVServerTest"</span>,</span><br><span class="line"> vendor: <span class="keyword">true</span>,</span><br><span class="line"> srcs: [<span class="string">"TVServerTest.cpp"</span>],</span><br><span class="line"></span><br><span class="line"> shared_libs: [</span><br><span class="line"> <span class="string">"liblog"</span>,</span><br><span class="line"> <span class="string">"libhardware"</span>,</span><br><span class="line"> <span class="string">"libhidlbase"</span>,</span><br><span class="line"> <span class="string">"libhidltransport"</span>,</span><br><span class="line"> <span class="string">"libutils"</span>,</span><br><span class="line"> <span class="string">"device.skytoby.pure.tvserver@1.0"</span>,</span><br><span class="line"> ],</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 device.mk 中加上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += \</span><br><span class="line">    TVServerTest</span><br></pre></td></tr></table></figure>
<p>然后整编译系统，运行:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pure:/ # TVServerTest                              </span><br><span class="line">hello skytoby from TVServer</span><br><span class="line">pure:/ #</span><br></pre></td></tr></table></figure>
<p>成功调用了 hidl 服务。</p>
<p>最终代码目录结构是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models/hidl$ tree</span><br><span class="line">.</span><br><span class="line">├── current.txt</span><br><span class="line">├── tvserver</span><br><span class="line">│   └── <span class="number">1.0</span></span><br><span class="line">│       ├── Android.bp</span><br><span class="line">│       ├── <span class="keyword">default</span></span><br><span class="line">│       │   ├── Android.bp</span><br><span class="line">│       │   ├── device.skytoby.pure.tvserver@<span class="number">1.0</span>-service.rc</span><br><span class="line">│       │   ├── main.cpp</span><br><span class="line">│       │   ├── TVServer.cpp</span><br><span class="line">│       │   └── TVServer.h</span><br><span class="line">│       ├── ITVServer.hal</span><br><span class="line">│       └── test</span><br><span class="line">│           ├── Android.bp</span><br><span class="line">│           └── TVServerTest.cpp</span><br><span class="line">└── update-makefiles.sh</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> directories, <span class="number">11</span> files</span><br><span class="line">skytoby<span class="meta">@skytoby</span>-pc:~/source/android-<span class="number">10</span>/device/skytoby/pure/models/hidl$</span><br></pre></td></tr></table></figure>
<p>经过了这么多的步骤终于完成了一个 hidl 的 hello world。 以后我们只要在这个框架上慢慢添加功能就行了。</p>
<p>网上大部分文章会忽略掉 current.txt, manifest.xml, selinux 及在 device/product 目录下添加模块的这些问题，导致自己跟着那些文章实现的时候，总是遇到各种问题，希望这篇记录能够帮助到想创建 hidl 服务的同学。</p>
<h2 id="4-13-增加hidl服务回调"><a href="#4-13-增加hidl服务回调" class="headerlink" title="4.13 增加hidl服务回调"></a>4.13 增加hidl服务回调</h2><p>上一小节我们已经完整的跑起来了一个 hidl 的　hello demo，这个 demo　虽然非常简单，但已经包含了 hidl 的大部分知识点了，我们只要在这个框架的基础上不断的扩展功能即可。 上一小节的demo　调用是单向的，即只能由 client 调用 service　的功能，但实际项目中我们是经常需要在 service 里面通知 client　某个事件发生了，需要 client　进行处理。也就是双向调用，或者称为　callback。下面我们在上一小节的基础上增加一个回调功能。</p>
<h3 id="4-13-1-增加回调-hal-接口"><a href="#4-13-1-增加回调-hal-接口" class="headerlink" title="4.13.1 增加回调 hal 接口"></a>4.13.1 增加回调 hal 接口</h3><p>在 tvserver/1.0 目录下增加 ITVServerListener.hal　文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> device.skytoby.pure.tvserver@<span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ITVServerListener</span> </span>&#123;</span><br><span class="line"> <span class="function">oneway <span class="title">onMessage</span><span class="params">(string message)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="4-13-2-ITVServer-hal-增加回调注册接口"><a href="#4-13-2-ITVServer-hal-增加回调注册接口" class="headerlink" title="4.13.2 ITVServer.hal 增加回调注册接口"></a>4.13.2 ITVServer.hal 增加回调注册接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> device.skytoby.pure.tvserver@<span class="number">1.0</span>;</span><br><span class="line"><span class="keyword">import</span> ITVServerListener;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ITVServer</span> </span>&#123;</span><br><span class="line"> hello(string name) generates (string result);</span><br><span class="line"> registerListener(uint32_t pid, ITVServerListener listener);</span><br><span class="line"> unregisterListener(uint32_t pid);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="4-13-3-更新-current-txt"><a href="#4-13-3-更新-current-txt" class="headerlink" title="4.13.3 更新 current.txt"></a>4.13.3 更新 current.txt</h3><p>current.txt 中增加 ITVServerListener 接口的 hash 值，先随便写一个，然后执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./device/skytoby/pure/models/hidl/update-makefiles.sh</span><br></pre></td></tr></table></figure>
<p>会提示 hash 值不对，更新 current.txt 即可， 两个 hal　接口的 hash 值都更新之后，再执行 update-makefiles.sh</p>
<h3 id="4-13-4-实现新增的-hal-接口"><a href="#4-13-4-实现新增的-hal-接口" class="headerlink" title="4.13.4 实现新增的 hal 接口"></a>4.13.4 实现新增的 hal 接口</h3><p>TVServer.h</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">#include &lt;device/skytoby/pure/tvserver/1.0/ITVServerListener.h&gt;</span><br><span class="line">#include &lt;map&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">class TVServer : public ITVServer &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function">Return&lt;<span class="keyword">void</span>&gt; <span class="title">hello</span><span class="params">(<span class="keyword">const</span> hidl_string&amp; name, hello_cb _hidl_cb)</span> override</span>;</span><br><span class="line"> <span class="function">Return&lt;<span class="keyword">void</span>&gt; <span class="title">registerListener</span><span class="params">(<span class="keyword">const</span> uint32_t pid, <span class="keyword">const</span> sp&lt;ITVServerListener&gt;&amp; listener)</span> override</span>;</span><br><span class="line"> <span class="function">Return&lt;<span class="keyword">void</span>&gt; <span class="title">unregisterListener</span><span class="params">(<span class="keyword">const</span> uint32_t pid)</span> override</span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"> map&lt;uint32_t, sp&lt;ITVServerListener&gt; &gt; mListeners;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>增加了 registerListener, unregisterListener 两个方法，　这两个方法的参数类型可以根据 hal 文件中声明的参数类型来推断。 hidl 与 c++ 的数据类型转换可以按下表来转换一下，给所有参数都加上 const <a href="https://source.android.google.cn/devices/architecture/hidl-cpp/types?hl=zh-cn" target="_blank" rel="noopener">数据类型</a></p>
<p>hal 类型的参数，则使用 const sp&amp; listener 这种智能指针的形式。 当然我们也可以使用　hidl-gen　来自动生成代码。参考上一小节的：根据 .hal 自动生成 cpp 实现。</p>
<p>TVServer.cpp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;android/log.h&gt;</span><br><span class="line">#define LOG_TAG "TVServer"</span><br><span class="line">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Return&lt;<span class="keyword">void</span>&gt; TVServer::hello(<span class="keyword">const</span> hidl_string&amp; name, hello_cb _hidl_cb) &#123;</span><br><span class="line"> <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"> ::memset(buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"> ::snprintf(buf, <span class="number">100</span>, <span class="string">"hello %s from TVServer"</span>, name.c_str());</span><br><span class="line"> <span class="function">hidl_string <span class="title">result</span><span class="params">(buf)</span></span>;</span><br><span class="line"> _hidl_cb(result);</span><br><span class="line"></span><br><span class="line"> LOGD(<span class="string">"listener size = %d"</span>, mListeners.size());</span><br><span class="line"> map&lt;uint32_t, sp&lt;ITVServerListener&gt; &gt;::iterator it;</span><br><span class="line"> <span class="keyword">for</span> (it = mListeners.begin(); it != mListeners.end(); ++it) &#123;</span><br><span class="line"> sp&lt;ITVServerListener&gt; listener = it-&gt;second;</span><br><span class="line"> listener-&gt;onMessage(<span class="string">"message from server"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Return&lt;<span class="keyword">void</span>&gt; TVServer::registerListener(<span class="keyword">const</span> uint32_t pid, <span class="keyword">const</span> sp&lt;ITVServerListener&gt;&amp; listener) &#123;</span><br><span class="line"> mListeners[pid] = listener;</span><br><span class="line"> LOGD(<span class="string">"registerListener %d, %x"</span>, pid, listener.get());</span><br><span class="line"> <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Return&lt;<span class="keyword">void</span>&gt; TVServer::unregisterListener(<span class="keyword">const</span> uint32_t pid) &#123;</span><br><span class="line"> mListeners.erase(pid);</span><br><span class="line"> LOGD(<span class="string">"unregisterListener %d"</span>, pid);</span><br><span class="line"> <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-13-5-更新-manifest-xml"><a href="#4-13-5-更新-manifest-xml" class="headerlink" title="4.13.5 更新 manifest.xml"></a>4.13.5 更新 manifest.xml</h3><p>增加一个interface节点就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;hal format=<span class="string">"hidl"</span>&gt;</span><br><span class="line"> &lt;name&gt;device.skytoby.pure.tvserver&lt;/name&gt;</span><br><span class="line"> &lt;transport&gt;hwbinder&lt;/transport&gt;</span><br><span class="line"> &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line"> &lt;<span class="class"><span class="keyword">interface</span>&gt;</span></span><br><span class="line"><span class="class"> &lt;<span class="title">name</span>&gt;<span class="title">ITVServer</span>&lt;/<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class"> &lt;<span class="title">instance</span>&gt;<span class="title">default</span>&lt;/<span class="title">instance</span>&gt;</span></span><br><span class="line"><span class="class"> &lt;/<span class="title">interface</span>&gt;</span></span><br><span class="line"><span class="class"> &lt;<span class="title">interface</span>&gt;</span></span><br><span class="line"><span class="class"> &lt;<span class="title">name</span>&gt;<span class="title">ITVServerListener</span>&lt;/<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class"> &lt;<span class="title">instance</span>&gt;<span class="title">default</span>&lt;/<span class="title">instance</span>&gt;</span></span><br><span class="line"><span class="class"> &lt;/<span class="title">interface</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">hal</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-13-6-更新-client"><a href="#4-13-6-更新-client" class="headerlink" title="4.13.6 更新 client　"></a>4.13.6 更新 client　</h3><p>TVServerTest.cpp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;device/skytoby/pure/tvserver/1.0/ITVServer.h&gt;</span><br><span class="line">#include &lt;device/skytoby/pure/tvserver/1.0/ITVServerListener.h&gt;</span><br><span class="line">#include &lt;hidl/Status.h&gt;</span><br><span class="line">#include &lt;utils/misc.h&gt;</span><br><span class="line">#include &lt;hidl/HidlSupport.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">using ::android::hardware::hidl_string;</span><br><span class="line">using ::android::sp;</span><br><span class="line">using device::skytoby::pure::tvserver::V1_0::ITVServer;</span><br><span class="line">using device::skytoby::pure::tvserver::V1_0::ITVServerListener;</span><br><span class="line"></span><br><span class="line">class TVServerListener : public ITVServerListener &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> android::hardware::<span class="function">Return&lt;<span class="keyword">void</span>&gt; <span class="title">onMessage</span><span class="params">(<span class="keyword">const</span> hidl_string&amp; message)</span> override </span>&#123;</span><br><span class="line"> printf(<span class="string">"onMessage:%s\n"</span>, message.c_str());</span><br><span class="line"> <span class="keyword">return</span> android::hardware::Return&lt;<span class="keyword">void</span>&gt;();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"> sp&lt;ITVServerListener&gt; listener = <span class="keyword">new</span> TVServerListener();</span><br><span class="line"></span><br><span class="line"> android::sp&lt;ITVServer&gt; service = ITVServer::getService();</span><br><span class="line"> <span class="keyword">if</span> (service == nullptr)&#123;</span><br><span class="line"> printf(<span class="string">"Failed to get service\n"</span>);</span><br><span class="line"> <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> service-&gt;registerListener(getpid(), listener);</span><br><span class="line"></span><br><span class="line"> service-&gt;hello(<span class="string">"skytoby"</span>, [&amp;](hidl_string result)&#123;</span><br><span class="line"> printf(<span class="string">"%s\n"</span>, result.c_str());</span><br><span class="line"> &#125;);</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"> service-&gt;unregisterListener(getpid());</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-13-7-编译验证"><a href="#4-13-7-编译验证" class="headerlink" title="4.13.7 编译验证"></a>4.13.7 编译验证</h3><p>整编系统，执行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pure:/ # TVServerTest </span><br><span class="line">hello skytoby from TVServer</span><br><span class="line">onMessage:message from server</span><br><span class="line">pure:/ # logcat -s TVServer </span><br><span class="line">--------- beginning of main</span><br><span class="line">--------- beginning of system</span><br><span class="line"><span class="number">01</span>-<span class="number">18</span> <span class="number">13</span>:<span class="number">21</span>:<span class="number">27.414</span> <span class="number">1665</span> <span class="number">1903</span> D TVServer: registerListener <span class="number">4466</span>, b0443000</span><br><span class="line"><span class="number">01</span>-<span class="number">18</span> <span class="number">13</span>:<span class="number">21</span>:<span class="number">27.414</span> <span class="number">1665</span> <span class="number">1903</span> D TVServer: listener size = <span class="number">1</span></span><br><span class="line"><span class="number">01</span>-<span class="number">18</span> <span class="number">13</span>:<span class="number">21</span>:<span class="number">28.415</span> <span class="number">1665</span> <span class="number">1903</span> D TVServer: unregisterListener <span class="number">4466</span></span><br><span class="line">^C</span><br><span class="line">130|pure:/ #</span><br></pre></td></tr></table></figure>
<p>可以看到收到了　onMessage　回调。</p>
<p>参考资料</p>
<p><a href="http://qiushao.net/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener">http://qiushao.net/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/</a></p>

      
    </div>


    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Framework接口/" rel="tag">#Framework接口</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/Android Framework学习总结/" rel="next" title="Android Framework学习总结">
                <i class="fa fa-chevron-left"></i> Android Framework学习总结
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/Android音频基础知识/" rel="prev" title="Android音频基础知识">
                Android音频基础知识 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Skytoby">
          <p class="site-author-name" itemprop="name">Skytoby</p>
          <p class="site-description motion-element" itemprop="description">现居深圳，毕业于电子科技大学 <br>Android、AI<br>座右铭：想法+行动+坚持</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caoxiaoliang" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/cao861544325" target="_blank" title="CSDN">
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、JNI接口"><span class="nav-text">一、JNI接口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-源码编译so库"><span class="nav-text">1.1 源码编译so库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-so库导入系统"><span class="nav-text">1.2 so库导入系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-Java-jni调用"><span class="nav-text">1.3 Java jni调用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、Jave服务接口"><span class="nav-text">二、Jave服务接口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-使用-aidl-定义服务接口"><span class="nav-text">2.1 使用 aidl 定义服务接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-实现接口"><span class="nav-text">2.2 实现接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-将服务添加到-ServiceManager"><span class="nav-text">2.3 将服务添加到 ServiceManager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-selinux-规则设置"><span class="nav-text">2.4 selinux 规则设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-编译验证"><span class="nav-text">2.5 编译验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-客户端调用"><span class="nav-text">2.6 客户端调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-1-系统源码中使用"><span class="nav-text">2.6.1 系统源码中使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-2-非系统源码中使用"><span class="nav-text">2.6.2 非系统源码中使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-添加服务回调"><span class="nav-text">2.7 添加服务回调</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-1-使用-aidl-定义callback接口"><span class="nav-text">2.7.1 使用 aidl 定义callback接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-2-添加注册回调接口"><span class="nav-text">2.7.2 添加注册回调接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-3-client-注册回调接口"><span class="nav-text">2.7.3 client 注册回调接口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、Native服务接口"><span class="nav-text">三、Native服务接口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-声明服务接口"><span class="nav-text">3.1 声明服务接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-实现服务功能"><span class="nav-text">3.2. 实现服务功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-添加-main-cpp"><span class="nav-text">3.3. 添加 main.cpp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-Android-bp"><span class="nav-text">3.4  Android.bp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-selinux-规则设置"><span class="nav-text">3.5 selinux 规则设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-添加-HelloNativeService-te"><span class="nav-text">3.5.1 添加 HelloNativeService.te</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-修改-file-contexts"><span class="nav-text">3.5.2 修改 file_contexts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-3-修改-service-contexts"><span class="nav-text">3.5.3 修改 service_contexts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-修改-service-te"><span class="nav-text">5.4 修改 service.te</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-开机自动运行"><span class="nav-text">3.6 开机自动运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-编写-client-调用服务"><span class="nav-text">3.7 编写 client 调用服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-编译运行"><span class="nav-text">3.8 编译运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-添加native服务回调"><span class="nav-text">3.9 添加native服务回调</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-1-client-端更改"><span class="nav-text">3.9.1 client 端更改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-2-server-端更改"><span class="nav-text">3.9.2 server 端更改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-3-编译验证"><span class="nav-text">3.9.3 编译验证</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、HIDL服务接口"><span class="nav-text">四、HIDL服务接口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-添加-hal-目录"><span class="nav-text">4.1 添加 hal 目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-定义-hal-接口"><span class="nav-text">4.2 定义 hal 接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-根据-hal-自动生成-cpp-实现"><span class="nav-text">4.3 根据 .hal 自动生成 cpp 实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-开机自动启动服务"><span class="nav-text">4.4 开机自动启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-生成-Android-bp"><span class="nav-text">4.5 生成 Android.bp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-自动生成-hal-接口的-Android-bp"><span class="nav-text">4.6 自动生成 hal 接口的 Android.bp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-7-更新-current-txt"><span class="nav-text">4.7 更新 current.txt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-8-模块编译"><span class="nav-text">4.8 模块编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-9-更新-manifest-xml"><span class="nav-text">4.9 更新 manifest.xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-10-添加到-PRODUCT-PACKAGES"><span class="nav-text">4.10 添加到 PRODUCT_PACKAGES</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-11-添加-selinux-规则"><span class="nav-text">4.11 添加 selinux 规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-12-编写-client-调用服务"><span class="nav-text">4.12 编写 client 调用服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-13-增加hidl服务回调"><span class="nav-text">4.13 增加hidl服务回调</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-13-1-增加回调-hal-接口"><span class="nav-text">4.13.1 增加回调 hal 接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-13-2-ITVServer-hal-增加回调注册接口"><span class="nav-text">4.13.2 ITVServer.hal 增加回调注册接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-13-3-更新-current-txt"><span class="nav-text">4.13.3 更新 current.txt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-13-4-实现新增的-hal-接口"><span class="nav-text">4.13.4 实现新增的 hal 接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-13-5-更新-manifest-xml"><span class="nav-text">4.13.5 更新 manifest.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-13-6-更新-client"><span class="nav-text">4.13.6 更新 client　</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-13-7-编译验证"><span class="nav-text">4.13.7 编译验证</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skytoby</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme Next
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'https-zproo-github-io';
      var disqus_identifier = '2023/Android Framewok接口开发总结/';
      var disqus_title = "Android Framework接口开发总结";
      var disqus_url = 'http://zproo.github.io/2023/Android Framewok接口开发总结/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  









  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
