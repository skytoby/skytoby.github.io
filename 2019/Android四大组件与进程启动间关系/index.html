<!doctype html>



  


<html class="theme-next pisces use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="四大组件与进程关系,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="基于Android10.0，分析四大组件与进程启动间的关系  一、概述Android进程对于系统来说非常重要，而Android四大组件是Android应用的基础。在前面分析过Android进程创建的过程，那么对于四大组件来说和进程之间又有什么关联，这里主要看AMS.startProcessLocked方法。 二、四大组件与进程2.1 四大组件Activity、Service、ContentPro">
<meta name="keywords" content="四大组件与进程关系">
<meta property="og:type" content="article">
<meta property="og:title" content="Android四大组件与进程启动间关系">
<meta property="og:url" content="http://zproo.github.io/2019/Android四大组件与进程启动间关系/index.html">
<meta property="og:site_name" content="Skytoby">
<meta property="og:description" content="基于Android10.0，分析四大组件与进程启动间的关系  一、概述Android进程对于系统来说非常重要，而Android四大组件是Android应用的基础。在前面分析过Android进程创建的过程，那么对于四大组件来说和进程之间又有什么关联，这里主要看AMS.startProcessLocked方法。 二、四大组件与进程2.1 四大组件Activity、Service、ContentPro">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-12-29T14:03:21.658Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android四大组件与进程启动间关系">
<meta name="twitter:description" content="基于Android10.0，分析四大组件与进程启动间的关系  一、概述Android进程对于系统来说非常重要，而Android四大组件是Android应用的基础。在前面分析过Android进程创建的过程，那么对于四大组件来说和进程之间又有什么关联，这里主要看AMS.startProcessLocked方法。 二、四大组件与进程2.1 四大组件Activity、Service、ContentPro">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://zproo.github.io/2019/Android四大组件与进程启动间关系/">

  <title> Android四大组件与进程启动间关系 | Skytoby </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <header id="header_post" class="header" itemscope="" itemtype="http://schema.org/WPHeader" style="background-image: url('http://ortur5wom.bkt.clouddn.com/home_bg.jpg');">
      <div class="header-inner-post"><a class="site-home" href="/">Skytoby</a>

<div class="site-meta ">
  
  
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/logo.png" style="width: 50px" alt="Skytoby">
      </a>
    </div>
  

  
  
  
  
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
           <li class="menu-item menu-item-关于">
             <a href="/about" rel="section">
               
               
               关于
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-目录">
             <a href="/archives" rel="section">
               
               
               目录
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-首页">
             <a href="/" rel="section">
               
               
               首页
             </a>
           </li>
        
      

      
    </ul>
  

  
</nav> </div>
      <div class="header-post"> 
  <div class="post-header">
      <div class="tags">
      
        <a href="/tags/四大组件与进程关系/" rel="tag" title="四大组件与进程关系">四大组件与进程关系</a>
      
      </div>
      <h1>Android四大组件与进程启动间关系</h1>
      <h2 class="subtitle"></h2>
      <div class="post-time">
        <span class="post-meta-item-text">Posted on </span>
        <time itemprop="dateCreated" datetime="2019-10-31T21:45:23+08:00" content="2019-10-31" title="2019-10-31 21:45:23">
          2019-10-31
        </time>
      </div>
  </div>
 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android四大组件与进程启动间关系
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2019-10-31T21:45:23+08:00" content="2019-10-31">
              2019-10-31
            </time>
          </span>

          

          

          <!-- 
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/Android四大组件与进程启动间关系/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/Android四大组件与进程启动间关系/" itemprop="commentsCount"></span>
                </a>
              </span>
            
           -->

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>基于Android10.0，分析四大组件与进程启动间的关系</p>
</blockquote>
<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>Android进程对于系统来说非常重要，而Android四大组件是Android应用的基础。在前面分析过<a href="https://skytoby.github.io/2019/Android%E8%BF%9B%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">Android进程创建的过程</a>，那么对于四大组件来说和进程之间又有什么关联，这里主要看AMS.startProcessLocked方法。</p>
<h2 id="二、四大组件与进程"><a href="#二、四大组件与进程" class="headerlink" title="二、四大组件与进程"></a>二、四大组件与进程</h2><h3 id="2-1-四大组件"><a href="#2-1-四大组件" class="headerlink" title="2.1 四大组件"></a>2.1 四大组件</h3><p>Activity、Service、ContentProvider、BroadcastReceiver这四大组件，在启动的过程中，当其承载的进程不存在时需要调用startProcessLocked先创建进程。</p>
<h4 id="2-1-1-Activity"><a href="#2-1-1-Activity" class="headerlink" title="2.1.1 Activity"></a>2.1.1 Activity</h4><p>启动Activity，调用的是startActivity方法，经过层层调用ActivityStackSupervisor.java中的startSpecificActivityLocked。当activity所属的进程还没有启动时，则需要创建相应的进程。详细见<a href="https://skytoby.github.io/2019/startActivity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" target="_blank" rel="noopener">startActivity启动过程</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void startSpecificActivityLocked(ActivityRecord r,</span><br><span class="line">            boolean andResume, boolean checkConfig) &#123;</span><br><span class="line">        ...</span><br><span class="line">        if (app != null &amp;&amp; app.thread != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == 0</span><br><span class="line">                        || !&quot;android&quot;.equals(r.info.packageName)) &#123;</span><br><span class="line">                    // Don&apos;t add this if it is a platform component that is marked</span><br><span class="line">                    // to run in multiple processes, because this is actually</span><br><span class="line">                    // part of the framework so doesn&apos;t make sense to track as a</span><br><span class="line">                    // separate apk in the process.</span><br><span class="line">                    app.addPackage(r.info.packageName, r.info.applicationInfo.longVersionCode,</span><br><span class="line">                            mService.mProcessStats);</span><br><span class="line">                &#125;</span><br><span class="line">                //真正启动Activity，见2.18节</span><br><span class="line">                realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">                return;</span><br><span class="line">            &#125; catch (RemoteException e) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;Exception when starting activity &quot;</span><br><span class="line">                        + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // If a dead object exception was thrown -- fall through to</span><br><span class="line">            // restart the application.</span><br><span class="line">        &#125;</span><br><span class="line">        //当进程不存在，则创建进程</span><br><span class="line">        mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,</span><br><span class="line">                &quot;activity&quot;, r.intent.getComponent(), false, false, true);</span><br><span class="line">         ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-Service"><a href="#2-1-2-Service" class="headerlink" title="2.1.2 Service"></a>2.1.2 Service</h4><p>启动Service，调用的是startService方法，经过层层调用ActiveServices.java中的bringUpServiceLocked。当Service所属的进程还没有启动时，则需要创建相应的进程。详细见<a href="https://skytoby.github.io/2019/startService%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" target="_blank" rel="noopener">startService启动过程</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg,</span><br><span class="line">           boolean whileRestarting, boolean permissionsReviewRequired)</span><br><span class="line">           throws TransactionTooLargeException &#123;</span><br><span class="line">       ....</span><br><span class="line">       //对于服务进程没有启动的情况</span><br><span class="line">       // Not running -- get it started, and enqueue this service record</span><br><span class="line">       // to be executed when the app comes up.</span><br><span class="line">       if (app == null &amp;&amp; !permissionsReviewRequired) &#123;</span><br><span class="line">           //启动服务所需要的进程</span><br><span class="line">           if ((app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags,</span><br><span class="line">                   hostingType, r.name, false, isolated, false)) == null) &#123;</span><br><span class="line">               String msg = &quot;Unable to launch app &quot;</span><br><span class="line">                       + r.appInfo.packageName + &quot;/&quot;</span><br><span class="line">                       + r.appInfo.uid + &quot; for service &quot;</span><br><span class="line">                       + r.intent.getIntent() + &quot;: process is bad&quot;;</span><br><span class="line">               Slog.w(TAG, msg);</span><br><span class="line">               //进程启动失败</span><br><span class="line">               bringDownServiceLocked(r);</span><br><span class="line">               return msg;</span><br><span class="line">           &#125;</span><br><span class="line">           if (isolated) &#123;</span><br><span class="line">               r.isolatedProc = app;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-3-ContentProvider"><a href="#2-1-3-ContentProvider" class="headerlink" title="2.1.3 ContentProvider"></a>2.1.3 ContentProvider</h4><p>ContentProvider.query经过层层调用，最终调用到ActivityManagerService.java中getContentProviderImpl，当ContentProvider所对应进程不存在，则需要创建新进程。详细见<a href="https://skytoby.github.io/2019/ContentProvider%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">ContentProvider原理分析</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  private ContentProviderHolder getContentProviderImpl(IApplicationThread caller,</span><br><span class="line">            String name, IBinder token, boolean stable, int userId) &#123;</span><br><span class="line">            .....</span><br><span class="line">                      if (proc != null &amp;&amp; proc.thread != null &amp;&amp; !proc.killed) &#123;</span><br><span class="line">                            if (DEBUG_PROVIDER) Slog.d(TAG_PROVIDER,</span><br><span class="line">                                    &quot;Installing in existing process &quot; + proc);</span><br><span class="line">                            if (!proc.pubProviders.containsKey(cpi.name)) &#123;</span><br><span class="line">                                checkTime(startTime, &quot;getContentProviderImpl: scheduling install&quot;);</span><br><span class="line">                                proc.pubProviders.put(cpi.name, cpr);</span><br><span class="line">                                try &#123;</span><br><span class="line">                                     //发布provider，见2.2.1节</span><br><span class="line">                                    proc.thread.scheduleInstallProvider(cpi);</span><br><span class="line">                                &#125; catch (RemoteException e) &#123;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            checkTime(startTime, &quot;getContentProviderImpl: before start process&quot;);</span><br><span class="line">                            //启动进程</span><br><span class="line">                            proc = startProcessLocked(cpi.processName,</span><br><span class="line">                                    cpr.appInfo, false, 0, &quot;content provider&quot;,</span><br><span class="line">                                    new ComponentName(cpi.applicationInfo.packageName,</span><br><span class="line">                                            cpi.name), false, false, false);</span><br><span class="line">                            checkTime(startTime, &quot;getContentProviderImpl: after start process&quot;);</span><br><span class="line">                            if (proc == null) &#123;</span><br><span class="line">                                Slog.w(TAG, &quot;Unable to launch app &quot;</span><br><span class="line">                                        + cpi.applicationInfo.packageName + &quot;/&quot;</span><br><span class="line">                                        + cpi.applicationInfo.uid + &quot; for provider &quot;</span><br><span class="line">                                        + name + &quot;: process is bad&quot;);</span><br><span class="line">                                return null;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                 ......       </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-4-BroadcastReceiver"><a href="#2-1-4-BroadcastReceiver" class="headerlink" title="2.1.4 BroadcastReceiver"></a>2.1.4 BroadcastReceiver</h4><p>调用SendBroadcast方法，经过层层调用，最终调用BroadcastQueue.jav的processNextBroadcast方法。当BroadcastReceiver所在的进程没有启动，则创建相应进程。详细见<a href="https://skytoby.github.io/2019/BroadcastCast%E5%B9%BF%E6%92%AD%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">BroadcastCast广播机制原理</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">final void processNextBroadcastLocked(boolean fromMsg, boolean skipOomAdj) &#123;</span><br><span class="line">    ......</span><br><span class="line">    if ((r.curApp=mService.startProcessLocked(targetProcess,</span><br><span class="line">                info.activityInfo.applicationInfo, true,</span><br><span class="line">                r.intent.getFlags() | Intent.FLAG_FROM_BACKGROUND,</span><br><span class="line">                &quot;broadcast&quot;, r.curComponent,</span><br><span class="line">                (r.intent.getFlags()&amp;Intent.FLAG_RECEIVER_BOOT_UPGRADE) != 0, false, false))</span><br><span class="line">                        == null) &#123;</span><br><span class="line">            // Ah, this recipient is unavailable.  Finish it if necessary,</span><br><span class="line">            // and mark the broadcast record as ready for the next.</span><br><span class="line">            Slog.w(TAG, &quot;Unable to launch app &quot;</span><br><span class="line">                    + info.activityInfo.applicationInfo.packageName + &quot;/&quot;</span><br><span class="line">                    + receiverUid + &quot; for broadcast &quot;</span><br><span class="line">                    + r.intent + &quot;: process is bad&quot;);</span><br><span class="line">            //创建失败，直接结束该receiver        </span><br><span class="line">            logBroadcastReceiverDiscardLocked(r);</span><br><span class="line">            finishReceiverLocked(r, r.resultCode, r.resultData,</span><br><span class="line">                    r.resultExtras, r.resultAbort, false);</span><br><span class="line">            //开启下一个广播</span><br><span class="line">            scheduleBroadcastsLocked();</span><br><span class="line">            r.state = BroadcastRecord.IDLE;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-进程启动"><a href="#2-2-进程启动" class="headerlink" title="2.2 进程启动"></a>2.2 进程启动</h3><p>ActivityManagerService.java有四个不同startProcessLocked的启动进程方法，详细见第三大节。对于进程启动的触发实际主要是四个组件所在的进程没有启动才会创建。大多数情况下app都是单进程架构，对于多进程的app一般都是通过AndroidManifest.xml中的android:process属性来实现的。</p>
<ul>
<li><p>当android:process属于值以”:”开头，则代表进程是私有进程，只有该app可以使用</p>
</li>
<li><p>当android:process属于值不以”:”开头，则代表进程是全局进程，这种情况需要注意进程名至少包含“.”字符。</p>
</li>
</ul>
<h2 id="三、进程创建过程"><a href="#三、进程创建过程" class="headerlink" title="三、进程创建过程"></a>三、进程创建过程</h2><h3 id="3-1-AMS-startProcessLocked"><a href="#3-1-AMS-startProcessLocked" class="headerlink" title="3.1  AMS.startProcessLocked"></a>3.1  AMS.startProcessLocked</h3><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">final ProcessRecord startProcessLocked(String processName,</span><br><span class="line">          ApplicationInfo info, boolean knownToBeDead, int intentFlags,</span><br><span class="line">          String hostingType, ComponentName hostingName, boolean allowWhileBooting,</span><br><span class="line">          boolean isolated, boolean keepIfLarge) &#123;</span><br><span class="line">      //见3.2节    </span><br><span class="line">      return startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,</span><br><span class="line">              hostingName, allowWhileBooting, isolated, 0 /* isolatedUid */, keepIfLarge,</span><br><span class="line">              null /* ABI override */, null /* entryPoint */, null /* entryPointArgs */,</span><br><span class="line">              null /* crashHandler */);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-AMS-startProcessLocked"><a href="#3-2-AMS-startProcessLocked" class="headerlink" title="3.2  AMS.startProcessLocked"></a>3.2  AMS.startProcessLocked</h3><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">@GuardedBy(&quot;this&quot;)</span><br><span class="line">   final ProcessRecord startProcessLocked(String processName, ApplicationInfo info,</span><br><span class="line">           boolean knownToBeDead, int intentFlags, String hostingType, ComponentName hostingName,</span><br><span class="line">           boolean allowWhileBooting, boolean isolated, int isolatedUid, boolean keepIfLarge,</span><br><span class="line">           String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler) &#123;</span><br><span class="line">       long startTime = SystemClock.elapsedRealtime();</span><br><span class="line">       ProcessRecord app;</span><br><span class="line">       if (!isolated) &#123;</span><br><span class="line">           //如果不是孤立进程，根据进程名和uid检查相应的ProcessRecord</span><br><span class="line">           app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line">           checkTime(startTime, &quot;startProcess: after getProcessRecord&quot;);</span><br><span class="line"></span><br><span class="line">           if ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != 0) &#123;</span><br><span class="line">               // If we are in the background, then check to see if this process</span><br><span class="line">               // is bad.  If so, we will just silently fail.</span><br><span class="line">               //如果当前进程是后台进程，检查进程是否处于bad进程列表</span><br><span class="line">               if (mAppErrors.isBadProcessLocked(info)) &#123;</span><br><span class="line">                   if (DEBUG_PROCESSES) Slog.v(TAG, &quot;Bad process: &quot; + info.uid</span><br><span class="line">                           + &quot;/&quot; + info.processName);</span><br><span class="line">                   return null;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               // When the user is explicitly starting a process, then clear its</span><br><span class="line">               // crash count so that we won&apos;t make it bad until they see at</span><br><span class="line">               // least one crash dialog again, and make the process good again</span><br><span class="line">               // if it had been bad.</span><br><span class="line">               //当用户明确的启动一个进程，则清空crash的次数。保证其不处于bad进程</span><br><span class="line">               //直到下次再弹出crash对话框。如果之前是bad进程则改成good进程</span><br><span class="line">               if (DEBUG_PROCESSES) Slog.v(TAG, &quot;Clearing bad process: &quot; + info.uid</span><br><span class="line">                       + &quot;/&quot; + info.processName);</span><br><span class="line">               mAppErrors.resetProcessCrashTimeLocked(info);</span><br><span class="line">               if (mAppErrors.isBadProcessLocked(info)) &#123;</span><br><span class="line">                   EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</span><br><span class="line">                           UserHandle.getUserId(info.uid), info.uid,</span><br><span class="line">                           info.processName);</span><br><span class="line">                   mAppErrors.clearBadProcessLocked(info);</span><br><span class="line">                   if (app != null) &#123;</span><br><span class="line">                       app.bad = false;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           // If this is an isolated process, it can&apos;t re-use an existing process.</span><br><span class="line">           //如果是孤立进程则无法利用已存在的信息</span><br><span class="line">           app = null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // We don&apos;t have to do anything more if:</span><br><span class="line">       // (1) There is an existing application record; and</span><br><span class="line">       // (2) The caller doesn&apos;t think it is dead, OR there is no thread</span><br><span class="line">       //     object attached to it so we know it couldn&apos;t have crashed; and</span><br><span class="line">       // (3) There is a pid assigned to it, so it is either starting or</span><br><span class="line">       //     already running.</span><br><span class="line">       if (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, &quot;startProcess: name=&quot; + processName</span><br><span class="line">               + &quot; app=&quot; + app + &quot; knownToBeDead=&quot; + knownToBeDead</span><br><span class="line">               + &quot; thread=&quot; + (app != null ? app.thread : null)</span><br><span class="line">               + &quot; pid=&quot; + (app != null ? app.pid : -1));</span><br><span class="line">       //(1)存在ProcessRecord</span><br><span class="line">       //(2)caller不认为该进程已经死亡或者没有thread attached到该进程</span><br><span class="line">       //(3)分配了pid，那么改进程要么在启动要么在运行</span><br><span class="line">       if (app != null &amp;&amp; app.pid &gt; 0) &#123;</span><br><span class="line">           if ((!knownToBeDead &amp;&amp; !app.killed) || app.thread == null) &#123;</span><br><span class="line">               // We already have the app running, or are waiting for it to</span><br><span class="line">               // come up (we have a pid but not yet its thread), so keep it.</span><br><span class="line">               if (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, &quot;App already running: &quot; + app);</span><br><span class="line">               // If this is a new package in the process, add the package to the list</span><br><span class="line">               //如果是进程中新package，则package添加到列表</span><br><span class="line">               app.addPackage(info.packageName, info.versionCode, mProcessStats);</span><br><span class="line">               checkTime(startTime, &quot;startProcess: done, added package to proc&quot;);</span><br><span class="line">               return app;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // An application record is attached to a previous process,</span><br><span class="line">           // clean it up now.</span><br><span class="line">           //ProcessRecord已经attached到先前的一个进程，则杀死并清理该进程</span><br><span class="line">           if (DEBUG_PROCESSES || DEBUG_CLEANUP) Slog.v(TAG_PROCESSES, &quot;App died: &quot; + app);</span><br><span class="line">           checkTime(startTime, &quot;startProcess: bad proc running, killing&quot;);</span><br><span class="line">           killProcessGroup(app.uid, app.pid);</span><br><span class="line">           handleAppDiedLocked(app, true, true);</span><br><span class="line">           checkTime(startTime, &quot;startProcess: done killing old proc&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       String hostingNameStr = hostingName != null</span><br><span class="line">               ? hostingName.flattenToShortString() : null;</span><br><span class="line"></span><br><span class="line">       if (app == null) &#123;</span><br><span class="line">           checkTime(startTime, &quot;startProcess: creating new process record&quot;);</span><br><span class="line">           //创建newProcessRecordLocked对象</span><br><span class="line">           app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</span><br><span class="line">           if (app == null) &#123;</span><br><span class="line">               Slog.w(TAG, &quot;Failed making new process record for &quot;</span><br><span class="line">                       + processName + &quot;/&quot; + info.uid + &quot; isolated=&quot; + isolated);</span><br><span class="line">               return null;</span><br><span class="line">           &#125;</span><br><span class="line">           app.crashHandler = crashHandler;</span><br><span class="line">           app.isolatedEntryPoint = entryPoint;</span><br><span class="line">           app.isolatedEntryPointArgs = entryPointArgs;</span><br><span class="line">           checkTime(startTime, &quot;startProcess: done creating new process record&quot;);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           // If this is a new package in the process, add the package to the list</span><br><span class="line">           // 如果是进程中新package，则package添加到列表</span><br><span class="line">           app.addPackage(info.packageName, info.versionCode, mProcessStats);</span><br><span class="line">           checkTime(startTime, &quot;startProcess: added package to existing proc&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // If the system is not ready yet, then hold off on starting this</span><br><span class="line">       // process until it is.</span><br><span class="line">       //如果系统未准备完毕，则将其添加到mProcessesOnHold</span><br><span class="line">       if (!mProcessesReady</span><br><span class="line">               &amp;&amp; !isAllowedWhileBooting(info)</span><br><span class="line">               &amp;&amp; !allowWhileBooting) &#123;</span><br><span class="line">           if (!mProcessesOnHold.contains(app)) &#123;</span><br><span class="line">               mProcessesOnHold.add(app);</span><br><span class="line">           &#125;</span><br><span class="line">           if (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES,</span><br><span class="line">                   &quot;System not ready, putting on hold: &quot; + app);</span><br><span class="line">           checkTime(startTime, &quot;startProcess: returning with proc on hold&quot;);</span><br><span class="line">           return app;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       checkTime(startTime, &quot;startProcess: stepping in to startProcess&quot;);</span><br><span class="line">       //启动进程</span><br><span class="line">       final boolean success = startProcessLocked(app, hostingType, hostingNameStr, abiOverride);</span><br><span class="line">       checkTime(startTime, &quot;startProcess: done starting proc!&quot;);</span><br><span class="line">       return success ? app : null;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>主要功能：</p>
<p>1.对于非isolated进程，则根据进程名和uid检查相应的ProcessRecord，如果当前进程处于后台且当前进程处于bad列表则直接返回，否则清空crash次数，以保证其不处于bad进程知道下次再次弹出crash对话框</p>
<p>2.当存在ProcessRecord，且已分配pid（正在启动或者已经启动）的情况</p>
<ul>
<li><p>当caller不认为该进程已死亡或者thread对象attached到该进程，则不应该清理该进程，则直接返回；</p>
</li>
<li><p>否则杀死并清理该进程</p>
</li>
</ul>
<p>3.当ProcessRecord为空则新建一个，当创建失败则直接返回</p>
<p>4.当以下3个值为false，则将当前进程加入到mProcessesOnHold，并直接返回，当进程真正创建则从mProcessesOnHold中移除。</p>
<ul>
<li><p>当AMS.systemReady执行完成，则mProcessesReady = true；</p>
</li>
<li><p>当进程为persistent，则isAllowedWhileBooting=true;</p>
</li>
<li><p>一般地创建进程时参数allowWhileBooting = flase，只有AMS.startIsolatedProcess该值才为true；</p>
</li>
</ul>
<p>5.最后启动新进程，其参数含义：</p>
<p>hostingType取值为“activity”,”service”,”broadcast”，”contentprovider”</p>
<p>hostingNameStr取值为具体相对应的组件名，类型为ComponentName</p>
<h3 id="3-3-AMS-startProcessLocked"><a href="#3-3-AMS-startProcessLocked" class="headerlink" title="3.3  AMS.startProcessLocked"></a>3.3  AMS.startProcessLocked</h3><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private final boolean startProcessLocked(ProcessRecord app,</span><br><span class="line">        String hostingType, String hostingNameStr, String abiOverride) &#123;</span><br><span class="line">    return startProcessLocked(app, hostingType, hostingNameStr,</span><br><span class="line">            false /* disableHiddenApiChecks */, abiOverride);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * @return &#123;@code true&#125; if process start is successful, false otherwise.</span><br><span class="line">   */</span><br><span class="line">  @GuardedBy(&quot;this&quot;)</span><br><span class="line">  private final boolean startProcessLocked(ProcessRecord app, String hostingType,</span><br><span class="line">          String hostingNameStr, boolean disableHiddenApiChecks, String abiOverride) &#123;</span><br><span class="line">      if (app.pendingStart) &#123;</span><br><span class="line">          return true;</span><br><span class="line">      &#125;</span><br><span class="line">      long startTime = SystemClock.elapsedRealtime();</span><br><span class="line">      //app的pid大于0且pid不等于当前进程的pid,则从mPidsSelfLocked中移除该app的pid</span><br><span class="line">      if (app.pid &gt; 0 &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line">          checkTime(startTime, &quot;startProcess: removing from pids map&quot;);</span><br><span class="line">          synchronized (mPidsSelfLocked) &#123;</span><br><span class="line">              mPidsSelfLocked.remove(app.pid);</span><br><span class="line">              mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">          &#125;</span><br><span class="line">          checkTime(startTime, &quot;startProcess: done removing from pids map&quot;);</span><br><span class="line">          app.setPid(0);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</span><br><span class="line">              &quot;startProcessLocked removing on hold: &quot; + app);</span><br><span class="line">      //从mProcessesOnHold进程中移除该app</span><br><span class="line">      mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">      checkTime(startTime, &quot;startProcess: starting to update cpu stats&quot;);</span><br><span class="line">      //更新cpu统计信息</span><br><span class="line">      updateCpuStats();</span><br><span class="line">      checkTime(startTime, &quot;startProcess: done updating cpu stats&quot;);</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">          try &#123;</span><br><span class="line">              final int userId = UserHandle.getUserId(app.uid);</span><br><span class="line">              //检查package是否可启动</span><br><span class="line">              AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId);</span><br><span class="line">          &#125; catch (RemoteException e) &#123;</span><br><span class="line">              throw e.rethrowAsRuntimeException();</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          int uid = app.uid;</span><br><span class="line">          int[] gids = null;</span><br><span class="line">          int mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">          if (!app.isolated) &#123;</span><br><span class="line">              int[] permGids = null;</span><br><span class="line">              try &#123;</span><br><span class="line">                  //获取gid</span><br><span class="line">                  checkTime(startTime, &quot;startProcess: getting gids from package manager&quot;);</span><br><span class="line">                  final IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">                  permGids = pm.getPackageGids(app.info.packageName,</span><br><span class="line">                          MATCH_DEBUG_TRIAGED_MISSING, app.userId);</span><br><span class="line">                  StorageManagerInternal storageManagerInternal = LocalServices.getService(</span><br><span class="line">                          StorageManagerInternal.class);</span><br><span class="line">                  mountExternal = storageManagerInternal.getExternalStorageMountMode(uid,</span><br><span class="line">                          app.info.packageName);</span><br><span class="line">              &#125; catch (RemoteException e) &#123;</span><br><span class="line">                  throw e.rethrowAsRuntimeException();</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              /*</span><br><span class="line">               * Add shared application and profile GIDs so applications can share some</span><br><span class="line">               * resources like shared libraries and access user-wide resources</span><br><span class="line">               */</span><br><span class="line">               //添加共享app和gids，用于app直接共享资源</span><br><span class="line">              if (ArrayUtils.isEmpty(permGids)) &#123;</span><br><span class="line">                  gids = new int[3];</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  gids = new int[permGids.length + 3];</span><br><span class="line">                  System.arraycopy(permGids, 0, gids, 3, permGids.length);</span><br><span class="line">              &#125;</span><br><span class="line">              gids[0] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</span><br><span class="line">              gids[1] = UserHandle.getCacheAppGid(UserHandle.getAppId(uid));</span><br><span class="line">              gids[2] = UserHandle.getUserGid(UserHandle.getUserId(uid));</span><br><span class="line"></span><br><span class="line">              // Replace any invalid GIDs</span><br><span class="line">              if (gids[0] == UserHandle.ERR_GID) gids[0] = gids[2];</span><br><span class="line">              if (gids[1] == UserHandle.ERR_GID) gids[1] = gids[2];</span><br><span class="line">          &#125;</span><br><span class="line">          checkTime(startTime, &quot;startProcess: building args&quot;);</span><br><span class="line">          if (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) &#123;</span><br><span class="line">              if (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">                      &amp;&amp; mTopComponent != null</span><br><span class="line">                      &amp;&amp; app.processName.equals(mTopComponent.getPackageName())) &#123;</span><br><span class="line">                  uid = 0;</span><br><span class="line">              &#125;</span><br><span class="line">              if (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL</span><br><span class="line">                      &amp;&amp; (app.info.flags&amp;ApplicationInfo.FLAG_FACTORY_TEST) != 0) &#123;</span><br><span class="line">                  uid = 0;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          //根据不同的参数，设置runtimeFlags</span><br><span class="line">          int runtimeFlags = 0;</span><br><span class="line">          if ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_ENABLE_JDWP;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_JAVA_DEBUGGABLE;</span><br><span class="line">              // Also turn on CheckJNI for debuggable apps. It&apos;s quite</span><br><span class="line">              // awkward to turn on otherwise.</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</span><br><span class="line">          &#125;</span><br><span class="line">          // Run the app in safe mode if its manifest requests so or the</span><br><span class="line">          // system is booted in safe mode.</span><br><span class="line">          if ((app.info.flags &amp; ApplicationInfo.FLAG_VM_SAFE_MODE) != 0 ||</span><br><span class="line">              mSafeMode == true) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_ENABLE_SAFEMODE;</span><br><span class="line">          &#125;</span><br><span class="line">          if (&quot;1&quot;.equals(SystemProperties.get(&quot;debug.checkjni&quot;))) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</span><br><span class="line">          &#125;</span><br><span class="line">          String genDebugInfoProperty = SystemProperties.get(&quot;debug.generate-debug-info&quot;);</span><br><span class="line">          if (&quot;1&quot;.equals(genDebugInfoProperty) || &quot;true&quot;.equals(genDebugInfoProperty)) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO;</span><br><span class="line">          &#125;</span><br><span class="line">          String genMiniDebugInfoProperty = SystemProperties.get(&quot;dalvik.vm.minidebuginfo&quot;);</span><br><span class="line">          if (&quot;1&quot;.equals(genMiniDebugInfoProperty) || &quot;true&quot;.equals(genMiniDebugInfoProperty)) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_GENERATE_MINI_DEBUG_INFO;</span><br><span class="line">          &#125;</span><br><span class="line">          if (&quot;1&quot;.equals(SystemProperties.get(&quot;debug.jni.logging&quot;))) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_ENABLE_JNI_LOGGING;</span><br><span class="line">          &#125;</span><br><span class="line">          if (&quot;1&quot;.equals(SystemProperties.get(&quot;debug.assert&quot;))) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_ENABLE_ASSERT;</span><br><span class="line">          &#125;</span><br><span class="line">          if (mNativeDebuggingApp != null &amp;&amp; mNativeDebuggingApp.equals(app.processName)) &#123;</span><br><span class="line">              // Enable all debug flags required by the native debugger.</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_ALWAYS_JIT;          // Don&apos;t interpret anything</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO; // Generate debug info</span><br><span class="line">              runtimeFlags |= Zygote.DEBUG_NATIVE_DEBUGGABLE;   // Disbale optimizations</span><br><span class="line">              mNativeDebuggingApp = null;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          if (app.info.isPrivilegedApp() &amp;&amp;</span><br><span class="line">                  DexManager.isPackageSelectedToRunOob(app.pkgList.keySet())) &#123;</span><br><span class="line">              runtimeFlags |= Zygote.ONLY_USE_SYSTEM_OAT_FILES;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          if (!disableHiddenApiChecks &amp;&amp; !mHiddenApiBlacklist.isDisabled()) &#123;</span><br><span class="line">              app.info.maybeUpdateHiddenApiEnforcementPolicy(mHiddenApiBlacklist.getPolicy());</span><br><span class="line">              @HiddenApiEnforcementPolicy int policy =</span><br><span class="line">                      app.info.getHiddenApiEnforcementPolicy();</span><br><span class="line">              int policyBits = (policy &lt;&lt; Zygote.API_ENFORCEMENT_POLICY_SHIFT);</span><br><span class="line">              if ((policyBits &amp; Zygote.API_ENFORCEMENT_POLICY_MASK) != policyBits) &#123;</span><br><span class="line">                  throw new IllegalStateException(&quot;Invalid API policy: &quot; + policy);</span><br><span class="line">              &#125;</span><br><span class="line">              runtimeFlags |= policyBits;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          String invokeWith = null;</span><br><span class="line">          if ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0) &#123;</span><br><span class="line">              // Debuggable apps may include a wrapper script with their library directory.</span><br><span class="line">              String wrapperFileName = app.info.nativeLibraryDir + &quot;/wrap.sh&quot;;</span><br><span class="line">              StrictMode.ThreadPolicy oldPolicy = StrictMode.allowThreadDiskReads();</span><br><span class="line">              try &#123;</span><br><span class="line">                  if (new File(wrapperFileName).exists()) &#123;</span><br><span class="line">                      invokeWith = &quot;/system/bin/logwrapper &quot; + wrapperFileName;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; finally &#123;</span><br><span class="line">                  StrictMode.setThreadPolicy(oldPolicy);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          String requiredAbi = (abiOverride != null) ? abiOverride : app.info.primaryCpuAbi;</span><br><span class="line">          if (requiredAbi == null) &#123;</span><br><span class="line">              requiredAbi = Build.SUPPORTED_ABIS[0];</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          String instructionSet = null;</span><br><span class="line">          if (app.info.primaryCpuAbi != null) &#123;</span><br><span class="line">              instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          app.gids = gids;</span><br><span class="line">          app.requiredAbi = requiredAbi;</span><br><span class="line">          app.instructionSet = instructionSet;</span><br><span class="line"></span><br><span class="line">          // the per-user SELinux context must be set</span><br><span class="line">          if (TextUtils.isEmpty(app.info.seInfoUser)) &#123;</span><br><span class="line">              Slog.wtf(TAG, &quot;SELinux tag not defined&quot;,</span><br><span class="line">                      new IllegalStateException(&quot;SELinux tag not defined for &quot;</span><br><span class="line">                      + app.info.packageName + &quot; (uid &quot; + app.uid + &quot;)&quot;));</span><br><span class="line">          &#125;</span><br><span class="line">          final String seInfo = app.info.seInfo</span><br><span class="line">                  + (TextUtils.isEmpty(app.info.seInfoUser) ? &quot;&quot; : app.info.seInfoUser);</span><br><span class="line">          // Start the process.  It will either succeed and return a result containing</span><br><span class="line">          // the PID of the new process, or else throw a RuntimeException.</span><br><span class="line">          final String entryPoint = &quot;android.app.ActivityThread&quot;;</span><br><span class="line">          //见3.4节</span><br><span class="line">          return startProcessLocked(hostingType, hostingNameStr, entryPoint, app, uid, gids,</span><br><span class="line">                  runtimeFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith,</span><br><span class="line">                  startTime);</span><br><span class="line">      &#125; catch (RuntimeException e) &#123;</span><br><span class="line">          Slog.e(TAG, &quot;Failure starting process &quot; + app.processName, e);</span><br><span class="line"></span><br><span class="line">          // Something went very wrong while trying to start this process; one</span><br><span class="line">          // common case is when the package is frozen due to an active</span><br><span class="line">          // upgrade. To recover, clean up any active bookkeeping related to</span><br><span class="line">          // starting this process. (We already invoked this method once when</span><br><span class="line">          // the package was initially frozen through KILL_APPLICATION_MSG, so</span><br><span class="line">          // it doesn&apos;t hurt to use it again.)</span><br><span class="line">          //启动该进程失败，一个可能的原因是package被冻结。为了恢复，清除该进程</span><br><span class="line">          forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid), false,</span><br><span class="line">                  false, true, false, false, app.userId, &quot;start failure&quot;);</span><br><span class="line">          return false;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>根据不同参数设置相应的runtimeFlags</p>
<h3 id="3-4-AMS-startProcessLocked"><a href="#3-4-AMS-startProcessLocked" class="headerlink" title="3.4 AMS.startProcessLocked"></a>3.4 AMS.startProcessLocked</h3><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">@GuardedBy(&quot;this&quot;)</span><br><span class="line"> private boolean startProcessLocked(String hostingType, String hostingNameStr, String entryPoint,</span><br><span class="line">         ProcessRecord app, int uid, int[] gids, int runtimeFlags, int mountExternal,</span><br><span class="line">         String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span><br><span class="line">         long startTime) &#123;</span><br><span class="line">     //重置成员变量    </span><br><span class="line">     app.pendingStart = true;</span><br><span class="line">     app.killedByAm = false;</span><br><span class="line">     app.removed = false;</span><br><span class="line">     app.killed = false;</span><br><span class="line">     final long startSeq = app.startSeq = ++mProcStartSeqCounter;</span><br><span class="line">     app.setStartParams(uid, hostingType, hostingNameStr, seInfo, startTime);</span><br><span class="line">     //如果是异步</span><br><span class="line">     if (mConstants.FLAG_PROCESS_START_ASYNC) &#123;</span><br><span class="line">         if (DEBUG_PROCESSES) Slog.i(TAG_PROCESSES,</span><br><span class="line">                 &quot;Posting procStart msg for &quot; + app.toShortString());</span><br><span class="line">         //post到mProcStartHandlerThread线程</span><br><span class="line">         mProcStartHandler.post(() -&gt; &#123;</span><br><span class="line">             try &#123;</span><br><span class="line">                 synchronized (ActivityManagerService.this) &#123;</span><br><span class="line">                     final String reason = isProcStartValidLocked(app, startSeq);</span><br><span class="line">                     if (reason != null) &#123;</span><br><span class="line">                         Slog.w(TAG_PROCESSES, app + &quot; not valid anymore,&quot;</span><br><span class="line">                                 + &quot; don&apos;t start process, &quot; + reason);</span><br><span class="line">                         app.pendingStart = false;</span><br><span class="line">                         return;</span><br><span class="line">                     &#125;</span><br><span class="line">                     app.usingWrapper = invokeWith != null</span><br><span class="line">                             || SystemProperties.get(&quot;wrap.&quot; + app.processName) != null;</span><br><span class="line">                     mPendingStarts.put(startSeq, app);</span><br><span class="line">                 &#125;</span><br><span class="line">                 //见3.4.1节</span><br><span class="line">                 final ProcessStartResult startResult = startProcess(app.hostingType, entryPoint,</span><br><span class="line">                         app, app.startUid, gids, runtimeFlags, mountExternal, app.seInfo,</span><br><span class="line">                         requiredAbi, instructionSet, invokeWith, app.startTime);</span><br><span class="line">                 synchronized (ActivityManagerService.this) &#123;</span><br><span class="line">                     //见3.4.2节</span><br><span class="line">                     handleProcessStartedLocked(app, startResult, startSeq);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; catch (RuntimeException e) &#123;</span><br><span class="line">                 synchronized (ActivityManagerService.this) &#123;</span><br><span class="line">                     Slog.e(TAG, &quot;Failure starting process &quot; + app.processName, e);</span><br><span class="line">                     mPendingStarts.remove(startSeq);</span><br><span class="line">                     app.pendingStart = false;</span><br><span class="line">                     forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid),</span><br><span class="line">                             false, false, true, false, false,</span><br><span class="line">                             UserHandle.getUserId(app.userId), &quot;start failure&quot;);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         return true;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         //同步</span><br><span class="line">         try &#123;</span><br><span class="line">             final ProcessStartResult startResult = startProcess(hostingType, entryPoint, app,</span><br><span class="line">                     uid, gids, runtimeFlags, mountExternal, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                     invokeWith, startTime);</span><br><span class="line">             handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper,</span><br><span class="line">                     startSeq, false);</span><br><span class="line">         &#125; catch (RuntimeException e) &#123;</span><br><span class="line">             Slog.e(TAG, &quot;Failure starting process &quot; + app.processName, e);</span><br><span class="line">             app.pendingStart = false;</span><br><span class="line">             forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid),</span><br><span class="line">                     false, false, true, false, false,</span><br><span class="line">                     UserHandle.getUserId(app.userId), &quot;start failure&quot;);</span><br><span class="line">         &#125;</span><br><span class="line">         return app.pid &gt; 0;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-1-AMS-startProcess"><a href="#3-4-1-AMS-startProcess" class="headerlink" title="3.4.1  AMS.startProcess"></a>3.4.1  AMS.startProcess</h4><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private ProcessStartResult startProcess(String hostingType, String entryPoint,</span><br><span class="line">          ProcessRecord app, int uid, int[] gids, int runtimeFlags, int mountExternal,</span><br><span class="line">          String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span><br><span class="line">          long startTime) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">          Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;Start proc: &quot; +</span><br><span class="line">                  app.processName);</span><br><span class="line">          checkTime(startTime, &quot;startProcess: asking zygote to start proc&quot;);</span><br><span class="line">          final ProcessStartResult startResult;</span><br><span class="line">          if (hostingType.equals(&quot;webview_service&quot;)) &#123;</span><br><span class="line">              //webview进程启动</span><br><span class="line">              startResult = startWebView(entryPoint,</span><br><span class="line">                      app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                      app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                      app.info.dataDir, null,</span><br><span class="line">                      new String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              //启动进程，见3.5节</span><br><span class="line">              startResult = Process.start(entryPoint,</span><br><span class="line">                      app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                      app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                      app.info.dataDir, invokeWith,</span><br><span class="line">                      new String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          checkTime(startTime, &quot;startProcess: returned from zygote!&quot;);</span><br><span class="line">          return startResult;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">          Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-2-AMS-handleProcessStartedLocked"><a href="#3-4-2-AMS-handleProcessStartedLocked" class="headerlink" title="3.4.2  AMS.handleProcessStartedLocked"></a>3.4.2  AMS.handleProcessStartedLocked</h4><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">private boolean handleProcessStartedLocked(ProcessRecord app, int pid, boolean usingWrapper,</span><br><span class="line">           long expectedStartSeq, boolean procAttached) &#123;</span><br><span class="line">       mPendingStarts.remove(expectedStartSeq);</span><br><span class="line">       //检查进程启动是否合法，不合法则杀掉进程</span><br><span class="line">       final String reason = isProcStartValidLocked(app, expectedStartSeq);</span><br><span class="line">       if (reason != null) &#123;</span><br><span class="line">           Slog.w(TAG_PROCESSES, app + &quot; start not valid, killing pid=&quot; + pid</span><br><span class="line">                   + &quot;, &quot; + reason);</span><br><span class="line">           app.pendingStart = false;</span><br><span class="line">           Process.killProcessQuiet(pid);</span><br><span class="line">           Process.killProcessGroup(app.uid, app.pid);</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line">       //通知电池统计服务该进程启动</span><br><span class="line">       mBatteryStatsService.noteProcessStart(app.processName, app.info.uid);</span><br><span class="line">       checkTime(app.startTime, &quot;startProcess: done updating battery stats&quot;);</span><br><span class="line"></span><br><span class="line">       EventLog.writeEvent(EventLogTags.AM_PROC_START,</span><br><span class="line">               UserHandle.getUserId(app.startUid), pid, app.startUid,</span><br><span class="line">               app.processName, app.hostingType,</span><br><span class="line">               app.hostingNameStr != null ? app.hostingNameStr : &quot;&quot;);</span><br><span class="line"></span><br><span class="line">       try &#123;</span><br><span class="line">           AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid,</span><br><span class="line">                   app.seInfo, app.info.sourceDir, pid);</span><br><span class="line">       &#125; catch (RemoteException ex) &#123;</span><br><span class="line">           // Ignore</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (app.persistent) &#123;</span><br><span class="line">           Watchdog.getInstance().processStarted(app.processName, pid);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       checkTime(app.startTime, &quot;startProcess: building log message&quot;);</span><br><span class="line">       StringBuilder buf = mStringBuilder;</span><br><span class="line">       buf.setLength(0);</span><br><span class="line">       buf.append(&quot;Start proc &quot;);</span><br><span class="line">       buf.append(pid);</span><br><span class="line">       buf.append(&apos;:&apos;);</span><br><span class="line">       buf.append(app.processName);</span><br><span class="line">       buf.append(&apos;/&apos;);</span><br><span class="line">       UserHandle.formatUid(buf, app.startUid);</span><br><span class="line">       if (app.isolatedEntryPoint != null) &#123;</span><br><span class="line">           buf.append(&quot; [&quot;);</span><br><span class="line">           buf.append(app.isolatedEntryPoint);</span><br><span class="line">           buf.append(&quot;]&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">       buf.append(&quot; for &quot;);</span><br><span class="line">       buf.append(app.hostingType);</span><br><span class="line">       if (app.hostingNameStr != null) &#123;</span><br><span class="line">           buf.append(&quot; &quot;);</span><br><span class="line">           buf.append(app.hostingNameStr);</span><br><span class="line">       &#125;</span><br><span class="line">       //重置ProcessRecord变量</span><br><span class="line">       reportUidInfoMessageLocked(TAG, buf.toString(), app.startUid);</span><br><span class="line">       app.setPid(pid);</span><br><span class="line">       app.usingWrapper = usingWrapper;</span><br><span class="line">       app.pendingStart = false;</span><br><span class="line">       checkTime(app.startTime, &quot;startProcess: starting to update pids map&quot;);</span><br><span class="line">       ProcessRecord oldApp;</span><br><span class="line">       synchronized (mPidsSelfLocked) &#123;</span><br><span class="line">           oldApp = mPidsSelfLocked.get(pid);</span><br><span class="line">       &#125;</span><br><span class="line">       // If there is already an app occupying that pid that hasn&apos;t been cleaned up</span><br><span class="line">       if (oldApp != null &amp;&amp; !app.isolated) &#123;</span><br><span class="line">           // Clean up anything relating to this pid first</span><br><span class="line">           Slog.w(TAG, &quot;Reusing pid &quot; + pid</span><br><span class="line">                   + &quot; while app is still mapped to it&quot;);</span><br><span class="line">           cleanUpApplicationRecordLocked(oldApp, false, false, -1,</span><br><span class="line">                   true /*replacingPid*/);</span><br><span class="line">       &#125;</span><br><span class="line">       synchronized (mPidsSelfLocked) &#123;</span><br><span class="line">           //将创建的进程加入到mPidsSelfLocked</span><br><span class="line">           this.mPidsSelfLocked.put(pid, app);</span><br><span class="line">           if (!procAttached) &#123;</span><br><span class="line">               Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</span><br><span class="line">               msg.obj = app;</span><br><span class="line">               //延迟发送PROC_START_TIMEOUT消息</span><br><span class="line">               mHandler.sendMessageDelayed(msg, usingWrapper</span><br><span class="line">                       ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       checkTime(app.startTime, &quot;startProcess: done updating pids map&quot;);</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Process.start是通过socket通信通知Zygote创建fork子进程，创建新进程后将ActivityThread类加入到新进程中，并调用ActivityThread.main方法，详细可以参考Android进程创建流程，接下来进入AT.main方法</p>
<h3 id="3-5-AT-main"><a href="#3-5-AT-main" class="headerlink" title="3.5 AT.main"></a>3.5 AT.main</h3><p>[-&gt;ActivityThread.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;ActivityThreadMain&quot;);</span><br><span class="line"></span><br><span class="line">       // CloseGuard defaults to true and can be quite spammy.  We</span><br><span class="line">       // disable it here, but selectively enable it later (via</span><br><span class="line">       // StrictMode) on debug builds, but using DropBox, not logs.</span><br><span class="line">       //性能统计默认关闭</span><br><span class="line">       CloseGuard.setEnabled(false);</span><br><span class="line">       //将当前进程所在的userID赋值给sCurrentUser</span><br><span class="line">       Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">       // Make sure TrustedCertificateStore looks in the right place for CA certificates</span><br><span class="line">       //确保可信任的CA证书放在正确的位置</span><br><span class="line">       final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">       TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">       Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);</span><br><span class="line">       //创建主线程looper</span><br><span class="line">       Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">       // Find the value for &#123;@link #PROC_START_SEQ_IDENT&#125; if provided on the command line.</span><br><span class="line">       // It will be in the format &quot;seq=114&quot;</span><br><span class="line">       long startSeq = 0;</span><br><span class="line">       if (args != null) &#123;</span><br><span class="line">           for (int i = args.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">               if (args[i] != null &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) &#123;</span><br><span class="line">                   startSeq = Long.parseLong(</span><br><span class="line">                           args[i].substring(PROC_START_SEQ_IDENT.length()));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       //创建ActivityThread对象</span><br><span class="line">       ActivityThread thread = new ActivityThread();</span><br><span class="line">       //见3.6节</span><br><span class="line">       thread.attach(false, startSeq);</span><br><span class="line"></span><br><span class="line">       if (sMainThreadHandler == null) &#123;</span><br><span class="line">           sMainThreadHandler = thread.getHandler();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (false) &#123;</span><br><span class="line">           Looper.myLooper().setMessageLogging(new</span><br><span class="line">                   LogPrinter(Log.DEBUG, &quot;ActivityThread&quot;));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // End of event ActivityThreadMain.</span><br><span class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">       //主线程进入循环状态</span><br><span class="line">       Looper.loop();</span><br><span class="line"></span><br><span class="line">       throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>1.创建主线程的Looper对象，该主线程的Looper是在进程创建完成后自动创建完成的，如果子线程中要通过handler通信，那么需要手动创建Looper对象，并且每个线程只能创建一次。</p>
<p>2.创建ActivityThread thread = new ActivityThread();这个过程中汇初始化几个重要的变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApplicationThread mAppThread = new ApplicationThread();</span><br><span class="line">Looper mLooper = Looper.myLooper();</span><br><span class="line">H mH = new H(); //其中H继承Handler，用于处理组件的生命周期</span><br></pre></td></tr></table></figure>
<p>3.attach过程是当前主线程向systemserver进程通信的过程，将thread信息通知AMS</p>
<p>4.sMainThreadHandler通过getHandler获取的对象正是mH，这是主线程的handler对象。</p>
<p>5.之后主线程调用 Looper.loop()进入消息循环状态，当没有消息时主线程进入休眠状态，一旦有消息来则唤醒主线程并执行相关的操作。</p>
<h3 id="3-6-AT-attach"><a href="#3-6-AT-attach" class="headerlink" title="3.6 AT.attach"></a>3.6 AT.attach</h3><p>[-&gt;ActivityThread.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">private void attach(boolean system, long startSeq) &#123;</span><br><span class="line">      sCurrentActivityThread = this;</span><br><span class="line">      mSystemThread = system;</span><br><span class="line">      //非系统</span><br><span class="line">      if (!system) &#123;</span><br><span class="line">          //开启虚拟机的jit即时编译功能</span><br><span class="line">          android.ddm.DdmHandleAppName.setAppName(&quot;&lt;pre-initialized&gt;&quot;,</span><br><span class="line">                                                  UserHandle.myUserId());</span><br><span class="line">          RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">          //获取AMS的代理对象</span><br><span class="line">          final IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">          try &#123;</span><br><span class="line">              //见3.7，调用AMS的attachApplication方法</span><br><span class="line">              mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">          &#125; catch (RemoteException ex) &#123;</span><br><span class="line">              throw ex.rethrowFromSystemServer();</span><br><span class="line">          &#125;</span><br><span class="line">          // Watch for getting close to heap limit.</span><br><span class="line">          //观察是否快接近heap的上限</span><br><span class="line">          BinderInternal.addGcWatcher(new Runnable() &#123;</span><br><span class="line">              @Override public void run() &#123;</span><br><span class="line">                  if (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                      return;</span><br><span class="line">                  &#125;</span><br><span class="line">                  Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                  long dalvikMax = runtime.maxMemory();</span><br><span class="line">                  long dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                  //当已用内存超过最大内存的3/4，则请求释放内存空间</span><br><span class="line">                  if (dalvikUsed &gt; ((3*dalvikMax)/4)) &#123;</span><br><span class="line">                      if (DEBUG_MEMORY_TRIM) Slog.d(TAG, &quot;Dalvik max=&quot; + (dalvikMax/1024)</span><br><span class="line">                              + &quot; total=&quot; + (runtime.totalMemory()/1024)</span><br><span class="line">                              + &quot; used=&quot; + (dalvikUsed/1024));</span><br><span class="line">                      mSomeActivitiesChanged = false;</span><br><span class="line">                      try &#123;</span><br><span class="line">                          mgr.releaseSomeActivities(mAppThread);</span><br><span class="line">                      &#125; catch (RemoteException e) &#123;</span><br><span class="line">                          throw e.rethrowFromSystemServer();</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          // Don&apos;t set application object here -- if the system crashes,</span><br><span class="line">          // we can&apos;t display an alert, we just want to die die die.</span><br><span class="line">          //系统走这里</span><br><span class="line">          android.ddm.DdmHandleAppName.setAppName(&quot;system_process&quot;,</span><br><span class="line">                  UserHandle.myUserId());</span><br><span class="line">          try &#123;</span><br><span class="line">              mInstrumentation = new Instrumentation();</span><br><span class="line">              mInstrumentation.basicInit(this);</span><br><span class="line">              //创建context</span><br><span class="line">              ContextImpl context = ContextImpl.createAppContext(</span><br><span class="line">                      this, getSystemContext().mPackageInfo);</span><br><span class="line">              mInitialApplication = context.mPackageInfo.makeApplication(true, null);</span><br><span class="line">              mInitialApplication.onCreate();</span><br><span class="line">          &#125; catch (Exception e) &#123;</span><br><span class="line">              throw new RuntimeException(</span><br><span class="line">                      &quot;Unable to instantiate Application():&quot; + e.toString(), e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      //添加config回调接口</span><br><span class="line">      ViewRootImpl.ConfigChangedCallback configChangedCallback</span><br><span class="line">              = (Configuration globalConfig) -&gt; &#123;</span><br><span class="line">          synchronized (mResourcesManager) &#123;</span><br><span class="line">              // We need to apply this change to the resources immediately, because upon returning</span><br><span class="line">              // the view hierarchy will be informed about it.</span><br><span class="line">              if (mResourcesManager.applyConfigurationToResourcesLocked(globalConfig,</span><br><span class="line">                      null /* compat */)) &#123;</span><br><span class="line">                  updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                          mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">                  // This actually changed the resources! Tell everyone about it.</span><br><span class="line">                  if (mPendingConfiguration == null</span><br><span class="line">                          || mPendingConfiguration.isOtherSeqNewer(globalConfig)) &#123;</span><br><span class="line">                      mPendingConfiguration = globalConfig;</span><br><span class="line">                      sendMessage(H.CONFIGURATION_CHANGED, globalConfig);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      ViewRootImpl.addConfigCallback(configChangedCallback);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>对于非系统处理过程如下：</p>
<p>1.创建线程来开启虚拟机的jit即时编译功能</p>
<p>2.通过Binder机制，调用AMS.attachApplication方法</p>
<p>3.观察虚拟机内存是否快接近heap的上限，当已用内存超过最大内存3/4，则释放内存空间</p>
<p>4.添加config回调接口</p>
<h3 id="3-7-AMS-attachApplication"><a href="#3-7-AMS-attachApplication" class="headerlink" title="3.7 AMS.attachApplication"></a>3.7 AMS.attachApplication</h3><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public final void attachApplication(IApplicationThread thread, long startSeq) &#123;</span><br><span class="line">       synchronized (this) &#123;</span><br><span class="line">           int callingPid = Binder.getCallingPid();</span><br><span class="line">           final int callingUid = Binder.getCallingUid();</span><br><span class="line">           final long origId = Binder.clearCallingIdentity();</span><br><span class="line">           //见3.8节</span><br><span class="line">           attachApplicationLocked(thread, callingPid, callingUid, startSeq);</span><br><span class="line">           Binder.restoreCallingIdentity(origId);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-8-AMS-attachApplicationLocked"><a href="#3-8-AMS-attachApplicationLocked" class="headerlink" title="3.8 AMS.attachApplicationLocked"></a>3.8 AMS.attachApplicationLocked</h3><p>[-&gt;ActivityManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br></pre></td><td class="code"><pre><span class="line">private final boolean attachApplicationLocked(IApplicationThread thread,</span><br><span class="line">           int pid, int callingUid, long startSeq) &#123;</span><br><span class="line"></span><br><span class="line">       // Find the application record that is being attached...  either via</span><br><span class="line">       // the pid if we are running in multiple processes, or just pull the</span><br><span class="line">       // next app record if we are emulating process with anonymous threads.</span><br><span class="line">       //通过pid获取ProcessRecord</span><br><span class="line">       ProcessRecord app;</span><br><span class="line">       long startTime = SystemClock.uptimeMillis();</span><br><span class="line">       long bindApplicationTimeMillis;</span><br><span class="line">       if (pid != MY_PID &amp;&amp; pid &gt;= 0) &#123;</span><br><span class="line">           synchronized (mPidsSelfLocked) &#123;</span><br><span class="line">               app = mPidsSelfLocked.get(pid);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           app = null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // It&apos;s possible that process called attachApplication before we got a chance to</span><br><span class="line">       // update the internal state.</span><br><span class="line">       //在得到机会更新之前，就调用了attachApplication方法</span><br><span class="line">       if (app == null &amp;&amp; startSeq &gt; 0) &#123;</span><br><span class="line">           final ProcessRecord pending = mPendingStarts.get(startSeq);</span><br><span class="line">           if (pending != null &amp;&amp; pending.startUid == callingUid</span><br><span class="line">                   &amp;&amp; handleProcessStartedLocked(pending, pid, pending.usingWrapper,</span><br><span class="line">                           startSeq, true)) &#123;</span><br><span class="line">               app = pending;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (app == null) &#123;</span><br><span class="line">           Slog.w(TAG, &quot;No pending application record for pid &quot; + pid</span><br><span class="line">                   + &quot; (IApplicationThread &quot; + thread + &quot;); dropping process&quot;);</span><br><span class="line">           EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</span><br><span class="line">           if (pid &gt; 0 &amp;&amp; pid != MY_PID) &#123;</span><br><span class="line">               //ProcessRecord为空，则杀掉该进程</span><br><span class="line">               killProcessQuiet(pid);</span><br><span class="line">               //TODO: killProcessGroup(app.info.uid, pid);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                   //退出新建进程的looper</span><br><span class="line">                   thread.scheduleExit();</span><br><span class="line">               &#125; catch (Exception e) &#123;</span><br><span class="line">                   // Ignore exceptions.</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // If this application record is still attached to a previous</span><br><span class="line">       // process, clean it up now.</span><br><span class="line">       //刚刚进入attach过程，thread应该为null,如果不为null,则表示app在上一个进程，则清空</span><br><span class="line">       if (app.thread != null) &#123;</span><br><span class="line">           handleAppDiedLocked(app, true, true);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Tell the process all about itself.</span><br><span class="line"></span><br><span class="line">       if (DEBUG_ALL) Slog.v(</span><br><span class="line">               TAG, &quot;Binding process pid &quot; + pid + &quot; to record &quot; + app);</span><br><span class="line"></span><br><span class="line">       final String processName = app.processName;</span><br><span class="line">       try &#123;</span><br><span class="line">           //绑定死亡通知</span><br><span class="line">           AppDeathRecipient adr = new AppDeathRecipient(</span><br><span class="line">                   app, pid, thread);</span><br><span class="line">           thread.asBinder().linkToDeath(adr, 0);</span><br><span class="line">           app.deathRecipient = adr;</span><br><span class="line">       &#125; catch (RemoteException e) &#123;</span><br><span class="line">           app.resetPackageList(mProcessStats);</span><br><span class="line">           //重新启动进程</span><br><span class="line">           startProcessLocked(app, &quot;link fail&quot;, processName);</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);</span><br><span class="line">        </span><br><span class="line">       //重置进程信息，执行完后app.thread不再为空 </span><br><span class="line">       app.makeActive(thread, mProcessStats);</span><br><span class="line">       app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">       app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">       app.forcingToImportant = null;</span><br><span class="line">       updateProcessForegroundLocked(app, false, false);</span><br><span class="line">       app.hasShownUi = false;</span><br><span class="line">       app.debugging = false;</span><br><span class="line">       app.cached = false;</span><br><span class="line">       app.killedByAm = false;</span><br><span class="line">       app.killed = false;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       // We carefully use the same state that PackageManager uses for</span><br><span class="line">       // filtering, since we use this flag to decide if we need to install</span><br><span class="line">       // providers when user is unlocked later</span><br><span class="line">       //用户是否解锁</span><br><span class="line">       app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);</span><br><span class="line">       </span><br><span class="line">       //移除进程启动超时的通知</span><br><span class="line">       mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">       </span><br><span class="line">       //系统处于ready状态或者app为FLAG_PERSISTENT进程，则为true</span><br><span class="line">       boolean normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line">       //查询正在启动中的provider</span><br><span class="line">       List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : null;</span><br><span class="line"></span><br><span class="line">       //app进程存在启动中的provider，超时10s后发送CONTENT_PROVIDER_PUBLISH_TIMEOUT消息</span><br><span class="line">       if (providers != null &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</span><br><span class="line">           Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</span><br><span class="line">           msg.obj = app;</span><br><span class="line">           mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       checkTime(startTime, &quot;attachApplicationLocked: before bindApplication&quot;);</span><br><span class="line"></span><br><span class="line">       if (!normalMode) &#123;</span><br><span class="line">           Slog.i(TAG, &quot;Launching preboot mode app: &quot; + app);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (DEBUG_ALL) Slog.v(</span><br><span class="line">           TAG, &quot;New app record &quot; + app</span><br><span class="line">           + &quot; thread=&quot; + thread.asBinder() + &quot; pid=&quot; + pid);</span><br><span class="line">       try &#123;</span><br><span class="line">           int testMode = ApplicationThreadConstants.DEBUG_OFF;</span><br><span class="line">           if (mDebugApp != null &amp;&amp; mDebugApp.equals(processName)) &#123;</span><br><span class="line">               testMode = mWaitForDebugger</span><br><span class="line">                   ? ApplicationThreadConstants.DEBUG_WAIT</span><br><span class="line">                   : ApplicationThreadConstants.DEBUG_ON;</span><br><span class="line">               app.debugging = true;</span><br><span class="line">               if (mDebugTransient) &#123;</span><br><span class="line">                   mDebugApp = mOrigDebugApp;</span><br><span class="line">                   mWaitForDebugger = mOrigWaitForDebugger;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           boolean enableTrackAllocation = false;</span><br><span class="line">           if (mTrackAllocationApp != null &amp;&amp; mTrackAllocationApp.equals(processName)) &#123;</span><br><span class="line">               enableTrackAllocation = true;</span><br><span class="line">               mTrackAllocationApp = null;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // If the app is being launched for restore or full backup, set it up specially</span><br><span class="line">           //备份模式</span><br><span class="line">           boolean isRestrictedBackupMode = false;</span><br><span class="line">           if (mBackupTarget != null &amp;&amp; mBackupAppName.equals(processName)) &#123;</span><br><span class="line">               isRestrictedBackupMode = mBackupTarget.appInfo.uid &gt;= FIRST_APPLICATION_UID</span><br><span class="line">                       &amp;&amp; ((mBackupTarget.backupMode == BackupRecord.RESTORE)</span><br><span class="line">                               || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL)</span><br><span class="line">                               || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL));</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (app.instr != null) &#123;</span><br><span class="line">               notifyPackageUse(app.instr.mClass.getPackageName(),</span><br><span class="line">                                PackageManager.NOTIFY_PACKAGE_USE_INSTRUMENTATION);</span><br><span class="line">           &#125;</span><br><span class="line">           if (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, &quot;Binding proc &quot;</span><br><span class="line">                   + processName + &quot; with config &quot; + getGlobalConfiguration());</span><br><span class="line">           </span><br><span class="line">           //获取应用的ApplicationInfo</span><br><span class="line">           ApplicationInfo appInfo = app.instr != null ? app.instr.mTargetInfo : app.info;</span><br><span class="line">           app.compat = compatibilityInfoForPackageLocked(appInfo);</span><br><span class="line"></span><br><span class="line">           //统计信息</span><br><span class="line">           ProfilerInfo profilerInfo = null;</span><br><span class="line">           String preBindAgent = null;</span><br><span class="line">           if (mProfileApp != null &amp;&amp; mProfileApp.equals(processName)) &#123;</span><br><span class="line">               mProfileProc = app;</span><br><span class="line">               if (mProfilerInfo != null) &#123;</span><br><span class="line">                   // Send a profiler info object to the app if either a file is given, or</span><br><span class="line">                   // an agent should be loaded at bind-time.</span><br><span class="line">                   boolean needsInfo = mProfilerInfo.profileFile != null</span><br><span class="line">                           || mProfilerInfo.attachAgentDuringBind;</span><br><span class="line">                   profilerInfo = needsInfo ? new ProfilerInfo(mProfilerInfo) : null;</span><br><span class="line">                   if (mProfilerInfo.agent != null) &#123;</span><br><span class="line">                       preBindAgent = mProfilerInfo.agent;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; else if (app.instr != null &amp;&amp; app.instr.mProfileFile != null) &#123;</span><br><span class="line">               profilerInfo = new ProfilerInfo(app.instr.mProfileFile, null, 0, false, false,</span><br><span class="line">                       null, false);</span><br><span class="line">           &#125;</span><br><span class="line">           if (mAppAgentMap != null &amp;&amp; mAppAgentMap.containsKey(processName)) &#123;</span><br><span class="line">               // We need to do a debuggable check here. See setAgentApp for why the check is</span><br><span class="line">               // postponed to here.</span><br><span class="line">               if ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0) &#123;</span><br><span class="line">                   String agent = mAppAgentMap.get(processName);</span><br><span class="line">                   // Do not overwrite already requested agent.</span><br><span class="line">                   if (profilerInfo == null) &#123;</span><br><span class="line">                       profilerInfo = new ProfilerInfo(null, null, 0, false, false,</span><br><span class="line">                               mAppAgentMap.get(processName), true);</span><br><span class="line">                   &#125; else if (profilerInfo.agent == null) &#123;</span><br><span class="line">                       profilerInfo = profilerInfo.setAgent(mAppAgentMap.get(processName), true);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (profilerInfo != null &amp;&amp; profilerInfo.profileFd != null) &#123;</span><br><span class="line">               profilerInfo.profileFd = profilerInfo.profileFd.dup();</span><br><span class="line">               if (TextUtils.equals(mProfileApp, processName) &amp;&amp; mProfilerInfo != null) &#123;</span><br><span class="line">                   clearProfilerLocked();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // We deprecated Build.SERIAL and it is not accessible to</span><br><span class="line">           // apps that target the v2 security sandbox and to apps that</span><br><span class="line">           // target APIs higher than O MR1. Since access to the serial</span><br><span class="line">           // is now behind a permission we push down the value.</span><br><span class="line">           //buildSerial根据不同版本初始化</span><br><span class="line">           final String buildSerial = (appInfo.targetSandboxVersion &lt; 2</span><br><span class="line">                   &amp;&amp; appInfo.targetSdkVersion &lt; Build.VERSION_CODES.P)</span><br><span class="line">                           ? sTheRealBuildSerial : Build.UNKNOWN;</span><br><span class="line"></span><br><span class="line">           // Check if this is a secondary process that should be incorporated into some</span><br><span class="line">           // currently active instrumentation.  (Note we do this AFTER all of the profiling</span><br><span class="line">           // stuff above because profiling can currently happen only in the primary</span><br><span class="line">           // instrumentation process.)</span><br><span class="line">           //检查是否第二个进程合并到最近的instrumentation</span><br><span class="line">           if (mActiveInstrumentation.size() &gt; 0 &amp;&amp; app.instr == null) &#123;</span><br><span class="line">               for (int i = mActiveInstrumentation.size() - 1; i &gt;= 0 &amp;&amp; app.instr == null; i--) &#123;</span><br><span class="line">                   ActiveInstrumentation aInstr = mActiveInstrumentation.get(i);</span><br><span class="line">                   if (!aInstr.mFinished &amp;&amp; aInstr.mTargetInfo.uid == app.uid) &#123;</span><br><span class="line">                       if (aInstr.mTargetProcesses.length == 0) &#123;</span><br><span class="line">                           // This is the wildcard mode, where every process brought up for</span><br><span class="line">                           // the target instrumentation should be included.</span><br><span class="line">                           if (aInstr.mTargetInfo.packageName.equals(app.info.packageName)) &#123;</span><br><span class="line">                               app.instr = aInstr;</span><br><span class="line">                               aInstr.mRunningProcesses.add(app);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125; else &#123;</span><br><span class="line">                           for (String proc : aInstr.mTargetProcesses) &#123;</span><br><span class="line">                               if (proc.equals(app.processName)) &#123;</span><br><span class="line">                                   app.instr = aInstr;</span><br><span class="line">                                   aInstr.mRunningProcesses.add(app);</span><br><span class="line">                                   break;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // If we were asked to attach an agent on startup, do so now, before we&apos;re binding</span><br><span class="line">           // application code.</span><br><span class="line">           //绑定代理</span><br><span class="line">           if (preBindAgent != null) &#123;</span><br><span class="line">               thread.attachAgent(preBindAgent);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           // Figure out whether the app needs to run in autofill compat mode.</span><br><span class="line">           boolean isAutofillCompatEnabled = false;</span><br><span class="line">           if (UserHandle.getAppId(app.info.uid) &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">               final AutofillManagerInternal afm = LocalServices.getService(</span><br><span class="line">                       AutofillManagerInternal.class);</span><br><span class="line">               if (afm != null) &#123;</span><br><span class="line">                   isAutofillCompatEnabled = afm.isCompatibilityModeRequested(</span><br><span class="line">                           app.info.packageName, app.info.versionCode, app.userId);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           checkTime(startTime, &quot;attachApplicationLocked: immediately before bindApplication&quot;);</span><br><span class="line">           bindApplicationTimeMillis = SystemClock.elapsedRealtime();</span><br><span class="line">           mStackSupervisor.getActivityMetricsLogger().notifyBindApplication(app);</span><br><span class="line">           if (app.isolatedEntryPoint != null) &#123;</span><br><span class="line">               // This is an isolated process which should just call an entry point instead of</span><br><span class="line">               // being bound to an application.</span><br><span class="line">               //孤立进程</span><br><span class="line">               thread.runIsolatedEntryPoint(app.isolatedEntryPoint, app.isolatedEntryPointArgs);</span><br><span class="line">           &#125; else if (app.instr != null) &#123; </span><br><span class="line">               //instr不为空，绑定应用</span><br><span class="line">               thread.bindApplication(processName, appInfo, providers,</span><br><span class="line">                       app.instr.mClass,</span><br><span class="line">                       profilerInfo, app.instr.mArguments,</span><br><span class="line">                       app.instr.mWatcher,</span><br><span class="line">                       app.instr.mUiAutomationConnection, testMode,</span><br><span class="line">                       mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                       isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                       new Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                       getCommonServicesLocked(app.isolated),</span><br><span class="line">                       mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                       buildSerial, isAutofillCompatEnabled);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               //绑定应用，见3.9节</span><br><span class="line">               thread.bindApplication(processName, appInfo, providers, null, profilerInfo,</span><br><span class="line">                       null, null, null, testMode,</span><br><span class="line">                       mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                       isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                       new Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                       getCommonServicesLocked(app.isolated),</span><br><span class="line">                       mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                       buildSerial, isAutofillCompatEnabled);</span><br><span class="line">           &#125;</span><br><span class="line">           if (profilerInfo != null) &#123;</span><br><span class="line">               profilerInfo.closeFd();</span><br><span class="line">               profilerInfo = null;</span><br><span class="line">           &#125;</span><br><span class="line">           checkTime(startTime, &quot;attachApplicationLocked: immediately after bindApplication&quot;);</span><br><span class="line">           //更新LRU进程队列</span><br><span class="line">           updateLruProcessLocked(app, false, null);</span><br><span class="line">           checkTime(startTime, &quot;attachApplicationLocked: after updateLruProcessLocked&quot;);</span><br><span class="line">           app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line">           // todo: Yikes!  What should we do?  For now we will try to</span><br><span class="line">           // start another process, but that could easily get us in</span><br><span class="line">           // an infinite loop of restarting processes...</span><br><span class="line">           Slog.wtf(TAG, &quot;Exception thrown during bind of &quot; + app, e);</span><br><span class="line"></span><br><span class="line">           app.resetPackageList(mProcessStats);</span><br><span class="line">           app.unlinkDeathRecipient();</span><br><span class="line">           //失败，重新启动进程，可能导致无限制的重启</span><br><span class="line">           startProcessLocked(app, &quot;bind fail&quot;, processName);</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Remove this record from the list of starting applications.</span><br><span class="line">       mPersistentStartingProcesses.remove(app);</span><br><span class="line">       if (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</span><br><span class="line">               &quot;Attach application locked removing on hold: &quot; + app);</span><br><span class="line">       mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">       boolean badApp = false;</span><br><span class="line">       boolean didSomething = false;</span><br><span class="line"></span><br><span class="line">       // See if the top visible activity is waiting to run in this process...</span><br><span class="line">       //Activity 检查最顶层的activity是否等待在该进程中运行</span><br><span class="line">       if (normalMode) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               if (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                   didSomething = true;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               Slog.wtf(TAG, &quot;Exception thrown launching activities in &quot; + app, e);</span><br><span class="line">               badApp = true;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Find any services that should be running in this process...</span><br><span class="line">       //services ：找到所有需要在该进程中运行的服务</span><br><span class="line">       if (!badApp) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">               checkTime(startTime, &quot;attachApplicationLocked: after mServices.attachApplicationLocked&quot;);</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               Slog.wtf(TAG, &quot;Exception thrown starting services in &quot; + app, e);</span><br><span class="line">               badApp = true;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Check if a next-broadcast receiver is in this process...</span><br><span class="line">       //broadcast：检查是否在这个进程中有下一个广播接收者</span><br><span class="line">       if (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               didSomething |= sendPendingBroadcastsLocked(app);</span><br><span class="line">               checkTime(startTime, &quot;attachApplicationLocked: after sendPendingBroadcastsLocked&quot;);</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               // If the app died trying to launch the receiver we declare it &apos;bad&apos;</span><br><span class="line">               Slog.wtf(TAG, &quot;Exception thrown dispatching broadcasts in &quot; + app, e);</span><br><span class="line">               badApp = true;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Check whether the next backup agent is in this process...</span><br><span class="line">       //检查是否在这个进程中有下一个backup代理</span><br><span class="line">       if (!badApp &amp;&amp; mBackupTarget != null &amp;&amp; mBackupTarget.app == app) &#123;</span><br><span class="line">           if (DEBUG_BACKUP) Slog.v(TAG_BACKUP,</span><br><span class="line">                   &quot;New app is backup target, launching agent for &quot; + app);</span><br><span class="line">           notifyPackageUse(mBackupTarget.appInfo.packageName,</span><br><span class="line">                            PackageManager.NOTIFY_PACKAGE_USE_BACKUP);</span><br><span class="line">           try &#123;</span><br><span class="line">               thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,</span><br><span class="line">                       compatibilityInfoForPackageLocked(mBackupTarget.appInfo),</span><br><span class="line">                       mBackupTarget.backupMode);</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               Slog.wtf(TAG, &quot;Exception thrown creating backup agent in &quot; + app, e);</span><br><span class="line">               badApp = true;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (badApp) &#123;  //杀掉bad应用</span><br><span class="line">           app.kill(&quot;error during init&quot;, true);</span><br><span class="line">           handleAppDiedLocked(app, false, true);</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (!didSomething) &#123;</span><br><span class="line">           updateOomAdjLocked();  //更新adj</span><br><span class="line">           checkTime(startTime, &quot;attachApplicationLocked: after updateOomAdjLocked&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       StatsLog.write(</span><br><span class="line">               StatsLog.PROCESS_START_TIME,</span><br><span class="line">               app.info.uid,</span><br><span class="line">               app.pid,</span><br><span class="line">               app.info.packageName,</span><br><span class="line">               StatsLog.PROCESS_START_TIME__TYPE__COLD,</span><br><span class="line">               app.startTime,</span><br><span class="line">               (int) (bindApplicationTimeMillis - app.startTime),</span><br><span class="line">               (int) (SystemClock.elapsedRealtime() - app.startTime),</span><br><span class="line">               app.hostingType,</span><br><span class="line">               (app.hostingNameStr != null ? app.hostingNameStr : &quot;&quot;));</span><br><span class="line"></span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>1.根据pid查询相应的ProcessRecord对象中的app</p>
<p>2.当app==null,如果进程存在则杀掉进程或者停止looper后返回</p>
<p>3.还刚进入attach过程，app.thread不为null,若不为null,则表示该app在上一个进程，则调用handleAppDiedLocked清理</p>
<p>4.绑定死亡通知，如果进程pid死亡，则会通过binder死亡回调来通知systemserver进程死亡的消息</p>
<p>5.重置ProcessRecord的进程信息，此时app.thread赋值，不为空</p>
<p>6.app进程存在正在启动中的provider，则超时10s发送消息</p>
<p>7.调用thread.bindApplication绑定应用进程</p>
<p>8.处理Activity，Service，Broadcast相应流程</p>
<h3 id="3-9-AT-bindApplication"><a href="#3-9-AT-bindApplication" class="headerlink" title="3.9 AT.bindApplication"></a>3.9 AT.bindApplication</h3><p>[-&gt;ActivityThread.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">public final void bindApplication(String processName, ApplicationInfo appInfo,</span><br><span class="line">              List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span><br><span class="line">              ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span><br><span class="line">              IInstrumentationWatcher instrumentationWatcher,</span><br><span class="line">              IUiAutomationConnection instrumentationUiConnection, int debugMode,</span><br><span class="line">              boolean enableBinderTracking, boolean trackAllocation,</span><br><span class="line">              boolean isRestrictedBackupMode, boolean persistent, Configuration config,</span><br><span class="line">              CompatibilityInfo compatInfo, Map services, Bundle coreSettings,</span><br><span class="line">              String buildSerial, boolean autofillCompatibilityEnabled) &#123;</span><br><span class="line"></span><br><span class="line">          if (services != null) &#123;</span><br><span class="line">              if (false) &#123;</span><br><span class="line">                  // Test code to make sure the app could see the passed-in services.</span><br><span class="line">                  for (Object oname : services.keySet()) &#123;</span><br><span class="line">                      if (services.get(oname) == null) &#123;</span><br><span class="line">                          continue; // AM just passed in a null service.</span><br><span class="line">                      &#125;</span><br><span class="line">                      String name = (String) oname;</span><br><span class="line"></span><br><span class="line">                      // See b/79378449 about the following exemption.</span><br><span class="line">                      switch (name) &#123;</span><br><span class="line">                          case &quot;package&quot;:</span><br><span class="line">                          case Context.WINDOW_SERVICE:</span><br><span class="line">                              continue;</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      if (ServiceManager.getService(name) == null) &#123;</span><br><span class="line">                          Log.wtf(TAG, &quot;Service &quot; + name + &quot; should be accessible by this app&quot;);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              // Setup the service cache in the ServiceManager</span><br><span class="line">              //将Service缓存，减少binder调用次数</span><br><span class="line">              ServiceManager.initServiceCache(services);</span><br><span class="line">          &#125;</span><br><span class="line">          //发送H.SET_CORE_SETTINGS消息</span><br><span class="line">          setCoreSettings(coreSettings);</span><br><span class="line"></span><br><span class="line">          AppBindData data = new AppBindData();</span><br><span class="line">          data.processName = processName;</span><br><span class="line">          data.appInfo = appInfo;</span><br><span class="line">          data.providers = providers;</span><br><span class="line">          data.instrumentationName = instrumentationName;</span><br><span class="line">          data.instrumentationArgs = instrumentationArgs;</span><br><span class="line">          data.instrumentationWatcher = instrumentationWatcher;</span><br><span class="line">          data.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br><span class="line">          data.debugMode = debugMode;</span><br><span class="line">          data.enableBinderTracking = enableBinderTracking;</span><br><span class="line">          data.trackAllocation = trackAllocation;</span><br><span class="line">          data.restrictedBackupMode = isRestrictedBackupMode;</span><br><span class="line">          data.persistent = persistent;</span><br><span class="line">          data.config = config;</span><br><span class="line">          data.compatInfo = compatInfo;</span><br><span class="line">          data.initProfilerInfo = profilerInfo;</span><br><span class="line">          data.buildSerial = buildSerial;</span><br><span class="line">          data.autofillCompatibilityEnabled = autofillCompatibilityEnabled;</span><br><span class="line">          sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>发送H.SET_CORE_SETTINGS、H.BIND_APPLICATION消息到主线程</p>
<h3 id="3-10-H-handleMessage"><a href="#3-10-H-handleMessage" class="headerlink" title="3.10 H.handleMessage"></a>3.10 H.handleMessage</h3><p>[-&gt;ActivityThread.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class H extends Handler &#123;</span><br><span class="line">...</span><br><span class="line">     public void handleMessage(Message msg) &#123;</span><br><span class="line">           if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what));</span><br><span class="line">           switch (msg.what) &#123;</span><br><span class="line">               case SET_CORE_SETTINGS:</span><br><span class="line">                   Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;setCoreSettings&quot;);</span><br><span class="line">                   handleSetCoreSettings((Bundle) msg.obj);</span><br><span class="line">                   Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">               case BIND_APPLICATION:</span><br><span class="line">                   Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;bindApplication&quot;);</span><br><span class="line">                   AppBindData data = (AppBindData)msg.obj;</span><br><span class="line">                   handleBindApplication(data);</span><br><span class="line">                   Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                   break;</span><br><span class="line">                   ...</span><br><span class="line">             &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-11-AT-handleSetCoreSettings"><a href="#3-11-AT-handleSetCoreSettings" class="headerlink" title="3.11 AT.handleSetCoreSettings"></a>3.11 AT.handleSetCoreSettings</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void handleSetCoreSettings(Bundle coreSettings) &#123;</span><br><span class="line">     synchronized (mResourcesManager) &#123;</span><br><span class="line">         mCoreSettings = coreSettings;</span><br><span class="line">     &#125;</span><br><span class="line">     onCoreSettingsChange();</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">  private void onCoreSettingsChange() &#123;</span><br><span class="line">     boolean debugViewAttributes =</span><br><span class="line">             mCoreSettings.getInt(Settings.Global.DEBUG_VIEW_ATTRIBUTES, 0) != 0;</span><br><span class="line">     if (debugViewAttributes != View.mDebugViewAttributes) &#123;</span><br><span class="line">         View.mDebugViewAttributes = debugViewAttributes;</span><br><span class="line"> </span><br><span class="line">         // request all activities to relaunch for the changes to take place</span><br><span class="line">         //发生改变，请求所有的activity重新启动</span><br><span class="line">         relaunchAllActivities();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-12-AT-handleBindApplication"><a href="#3-12-AT-handleBindApplication" class="headerlink" title="3.12 AT.handleBindApplication"></a>3.12 AT.handleBindApplication</h3><p>[-&gt;ActivityThread.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br></pre></td><td class="code"><pre><span class="line">private void handleBindApplication(AppBindData data) &#123;</span><br><span class="line">       // Register the UI Thread as a sensitive thread to the runtime.</span><br><span class="line">       VMRuntime.registerSensitiveThread();</span><br><span class="line">       // In the case the stack depth property exists, pass it down to the runtime.</span><br><span class="line">       String property = SystemProperties.get(&quot;debug.allocTracker.stackDepth&quot;);</span><br><span class="line">       if (property.length() != 0) &#123;</span><br><span class="line">           VMDebug.setAllocTrackerStackDepth(Integer.parseInt(property));</span><br><span class="line">       &#125;</span><br><span class="line">       if (data.trackAllocation) &#123;</span><br><span class="line">           DdmVmInternal.enableRecentAllocations(true);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Note when this process has started.</span><br><span class="line">       //记录进程开始时间</span><br><span class="line">       Process.setStartTimes(SystemClock.elapsedRealtime(), SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">       mBoundApplication = data;</span><br><span class="line">       mConfiguration = new Configuration(data.config);</span><br><span class="line">       mCompatConfiguration = new Configuration(data.config);</span><br><span class="line"></span><br><span class="line">       mProfiler = new Profiler();</span><br><span class="line">       String agent = null;</span><br><span class="line">       if (data.initProfilerInfo != null) &#123;</span><br><span class="line">           mProfiler.profileFile = data.initProfilerInfo.profileFile;</span><br><span class="line">           mProfiler.profileFd = data.initProfilerInfo.profileFd;</span><br><span class="line">           mProfiler.samplingInterval = data.initProfilerInfo.samplingInterval;</span><br><span class="line">           mProfiler.autoStopProfiler = data.initProfilerInfo.autoStopProfiler;</span><br><span class="line">           mProfiler.streamingOutput = data.initProfilerInfo.streamingOutput;</span><br><span class="line">           if (data.initProfilerInfo.attachAgentDuringBind) &#123;</span><br><span class="line">               agent = data.initProfilerInfo.agent;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // send up app name; do this *before* waiting for debugger</span><br><span class="line">       //设置进程名</span><br><span class="line">       Process.setArgV0(data.processName);</span><br><span class="line">       android.ddm.DdmHandleAppName.setAppName(data.processName,</span><br><span class="line">                                               UserHandle.myUserId());</span><br><span class="line">       VMRuntime.setProcessPackageName(data.appInfo.packageName);</span><br><span class="line"></span><br><span class="line">       // Pass data directory path to ART. This is used for caching information and</span><br><span class="line">       // should be set before any application code is loaded.</span><br><span class="line">       VMRuntime.setProcessDataDirectory(data.appInfo.dataDir);</span><br><span class="line">       </span><br><span class="line">       //开启Profiler统计信息</span><br><span class="line">       if (mProfiler.profileFd != null) &#123;</span><br><span class="line">           mProfiler.startProfiling();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // If the app is Honeycomb MR1 or earlier, switch its AsyncTask</span><br><span class="line">       // implementation to use the pool executor.  Normally, we use the</span><br><span class="line">       // serialized executor as the default. This has to happen in the</span><br><span class="line">       // main thread so the main looper is set right.</span><br><span class="line">       if (data.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</span><br><span class="line">           AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Message.updateCheckRecycle(data.appInfo.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">       // Prior to P, internal calls to decode Bitmaps used BitmapFactory,</span><br><span class="line">       // which may scale up to account for density. In P, we switched to</span><br><span class="line">       // ImageDecoder, which skips the upscale to save memory. ImageDecoder</span><br><span class="line">       // needs to still scale up in older apps, in case they rely on the</span><br><span class="line">       // size of the Bitmap without considering its density.</span><br><span class="line">       ImageDecoder.sApiLevel = data.appInfo.targetSdkVersion;</span><br><span class="line"></span><br><span class="line">       /*</span><br><span class="line">        * Before spawning a new process, reset the time zone to be the system time zone.</span><br><span class="line">        * This needs to be done because the system time zone could have changed after the</span><br><span class="line">        * the spawning of this process. Without doing this this process would have the incorrect</span><br><span class="line">        * system time zone.</span><br><span class="line">        */</span><br><span class="line">        //重置时区</span><br><span class="line">       TimeZone.setDefault(null);</span><br><span class="line"></span><br><span class="line">       /*</span><br><span class="line">        * Set the LocaleList. This may change once we create the App Context.</span><br><span class="line">        */</span><br><span class="line">       LocaleList.setDefault(data.config.getLocales());</span><br><span class="line"></span><br><span class="line">       synchronized (mResourcesManager) &#123;</span><br><span class="line">           /*</span><br><span class="line">            * Update the system configuration since its preloaded and might not</span><br><span class="line">            * reflect configuration changes. The configuration object passed</span><br><span class="line">            * in AppBindData can be safely assumed to be up to date</span><br><span class="line">            */</span><br><span class="line">           //更新系统配置</span><br><span class="line">           mResourcesManager.applyConfigurationToResourcesLocked(data.config, data.compatInfo);</span><br><span class="line">           mCurDefaultDisplayDpi = data.config.densityDpi;</span><br><span class="line"></span><br><span class="line">           // This calls mResourcesManager so keep it within the synchronized block.</span><br><span class="line">           applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line">       &#125;</span><br><span class="line">       //获取LoadedApk对象</span><br><span class="line">       data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">       if (agent != null) &#123;</span><br><span class="line">           handleAttachAgent(agent, data.info);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       /**</span><br><span class="line">        * Switch this process to density compatibility mode if needed.</span><br><span class="line">        */</span><br><span class="line">       if ((data.appInfo.flags&amp;ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES)</span><br><span class="line">               == 0) &#123;</span><br><span class="line">           mDensityCompatMode = true;</span><br><span class="line">           Bitmap.setDefaultDensity(DisplayMetrics.DENSITY_DEFAULT);</span><br><span class="line">       &#125;</span><br><span class="line">       updateDefaultDensity();</span><br><span class="line"></span><br><span class="line">       final String use24HourSetting = mCoreSettings.getString(Settings.System.TIME_12_24);</span><br><span class="line">       Boolean is24Hr = null;</span><br><span class="line">       if (use24HourSetting != null) &#123;</span><br><span class="line">           is24Hr = &quot;24&quot;.equals(use24HourSetting) ? Boolean.TRUE : Boolean.FALSE;</span><br><span class="line">       &#125;</span><br><span class="line">       // null : use locale default for 12/24 hour formatting,</span><br><span class="line">       // false : use 12 hour format,</span><br><span class="line">       // true : use 24 hour format.</span><br><span class="line">       DateFormat.set24HourTimePref(is24Hr);</span><br><span class="line"></span><br><span class="line">       View.mDebugViewAttributes =</span><br><span class="line">               mCoreSettings.getInt(Settings.Global.DEBUG_VIEW_ATTRIBUTES, 0) != 0;</span><br><span class="line"></span><br><span class="line">       StrictMode.initThreadDefaults(data.appInfo);</span><br><span class="line">       StrictMode.initVmDefaults(data.appInfo);</span><br><span class="line"></span><br><span class="line">       // We deprecated Build.SERIAL and only apps that target pre NMR1</span><br><span class="line">       // SDK can see it. Since access to the serial is now behind a</span><br><span class="line">       // permission we push down the value and here we fix it up</span><br><span class="line">       // before any app code has been loaded.</span><br><span class="line">       try &#123;</span><br><span class="line">           Field field = Build.class.getDeclaredField(&quot;SERIAL&quot;);</span><br><span class="line">           field.setAccessible(true);</span><br><span class="line">           field.set(Build.class, data.buildSerial);</span><br><span class="line">       &#125; catch (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">           /* ignore */</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (data.debugMode != ApplicationThreadConstants.DEBUG_OFF) &#123;</span><br><span class="line">           // XXX should have option to change the port.</span><br><span class="line">           Debug.changeDebugPort(8100);</span><br><span class="line">           if (data.debugMode == ApplicationThreadConstants.DEBUG_WAIT) &#123;</span><br><span class="line">               Slog.w(TAG, &quot;Application &quot; + data.info.getPackageName()</span><br><span class="line">                     + &quot; is waiting for the debugger on port 8100...&quot;);</span><br><span class="line"></span><br><span class="line">               IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">               try &#123;</span><br><span class="line">                   mgr.showWaitingForDebugger(mAppThread, true);</span><br><span class="line">               &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                   throw ex.rethrowFromSystemServer();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               Debug.waitForDebugger();</span><br><span class="line"></span><br><span class="line">               try &#123;</span><br><span class="line">                   mgr.showWaitingForDebugger(mAppThread, false);</span><br><span class="line">               &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                   throw ex.rethrowFromSystemServer();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               Slog.w(TAG, &quot;Application &quot; + data.info.getPackageName()</span><br><span class="line">                     + &quot; can be debugged on port 8100...&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Allow application-generated systrace messages if we&apos;re debuggable.</span><br><span class="line">       boolean isAppDebuggable = (data.appInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">       Trace.setAppTracingAllowed(isAppDebuggable);</span><br><span class="line">       ThreadedRenderer.setDebuggingEnabled(isAppDebuggable || Build.IS_DEBUGGABLE);</span><br><span class="line">       if (isAppDebuggable &amp;&amp; data.enableBinderTracking) &#123;</span><br><span class="line">           Binder.enableTracing();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       /**</span><br><span class="line">        * Initialize the default http proxy in this process for the reasons we set the time zone.</span><br><span class="line">        */</span><br><span class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;Setup proxies&quot;);</span><br><span class="line">       final IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">       //初始化httpProxy</span><br><span class="line">       if (b != null) &#123;</span><br><span class="line">           // In pre-boot mode (doing initial launch to collect password), not</span><br><span class="line">           // all system is up.  This includes the connectivity service, so don&apos;t</span><br><span class="line">           // crash if we can&apos;t get it.</span><br><span class="line">           final IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);</span><br><span class="line">           try &#123;</span><br><span class="line">               Proxy.setHttpProxySystemProperty(service.getProxyForNetwork(null));</span><br><span class="line">           &#125; catch (RemoteException e) &#123;</span><br><span class="line">               Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">               throw e.rethrowFromSystemServer();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">       // Instrumentation info affects the class loader, so load it before</span><br><span class="line">       // setting up the app context.</span><br><span class="line">       final InstrumentationInfo ii;</span><br><span class="line">       if (data.instrumentationName != null) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               ii = new ApplicationPackageManager(null, getPackageManager())</span><br><span class="line">                       .getInstrumentationInfo(data.instrumentationName, 0);</span><br><span class="line">           &#125; catch (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">               throw new RuntimeException(</span><br><span class="line">                       &quot;Unable to find instrumentation info for: &quot; + data.instrumentationName);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // Warn of potential ABI mismatches.</span><br><span class="line">           if (!Objects.equals(data.appInfo.primaryCpuAbi, ii.primaryCpuAbi)</span><br><span class="line">                   || !Objects.equals(data.appInfo.secondaryCpuAbi, ii.secondaryCpuAbi)) &#123;</span><br><span class="line">               Slog.w(TAG, &quot;Package uses different ABI(s) than its instrumentation: &quot;</span><br><span class="line">                       + &quot;package[&quot; + data.appInfo.packageName + &quot;]: &quot;</span><br><span class="line">                       + data.appInfo.primaryCpuAbi + &quot;, &quot; + data.appInfo.secondaryCpuAbi</span><br><span class="line">                       + &quot; instrumentation[&quot; + ii.packageName + &quot;]: &quot;</span><br><span class="line">                       + ii.primaryCpuAbi + &quot;, &quot; + ii.secondaryCpuAbi);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           mInstrumentationPackageName = ii.packageName;</span><br><span class="line">           mInstrumentationAppDir = ii.sourceDir;</span><br><span class="line">           mInstrumentationSplitAppDirs = ii.splitSourceDirs;</span><br><span class="line">           mInstrumentationLibDir = getInstrumentationLibrary(data.appInfo, ii);</span><br><span class="line">           mInstrumentedAppDir = data.info.getAppDir();</span><br><span class="line">           mInstrumentedSplitAppDirs = data.info.getSplitAppDirs();</span><br><span class="line">           mInstrumentedLibDir = data.info.getLibDir();</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           ii = null;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       //创建ContextImpl上下文</span><br><span class="line">       final ContextImpl appContext = ContextImpl.createAppContext(this, data.info);</span><br><span class="line">       updateLocaleListFromAppContext(appContext,</span><br><span class="line">               mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">       if (!Process.isIsolated()) &#123;</span><br><span class="line">           final int oldMask = StrictMode.allowThreadDiskWritesMask();</span><br><span class="line">           try &#123;</span><br><span class="line">               setupGraphicsSupport(appContext);</span><br><span class="line">           &#125; finally &#123;</span><br><span class="line">               StrictMode.setThreadPolicyMask(oldMask);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           ThreadedRenderer.setIsolatedProcess(true);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Install the Network Security Config Provider. This must happen before the application</span><br><span class="line">       // code is loaded to prevent issues with instances of TLS objects being created before</span><br><span class="line">       // the provider is installed.</span><br><span class="line">       //网络安全配置初始化</span><br><span class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;NetworkSecurityConfigProvider.install&quot;);</span><br><span class="line">       NetworkSecurityConfigProvider.install(appContext);</span><br><span class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">       // Continue loading instrumentation.</span><br><span class="line">       //获取mInstrumentation</span><br><span class="line">       if (ii != null) &#123;</span><br><span class="line">           ApplicationInfo instrApp;</span><br><span class="line">           try &#123;</span><br><span class="line">               instrApp = getPackageManager().getApplicationInfo(ii.packageName, 0,</span><br><span class="line">                       UserHandle.myUserId());</span><br><span class="line">           &#125; catch (RemoteException e) &#123;</span><br><span class="line">               instrApp = null;</span><br><span class="line">           &#125;</span><br><span class="line">           if (instrApp == null) &#123;</span><br><span class="line">               instrApp = new ApplicationInfo();</span><br><span class="line">           &#125;</span><br><span class="line">           ii.copyTo(instrApp);</span><br><span class="line">           instrApp.initForUser(UserHandle.myUserId());</span><br><span class="line">           final LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</span><br><span class="line">                   appContext.getClassLoader(), false, true, false);</span><br><span class="line">           final ContextImpl instrContext = ContextImpl.createAppContext(this, pi);</span><br><span class="line"></span><br><span class="line">           try &#123;</span><br><span class="line">               final ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">               mInstrumentation = (Instrumentation)</span><br><span class="line">                   cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               throw new RuntimeException(</span><br><span class="line">                   &quot;Unable to instantiate instrumentation &quot;</span><br><span class="line">                   + data.instrumentationName + &quot;: &quot; + e.toString(), e);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           final ComponentName component = new ComponentName(ii.packageName, ii.name);</span><br><span class="line">           mInstrumentation.init(this, instrContext, appContext, component,</span><br><span class="line">                   data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br><span class="line"></span><br><span class="line">           if (mProfiler.profileFile != null &amp;&amp; !ii.handleProfiling</span><br><span class="line">                   &amp;&amp; mProfiler.profileFd == null) &#123;</span><br><span class="line">               mProfiler.handlingProfiling = true;</span><br><span class="line">               final File file = new File(mProfiler.profileFile);</span><br><span class="line">               file.getParentFile().mkdirs();</span><br><span class="line">               Debug.startMethodTracing(file.toString(), 8 * 1024 * 1024);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mInstrumentation = new Instrumentation();</span><br><span class="line">           mInstrumentation.basicInit(this);</span><br><span class="line">       &#125;</span><br><span class="line">       //清除内存增长上限</span><br><span class="line">       if ((data.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != 0) &#123;</span><br><span class="line">           dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           // Small heap, clamp to the current growth limit and let the heap release</span><br><span class="line">           // pages after the growth limit to the non growth limit capacity. b/18387825</span><br><span class="line">           dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Allow disk access during application and provider setup. This could</span><br><span class="line">       // block processing ordered broadcasts, but later processing would</span><br><span class="line">       // probably end up doing the same disk access.</span><br><span class="line">       Application app;</span><br><span class="line">       final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</span><br><span class="line">       final StrictMode.ThreadPolicy writesAllowedPolicy = StrictMode.getThreadPolicy();</span><br><span class="line">       try &#123;</span><br><span class="line">           // If the app is being launched for full backup or restore, bring it up in</span><br><span class="line">           // a restricted environment with the base application class.</span><br><span class="line">           //LoadedApk通过反射创建目标应用的Application对象，见3.13节</span><br><span class="line">           app = data.info.makeApplication(data.restrictedBackupMode, null);</span><br><span class="line"></span><br><span class="line">           // Propagate autofill compat state</span><br><span class="line">           app.setAutofillCompatibilityEnabled(data.autofillCompatibilityEnabled);</span><br><span class="line"></span><br><span class="line">           mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">           // don&apos;t bring up providers in restricted mode; they may depend on the</span><br><span class="line">           // app&apos;s custom Application class</span><br><span class="line">           if (!data.restrictedBackupMode) &#123;</span><br><span class="line">               if (!ArrayUtils.isEmpty(data.providers)) &#123;</span><br><span class="line">                   installContentProviders(app, data.providers);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // Do this after providers, since instrumentation tests generally start their</span><br><span class="line">           // test thread at this point, and we don&apos;t want that racing.</span><br><span class="line">           try &#123; </span><br><span class="line">               mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">           &#125;</span><br><span class="line">           catch (Exception e) &#123;</span><br><span class="line">               throw new RuntimeException(</span><br><span class="line">                   &quot;Exception thrown in onCreate() of &quot;</span><br><span class="line">                   + data.instrumentationName + &quot;: &quot; + e.toString(), e);</span><br><span class="line">           &#125;</span><br><span class="line">           try &#123;</span><br><span class="line">               //调用Application.onCreate方法</span><br><span class="line">               mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               if (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                   throw new RuntimeException(</span><br><span class="line">                     &quot;Unable to create application &quot; + app.getClass().getName()</span><br><span class="line">                     + &quot;: &quot; + e.toString(), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           // If the app targets &lt; O-MR1, or doesn&apos;t change the thread policy</span><br><span class="line">           // during startup, clobber the policy to maintain behavior of b/36951662</span><br><span class="line">           if (data.appInfo.targetSdkVersion &lt; Build.VERSION_CODES.O_MR1</span><br><span class="line">                   || StrictMode.getThreadPolicy().equals(writesAllowedPolicy)) &#123;</span><br><span class="line">               StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Preload fonts resources</span><br><span class="line">       // 加载字体资源</span><br><span class="line">       FontsContract.setApplicationContextForResources(appContext);   </span><br><span class="line">       if (!Process.isIsolated()) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               final ApplicationInfo info =</span><br><span class="line">                       getPackageManager().getApplicationInfo(</span><br><span class="line">                               data.appInfo.packageName,</span><br><span class="line">                               PackageManager.GET_META_DATA /*flags*/,</span><br><span class="line">                               UserHandle.myUserId());</span><br><span class="line">               if (info.metaData != null) &#123;</span><br><span class="line">                   final int preloadedFontsResource = info.metaData.getInt(</span><br><span class="line">                           ApplicationInfo.METADATA_PRELOADED_FONTS, 0);</span><br><span class="line">                   if (preloadedFontsResource != 0) &#123;</span><br><span class="line">                       data.info.getResources().preloadFonts(preloadedFontsResource);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; catch (RemoteException e) &#123;</span><br><span class="line">               throw e.rethrowFromSystemServer();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-13-LA-makeApplication"><a href="#3-13-LA-makeApplication" class="headerlink" title="3.13 LA.makeApplication"></a>3.13 LA.makeApplication</h3><p>[-&gt;LoadedApk.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">public Application makeApplication(boolean forceDefaultAppClass,</span><br><span class="line">           Instrumentation instrumentation) &#123;</span><br><span class="line">       if (mApplication != null) &#123;</span><br><span class="line">           return mApplication;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;makeApplication&quot;);</span><br><span class="line"></span><br><span class="line">       Application app = null;</span><br><span class="line"></span><br><span class="line">       String appClass = mApplicationInfo.className;</span><br><span class="line">       if (forceDefaultAppClass || (appClass == null)) &#123;</span><br><span class="line">           appClass = &quot;android.app.Application&quot;;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       try &#123;</span><br><span class="line">           java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">           if (!mPackageName.equals(&quot;android&quot;)) &#123;</span><br><span class="line">               Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,</span><br><span class="line">                       &quot;initializeJavaContextClassLoader&quot;);</span><br><span class="line">               initializeJavaContextClassLoader();</span><br><span class="line">               Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">           &#125;</span><br><span class="line">           //见3.13.1节</span><br><span class="line">           ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this);</span><br><span class="line">           //见3.13.2节</span><br><span class="line">           app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                   cl, appClass, appContext);</span><br><span class="line">           appContext.setOuterContext(app);</span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line">           if (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">               Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">               throw new RuntimeException(</span><br><span class="line">                   &quot;Unable to instantiate application &quot; + appClass</span><br><span class="line">                   + &quot;: &quot; + e.toString(), e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       mActivityThread.mAllApplications.add(app);</span><br><span class="line">       mApplication = app;</span><br><span class="line"></span><br><span class="line">       if (instrumentation != null) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               //调用app的OnCreate</span><br><span class="line">               instrumentation.callApplicationOnCreate(app);</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               if (!instrumentation.onException(app, e)) &#123;</span><br><span class="line">                   Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                   throw new RuntimeException(</span><br><span class="line">                       &quot;Unable to create application &quot; + app.getClass().getName()</span><br><span class="line">                       + &quot;: &quot; + e.toString(), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Rewrite the R &apos;constants&apos; for all library apks.</span><br><span class="line">       SparseArray&lt;String&gt; packageIdentifiers = getAssets().getAssignedPackageIdentifiers();</span><br><span class="line">       final int N = packageIdentifiers.size();</span><br><span class="line">       for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">           final int id = packageIdentifiers.keyAt(i);</span><br><span class="line">           if (id == 0x01 || id == 0x7f) &#123;</span><br><span class="line">               continue;</span><br><span class="line">           &#125;</span><br><span class="line">           //重写所有apk库中的R常量 ，见3.13.3节</span><br><span class="line">           rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">       return app;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-13-1-CI-createAppContext"><a href="#3-13-1-CI-createAppContext" class="headerlink" title="3.13.1 CI.createAppContext"></a>3.13.1 CI.createAppContext</h4><p>[-&gt;ContextImpl.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static ContextImpl createAppContext(ActivityThread mainThread, LoadedApk packageInfo) &#123;</span><br><span class="line">       if (packageInfo == null) throw new IllegalArgumentException(&quot;packageInfo&quot;);</span><br><span class="line">       ContextImpl context = new ContextImpl(null, mainThread, packageInfo, null, null, null, 0,</span><br><span class="line">               null);</span><br><span class="line">       context.setResources(packageInfo.getResources());</span><br><span class="line">       return context;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-13-2-newApplication"><a href="#3-13-2-newApplication" class="headerlink" title="3.13.2 newApplication"></a>3.13.2 newApplication</h4><p>[-&gt;Instrumentation.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public Application newApplication(ClassLoader cl, String className, Context context)</span><br><span class="line">         throws InstantiationException, IllegalAccessException, </span><br><span class="line">         ClassNotFoundException &#123;</span><br><span class="line">     //通过反射方法创建Application</span><br><span class="line">     Application app = getFactory(context.getPackageName())</span><br><span class="line">             .instantiateApplication(cl, className);</span><br><span class="line">     //调用attach方法</span><br><span class="line">     app.attach(context);</span><br><span class="line">     return app;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-13-3-LA-rewriteRValues"><a href="#3-13-3-LA-rewriteRValues" class="headerlink" title="3.13.3 LA.rewriteRValues"></a>3.13.3 LA.rewriteRValues</h4><p>[-&gt;LoadedApk.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private void rewriteRValues(ClassLoader cl, String packageName, int id) &#123;</span><br><span class="line">       final Class&lt;?&gt; rClazz;</span><br><span class="line">       try &#123;</span><br><span class="line">           rClazz = cl.loadClass(packageName + &quot;.R&quot;);</span><br><span class="line">       &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">           // This is not necessarily an error, as some packages do not ship with resources</span><br><span class="line">           // (or they do not need rewriting).</span><br><span class="line">           Log.i(TAG, &quot;No resource references to update in package &quot; + packageName);</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       final Method callback;</span><br><span class="line">       try &#123;</span><br><span class="line">           callback = rClazz.getMethod(&quot;onResourcesLoaded&quot;, int.class);</span><br><span class="line">       &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">           // No rewriting to be done.</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Throwable cause;</span><br><span class="line">       try &#123;</span><br><span class="line">           callback.invoke(null, id);</span><br><span class="line">           return;</span><br><span class="line">       &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">           cause = e;</span><br><span class="line">       &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">           cause = e.getCause();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       throw new RuntimeException(&quot;Failed to rewrite resource references for &quot; + packageName,</span><br><span class="line">               cause);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>介绍了四大组件和进程启动，并分析四大组件共用的启动进程方法startProcessLocked。在这个整个过程中有新创建的进程和systemserver进程之间的交互过程，通过binder进行通信。app的任何组件都需要一个承载其运行的容器即进程，进程的创建过程是由systemserver通过socket向zygote进程请求fork新进程。</p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>源码路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core\java\android\os\Process.java</span><br><span class="line">frameworks/base/services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line">frameworks/base/core\java\android\app\ActivityThread.java</span><br><span class="line">frameworks/base/core\java\android\app\LoadedApk.java</span><br><span class="line">frameworks/base/core\java\android\app\Instrumentation.java</span><br><span class="line">frameworks/base/core\java\android\app\ContextImpl.java</span><br></pre></td></tr></table></figure>

      
    </div>


    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/四大组件与进程关系/" rel="tag">#四大组件与进程关系</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/Android进程创建流程分析/" rel="next" title="Android进程创建流程分析">
                <i class="fa fa-chevron-left"></i> Android进程创建流程分析
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/selinux修改/" rel="prev" title="SELinux权限修改">
                SELinux权限修改 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Skytoby">
          <p class="site-author-name" itemprop="name">Skytoby</p>
          <p class="site-description motion-element" itemprop="description">现居深圳，毕业于电子科技大学 <br>Android、AI<br>座右铭：想法+行动+坚持</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">34</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caoxiaoliang" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/cao861544325" target="_blank" title="CSDN">
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、概述"><span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、四大组件与进程"><span class="nav-text">二、四大组件与进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-四大组件"><span class="nav-text">2.1 四大组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-Activity"><span class="nav-text">2.1.1 Activity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-Service"><span class="nav-text">2.1.2 Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-ContentProvider"><span class="nav-text">2.1.3 ContentProvider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-BroadcastReceiver"><span class="nav-text">2.1.4 BroadcastReceiver</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-进程启动"><span class="nav-text">2.2 进程启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、进程创建过程"><span class="nav-text">三、进程创建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-AMS-startProcessLocked"><span class="nav-text">3.1  AMS.startProcessLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-AMS-startProcessLocked"><span class="nav-text">3.2  AMS.startProcessLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-AMS-startProcessLocked"><span class="nav-text">3.3  AMS.startProcessLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-AMS-startProcessLocked"><span class="nav-text">3.4 AMS.startProcessLocked</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-1-AMS-startProcess"><span class="nav-text">3.4.1  AMS.startProcess</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-AMS-handleProcessStartedLocked"><span class="nav-text">3.4.2  AMS.handleProcessStartedLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-AT-main"><span class="nav-text">3.5 AT.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-AT-attach"><span class="nav-text">3.6 AT.attach</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-AMS-attachApplication"><span class="nav-text">3.7 AMS.attachApplication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-AMS-attachApplicationLocked"><span class="nav-text">3.8 AMS.attachApplicationLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-AT-bindApplication"><span class="nav-text">3.9 AT.bindApplication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-10-H-handleMessage"><span class="nav-text">3.10 H.handleMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-11-AT-handleSetCoreSettings"><span class="nav-text">3.11 AT.handleSetCoreSettings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-12-AT-handleBindApplication"><span class="nav-text">3.12 AT.handleBindApplication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-13-LA-makeApplication"><span class="nav-text">3.13 LA.makeApplication</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-13-1-CI-createAppContext"><span class="nav-text">3.13.1 CI.createAppContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-13-2-newApplication"><span class="nav-text">3.13.2 newApplication</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-13-3-LA-rewriteRValues"><span class="nav-text">3.13.3 LA.rewriteRValues</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、总结"><span class="nav-text">四、总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录"><span class="nav-text">附录</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skytoby</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme Next
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'https-zproo-github-io';
      var disqus_identifier = '2019/Android四大组件与进程启动间关系/';
      var disqus_title = "Android四大组件与进程启动间关系";
      var disqus_url = 'http://zproo.github.io/2019/Android四大组件与进程启动间关系/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  









  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
