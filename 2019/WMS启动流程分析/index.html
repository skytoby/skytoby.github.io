<!doctype html>



  


<html class="theme-next pisces use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="WindowManagerService,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="基于Android10.0，分析WMS的启动过程  一、概述WindowManagerService作为Android系统中重要的服务，管理所有的窗口和输入事件的中转站，其相关类如下。 1.1 WMS类族 WMS继承于IWindowManager.Stub,作为Binder服务端 成员变量mSessions保存所有的Session对象，Session继承于IWindowSession.Stub，">
<meta name="keywords" content="WindowManagerService">
<meta property="og:type" content="article">
<meta property="og:title" content="WMS启动流程分析">
<meta property="og:url" content="http://zproo.github.io/2019/WMS启动流程分析/index.html">
<meta property="og:site_name" content="Skytoby">
<meta property="og:description" content="基于Android10.0，分析WMS的启动过程  一、概述WindowManagerService作为Android系统中重要的服务，管理所有的窗口和输入事件的中转站，其相关类如下。 1.1 WMS类族 WMS继承于IWindowManager.Stub,作为Binder服务端 成员变量mSessions保存所有的Session对象，Session继承于IWindowSession.Stub，">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://zproo.github.io/2019/WMS启动流程分析/WMS.jpg">
<meta property="og:image" content="http://zproo.github.io/2019/WMS启动流程分析/session.png">
<meta property="og:image" content="http://zproo.github.io/2019/WMS启动流程分析/surface_rendered.png">
<meta property="og:image" content="http://zproo.github.io/2019/WMS启动流程分析/wms_startup.jpg">
<meta property="og:updated_time" content="2019-12-28T04:59:24.509Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WMS启动流程分析">
<meta name="twitter:description" content="基于Android10.0，分析WMS的启动过程  一、概述WindowManagerService作为Android系统中重要的服务，管理所有的窗口和输入事件的中转站，其相关类如下。 1.1 WMS类族 WMS继承于IWindowManager.Stub,作为Binder服务端 成员变量mSessions保存所有的Session对象，Session继承于IWindowSession.Stub，">
<meta name="twitter:image" content="http://zproo.github.io/2019/WMS启动流程分析/WMS.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://zproo.github.io/2019/WMS启动流程分析/">

  <title> WMS启动流程分析 | Skytoby </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <header id="header_post" class="header" itemscope="" itemtype="http://schema.org/WPHeader" style="background-image: url('http://ortur5wom.bkt.clouddn.com/home_bg.jpg');">
      <div class="header-inner-post"><a class="site-home" href="/">Skytoby</a>

<div class="site-meta ">
  
  
  
    <div class="site-meta-headline">
      <a>
        <img class="custom-logo-image" src="/images/logo.png" style="width: 50px" alt="Skytoby">
      </a>
    </div>
  

  
  
  
  
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
           <li class="menu-item menu-item-关于">
             <a href="/about" rel="section">
               
               
               关于
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-目录">
             <a href="/archives" rel="section">
               
               
               目录
             </a>
           </li>
        
      
        
        
        
           <li class="menu-item menu-item-首页">
             <a href="/" rel="section">
               
               
               首页
             </a>
           </li>
        
      

      
    </ul>
  

  
</nav> </div>
      <div class="header-post"> 
  <div class="post-header">
      <div class="tags">
      
        <a href="/tags/WindowManagerService/" rel="tag" title="WindowManagerService">WindowManagerService</a>
      
      </div>
      <h1>WMS启动流程分析</h1>
      <h2 class="subtitle"></h2>
      <div class="post-time">
        <span class="post-meta-item-text">Posted on </span>
        <time itemprop="dateCreated" datetime="2019-07-20T21:38:24+08:00" content="2019-07-20" title="2019-07-20 21:38:24">
          2019-07-20
        </time>
      </div>
  </div>
 </div>
    </header>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                WMS启动流程分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2019-07-20T21:38:24+08:00" content="2019-07-20">
              2019-07-20
            </time>
          </span>

          

          <!-- 
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/WMS启动流程分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/WMS启动流程分析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
           -->

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>基于Android10.0，分析WMS的启动过程</p>
</blockquote>
<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>WindowManagerService作为Android系统中重要的服务，管理所有的窗口和输入事件的中转站，其相关类如下。</p>
<h4 id="1-1-WMS类族"><a href="#1-1-WMS类族" class="headerlink" title="1.1 WMS类族"></a>1.1 WMS类族</h4><p><img src="/2019/WMS启动流程分析/WMS.jpg" alt="WMS"></p>
<p>WMS继承于IWindowManager.Stub,作为Binder服务端</p>
<p>成员变量mSessions保存所有的Session对象，Session继承于IWindowSession.Stub，作为Binder服务端</p>
<p>成员变量mPolicy，实例是PhoneWindowManager，用于实现各种窗口相关的策略</p>
<p>成员变量mWindowMap,保存所有的WindowState对象;以IBinder为key, 是IWindow的Bp端;</p>
<p>每个窗口都对应一个WindowState对象, 该对象的成员变量mClient用于跟应用端交互,成员变量mToken用于跟AMS交互,WindowState的attach方法与SurfaceFlinger通信。</p>
<p>WindowManager与WindowManagerService通过Session进行通信，具体的实现由WMS处理。</p>
<p>WindowManager实现类是WindowManagerImpl ；</p>
<p>WindowManagerImpl 中成员变量 mParentWindow （Window）,mGlobal (WindowManagerGlobal) </p>
<p><img src="/2019/WMS启动流程分析/session.png" alt=""></p>
<h4 id="1-2-图形框架"><a href="#1-2-图形框架" class="headerlink" title="1.2 图形框架"></a>1.2 图形框架</h4><p>Android系统图形系统复杂，包括WindowManager，SurfaceFlinger，Open GL，GPU等模块，其中SurfaceFlinger作为绘制应用UI的核心。Surface代表BufferQueue的生产者端，并由SurfaceFlinger消费。</p>
<p><img src="/2019/WMS启动流程分析/surface_rendered.png" alt=""></p>
<p>Image Stream Producter（生产者）:可产生graphic buffers的生产者，例如：OpenGL ES,Canvas 2D，mediaserver的视频编码器</p>
<p>Image Stream Consumers（消费者）：使用Open GL和Hardware Composer来组合一组surfaces</p>
<p>Window Manager：用于管理window，这是一组view容器，WM将window元数据信息发送给SurfaceFlinger，因此SurfaceFlinger能将这些信息来合成surfaces，并输出到显示设备。</p>
<p>Hardware Composer（硬件合成器）：显示子系统的硬件抽象层，SurfaceFlinger能将一些合成工作给Hardware Composer，从而降低OpenGL和GPU的负载。</p>
<p>Gralloc:全程graphics memory allocator，图像内存分配器，用于图形生产请求分配内存。</p>
<h2 id="二、启动过程"><a href="#二、启动过程" class="headerlink" title="二、启动过程"></a>二、启动过程</h2><p>WMS在SystemServer中的startOtherServices方法启动，和其启动相关的主要操作如下：</p>
<p>[-&gt;SystemServer.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private void startOtherServices() &#123;</span><br><span class="line">      wm = WindowManagerService.main(context, inputManager,</span><br><span class="line">                   mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL,</span><br><span class="line">                   !mFirstBoot, mOnlyCore, new PhoneWindowManager());</span><br><span class="line">      ...</span><br><span class="line">      //见2.1节</span><br><span class="line">      mActivityManagerService.setWindowManager(wm);</span><br><span class="line">      ...   </span><br><span class="line">      wm.onInitReady();</span><br><span class="line">      ...   </span><br><span class="line">      wm.displayReady();</span><br><span class="line">      ...     </span><br><span class="line">      wm.systemReady();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-WMS-main"><a href="#2-1-WMS-main" class="headerlink" title="2.1 WMS.main"></a>2.1 WMS.main</h3><p>[-&gt;WindowManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static WindowManagerService main(final Context context, final InputManagerService im,</span><br><span class="line">           final boolean haveInputMethods, final boolean showBootMsgs, final boolean onlyCore,</span><br><span class="line">           WindowManagerPolicy policy) &#123;</span><br><span class="line">       DisplayThread.getHandler().runWithScissors(() -&gt;</span><br><span class="line">               //运行在android.display线程</span><br><span class="line">               sInstance = new WindowManagerService(context, im, haveInputMethods, showBootMsgs,</span><br><span class="line">                       onlyCore, policy), 0);</span><br><span class="line">       return sInstance;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-WindowManagerService"><a href="#2-2-WindowManagerService" class="headerlink" title="2.2 WindowManagerService"></a>2.2 WindowManagerService</h3><p>[-&gt;WindowManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">private WindowManagerService(Context context, InputManagerService inputManager,</span><br><span class="line">           boolean haveInputMethods, boolean showBootMsgs, boolean onlyCore,</span><br><span class="line">           WindowManagerPolicy policy) &#123;</span><br><span class="line">       //初始化锁</span><br><span class="line">       installLock(this, INDEX_WINDOW);</span><br><span class="line">       mContext = context;</span><br><span class="line">       mHaveInputMethods = haveInputMethods;</span><br><span class="line">       mAllowBootMessages = showBootMsgs;</span><br><span class="line">       mOnlyCore = onlyCore;</span><br><span class="line">       mLimitedAlphaCompositing = context.getResources().getBoolean(</span><br><span class="line">               com.android.internal.R.bool.config_sf_limitedAlpha);</span><br><span class="line">       mHasPermanentDpad = context.getResources().getBoolean(</span><br><span class="line">               com.android.internal.R.bool.config_hasPermanentDpad);</span><br><span class="line">       mInTouchMode = context.getResources().getBoolean(</span><br><span class="line">               com.android.internal.R.bool.config_defaultInTouchMode);</span><br><span class="line">       mDrawLockTimeoutMillis = context.getResources().getInteger(</span><br><span class="line">               com.android.internal.R.integer.config_drawLockTimeoutMillis);</span><br><span class="line">       mAllowAnimationsInLowPowerMode = context.getResources().getBoolean(</span><br><span class="line">               com.android.internal.R.bool.config_allowAnimationsInLowPowerMode);</span><br><span class="line">       mMaxUiWidth = context.getResources().getInteger(</span><br><span class="line">               com.android.internal.R.integer.config_maxUiWidth);</span><br><span class="line">       mDisableTransitionAnimation = context.getResources().getBoolean(</span><br><span class="line">               com.android.internal.R.bool.config_disableTransitionAnimation);</span><br><span class="line">       mInputManager = inputManager; // Must be before createDisplayContentLocked.</span><br><span class="line">       mDisplayManagerInternal = LocalServices.getService(DisplayManagerInternal.class);</span><br><span class="line">       mDisplaySettings = new DisplaySettings();</span><br><span class="line">       mDisplaySettings.readSettingsLocked();</span><br><span class="line"></span><br><span class="line">       mPolicy = policy;</span><br><span class="line">       mAnimator = new WindowAnimator(this);</span><br><span class="line">       //创建根Window，用于支持多屏幕的功能</span><br><span class="line">       mRoot = new RootWindowContainer(this);</span><br><span class="line"></span><br><span class="line">       mWindowPlacerLocked = new WindowSurfacePlacer(this);</span><br><span class="line">       mTaskSnapshotController = new TaskSnapshotController(this);</span><br><span class="line"></span><br><span class="line">       mWindowTracing = WindowTracing.createDefaultAndStartLooper(context);</span><br><span class="line"></span><br><span class="line">       LocalServices.addService(WindowManagerPolicy.class, mPolicy);</span><br><span class="line"></span><br><span class="line">       if(mInputManager != null) &#123;</span><br><span class="line">           final InputChannel inputChannel = mInputManager.monitorInput(TAG_WM);</span><br><span class="line">           mPointerEventDispatcher = inputChannel != null</span><br><span class="line">                   ? new PointerEventDispatcher(inputChannel) : null;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mPointerEventDispatcher = null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mDisplayManager = (DisplayManager)context.getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line"></span><br><span class="line">       mKeyguardDisableHandler = new KeyguardDisableHandler(mContext, mPolicy);</span><br><span class="line"></span><br><span class="line">       mPowerManager = (PowerManager)context.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">       mPowerManagerInternal = LocalServices.getService(PowerManagerInternal.class);</span><br><span class="line"></span><br><span class="line">       if (mPowerManagerInternal != null) &#123;</span><br><span class="line">           mPowerManagerInternal.registerLowPowerModeObserver(</span><br><span class="line">                   new PowerManagerInternal.LowPowerModeListener() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               public int getServiceType() &#123;</span><br><span class="line">                   return ServiceType.ANIMATION;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               @Override</span><br><span class="line">               public void onLowPowerModeChanged(PowerSaveState result) &#123;</span><br><span class="line">                   synchronized (mWindowMap) &#123;</span><br><span class="line">                       final boolean enabled = result.batterySaverEnabled;</span><br><span class="line">                       if (mAnimationsDisabled != enabled &amp;&amp; !mAllowAnimationsInLowPowerMode) &#123;</span><br><span class="line">                           mAnimationsDisabled = enabled;</span><br><span class="line">                           dispatchNewAnimatorScaleLocked(null);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">           mAnimationsDisabled = mPowerManagerInternal</span><br><span class="line">                   .getLowPowerState(ServiceType.ANIMATION).batterySaverEnabled;</span><br><span class="line">       &#125;</span><br><span class="line">       //创建屏幕锁</span><br><span class="line">       mScreenFrozenLock = mPowerManager.newWakeLock(</span><br><span class="line">               PowerManager.PARTIAL_WAKE_LOCK, &quot;SCREEN_FROZEN&quot;);</span><br><span class="line">       mScreenFrozenLock.setReferenceCounted(false);</span><br><span class="line"></span><br><span class="line">       mAppTransition = new AppTransition(context, this);</span><br><span class="line">       mAppTransition.registerListenerLocked(mActivityManagerAppTransitionNotifier);</span><br><span class="line"></span><br><span class="line">       final AnimationHandler animationHandler = new AnimationHandler();</span><br><span class="line">       mBoundsAnimationController = new BoundsAnimationController(context, mAppTransition,</span><br><span class="line">               AnimationThread.getHandler(), animationHandler);</span><br><span class="line"></span><br><span class="line">       mActivityManager = ActivityManager.getService();</span><br><span class="line">       mAmInternal = LocalServices.getService(ActivityManagerInternal.class);</span><br><span class="line">       mAppOps = (AppOpsManager)context.getSystemService(Context.APP_OPS_SERVICE);</span><br><span class="line">       AppOpsManager.OnOpChangedInternalListener opListener =</span><br><span class="line">               new AppOpsManager.OnOpChangedInternalListener() &#123;</span><br><span class="line">                   @Override public void onOpChanged(int op, String packageName) &#123;</span><br><span class="line">                       updateAppOpsState();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;;</span><br><span class="line">       mAppOps.startWatchingMode(OP_SYSTEM_ALERT_WINDOW, null, opListener);</span><br><span class="line">       mAppOps.startWatchingMode(AppOpsManager.OP_TOAST_WINDOW, null, opListener);</span><br><span class="line"></span><br><span class="line">       mPmInternal = LocalServices.getService(PackageManagerInternal.class);</span><br><span class="line">       final IntentFilter suspendPackagesFilter = new IntentFilter();</span><br><span class="line">       suspendPackagesFilter.addAction(Intent.ACTION_PACKAGES_SUSPENDED);</span><br><span class="line">       suspendPackagesFilter.addAction(Intent.ACTION_PACKAGES_UNSUSPENDED);</span><br><span class="line">       context.registerReceiverAsUser(new BroadcastReceiver() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">               final String[] affectedPackages =</span><br><span class="line">                       intent.getStringArrayExtra(Intent.EXTRA_CHANGED_PACKAGE_LIST);</span><br><span class="line">               final boolean suspended =</span><br><span class="line">                       Intent.ACTION_PACKAGES_SUSPENDED.equals(intent.getAction());</span><br><span class="line">               updateHiddenWhileSuspendedState(new ArraySet&lt;&gt;(Arrays.asList(affectedPackages)),</span><br><span class="line">                       suspended);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;, UserHandle.ALL, suspendPackagesFilter, null, null);</span><br><span class="line"></span><br><span class="line">       // Get persisted window scale setting</span><br><span class="line">       mWindowAnimationScaleSetting = Settings.Global.getFloat(context.getContentResolver(),</span><br><span class="line">               Settings.Global.WINDOW_ANIMATION_SCALE, mWindowAnimationScaleSetting);</span><br><span class="line">       mTransitionAnimationScaleSetting = Settings.Global.getFloat(context.getContentResolver(),</span><br><span class="line">               Settings.Global.TRANSITION_ANIMATION_SCALE,</span><br><span class="line">               context.getResources().getFloat(</span><br><span class="line">                       R.dimen.config_appTransitionAnimationDurationScaleDefault));</span><br><span class="line"></span><br><span class="line">       setAnimatorDurationScale(Settings.Global.getFloat(context.getContentResolver(),</span><br><span class="line">               Settings.Global.ANIMATOR_DURATION_SCALE, mAnimatorDurationScaleSetting));</span><br><span class="line"></span><br><span class="line">       IntentFilter filter = new IntentFilter();</span><br><span class="line">       // Track changes to DevicePolicyManager state so we can enable/disable keyguard.</span><br><span class="line">       filter.addAction(ACTION_DEVICE_POLICY_MANAGER_STATE_CHANGED);</span><br><span class="line">       mContext.registerReceiver(mBroadcastReceiver, filter);</span><br><span class="line"></span><br><span class="line">       mLatencyTracker = LatencyTracker.getInstance(context);</span><br><span class="line"></span><br><span class="line">       mSettingsObserver = new SettingsObserver();</span><br><span class="line"></span><br><span class="line">       mHoldingScreenWakeLock = mPowerManager.newWakeLock(</span><br><span class="line">               PowerManager.SCREEN_BRIGHT_WAKE_LOCK | PowerManager.ON_AFTER_RELEASE, TAG_WM);</span><br><span class="line">       mHoldingScreenWakeLock.setReferenceCounted(false);</span><br><span class="line"></span><br><span class="line">       mSurfaceAnimationRunner = new SurfaceAnimationRunner(mPowerManagerInternal);</span><br><span class="line"></span><br><span class="line">       mAllowTheaterModeWakeFromLayout = context.getResources().getBoolean(</span><br><span class="line">               com.android.internal.R.bool.config_allowTheaterModeWakeFromWindowLayout);</span><br><span class="line"></span><br><span class="line">       mTaskPositioningController = new TaskPositioningController(</span><br><span class="line">               this, mInputManager, mInputMonitor, mActivityManager, mH.getLooper());</span><br><span class="line">       mDragDropController = new DragDropController(this, mH.getLooper());</span><br><span class="line"></span><br><span class="line">       LocalServices.addService(WindowManagerInternal.class, new LocalService());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>WMS的初始化在“android.display”线程中执行，mH继承于Handler,采用的是当前线程的Looper， mH.sendMessage方法也运行在android.display”线程</p>
<h3 id="2-3-WMS-onInitReady"><a href="#2-3-WMS-onInitReady" class="headerlink" title="2.3  WMS.onInitReady"></a>2.3  WMS.onInitReady</h3><p>[-&gt;WindowManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void onInitReady() &#123;</span><br><span class="line">       initPolicy();</span><br><span class="line"></span><br><span class="line">       // Add ourself to the Watchdog monitors.</span><br><span class="line">       Watchdog.getInstance().addMonitor(this);</span><br><span class="line"></span><br><span class="line">       openSurfaceTransaction();</span><br><span class="line">       try &#123;</span><br><span class="line">           createWatermarkInTransaction();</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           closeSurfaceTransaction(&quot;createWatermarkInTransaction&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       showEmulatorDisplayOverlayIfNeeded();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-1-initPolicy"><a href="#2-3-1-initPolicy" class="headerlink" title="2.3.1 initPolicy"></a>2.3.1 initPolicy</h4><p>[-&gt;WindowManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void initPolicy() &#123;</span><br><span class="line">      //运行在Ui线程</span><br><span class="line">       UiThread.getHandler().runWithScissors(new Runnable() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void run() &#123;</span><br><span class="line">               WindowManagerPolicyThread.set(Thread.currentThread(), Looper.myLooper());</span><br><span class="line">               //此处为PhoneWindowManager</span><br><span class="line">               mPolicy.init(mContext, WindowManagerService.this, WindowManagerService.this);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;, 0);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-2-runWithScissors"><a href="#2-3-2-runWithScissors" class="headerlink" title="2.3.2 runWithScissors"></a>2.3.2 runWithScissors</h4><p>[-&gt;Handler.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public final boolean runWithScissors(final Runnable r, long timeout) &#123;</span><br><span class="line">       if (r == null) &#123;</span><br><span class="line">           throw new IllegalArgumentException(&quot;runnable must not be null&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">       if (timeout &lt; 0) &#123;</span><br><span class="line">           throw new IllegalArgumentException(&quot;timeout must be non-negative&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (Looper.myLooper() == mLooper) &#123;</span><br><span class="line">           r.run();</span><br><span class="line">           return true;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       BlockingRunnable br = new BlockingRunnable(r);</span><br><span class="line">       return br.postAndWait(this, timeout);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-3-postAndWait"><a href="#2-3-3-postAndWait" class="headerlink" title="2.3.3 postAndWait"></a>2.3.3 postAndWait</h4><p>[-&gt;Handler.java::BlockingRunnable]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public boolean postAndWait(Handler handler, long timeout) &#123;</span><br><span class="line">           if (!handler.post(this)) &#123;</span><br><span class="line">               return false;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           synchronized (this) &#123;</span><br><span class="line">               if (timeout &gt; 0) &#123;</span><br><span class="line">                   final long expirationTime = SystemClock.uptimeMillis() + timeout;</span><br><span class="line">                   while (!mDone) &#123;</span><br><span class="line">                       long delay = expirationTime - SystemClock.uptimeMillis();</span><br><span class="line">                       if (delay &lt;= 0) &#123;</span><br><span class="line">                           return false; // timeout</span><br><span class="line">                       &#125;</span><br><span class="line">                       try &#123;</span><br><span class="line">                           wait(delay);</span><br><span class="line">                       &#125; catch (InterruptedException ex) &#123;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   while (!mDone) &#123;</span><br><span class="line">                       try &#123;</span><br><span class="line">                           wait();</span><br><span class="line">                       &#125; catch (InterruptedException ex) &#123;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           return true;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>postAndWait是阻塞操作，把消息放在Handler所指向的线程，此处是android.ui线程，由于该方法运行在android.display线程，从而会进入等待状态，直到执行完成，再唤醒android.display线程，PWM.init运行在android.ui线程，属于同步阻塞。</p>
<h3 id="2-4-PWM-init"><a href="#2-4-PWM-init" class="headerlink" title="2.4 PWM.init"></a>2.4 PWM.init</h3><p>[-&gt;PhoneWindowManager.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line">public void init(Context context, IWindowManager windowManager,</span><br><span class="line">            WindowManagerFuncs windowManagerFuncs) &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mWindowManager = windowManager;</span><br><span class="line">        mWindowManagerFuncs = windowManagerFuncs;</span><br><span class="line">        mWindowManagerInternal = LocalServices.getService(WindowManagerInternal.class);</span><br><span class="line">        mActivityManagerInternal = LocalServices.getService(ActivityManagerInternal.class);</span><br><span class="line">        mInputManagerInternal = LocalServices.getService(InputManagerInternal.class);</span><br><span class="line">        mDreamManagerInternal = LocalServices.getService(DreamManagerInternal.class);</span><br><span class="line">        mPowerManagerInternal = LocalServices.getService(PowerManagerInternal.class);</span><br><span class="line">        mAppOpsManager = (AppOpsManager) mContext.getSystemService(Context.APP_OPS_SERVICE);</span><br><span class="line">        mHasFeatureWatch = mContext.getPackageManager().hasSystemFeature(FEATURE_WATCH);</span><br><span class="line">        mHasFeatureLeanback = mContext.getPackageManager().hasSystemFeature(FEATURE_LEANBACK);</span><br><span class="line">        mAccessibilityShortcutController =</span><br><span class="line">                new AccessibilityShortcutController(mContext, new Handler(), mCurrentUserId);</span><br><span class="line">        mLogger = new MetricsLogger();</span><br><span class="line">        // Init display burn-in protection</span><br><span class="line">        boolean burnInProtectionEnabled = context.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_enableBurnInProtection);</span><br><span class="line">        // Allow a system property to override this. Used by developer settings.</span><br><span class="line">        boolean burnInProtectionDevMode =</span><br><span class="line">                SystemProperties.getBoolean(&quot;persist.debug.force_burn_in&quot;, false);</span><br><span class="line">        if (burnInProtectionEnabled || burnInProtectionDevMode) &#123;</span><br><span class="line">            final int minHorizontal;</span><br><span class="line">            final int maxHorizontal;</span><br><span class="line">            final int minVertical;</span><br><span class="line">            final int maxVertical;</span><br><span class="line">            final int maxRadius;</span><br><span class="line">            if (burnInProtectionDevMode) &#123;</span><br><span class="line">                minHorizontal = -8;</span><br><span class="line">                maxHorizontal = 8;</span><br><span class="line">                minVertical = -8;</span><br><span class="line">                maxVertical = -4;</span><br><span class="line">                maxRadius = (isRoundWindow()) ? 6 : -1;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                Resources resources = context.getResources();</span><br><span class="line">                minHorizontal = resources.getInteger(</span><br><span class="line">                        com.android.internal.R.integer.config_burnInProtectionMinHorizontalOffset);</span><br><span class="line">                maxHorizontal = resources.getInteger(</span><br><span class="line">                        com.android.internal.R.integer.config_burnInProtectionMaxHorizontalOffset);</span><br><span class="line">                minVertical = resources.getInteger(</span><br><span class="line">                        com.android.internal.R.integer.config_burnInProtectionMinVerticalOffset);</span><br><span class="line">                maxVertical = resources.getInteger(</span><br><span class="line">                        com.android.internal.R.integer.config_burnInProtectionMaxVerticalOffset);</span><br><span class="line">                maxRadius = resources.getInteger(</span><br><span class="line">                        com.android.internal.R.integer.config_burnInProtectionMaxRadius);</span><br><span class="line">            &#125;</span><br><span class="line">            mBurnInProtectionHelper = new BurnInProtectionHelper(</span><br><span class="line">                    context, minHorizontal, maxHorizontal, minVertical, maxVertical, maxRadius);</span><br><span class="line">        &#125;</span><br><span class="line">        //运行在ui线程</span><br><span class="line">        mHandler = new PolicyHandler(); </span><br><span class="line">        mWakeGestureListener = new MyWakeGestureListener(mContext, mHandler);</span><br><span class="line">        mOrientationListener = new MyOrientationListener(mContext, mHandler);</span><br><span class="line">        try &#123;</span><br><span class="line">            mOrientationListener.setCurrentRotation(windowManager.getDefaultDisplayRotation());</span><br><span class="line">        &#125; catch (RemoteException ex) &#123; &#125;</span><br><span class="line">        mSettingsObserver = new SettingsObserver(mHandler);</span><br><span class="line">        mSettingsObserver.observe();</span><br><span class="line">        mShortcutManager = new ShortcutManager(context);</span><br><span class="line">        mUiMode = context.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_defaultUiModeType);</span><br><span class="line">        mHomeIntent =  new Intent(Intent.ACTION_MAIN, null);</span><br><span class="line">        mHomeIntent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">        mHomeIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED);</span><br><span class="line">        mEnableCarDockHomeCapture = context.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_enableCarDockHomeLaunch);</span><br><span class="line">        mCarDockIntent =  new Intent(Intent.ACTION_MAIN, null);</span><br><span class="line">        mCarDockIntent.addCategory(Intent.CATEGORY_CAR_DOCK);</span><br><span class="line">        mCarDockIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED);</span><br><span class="line">        mDeskDockIntent =  new Intent(Intent.ACTION_MAIN, null);</span><br><span class="line">        mDeskDockIntent.addCategory(Intent.CATEGORY_DESK_DOCK);</span><br><span class="line">        mDeskDockIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED);</span><br><span class="line">        mVrHeadsetHomeIntent =  new Intent(Intent.ACTION_MAIN, null);</span><br><span class="line">        mVrHeadsetHomeIntent.addCategory(Intent.CATEGORY_VR_HOME);</span><br><span class="line">        mVrHeadsetHomeIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED);</span><br><span class="line"></span><br><span class="line">        mPowerManager = (PowerManager)context.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">        mBroadcastWakeLock = mPowerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,</span><br><span class="line">                &quot;PhoneWindowManager.mBroadcastWakeLock&quot;);</span><br><span class="line">        mPowerKeyWakeLock = mPowerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,</span><br><span class="line">                &quot;PhoneWindowManager.mPowerKeyWakeLock&quot;);</span><br><span class="line">        mEnableShiftMenuBugReports = &quot;1&quot;.equals(SystemProperties.get(&quot;ro.debuggable&quot;));</span><br><span class="line">        mSupportAutoRotation = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_supportAutoRotation);</span><br><span class="line">        mLidOpenRotation = readRotation(</span><br><span class="line">                com.android.internal.R.integer.config_lidOpenRotation);</span><br><span class="line">        mCarDockRotation = readRotation(</span><br><span class="line">                com.android.internal.R.integer.config_carDockRotation);</span><br><span class="line">        mDeskDockRotation = readRotation(</span><br><span class="line">                com.android.internal.R.integer.config_deskDockRotation);</span><br><span class="line">        mUndockedHdmiRotation = readRotation(</span><br><span class="line">                com.android.internal.R.integer.config_undockedHdmiRotation);</span><br><span class="line">        mCarDockEnablesAccelerometer = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_carDockEnablesAccelerometer);</span><br><span class="line">        mDeskDockEnablesAccelerometer = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_deskDockEnablesAccelerometer);</span><br><span class="line">        mLidKeyboardAccessibility = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_lidKeyboardAccessibility);</span><br><span class="line">        mLidNavigationAccessibility = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_lidNavigationAccessibility);</span><br><span class="line">        mLidControlsScreenLock = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_lidControlsScreenLock);</span><br><span class="line">        mLidControlsSleep = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_lidControlsSleep);</span><br><span class="line">        mTranslucentDecorEnabled = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_enableTranslucentDecor);</span><br><span class="line"></span><br><span class="line">        mAllowTheaterModeWakeFromKey = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_allowTheaterModeWakeFromKey);</span><br><span class="line">        mAllowTheaterModeWakeFromPowerKey = mAllowTheaterModeWakeFromKey</span><br><span class="line">                || mContext.getResources().getBoolean(</span><br><span class="line">                    com.android.internal.R.bool.config_allowTheaterModeWakeFromPowerKey);</span><br><span class="line">        mAllowTheaterModeWakeFromMotion = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_allowTheaterModeWakeFromMotion);</span><br><span class="line">        mAllowTheaterModeWakeFromMotionWhenNotDreaming = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_allowTheaterModeWakeFromMotionWhenNotDreaming);</span><br><span class="line">        mAllowTheaterModeWakeFromCameraLens = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_allowTheaterModeWakeFromCameraLens);</span><br><span class="line">        mAllowTheaterModeWakeFromLidSwitch = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_allowTheaterModeWakeFromLidSwitch);</span><br><span class="line">        mAllowTheaterModeWakeFromWakeGesture = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_allowTheaterModeWakeFromGesture);</span><br><span class="line"></span><br><span class="line">        mGoToSleepOnButtonPressTheaterMode = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_goToSleepOnButtonPressTheaterMode);</span><br><span class="line"></span><br><span class="line">        mSupportLongPressPowerWhenNonInteractive = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_supportLongPressPowerWhenNonInteractive);</span><br><span class="line"></span><br><span class="line">        mLongPressOnBackBehavior = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_longPressOnBackBehavior);</span><br><span class="line"></span><br><span class="line">        mShortPressOnPowerBehavior = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_shortPressOnPowerBehavior);</span><br><span class="line">        mLongPressOnPowerBehavior = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_longPressOnPowerBehavior);</span><br><span class="line">        mVeryLongPressOnPowerBehavior = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_veryLongPressOnPowerBehavior);</span><br><span class="line">        mDoublePressOnPowerBehavior = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_doublePressOnPowerBehavior);</span><br><span class="line">        mTriplePressOnPowerBehavior = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_triplePressOnPowerBehavior);</span><br><span class="line">        mShortPressOnSleepBehavior = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_shortPressOnSleepBehavior);</span><br><span class="line">        mVeryLongPressTimeout = mContext.getResources().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_veryLongPressTimeout);</span><br><span class="line">        mAllowStartActivityForLongPressOnPowerDuringSetup = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_allowStartActivityForLongPressOnPowerInSetup);</span><br><span class="line"></span><br><span class="line">        mUseTvRouting = AudioSystem.getPlatformType(mContext) == AudioSystem.PLATFORM_TELEVISION;</span><br><span class="line"></span><br><span class="line">        mHandleVolumeKeysInWM = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_handleVolumeKeysInWindowManager);</span><br><span class="line"></span><br><span class="line">        readConfigurationDependentBehaviors();</span><br><span class="line"></span><br><span class="line">        mAccessibilityManager = (AccessibilityManager) context.getSystemService(</span><br><span class="line">                Context.ACCESSIBILITY_SERVICE);</span><br><span class="line"></span><br><span class="line">        // register for dock events</span><br><span class="line">        IntentFilter filter = new IntentFilter();</span><br><span class="line">        filter.addAction(UiModeManager.ACTION_ENTER_CAR_MODE);</span><br><span class="line">        filter.addAction(UiModeManager.ACTION_EXIT_CAR_MODE);</span><br><span class="line">        filter.addAction(UiModeManager.ACTION_ENTER_DESK_MODE);</span><br><span class="line">        filter.addAction(UiModeManager.ACTION_EXIT_DESK_MODE);</span><br><span class="line">        filter.addAction(Intent.ACTION_DOCK_EVENT);</span><br><span class="line">        Intent intent = context.registerReceiver(mDockReceiver, filter);</span><br><span class="line">        if (intent != null) &#123;</span><br><span class="line">            // Retrieve current sticky dock event broadcast.</span><br><span class="line">            mDockMode = intent.getIntExtra(Intent.EXTRA_DOCK_STATE,</span><br><span class="line">                    Intent.EXTRA_DOCK_STATE_UNDOCKED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // register for dream-related broadcasts</span><br><span class="line">        filter = new IntentFilter();</span><br><span class="line">        filter.addAction(Intent.ACTION_DREAMING_STARTED);</span><br><span class="line">        filter.addAction(Intent.ACTION_DREAMING_STOPPED);</span><br><span class="line">        context.registerReceiver(mDreamReceiver, filter);</span><br><span class="line"></span><br><span class="line">        // register for multiuser-relevant broadcasts</span><br><span class="line">        filter = new IntentFilter(Intent.ACTION_USER_SWITCHED);</span><br><span class="line">        context.registerReceiver(mMultiuserReceiver, filter);</span><br><span class="line"></span><br><span class="line">        // monitor for system gestures</span><br><span class="line">        // TODO(multi-display): Needs to be display specific.</span><br><span class="line">        mSystemGestures = new SystemGesturesPointerEventListener(context,</span><br><span class="line">                new SystemGesturesPointerEventListener.Callbacks() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onSwipeFromTop() &#123;</span><br><span class="line">                        if (mStatusBar != null) &#123;</span><br><span class="line">                            requestTransientBars(mStatusBar);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onSwipeFromBottom() &#123;</span><br><span class="line">                        if (mNavigationBar != null &amp;&amp; mNavigationBarPosition == NAV_BAR_BOTTOM) &#123;</span><br><span class="line">                            requestTransientBars(mNavigationBar);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onSwipeFromRight() &#123;</span><br><span class="line">                        if (mNavigationBar != null &amp;&amp; mNavigationBarPosition == NAV_BAR_RIGHT) &#123;</span><br><span class="line">                            requestTransientBars(mNavigationBar);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onSwipeFromLeft() &#123;</span><br><span class="line">                        if (mNavigationBar != null &amp;&amp; mNavigationBarPosition == NAV_BAR_LEFT) &#123;</span><br><span class="line">                            requestTransientBars(mNavigationBar);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onFling(int duration) &#123;</span><br><span class="line">                        if (mPowerManagerInternal != null) &#123;</span><br><span class="line">                            mPowerManagerInternal.powerHint(</span><br><span class="line">                                    PowerHint.INTERACTION, duration);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onDebug() &#123;</span><br><span class="line">                        // no-op</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onDown() &#123;</span><br><span class="line">                        mOrientationListener.onTouchStart();</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onUpOrCancel() &#123;</span><br><span class="line">                        mOrientationListener.onTouchEnd();</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onMouseHoverAtTop() &#123;</span><br><span class="line">                        mHandler.removeMessages(MSG_REQUEST_TRANSIENT_BARS);</span><br><span class="line">                        Message msg = mHandler.obtainMessage(MSG_REQUEST_TRANSIENT_BARS);</span><br><span class="line">                        msg.arg1 = MSG_REQUEST_TRANSIENT_BARS_ARG_STATUS;</span><br><span class="line">                        mHandler.sendMessageDelayed(msg, 500);</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onMouseHoverAtBottom() &#123;</span><br><span class="line">                        mHandler.removeMessages(MSG_REQUEST_TRANSIENT_BARS);</span><br><span class="line">                        Message msg = mHandler.obtainMessage(MSG_REQUEST_TRANSIENT_BARS);</span><br><span class="line">                        msg.arg1 = MSG_REQUEST_TRANSIENT_BARS_ARG_NAVIGATION;</span><br><span class="line">                        mHandler.sendMessageDelayed(msg, 500);</span><br><span class="line">                    &#125;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onMouseLeaveFromEdge() &#123;</span><br><span class="line">                        mHandler.removeMessages(MSG_REQUEST_TRANSIENT_BARS);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        mImmersiveModeConfirmation = new ImmersiveModeConfirmation(mContext);</span><br><span class="line">        mWindowManagerFuncs.registerPointerEventListener(mSystemGestures);</span><br><span class="line"></span><br><span class="line">        mVibrator = (Vibrator)context.getSystemService(Context.VIBRATOR_SERVICE);</span><br><span class="line">        mLongPressVibePattern = getLongIntArray(mContext.getResources(),</span><br><span class="line">                com.android.internal.R.array.config_longPressVibePattern);</span><br><span class="line">        mCalendarDateVibePattern = getLongIntArray(mContext.getResources(),</span><br><span class="line">                com.android.internal.R.array.config_calendarDateVibePattern);</span><br><span class="line">        mSafeModeEnabledVibePattern = getLongIntArray(mContext.getResources(),</span><br><span class="line">                com.android.internal.R.array.config_safeModeEnabledVibePattern);</span><br><span class="line"></span><br><span class="line">        mScreenshotChordEnabled = mContext.getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_enableScreenshotChord);</span><br><span class="line"></span><br><span class="line">        mGlobalKeyManager = new GlobalKeyManager(mContext);</span><br><span class="line"></span><br><span class="line">        // Controls rotation and the like.</span><br><span class="line">        initializeHdmiState();</span><br><span class="line"></span><br><span class="line">        // Match current screen state.</span><br><span class="line">        if (!mPowerManager.isInteractive()) &#123;</span><br><span class="line">            startedGoingToSleep(WindowManagerPolicy.OFF_BECAUSE_OF_USER);</span><br><span class="line">            finishedGoingToSleep(WindowManagerPolicy.OFF_BECAUSE_OF_USER);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mWindowManagerInternal.registerAppTransitionListener(</span><br><span class="line">                mStatusBarController.getAppTransitionListener());</span><br><span class="line">        mWindowManagerInternal.registerAppTransitionListener(new AppTransitionListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public int onAppTransitionStartingLocked(int transit, IBinder openToken,</span><br><span class="line">                    IBinder closeToken, long duration, long statusBarAnimationStartTime,</span><br><span class="line">                    long statusBarAnimationDuration) &#123;</span><br><span class="line">                return handleStartTransitionForKeyguardLw(transit, duration);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onAppTransitionCancelledLocked(int transit) &#123;</span><br><span class="line">                handleStartTransitionForKeyguardLw(transit, 0 /* duration */);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mKeyguardDelegate = new KeyguardServiceDelegate(mContext,</span><br><span class="line">                new StateCallback() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void onTrustedChanged() &#123;</span><br><span class="line">                        mWindowManagerFuncs.notifyKeyguardTrustedChanged();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public void onShowingChanged() &#123;</span><br><span class="line">                        mWindowManagerFuncs.onKeyguardShowingAndNotOccludedChanged();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        mScreenshotHelper = new ScreenshotHelper(mContext);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-WMS-displayReady"><a href="#2-5-WMS-displayReady" class="headerlink" title="2.5 WMS.displayReady"></a>2.5 WMS.displayReady</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void displayReady(int displayId) &#123;</span><br><span class="line">      synchronized(mWindowMap) &#123;</span><br><span class="line">          //得到显示的displayid</span><br><span class="line">          final DisplayContent displayContent = mRoot.getDisplayContent(displayId);</span><br><span class="line">          if (displayContent != null) &#123;</span><br><span class="line">              mAnimator.addDisplayLocked(displayId);</span><br><span class="line">              displayContent.initializeDisplayBaseInfo();</span><br><span class="line">              reconfigureDisplayLocked(displayContent);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-6-WMS-systemReady"><a href="#2-6-WMS-systemReady" class="headerlink" title="2.6 WMS.systemReady"></a>2.6 WMS.systemReady</h3><p>[-&gt;WindowManagerService.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void systemReady() &#123;</span><br><span class="line">      mPolicy.systemReady();</span><br><span class="line">      //截屏systemReady</span><br><span class="line">      mTaskSnapshotController.systemReady();</span><br><span class="line">      mHasWideColorGamutSupport = queryWideColorGamutSupport();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-1-PWM-systemReady"><a href="#2-6-1-PWM-systemReady" class="headerlink" title="2.6.1 PWM.systemReady"></a>2.6.1 PWM.systemReady</h4><p>[-&gt;PhoneWindowManager]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public void systemReady() &#123;</span><br><span class="line">       // In normal flow, systemReady is called before other system services are ready.</span><br><span class="line">       // So it is better not to bind keyguard here.</span><br><span class="line">       mKeyguardDelegate.onSystemReady();</span><br><span class="line"></span><br><span class="line">       mVrManagerInternal = LocalServices.getService(VrManagerInternal.class);</span><br><span class="line">       if (mVrManagerInternal != null) &#123;</span><br><span class="line">           mVrManagerInternal.addPersistentVrModeStateListener(mPersistentVrModeListener);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       readCameraLensCoverState();</span><br><span class="line">       updateUiMode();</span><br><span class="line">       synchronized (mLock) &#123;</span><br><span class="line">           updateOrientationListenerLp();</span><br><span class="line">           mSystemReady = true;</span><br><span class="line">           mHandler.post(new Runnable() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               public void run() &#123;</span><br><span class="line">                   updateSettings();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">           // If this happens, for whatever reason, systemReady came later than systemBooted.</span><br><span class="line">           // And keyguard should be already bound from systemBooted</span><br><span class="line">           if (mSystemBooted) &#123;</span><br><span class="line">               mKeyguardDelegate.onBootCompleted();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mSystemGestures.systemReady();</span><br><span class="line">       mImmersiveModeConfirmation.systemReady();</span><br><span class="line"></span><br><span class="line">       mAutofillManagerInternal = LocalServices.getService(AutofillManagerInternal.class);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>整个启动过程有3个线程，systemserver主线程，”android.display”,”android.ui”,整个过程采用阻塞的方式（利用runWithScissors）执行，WMS.mH的Looper运行在”android.display”进程。流程如下：</p>
<p><img src="/2019/WMS启动流程分析/wms_startup.jpg" alt=""></p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>源码路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/java/com/android/server/SystemServer.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/UiThread.java</span><br><span class="line">frameworks/base/core/java/android/os/Handler.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java</span><br></pre></td></tr></table></figure>

      
    </div>


    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/WindowManagerService/" rel="tag">#WindowManagerService</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/android系统编译/" rel="next" title="android系统编译方法">
                <i class="fa fa-chevron-left"></i> android系统编译方法
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/AMS启动流程分析/" rel="prev" title="AMS启动流程分析">
                AMS启动流程分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Skytoby">
          <p class="site-author-name" itemprop="name">Skytoby</p>
          <p class="site-description motion-element" itemprop="description"><br>现居深圳、毕业于电子科技大学 <br> 技术领域：Android、AI <br><br>座右铭：想法+行动+坚持</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">22</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caoxiaoliang" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/cao861544325" target="_blank" title="CSDN">
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、概述"><span class="nav-text">一、概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-WMS类族"><span class="nav-text">1.1 WMS类族</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-图形框架"><span class="nav-text">1.2 图形框架</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#二、启动过程"><span class="nav-text">二、启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-WMS-main"><span class="nav-text">2.1 WMS.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-WindowManagerService"><span class="nav-text">2.2 WindowManagerService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-WMS-onInitReady"><span class="nav-text">2.3  WMS.onInitReady</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-initPolicy"><span class="nav-text">2.3.1 initPolicy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-runWithScissors"><span class="nav-text">2.3.2 runWithScissors</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-postAndWait"><span class="nav-text">2.3.3 postAndWait</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-PWM-init"><span class="nav-text">2.4 PWM.init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-WMS-displayReady"><span class="nav-text">2.5 WMS.displayReady</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-WMS-systemReady"><span class="nav-text">2.6 WMS.systemReady</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-1-PWM-systemReady"><span class="nav-text">2.6.1 PWM.systemReady</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、总结"><span class="nav-text">三、总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录"><span class="nav-text">附录</span></a></li></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skytoby</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme Next
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'https-zproo-github-io';
      var disqus_identifier = '2019/WMS启动流程分析/';
      var disqus_title = "WMS启动流程分析";
      var disqus_url = 'http://zproo.github.io/2019/WMS启动流程分析/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  









  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
